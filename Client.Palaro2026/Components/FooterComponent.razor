@using QRCoder
@using System.Drawing.Imaging
@using System.IO
@using Microsoft.AspNetCore.Components
@inject NavigationManager navigationManager


<MudContainer MaxWidth="MaxWidth.Large" Class="mt-20 mb-5">
    <MudGrid>
        <MudItem xs="6">
            <MudStack Row AlignItems="AlignItems.End" Style="height: 100%; width: 100%">
                <MudText Typo="Typo.caption">Follow us: </MudText>
                <MudIcon Size="Size.Small" Color="Color.Primary" Icon="@Icons.Custom.Brands.Facebook" />
                <MudIcon Size="Size.Small" Color="Color.Primary" Icon="@Icons.Custom.Brands.TikTok" />
                <MudIcon Size="Size.Small" Color="Color.Primary" Icon="@Icons.Custom.Brands.YouTube" />
            </MudStack>
        </MudItem>
        <MudItem xs="6">
            <MudStack Row AlignItems="AlignItems.End" Justify=Justify.FlexEnd Style="height: 100%; width: 100%">
                @if (!string.IsNullOrEmpty(qrCodeBase64))
                {
                    <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="0">
                        <MudText Style="font-size: 10px">QR to this page</MudText>
                        <MudImage Src="@qrCodeBase64" alt="QR Code" style="height:100px;" />
                        <MudElement HtmlTag="a" href="@qrCodeBase64" download="@fileName">
                            <MudButton Size="Size.Small">Download</MudButton>
                        </MudElement>
                    </MudStack>
                }
            </MudStack>
        </MudItem>
        <MudItem xs="12">
            <MudDivider />
        </MudItem>
        <MudItem xs="12">
            <MudStack Class="flex-sm-row align-content-center"
                      Justify="Justify.SpaceBetween"
                      AlignItems="AlignItems.Center"
                      Spacing="2"
                      Wrap="Wrap.Wrap">

                <!-- Left Logo Stack -->
                <MudStack Row Wrap="Wrap.Wrap" AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="1">
                    <MudImage Src="media/logo/logo with 2026.webp" style="height: 100px; width: auto" />
                    <MudImage Src="media/logo/Palarong Pambansa Logo.webp" style="height: 100px; width: auto" />
                </MudStack>

                <!-- Right Text Stack -->
                <MudStack AlignItems="AlignItems.Center" Class="mt-2 mt-sm-0">
                    @if (currentYear == "2025")
                    {
                        <MudText>Copyright 2025. All rights reserved</MudText>
                    }
                    else
                    {
                        <MudText>Copyright 2025-@currentYear. All rights reserved</MudText>
                    }
                    <MudText Typo="Typo.caption" Align="Align.Center">
                        Developed by the
                        <MudElement HtmlTag="a" href="https://agusandelsur.gov.ph/" target="_blank">Provincial Government of Agusan del Sur</MudElement>
                        <br />
                        under the leadership of
                        <MudElement HtmlTag="a" href="https://agusandelsur.gov.ph/the-province-of-agusan-del-sur/government-officials/governor/" target="_blank">Gov. Santiago B. Cane, Jr.</MudElement>
                    </MudText>
                </MudStack>
            </MudStack>
        </MudItem>

        <MudItem xs="12">
            <MudDivider />
        </MudItem>
        <MudItem xs="12" Class="mt-n5">
            <MudStack Class="flex-sm-row" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row Spacing="5" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.caption"><MudElement HtmlTag="a" href="./policies/privacy-policy">Privacy Policy</MudElement></MudText> •
                    <MudText Typo="Typo.caption"><MudElement HtmlTag="a" href="./policies/terms-and-conditions">Terms of Service</MudElement></MudText> •
                    <MudText Typo="Typo.caption"><MudElement HtmlTag="a" href="./policies">Policies</MudElement></MudText>
                </MudStack>
                <MudStack Row>
                    <MudImage Src="media/logo/DepED.webp" Height="30" />
                    <MudImage Src="media/logo/Seal of Agusan del Sur.webp" Height="30" />
                    <MudImage Src="media/logo/PIMO Logo.webp" Height="30" />
                </MudStack>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudContainer>

@code
{
    string currentYear = DateTime.Now.ToString("yyyy");

    string? qrCodeBase64;
    string? fileName;

    protected override void OnInitialized()
    {
        var currentUrl = navigationManager.Uri;
        qrCodeBase64 = GenerateQrCodeBase64(currentUrl);

        // Extract full path from the URL and clean it for a safe filename
        var uri = new Uri(currentUrl);
        var path = uri.AbsolutePath.Trim('/').Replace("/", "-");

        // Fallback if root page
        if (string.IsNullOrWhiteSpace(path))
            path = "homepage";

        fileName = $"qr-code-{path}.png";
    }

    private string GenerateQrCodeBase64(string text)
    {
        using var qrGenerator = new QRCoder.QRCodeGenerator();
        using var qrCodeData = qrGenerator.CreateQrCode(text, QRCoder.QRCodeGenerator.ECCLevel.Q);
        using var qrCode = new QRCoder.PngByteQRCode(qrCodeData);
        byte[] qrCodeBytes = qrCode.GetGraphic(20);

        return $"data:image/png;base64,{Convert.ToBase64String(qrCodeBytes)}";
    }
}