@using Client.Palaro2026.Services
@using System.Text.Json
@using System.Text.RegularExpressions
@using System.Text
@inject IChatService ChatService
@inject IJSRuntime JS
@implements IAsyncDisposable

<style>
    :root {
        --pal-blue: #023E8A;
        --pal-gold: #FFB400;
        --pal-red: #EA0000;
        --pal-bg-gradient: linear-gradient(180deg, #e6f0ff 0%, #ffffff 100%);
    }

    /* CHAT WINDOW */
    .chat-window {
        transition: all 0.3s ease-in-out;
        transform-origin: bottom right;
        opacity: 0;
        transform: translateY(15px);
        visibility: hidden;
        pointer-events: none;
        box-shadow: 0 12px 48px rgba(2, 62, 138, 0.3);
        border: 2px solid var(--pal-blue);
        background: var(--pal-bg-gradient);
    }

        .chat-window.open {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
            pointer-events: auto;
        }

    /* SCROLLBARS */
    .chat-scroll-container::-webkit-scrollbar, .sports-grid::-webkit-scrollbar {
        width: 5px;
    }

    .chat-scroll-container::-webkit-scrollbar-track, .sports-grid::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.05);
    }

    .chat-scroll-container::-webkit-scrollbar-thumb, .sports-grid::-webkit-scrollbar-thumb {
        background-color: var(--pal-blue);
        border-radius: 4px;
    }

    /* USER BUBBLE */
    .bubble-user {
        background-color: var(--pal-blue);
        color: white;
        border-radius: 16px 16px 2px 16px;
        box-shadow: 0 2px 5px rgba(2, 62, 138, 0.2);
    }

        .bubble-user a {
            color: var(--pal-gold);
            text-decoration: underline;
            font-weight: bold;
        }

    /* AI BUBBLE */
    .bubble-ai {
        background-color: white;
        color: #1e293b;
        border-radius: 16px 16px 16px 2px;
        border-left: 5px solid var(--pal-gold);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

        .bubble-ai a {
            color: var(--pal-blue);
            text-decoration: underline;
            font-weight: 700;
        }

    .bubble-content {
        line-height: 1.5;
        font-size: 0.95rem;
    }

        .bubble-content p {
            margin-bottom: 8px;
            margin-top: 0;
        }

        .bubble-content ul, .bubble-content ol {
            margin-top: 4px;
            margin-bottom: 8px;
            padding-left: 20px;
        }

        .bubble-content li {
            margin-bottom: 4px;
        }

        .bubble-content strong {
            font-weight: 700;
            color: inherit;
        }

    .msg-timestamp {
        font-size: 0.65rem;
        color: #64748b;
        margin-top: 2px;
        margin-left: 4px;
        margin-right: 4px;
        font-weight: 500;
    }

    /* INPUT AREA */
    .input-area {
        border-top: 4px solid var(--pal-gold);
        background: white;
        padding: 12px 16px;
        align-items: flex-end;
    }

    .clean-textarea {
        width: 100%;
        border: none;
        outline: none;
        font-size: 0.9rem;
        color: #334155;
        background: transparent;
        resize: none;
        max-height: 120px;
        overflow-y: auto;
        padding: 0;
        margin-bottom: 4px;
        font-family: inherit;
        line-height: 1.4;
    }

        .clean-textarea::placeholder {
            color: #94a3b8;
        }

    .typing-dot {
        width: 5px;
        height: 5px;
        background-color: var(--pal-blue);
        border-radius: 50%;
        animation: simpleBounce 1.4s infinite ease-in-out both;
    }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

    @@keyframes simpleBounce {
        0%, 80%, 100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    .sports-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
        max-height: 220px;
        overflow-y: auto;
        padding: 4px;
        width: 100%;
    }

    /* CHIPS */
    .chip-blue-filled {
        background-color: var(--pal-blue) !important;
        color: white !important;
        border: none !important;
        font-weight: 500;
    }

        .chip-blue-filled:hover {
            background-color: #00285a !important;
            filter: brightness(1.1);
        }

    .chip-gold-filled {
        background-color: var(--pal-gold) !important;
        color: white !important;
        border: none !important;
        font-weight: 500;
        text-shadow: 0 1px 1px rgba(0,0,0,0.1);
    }

        .chip-gold-filled:hover {
            filter: brightness(1.05);
        }

    .chip-red-filled {
        background-color: var(--pal-red) !important;
        color: white !important;
        border: none !important;
        font-weight: 500;
    }

        .chip-red-filled:hover {
            filter: brightness(1.1);
        }

    .btn-close-white {
        color: white;
        opacity: 0.8;
    }

        .btn-close-white:hover {
            color: var(--pal-gold) !important;
            opacity: 1;
            background-color: rgba(255,255,255,0.1) !important;
        }

    @@media (max-width: 600px) {
        .chat-window {
            bottom: 0 !important;
            right: 0 !important;
            width: 100% !important;
            height: 100% !important;
            max-height: 100vh !important;
            border-radius: 0 !important;
        }
    }
</style>

<!-- CHAT WINDOW -->
<MudPaper Elevation="0"
          Class="@($"chat-window fixed d-flex flex-column overflow-hidden rounded-xl {(_isOpen ? "open" : "")}")"
          Style="bottom:90px; right:20px; width:380px; height:650px; max-height:80vh; z-index:2000;">

    <!-- HEADER -->
    <div class="d-flex align-center px-4 py-3" style="background: var(--pal-blue); color: white;">

        <!-- HEADER LOGO: Updated path to match folder & removed background -->
        <MudImage Src="./media/images/2030.png" Height="30" Width="30" ObjectFit="ObjectFit.Contain" Class="mr-3" />

        <div class="d-flex flex-column flex-grow-1">
            <MudText Typo="Typo.subtitle2" Class="fw-bold" Style="color: white;">Palaro Assistant </MudText>
            <MudText Typo="Typo.caption" Style="color: #FFB400; font-size: 0.7rem;">● Online</MudText>
        </div>

        <MudIconButton Icon="@Icons.Material.Rounded.Close" Class="btn-close-white" Size="Size.Small" OnClick="ToggleChat" />
    </div>

    <!-- MESSAGES AREA -->
    <div class="flex-grow-1 overflow-auto px-4 pt-4 chat-scroll-container"
         @ref="_messagesContainer">

        @if (_messages.Count == 0)
        {
            <div class="d-flex flex-column align-center justify-center h-100 pb-10 fade-in">

                <!-- MAIN BANNER LOGO -->
                <!-- Updated Path: ./media/logo/Palarong Pambansa Logo.webp -->
                <!-- Removed: background colors and borders. Just the transparent image. -->
                <div class="d-flex align-center justify-center mb-6 w-100">
                    <MudImage Src="./media/images/2031.png" Fluid="true" Style="max-width: 280px; max-height: 120px;" ObjectFit="ObjectFit.Contain" />
                </div>

                @if (!_showVenueSelection && !_showGuidelinesSelection && !_showMedalTallySelection)
                {
                    <MudText Typo="Typo.body2" Class="fw-bold" Style="color: var(--pal-blue); font-size: 1.1rem;">Mabuhay! 👋</MudText>
                    <MudText Typo="Typo.caption" Class="text-center mt-1 px-4 mb-6" Style="color: #334155;">
                        I'm your Palaro 2026 companion. Ask me anything! 🇵🇭
                    </MudText>

                    <div class="d-flex flex-wrap justify-center gap-2 px-4">
                        <MudChip T="string" OnClick="@(() => ToggleGuidelinesSelection(true))" Class="chip-blue-filled" Icon="@Icons.Material.Filled.Description">Guidelines</MudChip>
                        <MudChip T="string" OnClick="@(() => ToggleVenueSelection(true))" Class="chip-red-filled" Icon="@Icons.Material.Filled.Place">Venues</MudChip>
                        <MudChip T="string" OnClick="@(() => ToggleMedalTallySelection(true))" Class="chip-gold-filled" Icon="@Icons.Material.Filled.EmojiEvents">Medal Tally</MudChip>
                    </div>
                }
                else if (_showGuidelinesSelection)
                {
                    <MudText Typo="Typo.body2" Class="fw-bold mb-1" Style="color: var(--pal-blue);">Guidelines 📋</MudText>
                    <MudText Typo="Typo.caption" Class="text-center mb-4" Style="color: #475569;">Select a sport to view guidelines.</MudText>
                    <div class="sports-grid px-2">
                        @foreach (var sport in _sportsList)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" OnClick="@(() => SelectSportGuidelines(sport))" Class="m-0 chip-blue-filled" Style="font-size: 0.75rem;">@sport</MudChip>
                        }
                    </div>
                    <MudButton OnClick="@(() => ToggleGuidelinesSelection(false))" Variant="Variant.Text" Style="color: var(--pal-red);" Size="Size.Small" StartIcon="@Icons.Material.Rounded.ArrowBack" Class="mt-4">Back to Menu</MudButton>
                }
                else if (_showVenueSelection)
                {
                    <MudText Typo="Typo.body2" Class="fw-bold mb-1" Style="color: var(--pal-blue);">Select a Sport 🏟️</MudText>
                    <MudText Typo="Typo.caption" Class="text-center mb-4" Style="color: #475569;">Find the venue for:</MudText>
                    <div class="sports-grid px-2">
                        @foreach (var sport in _sportsList)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" OnClick="@(() => SelectSportVenue(sport))" Class="m-0 chip-red-filled" Style="font-size: 0.75rem;">@sport</MudChip>
                        }
                    </div>
                    <MudButton OnClick="@(() => ToggleVenueSelection(false))" Variant="Variant.Text" Style="color: var(--pal-blue);" Size="Size.Small" StartIcon="@Icons.Material.Rounded.ArrowBack" Class="mt-4">Back to Menu</MudButton>
                }
                else if (_showMedalTallySelection)
                {
                    <MudText Typo="Typo.body2" Class="fw-bold mb-1" Style="color: var(--pal-blue);">Medal Tally Stats 🥇</MudText>
                    <MudText Typo="Typo.caption" Class="text-center mb-4" Style="color: #475569;">Check the standings</MudText>

                    <div class="d-flex justify-center w-100 px-4 mb-3">
                        <MudButton OnClick="SelectLeadingRegion" Variant="Variant.Filled" Class="chip-gold-filled" FullWidth="true" StartIcon="@Icons.Material.Filled.EmojiEvents">🏆 Who is Leading?</MudButton>
                    </div>

                    <MudText Typo="Typo.caption" Class="text-center mb-2 fw-bold" Style="color: #94a3b8;">-- OR CHECK BY REGION --</MudText>

                    <div class="sports-grid px-2">
                        @foreach (var region in _regionsList)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" OnClick="@(() => SelectRegionStats(region))" Class="m-0 chip-blue-filled" Style="font-size: 0.75rem; background-color: #334155 !important;">@region</MudChip>
                        }
                    </div>
                    <MudButton OnClick="@(() => ToggleMedalTallySelection(false))" Variant="Variant.Text" Style="color: var(--pal-red);" Size="Size.Small" StartIcon="@Icons.Material.Rounded.ArrowBack" Class="mt-4">Back to Menu</MudButton>
                }
            </div>
        }
        else
        {
            <!-- CONVERSATION VIEW -->
            <div class="d-flex flex-column h-100">
                <MudStack Spacing="3" Class="flex-grow-1">
                    @foreach (var message in _messages)
                    {
                        <div class="d-flex w-100 @(message.IsUser ? "justify-end" : "justify-start")">
                            @if (!message.IsUser)
                            {
                                <!-- AI AVATAR (NO BACKGROUND) -->
                                <MudAvatar Size="Size.Small" Class="mr-2 mt-1" Style="background: transparent;">
                                    <MudImage Src="./media/images/2026.png" ObjectFit="ObjectFit.Contain" />
                                </MudAvatar>
                            }
                            <div class="d-flex flex-column" style="max-width: 80%;">
                                <div class="pa-3 px-4 @(message.IsUser ? "bubble-user" : "bubble-ai")">
                                    <div class="bubble-content">
                                        @((MarkupString)GetFormattedMessage(message.Content))
                                    </div>
                                </div>
                                <div class="d-flex @(message.IsUser ? "justify-end" : "justify-start")">
                                    <span class="msg-timestamp">@message.Timestamp.ToString("h:mm tt")</span>
                                </div>
                            </div>
                        </div>
                    }

                    @if (_isSending)
                    {
                        <div class="d-flex w-100 justify-start">
                            <MudAvatar Size="Size.Small" Class="mr-2 mt-1" Style="background: transparent;">
                                <MudImage Src="./media/images/2026.png" ObjectFit="ObjectFit.Contain" />
                            </MudAvatar>
                            <div class="bubble-ai pa-3 px-4 d-flex align-center gap-1">
                                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                            </div>
                        </div>
                    }
                </MudStack>

                <!-- BOTTOM SELECTION UI -->
                @if ((_showVenueSelection || _showGuidelinesSelection || _showMedalTallySelection || _showMainMenu) && !_isSending)
                {
                    <div class="d-flex flex-column align-center justify-center mt-4 pt-3 pb-2"
                         style="border-top: 1px dashed var(--pal-blue); background: rgba(255,255,255,0.9);">

                        @if (_showMainMenu)
                        {
                            <MudText Typo="Typo.caption" Class="fw-bold mb-3" Style="color: var(--pal-blue);">Select an Option</MudText>
                            <div class="d-flex flex-wrap justify-center gap-2 px-4">
                                <MudChip T="string" Size="Size.Small" OnClick="@(() => ToggleGuidelinesSelection(true))" Class="chip-blue-filled" Icon="@Icons.Material.Filled.Description">Guidelines</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick="@(() => ToggleVenueSelection(true))" Class="chip-red-filled" Icon="@Icons.Material.Filled.Place">Venues</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick="@(() => ToggleMedalTallySelection(true))" Class="chip-gold-filled" Icon="@Icons.Material.Filled.EmojiEvents">Medal Tally</MudChip>
                            </div>
                            <MudButton OnClick="@(() => CloseAllMenus())" Variant="Variant.Text" Style="color: var(--pal-red);" Size="Size.Small" StartIcon="@Icons.Material.Rounded.Close" Class="mt-2">Hide Menu</MudButton>
                        }
                        else if (_showGuidelinesSelection)
                        {
                            <MudText Typo="Typo.caption" Class="fw-bold mb-3" Style="color: var(--pal-blue);">📋 Select Sport for Guidelines</MudText>
                            <div class="sports-grid px-2" style="max-height: 160px;">
                                @foreach (var sport in _sportsList)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" OnClick="@(() => SelectSportGuidelines(sport))" Class="m-0 chip-blue-filled" Style="font-size: 0.75rem;">@sport</MudChip>
                                }
                            </div>
                            <div class="d-flex gap-2 mt-3">
                                <MudButton OnClick="@(() => { _wasInGuidelinesSelection = false; _showGuidelinesSelection = false; StateHasChanged(); })" Variant="Variant.Text" Style="color: var(--pal-red);" Size="Size.Small" StartIcon="@Icons.Material.Rounded.ArrowBack">Back to Chat</MudButton>
                                <MudButton OnClick="@(() => ShowMainMenu())" Variant="Variant.Text" Style="color: var(--pal-blue);" Size="Size.Small" StartIcon="@Icons.Material.Rounded.Home">Back to Menu</MudButton>
                            </div>
                        }
                        else if (_showVenueSelection)
                        {
                            <MudText Typo="Typo.caption" Class="fw-bold mb-3" Style="color: var(--pal-blue);">🏟️ Select Sport for Venue</MudText>
                            <div class="sports-grid px-2" style="max-height: 160px;">
                                @foreach (var sport in _sportsList)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" OnClick="@(() => SelectSportVenue(sport))" Class="m-0 chip-red-filled" Style="font-size: 0.75rem;">@sport</MudChip>
                                }
                            </div>
                            <div class="d-flex gap-2 mt-3">
                                <MudButton OnClick="@(() => { _wasInVenueSelection = false; _showVenueSelection = false; StateHasChanged(); })" Variant="Variant.Text" Style="color: var(--pal-blue);" Size="Size.Small" StartIcon="@Icons.Material.Rounded.ArrowBack">Back to Chat</MudButton>
                                <MudButton OnClick="@(() => ShowMainMenu())" Variant="Variant.Text" Style="color: var(--pal-blue);" Size="Size.Small" StartIcon="@Icons.Material.Rounded.Home">Back to Menu</MudButton>
                            </div>
                        }
                        else if (_showMedalTallySelection)
                        {
                            <MudText Typo="Typo.caption" Class="fw-bold mb-2" Style="color: var(--pal-blue);">🥇 Medal Tally Options</MudText>
                            <div class="d-flex justify-center w-100 px-4 mb-2">
                                <MudButton OnClick="SelectLeadingRegion" Variant="Variant.Filled" Size="Size.Small" Class="chip-gold-filled" FullWidth="true" StartIcon="@Icons.Material.Filled.EmojiEvents">🏆 Who is Leading?</MudButton>
                            </div>
                            <MudText Typo="Typo.caption" Class="text-center mb-2" Style="color: #94a3b8; font-size: 0.65rem;">OR SELECT REGION</MudText>
                            <div class="sports-grid px-2" style="max-height: 120px;">
                                @foreach (var region in _regionsList)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" OnClick="@(() => SelectRegionStats(region))" Class="m-0 chip-blue-filled" Style="font-size: 0.75rem; background-color: #334155 !important;">@region</MudChip>
                                }
                            </div>
                            <div class="d-flex gap-2 mt-3">
                                <MudButton OnClick="@(() => { _wasInMedalTallySelection = false; _showMedalTallySelection = false; StateHasChanged(); })" Variant="Variant.Text" Style="color: var(--pal-red);" Size="Size.Small" StartIcon="@Icons.Material.Rounded.ArrowBack">Back to Chat</MudButton>
                                <MudButton OnClick="@(() => ShowMainMenu())" Variant="Variant.Text" Style="color: var(--pal-blue);" Size="Size.Small" StartIcon="@Icons.Material.Rounded.Home">Back to Menu</MudButton>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>

    <!-- INPUT AREA -->
    <div class="input-area d-flex">
        <textarea @bind="_messageInput"
                  @bind:event="oninput"
                  @onkeydown="HandleKeyDown"
                  id="chatInputBox"
                  placeholder="Type a message..."
                  disabled="@_isSending"
                  rows="1"
                  class="clean-textarea flex-grow-1"></textarea>

        <MudIconButton Icon="@Icons.Material.Rounded.Send"
                       Style="color: var(--pal-blue);"
                       Size="Size.Small"
                       Disabled="@(string.IsNullOrWhiteSpace(_messageInput) || _isSending)"
                       OnClick="SendMessage"
                       Class="ml-2 mb-1"
                       Variant="Variant.Text" />
    </div>

</MudPaper>

<!-- FAB TRIGGER -->
<div style="position: fixed; bottom: 25px; right: 25px; z-index: 1999;">
    <MudFab OnClick="ToggleChat"
            StartIcon="@(_isOpen ? Icons.Material.Rounded.Close : Icons.Material.Rounded.Chat)"
            Class="mud-elevation-8"
            Style="background-color: var(--pal-blue); color: white; transition: transform 0.2s;" />
</div>

@code {
    // ... (Your C# code logic remains unchanged) ...
    private List<ChatMessage> _messages = new();
    private string _messageInput = string.Empty;
    private bool _isOpen;
    private bool _isSending;

    private bool _showVenueSelection = false;
    private bool _showGuidelinesSelection = false;
    private bool _showMedalTallySelection = false;
    private bool _showMainMenu = false;

    private bool _wasInVenueSelection = false;
    private bool _wasInGuidelinesSelection = false;
    private bool _wasInMedalTallySelection = false;

    private ElementReference _messagesContainer;

    private List<string> _sportsList = new()
    {
        "Archery", "Arnis", "Athletics", "Badminton", "Baseball",
        "Basketball (3x3)", "Basketball (Boys)", "Basketball (Girls)",
        "Billiards", "Boxing", "Chess", "Dance Sports",
        "Football", "Futsal", "Gymnastics", "Pencak Silat",
        "Sepak Takraw", "Softball", "Swimming", "Table Tennis",
        "Taekwondo", "Tennis", "Volleyball", "Wrestling",
        "Weightlifting", "Wushu", "Paragames"
    };

    private List<string> _regionsList = new()
    {
        "NCR", "Caraga", "BARMM", "CAR",
        "Region I", "Region II", "Region III", "Region IV-A",
        "Region IV-B", "Region V", "Region VI", "Region VII",
        "Region VIII", "Region IX", "Region X", "Region XI", "Region XII"
    };

    protected override async Task OnInitializedAsync()
    {
        ChatService.OnMessagesChanged += OnMessagesChanged;
        var serviceMessages = await ChatService.GetMessagesAsync();
        _messages = serviceMessages.ToList();
    }

    private void OnMessagesChanged() => _ = OnMessagesChangedAsync();

    private async Task OnMessagesChangedAsync()
    {
        var newMessages = await ChatService.GetMessagesAsync();
        if (_messages.Count != newMessages.Count)
        {
            _messages = newMessages.ToList();
            await InvokeAsync(StateHasChanged);
            await ScrollToBottom();
        }
    }

    private void ToggleVenueSelection(bool show)
    {
        _showVenueSelection = show;
        _showGuidelinesSelection = false;
        _showMedalTallySelection = false;
        _showMainMenu = false;

        if (show)
        {
            _wasInVenueSelection = true;
            _wasInGuidelinesSelection = false;
            _wasInMedalTallySelection = false;
        }
        StateHasChanged();
    }

    private void ToggleGuidelinesSelection(bool show)
    {
        _showGuidelinesSelection = show;
        _showVenueSelection = false;
        _showMedalTallySelection = false;
        _showMainMenu = false;

        if (show)
        {
            _wasInGuidelinesSelection = true;
            _wasInVenueSelection = false;
            _wasInMedalTallySelection = false;
        }
        StateHasChanged();
    }

    private void ToggleMedalTallySelection(bool show)
    {
        _showMedalTallySelection = show;
        _showVenueSelection = false;
        _showGuidelinesSelection = false;
        _showMainMenu = false;

        if (show)
        {
            _wasInMedalTallySelection = true;
            _wasInVenueSelection = false;
            _wasInGuidelinesSelection = false;
        }
        StateHasChanged();
    }

    private void ShowMainMenu()
    {
        _showVenueSelection = false;
        _showGuidelinesSelection = false;
        _showMedalTallySelection = false;
        _showMainMenu = true;
        StateHasChanged();
    }

    private void CloseAllMenus()
    {
        _showVenueSelection = false;
        _showGuidelinesSelection = false;
        _showMedalTallySelection = false;
        _showMainMenu = false;
        StateHasChanged();
    }

    private async Task SelectSportVenue(string sport)
    {
        _wasInVenueSelection = true;
        _showVenueSelection = false;
        await SetInputAndSend($"Where is the venue for {sport}?");
    }

    private async Task SelectSportGuidelines(string sport)
    {
        _wasInGuidelinesSelection = true;
        _showGuidelinesSelection = false;
        await SetInputAndSend($"Tell me the guidelines for {sport} in Palaro 2026.");
    }

    private async Task SelectLeadingRegion()
    {
        _wasInMedalTallySelection = true;
        _showMedalTallySelection = false;
        await SetInputAndSend("Who is leading the medal tally?");
    }

    private async Task SelectRegionStats(string region)
    {
        _wasInMedalTallySelection = true;
        _showMedalTallySelection = false;
        await SetInputAndSend($"Show me the medal tally for {region}.");
    }

    private async Task SetInputAndSend(string text)
    {
        _messageInput = text;
        await AutoExpandTextarea();
        await SendMessage();
    }

    private async Task AutoExpandTextarea()
    {
        try { await JS.InvokeVoidAsync("eval", "var el = document.getElementById('chatInputBox'); window.expandTextarea(el);"); } catch { }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_messageInput)) return;

        var textToSend = _messageInput;
        _messageInput = string.Empty;

        await JS.InvokeVoidAsync("eval", "var el = document.getElementById('chatInputBox'); if(el) el.style.height = 'auto';");

        _messages.Add(new ChatMessage { Content = textToSend, IsUser = true, Timestamp = DateTime.Now });

        _isSending = true;
        _showMainMenu = false;
        _showVenueSelection = false;
        _showGuidelinesSelection = false;
        _showMedalTallySelection = false;

        StateHasChanged();
        await ScrollToBottom();

        await ChatService.SendMessageAsync(textToSend);

        var updatedMessages = await ChatService.GetMessagesAsync();
        _messages = updatedMessages.ToList();

        _isSending = false;

        if (_wasInVenueSelection) _showVenueSelection = true;
        else if (_wasInGuidelinesSelection) _showGuidelinesSelection = true;
        else if (_wasInMedalTallySelection) _showMedalTallySelection = true;

        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey) await SendMessage();
    }

    private async Task ToggleChat()
    {
        _isOpen = !_isOpen;
        if (_isOpen) { await Task.Delay(100); await ScrollToBottom(); }
    }

    private async Task ScrollToBottom()
    {
        try { await JS.InvokeVoidAsync("eval", "var el = document.querySelector('.chat-scroll-container'); if(el) el.scrollTop = el.scrollHeight;"); } catch { }
    }

    private string GetFormattedMessage(string content)
    {
        if (string.IsNullOrWhiteSpace(content)) return string.Empty;
        if (content.TrimStart().StartsWith("{")) { try { using var doc = JsonDocument.Parse(content); if (doc.RootElement.TryGetProperty("output", out var o)) content = o.GetString() ?? content; } catch { } }

        content = InjectEmojis(content);
        content = System.Net.WebUtility.HtmlEncode(content);

        var sb = new StringBuilder();
        var lines = content.Split('\n');
        bool inList = false;

        foreach (var line in lines)
        {
            var trimmedLine = line.Trim();
            if (trimmedLine.StartsWith("- ") || trimmedLine.StartsWith("* "))
            {
                if (!inList) { sb.Append("<ul>"); inList = true; }
                sb.Append($"<li>{FormatInline(trimmedLine.Substring(2))}</li>");
            }
            else if (Regex.IsMatch(trimmedLine, @"^\d+\.\s"))
            {
                if (!inList) { sb.Append("<ul>"); inList = true; }
                sb.Append($"<li>{FormatInline(Regex.Replace(trimmedLine, @"^\d+\.\s", ""))}</li>");
            }
            else
            {
                if (inList) { sb.Append("</ul>"); inList = false; }
                if (string.IsNullOrWhiteSpace(trimmedLine)) continue;
                if (trimmedLine.StartsWith("#")) sb.Append($"<p><strong>{FormatInline(Regex.Replace(trimmedLine, @"^#+\s", ""))}</strong></p>");
                else sb.Append($"<p>{FormatInline(trimmedLine)}</p>");
            }
        }
        if (inList) sb.Append("</ul>");
        return sb.ToString();
    }

    private string InjectEmojis(string text)
    {
        if (text.Contains("🏀") || text.Contains("🥇")) return text;
        var replacements = new Dictionary<string, string>
        {
            { @"\bBasketball\b", "Basketball 🏀" },
            { @"\bVolleyball\b", "Volleyball 🏐" },
            { @"\bSwimming\b", "Swimming 🏊" },
            { @"\bFootball\b", "Football ⚽" },
            { @"\bGold\b", "Gold 🥇" },
            { @"\bSilver\b", "Silver 🥈" },
            { @"\bBronze\b", "Bronze 🥉" },
            { @"\bChampion\b", "Champion 🏆" },
            { @"\bSchedule\b", "Schedule 📅" },
            { @"\bVenue\b", "Venue 📍" },
            { @"\bPalaro\b", "Palaro 🔥" }
        };
        foreach (var kvp in replacements) text = Regex.Replace(text, kvp.Key, kvp.Value, RegexOptions.IgnoreCase);
        return text;
    }

    private string FormatInline(string text)
    {
        text = Regex.Replace(text, @"\[([^\]]+)\][\r\n\s]*\((https?:\/\/[^)]+)\)", $"<a href='$2' target='_blank' style='color: #023E8A; text-decoration: underline; font-weight: bold;'>$1</a>");
        text = Regex.Replace(text, @"\*\*(.*?)\*\*", "<strong>$1</strong>");
        text = Regex.Replace(text, @"\*(.*?)\*", "<em>$1</em>");
        string rawUrlPattern = @"(?<!href=['""])((http|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&amp;:/~\+#]*[\w\-\@?^=%&amp;/~\+#])?)";
        text = Regex.Replace(text, rawUrlPattern, "<a href='$1' target='_blank' style='color: #023E8A; text-decoration: underline;'>$1</a>");
        return text;
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        ChatService.OnMessagesChanged -= OnMessagesChanged;
    }
}

<script suppress-error="BL9992">
    window.expandTextarea = function(el) {
        if (el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; }
    };
</script>