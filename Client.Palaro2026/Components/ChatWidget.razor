@using Client.Palaro2026.Services
@using System.Text.Json
@using System.Text.RegularExpressions
@using System.Text 
@inject IChatService ChatService
@inject IJSRuntime JS
@implements IAsyncDisposable

<style>
    :root {
        /* Minimalist Sports Palette */
        --min-primary: #0f172a;    /* Deep Navy */
        --min-accent: #f59e0b;     /* Sport Gold */
        --min-bg: #ffffff;
        --min-gray: #f8fafc;
        --min-border: #e2e8f0;
    }

    /* --- Chat Window --- */
    .chat-window {
        transition: all 0.3s ease-in-out;
        transform-origin: bottom right;
        opacity: 0;
        transform: translateY(15px);
        visibility: hidden;
        pointer-events: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.12);
        border: 1px solid var(--min-border);
        background: var(--min-bg);
    }

    .chat-window.open {
        opacity: 1;
        transform: translateY(0);
        visibility: visible;
        pointer-events: auto;
    }

    /* --- Scrollbar --- */
    .chat-scroll-container::-webkit-scrollbar { width: 4px; }
    .chat-scroll-container::-webkit-scrollbar-track { background: transparent; }
    .chat-scroll-container::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 4px;
    }

    /* --- Minimalist Bubbles --- */
    .bubble-user {
        background-color: var(--min-primary);
        color: white;
        border-radius: 16px 16px 2px 16px;
    }

    .bubble-ai {
        background-color: var(--min-gray);
        color: #334155;
        border-radius: 16px 16px 16px 2px;
    }

    /* --- FORMATTING STYLES (Para Plastar ang Output) --- */
    .bubble-content {
        line-height: 1.5;
        font-size: 0.9rem;
    }
    .bubble-content p {
        margin-bottom: 8px; /* Space between paragraphs */
        margin-top: 0;
    }
    .bubble-content ul, .bubble-content ol {
        margin-top: 4px;
        margin-bottom: 8px;
        padding-left: 20px; /* Indent lists */
    }
    .bubble-content li {
        margin-bottom: 4px;
    }
    .bubble-content strong {
        font-weight: 700;
        color: inherit;
    }
    /* Links inside bubbles */
    .bubble-ai a { color: #0284c7; text-decoration: underline; }
    .bubble-user a { color: #fbbf24; text-decoration: underline; }

    /* --- Timestamp Styling --- */
    .msg-timestamp {
        font-size: 0.65rem;
        color: #94a3b8;
        margin-top: 2px;
        margin-left: 4px;
        margin-right: 4px;
    }

    /* --- Expandable Input Area --- */
    .input-area {
        border-top: 1px solid var(--min-border);
        background: var(--min-bg);
        padding: 12px 16px;
        align-items: flex-end; 
    }

    .clean-textarea {
        width: 100%;
        border: none;
        outline: none;
        font-size: 0.9rem;
        color: #334155;
        background: transparent;
        resize: none; 
        max-height: 120px; 
        overflow-y: auto;
        padding: 0;
        margin-bottom: 4px; 
        font-family: inherit;
        line-height: 1.4;
    }
    .clean-textarea::placeholder { color: #94a3b8; }

    /* --- Typing Dots --- */
    .typing-dot {
        width: 5px; height: 5px;
        background-color: #94a3b8;
        border-radius: 50%;
        animation: simpleBounce 1.4s infinite ease-in-out both;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    @@keyframes simpleBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

    /* --- Mobile --- */
    @@media (max-width: 600px) {
        .chat-window {
            bottom: 0 !important; right: 0 !important;
            width: 100% !important; height: 100% !important;
            max-height: 100vh !important; border-radius: 0 !important;
        }
    }
</style>

<!-- CHAT WINDOW -->
<MudPaper Elevation="0"
          Class="@($"chat-window fixed d-flex flex-column overflow-hidden rounded-xl {(_isOpen ? "open" : "")}")"
          Style="bottom:90px; right:20px; width:360px; height:600px; max-height:80vh; z-index:2000;">

    <!-- MINIMAL HEADER -->
    <div class="d-flex align-center px-4 py-3" style="background: white; border-bottom: 1px solid var(--min-border);">
        <MudImage Src="./media/images/palaro2026.png" Height="24" Width="24" ObjectFit="ObjectFit.Contain" Class="mr-3" />
        
        <div class="d-flex flex-column flex-grow-1">
            <MudText Typo="Typo.subtitle2" Class="fw-bold" Style="color: var(--min-primary);">Palaro Assistant</MudText>
            <MudText Typo="Typo.caption" Style="color: #94a3b8; font-size: 0.7rem;">Online</MudText>
        </div>

        <MudIconButton Icon="@Icons.Material.Rounded.Close" Color="Color.Default" Size="Size.Small" OnClick="ToggleChat" />
    </div>

    <!-- MESSAGES AREA -->
    <div class="flex-grow-1 overflow-auto px-4 pt-4 chat-scroll-container"
         @ref="_messagesContainer"
         style="background: white;">

        @if (_messages.Count == 0)
        {
            <div class="d-flex flex-column align-center justify-center h-100 pb-10">
                <!-- Large Logo in Empty State -->
                <div class="d-flex align-center justify-center mb-4" style="width: 80px; height: 80px; background: #f8fafc; border-radius: 50%;">
                     <MudImage Src="./media/images/palaro2026.png" Height="50" Width="50" ObjectFit="ObjectFit.Contain" />
                </div>
                
                <MudText Typo="Typo.body2" Class="fw-bold" Style="color: var(--min-primary);">Welcome to Palaro 2026</MudText>
                <MudText Typo="Typo.caption" Class="text-center mt-1 px-4" Style="color: #94a3b8;">
                    Ask about schedules, sports results, or venues.
                </MudText>
                
                <div class="mt-6 d-flex gap-2">
                    <MudChip T="string" Size="Size.Small" OnClick="@(() => SetInputAndSend("Game Schedule"))" Variant="Variant.Outlined" Color="Color.Default">Schedule</MudChip>
                    <MudChip T="string" Size="Size.Small" OnClick="@(() => SetInputAndSend("Venues"))" Variant="Variant.Outlined" Color="Color.Default">Venues</MudChip>
                </div>
            </div>
        }
        else
        {
            <MudStack Spacing="3" Class="pb-4">
                @foreach (var message in _messages)
                {
                    <div class="d-flex w-100 @(message.IsUser ? "justify-end" : "justify-start")">
                        
                        <!-- AI PROFILE PIC (Only shows if not user) -->
                        @if (!message.IsUser)
                        {
                            <MudAvatar Size="Size.Small" Class="mr-2 mt-1" Style="background: transparent;">
                                <MudImage Src="./media/images/palaro2026.png" ObjectFit="ObjectFit.Contain" />
                            </MudAvatar>
                        }

                        <div class="d-flex flex-column" style="max-width: 80%;">
                            <!-- Bubble with Enhanced Content Class -->
                            <div class="pa-3 px-4 @(message.IsUser ? "bubble-user" : "bubble-ai")">
                                <div class="bubble-content">
                                    @((MarkupString)GetFormattedMessage(message.Content))
                                </div>
                            </div>

                            <!-- Timestamp -->
                            <div class="d-flex @(message.IsUser ? "justify-end" : "justify-start")">
                                <span class="msg-timestamp">@message.Timestamp.ToString("h:mm tt")</span>
                            </div>
                        </div>

                    </div>
                }

                @if (_isSending)
                {
                    <div class="d-flex w-100 justify-start">
                        <!-- AI Avatar for loading state too -->
                        <MudAvatar Size="Size.Small" Class="mr-2 mt-1" Style="background: transparent;">
                                <MudImage Src="./media/images/palaro2026.png" ObjectFit="ObjectFit.Contain" />
                        </MudAvatar>

                        <div class="bubble-ai pa-3 px-4 d-flex align-center gap-1">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                    </div>
                }
            </MudStack>
        }
    </div>

    <!-- INPUT AREA -->
    <div class="input-area d-flex">
        <textarea @bind="_messageInput"
                  @bind:event="oninput"
                  @onkeydown="HandleKeyDown"
                  id="chatInputBox"
                  placeholder="Type a message..."
                  disabled="@_isSending"
                  rows="1"
                  class="clean-textarea flex-grow-1"></textarea>

        <MudIconButton Icon="@Icons.Material.Rounded.Send"
                       Color="Color.Primary"
                       Size="Size.Small"
                       Disabled="@(string.IsNullOrWhiteSpace(_messageInput) || _isSending)"
                       OnClick="SendMessage"
                       Class="ml-2 mb-1" 
                       Variant="Variant.Text" />
    </div>

</MudPaper>

<!-- FAB TRIGGER -->
<div style="position: fixed; bottom: 25px; right: 25px; z-index: 1999;">
    <MudFab OnClick="ToggleChat"
            Color="Color.Primary"
            StartIcon="@(_isOpen ? Icons.Material.Rounded.Close : Icons.Material.Rounded.Chat)"
            Class="mud-elevation-8"
            Style="background-color: var(--min-primary); transition: transform 0.2s;" />
</div>

@code {
    private List<ChatMessage> _messages = new();
    private string _messageInput = string.Empty;
    private bool _isOpen;
    private bool _isSending;
    private ElementReference _messagesContainer;

    protected override async Task OnInitializedAsync()
    {
        ChatService.OnMessagesChanged += OnMessagesChanged;
        _messages = await ChatService.GetMessagesAsync();
    }

    private void OnMessagesChanged() => _ = OnMessagesChangedAsync();

    private async Task OnMessagesChangedAsync()
    {
        var newMessages = await ChatService.GetMessagesAsync();
        if (_messages.Count != newMessages.Count)
        {
            _messages = newMessages;
            await InvokeAsync(StateHasChanged);
            await ScrollToBottom();
        }
    }

    private async Task SetInputAndSend(string text)
    {
        _messageInput = text;
        await AutoExpandTextarea();
        await SendMessage();
    }

    private async Task AutoExpandTextarea()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", "var el = document.getElementById('chatInputBox'); window.expandTextarea(el);");
        }
        catch { }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_messageInput)) return;

        var textToSend = _messageInput;
        _messageInput = string.Empty;

        await JS.InvokeVoidAsync("eval", "var el = document.getElementById('chatInputBox'); if(el) el.style.height = 'auto';");

        // Optimistic Update
        _messages.Add(new ChatMessage 
        { 
            Content = textToSend, 
            IsUser = true, 
            Timestamp = DateTime.Now 
        });

        _isSending = true;
        StateHasChanged(); 
        await ScrollToBottom();

        await ChatService.SendMessageAsync(textToSend);

        var updatedMessages = await ChatService.GetMessagesAsync();
        _messages = updatedMessages; 
        
        _isSending = false;

        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private async Task ToggleChat()
    {
        _isOpen = !_isOpen;
        if (_isOpen)
        {
            await Task.Delay(100);
            await ScrollToBottom();
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", "var el = document.querySelector('.chat-scroll-container'); if(el) el.scrollTop = el.scrollHeight;");
        }
        catch { }
    }

    // --- ENHANCED FORMATTING LOGIC (Para Plastar) ---
    private string GetFormattedMessage(string content)
    {
        if (string.IsNullOrWhiteSpace(content)) return string.Empty;

        // 1. JSON CLEANING
        if (content.TrimStart().StartsWith("{"))
        {
            try
            {
                using var doc = JsonDocument.Parse(content);
                if (doc.RootElement.TryGetProperty("output", out var o)) content = o.GetString() ?? content;
            }
            catch { }
        }

        // 2. ESCAPE HTML (Security First)
        content = System.Net.WebUtility.HtmlEncode(content);

        // 3. PROCESS MARKDOWN-LIKE SYNTAX LINE BY LINE
        var sb = new StringBuilder();
        var lines = content.Split('\n');
        bool inList = false;

        foreach (var line in lines)
        {
            var trimmedLine = line.Trim();

            // Detect Bullet Points (- item or * item)
            if (trimmedLine.StartsWith("- ") || trimmedLine.StartsWith("* "))
            {
                if (!inList)
                {
                    sb.Append("<ul>");
                    inList = true;
                }
                var text = trimmedLine.Substring(2);
                sb.Append($"<li>{FormatInline(text)}</li>");
            }
            // Detect Numbered Lists (1. item)
            else if (Regex.IsMatch(trimmedLine, @"^\d+\.\s"))
            {
                // Simple approach: treat numbered lists as bullets for chat simplicity, 
                // or you could add 'inOrderedList' logic. 
                // Let's stick to simple list for now to avoid complexity bugs.
                if (!inList)
                {
                    sb.Append("<ul>");
                    inList = true;
                }
                var text = Regex.Replace(trimmedLine, @"^\d+\.\s", "");
                sb.Append($"<li>{FormatInline(text)}</li>");
            }
            else
            {
                if (inList)
                {
                    sb.Append("</ul>");
                    inList = false;
                }

                if (string.IsNullOrWhiteSpace(trimmedLine))
                {
                    // Empty lines become spacing
                    continue; 
                }

                // Headers (### Header) -> Convert to Bold paragraph
                if (trimmedLine.StartsWith("### ") || trimmedLine.StartsWith("## ") || trimmedLine.StartsWith("# "))
                {
                    var text = Regex.Replace(trimmedLine, @"^#+\s", "");
                    sb.Append($"<p><strong>{FormatInline(text)}</strong></p>");
                }
                else
                {
                    // Standard Paragraph
                    sb.Append($"<p>{FormatInline(trimmedLine)}</p>");
                }
            }
        }

        if (inList) sb.Append("</ul>");

        return sb.ToString();
    }

    // Helper for Bold, Italic, Links inside lines
    private string FormatInline(string text)
    {
        // Bold (**text**)
        text = Regex.Replace(text, @"\*\*(.*?)\*\*", "<strong>$1</strong>");
        
        // Italic (*text*)
        text = Regex.Replace(text, @"\*(.*?)\*", "<em>$1</em>");

        // Links
        text = Regex.Replace(text, 
            @"((http|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&amp;:/~\+#]*[\w\-\@?^=%&amp;/~\+#])?)", 
            "<a href='$1' target='_blank'>$1</a>");

        return text;
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        ChatService.OnMessagesChanged -= OnMessagesChanged;
    }
}

<script suppress-error="BL9992">
    window.expandTextarea = function(el) {
        if (el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }
    };
</script>