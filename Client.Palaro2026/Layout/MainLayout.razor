@inherits LayoutComponentBase

@inject IJSRuntime JSRuntime
@inject NavigationManager uriHelper
@inject ThemeService ThemeService

@* Required *@
<MudThemeProvider @ref="_mudThemeProvider" Theme="PalaroTheme" DefaultScrollbar="true" IsDarkMode="@(ThemeService.IsDarkMode ?? false)" />
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

<MudLayout>
    <MudHidden Breakpoint="Breakpoint.SmAndDown">
        <MudAppBar Elevation="0">
            <MudLink Href="./" Underline="Underline.None">
                <MudStack Row AlignItems="AlignItems.Center">
                    <MudImage Height="50" Src="./media/logo/Flat Logo with 2026.png" />
                    <MudStack Spacing="0" AlignItems="AlignItems.Start" Justify="Justify.Center" Style="height: 100%" Class="mr-10">
                        <MudText Typo="Typo.h5" Color="Color.Dark" Style="font-weight: bold" Class="mb-n2">PALARO 2026</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Dark">Agusan del Sur</MudText>
                    </MudStack>
                </MudStack>
            </MudLink>
            <NavigationMenu />
            <MudSpacer />

            <!-- Night mode button -->
            <MudTooltip Text="@GetThemeTooltip()" Arrow="true" Placement="Placement.Left">
                <MudIconButton OnClick="ToggleDarkMode" Icon="@GetThemeIcon()" />
            </MudTooltip>
        </MudAppBar>
    </MudHidden>
    <MudHidden Breakpoint="Breakpoint.SmAndUp">
        <MudAppBar Elevation="0" Gutters="false">
            <MudStack Row Justify="Justify.SpaceBetween" Style="width: 100%">
                <MudIconButton Icon="@Icons.Material.Filled.Menu" OnClick="@ToggleDrawer" />
                <MudImage Height="50" Src="./media/logo/Flat Logo with 2026.png" />
                <MudIconButton OnClick="ToggleDarkMode" Icon="@GetThemeIcon()" />
            </MudStack>
        </MudAppBar>
        <MudDrawer @bind-Open="@_open" >
            <MudDrawerHeader Dense="true" Class="pa-1">
                <MudStack Row Justify="Justify.FlexStart">
                    <MudImage Height="50" Src="./media/logo/Flat Logo with 2026.png" />
                    <MudStack Spacing="0" AlignItems="AlignItems.Start" Justify="Justify.Center" Style="height: 100%" Class="mr-10">
                        <MudText Style="font-weight: bold; font-size: 20px" Class="mb-n2">PALARO 2026</MudText>
                        <MudText Typo="Typo.caption">Agusan del Sur</MudText>
                    </MudStack>
                </MudStack>
            </MudDrawerHeader>
            <MudDrawerContainer Class="mt-3">
                <NavigationMenu />
            </MudDrawerContainer>
        </MudDrawer>
    </MudHidden>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code
{
    private MudThemeProvider? _mudThemeProvider;

    protected override async Task OnInitializedAsync()
    {
        ThemeService.OnThemeChanged += StateHasChanged;
        await ThemeService.LoadThemePreference();
    }

    private async Task ToggleDarkMode()
    {
        await ThemeService.ToggleDarkModeAsync();
    }

    private string GetThemeIcon()
    {
        if (!ThemeService.UserSelectedTheme)
            return Icons.Material.Filled.AutoMode;

        return ThemeService.IsDarkMode switch
        {
            true => Icons.Material.Filled.DarkMode,
            false => Icons.Material.Filled.LightMode,
            _ => Icons.Material.Filled.Help // fallback if something goes wrong
        };
    }

    private string GetThemeTooltip()
    {
        if (!ThemeService.UserSelectedTheme)
            return "System Theme";

        return ThemeService.IsDarkMode switch
        {
            true => "Dark Mode",
            false => "Light Mode",
            _ => "Unknown Theme"
        };
    }

    private MudTheme PalaroTheme = new MudTheme()
        {
            PaletteLight = new PaletteLight()
            {
                Dark = Colors.Gray.Darken4,
                White = Colors.Gray.Lighten5,
                Primary = "1e4ca1",
                Secondary = "ebb94d",
                Tertiary = "ba3535",
                ActionDefault = Colors.Gray.Darken4,
                AppbarBackground = Colors.Shades.White,
                AppbarText = Colors.Shades.Black,
                TextPrimary = Colors.Shades.Black,
            },
            PaletteDark = new PaletteDark()
            {
                Dark = Colors.Gray.Lighten5,
                White = Colors.Gray.Darken4,
                Primary = "4a7ad3",
                Secondary = "f8d589",
                Tertiary = "db5a5a",
                Background = Colors.Gray.Darken4,
                Surface = Colors.Gray.Darken4,
                DrawerBackground = Colors.Gray.Darken4,
                ActionDefault = Colors.Gray.Lighten5,
                AppbarBackground = Colors.Gray.Darken4,
                AppbarText = Colors.Gray.Lighten5,
                TextPrimary = Colors.Shades.White
            },
            LayoutProperties = new LayoutProperties()
            {
                DrawerWidthLeft = "280px"
            },
            Typography = new Typography()
            {
                Default = new DefaultTypography()
                {
                    FontFamily = new[] { "Inter", "sans-serif" },
                },
            }
        };

    private bool _open = false;

    private void ToggleDrawer()
    {
        _open = !_open;
    }
}