@page "/billeting-quarters"

@using System.Text.Json
@inject IJSRuntime JSRuntime
@inject ColorService ColorService

<MudContainer Gutters="false" MaxWidth="MaxWidth.False">
    <MudPaper Square Elevation="0" Class="ma-3 pa-2" Style="z-index: 1; position: absolute">
        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Color="Color.Primary" />
            <MudSelect Margin="Margin.Dense" Clearable T="string" Variant="Variant.Outlined"
                       Value="@newLocation"
                       ValueChanged="HandleLocationChange"
                       FullWidth Label="Regional Teams"
                       AnchorOrigin="Origin.BottomCenter"
                       OnClearButtonClick="ClearSelection">
                <MudVirtualize Items="regionContents" Context="quarterData">
                    <MudSelectItem T="string" Value="@quarterData.Region">
                        <MudText Typo="Typo.body2">@quarterData.Region (@quarterData.Abbreviation)</MudText>
                    </MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudStack>
        @if (selectedRegion != null)
        {
            <MudPaper Elevation="0" Style="margin-top: 15px;">
                <MudStack Spacing="5">
                    <MudStack Spacing="2">
                        <MudStack Spacing="0">
                            <MudText><b>Quarter</b></MudText>
                            <MudDivider />
                        </MudStack>
                        <MudStack Row AlignItems="AlignItems.Center">
                            <MudIcon Color="Color.Primary" Size="Size.Small" Icon="@Icons.Material.Filled.School"></MudIcon>
                            <MudText Typo="Typo.body2">@selectedRegion.BilletingQuarterList?.FirstOrDefault()?.BilletingQuarter</MudText>
                        </MudStack>
                        <MudStack Row AlignItems="AlignItems.Center">
                            <MudIcon Color="Color.Primary" Size="Size.Small" Icon="@Icons.Material.Filled.LocationOn"></MudIcon>
                            <MudText Typo="Typo.body2">@selectedRegion.BilletingQuarterList?.FirstOrDefault()?.Address</MudText>
                        </MudStack>
                    </MudStack>
                    <MudStack Spacing="2">
                        <MudStack Spacing="0">
                            <MudText><b>Contact Person</b></MudText>
                            <MudDivider />
                        </MudStack>
                        <MudStack Row AlignItems="AlignItems.Center">
                            <MudIcon Color="Color.Primary" Size="Size.Small" Icon="@Icons.Material.Filled.Person"></MudIcon>
                            <MudText Typo="Typo.body2">@selectedRegion.BilletingQuarterList?.FirstOrDefault()?.ContactPerson</MudText>
                        </MudStack>
                        <MudStack Row AlignItems="AlignItems.Center">
                            <MudIcon Color="Color.Primary" Size="Size.Small" Icon="@Icons.Material.Filled.Phone"></MudIcon>
                            <MudText Typo="Typo.body2">@selectedRegion.BilletingQuarterList?.FirstOrDefault()?.ContactPersonNumber</MudText>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper>
        }
    </MudPaper>
    <MudStack id="map" Style="width: 100%; height: calc(100vh - 64px); overflow: hidden"></MudStack>
</MudContainer>
<style>
    :root {
        color: @ColorService.SelectedColor; /* Default color */
    }
</style>
@code {
    private readonly string API_URL = APIService.Palaro2026API;
    private string mapboxToken = MapBoxService.mapboxToken;
    private string? newLocation;
    private RegionContent? selectedRegion;
    private List<RegionContent>? regionContents;
    private List<BilletingQuartersContent>? quarterContents;

    public class RegionContent
    {
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public List<BilletingQuartersContent>? BilletingQuarterList { get; set; }
    }

    public class BilletingQuartersContent
    {
        public string? BilletingQuarter { get; set; }
        public string? Address { get; set; }
        public decimal? Latitude { get; set; }
        public decimal? Longitude { get; set; }
        public string? ContactPerson { get; set; }
        public string? ContactPersonNumber { get; set; }
    }

    private async Task GetBilletingQuarters()
    {
        try
        {
            using HttpClient httpClient = new HttpClient();
            HttpResponseMessage httpResponse = await httpClient.GetAsync($"{API_URL}/BilletingQuarters/BilletingQuartersDetails");
            httpResponse.EnsureSuccessStatusCode();

            using var responseStream = await httpResponse.Content.ReadAsStreamAsync();
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            regionContents = await JsonSerializer.DeserializeAsync<List<RegionContent>>(responseStream, options);


            // Populate quarterContents from regionContents
            quarterContents = regionContents?
                .SelectMany(region => region.BilletingQuarterList ?? new List<BilletingQuartersContent>())
                .ToList();
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
        }
    }

    private async Task ClearSelection()
    {
        newLocation = null;
        selectedRegion = null;
        await JSRuntime.InvokeVoidAsync("clearRoute");
        await JSRuntime.InvokeVoidAsync("centerMap", null);
    }

    private async Task HandleLocationChange(string? selectedValue)
    {
        if (string.IsNullOrEmpty(selectedValue)) return;

        newLocation = selectedValue;
        selectedRegion = regionContents?.FirstOrDefault(region => region.Region == newLocation);

        if (selectedRegion?.BilletingQuarterList?.FirstOrDefault() is { Latitude: { }, Longitude: { } } billetingQuarter)
        {
            await JSRuntime.InvokeVoidAsync("showDirections", new object[] {
                new decimal[] { (decimal)billetingQuarter.Longitude.Value, (decimal)billetingQuarter.Latitude.Value }
    });
        }
        else
        {
            Console.WriteLine("No matching venue found or invalid coordinates.");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await GetBilletingQuarters();
        await JSRuntime.InvokeVoidAsync("initializeMap", "map", mapboxToken, quarterContents);
    }
}
