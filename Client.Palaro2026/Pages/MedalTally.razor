@page "/medal-tally"

@using System.Net.Http
@using System.Text.Json
@using System.Threading.Tasks
@using Client.Palaro2026.Services
@inject IDialogService DialogService
@inject APIService apiService
@inject HttpClient httpClient
@inject NavigationManager navigationManager

<PageTitle>Medal tally | PALARO 2026 - Agusan del Sur</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudGrid>
        <MudItem xs="12">
                <MudText Typo="Typo.h2">Medal Tally</MudText>
                <MudText Typo="Typo.subtitle1">The medal tally shows the total number of medals won by each region.</MudText>
        </MudItem>
        <MudItem xs="12">
            <MudTabs KeepPanelsAlive Elevation="0" ApplyEffectsToContainer="true" PanelClass="pa-6" Centered>
                <MudTabPanel Style="text-transform: none" Text="Grand Total">
                    <MudTable Items="_regionalMedalTallies" HorizontalScrollbar="true" Virtualize SortLabel="Sort by" Elevation="0" AllowUnsorted="false" Context="region">
                        <ColGroup>
                            <MudHidden Breakpoint="Breakpoint.Xs">
                                <col style="width: 50%" />
                                <col style="width: 10%" />
                                <col style="width: 10%" />
                                <col style="width: 10%" />
                                <col style="width: 10%" />
                                <col style="width: 10%" />
                            </MudHidden>
                        </ColGroup>
                        <HeaderContent>
                            <MudTh Style="text-indent: 25px">
                                <MudTableSortLabel SortBy="new Func<MedalTallyDTO.RegionalMedalTally, object>(x => x.Region!)">Region</MudTableSortLabel>
                            </MudTh>
                            <MudTh>
                                <MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="new Func<MedalTallyDTO.RegionalMedalTally, object>(x => x.Gold!)">
                                    Gold
                                </MudTableSortLabel>
                            </MudTh>
                            <MudTh Style="text-align: center; text-indent: 12px">
                                <MudTableSortLabel SortBy="new Func<MedalTallyDTO.RegionalMedalTally, object>(x => x.Silver!)">
                                    Silver
                                </MudTableSortLabel>
                            </MudTh>
                            <MudTh Style="text-align: center; text-indent: 12px">
                                <MudTableSortLabel SortBy="new Func<MedalTallyDTO.RegionalMedalTally, object>(x => x.Bronze!)">
                                    Bronze
                                </MudTableSortLabel>
                            </MudTh>
                            <MudTh Style="text-align: center; text-indent: 12px">
                                <MudTableSortLabel SortBy="new Func<MedalTallyDTO.RegionalMedalTally, object>(x => x.Total!)">
                                    Total
                                </MudTableSortLabel>
                            </MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Region">
                                <MudStack Row AlignItems="AlignItems.Center">
                                    <MudImage Height="50" Src="@($"media/regions/{region.Abbreviation}.webp")" />
                                    <MudStack Spacing="0" Style="height: 100%" Justify="Justify.Center">
                                        <MudText Style="font-weight: bold; line-height: .8">
                                            @region.Abbreviation <br />
                                            <MudElement>
                                                <MudText Typo="Typo.caption">@region.Region</MudText>
                                            </MudElement>
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Gold" Style="text-align:center">
                                @if (region.Gold != 0)
                                {
                                    <MudAvatar Style="@($"background-color: {Colors.Amber.Accent4}")">@region.Gold</MudAvatar>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2">-</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Silver" Style="text-align:center">
                                @if (region.Silver != 0)
                                {
                                    <MudAvatar Style="@($"background-color: {Colors.BlueGray.Lighten4}")">@region.Silver</MudAvatar>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2">-</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Bronze" Style="text-align:center">
                                @if (region.Bronze != 0)
                                {
                                    <MudAvatar Style="@($"background-color: {Colors.DeepOrange.Lighten1}")">@region.Bronze</MudAvatar>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2">-</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Total" Style="text-align:center">
                                <MudText Typo="Typo.body1"><b>@region.Total</b></MudText>
                            </MudTd>
                            <MudTd DataLabel=""><MudIconButton Href="@($"./regional-teams/{region.Abbreviation}-{region.Region}")" Icon="@Icons.Material.Filled.ArrowForward" /></MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudTabPanel>
                <MudVirtualize Items="_schoolLevelMedalTallies" Context="schoolLevelMedalTally">
                    <MudTabPanel Style="text-transform: none" Text="@schoolLevelMedalTally.Level">
                        <MudTable Items="schoolLevelMedalTally.RegionalMedalTallyList" HorizontalScrollbar="true" Virtualize SortLabel="Sort by" Elevation="0" AllowUnsorted="false" Context="region">
                            <ColGroup>
                                <MudHidden Breakpoint="Breakpoint.Xs">
                                    <col style="width: 50%" />
                                    <col style="width: 10%" />
                                    <col style="width: 10%" />
                                    <col style="width: 10%" />
                                    <col style="width: 10%" />
                                    <col style="width: 10%" />
                                </MudHidden>
                            </ColGroup>
                            <HeaderContent>
                                <MudTh Style="text-indent: 25px">
                                    <MudTableSortLabel SortBy="new Func<MedalTallyDTO.SchoolLevelMedalTally.RegionalMedalTally, object>(x => x.Region!)">
                                        Region
                                    </MudTableSortLabel>

                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="new Func<MedalTallyDTO.SchoolLevelMedalTally.RegionalMedalTally, object>(x => x.Gold!)">
                                        Gold
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh Style="text-align: center; text-indent: 12px">
                                    <MudTableSortLabel SortBy="new Func<MedalTallyDTO.SchoolLevelMedalTally.RegionalMedalTally, object>(x => x.Silver!)">
                                        Silver
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh Style="text-align: center; text-indent: 12px">
                                    <MudTableSortLabel SortBy="new Func<MedalTallyDTO.SchoolLevelMedalTally.RegionalMedalTally, object>(x => x.Bronze!)">
                                        Bronze
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh Style="text-align: center; text-indent: 12px">
                                    <MudTableSortLabel SortBy="new Func<MedalTallyDTO.SchoolLevelMedalTally.RegionalMedalTally, object>(x => x.Total!)">
                                        Total
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh></MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">
                                    <MudStack Row AlignItems="AlignItems.Center">
                                        <MudImage Height="50" Src="@($"media/regions/{region.Abbreviation}.webp")" />
                                        <MudStack Spacing="0">
                                            <MudText Style="font-weight: bold; line-height: .8">@region.Abbreviation</MudText>
                                            <MudText Typo="Typo.caption">@region.Region</MudText>
                                        </MudStack>
                                    </MudStack>
                                </MudTd>
                                <MudTd DataLabel="Gold" Style="text-align:center">
                                    @if (region.Gold != 0)
                                    {
                                        <MudAvatar Style="@($"background-color: {Colors.Amber.Accent4}")">@region.Gold</MudAvatar>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Silver" Style="text-align:center">
                                    @if (region.Silver != 0)
                                    {
                                        <MudAvatar Style="@($"background-color: {Colors.BlueGray.Lighten4}")">@region.Silver</MudAvatar>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Bronze" Style="text-align:center">
                                    @if (region.Bronze != 0)
                                    {
                                        <MudAvatar Style="@($"background-color: {Colors.DeepOrange.Lighten1}")">@region.Bronze</MudAvatar>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Total" Style="text-align:center">
                                    <MudText Typo="Typo.body1"><b>@region.Total</b></MudText>
                                </MudTd>
                                <MudTd DataLabel=""><MudIconButton Href="@($"./regional-teams/{region.Abbreviation}-{region.Region}")" Icon="@Icons.Material.Filled.ArrowForward" /></MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudTabPanel>
                </MudVirtualize>
            </MudTabs>
        </MudItem>
    </MudGrid>
</MudContainer>
<FooterComponent />

@code {
    /* ---------------------------
       Variables

       - manages and stores and data coming from API calls

    --------------------------- */

    // Data storage for medal tally by region
    private List<MedalTallyDTO.RegionalMedalTally>? _regionalMedalTallies;
    // Data storage for medal tally by school level
    private List<MedalTallyDTO.SchoolLevelMedalTally.SchoolLevel>? _schoolLevelMedalTallies;

    /* ---------------------------
        Lifecycle Methods

        - methods that manage the component's lifecycle and state

    --------------------------- */

    // On component initialization, fetch medal tally data
    protected override async Task OnInitializedAsync()
    {
        // Fetch both regional and school level medal tallies
        await GetMedalTallyByRegionAsync();
        await GetMedalTallyBySchoolLevelAsync();
    }

    /* ---------------------------
       API Calls

       - methods for fetching data from APIs

    --------------------------- */

    // Fetch medal tally data grouped by region
    private async Task GetMedalTallyByRegionAsync()
    {
        const string url = "/MedalTally";
        _regionalMedalTallies = await apiService.GetAsync<MedalTallyDTO.RegionalMedalTally>(url);
    }

    // Fetch medal tally data grouped by school level
    private async Task GetMedalTallyBySchoolLevelAsync()
    {
        const string url = "/MedalTally/BySchoolLevel";
        _schoolLevelMedalTallies = await apiService.GetAsync<MedalTallyDTO.SchoolLevelMedalTally.SchoolLevel>(url);
    }

    /* ---------------------------
       DTO Classes

       - Data Transfer Objects for handling API responses
       Note: Please refer to the API documentation for more details.

    --------------------------- */

    // DTO for Medal Tally data
    public class MedalTallyDTO
    {
        public class RegionalMedalTally
        {
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
            public int? Gold { get; set; }
            public int? Silver { get; set; }
            public int? Bronze { get; set; }
            public int? Total { get; set; }
        }

        public class SchoolLevelMedalTally
        {
            public class SchoolLevel
            {
                public string? Level { get; set; }
                public List<RegionalMedalTally>? RegionalMedalTallyList { get; set; }
            }

            public class RegionalMedalTally
            {
                public string? Region { get; set; }
                public string? Abbreviation { get; set; }
                public int? Gold { get; set; }
                public int? Silver { get; set; }
                public int? Bronze { get; set; }
                public int? Total { get; set; }
            }
        }
    }
}

