@page "/regional-teams/{Abbreviation}-{Region}/players/{FirstName}-{LastName}"

@using System.Net.Http
@using System.Text.Json
@using System.Threading.Tasks
@inject IDialogService DialogService
@inject APIService apiService
@inject HttpClient httpClient

<PageTitle>@($"{FirstName} {LastName} - {Region} ({Abbreviation}) | Palaro 2026")</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudGrid>
        <MudItem xs="12">
            <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h2">@Abbreviation</MudText>
                    <MudText Typo="Typo.subtitle1">@Region</MudText>
                </MudStack>
                <MudImage Src="@($"media/regions/{Abbreviation}.webp")" Height="100" />
            </MudStack>
        </MudItem>
        <MudItem xs="12">
            <MudBreadcrumbs Style="font-size: 15px" Class="pa-0" Items="_items"></MudBreadcrumbs>
            <MudDivider />
        </MudItem>
        <MudItem xs="12">
            <MudText Typo="Typo.h2">@_profilePlayers?.FirstName @_profilePlayers?.LastName</MudText>
            <MudText><b>@_profilePlayers?.Sport</b> | @_profilePlayers?.Category</MudText>
            <MudText>@_profilePlayers?.Level</MudText>
            <MudText>@_profilePlayers?.School, @_profilePlayers?.Division</MudText>
        </MudItem>
        <MudItem xs="12">
            <MudDivider />
        </MudItem>
        <MudItem xs="12">
            <MudGrid>
                <MudVirtualize Items="@_profilePlayers?.ProfilePlayerSportsList" Context="sport">
                    <MudItem xs="6" md="4" lg="3">
                        <MudPaper Style="height: 100%">
                            <MudStack Class="pa-3" Style="height: 100%">
                                <MudText Typo="Typo.body2">
                                    @sport.Subcategory |
                                    <MudElement>
                                        @{
                                            string gender;

                                            if (sport.Gender == "Male")
                                            {
                                                gender = "♂️";
                                            }
                                            else if (sport.Gender == "Female")
                                            {
                                                gender = "♀️";
                                            }
                                            else
                                            {
                                                gender = "♂️♀️";
                                            }
                                        }
                                        <MudText Typo="Typo.caption">
                                            @gender
                                        </MudText>
                                    </MudElement>
                                    <MudDivider />
                                    @if (sport.ProfilePlayerSportCoachesList?.Count > 1)
                                    {
                                        <MudText Typo="Typo.caption">
                                            Coaches:
                                        </MudText>
                                    }
                                    else if (sport.ProfilePlayerSportCoachesList?.Count == 1)
                                    {
                                        <MudText Typo="Typo.caption">
                                            Coach:
                                        </MudText>
                                    }

                                    <MudStack Row Spacing="0" Wrap="Wrap.Wrap">
                                        <MudVirtualize Items="sport.ProfilePlayerSportCoachesList" Context="coach">
                                            <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">
                                                @coach.CoachFirstName @coach.CoachLastName
                                            </MudChip>
                                        </MudVirtualize>
                                    </MudStack>
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudVirtualize>
            </MudGrid>
        </MudItem>

    </MudGrid>
</MudContainer>
<FooterComponent />

@code {
    [Parameter]
    public string? Region { get; set; }
    [Parameter]
    public string? Abbreviation { get; set; }
    [Parameter]
    public string? FirstName { get; set; }
    [Parameter]
    public string? LastName { get; set; }

    private List<BreadcrumbItem> _items = new();

    private ProfilesDTO.ProfilePlayersDetails.ProfilePlayers? _profilePlayers;

    public class ProfilesDTO
    {
        public class ProfilePlayersDetails
        {
            public class ProfilePlayers
            {
                public int ID { get; set; }
                public string? FirstName { get; set; }
                public string? LastName { get; set; }
                public string? School { get; set; }
                public int? SchoolLevelID { get; set; }
                public string? Level { get; set; }
                public string? Division { get; set; }
                public int? RegionID { get; set; }
                public string? Region { get; set; }
                public string? Abbreviation { get; set; }
                public string? Category { get; set; }
                public int? SportID { get; set; }
                public string? Sport { get; set; }
                public List<ProfilePlayerSports>? ProfilePlayerSportsList { get; set; }
            }

            public class ProfilePlayerSports
            {
                public int ProfilePlayerSportID { get; set; }
                public string? Gender { get; set; }
                public string? Subcategory { get; set; }
                public List<ProfilePlayerSportCoaches>? ProfilePlayerSportCoachesList { get; set; }
            }

            public class ProfilePlayerSportCoaches
            {
                public string? CoachFirstName { get; set; }
                public string? CoachLastName { get; set; }
            }
        }

        public class ProfilePlayers
        {
            public int ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
            public int? SchoolID { get; set; }
            public int? SportID { get; set; }
        }
    }

    // Initialization
    protected override async Task OnInitializedAsync()
    {
        await GetPlayersProfileAsync();

        _items = new List<BreadcrumbItem>
        {
            new("Home", href: "./"),
            new("Regional Teams", href: "./regional-teams"),
            new($"{Region}", href: $"./regional-teams/{Abbreviation}-{Region}"),
            new("Players", href: $"./regional-teams/{Abbreviation}-{Region}/players"),
            new($"{FirstName} {LastName}", href: null, disabled: true)
        };
    }

    private async Task GetPlayersProfileAsync()
    {
        string url = $"/Profiles/Player/Details?region={Region}&firstName={FirstName}&lastName={LastName}";

        _profilePlayers = await apiService.GetSingleAsync<ProfilesDTO.ProfilePlayersDetails.ProfilePlayers>(url);
    }
}
