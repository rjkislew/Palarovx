@page "/events"

@using System.Net.Http
@using System.Text.Json
@using System.Threading.Tasks
@inject IDialogService DialogService
@inject APIService apiService
@inject HttpClient httpClient

<MudGrid>
    <!-- Content -->
    <MudItem xs="12">
        <MudContainer MaxWidth="MaxWidth.Large">
            <MudGrid>
                <MudItem xs="12">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudLink Href="./live-streams" Underline="Underline.None">
                                <MudPaper Outlined Class="pa-5">
                                    <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center" Style="width: 100%; height: 100%" Spacing="0">
                                        <MudText Typo="Typo.h2" Style="font-weight: bold">LIVE STREAM</MudText>
                                        <MudText Typo="Typo.caption">Watch the games live from anywhere with real-time streaming.</MudText>
                                    </MudStack>
                                </MudPaper>
                            </MudLink>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudLink Href="./venues" Underline="Underline.None">
                                <MudPaper Outlined Class="pa-5">
                                    <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center" Style="width: 100%; height: 100%" Spacing="0">
                                        <MudText Typo="Typo.h2" Style="font-weight: bold">VENUES</MudText>
                                        <MudText Typo="Typo.caption">Explore the locations where the events are taking place</MudText>
                                    </MudStack>
                                </MudPaper>
                            </MudLink>
                        </MudItem>
                    </MudGrid>
                </MudItem>
                <MudItem xs="12">
                    <MudStack AlignItems="AlignItems.Start">
                        <MudButton OnClick="OnExpandFilterCollapseClick" StartIcon="@(_expandedFilter ? @Icons.Material.Filled.FilterAltOff : @Icons.Material.Filled.FilterAlt)">Filter</MudButton>
                        <MudCollapse Expanded="_expandedFilter">
                            <MudStack Spacing="3">
                                <MudStack Spacing="0">
                                    <MudText>Regional Teams</MudText>
                                    <MudChipSet T="string" SelectedValues="_selectedEventTeams" SelectionMode="SelectionMode.MultiSelection" CheckMark SelectedValuesChanged="UpdateSelectedEventTeams">
                                        <MudVirtualize Items="_eventTeamList" Context="team">
                                            <MudChip Size="Size.Small" Variant="Variant.Text" Value="@team">@team</MudChip>
                                        </MudVirtualize>
                                        @if (_selectedEventTeams != null && _selectedEventTeams.Any())
                                        {
                                            <MudChip OnClick="ClearSelectedEventTeams" Variant="Variant.Text" Color="Color.Error" Size="Size.Small">
                                                Clear Selection
                                            </MudChip>
                                        }
                                    </MudChipSet>
                                </MudStack>
                                <MudStack Spacing="0">
                                    <MudText>Sports</MudText>
                                    <MudChipSet T="string" SelectedValues="_selectedSports" SelectionMode="SelectionMode.MultiSelection" CheckMark SelectedValuesChanged="UpdateSelectedSports">
                                        <MudVirtualize Items="_sportList" Context="sport">
                                            <MudChip Size="Size.Small" Variant="Variant.Text" Value="@sport">@sport</MudChip>
                                        </MudVirtualize>
                                        @if (_selectedSports != null && _selectedSports.Any())
                                        {
                                            <MudChip OnClick="ClearSelectedSports" Variant="Variant.Text" Color="Color.Error" Size="Size.Small">
                                                Clear Selection
                                            </MudChip>
                                        }
                                    </MudChipSet>
                                </MudStack>
                                <MudStack Spacing="0">
                                    <MudText>Event Stages</MudText>
                                    <MudChipSet T="string" SelectedValues="_selectedEventStages" SelectionMode="SelectionMode.MultiSelection" CheckMark SelectedValuesChanged="UpdateSelectedEventStages">
                                        <MudVirtualize Items="_eventStageList" Context="stage">
                                            <MudChip Size="Size.Small" Variant="Variant.Text" Value="@stage">@stage</MudChip>
                                        </MudVirtualize>
                                        @if (_selectedEventStages != null && _selectedEventStages.Any())
                                        {
                                            <MudChip OnClick="ClearSelectedEventStages" Variant="Variant.Text" Color="Color.Error" Size="Size.Small">
                                                Clear Selection
                                            </MudChip>
                                        }
                                    </MudChipSet>
                                </MudStack>
                                <MudStack Spacing="0">
                                    <MudText>Stream Services</MudText>
                                    <MudChipSet T="string" SelectedValues="_selectedStreamServices" SelectionMode="SelectionMode.MultiSelection" CheckMark SelectedValuesChanged="UpdateSelectedStreamServices">
                                        <MudVirtualize Items="_streamServiceList" Context="streamService">
                                            <MudChip Size="Size.Small" Variant="Variant.Text" Value="@streamService">@streamService</MudChip>
                                        </MudVirtualize>
                                        @if (_selectedStreamServices != null && _selectedStreamServices.Any())
                                        {
                                            <MudChip OnClick="ClearSelectedStreamServices" Variant="Variant.Text" Color="Color.Error" Size="Size.Small">
                                                Clear Selection
                                            </MudChip>
                                        }
                                    </MudChipSet>
                                </MudStack>
                            </MudStack>
                        </MudCollapse>
                    </MudStack>
                </MudItem>

                <MudFlexBreak />

                <MudItem xs="12">
                    @if (_eventDetails == null || !_eventDetails.Any())
                    {
                        <MudGrid>
                            @for (int i = 0; i < 3; i++)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="250px" />
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudGrid>
                            <MudVirtualize Items="_eventDetails" Context="eventDetail">
                                <MudItem xs="12" sm="6" md="4">
                                    <MudPaper Outlined Class="pa-3" Style="height: 100%">
                                        <MudStack Style="height: 100%" Justify="Justify.SpaceBetween">
                                            <MudStack>
                                                @* Sport Details *@
                                                <MudStack AlignItems="AlignItems.Start" Row Justify="Justify.SpaceBetween">
                                                    <MudStack Spacing="0">
                                                        <MudText Style="font-weight: bold">@eventDetail.Sport</MudText>
                                                        <MudText Typo="Typo.caption">@eventDetail.Subcategory</MudText>
                                                        <MudText Typo="Typo.caption" Class="mt-3" Style="word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                                                            #@eventDetail.Category?.Replace(" ", "") #@eventDetail.Level?.Replace(" ", "") #@eventDetail.EventStage?.Replace(" ", "")
                                                            <MudElement>
                                                                #
                                                                @if (eventDetail.Gender == "Male")
                                                                {
                                                                    <MudText Typo="Typo.caption">Male♂️</MudText>
                                                                }
                                                                else if (eventDetail.Gender == "Female")
                                                                {
                                                                    <MudText Typo="Typo.caption">Female♀️</MudText>
                                                                }
                                                                else
                                                                {
                                                                    <MudText Typo="Typo.caption">Mixed♂️♀️</MudText>
                                                                }
                                                            </MudElement>
                                                        </MudText>
                                                    </MudStack>
                                                </MudStack>
                                                <MudDivider />
                                                @* Teams *@
                                                <MudStack>
                                                    @if (eventDetail.EventVersusList == null || !eventDetail.EventVersusList.Any())
                                                    {
                                                        <MudText Typo="Typo.caption">Opposing teams to be assigned.</MudText>
                                                    }
                                                    else if (eventDetail.IsFinished == true && eventDetail.EventStage == "Championship")
                                                    {
                                                        <MudSimpleTable Dense="true" Elevation="0">
                                                            <thead>
                                                                <tr>
                                                                    <th>Team</th>
                                                                    <th>Score</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var (team, index) in eventDetail!.EventVersusList!.OrderByDescending(e => int.TryParse(e.Score, out var s) ? s : 0).Select((team, index) => (team, index)))
                                                                {
                                                                    <tr>
                                                                        <td>
                                                                            <MudStack Row Spacing="1">
                                                                                <MudIcon Size="Size.Small" Class="pa-0" Icon="@Icons.Material.Filled.WorkspacePremium" Style="@($"color: {GetMedalColor(index)}")" />
                                                                                @team.Abbreviation
                                                                            </MudStack>
                                                                        </td>
                                                                        <td>@team.Score</td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </MudSimpleTable>

                                                    }
                                                    else
                                                    {
                                                        <MudSimpleTable Dense="true" Elevation="0">
                                                            <thead>
                                                                <tr>
                                                                    <th>Teams</th>
                                                                    <th>Score</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <MudVirtualize Items="eventDetail.EventVersusList" Context="team">
                                                                    <tr>
                                                                        <td>@team.Abbreviation</td>
                                                                        <td>@team.Score</td>
                                                                    </tr>
                                                                </MudVirtualize>
                                                            </tbody>
                                                        </MudSimpleTable>
                                                    }
                                                </MudStack>

                                                <MudDivider />

                                                @* Address *@
                                                <MudStack Row AlignItems="AlignItems.Center">
                                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" />
                                                    <MudText Typo="Typo.caption">@eventDetail.Venue</MudText>
                                                </MudStack>

                                                @* Date Time *@
                                                <MudStack Row AlignItems="AlignItems.Center">
                                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                                    <MudText Typo="Typo.caption">@(eventDetail.Date?.ToString("dddd - MMMM d") ?? "No Date") [@(eventDetail.Time.HasValue ? DateTime.Today.Add(eventDetail.Time.Value).ToString("hh:mm tt") : "No Time")]</MudText>
                                                </MudStack>

                                                @* Stream *@
                                                <MudStack>
                                                    @if (eventDetail.OnStream != true)
                                                    {
                                                        <MudStack Row AlignItems="AlignItems.Center">
                                                            <MudIcon Icon="@Icons.Material.Filled.Podcasts" Size="Size.Small" />
                                                            <MudText Typo="Typo.caption">No stream available.</MudText>
                                                            <MudIconButton Class="pa-o" Icon="@Icons.Material.Filled.Error" Size="Size.Small" Disabled="true" />
                                                        </MudStack>
                                                    }
                                                    else
                                                    {
                                                        <MudStack Row AlignItems="AlignItems.Center">
                                                            <MudIcon Icon="@Icons.Material.Filled.Podcasts" Size="Size.Small" />
                                                            <MudText Typo="Typo.caption">@eventDetail.StreamService</MudText>
                                                        </MudStack>
                                                    }
                                                </MudStack>

                                                <MudDivider />

                                                <!--<MudButton FullWidth Variant="Variant.Text" Size="Size.Small" Style="text-transform: none" DropShadow="false" Color="Color.Tertiary" Href="@($"https://www.google.com/maps/?q={eventDetail.Latitude},{eventDetail.Longitude}")" Target="_blank">Details</MudButton>-->
                                                <MudButton FullWidth Variant="Variant.Text" Size="Size.Small" Style="text-transform: none" DropShadow="false" Color="Color.Tertiary" Href="@($"./events/id={eventDetail.ID}")">Details</MudButton>
                                            </MudStack>
                                        </MudStack>
                                    </MudPaper>
                                </MudItem>
                            </MudVirtualize>
                        </MudGrid>
                    }
                </MudItem>

            </MudGrid>
        </MudContainer>
    </MudItem>
</MudGrid>
<FooterComponent />

@code {
    private List<EventsDTO.EventDetails.Event>? _eventDetails;
    private string[]? _sportList;
    private string[]? _eventStageList;
    private string[]? _streamServiceList;
    private string[]? _eventTeamList;
    bool _expandedFilter = false;

    private string[]? _selectedSports;
    private string[]? _selectedEventStages;
    private string[]? _selectedStreamServices;
    private string[]? _selectedEventTeams;

    private void OnExpandFilterCollapseClick()
    {
        _expandedFilter = !_expandedFilter;
    }

    private string GetMedalColor(int index)
    {
        return index switch
        {
            0 => Colors.Amber.Accent4,   // First place (Gold)
            1 => Colors.BlueGray.Lighten4, // Second place (Silver)
            2 => Colors.DeepOrange.Lighten1, // Third place (Bronze)
            _ => "transparent" // Default color for others
        };
    }

    private async Task ClearSelectedEventTeams()
    {
        _selectedEventTeams = Array.Empty<string>();

        await GetQueriedEventsAsync("");
    }
    public async Task UpdateSelectedEventTeams(IReadOnlyCollection<string> values)
    {
        _selectedEventTeams = values.ToArray();
        await GetQueriedEventsAsync("eventTeams");
    }


    private async Task ClearSelectedSports()
    {
        _selectedSports = Array.Empty<string>();

        await GetQueriedEventsAsync("");
    }
    public async Task UpdateSelectedSports(IReadOnlyCollection<string> values)
    {
        _selectedSports = values.ToArray();
        await GetQueriedEventsAsync("sports");
    }


    private async Task ClearSelectedEventStages()
    {
        _selectedEventStages = Array.Empty<string>();

        await GetQueriedEventsAsync("");
    }
    public async Task UpdateSelectedEventStages(IReadOnlyCollection<string> values)
    {
        _selectedEventStages = values.ToArray();
        await GetQueriedEventsAsync("eventStages");
    }

    private async Task ClearSelectedStreamServices()
    {
        _selectedStreamServices = Array.Empty<string>();

        await GetQueriedEventsAsync("");
    }
    public async Task UpdateSelectedStreamServices(IReadOnlyCollection<string> values)
    {
        _selectedStreamServices = values.ToArray();

        await GetQueriedEventsAsync("streamServices");
    }

    public class EventsDTO
    {
        public class EventDetails
        {
            public class Event
            {
                public string ID { get; set; } = null!;
                public string? EventStage { get; set; }
                public List<EventVersusTeams>? EventVersusList { get; set; }
                public string? Category { get; set; }
                public string? Sport { get; set; }
                public int? SubCategoryID { get; set; }
                public string? Subcategory { get; set; }
                public string? Gender { get; set; }
                public string? Level { get; set; }
                public string? Venue { get; set; }
                public decimal? Latitude { get; set; }
                public decimal? Longitude { get; set; }
                public DateTime? Date { get; set; }
                public TimeSpan? Time { get; set; }
                public bool? OnStream { get; set; }
                public string? StreamService { get; set; }
                public string? StreamURL { get; set; }
                public string? StreamTitle { get; set; }
                public bool? IsFinished { get; set; }
                public byte[]? Attachement { get; set; }
                public bool? Archived { get; set; }
                public bool? Deleted { get; set; }
                public string? FirstName { get; set; }
                public string? LastName { get; set; }
            }

            public class EventVersusTeams
            {
                public int ID { get; set; }
                public string? Score { get; set; }
                // public int? SchoolRegionID { get; set; }
                public string? Region { get; set; }
                public string? Abbreviation { get; set; }
                //

                public List<EventVersusTeamPlayers>? EventVersusTeamPlayersList { get; set; }
                public DateTime? RecentUpdateAt { get; set; }
            }

            public class EventVersusTeamPlayers
            {
                public int ID { get; set; }
                public int? EventVersusID { get; set; }
                public string? FirstName { get; set; }
                public string? LastName { get; set; }
                public string? School { get; set; }
            }
        }
    }

    private string GetThumbnailUrl(string? url)
    {
        if (string.IsNullOrWhiteSpace(url)) return string.Empty;

        if (url.Contains("youtube.com/watch?v="))
        {
            var videoId = url.Split("v=")[1].Split('&')[0];
            return $"https://img.youtube.com/vi/{videoId}/hqdefault.jpg";
        }

        return "media/images/no-thumbnail-default.png";
    }

    private string GetRandomImage()
    {
        string folderPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot/media/sports/images");
        if (!Directory.Exists(folderPath)) return string.Empty;

        string[] images = Directory.GetFiles(folderPath);
        if (images.Length == 0) return string.Empty;

        var random = new Random();
        string randomImage = images[random.Next(images.Length)];
        return $"/media/sports/images/{Path.GetFileName(randomImage)}";
    }

    protected override async Task OnInitializedAsync()
    {
        await GetEventsAsync();
    }

    private async Task GetEventsAsync()
    {
        try
        {
            string url = $"{apiService.Palaro2026API}/Events/Details";

            HttpResponseMessage httpResponse = await httpClient.GetAsync(url);
            httpResponse.EnsureSuccessStatusCode(); // Ensure a successful response

            using var responseStream = await httpResponse.Content.ReadAsStreamAsync();
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            _eventDetails = await JsonSerializer.DeserializeAsync<List<EventsDTO.EventDetails.Event>>(responseStream, options);

            _sportList = _eventDetails?.Select(e => e.Sport!).Where(sub => !string.IsNullOrWhiteSpace(sub)).Distinct().ToArray();
            _eventStageList = _eventDetails?.Select(e => e.EventStage!).Where(sub => !string.IsNullOrWhiteSpace(sub)).Distinct().ToArray();
            _streamServiceList = _eventDetails?.Select(e => e.StreamService!).Where(sub => !string.IsNullOrWhiteSpace(sub)).Distinct().ToArray();
            _eventTeamList = _eventDetails?.Where(e => e.EventVersusList != null).SelectMany(e => e.EventVersusList!).Select(t => t.Region!).Where(region => !string.IsNullOrWhiteSpace(region)).Distinct().ToArray();
        }
        catch (HttpRequestException)
        {
            _eventDetails = null;
        }
    }

    private async Task GetQueriedEventsAsync(string selectedChip)
    {
        try
        {
            string url = $"{apiService.Palaro2026API}/Events/Details?";

            var queryParams = new List<string>();

            if (_selectedEventTeams?.Any() == true)
                queryParams.Add($"region={Uri.EscapeDataString(string.Join(",", _selectedEventTeams))}");

            if (_selectedSports?.Any() == true)
                queryParams.Add($"sport={Uri.EscapeDataString(string.Join(",", _selectedSports))}");

            if (_selectedEventStages?.Any() == true)
                queryParams.Add($"eventStage={Uri.EscapeDataString(string.Join(",", _selectedEventStages))}");

            if (_selectedStreamServices?.Any() == true)
                queryParams.Add($"streamService={Uri.EscapeDataString(string.Join(",", _selectedStreamServices))}");

            if (queryParams.Any())
            {
                url += "&" + string.Join("&", queryParams);
            }

            HttpResponseMessage httpResponse = await httpClient.GetAsync(url);
            httpResponse.EnsureSuccessStatusCode(); // Ensure a successful response

            using var responseStream = await httpResponse.Content.ReadAsStreamAsync();
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            _eventDetails = await JsonSerializer.DeserializeAsync<List<EventsDTO.EventDetails.Event>>(responseStream, options);


            if (selectedChip != "sports")
            {
                _sportList = _eventDetails?.Select(e => e.Sport!).Where(sub => !string.IsNullOrWhiteSpace(sub)).Distinct().ToArray();
            }
            if (selectedChip != "eventStages")
            {
                _eventStageList = _eventDetails?.Select(e => e.EventStage!).Where(sub => !string.IsNullOrWhiteSpace(sub)).Distinct().ToArray();
            }
            if (selectedChip != "streamServices")
            {
                _streamServiceList = _eventDetails?.Select(e => e.StreamService!).Where(sub => !string.IsNullOrWhiteSpace(sub)).Distinct().ToArray();
            }
            if (selectedChip != "eventTeams")
            {
                _eventTeamList = _eventDetails?.Where(e => e.EventVersusList != null).SelectMany(e => e.EventVersusList!).Select(t => t.Region!).Where(region => !string.IsNullOrWhiteSpace(region)).Distinct().ToArray();
            }
        }
        catch (HttpRequestException)
        {
            _eventDetails = null;
        }
    }
}
