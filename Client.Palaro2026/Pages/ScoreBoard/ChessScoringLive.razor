@page "/scoreboard/chess/{EventID}"
@using Client.Palaro2026.Services
@inject ISnackbar Snackbar
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout


<PageTitle>@_eventDetails?.Subcategory - Chess Scoreboard | PALARO 2026</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&family=Chakra+Petch:wght@600;700&display=swap');

    :root {
        --bg-dark: #0a0a0a;
        --card-bg: rgba(30, 30, 30, 0.7);
        --card-border: rgba(255, 255, 255, 0.1);
        --text-primary: #ffffff;
        --accent-blue: #4FC3F7;
        --accent-cyan: #00BCD4;
        --accent-teal: #0097A7;
        --accent-green: #2e7d32;
        --neon-blue: 0 0 10px rgba(79, 195, 247, 0.6), 0 0 20px rgba(79, 195, 247, 0.3);
        --neon-cyan: 0 0 10px rgba(0, 188, 212, 0.4);
        --neon-teal: 0 0 10px rgba(0, 151, 167, 0.6);
    }

    /* BACKGROUND TEXTURE */
    .dashboard-bg {
        background-color: var(--bg-dark);
        background-image: radial-gradient(circle at 10% 20%, rgba(79, 195, 247, 0.08) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(0, 188, 212, 0.05) 0%, transparent 40%), linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
        min-height: 100vh;
        color: var(--text-primary);
        font-family: 'Rajdhani', sans-serif;
    }

    /* HEADER */
    .header-container {
        text-align: center;
        margin-bottom: 40px;
        position: relative;
        padding: 30px 0;
        background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
        border-bottom: 1px solid rgba(79, 195, 247, 0.2);
    }

    .main-title {
        font-family: 'Orbitron', sans-serif;
        font-weight: 900;
        font-size: clamp(2rem, 5vw, 3.5rem);
        background: linear-gradient(180deg, #4FC3F7 0%, #00BCD4 50%, #0097A7 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: 4px;
        text-transform: uppercase;
        margin-bottom: 5px;
        filter: drop-shadow(0 0 15px rgba(79, 195, 247, 0.4));
    }

    .sub-title {
        font-family: 'Chakra Petch', sans-serif;
        color: rgba(255, 255, 255, 0.7);
        font-size: clamp(1rem, 1.5vw, 1.3rem);
        letter-spacing: 8px;
        font-weight: 700;
        text-transform: uppercase;
        position: relative;
        display: inline-block;
    }

        .sub-title::before, .sub-title::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 60px;
            height: 2px;
            background: var(--accent-blue);
            opacity: 0.5;
        }

        .sub-title::before {
            left: -80px;
        }

        .sub-title::after {
            right: -80px;
        }

    /* EVENT DETAILS */
    .event-details-container {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid var(--card-border);
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .event-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .detail-item {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(79, 195, 247, 0.2);
    }

    .detail-label {
        color: var(--accent-cyan);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
        font-family: 'Chakra Petch';
        font-weight: 600;
    }

    .detail-value {
        color: white;
        font-size: 1.1rem;
        font-weight: 700;
        font-family: 'Rajdhani';
    }

    /* STANDINGS TABLE */
    .standings-table {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid var(--card-border);
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .table-header {
        font-family: 'Orbitron', sans-serif;
        color: var(--accent-blue);
        font-size: 1.5rem;
        font-weight: 900;
        margin-bottom: 20px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .standing-row {
        display: grid;
        grid-template-columns: 80px 1fr 100px 100px 100px 100px 120px;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.3s;
    }

        .standing-row:hover {
            background: rgba(79, 195, 247, 0.05);
        }

        .standing-row.top-3 {
            background: rgba(79, 195, 247, 0.1);
            border-left: 3px solid var(--accent-blue);
        }

    .header-row {
        font-family: 'Chakra Petch';
        font-weight: 700;
        color: var(--accent-cyan);
        border-bottom: 2px solid rgba(79, 195, 247, 0.3);
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .rank-cell {
        text-align: center;
        font-family: 'Orbitron';
        font-weight: 900;
        font-size: 1.2rem;
    }

    .rank-1 {
        color: #FFD700;
    }

    .rank-2 {
        color: #C0C0C0;
    }

    .rank-3 {
        color: #CD7F32;
    }

    .region-cell {
        font-family: 'Rajdhani';
        font-weight: 600;
        font-size: 1rem;
    }

    .stats-cell {
        text-align: center;
        font-family: 'Rajdhani';
        font-weight: 500;
    }

    .points-cell {
        text-align: center;
        font-family: 'Orbitron';
        font-weight: 900;
        font-size: 1.1rem;
        color: #FFD700;
    }

    /* CURRENT MATCHES */
    .matches-container {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid var(--card-border);
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .match-card {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border: 1px solid rgba(79, 195, 247, 0.2);
        transition: transform 0.3s, border-color 0.3s;
    }

        .match-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-blue);
        }

    .match-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .match-table {
        font-family: 'Orbitron';
        font-weight: 900;
        color: var(--accent-blue);
        font-size: 1.1rem;
    }

    .match-set {
        font-family: 'Rajdhani';
        color: #aaa;
        font-weight: 600;
    }

    .players-container {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 20px;
    }

    .player-card {
        background: rgba(30, 30, 30, 0.5);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }

    .player-white {
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .player-black {
        border: 1px solid rgba(0, 0, 0, 0.5);
        background: rgba(0, 0, 0, 0.4);
    }

    .player-name {
        font-family: 'Rajdhani';
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 5px;
    }

    .player-region {
        font-family: 'Chakra Petch';
        color: var(--accent-cyan);
        font-size: 0.8rem;
    }

    .player-score {
        font-family: 'Orbitron';
        font-weight: 900;
        font-size: 1.3rem;
        margin-top: 5px;
    }

    .score-win {
        color: #4CAF50;
    }

    .score-loss {
        color: #F44336;
    }

    .score-draw {
        color: #FFC107;
    }

    .score-pending {
        color: #aaa;
    }

    .vs-text {
        font-family: 'Orbitron';
        color: var(--accent-blue);
        font-weight: 900;
        font-size: 1.2rem;
    }

    /* STATUS BADGES */
    .status-badge {
        padding: 6px 15px;
        border-radius: 6px;
        font-family: 'Chakra Petch';
        font-weight: 800;
        font-size: 0.8rem;
        letter-spacing: 1px;
        display: inline-block;
    }

    .badge-live {
        background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%);
        color: white;
        box-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
        border: 1px solid #4FC3F7;
        animation: pulse 2s infinite;
    }

    .badge-finish {
        background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        color: white;
        border: 1px solid #66bb6a;
        box-shadow: 0 0 10px rgba(46, 125, 50, 0.4);
    }

    .badge-pending {
        background: linear-gradient(135deg, #757575 0%, #424242 100%);
        color: white;
        border: 1px solid #9e9e9e;
    }

    @@keyframes pulse {
        0% {
            opacity: 1;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
        }

        50% {
            opacity: 0.8;
            box-shadow: 0 0 5px rgba(0, 188, 212, 0.2);
        }

        100% {
            opacity: 1;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
        }
    }

    /* RESPONSIVE */
    @@media (max-width: 1200px) {
        .standing-row {
            grid-template-columns: 60px 1fr 80px 80px 80px 80px 100px;
            font-size: 0.9rem;
        }
    }

    @@media (max-width: 768px) {
        .standing-row {
            grid-template-columns: 50px 1fr 70px 70px 70px 70px 90px;
            font-size: 0.85rem;
            padding: 10px;
        }
    }

    .page-content {
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
    }

        .page-content.loading {
            opacity: 0.7;
            pointer-events: none;
        }

    .refresh-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(0, 188, 212, 0.9);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.8rem;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
        display: none;
    }

        .refresh-indicator.active {
            display: block;
        }

    @@keyframes slideIn {
        from {
            transform: translateX(100px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

<!-- Refresh Indicator -->
<div class="refresh-indicator @(_isRefreshing ? "active" : "")">
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        <MudIcon Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" Class="mud-spin" />
        <span>Updating...</span>
    </MudStack>
</div>

<div class="dashboard-bg">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">

        <!-- HEADER -->
        <div class="header-container">
            <div class="main-title">PALARONG PAMBANSA 2026</div>
            <div class="sub-title">CHESS SCOREBOARD</div>
        </div>

        <!-- BACK BUTTON -->
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Info"
                   StartIcon="@Icons.Material.Filled.ArrowBack"
                   OnClick="NavigateBack"
                   Class="mb-4">
            Back to Chess Events
        </MudButton>

        <!-- Wrap content for smooth transitions -->
        <div class="page-content @(_isLoading ? "loading" : "")">
            @if (_isLoading && _eventDetails == null)
            {
                <!-- INITIAL LOADING -->
                <MudPaper Class="pa-8 mt-4" Style="background-color: rgba(30,30,30,0.5); border-radius: 20px;">
                    <MudStack Spacing="3" AlignItems="AlignItems.Center">
                        <MudProgressCircular Indeterminate="true" Color="Color.Info" Size="Size.Large" />
                        <MudText Typo="Typo.h6" Style="font-family:'Orbitron'; color:var(--accent-blue);">
                            LOADING CHESS EVENT DATA...
                        </MudText>
                    </MudStack>
                </MudPaper>
            }
            else if (_eventDetails == null)
            {
                <!-- NO EVENT FOUND -->
                <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-4" Style="background-color: rgba(30,30,30,0.5); border: 1px dashed #444; border-radius: 20px;">
                    <MudIcon Icon="@Icons.Material.Filled.PsychologyAlt" Size="Size.Large" Style="color: #555; width: 60px; height: 60px;" />
                    <MudText Typo="Typo.h5" Class="mt-4" Style="color: #666; font-family:'Orbitron'; font-weight:700;">
                        EVENT NOT FOUND
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mt-2" Style="color: #555;">
                        The requested chess event could not be found.
                    </MudText>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Info"
                               StartIcon="@Icons.Material.Filled.ArrowBack"
                               OnClick="NavigateBack"
                               Class="mt-4">
                        Back to Chess Events
                    </MudButton>
                </MudPaper>
            }
            else
            {
                <!-- EVENT DETAILS -->
                <div class="event-details-container">
                    <MudGrid>
                        <MudItem xs="12" md="8">
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.h4" Style="font-family:'Orbitron'; color:white; font-weight:900;">
                                    @_eventDetails.Subcategory
                                </MudText>
                                <MudText Typo="Typo.h6" Style="color:var(--accent-cyan); font-family:'Rajdhani';">
                                    @_eventDetails.Level - @_eventDetails.Gender • @_eventDetails.EventStage
                                </MudText>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" md="4" Style="display: flex; align-items: center; justify-content: flex-end;">
                            <div class="status-badge @(_eventDetails.IsFinished == true ? "badge-finish" : "badge-live")">
                                @(_eventDetails.IsFinished == true ? "FINISH" : "LIVE")
                            </div>
                        </MudItem>
                    </MudGrid>

                    <div class="event-details-grid">
                        <div class="detail-item">
                            <div class="detail-label">Sport</div>
                            <div class="detail-value">@_eventDetails.Sport</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Category</div>
                            <div class="detail-value">@_eventDetails.SportMainCat</div>
                        </div>
                    </div>
                </div>

                <!-- STANDINGS TABLE -->
                <div class="standings-table">
                    <div class="table-header">
                        <MudStack Row="true" Justify="Justify.Center" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Style="color: #FFD700;" />
                            <span>OVERALL STANDINGS</span>
                            <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Style="color: #FFD700;" />
                        </MudStack>
                    </div>

                    @if (!_standings.Any())
                    {
                        <MudText Align="Align.Center" Style="color: #777; padding: 40px;">
                            No standings data available yet.
                        </MudText>
                    }
                    else
                    {
                        <!-- HEADER ROW -->
                        <div class="standing-row header-row">
                            <div class="rank-cell">RANK</div>
                            <div class="region-cell">REGION</div>
                            <div class="stats-cell">WINS</div>
                            <div class="stats-cell">DRAWS</div>
                            <div class="stats-cell">LOSSES</div>
                            <div class="stats-cell">GAMES</div>
                            <div class="points-cell">POINTS</div>
                        </div>

                        <!-- STANDINGS ROWS -->
                        @foreach (var standing in _standings)
                        {
                            <div class="standing-row @(standing.Rank <= 3 ? "top-3" : "")">
                                <div class="rank-cell @GetRankClass(standing.Rank)">@standing.Rank</div>
                                <div class="region-cell">
                                    <MudStack Spacing="1">
                                        <span>@standing.RegionName</span>
                                        @if (!string.IsNullOrEmpty(standing.PlayerName))
                                        {
                                            <MudText Typo="Typo.caption" Style="color: #aaa;">
                                                @standing.PlayerName
                                            </MudText>
                                        }
                                    </MudStack>
                                </div>
                                <div class="stats-cell">@standing.Wins</div>
                                <div class="stats-cell">@standing.Draws</div>
                                <div class="stats-cell">@standing.Losses</div>
                                <div class="stats-cell">@standing.GamesPlayed</div>
                                <div class="points-cell">@standing.TotalPoints.ToString("F1")</div>
                            </div>
                        }
                    }
                </div>
            }
        </div>
    </MudContainer>
</div>

@code {
    /* ===================== PARAMETERS ===================== */
    [Parameter] public string EventID { get; set; } = "";

    /* ===================== MODELS ===================== */
    public class EventDetailsDTO
    {
        public class Event
        {
            public string ID { get; set; } = null!;
            public string? EventStage { get; set; }
            public List<EventVersus>? EventVersusList { get; set; }
            public string? SportMainCat { get; set; }
            public string? Category { get; set; }
            public string? Sport { get; set; }
            public string? GamePhase { get; set; }
            public int? SubCategoryID { get; set; }
            public string? Subcategory { get; set; }
            public string? Gender { get; set; }
            public string? Level { get; set; }
            public string? Venue { get; set; }
            public decimal? Latitude { get; set; }
            public decimal? Longitude { get; set; }
            public DateTime? Date { get; set; }
            public TimeSpan? Time { get; set; }
            public bool? OnStream { get; set; }
            public string? StreamService { get; set; }
            public string? StreamURL { get; set; }
            public bool? IsFinished { get; set; }
            public bool? Archived { get; set; }
            public bool? Deleted { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }

        public class EventVersus
        {
            public int ID { get; set; }
            public string? Score { get; set; }
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
            public List<EventVersusTeamPlayers>? EventVersusTeamPlayersList { get; set; }
            public string? Rank { get; set; }
            public DateTime? RecentUpdateAt { get; set; }
        }

        public class EventVersusTeamPlayers
        {
            public int ID { get; set; }
            public int? EventVersusID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
            public string? School { get; set; }
        }
    }

    public class EventDetails
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Level { get; set; }
        public string? Gender { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public bool? IsFinished { get; set; }
    }

    public class ChessStanding
    {
        public int Rank { get; set; }
        public string RegionName { get; set; } = "";
        public decimal TotalPoints { get; set; }
        public int GamesPlayed { get; set; }
        public int Wins { get; set; }
        public int Draws { get; set; }
        public int Losses { get; set; }
        public string? PlayerName { get; set; }
    }

    /* ===================== STATE ===================== */
    private EventDetails? _eventDetails;
    private List<ChessStanding> _standings = new();
    private List<ChessStanding> _previousStandings = new();
    private bool _isLoading = true;
    private bool _isRefreshing = false;
    private Timer? _refreshTimer;
    private DateTime _lastUpdated = DateTime.Now;

    /* ===================== LIFECYCLE ===================== */
    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(EventID))
        {
            Snackbar.Add("Event ID is required", Severity.Error);
            Navigation.NavigateTo("/scoreboard/chess");
            return;
        }

        await LoadEventData(true);

        // Auto-refresh every 10 seconds
        _refreshTimer = new Timer(async _ => await RefreshData(), null, 10000, 10000);
    }

    /* ===================== IMPROVED DATA LOADING ===================== */
    private async Task LoadEventData(bool isInitialLoad = false)
    {
        if (_isRefreshing) return;

        try
        {
            if (isInitialLoad)
            {
                _isLoading = true;
            }
            else
            {
                _isRefreshing = true;
            }

            StateHasChanged();

            // LOAD EVENT DETAILS FROM /Events/Details ENDPOINT
            var allEvents = await apiService.GetAsync<EventDetailsDTO.Event>("/Events/Details");

            if (allEvents != null)
            {
                // Find the Chess event by ID
                var eventDetails = allEvents.FirstOrDefault(e =>
                    e.ID == EventID &&
                    e.Sport?.Equals("Chess", StringComparison.OrdinalIgnoreCase) == true);

                if (eventDetails != null)
                {
                    // Map to EventDetails
                    _eventDetails = new EventDetails
                    {
                        ID = eventDetails.ID,
                        Sport = eventDetails.Sport,
                        Subcategory = eventDetails.Subcategory,
                        Level = eventDetails.Level,
                        Gender = eventDetails.Gender,
                        EventStage = eventDetails.EventStage,
                        SportMainCat = eventDetails.SportMainCat,
                        // IMPORTANT: Get IsFinished from /Events/Details
                        IsFinished = eventDetails.IsFinished
                    };

                    Console.WriteLine($"[CHESS DEBUG] Event {EventID} IsFinished = {_eventDetails.IsFinished}");
                }
                else
                {
                    Console.WriteLine($"[CHESS ERROR] Event {EventID} not found in /Events/Details");
                    // Fallback to old API
                    await LoadEventFromFallback();
                }
            }
            else
            {
                await LoadEventFromFallback();
            }

            if (_eventDetails != null)
            {
                // Load standings
                await LoadStandings();
                _lastUpdated = DateTime.Now;
            }

            if (isInitialLoad)
            {
                _isLoading = false;
            }
            else
            {
                await Task.Delay(500);
                _isRefreshing = false;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading event data: {ex.Message}", Severity.Error);
            _isLoading = false;
            _isRefreshing = false;
            StateHasChanged();
        }
    }

    private async Task LoadEventFromFallback()
    {
        // Fallback to old API if /Events/Details fails
        try
        {
            var events = await apiService.GetAsync<EventDetails>("/ChessScoring/events");
            if (events != null && events.Any())
            {
                _eventDetails = events.FirstOrDefault(e => e.ID == EventID);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fallback API error: {ex.Message}");
        }
    }

    private async Task RefreshData()
    {
        if (_isLoading || _isRefreshing) return;

        try
        {
            await InvokeAsync(async () =>
            {
                await LoadEventData(false);
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Refresh error: {ex.Message}");
        }
    }

    private async Task LoadStandings()
    {
        try
        {
            // Get chess scoring records
            var scoringRecords = await apiService.GetAsync<ChessScoringDTO>($"/ChessScoring/event/{EventID}");

            if (scoringRecords != null && scoringRecords.Any())
            {
                // Group by region and calculate standings
                var regionGroups = scoringRecords
                    .Where(r => !string.IsNullOrEmpty(r.Region))
                    .GroupBy(r => r.Region!);

                var standingsList = new List<ChessStanding>();

                foreach (var group in regionGroups)
                {
                    var regionName = group.Key;
                    var regionRecords = group.ToList();

                    var standing = new ChessStanding
                    {
                        RegionName = regionName,
                        TotalPoints = regionRecords.Sum(r => r.Score ?? 0),
                        Wins = regionRecords.Count(r => r.Score == 1.0m),
                        Draws = regionRecords.Count(r => r.Score == 0.5m),
                        Losses = regionRecords.Count(r => r.Score == 0.0m),
                        GamesPlayed = regionRecords.Count(r => r.Score.HasValue),
                        PlayerName = regionRecords.FirstOrDefault()?.PlayerName
                    };

                    standingsList.Add(standing);
                }

                // Sort and rank
                _standings = standingsList
                    .OrderByDescending(s => s.TotalPoints)
                    .ThenByDescending(s => s.Wins)
                    .ThenBy(s => s.Losses)
                    .Select((s, index) =>
                    {
                        s.Rank = index + 1;
                        return s;
                    })
                    .ToList();
            }
            else
            {
                _standings = new List<ChessStanding>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading standings: {ex.Message}");
            _standings = new List<ChessStanding>();
        }
    }

    /* ===================== HELPER METHODS ===================== */
    private string GetRankClass(int rank)
    {
        return rank switch
        {
            1 => "rank-1",
            2 => "rank-2",
            3 => "rank-3",
            _ => ""
        };
    }

    /* ===================== NAVIGATION ===================== */
    private void NavigateBack()
    {
        Navigation.NavigateTo("/scoreboard/chess");
    }

    /* ===================== SUPPORTING MODELS ===================== */
    public class ChessScoringDTO
    {
        public int ID { get; set; }
        public int? SportsID { get; set; }
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int SetNo { get; set; }
        public int TableNo { get; set; }
        public string? ColorGroup { get; set; }
        public decimal? Score { get; set; }
        public DateTime? CreatedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    /* ===================== CLEANUP ===================== */
    public void Dispose()
    {
        _refreshTimer?.Dispose();
        _refreshTimer = null;
    }
}