@page "/scoreboard/track-events/{EventID}"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>Track Events Scoring | PALARO 2026</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@600;700&display=swap');

    :root {
        --bg-dark: #121212;
        --panel-bg: rgba(20, 20, 25, 0.9);
        --accent-gold: #FFD700;
        --accent-blue: #00B0FF;
        --accent-red: #FF1744;
        --text-white: #ffffff;
        --accent-green: #4CAF50;
        --accent-purple: #9C27B0;
    }

    body {
        background-color: black;
        overflow: hidden;
    }

    .tv-screen {
        min-height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at center, #1e1e24 0%, #000000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: 'Rajdhani', sans-serif;
        color: white;
        padding: 20px;
    }

    .tournament-header {
        text-align: center;
        margin-bottom: 2vh;
    }

    .palaro-branding {
        font-family: 'Orbitron', sans-serif;
        font-size: 2.5rem;
        color: var(--accent-gold);
        letter-spacing: 5px;
        font-weight: bold;
    }

    .sport-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 3rem;
        font-weight: 900;
    }

    .match-details {
        font-size: 1.5rem;
        color: #aaa;
        margin-top: 5px;
    }

    .scoreboard-card {
        width: 95%;
        max-width: 1400px;
        background: var(--panel-bg);
        border-radius: 25px;
        padding: 30px;
        margin-bottom: 3vh;
        text-align: center;
        font-size: 1.8rem;
        font-family: 'Rajdhani', sans-serif;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .status-badge {
        font-family: 'Orbitron', sans-serif;
        padding: 8px 30px;
        border-radius: 50px;
        font-size: 1.5rem;
        font-weight: bold;
    }

    .live {
        background: var(--accent-red);
        animation: pulse 1.5s infinite;
    }

    .final {
        background: #00C853;
    }

    .results-table {
        width: 95%;
        max-width: 1400px;
        background: rgba(255,255,255,0.05);
        border-radius: 15px;
        padding: 20px;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1
        }

        50% {
            opacity: 0.7
        }
    }

    .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255,255,255,0.1);
        color: white;
        border: 1px solid #333;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

        .back-button:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

    .region-flag {
        width: 30px;
        height: 30px;
        margin-right: 10px;
        border-radius: 50%;
        overflow: hidden;
        background: rgba(255,255,255,0.1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

        .region-flag img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

    .separator-dot {
        color: #666;
        font-size: 1.5rem;
    }

    .time-cell {
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
        text-align: center;
        font-size: 1.3rem;
        color: var(--accent-gold);
    }
</style>

<div class="tv-screen">
    <button class="back-button" onclick="history.back()">← Back</button>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate Color="Color.Warning" Size="Size.Large" />
    }
    else if (_eventDetails == null)
    {
        <MudText Typo="Typo.h4" Color="Color.Error">EVENT NOT FOUND</MudText>
    }
    else
    {
        <div class="tournament-header">
            <div class="palaro-branding">PALARONG PAMBANSA 2026</div>
            <div class="sport-name">@_eventDetails.Subcategory</div>
            <div class="match-details">
                @{
                    var isLive = _eventDetails.EventStage?.Equals("Live", StringComparison.OrdinalIgnoreCase) == true ||
                    _eventDetails.EventStage?.Equals("In Progress", StringComparison.OrdinalIgnoreCase) == true;
                    var isCompleted = _eventDetails.EventStage?.Equals("Completed", StringComparison.OrdinalIgnoreCase) == true;
                }
                @if (isCompleted)
                {
                    <div class="status-badge final">FINAL</div>
                }
                else if (isLive)
                {
                    <div class="status-badge live">LIVE</div>
                }
            </div>


        </div>

        <div class="scoreboard-card">
            @_eventDetails.Sport
            <span class="separator-dot">•</span>
            @_eventDetails.Level
            <span class="separator-dot">•</span>
            @_eventDetails.Gender
            <span class="separator-dot">•</span>
            @_eventDetails.Subcategory
        </div>

        @if (_rankings.Any())
        {
            <div class="results-table">
                <MudTable Items="_rankings.OrderBy(r => r.Rank).ToList()"
                          Dense Hover>
                    <HeaderContent>
                        <MudTh style="font-size: 1.3rem;">Rank</MudTh>
                        <MudTh style="font-size: 1.3rem;">Athlete</MudTh>
                        <MudTh style="font-size: 1.3rem;">Region</MudTh>
                        <MudTh style="text-align:center; font-size: 1.3rem;">Time/Result</MudTh>
                        <MudTh style="text-align:center; font-size: 1.3rem;">Lane</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd>
                            @if (context.Rank > 0)
                            {
                                <span style="font-family: Orbitron; font-weight:bold; color:white; font-size: 1.3rem;">
                                    @if (context.Result != "TBA")
                                    {
                                        <text>#@context.Rank</text>
                                    }
                                    else
                                    {
                                        <text>-</text>
                                    }
                                </span>
                            }
                            else
                            {
                                <span style="color: #666;">-</span>
                            }
                        </MudTd>
                        <MudTd>
                            <div style="font-weight: bold; font-size: 1.3rem;">
                                @if (!string.IsNullOrEmpty(context.PlayerName) && context.PlayerName != "TBA")
                                {
                                    @context.PlayerName
                                }
                                else
                                {
                                    <span style="color: #888;">TBA</span>
                                }
                            </div>
                        </MudTd>
                        <MudTd>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="region-flag">
                                    <MudImage Src="@GetRegionLogo(context.RegionName)"
                                              ObjectFit="ObjectFit.Contain"
                                              Alt="@context.RegionName"
                                              Style="width:100%; height:100%;" />
                                </div>
                                <div style="font-weight:bold; font-size:1.3rem;">
                                    @context.RegionName
                                </div>
                            </div>
                        </MudTd>
                        <MudTd class="time-cell">
                            @if (!string.IsNullOrEmpty(context.Result) && context.Result != "TBA")
                            {
                                @context.Result
                            }
                            else
                            {
                                <span style="color: #666; font-style: italic;">Waiting for results</span>
                            }
                        </MudTd>
                        <MudTd style="font-family: Orbitron; font-weight:bold; color: white; text-align:center; font-size: 1.1rem;">
                            @if (!string.IsNullOrEmpty(context.AssignedLane) && context.AssignedLane != "TBA")
                            {
                                @GetTrackFromAssignedLane(context.AssignedLane)
                            }
                            else
                            {
                                <span style="color: #666;">TBA</span>
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
        }
        else
        {
            <div style="text-align: center; padding: 40px; color: #888;">
                <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Style="font-size: 3rem; margin-bottom: 15px;" />
                <MudText Typo="Typo.h6">No participants registered yet</MudText>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public string EventID { get; set; } = string.Empty;

    private EventInfo? _eventDetails;
    private List<RankingResult> _rankings = new();
    private SavedScoringData? _savedData;
    private bool _isLoading = true;
    private Timer? _refreshTimer;

    protected override async Task OnParametersSetAsync()
    {
        await LoadEventDetails();

        if (_refreshTimer != null)
        {
            _refreshTimer.Dispose();
        }

        _refreshTimer = new Timer(async _ =>
        {
            if (_eventDetails?.EventStage?.ToLower() == "live" ||
                _eventDetails?.EventStage?.ToLower() == "in progress")
            {
                await InvokeAsync(async () =>
                {
                    await LoadEventDetails();
                    StateHasChanged();
                });
            }
        }, null, 2000, 2000);
    }

    private async Task LoadEventDetails()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            Console.WriteLine($"=== LOADING EVENT DETAILS FOR ID: {EventID} ===");

            // Load all events first to get the specific event details
            var allEvents = await apiService.GetAsync<EventInfo>("TimeDistanceEvents/Sports/AthleticsSwimming");

            if (allEvents != null && allEvents.Any())
            {
                Console.WriteLine($"Total events loaded: {allEvents.Count}");

                // Find events matching this ID
                var eventParticipants = allEvents
                    .Where(p => p.ID == EventID)
                    .ToList();

                Console.WriteLine($"Found {eventParticipants.Count} participants for event {EventID}");

                if (eventParticipants.Any())
                {
                    var first = eventParticipants.First();
                    _eventDetails = new EventInfo
                    {
                        ID = first.ID,
                        Sport = first.Sport,
                        Subcategory = first.Subcategory,
                        Gender = first.Gender,
                        Level = first.Level,
                        EventStage = first.EventStage,
                        Date = first.Date,
                        Time = first.Time,
                        SportMainCat = first.SportMainCat,
                        Region = first.Region,
                        Abbreviation = first.Abbreviation,
                        RegionID = first.RegionID,
                        PlayerID = first.PlayerID,
                        PlayerName = first.PlayerName
                    };

                    Console.WriteLine($"Event details loaded: {_eventDetails.Subcategory}, {_eventDetails.Gender}, {_eventDetails.Level}");

                    // Load saved scoring data which contains the results
                    await LoadSavedScoringData();

                    // If no saved data, create rankings from all participants
                    if (!_rankings.Any())
                    {
                        Console.WriteLine("No saved data found, creating rankings from participant list");
                        _rankings = CreateRankingsFromParticipants(eventParticipants);
                    }
                }
                else
                {
                    Console.WriteLine($"No participants found for EventID: {EventID}");
                }
            }
            else
            {
                Console.WriteLine("No events data available from API");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading event details: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private List<RankingResult> CreateRankingsFromParticipants(List<EventInfo> participants)
    {
        var rankings = new List<RankingResult>();
        int rank = 1;

        foreach (var participant in participants)
        {
            if (!string.IsNullOrEmpty(participant.Abbreviation))
            {
                rankings.Add(new RankingResult
                {
                    RegionName = participant.Abbreviation,
                    PlayerName = participant.PlayerName ?? "TBA",
                    Result = "TBA",
                    AssignedLane = "TBA",
                    Rank = rank++,
                    NumericResult = 0
                });
            }
        }

        return rankings;
    }

    private async Task LoadSavedScoringData()
    {
        try
        {
            _savedData = await apiService.GetSingleAsync<SavedScoringData>($"TimeDistanceEvents/Sports/AthleticsSwimming/{EventID}");

            if (_savedData != null)
            {
                _rankings = CalculateRankingsFromSavedData(_savedData);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR loading saved data: {ex.Message}");
        }
    }

    private List<RankingResult> CalculateRankingsFromSavedData(SavedScoringData savedData)
    {
        var rankings = new List<RankingResult>();

        if (savedData.Heats == null || !savedData.Heats.Any())
            return rankings;

        var allResults = new List<RankingResult>();

        foreach (var heat in savedData.Heats)
        {
            if (heat.Lanes == null) continue;

            foreach (var lane in heat.Lanes)
            {
                if (!string.IsNullOrEmpty(lane.Result) &&
                    !string.IsNullOrEmpty(lane.RegionAbbreviation))
                {
                    if (TryParseResult(lane.Result, out double numericResult))
                    {
                        allResults.Add(new RankingResult
                        {
                            RegionName = lane.RegionAbbreviation,
                            PlayerName = lane.PlayerName,
                            Result = lane.Result,
                            AssignedLane = $"{heat.HeatName}-{lane.LaneName}",
                            NumericResult = numericResult
                        });
                    }
                }
            }
        }

        if (!allResults.Any())
            return rankings;

        var sortedResults = allResults.OrderBy(r => r.NumericResult).ToList();

        for (int i = 0; i < sortedResults.Count; i++)
        {
            sortedResults[i].Rank = i + 1;
        }

        return sortedResults;
    }

    private bool TryParseResult(string result, out double numericResult)
    {
        numericResult = 0;

        if (string.IsNullOrEmpty(result))
            return false;

        if (double.TryParse(result, out double directResult))
        {
            numericResult = directResult;
            return true;
        }

        if (result.Contains(":") || result.Contains("."))
        {
            if (TimeSpan.TryParse(result, out TimeSpan timeResult))
            {
                numericResult = timeResult.TotalSeconds;
                return true;
            }
        }

        return false;
    }

    private string GetRegionLogo(string regionName)
    {
        if (string.IsNullOrWhiteSpace(regionName))
            return "/images/region-placeholder.png";

        var cleanRegionName = CleanRegionName(regionName);
        return $"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{cleanRegionName}.webp";
    }

    private string CleanRegionName(string regionName)
    {
        if (string.IsNullOrWhiteSpace(regionName))
            return string.Empty;

        return regionName.Trim();
    }

    private string GetTrackFromAssignedLane(string assignedLane)
    {
        if (string.IsNullOrEmpty(assignedLane))
            return "-";

        var parts = assignedLane.Split('-');
        if (parts.Length > 1)
        {
            return GetTrackDisplayName(parts[1]);
        }

        return GetTrackDisplayName(assignedLane);
    }

    private string GetTrackDisplayName(string laneName)
    {
        if (string.IsNullOrEmpty(laneName))
            return "Track ?";

        if (laneName.Contains("Track", StringComparison.OrdinalIgnoreCase))
        {
            return laneName;
        }

        var trackNumber = GetTrackNumber(laneName);
        return trackNumber > 0 ? $"Track {trackNumber}" : laneName;
    }

    private int GetTrackNumber(string laneName)
    {
        if (string.IsNullOrEmpty(laneName))
            return 0;

        var match = System.Text.RegularExpressions.Regex.Match(laneName, @"\d+");
        if (match.Success && int.TryParse(match.Value, out int trackNumber))
        {
            return trackNumber;
        }
        return 0;
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }

    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public DateTime? Date { get; set; }
        public string? Time { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class RankingResult
    {
        public string RegionName { get; set; } = "";
        public string? PlayerName { get; set; }
        public string Result { get; set; } = "";
        public string AssignedLane { get; set; } = "";
        public int Rank { get; set; }
        public double NumericResult { get; set; }
    }

    public class SavedScoringData
    {
        public List<SavedHeat> Heats { get; set; } = new();
        public List<SavedAssignment> Assignments { get; set; } = new();
    }

    public class SavedHeat
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public List<SavedLane> Lanes { get; set; } = new();
    }

    public class SavedLane
    {
        public string LaneName { get; set; } = "";
        public int LaneOrder { get; set; }
        public string? Result { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
        public string? RegionAbbreviation { get; set; }
    }

    public class SavedAssignment
    {
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string RegionAbbreviation { get; set; } = "";
        public string AssignedTable { get; set; } = "";
    }
}
