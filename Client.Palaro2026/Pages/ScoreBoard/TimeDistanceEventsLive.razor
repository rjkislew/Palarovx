@page "/scoreboard/time-distance/{EventID}"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>Time-Distance Event Scoring | PALARO 2026</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@600;700&display=swap');

    :root {
        --bg-dark: #121212;
        --panel-bg: rgba(20, 20, 25, 0.9);
        --accent-gold: #FFD700;
        --accent-blue: #00B0FF;
        --accent-red: #FF1744;
        --text-white: #ffffff;
        --accent-green: #4CAF50;
        --accent-purple: #9C27B0;
    }

    body {
        background-color: black;
        overflow: hidden;
    }

    .tv-screen {
        min-height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at center, #1e1e24 0%, #000000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: 'Rajdhani', sans-serif;
        color: white;
        padding: 20px;
    }

    .tournament-header {
        text-align: center;
        margin-bottom: 2vh;
    }

    .palaro-branding {
        font-family: 'Orbitron', sans-serif;
        font-size: 2.5rem;
        color: var(--accent-gold);
        letter-spacing: 5px;
        font-weight: bold;
    }

    .sport-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 3rem;
        font-weight: 900;
    }

    .match-details {
        font-size: 1.5rem;
        color: #aaa;
        margin-top: 5px;
    }

    .scoreboard-card {
        width: 95%;
        max-width: 1400px;
        background: var(--panel-bg);
        border-radius: 25px;
        padding: 30px;
        margin-bottom: 3vh;
        text-align: center;
        font-size: 1.8rem;
        font-family: 'Rajdhani', sans-serif;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .status-badge {
        font-family: 'Orbitron', sans-serif;
        padding: 8px 30px;
        border-radius: 50px;
        font-size: 1.5rem;
        font-weight: bold;
    }

    .live {
        background: var(--accent-red);
        animation: pulse 1.5s infinite;
    }

    .final {
        background: #00C853;
    }

    .results-table {
        width: 95%;
        max-width: 1400px;
        background: rgba(255,255,255,0.05);
        border-radius: 15px;
        padding: 20px;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1
        }

        50% {
            opacity: 0.7
        }
    }

    .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255,255,255,0.1);
        color: white;
        border: 1px solid #333;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

        .back-button:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

    /* Gold, Silver, Bronze highlighting */
    .gold-row {
        background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05)) !important;
        border-left: 4px solid var(--accent-gold) !important;
    }

    .silver-row {
        background: linear-gradient(90deg, rgba(192, 192, 192, 0.15), rgba(192, 192, 192, 0.05)) !important;
        border-left: 4px solid #C0C0C0 !important;
    }

    .bronze-row {
        background: linear-gradient(90deg, rgba(205, 127, 50, 0.15), rgba(205, 127, 50, 0.05)) !important;
        border-left: 4px solid #CD7F32 !important;
    }

    .result-cell {
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
        text-align: center;
        font-size: 1.3rem;
        color: var(--accent-gold);
    }

    .region-flag {
        width: 30px;
        height: 30px;
        margin-right: 10px;
        border-radius: 50%;
        overflow: hidden;
        background: rgba(255,255,255,0.1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

        .region-flag img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

    /* Separator dot */
    .separator-dot {
        color: #666;
        font-size: 1.5rem;
    }

    .heat-lane-badge {
        background: rgba(0, 176, 255, 0.2);
        color: var(--accent-blue);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.9rem;
        margin-left: 10px;
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
    }
</style>

<div class="tv-screen">
    <button class="back-button" onclick="history.back()">← Back</button>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate Color="Color.Warning" Size="Size.Large" />
    }
    else if (_event == null)
    {
        <MudText Typo="Typo.h4" Color="Color.Error">EVENT NOT FOUND</MudText>
    }
    else
    {
        <div class="tournament-header">
            <div class="palaro-branding">PALARONG PAMBANSA 2026</div>
            <div class="sport-name">@_event.Subcategory</div>
            <div class="match-details">
                @if (_event.IsFinished == true)
                {
                    <div class="status-badge final">FINAL</div>
                }
                else
                {
                    <div class="status-badge live">LIVE</div>
                }
            </div>
        </div>

        <div class="scoreboard-card">
            @_event.Sport
            <span class="separator-dot">•</span>
            @_event.Level
            <span class="separator-dot">•</span>
            @_event.Gender
            <span class="separator-dot">•</span>
            @_event.Subcategory
        </div>

        @if (_rankings.Any())
        {
            <div class="results-table">
                <MudTable Items="_rankings.OrderBy(r => r.Rank).ToList()"
                          Dense Hover>
                    <HeaderContent>
                        <MudTh style="font-size: 1.3rem;">Rank</MudTh>
                        <MudTh style="font-size: 1.3rem;">Athlete</MudTh>
                        <MudTh style="font-size: 1.3rem;">Region</MudTh>
                        <MudTh style="text-align:center; font-size: 1.3rem;">Heat/Lane</MudTh>
                        <MudTh style="text-align:center; font-size: 1.3rem;">Result</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd>
                            @if (context.Rank > 0)
                            {
                                <span style="font-family: Orbitron; font-weight:bold; color:white; font-size: 1.3rem;">
                                    #@context.Rank
                                </span>
                            }
                            else
                            {
                                <span style="color: #666;">-</span>
                            }
                        </MudTd>
                        <MudTd>
                            <div style="font-weight: bold; font-size: 1.3rem;">@context.PlayerName</div>
                        </MudTd>
                        <MudTd>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="region-flag">
                                    <MudImage Src="@GetRegionLogo(context.RegionAbbreviation)"
                                              ObjectFit="ObjectFit.Contain"
                                              Alt="@context.RegionAbbreviation"
                                              Style="width:100%; height:100%;" />
                                </div>
                                <div style="font-weight:bold; font-size:1.3rem;">
                                    @context.RegionAbbreviation
                                </div>
                            </div>
                        </MudTd>
                        <MudTd style="text-align:center;">
                            @if (!string.IsNullOrEmpty(context.AssignedLane))
                            {
                                <span class="heat-lane-badge">@context.AssignedLane</span>
                            }
                            else
                            {
                                <span style="color: #666;">-</span>
                            }
                        </MudTd>
                        <MudTd class="result-cell">
                            @if (!string.IsNullOrEmpty(context.Result))
                            {
                                @context.Result
                            }
                            else
                            {
                                <text>-</text>
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
        }
    }
</div>

@code {
    [Parameter] public string EventID { get; set; } = "";

    /* ===================== MODELS ===================== */

    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Level { get; set; }
        public string? Gender { get; set; }
        public string? EventStage { get; set; }
        public bool? IsFinished { get; set; }
    }

    public class RankingDTO
    {
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string Result { get; set; } = "";
        public string RegionAbbreviation { get; set; } = "";
        public string? PlayerName { get; set; }
        public string? AssignedLane { get; set; }
        public int Rank { get; set; }
    }

    public class SchoolRegions
    {
        public int ID { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
    }

    public class SavedScoringData
    {
        public List<SavedHeat> Heats { get; set; } = new();
        public List<SavedAssignment> Assignments { get; set; } = new();
    }

    public class SavedHeat
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public List<SavedLane> Lanes { get; set; } = new();
    }

    public class SavedLane
    {
        public string LaneName { get; set; } = "";
        public int LaneOrder { get; set; }
        public string? Result { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
        public string? RegionAbbreviation { get; set; }
    }

    public class SavedAssignment
    {
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string RegionAbbreviation { get; set; } = "";
        public string AssignedTable { get; set; } = "";
    }

    /* ===================== STATE ===================== */

    private EventInfo? _event;
    private List<RankingDTO> _rankings = new();
    private List<SchoolRegions>? _allRegions;
    private bool _isLoading = true;
    private Timer? _refreshTimer;

    /* ===================== INIT ===================== */

    protected override async Task OnInitializedAsync()
    {
        // Load regions first
        _allRegions = await apiService.GetAsync<SchoolRegions>("/Schools/Regions");

        await LoadData();
        // Auto-refresh every 2 seconds for live updates
        _refreshTimer = new Timer(async _ => await InvokeAsync(LoadData), null, 2000, 2000);
    }

    /* ===================== GET DATA ===================== */

    private async Task LoadData()
    {
        try
        {
            // Load event details
            var events = await apiService.GetAsync<EventInfo>(
                $"TimeDistanceEvents/Sports/AthleticsSwimming?eventID={EventID}");

            if (events != null && events.Any())
            {
                _event = events.First();

                // Determine if event is finished based on EventStage
                _event.IsFinished = _event.EventStage?.Equals("Completed", StringComparison.OrdinalIgnoreCase) ?? false;

                // Load rankings from saved data
                await LoadRankings();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading event: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadRankings()
    {
        if (_event == null) return;

        try
        {
            var savedData = await apiService.GetSingleAsync<SavedScoringData>($"TimeDistanceEvents/Sports/AthleticsSwimming/{_event.ID}");

            if (savedData == null || !savedData.Heats.Any())
            {
                _rankings = new List<RankingDTO>();
                return;
            }

            var rankings = new List<RankingDTO>();

            // Collect all results from heats
            foreach (var heat in savedData.Heats)
            {
                foreach (var lane in heat.Lanes)
                {
                    if (lane.RegionID.HasValue && !string.IsNullOrEmpty(lane.Result))
                    {
                        rankings.Add(new RankingDTO
                        {
                            RegionID = lane.RegionID.Value,
                            PlayerID = lane.PlayerID,
                            PlayerName = lane.PlayerName ?? "",
                            RegionAbbreviation = lane.RegionAbbreviation ?? "",
                            Result = lane.Result,
                            AssignedLane = $"{heat.HeatName} - {lane.LaneName}"
                        });
                    }
                }
            }

            // Calculate rankings
            _rankings = CalculateRankings(rankings);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading rankings: {ex.Message}");
            _rankings = new List<RankingDTO>();
        }
    }

    private List<RankingDTO> CalculateRankings(List<RankingDTO> results)
    {
        if (!results.Any()) return results;

        // Parse results to numeric values for ranking
        var parsedResults = results.Select(r => new
        {
            Original = r,
            NumericValue = ParseResult(r.Result)
        }).Where(x => x.NumericValue.HasValue).ToList();

        if (!parsedResults.Any()) return results;

        // Determine if this is time-based (lower is better) or distance-based (higher is better)
        // Check if results contain ":" (time format) or are just numbers (distance)
        bool isTimeBased = results.Any(r => r.Result.Contains(":"));

        // Sort and assign ranks
        var sorted = isTimeBased
            ? parsedResults.OrderBy(x => x.NumericValue.Value).ToList()
            : parsedResults.OrderByDescending(x => x.NumericValue.Value).ToList();

        int rank = 1;
        for (int i = 0; i < sorted.Count; i++)
        {
            if (i > 0 && sorted[i].NumericValue != sorted[i - 1].NumericValue)
            {
                rank = i + 1;
            }
            sorted[i].Original.Rank = rank;
        }

        return sorted.Select(x => x.Original).OrderBy(r => r.Rank).ToList();
    }

    private double? ParseResult(string result)
    {
        if (string.IsNullOrWhiteSpace(result)) return null;

        // Try parsing as time (mm:ss.ms or ss.ms)
        if (result.Contains(":"))
        {
            if (TimeSpan.TryParse(result, out TimeSpan timeResult))
            {
                return timeResult.TotalSeconds;
            }
        }

        // Try parsing as distance (numeric)
        if (double.TryParse(result, out double numericResult))
        {
            return numericResult;
        }

        return null;
    }

    private string GetRegionLogo(string regionAbbreviation)
    {
        if (string.IsNullOrWhiteSpace(regionAbbreviation))
            return "/images/region-placeholder.png";

        // Find the actual region name from the abbreviation
        var region = _allRegions?.FirstOrDefault(r =>
            r.Abbreviation?.Equals(regionAbbreviation, StringComparison.OrdinalIgnoreCase) == true);

        // Use the actual region name for the logo
        var actualRegionName = region?.Region ?? regionAbbreviation;

        return $"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{actualRegionName.Trim()}.webp";
    }

    /* ===================== CLEANUP ===================== */

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
