@page "/scoreboard/track-events"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>Track Events Scoreboard | PALARO 2026</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&family=Chakra+Petch:wght@600;700&display=swap');

    :root {
        --bg-dark: #0a0a0a;
        --card-bg: rgba(30, 30, 30, 0.7);
        --card-border: rgba(255, 255, 255, 0.1);
        --text-primary: #ffffff;
        --accent-yellow: #FFD700;
        --accent-gold: #FFC107;
        --accent-amber: #FFA000;
        --accent-green: #00E676;
        --accent-red: #FF0000;
        --neon-yellow: 0 0 10px rgba(255, 215, 0, 0.6), 0 0 20px rgba(255, 215, 0, 0.3);
        --neon-gold: 0 0 10px rgba(255, 193, 7, 0.4);
        --neon-red: 0 0 10px rgba(255, 0, 0, 0.6);
    }

    /* BACKGROUND TEXTURE */
    .dashboard-bg {
        background-color: var(--bg-dark);
        background-image: radial-gradient(circle at 10% 20%, rgba(255, 215, 0, 0.08) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(255, 193, 7, 0.05) 0%, transparent 40%), linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
        min-height: 100vh;
        color: var(--text-primary);
        font-family: 'Rajdhani', sans-serif;
    }

    /* HEADER */
    .header-container {
        text-align: center;
        margin-bottom: 40px;
        position: relative;
        padding: 30px 0;
        background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
        border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    }

    .main-title {
        font-family: 'Orbitron', sans-serif;
        font-weight: 900;
        font-size: clamp(2rem, 5vw, 3.5rem);
        background: linear-gradient(180deg, #FFD700 0%, #FFC107 50%, #FFA000 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: 4px;
        text-transform: uppercase;
        margin-bottom: 5px;
        filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
    }

    .sub-title {
        font-family: 'Chakra Petch', sans-serif;
        color: rgba(255, 255, 255, 0.7);
        font-size: clamp(1rem, 1.5vw, 1.3rem);
        letter-spacing: 8px;
        font-weight: 700;
        text-transform: uppercase;
        position: relative;
        display: inline-block;
    }

        .sub-title::before, .sub-title::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 60px;
            height: 2px;
            background: var(--accent-yellow);
            opacity: 0.5;
        }

        .sub-title::before {
            left: -80px;
        }

        .sub-title::after {
            right: -80px;
        }

    /* EVENT LINK */
    .event-link {
        text-decoration: none;
        display: block;
        height: 100%;
    }

    /* CARD DESIGN */
    .event-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 20px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        height: 100%;
    }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--accent-yellow), transparent);
            opacity: 0.5;
        }

        .event-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--accent-yellow);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.15);
        }

            .event-card:hover::before {
                opacity: 1;
            }

    /* TRACK SPECIFIC ELEMENTS */
    .track-icon {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.05));
        border-radius: 50%;
        padding: 10px;
        border: 1px solid rgba(255, 215, 0, 0.3);
    }

    .track-stats {
        display: flex;
        justify-content: space-between;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 12px;
        padding: 10px 15px;
        margin: 10px 0;
        border: 1px solid rgba(255, 215, 0, 0.3);
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.5rem;
        font-weight: 900;
        color: var(--accent-yellow);
        line-height: 1;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    .stat-label {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.75rem;
        color: #aaa;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 3px;
    }

    .lane-info {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        background: rgba(255, 215, 0, 0.1);
        border-radius: 6px;
        margin: 5px 0;
        border: 1px solid rgba(255, 215, 0, 0.2);
    }

    .lane-number {
        font-family: 'Orbitron', sans-serif;
        font-weight: 700;
        color: var(--accent-yellow);
        min-width: 30px;
    }

    .time-display {
        font-family: 'Orbitron', sans-serif;
        font-weight: 700;
        color: var(--accent-green);
        font-variant-numeric: tabular-nums;
    }

    /* BADGES */
    .status-container {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 8px;
        z-index: 5;
    }

    .event-type-badge {
        background: rgba(0,0,0,0.8);
        color: var(--accent-yellow);
        padding: 4px 12px;
        border-radius: 6px;
        font-family: 'Chakra Petch';
        font-weight: 700;
        font-size: 0.8rem;
        border: 1px solid var(--accent-yellow);
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    }

    .status-badge {
        padding: 4px 15px;
        border-radius: 6px;
        font-family: 'Chakra Petch';
        font-weight: 800;
        font-size: 0.8rem;
        letter-spacing: 1px;
    }

    .badge-live {
        background: linear-gradient(135deg, #FF0000 0%, #CC0000 100%);
        color: white;
        box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
        border: 1px solid #FF4444;
        animation: pulse 2s infinite;
    }

    .badge-final {
        background: linear-gradient(135deg, #00C853 0%, #00695C 100%);
        color: white;
        border: 1px solid #69F0AE;
        box-shadow: 0 0 10px rgba(0, 230, 118, 0.4);
    }

    .badge-upcoming {
        background: linear-gradient(135deg, #FFB300 0%, #F57C00 100%);
        color: white;
        border: 1px solid #FFB74D;
        box-shadow: 0 0 10px rgba(255, 179, 0, 0.4);
    }

    .leader-icon {
        background: var(--accent-yellow);
        color: #000;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        margin-right: 8px;
    }

    /* RESULTS LIST */
    .results-list {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 10px;
        padding-right: 5px;
    }

    .result-item {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        margin-bottom: 5px;
        border-left: 3px solid transparent;
    }

        .result-item:nth-child(1) {
            border-left-color: #FFD700;
            background: rgba(255, 215, 0, 0.05);
        }

        .result-item:nth-child(2) {
            border-left-color: #C0C0C0;
            background: rgba(192, 192, 192, 0.05);
        }

        .result-item:nth-child(3) {
            border-left-color: #CD7F32;
            background: rgba(205, 127, 50, 0.05);
        }

    .rank-badge {
        font-family: 'Orbitron', sans-serif;
        font-weight: 900;
        font-size: 0.9rem;
        min-width: 30px;
        text-align: center;
    }

    .result-item:nth-child(1) .rank-badge {
        color: #FFD700;
        text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }

    .result-item:nth-child(2) .rank-badge {
        color: #C0C0C0;
    }

    .result-item:nth-child(3) .rank-badge {
        color: #CD7F32;
    }

    .athlete-info {
        flex-grow: 1;
        padding: 0 10px;
    }

    .athlete-name {
        font-family: 'Chakra Petch', sans-serif;
        font-size: 0.9rem;
        font-weight: 700;
        color: white;
    }

    .athlete-region {
        font-size: 0.75rem;
        color: var(--accent-yellow);
        font-weight: 600;
    }

    /* MUD TABS CUSTOMIZATION */
    .mud-tabs-tabbar {
        background-color: transparent !important;
        border-bottom: 1px solid #333;
    }

    .mud-tab {
        color: #888 !important;
        font-family: 'Orbitron';
        font-weight: 700;
        letter-spacing: 1px;
        transition: color 0.3s;
    }

    .mud-tab-active {
        color: var(--accent-yellow) !important;
        font-weight: 900;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
    }

    .mud-tabs-indicator {
        background-color: var(--accent-yellow) !important;
        height: 3px;
        box-shadow: 0 0 10px var(--accent-yellow);
    }

    @@keyframes pulse {
        0% {
            opacity: 1;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
        }

        50% {
            opacity: 0.8;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
        }

        100% {
            opacity: 1;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
        }
    }

    /* SCROLLBAR STYLING */
    .results-list::-webkit-scrollbar {
        width: 4px;
    }

    .results-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 2px;
    }

    .results-list::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, var(--accent-yellow), #FFC107);
        border-radius: 2px;
    }

    /* LOADING STATE */
    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        background: rgba(30,30,30,0.5);
        border-radius: 20px;
        border: 1px dashed #444;
    }
</style>

<div class="dashboard-bg">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">

        <!-- HEADER -->
        <div class="header-container">
            <div class="main-title">PALARONG PAMBANSA 2026</div>
            <div class="sub-title">TRACK & FIELD SCOREBOARD</div>
        </div>


        @if (_isLoading)
        {
            <div class="loading-state">
                <MudProgressCircular Indeterminate="true" Color="Color.Warning" Size="Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-4" Style="font-family:'Orbitron'; color:var(--accent-yellow);">LOADING TRACK EVENTS...</MudText>
            </div>
        }
        else if (!_allEvents.Any())
        {
            <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-4" Style="background-color: rgba(30,30,30,0.5); border: 1px dashed #444; border-radius: 20px;">
                <MudIcon Icon="@Icons.Material.Filled.TimerOff" Size="Size.Large" Style="color: #555; width: 60px; height: 60px;" />
                <MudText Typo="Typo.h5" Class="mt-4" Style="color: #666; font-family:'Orbitron'; font-weight:700;">NO TRACK EVENTS</MudText>
                <MudText Typo="Typo.body2" Style="color: #555;">Waiting for event data...</MudText>
            </MudPaper>
        }
        else
        {
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="mt-6" Centered="true">

                <!-- TAB 1: LIVE (Includes Scheduled Events) -->
                <MudTabPanel Text="LIVE/ONGOING">
                    @{
                        // Include Live, In Progress, and Scheduled events
                        var liveEvents = _allEvents
                        .Where(e => e.EventStage?.Equals("Live", StringComparison.OrdinalIgnoreCase) == true ||
                        e.EventStage?.Equals("In Progress", StringComparison.OrdinalIgnoreCase) == true ||
                        e.EventStage?.Equals("Scheduled", StringComparison.OrdinalIgnoreCase) == true ||
                        (e.EventStage != "Completed" && e.EventStage != "Finished"))
                        .ToList();
                    }

                    @if (!liveEvents.Any())
                    {
                        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-4" Style="background-color: rgba(30,30,30,0.5); border: 1px dashed #444; border-radius: 20px;">
                            <MudIcon Icon="@Icons.Material.Filled.LiveTv" Size="Size.Large" Style="color: #555; width: 60px; height: 60px;" />
                            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #666; font-family:'Orbitron'; font-weight:700;">NO TRACK EVENTS</MudText>
                            <MudText Typo="Typo.body2" Style="color: #555;">All track events are completed</MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudGrid Spacing="3">
                            @foreach (var evt in liveEvents)
                            {
                                var isLive = evt.EventStage?.Equals("Live", StringComparison.OrdinalIgnoreCase) == true ||
                                evt.EventStage?.Equals("In Progress", StringComparison.OrdinalIgnoreCase) == true;
                                var isScheduled = evt.EventStage?.Equals("Scheduled", StringComparison.OrdinalIgnoreCase) == true;

                                var eventResults = _eventRankings.ContainsKey(evt.ID) ? _eventRankings[evt.ID] : new List<RankingResult>();
                                var participantCount = _eventParticipantCount.ContainsKey(evt.ID) ? _eventParticipantCount[evt.ID] : 0;
                                var heatCount = _eventHeats.ContainsKey(evt.ID) ? _eventHeats[evt.ID].Count : 0;

                                <MudItem xs="12" md="6" lg="4" xl="3">
                                    <a href="/scoreboard/track-events/@evt.ID" class="event-link">
                                        <div class="event-card">
                                            <div class="status-container">
                                                <div class="event-type-badge">@(evt.Level ?? "All")</div>
                                                @if (isLive)
                                                {
                                                    <div class="status-badge badge-live">LIVE</div>
                                                }
                                                else if (isScheduled)
                                                {
                                                    <div class="status-badge badge-upcoming">UPCOMING</div>
                                                }
                                                else
                                                {
                                                    <div class="status-badge" style="background:linear-gradient(135deg, #FF0000 0%, #CC0000 100%); color:white; border:1px solid #FF4444; animation: pulse 2s infinite;">LIVE</div>
                                                }
                                            </div>

                                            <div class="pa-5">
                                                <!-- Sport Header -->
                                                <div class="d-flex align-center mb-4">
                                                    <div class="track-icon mr-3">
                                                        <MudIcon Icon="@GetTrackIcon(evt.Subcategory)" Size="Size.Small" Style="color:var(--accent-yellow);" />
                                                    </div>
                                                    <div>
                                                        <MudText Typo="Typo.subtitle1" Style="font-family:'Orbitron'; font-weight:900; color:white; line-height:1.2;">@(evt.Subcategory?.ToUpper() ?? "TRACK EVENT")</MudText>
                                                        <MudText Typo="Typo.caption" Style="color:#aaa; font-family:'Rajdhani'; letter-spacing:1px; font-weight:600;">
                                                            @(evt.Gender ?? "Mixed") • @(evt.Level ?? "Open")
                                                        </MudText>
                                                    </div>
                                                </div>

                                                <MudDivider Class="mb-4" Style="border-color: rgba(255,255,255,0.1);" />

                                                <!-- Event Stats -->
                                                <div class="track-stats">
                                                    <div class="stat-item">
                                                        <div class="stat-value">@participantCount</div>
                                                        <div class="stat-label">Athletes</div>
                                                    </div>
                                                    <div class="stat-item">
                                                        <div class="stat-value">@heatCount</div>
                                                        <div class="stat-label">Heats</div>
                                                    </div>
                                                    <div class="stat-item">
                                                        <div class="stat-value">@(eventResults.Count)</div>
                                                        <div class="stat-label">Results</div>
                                                    </div>
                                                </div>

                                                @if (isScheduled)
                                                {
                                                    <!-- UPCOMING EVENT VIEW -->
                                                    <div class="d-flex align-center mb-3">
                                                        <div class="leader-icon" style="background:#FFB300;">
                                                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                                        </div>
                                                        <MudText Typo="Typo.caption" Style="font-family:'Chakra Petch'; font-weight:700; color:#FFB300;">UPCOMING EVENT</MudText>
                                                    </div>

                                                    <div style="background: rgba(255,179,0,0.1); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,179,0,0.3); text-align: center;">
                                                        @if (evt.Date.HasValue)
                                                        {
                                                            <div style="font-size: 1.1rem; color: #FFB300; font-weight: 700; margin-bottom: 5px;">
                                                                @evt.Date.Value.ToString("MMM dd")
                                                            </div>
                                                            <div style="font-size: 0.9rem; color: white; margin-bottom: 10px;">
                                                                @(!string.IsNullOrEmpty(evt.Time) ? $"{evt.Time}" : "Time TBD")
                                                            </div>
                                                        }
                                                        <div style="font-size: 0.8rem; color: #ccc;">
                                                            @participantCount athletes registered
                                                        </div>
                                                    </div>
                                                }
                                                else if (eventResults.Any())
                                                {
                                                    <!-- Top Results -->
                                                    <div class="d-flex align-center mb-2">
                                                        <div class="leader-icon">
                                                            <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Size="Size.Small" />
                                                        </div>
                                                        <MudText Typo="Typo.caption" Style="font-family:'Chakra Petch'; font-weight:700; color:white;">LEADERBOARD</MudText>
                                                    </div>

                                                    <div class="results-list">
                                                        @foreach (var result in eventResults.Take(3))
                                                        {
                                                            <div class="result-item">
                                                                <div class="rank-badge">#@result.Rank</div>
                                                                <div class="athlete-info">
                                                                    <div class="athlete-name">@result.PlayerName</div>
                                                                    <div class="athlete-region">@result.RegionName</div>
                                                                </div>
                                                                <div class="time-display">@FormatResultDisplay(result.Result, evt.Subcategory)</div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <!-- Heats Preview or In Progress -->
                                                    <div class="d-flex align-center mb-2">
                                                        <div class="leader-icon">
                                                            <MudIcon Icon="@Icons.Material.Filled.FormatListNumbered" Size="Size.Small" />
                                                        </div>
                                                        <MudText Typo="Typo.caption" Style="font-family:'Chakra Petch'; font-weight:700; color:white;">
                                                            @(isLive ? "HEATS IN PROGRESS" : "EVENT IN PROGRESS")
                                                        </MudText>
                                                    </div>

                                                    @if (_eventHeats.ContainsKey(evt.ID) && _eventHeats[evt.ID].Any())
                                                    {
                                                        @foreach (var heat in _eventHeats[evt.ID].Take(2))
                                                        {
                                                            <div class="lane-info">
                                                                <div class="lane-number">H@(heat.HeatOrder)</div>
                                                                <div style="flex-grow:1; font-size:0.9rem;">@heat.HeatName</div>
                                                                @if (!string.IsNullOrEmpty(heat.FastestTime))
                                                                {
                                                                    <div class="time-display" style="font-size:0.9rem;">@FormatResultDisplay(heat.FastestTime, evt.Subcategory)</div>
                                                                }
                                                            </div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <div class="d-flex align-center justify-center py-4">
                                                            <MudText Typo="Typo.body2" Style="color: #aaa; font-style: italic;">
                                                                @(isLive ? "Live timing in progress" : "Event starting soon")
                                                            </MudText>
                                                        </div>
                                                    }
                                                }

                                                <!-- Event Details -->
                                                <div class="mt-4">
                                                    @if (evt.Date.HasValue)
                                                    {
                                                        <div class="d-flex align-center" style="color: #ccc; font-size: 0.9rem;">
                                                            <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Class="mr-2" />
                                                            @evt.Date.Value.ToString("MMM dd") @(!string.IsNullOrEmpty(evt.Time) ? $"• {evt.Time}" : "")
                                                        </div>
                                                    }
                                                    <MudText Typo="Typo.caption" Style="color: var(--accent-yellow); font-weight:600; margin-top: 8px;">
                                                        Click for @(isScheduled ? "event details" : "live timing")
                                                    </MudText>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudTabPanel>

                <!-- TAB 2: PARTIAL RESULT -->
                <MudTabPanel Text="PARTIAL RESULT">
                    @{
                        var completedEvents = _allEvents
                        .Where(e => e.EventStage?.Equals("Completed", StringComparison.OrdinalIgnoreCase) == true)
                        .ToList();
                    }

                    @if (!completedEvents.Any())
                    {
                        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-4" Style="background-color: rgba(30,30,30,0.5); border: 1px dashed #444; border-radius: 20px;">
                            <MudIcon Icon="@Icons.Material.Filled.HistoryToggleOff" Size="Size.Large" Style="color: #555;" />
                            <MudText Typo="Typo.h6" Class="mt-4" Style="color: #777; font-family:'Orbitron'">NO COMPLETED EVENTS YET</MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudGrid Spacing="3">
                            @foreach (var evt in completedEvents)
                            {
                                var eventResults = _eventRankings.ContainsKey(evt.ID) ? _eventRankings[evt.ID] : new List<RankingResult>();
                                var participantCount = _eventParticipantCount.ContainsKey(evt.ID) ? _eventParticipantCount[evt.ID] : 0;

                                <MudItem xs="12" md="6" lg="4" xl="3">
                                    <a href="/scoreboard/track-events/@evt.ID" class="event-link">
                                        <div class="event-card">
                                            <div class="status-container">
                                                <div class="event-type-badge">@(evt.Level ?? "All")</div>
                                                <div class="status-badge badge-final">FINAL</div>
                                            </div>

                                            <div class="pa-5">
                                                <!-- Sport Header -->
                                                <div class="d-flex align-center mb-4">
                                                    <div class="track-icon mr-3">
                                                        <MudIcon Icon="@GetTrackIcon(evt.Subcategory)" Size="Size.Small" Style="color:var(--accent-yellow);" />
                                                    </div>
                                                    <div>
                                                        <MudText Typo="Typo.subtitle1" Style="font-family:'Orbitron'; font-weight:900; color:white; line-height:1.2;">@(evt.Subcategory?.ToUpper() ?? "TRACK EVENT")</MudText>
                                                        <MudText Typo="Typo.caption" Style="color:#aaa; font-family:'Rajdhani'; letter-spacing:1px; font-weight:600;">
                                                            @(evt.Gender ?? "Mixed") • @(evt.Level ?? "Open")
                                                        </MudText>
                                                    </div>
                                                </div>

                                                <MudDivider Class="mb-4" Style="border-color: rgba(255,255,255,0.1);" />

                                                <!-- Event Stats -->
                                                <div class="track-stats">
                                                    <div class="stat-item">
                                                        <div class="stat-value">@participantCount</div>
                                                        <div class="stat-label">Athletes</div>
                                                    </div>
                                                    <div class="stat-item">
                                                        <div class="stat-value">@eventResults.Count</div>
                                                        <div class="stat-label">Finalists</div>
                                                    </div>
                                                    <div class="stat-item">
                                                        <div class="stat-value" style="color:#FFD700;">GOLD</div>
                                                        <div class="stat-label">Medal</div>
                                                    </div>
                                                </div>

                                                <!-- Winner Display -->
                                                @if (eventResults.Any())
                                                {
                                                    var winner = eventResults.FirstOrDefault();
                                                    <div class="d-flex align-center mb-3">
                                                        <div class="leader-icon" style="background:#FFD700;">
                                                            <MudIcon Icon="@Icons.Material.Filled.MilitaryTech" Size="Size.Small" />
                                                        </div>
                                                        <MudText Typo="Typo.caption" Style="font-family:'Chakra Petch'; font-weight:700; color:#FFD700;">CHAMPION</MudText>
                                                    </div>

                                                    <div style="background: rgba(255,215,0,0.1); border-radius: 8px; padding: 10px; border: 1px solid rgba(255,215,0,0.3);">
                                                        <div class="d-flex align-center mb-2">
                                                            <div class="rank-badge" style="color:#FFD700;">#1</div>
                                                            <div class="athlete-info">
                                                                <div class="athlete-name">@winner?.PlayerName</div>
                                                                <div class="athlete-region">@winner?.RegionName</div>
                                                            </div>
                                                        </div>
                                                        <div class="time-display" style="text-align:center; font-size:1.2rem;">
                                                            @FormatResultDisplay(winner?.Result, evt.Subcategory)
                                                        </div>
                                                    </div>

                                                    <!-- Show 2nd and 3rd place -->
                                                    @if (eventResults.Count > 1)
                                                    {
                                                        <div class="results-list mt-3">
                                                            @foreach (var result in eventResults.Skip(1).Take(2))
                                                            {
                                                                <div class="result-item">
                                                                    <div class="rank-badge">#@result.Rank</div>
                                                                    <div class="athlete-info">
                                                                        <div class="athlete-name">@result.PlayerName</div>
                                                                        <div class="athlete-region">@result.RegionName</div>
                                                                    </div>
                                                                    <div class="time-display">@FormatResultDisplay(result.Result, evt.Subcategory)</div>
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="d-flex align-center justify-center py-6">
                                                        <MudText Typo="Typo.body2" Style="color: #aaa; font-style: italic;">Final results pending</MudText>
                                                    </div>
                                                }

                                                <!-- Event Details -->
                                                <div class="mt-4">
                                                    @if (evt.Date.HasValue)
                                                    {
                                                        <div class="d-flex align-center" style="color: #ccc; font-size: 0.9rem;">
                                                            <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Class="mr-2" />
                                                            @evt.Date.Value.ToString("MMM dd") @(!string.IsNullOrEmpty(evt.Time) ? $"• {evt.Time}" : "")
                                                        </div>
                                                    }
                                                    <MudText Typo="Typo.caption" Style="color: var(--accent-yellow); font-weight:600; margin-top: 8px;">
                                                        Click for full results
                                                    </MudText>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudTabPanel>
            </MudTabs>
        }
    </MudContainer>
</div>

@code {
    // --- VARIABLES ---
    private List<EventInfo> _allEvents = new();
    private Dictionary<string, List<HeatData>> _eventHeats = new();
    private Dictionary<string, List<RankingResult>> _eventRankings = new();
    private Dictionary<string, int> _eventParticipantCount = new();
    private bool _isLoading = true;
    private Timer? _refreshTimer;

    // Statistics
    private int _totalEvents = 0;
    private int _liveEventsCount = 0;
    private int _completedEventsCount = 0;
    private int _totalParticipants = 0;

    // --- LIFECYCLE ---
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _refreshTimer = new Timer(async _ => await InvokeAsync(LoadData), null, 5000, 5000);
    }

    private async Task LoadData()
    {
        try
        {
            var participants = await apiService.GetAsync<EventInfo>("TimeDistanceEvents/Sports/AthleticsSwimming");

            if (participants != null && participants.Any())
            {
                // Filter only Track Events
                var trackEventsOnly = participants
                    .Where(p => !string.IsNullOrEmpty(p.SportMainCat) &&
                                p.SportMainCat.Equals("Track Events", StringComparison.OrdinalIgnoreCase))
                    .ToList();

                // Calculate statistics
                _totalParticipants = trackEventsOnly.Count;
                _liveEventsCount = trackEventsOnly
                    .Where(e => e.EventStage?.Equals("Live", StringComparison.OrdinalIgnoreCase) == true ||
                               e.EventStage?.Equals("In Progress", StringComparison.OrdinalIgnoreCase) == true ||
                               e.EventStage?.Equals("Scheduled", StringComparison.OrdinalIgnoreCase) == true)
                    .Select(e => e.ID)
                    .Distinct()
                    .Count();

                _completedEventsCount = trackEventsOnly
                    .Where(e => e.EventStage?.Equals("Completed", StringComparison.OrdinalIgnoreCase) == true)
                    .Select(e => e.ID)
                    .Distinct()
                    .Count();

                // Group by event ID
                _allEvents = trackEventsOnly
                    .GroupBy(e => e.ID)
                    .Select(g =>
                    {
                        var first = g.First();
                        return new EventInfo
                        {
                            ID = first.ID,
                            Sport = first.Sport,
                            Subcategory = first.Subcategory,
                            Gender = first.Gender,
                            Level = first.Level,
                            EventStage = first.EventStage,
                            Date = first.Date,
                            Time = first.Time,
                            SportMainCat = first.SportMainCat,
                            Region = first.Region,
                            Abbreviation = first.Abbreviation,
                            RegionID = first.RegionID,
                            PlayerID = first.PlayerID,
                            PlayerName = first.PlayerName
                        };
                    })
                    .OrderBy(e => e.EventStage == "Completed" ? 1 : 0) // Completed events last
                    .ThenBy(e => e.EventStage == "Scheduled" ? 0 : 1) // Scheduled first in Live tab
                    .ThenBy(e => e.Sport)
                    .ThenBy(e => e.Gender)
                    .ThenBy(e => e.Level)
                    .ThenBy(e => e.Subcategory)
                    .ToList();

                _totalEvents = _allEvents.Count;

                // Count participants per event
                _eventParticipantCount.Clear();
                foreach (var evt in _allEvents)
                {
                    var count = trackEventsOnly
                        .Where(p => p.ID == evt.ID)
                        .Count();
                    _eventParticipantCount[evt.ID] = count;
                }

                // Load saved data for each event
                foreach (var evt in _allEvents)
                {
                    try
                    {
                        var savedData = await LoadSavedScoringData(evt.ID);

                        if (savedData != null)
                        {
                            // Extract heat information
                            if (savedData.Heats != null && savedData.Heats.Any())
                            {
                                var heatInfos = new List<HeatData>();

                                foreach (var savedHeat in savedData.Heats.OrderBy(h => h.HeatOrder))
                                {
                                    var heatData = new HeatData
                                    {
                                        HeatName = savedHeat.HeatName,
                                        HeatOrder = savedHeat.HeatOrder,
                                        LaneCount = savedHeat.Lanes?.Count ?? 0
                                    };

                                    if (savedHeat.Lanes != null && savedHeat.Lanes.Any())
                                    {
                                        var validResults = savedHeat.Lanes
                                            .Where(l => !string.IsNullOrEmpty(l.Result))
                                            .Select(l => l.Result)
                                            .ToList();

                                        if (validResults.Any())
                                        {
                                            heatData.FastestTime = GetFastestResult(validResults, evt.Subcategory);
                                        }
                                    }

                                    heatInfos.Add(heatData);
                                }

                                _eventHeats[evt.ID] = heatInfos;
                            }

                            // Calculate rankings
                            var rankings = CalculateRankingsFromSavedData(savedData, evt);
                            if (rankings.Any())
                            {
                                _eventRankings[evt.ID] = rankings;
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error loading saved data for event {evt.ID}: {ex.Message}");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading track events: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task<SavedScoringData?> LoadSavedScoringData(string eventId)
    {
        try
        {
            var savedData = await apiService.GetSingleAsync<SavedScoringData>($"TimeDistanceEvents/Sports/AthleticsSwimming/{eventId}");
            return savedData ?? new SavedScoringData();
        }
        catch
        {
            return new SavedScoringData();
        }
    }

    private List<RankingResult> CalculateRankingsFromSavedData(SavedScoringData savedData, EventInfo evt)
    {
        var rankings = new List<RankingResult>();

        if (savedData.Heats == null || !savedData.Heats.Any())
            return rankings;

        var allResults = new List<(string RegionName, string PlayerName, string Result, string Lane, double NumericResult)>();

        foreach (var heat in savedData.Heats)
        {
            if (heat.Lanes == null) continue;

            foreach (var lane in heat.Lanes)
            {
                if (!string.IsNullOrEmpty(lane.Result) &&
                    !string.IsNullOrEmpty(lane.RegionAbbreviation) &&
                    TryParseResult(lane.Result, out double numericResult))
                {
                    allResults.Add((
                        lane.RegionAbbreviation,
                        lane.PlayerName ?? "",
                        lane.Result,
                        $"{heat.HeatName}-{lane.LaneName}",
                        numericResult
                    ));
                }
            }
        }

        if (!allResults.Any())
            return rankings;

        var sortedResults = allResults.OrderBy(r => r.NumericResult).ToList();

        for (int i = 0; i < sortedResults.Count; i++)
        {
            var result = sortedResults[i];
            rankings.Add(new RankingResult
            {
                RegionName = result.RegionName,
                PlayerName = result.PlayerName,
                Result = result.Result,
                AssignedLane = result.Lane,
                Rank = i + 1,
                NumericResult = result.NumericResult
            });
        }

        return rankings;
    }

    private string GetFastestResult(List<string> results, string? subcategory)
    {
        if (!results.Any()) return "";

        var parsedResults = new List<(string Original, double Numeric)>();

        foreach (var result in results)
        {
            if (TryParseResult(result, out double numeric))
            {
                parsedResults.Add((result, numeric));
            }
        }

        if (!parsedResults.Any()) return "";

        var fastest = parsedResults.OrderBy(r => r.Numeric).First();
        return fastest.Original;
    }

    private bool TryParseResult(string result, out double numericResult)
    {
        numericResult = 0;

        if (string.IsNullOrEmpty(result))
            return false;

        if (result.Contains(":") || result.Contains("."))
        {
            if (TimeSpan.TryParse(result, out TimeSpan timeResult))
            {
                
                return true;
            }
        }

        return double.TryParse(result, out numericResult);
    }

    private string FormatResultDisplay(string? result, string? subcategory)
    {
        if (string.IsNullOrEmpty(result)) return "--:--";

        if (result.Contains(":") || result.Contains("."))
        {
            return result;
        }

        if (double.TryParse(result, out double seconds))
        {
            if (seconds > 0)
            {
                var timeSpan = TimeSpan.FromSeconds(seconds);
                if (timeSpan.TotalMinutes >= 1)
                {
                    return timeSpan.ToString(@"m\:ss\.ff");
                }
                else
                {
                    return timeSpan.ToString(@"s\.ff");
                }
            }
        }

        return result;
    }

    private string GetTrackIcon(string? subcategory)
    {
        if (string.IsNullOrEmpty(subcategory))
            return Icons.Material.Filled.DirectionsRun;

        var s = subcategory.ToLower();
        if (s.Contains("100") || s.Contains("200") || s.Contains("400"))
            return Icons.Material.Filled.FlashOn;
        if (s.Contains("800") || s.Contains("1500") || s.Contains("5000") || s.Contains("10000"))
            return Icons.Material.Filled.Timeline;
        if (s.Contains("hurdle") || s.Contains("steeple"))
            return Icons.Material.Filled.Timeline;
        if (s.Contains("relay") || s.Contains("x") || s.Contains("medley"))
            return Icons.Material.Filled.Groups;
        if (s.Contains("walk"))
            return Icons.Material.Filled.DirectionsWalk;
        return Icons.Material.Filled.TrackChanges;
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }

    // --- MODELS ---
    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public DateTime? Date { get; set; }
        public string? Time { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class HeatData
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public int LaneCount { get; set; }
        public string? FastestTime { get; set; }
    }

    public class RankingResult
    {
        public string RegionName { get; set; } = "";
        public string? PlayerName { get; set; }
        public string Result { get; set; } = "";
        public string AssignedLane { get; set; } = "";
        public int Rank { get; set; }
        public double NumericResult { get; set; }
    }

    public class SavedScoringData
    {
        public List<SavedHeat> Heats { get; set; } = new();
        public List<SavedAssignment> Assignments { get; set; } = new();
    }

    public class SavedHeat
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public List<SavedLane> Lanes { get; set; } = new();
    }

    public class SavedLane
    {
        public string LaneName { get; set; } = "";
        public int LaneOrder { get; set; }
        public string? Result { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
        public string? RegionAbbreviation { get; set; }
    }

    public class SavedAssignment
    {
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string RegionAbbreviation { get; set; } = "";
        public string AssignedTable { get; set; } = "";
    }
}