@page "/scoreboard/carousel"
@page "/scoreboard/carousel/{TargetSport}"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>TV Broadcast Loop | Palaro tu AgSur 2026</PageTitle>

<style>
    /* --- FONTS --- */
    @@import url('https://fonts.cdnfonts.com/css/evil-empire');
    @@import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@500;600;700;800&family=Oswald:wght@500;700&family=Roboto+Condensed:wght@700&display=swap');

    :root {
        --pal-blue: #023E8A;
        --pal-dark-blue: #001845;
        --pal-gold: #FFB400;
        --pal-red: #D90429;
        --text-dark: #1e293b;
        --bg-gradient: radial-gradient(circle at 50% 50%, #f8fafc 0%, #cbd5e1 100%);
    }

    body, html {
        height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: var(--bg-gradient);
        font-family: 'Oswald', sans-serif;
    }

    .tv-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    /* CAROUSEL */
    .mud-carousel {
        height: 90vh !important;
        width: 100% !important;
    }

    .mud-carousel-item {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    /* HEADER PILL */
    .header-pill {
        background-color: var(--pal-dark-blue);
        padding: 2vh 4vw;
        border-radius: 0 0 30px 30px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        border-bottom: 5px solid var(--pal-gold);
        text-align: center;
        margin-bottom: -3vh;
        z-index: 10;
        transform: translateY(-2vh);
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .header-row {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .header-sport {
        font-family: 'Evil Empire', sans-serif;
        font-size: 6vh;
        color: white;
        line-height: 0.9;
        letter-spacing: 2px;
        text-transform: uppercase;
        text-shadow: 2px 2px 0 #000;
    }

    .header-sub {
        font-family: 'Chakra Petch', sans-serif;
        font-size: 2vh;
        color: var(--pal-gold);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 3px;
        margin-top: 0.5vh;
    }

    /* TV CARD UI */
    .tv-card {
        background: white;
        width: 90vw;
        height: 65vh;
        border-radius: 40px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        border: 1px solid #e2e8f0;
    }

    .card-body {
        flex: 1;
        display: grid;
        grid-template-columns: 25% 20% 10% 20% 25%;
        align-items: center;
        padding: 2vh 2vw;
    }

    /* TEAMS & SCORES */
    .team-block {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .team-logo {
        height: 18vh;
        width: 18vh;
        object-fit: contain;
        margin-bottom: 2vh;
        filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
    }

    .team-name {
        font-family: 'Evil Empire', sans-serif;
        font-size: 4vh;
        color: var(--pal-dark-blue);
        line-height: 1;
        margin-bottom: 0.5vh;
    }

    .team-region {
        font-family: 'Chakra Petch', sans-serif;
        font-size: 1.8vh;
        color: var(--pal-blue);
        font-weight: 700;
        text-transform: uppercase;
    }

    .score-block {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .main-score {
        font-family: 'Roboto Condensed', sans-serif;
        font-size: 25vh;
        font-weight: 700;
        color: #334155;
        line-height: 1;
    }

    .score-leader {
        color: var(--pal-dark-blue);
        transform: scale(1.1);
        text-shadow: 0 0 30px rgba(2, 62, 138, 0.2);
    }

    .center-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1vh;
    }

    .phase-pill {
        background: var(--pal-red);
        color: white;
        padding: 0.5vh 1.5vw;
        border-radius: 50px;
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 700;
        font-size: 2vh;
        white-space: nowrap;
        box-shadow: 0 4px 10px rgba(217, 4, 41, 0.3);
    }

    .vs-text {
        font-size: 2.5vh;
        color: #94a3b8;
        font-weight: 700;
        font-style: italic;
    }

    .set-count {
        font-size: 4vh;
        font-weight: 800;
        color: var(--pal-dark-blue);
    }

    /* HISTORY TABLE */
    .card-footer-history {
        background: #f1f5f9;
        border-top: 4px solid var(--pal-gold);
        padding: 1.5vh 0;
        display: flex;
        justify-content: center;
        min-height: 15vh;
    }

    .history-table {
        border-collapse: collapse;
        width: 60%;
    }

        .history-table th {
            color: #64748b;
            font-family: 'Chakra Petch';
            font-size: 1.5vh;
            text-transform: uppercase;
            border-bottom: 2px solid #cbd5e1;
            padding-bottom: 0.5vh;
        }

        .history-table td {
            font-family: 'Oswald';
            font-size: 3vh;
            font-weight: 600;
            color: var(--pal-dark-blue);
            text-align: center;
            padding: 0.5vh 1vw;
        }

    .history-team-name {
        text-align: right !important;
        font-size: 2vh !important;
        color: var(--pal-blue) !important;
        font-family: 'Chakra Petch' !important;
        font-weight: 700 !important;
        padding-right: 2vw !important;
    }

    .won-set {
        color: var(--pal-red) !important;
        font-weight: 800 !important;
    }

    /* FOOTER */
    .ticker-footer {
        height: 10vh;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4vw;
        border-top: 4px solid var(--pal-gold);
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        z-index: 20;
    }

    .footer-logo {
        height: 6vh;
        width: auto;
    }
</style>

<div class="tv-container">

    @if (_isLoading)
    {
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height:100vh;">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
            <h1 style="font-family:'Evil Empire'; font-size:3rem; margin-top:20px;">LOADING BROADCAST...</h1>
        </MudStack>
    }
    else if (_activeMatches.Count == 0)
    {
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height:90vh;">
            <div class="header-pill">
                <div class="header-sport">PALARONG PAMBANSA</div>
                <div class="header-sub">OFFICIAL BROADCAST</div>
            </div>
            <div class="tv-card" style="align-items:center; justify-content:center;">
                <MudIcon Icon="@Icons.Material.Filled.Sports" Style="font-size:15vh; color:#cbd5e1;" />
                <h2 style="font-family:'Evil Empire'; font-size:5vh; margin-top:2vh; color:#1e293b;">NO LIVE MATCHES</h2>
                <p style="font-family:'Chakra Petch'; font-size:2vh; color:#64748b;">PLEASE STAND BY</p>
            </div>
        </MudStack>
    }
    else
    {
        <MudCarousel Class="mud-width-full"
                     Style="height:90vh;"
                     ShowArrows="false"
                     ShowBullets="false"
                     EnableSwipeGesture="false"
                     AutoCycle="true"
                     CycleTime="@TimeSpan.FromSeconds(15)"
                     TData="object">

            @foreach (var match in _activeMatches)
            {
                <MudCarouselItem Transition="Transition.Fade" Color="@Color.Transparent">

                    <!-- HEADER -->
                    <div class="header-pill">
                        <div class="header-row">
                            <MudIcon Icon="@GetSportIcon(match.EventData.Sport)" Style="color:white; font-size:5vh;" />
                            <div class="header-sport">@GetCleanSportName(match.EventData.Sport)</div>
                        </div>
                        <div class="header-sub">
                            @GetSchoolLevel(match.EventData.Sport) • @match.EventData.Gender • @match.EventData.EventStage
                        </div>
                    </div>

                    <!-- CARD -->
                    <div class="tv-card">
                        <!-- BODY -->
                        <div class="card-body">
                            <!-- Team A -->
                            <div class="team-block">
                                <img src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{match.TeamA.Region}.webp")"
                                     class="team-logo" onerror="this.src='/media/images/2031.png'" />
                                <div class="team-name">@match.TeamA.Abbreviation</div>
                                <div class="team-region">@match.TeamA.Region</div>
                            </div>

                            <!-- Score A -->
                            <div class="score-block">
                                <div class="main-score @(match.IsWinnerA ? "score-leader" : "")">@match.DisplayScoreA</div>
                            </div>

                            <!-- Center -->
                            <div class="center-info">
                                @if (!string.IsNullOrEmpty(match.PhaseText))
                                {
                                    <div class="phase-pill">@match.PhaseText</div>
                                }
                                <div class="vs-text">VS</div>
                                @if (match.IsSetGame)
                                {
                                    <div class="set-count">@match.SetsA - @match.SetsB</div>
                                }
                            </div>

                            <!-- Score B -->
                            <div class="score-block">
                                <div class="main-score @(match.IsWinnerB ? "score-leader" : "")">@match.DisplayScoreB</div>
                            </div>

                            <!-- Team B -->
                            <div class="team-block">
                                <img src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{match.TeamB.Region}.webp")"
                                     class="team-logo" onerror="this.src='/media/images/2031.png'" />
                                <div class="team-name">@match.TeamB.Abbreviation</div>
                                <div class="team-region">@match.TeamB.Region</div>
                            </div>
                        </div>

                        <!-- HISTORY FOOTER -->
                        <div class="card-footer-history">
                            @if (match.MatchHistory != null && match.MatchHistory.Any())
                            {
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th>TEAM</th>
                                            @foreach (var set in match.MatchHistory)
                                            {
                                                <th>@GetTableColumnHeader(match.EventData.Sport, set.PhaseNumber)</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="history-team-name">@match.TeamA.Region</td>
                                            @foreach (var set in match.MatchHistory)
                                            {
                                                <td class="@(set.ScoreA > set.ScoreB ? "won-set" : "")">@set.ScoreA</td>
                                            }
                                        </tr>
                                        <tr>
                                            <td class="history-team-name">@match.TeamB.Region</td>
                                            @foreach (var set in match.MatchHistory)
                                            {
                                                <td class="@(set.ScoreB > set.ScoreA ? "won-set" : "")">@set.ScoreB</td>
                                            }
                                        </tr>
                                    </tbody>
                                </table>
                            }
                            else
                            {
                                <div style="display:flex; align-items:center; color:#94a3b8; font-family:'Chakra Petch';">
                                    MATCH STARTING...
                                </div>
                            }
                        </div>
                    </div>
                </MudCarouselItem>
            }
        </MudCarousel>
    }

    <!-- FOOTER -->
    <div class="ticker-footer">
        <img src="/media/images/2031.png" class="footer-logo" />
        <img src="/media/images/deped.png" class="footer-logo" />
        <img src="/media/images/bagongpilipinas.png" class="footer-logo" />
        <img src="/media/logo/Palarong Pambansa Logo.webp" onerror="this.src='/media/images/2031.png'" class="footer-logo" />
        <img src="/media/images/pgas.png" class="footer-logo" />
    </div>

</div>

@code {
    [Parameter] public string? TargetSport { get; set; }

    /* ================= DATA MODELS ================= */
    public class CarouselMatchViewModel
    {
        public string EventID { get; set; } = "";
        public EventModel EventData { get; set; } = new();
        public EventVersusTeams TeamA { get; set; } = new();
        public EventVersusTeams TeamB { get; set; } = new();
        public int DisplayScoreA { get; set; }
        public int DisplayScoreB { get; set; }
        public int SetsA { get; set; }
        public int SetsB { get; set; }
        public bool IsSetGame { get; set; }
        public string PhaseText { get; set; } = "";
        public bool IsWinnerA { get; set; }
        public bool IsWinnerB { get; set; }
        public List<PhaseScoreModel> MatchHistory { get; set; } = new();
    }
    public class PhaseScoreModel { public int PhaseNumber { get; set; } public int ScoreA { get; set; } public int ScoreB { get; set; } }
    public class EventModel { public string ID { get; set; } = ""; public string? Sport { get; set; } public string? Gender { get; set; } public string? EventStage { get; set; } public bool? IsFinished { get; set; } public List<EventVersusTeams>? EventVersusList { get; set; } }
    public class EventVersusTeams { public string? Region { get; set; } public string? Abbreviation { get; set; } }
    public class ClientTeamMatchDTO { public string? EventID { get; set; } public string? Region { get; set; } public int Phase { get; set; } public int Score { get; set; } }

    /* ================= LOGIC ================= */
    private List<CarouselMatchViewModel> _activeMatches = new();
    private bool _isLoading = true;
    private Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        await LoadCarouselData();
        _timer = new Timer(async _ => await InvokeAsync(RefreshScoresOnly), null, 5000, 5000);
    }

    private async Task LoadCarouselData()
    {
        try
        {
            var allEvents = await apiService.GetAsync<EventModel>("/Events/Details");
            if (allEvents != null)
            {
                // Basic Filter (2 teams, Not Finished)
                var teamMatches = allEvents
                    .Where(e => e.EventVersusList?.Count == 2)
                    .Where(e => IsAllowedTeamSport(e.Sport))
                    .Where(e => e.IsFinished != true)
                    .ToList();

                // === STRICT FILTERING FOR TENNIS VS TABLE TENNIS ===
                if (!string.IsNullOrEmpty(TargetSport))
                {
                    string target = TargetSport.ToLower().Trim();
                    teamMatches = teamMatches.Where(e =>
                    {
                        string sportName = (e.Sport ?? "").ToLower();

                        // Rules:
                        // 1. If target is "Tennis", EXCLUDE "Table Tennis"
                        if (target == "tennis" && sportName.Contains("table")) return false;

                        // 2. If target is "Table", ONLY show "Table"
                        // 3. Normal contains for everything else
                        return sportName.Contains(target);
                    }).ToList();
                }

                var viewModels = new List<CarouselMatchViewModel>();
                foreach (var evt in teamMatches)
                {
                    var scores = await apiService.GetAsync<ClientTeamMatchDTO>($"score/TeamMatch?eventId={evt.ID}");
                    viewModels.Add(ProcessMatchData(evt, scores ?? new List<ClientTeamMatchDTO>()));
                }
                _activeMatches = viewModels;
            }
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        finally { _isLoading = false; StateHasChanged(); }
    }

    private async Task RefreshScoresOnly()
    {
        if (_activeMatches.Count == 0) return;
        foreach (var match in _activeMatches)
        {
            try
            {
                var scores = await apiService.GetAsync<ClientTeamMatchDTO>($"score/TeamMatch?eventId={match.EventID}");
                if (scores != null)
                {
                    var updated = ProcessMatchData(match.EventData, scores);
                    match.DisplayScoreA = updated.DisplayScoreA; match.DisplayScoreB = updated.DisplayScoreB;
                    match.SetsA = updated.SetsA; match.SetsB = updated.SetsB;
                    match.PhaseText = updated.PhaseText; match.MatchHistory = updated.MatchHistory;
                    match.IsWinnerA = updated.IsWinnerA; match.IsWinnerB = updated.IsWinnerB;
                }
            }
            catch { }
        }
        StateHasChanged();
    }

    private CarouselMatchViewModel ProcessMatchData(EventModel evt, List<ClientTeamMatchDTO> scores)
    {
        var vm = new CarouselMatchViewModel
        {
            EventID = evt.ID,
            EventData = evt,
            TeamA = evt.EventVersusList![0],
            TeamB = evt.EventVersusList![1],
            IsSetGame = IsSetBasedSport(evt.Sport)
        };
        if (!scores.Any()) return vm;

        int maxPhase = scores.Max(s => s.Phase);
        vm.PhaseText = GetPhaseText(evt.Sport, maxPhase);

        for (int i = 1; i <= maxPhase; i++)
        {
            var sA = scores.FirstOrDefault(s => s.Region == vm.TeamA.Region && s.Phase == i)?.Score ?? 0;
            var sB = scores.FirstOrDefault(s => s.Region == vm.TeamB.Region && s.Phase == i)?.Score ?? 0;
            if (sA > 0 || sB > 0 || i == maxPhase) vm.MatchHistory.Add(new PhaseScoreModel { PhaseNumber = i, ScoreA = sA, ScoreB = sB });
        }

        if (vm.IsSetGame)
        {
            for (int i = 1; i < maxPhase; i++)
            {
                var sA = scores.FirstOrDefault(s => s.Region == vm.TeamA.Region && s.Phase == i)?.Score ?? 0;
                var sB = scores.FirstOrDefault(s => s.Region == vm.TeamB.Region && s.Phase == i)?.Score ?? 0;
                if (sA > sB) vm.SetsA++; else if (sB > sA) vm.SetsB++;
            }
            vm.DisplayScoreA = scores.FirstOrDefault(s => s.Region == vm.TeamA.Region && s.Phase == maxPhase)?.Score ?? 0;
            vm.DisplayScoreB = scores.FirstOrDefault(s => s.Region == vm.TeamB.Region && s.Phase == maxPhase)?.Score ?? 0;
        }
        else
        {
            vm.DisplayScoreA = scores.Where(s => s.Region == vm.TeamA.Region).Sum(s => s.Score);
            vm.DisplayScoreB = scores.Where(s => s.Region == vm.TeamB.Region).Sum(s => s.Score);
        }
        vm.IsWinnerA = vm.DisplayScoreA > vm.DisplayScoreB; vm.IsWinnerB = vm.DisplayScoreB > vm.DisplayScoreA;
        return vm;
    }

    /* ================= HELPERS (DISPLAY & ICONS) ================= */
    private bool IsAllowedTeamSport(string? sport)
    {
        if (string.IsNullOrEmpty(sport)) return false;
        var s = sport.ToLower();
        // Explicitly include both Tennis types + other team sports
        return s.Contains("basket") || s.Contains("volley") || s.Contains("badminton") ||
               s.Contains("sepak") || s.Contains("futsal") || s.Contains("ball") ||
               s.Contains("tennis") || s.Contains("pong");
    }

    private bool IsSetBasedSport(string? s) => !string.IsNullOrEmpty(s) && (s.ToLower().Contains("volley") || s.ToLower().Contains("tennis") || s.ToLower().Contains("badminton") || s.ToLower().Contains("sepak") || s.ToLower().Contains("pong"));

    private string GetPhaseText(string? s, int p)
    {
        if ((s ?? "").ToLower().Contains("basket")) return p <= 4 ? $"Q{p}" : "OT";
        if ((s ?? "").ToLower().Contains("base")) return $"INN {p}";
        return $"SET {p}";
    }

    private string GetTableColumnHeader(string? s, int p) => (s ?? "").ToLower().Contains("basket") ? (p <= 4 ? $"Q{p}" : "OT") : $"{p}";
    private string GetSchoolLevel(string? s) => (s ?? "").ToUpper().Contains("ELEM") ? "ELEMENTARY" : "SECONDARY";

    // CLEAN DISPLAY NAME
    private string GetCleanSportName(string? s)
    {
        if (string.IsNullOrEmpty(s)) return "";
        string lower = s.ToLower();
        // Override logic para klaro sa TV
        if (lower.Contains("table") || lower.Contains("pong")) return "TABLE TENNIS";
        if (lower.Contains("tennis")) return "LAWN TENNIS"; // Separated!

        return s.Replace("(Elementary)", "").Replace("(Secondary)", "").Replace("Boys", "").Replace("Girls", "").Trim().ToUpper();
    }

    // DYNAMIC ICONS
    private string GetSportIcon(string? s)
    {
        if (string.IsNullOrEmpty(s)) return Icons.Material.Filled.Sports;
        string lower = s.ToLower();
        if (lower.Contains("basket")) return Icons.Material.Filled.SportsBasketball;
        if (lower.Contains("volley")) return Icons.Material.Filled.SportsVolleyball;
        if (lower.Contains("soccer") || lower.Contains("futsal") || lower.Contains("foot")) return Icons.Material.Filled.SportsSoccer;
        if (lower.Contains("base") || lower.Contains("soft")) return Icons.Material.Filled.SportsBaseball;
        if (lower.Contains("table") || lower.Contains("pong")) return Icons.Material.Filled.SportsTennis; // Use generic tennis icon for Table
        if (lower.Contains("tennis")) return Icons.Material.Filled.SportsBaseball; // Lawn Tennis often uses ball icon if tennis racket not avail
        if (lower.Contains("badminton")) return Icons.Material.Filled.SportsTennis;
        return Icons.Material.Filled.SportsScore;
    }

    public void Dispose() => _timer?.Dispose();
}