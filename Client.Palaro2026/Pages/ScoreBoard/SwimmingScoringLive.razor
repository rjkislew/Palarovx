@page "/scoreboard/swimming/{EventID}"
@using System.Linq
@using Client.Palaro2026.Services
@layout NoMainLayout
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Swimming Event Details | PALARO 2026</PageTitle>

@if (_isLoading)
{
    <MudStack AlignItems="AlignItems.Center" Class="mt-16">
        <MudProgressCircular Indeterminate="true" Color="Color.Info" Size="Size.Large" />
        <MudText Class="mt-4" Style="color: #00e5ff;">Loading Event Details...</MudText>
    </MudStack>
}
else if (_eventInfo == null)
{
    <MudStack AlignItems="AlignItems.Center" Class="mt-16">
        <MudIcon Icon="@Icons.Material.Filled.Pool" Size="Size.Large" Color="Color.Secondary" />
        <MudText Typo="Typo.h6" Class="mt-4">Event Not Found</MudText>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                  
                   StartIcon="@Icons.Material.Filled.ArrowBack" Class="mt-4">
            Back to Swimming Events
        </MudButton>
    </MudStack>
}
else
{
    <style>
        /* --- IMPORTS --- */
        @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&display=swap');

        :root {
            --bg-dark: #0a0a0a;
            --card-bg: rgba(30, 30, 30, 0.8);
            --card-border: rgba(0, 229, 255, 0.2);
            --accent-gold: #FFD700;
            --accent-silver: #C0C0C0;
            --accent-bronze: #CD7F32;
            --accent-blue: #00e5ff;
            --accent-teal: #00ffcc;
            --accent-aqua: #00e5ff;
            --accent-red: #ff1744;
            --accent-green: #00ff88;
            --text-white: #ffffff;
            --swim-blue: #0066cc;
            --pool-lane: rgba(0, 229, 255, 0.1);
            --medal-gold: linear-gradient(135deg, #FFD700 0%, #FFAA00 100%);
            --medal-silver: linear-gradient(135deg, #C0C0C0 0%, #A0A0A0 100%);
            --medal-bronze: linear-gradient(135deg, #CD7F32 0%, #A65C00 100%);
        }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 102, 204, 0.1) 0%, transparent 25%),
                radial-gradient(circle at 90% 80%, rgba(0, 255, 204, 0.1) 0%, transparent 25%);
            font-family: 'Rajdhani', sans-serif;
            color: white;
            min-height: 100vh;
        }

        /* HEADER SECTION */
        .event-header {
            background: linear-gradient(135deg, rgba(0,0,0,0.7) 0%, rgba(0,102,204,0.5) 100%);
            padding: 30px 20px;
            border-bottom: 2px solid rgba(0, 229, 255, 0.3);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .event-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2300e5ff' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.3;
        }

        .event-title {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 2.5rem;
            background: linear-gradient(180deg, var(--accent-aqua) 0%, var(--swim-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .event-subtitle {
            font-size: 1.1rem;
            color: #aaa;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .event-badge {
            background: var(--accent-red);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: pulse 2s infinite;
            display: inline-block;
        }

        .event-badge.completed {
            background: var(--accent-green);
            animation: none;
        }

        /* POOL VISUALIZATION */
        .pool-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(0, 229, 255, 0.2);
        }

        .pool-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-aqua);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pool-lanes-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pool-lane-item {
            display: flex;
            align-items: center;
            background: rgba(0, 229, 255, 0.08);
            border-radius: 8px;
            padding: 12px 15px;
            transition: all 0.3s ease;
            border-left: 4px solid var(--accent-teal);
        }

        .pool-lane-item:hover {
            background: rgba(0, 229, 255, 0.15);
            transform: translateX(5px);
        }

        .lane-number {
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            color: var(--accent-teal);
            width: 40px;
            text-align: center;
            font-size: 1.1rem;
        }

        .lane-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .lane-swimmer {
            font-weight: 700;
            font-size: 1rem;
            color: white;
        }

        .lane-region {
            font-size: 0.85rem;
            color: var(--accent-aqua);
        }

        .lane-time {
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--accent-green);
            min-width: 100px;
            text-align: right;
        }

        /* MEDAL WINNERS */
        .medals-section {
            margin: 30px 0;
        }

        .medals-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-aqua);
            margin-bottom: 20px;
            text-align: center;
        }

        .medals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .medal-card {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .medal-card:hover {
            transform: translateY(-5px);
        }

        .medal-card.gold {
            border-color: #FFD700;
            background: linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
        }

        .medal-card.silver {
            border-color: #C0C0C0;
            background: linear-gradient(135deg, rgba(192,192,192,0.1) 0%, rgba(0,0,0,0.3) 100%);
        }

        .medal-card.bronze {
            border-color: #CD7F32;
            background: linear-gradient(135deg, rgba(205,127,50,0.1) 0%, rgba(0,0,0,0.3) 100%);
        }

        .medal-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: bold;
        }

        .medal-icon.gold {
            background: var(--medal-gold);
            color: #000;
        }

        .medal-icon.silver {
            background: var(--medal-silver);
            color: #000;
        }

        .medal-icon.bronze {
            background: var(--medal-bronze);
            color: #000;
        }

        .medal-winner {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .medal-region {
            font-size: 1rem;
            color: var(--accent-aqua);
            margin-bottom: 10px;
        }

        .medal-time {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-green);
            font-weight: bold;
        }

        /* FULL RESULTS TABLE */
        .results-section {
            margin: 30px 0;
        }

        .results-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-aqua);
            margin-bottom: 20px;
        }

        .results-table {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(0, 229, 255, 0.2);
        }

        .table-header {
            background: linear-gradient(90deg, rgba(0,102,204,0.3) 0%, rgba(0,229,255,0.2) 100%);
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 80px 1fr 150px 120px;
            gap: 15px;
            font-weight: bold;
            color: var(--accent-aqua);
            border-bottom: 1px solid rgba(0, 229, 255, 0.2);
        }

        .table-row {
            padding: 12px 20px;
            display: grid;
            grid-template-columns: 80px 1fr 150px 120px;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }

        .table-row:hover {
            background: rgba(0, 229, 255, 0.08);
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .rank-cell {
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .swimmer-cell {
            font-weight: 600;
        }

        .region-cell {
            color: var(--accent-aqua);
            font-size: 0.9rem;
        }

        .time-cell {
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            color: var(--accent-green);
            text-align: right;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: rgba(0, 229, 255, 0.2);
        }

        /* BACK BUTTON */
        .back-section {
            margin: 30px 0;
            text-align: center;
        }

        @@keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* RESPONSIVE DESIGN */
        @@media (max-width: 768px) {
            .event-title {
                font-size: 1.8rem;
            }

            .event-subtitle {
                flex-direction: column;
                gap: 8px;
            }

            .table-header,
            .table-row {
                grid-template-columns: 60px 1fr 100px;
                padding: 10px 15px;
            }

            .region-cell {
                display: none;
            }

            .medals-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <MudContainer MaxWidth="MaxWidth.Large" Class="pb-16">

        <!-- EVENT HEADER -->
        <div class="event-header">
            <div class="event-title">@_eventInfo.Subcategory</div>
            <div class="event-subtitle">
                <span><MudIcon Icon="@Icons.Material.Filled.Pool" Size="Size.Small" /> SWIMMING</span>
                <span><MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" /> @_eventInfo.Gender</span>
                <span><MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Small" /> @_eventInfo.Level</span>
                @if (_eventInfo.Date.HasValue)
                {
                    <span><MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" /> @_eventInfo.Date.Value.ToString("MMMM dd, yyyy")</span>
                }
                @if (!string.IsNullOrEmpty(_eventInfo.Time))
                {
                    <span><MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" /> @_eventInfo.Time</span>
                }
            </div>
            <div class="mt-3">
                @if (_eventInfo.EventStage?.ToLower() != "completed")
                {
                    <span class="event-badge">LIVE - @_eventInfo.EventStage</span>
                }
                else
                {
                    <span class="event-badge completed">COMPLETED</span>
                }
            </div>
        </div>

        <!-- POOL VISUALIZATION -->
        @if (_hasHeats)
        {
            <div class="pool-container">
                <div class="pool-title">
                    <MudIcon Icon="@Icons.Material.Filled.Waves" />
                    Pool Lanes & Heats
                </div>
                <div class="pool-lanes-grid">
               
                </div>
            </div>
        }

        <!-- MEDAL WINNERS -->
        @if (_medalWinners.Any())
        {
            <div class="medals-section">
                <div class="medals-title">MEDAL WINNERS</div>
                <div class="medals-grid">
                    <!-- GOLD MEDAL -->
                    @if (_medalWinners.Count >= 1)
                    {
                        var gold = _medalWinners[0];
                        <div class="medal-card gold">
                            <div class="medal-icon gold">1st</div>
                            <div class="medal-winner">@gold.PlayerName</div>
                            <div class="medal-region">@gold.RegionName</div>
                            <div class="medal-time">@FormatTimeDisplay(gold.Result)</div>
                        </div>
                    }

                    <!-- SILVER MEDAL -->
                    @if (_medalWinners.Count >= 2)
                    {
                        var silver = _medalWinners[1];
                        <div class="medal-card silver">
                            <div class="medal-icon silver">2nd</div>
                            <div class="medal-winner">@silver.PlayerName</div>
                            <div class="medal-region">@silver.RegionName</div>
                            <div class="medal-time">@FormatTimeDisplay(silver.Result)</div>
                        </div>
                    }

                    <!-- BRONZE MEDAL -->
                    @if (_medalWinners.Count >= 3)
                    {
                        var bronze = _medalWinners[2];
                        <div class="medal-card bronze">
                            <div class="medal-icon bronze">3rd</div>
                            <div class="medal-winner">@bronze.PlayerName</div>
                            <div class="medal-region">@bronze.RegionName</div>
                            <div class="medal-time">@FormatTimeDisplay(bronze.Result)</div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- FULL RESULTS TABLE -->
        <div class="results-section">
            <div class="results-title">FULL RESULTS</div>
            
            @if (_allRankings.Any())
            {
                <div class="results-table">
                    <div class="table-header">
                        <div>RANK</div>
                        <div>SWIMMER</div>
                        <div>REGION</div>
                        <div>TIME</div>
                    </div>
                    
                    @foreach (var result in _allRankings)
                    {
                        <div class="table-row">
                            <div class="rank-cell @GetRankClass(result.Rank)">#@result.Rank</div>
                            <div class="swimmer-cell">@result.PlayerName</div>
                            <div class="region-cell">@result.RegionName</div>
                            <div class="time-cell">@FormatTimeDisplay(result.Result)</div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <MudIcon Icon="@Icons.Material.Filled.TimerOff" Class="empty-state-icon" />
                    <MudText Typo="Typo.h6">No Results Yet</MudText>
                    <MudText Typo="Typo.body2" Class="mt-2">Results will appear here once the event starts</MudText>
                </div>
            }
        </div>

        <!-- EVENT STATISTICS -->
        @if (_allRankings.Any())
        {
            <MudGrid Spacing="3" Class="mt-6">
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4 text-center" Style="background: rgba(0,102,204,0.2);">
                        <MudText Typo="Typo.h6" Style="color: var(--accent-aqua);">Total Swimmers</MudText>
                        <MudText Typo="Typo.h4" Style="color: white; font-weight: bold;">@_participantCount</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4 text-center" Style="background: rgba(0,229,255,0.2);">
                        <MudText Typo="Typo.h6" Style="color: var(--accent-aqua);">Heats</MudText>
                        <MudText Typo="Typo.h4" Style="color: white; font-weight: bold;">@_eventHeats.Count</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4 text-center" Style="background: rgba(0,255,204,0.2);">
                        <MudText Typo="Typo.h6" Style="color: var(--accent-aqua);">Fastest Time</MudText>
                        <MudText Typo="Typo.h4" Style="color: var(--accent-green); font-weight: bold;">
                            @(_allRankings.Any() ? FormatTimeDisplay(_allRankings[0].Result) : "--:--")
                        </MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4 text-center" Style="background: rgba(255,215,0,0.2);">
                        <MudText Typo="Typo.h6" Style="color: #FFD700;">Average Time</MudText>
                        <MudText Typo="Typo.h4" Style="color: white; font-weight: bold;">
                            @(_allRankings.Any() ? FormatTimeDisplay(GetAverageTime().ToString()) : "--:--")
                        </MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }

        <!-- BACK BUTTON -->
        <div class="back-section">
            <MudButton Variant="Variant.Outlined" Color="Color.Info" 
                      
                       StartIcon="@Icons.Material.Filled.ArrowBack" Size="Size.Large">
                Back to All Swimming Events
            </MudButton>
        </div>

    </MudContainer>
}
@code {
    [Parameter] public string EventID { get; set; } = "";

    // --- VARIABLES ---
    private EventInfo? _eventInfo;
    private List<HeatLaneDisplay> _eventHeats = new();
    private List<RankingResult> _allRankings = new();
    private List<RankingResult> _medalWinners = new();
    private int _participantCount = 0;
    private bool _isLoading = true;
    private bool _hasHeats = false;
    private System.Threading.Timer? _timer;

    // --- LIFECYCLE ---
    protected override async Task OnInitializedAsync()
    {
        await LoadEventData();
        // Auto refresh every 15 seconds for live events
        _timer = new System.Threading.Timer(async _ => await InvokeAsync(LoadEventData), null, 15000, 15000);
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadEventData();
    }

    private async Task LoadEventData()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            // Load all participants to find this event
            var participants = await apiService.GetAsync<EventInfo>("TimeDistanceEvents/Sports/AthleticsSwimming");

            if (participants != null)
            {
                // Find this specific event
                var eventParticipants = participants
                    .Where(p => p.ID == EventID && p.Sport == "Swimming")
                    .ToList();

                if (eventParticipants.Any())
                {
                    var firstParticipant = eventParticipants.First();
                    _eventInfo = new EventInfo
                    {
                        ID = firstParticipant.ID,
                        Sport = firstParticipant.Sport,
                        Subcategory = firstParticipant.Subcategory,
                        Gender = firstParticipant.Gender,
                        Level = firstParticipant.Level,
                        EventStage = firstParticipant.EventStage,
                        Date = firstParticipant.Date,
                        Time = firstParticipant.Time,
                        SportMainCat = firstParticipant.SportMainCat
                    };

                    _participantCount = eventParticipants.Count;

                    // Load saved scoring data for this event
                    await LoadSavedScoringData();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading event data: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadSavedScoringData()
    {
        try
        {
            var savedData = await apiService.GetSingleAsync<SavedScoringData>($"TimeDistanceEvents/Sports/AthleticsSwimming/{EventID}");
            
            if (savedData != null)
            {
                // Load heats information
                _eventHeats.Clear();
                if (savedData.Heats != null && savedData.Heats.Any())
                {
                    _hasHeats = true;
                    foreach (var heat in savedData.Heats.OrderBy(h => h.HeatOrder))
                    {
                        if (heat.Lanes != null)
                        {
                            foreach (var lane in heat.Lanes.OrderBy(l => l.LaneOrder))
                            {
                                _eventHeats.Add(new HeatLaneDisplay
                                {
                                    HeatName = heat.HeatName,
                                    HeatOrder = heat.HeatOrder,
                                    LaneName = lane.LaneName,
                                    LaneOrder = lane.LaneOrder,
                                    PlayerName = lane.PlayerName,
                                    RegionAbbreviation = lane.RegionAbbreviation,
                                    Result = lane.Result
                                });
                            }
                        }
                    }
                }

                // Calculate rankings
                _allRankings = CalculateRankingsFromSavedData(savedData);
                
                // Get medal winners (top 3)
                _medalWinners = _allRankings.Take(3).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading saved scoring data: {ex.Message}");
        }
    }

    private List<RankingResult> CalculateRankingsFromSavedData(SavedScoringData savedData)
    {
        var rankings = new List<RankingResult>();
        
        if (savedData.Heats == null || !savedData.Heats.Any())
            return rankings;

        var allResults = new List<(string RegionName, string PlayerName, string Result, string Lane, double NumericResult)>();

        // Collect all results from all heats
        foreach (var heat in savedData.Heats)
        {
            if (heat.Lanes == null) continue;
            
            foreach (var lane in heat.Lanes)
            {
                if (!string.IsNullOrEmpty(lane.Result) && 
                    !string.IsNullOrEmpty(lane.RegionAbbreviation) &&
                    TryParseResult(lane.Result, out double numericResult))
                {
                    allResults.Add((
                        lane.RegionAbbreviation ?? "Unknown",
                        lane.PlayerName ?? "Unknown",
                        lane.Result,
                        $"{heat.HeatName}-{lane.LaneName}",
                        numericResult
                    ));
                }
            }
        }

        if (!allResults.Any())
            return rankings;

        // Sort by time (lower is better for swimming)
        var sortedResults = allResults.OrderBy(r => r.NumericResult).ToList();

        for (int i = 0; i < sortedResults.Count; i++)
        {
            var result = sortedResults[i];
            rankings.Add(new RankingResult
            {
                RegionName = result.RegionName,
                PlayerName = result.PlayerName,
                Result = result.Result,
                AssignedLane = result.Lane,
                Rank = i + 1,
                NumericResult = result.NumericResult
            });
        }

        return rankings;
    }

    private bool TryParseResult(string result, out double numericResult)
    {
        numericResult = 0;
        
        if (string.IsNullOrEmpty(result))
            return false;

        // Try to parse as time (mm:ss.ff or ss.ff)
        if (result.Contains(":") || result.Contains("."))
        {
            if (TimeSpan.TryParse(result, out TimeSpan timeResult))
            {
                numericResult = timeResult.TotalSeconds;
                return true;
            }
        }

        // Try to parse as number
        return double.TryParse(result, out numericResult);
    }

    private string FormatTimeDisplay(string result)
    {
        if (string.IsNullOrEmpty(result)) return "--:--";
        
        // If it's already in time format, return as is
        if (result.Contains(":") || result.Contains("."))
        {
            return result;
        }
        
        // Try to format as time if it's a numeric value
        if (double.TryParse(result, out double seconds))
        {
            if (seconds > 0)
            {
                var timeSpan = TimeSpan.FromSeconds(seconds);
                if (timeSpan.TotalMinutes >= 1)
                {
                    return timeSpan.ToString(@"m\:ss\.ff");
                }
                else
                {
                    return timeSpan.ToString(@"s\.ff");
                }
            }
        }
        
        return result;
    }

    private double GetAverageTime()
    {
        if (!_allRankings.Any()) return 0;
        
        var validResults = _allRankings
            .Where(r => TryParseResult(r.Result, out _))
            .Select(r => 
            {
                TryParseResult(r.Result, out double numeric);
                return numeric;
            })
            .ToList();
            
        return validResults.Any() ? validResults.Average() : 0;
    }

    private string GetRankClass(int rank)
    {
        return rank switch
        {
            1 => "rank-1",
            2 => "rank-2",
            3 => "rank-3",
            _ => ""
        };
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }

    // --- MODELS ---
    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public DateTime? Date { get; set; }
        public string? Time { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class HeatLaneDisplay
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public string LaneName { get; set; } = "";
        public int LaneOrder { get; set; }
        public string? PlayerName { get; set; }
        public string? RegionAbbreviation { get; set; }
        public string? Result { get; set; }
    }

    public class RankingResult
    {
        public string RegionName { get; set; } = "";
        public string? PlayerName { get; set; }
        public string Result { get; set; } = "";
        public string AssignedLane { get; set; } = "";
        public int Rank { get; set; }
        public double NumericResult { get; set; }
    }

    // These classes should match your original scoring page
    public class SavedScoringData
    {
        public List<SavedHeat> Heats { get; set; } = new();
        public List<SavedAssignment> Assignments { get; set; } = new();
    }

    public class SavedHeat
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public List<SavedLane> Lanes { get; set; } = new();
    }

    public class SavedLane
    {
        public string LaneName { get; set; } = "";
        public int LaneOrder { get; set; }
        public string? Result { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
        public string? RegionAbbreviation { get; set; }
    }

    public class SavedAssignment
    {
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string RegionAbbreviation { get; set; } = "";
        public string AssignedTable { get; set; } = "";
    }
}