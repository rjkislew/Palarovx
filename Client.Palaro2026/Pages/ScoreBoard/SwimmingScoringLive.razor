@page "/scoreboard/swimming/{EventID}"
@using System.Linq
@using Client.Palaro2026.Services
@layout NoMainLayout
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Swimming Event Details | PALARO 2026</PageTitle>

<style>
    /* --- THEME IMPORTS (UNIFORM TV STYLE) --- */
    @@import url('https://fonts.cdnfonts.com/css/evil-empire');
    @@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Chakra+Petch:wght@600;700;800&display=swap');

    :root {
        /* PALARO COLOR PALETTE */
        --pal-blue: #023E8A;
        --pal-dark-blue: #001845;
        --pal-gold: #FFB400;
        --pal-red: #EA0000;
        --pal-white: #ffffff;
        /* MEDAL COLORS */
        --medal-gold: #FFB400;
        --medal-silver: #A0A0A0;
        --medal-bronze: #CD7F32;
        /* FONTS */
        --font-header: 'Evil Empire', sans-serif;
        --font-subheader: 'Chakra Petch', sans-serif;
        --font-body: 'Nunito', sans-serif;
    }

    body {
        background: radial-gradient(circle at 50% 30%, #ffffff 0%, #e0e7ff 100%);
        margin: 0;
        font-family: var(--font-body);
        overflow-x: hidden;
        min-height: 100vh;
        color: #333;
    }

    .tv-screen-bg {
        min-height: 100vh;
        width: 100vw;
        padding-bottom: 50px;
    }

    /* --- HEADER (PILL STYLE) --- */
    .dashboard-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 40px 0 30px 0;
    }

    .header-pill {
        background: var(--pal-dark-blue);
        border: 3px solid var(--pal-gold);
        padding: 20px 60px;
        border-radius: 50px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        min-width: 500px;
    }

    .main-event-title {
        font-family: var(--font-header);
        color: white;
        font-size: clamp(2rem, 3.5vw, 3rem);
        letter-spacing: 2px;
        margin: 0;
        line-height: 1;
        text-shadow: 2px 2px 0px black;
        text-transform: uppercase;
    }

    .sub-header-text {
        font-family: var(--font-subheader);
        color: var(--pal-gold);
        font-size: 1.1rem;
        letter-spacing: 3px;
        font-weight: 700;
        text-transform: uppercase;
        margin-top: 5px;
    }

    /* --- STATUS BADGE --- */
    .status-badge-container {
        display: flex;
        justify-content: center;
        margin-top: -15px;
        margin-bottom: 30px;
    }

    .status-pill {
        background: var(--pal-red);
        color: white;
        font-family: var(--font-subheader);
        font-weight: 800;
        padding: 5px 20px;
        border-radius: 20px;
        font-size: 0.9rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        text-transform: uppercase;
    }

        .status-pill.completed {
            background: #2e7d32; /* Green for finished */
        }

    /* --- TV CARD (Universal Container) --- */
    .tv-card {
        background-color: white;
        border: 1px solid #dee2e6;
        border-top: 5px solid var(--pal-blue);
        border-radius: 15px;
        padding: 20px;
        position: relative;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .section-title {
        font-family: var(--font-header);
        font-size: 1.5rem;
        color: var(--pal-dark-blue);
        border-bottom: 2px solid var(--pal-gold);
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    /* --- MEDALS SECTION --- */
    .medal-icon-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-family: var(--font-header);
        font-size: 2rem;
        color: white;
        box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }

    .gold-theme {
        border-top-color: var(--medal-gold) !important;
    }

    .gold-icon {
        background: var(--medal-gold);
    }

    .silver-theme {
        border-top-color: var(--medal-silver) !important;
    }

    .silver-icon {
        background: var(--medal-silver);
    }

    .bronze-theme {
        border-top-color: var(--medal-bronze) !important;
    }

    .bronze-icon {
        background: var(--medal-bronze);
    }

    .winner-name {
        font-family: var(--font-subheader);
        font-size: 1.3rem;
        font-weight: 800;
        color: var(--pal-dark-blue);
        margin-bottom: 5px;
        line-height: 1.1;
    }

    .winner-region {
        font-family: var(--font-body);
        color: #6c757d;
        font-weight: 700;
        font-size: 0.9rem;
        text-transform: uppercase;
    }

    .winner-time {
        margin-top: 15px;
        font-family: 'Chakra Petch', sans-serif;
        font-size: 2rem;
        font-weight: 700;
        color: var(--pal-blue);
    }

    /* --- LANE/HEAT LIST --- */
    .lane-row {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid #f1f1f1;
        transition: background 0.2s;
    }

        .lane-row:last-child {
            border-bottom: none;
        }

        .lane-row:hover {
            background-color: #f8f9fa;
        }

    .lane-num-box {
        background: var(--pal-dark-blue);
        color: var(--pal-gold);
        font-family: var(--font-subheader);
        font-weight: 700;
        width: 50px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 5px;
        margin-right: 15px;
    }

    .swimmer-info {
        flex: 1;
    }

    .swimmer-name {
        font-weight: 700;
        color: var(--pal-dark-blue);
        font-size: 1rem;
    }

    .swimmer-region {
        font-size: 0.8rem;
        color: #adb5bd;
        font-weight: 600;
        text-transform: uppercase;
    }

    .swimmer-time {
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--pal-blue);
    }

    /* --- RESULTS TABLE --- */
    .results-table-container {
        overflow-x: auto;
    }

    .tv-table {
        width: 100%;
        border-collapse: collapse;
    }

        .tv-table th {
            text-align: left;
            color: #adb5bd;
            font-family: var(--font-header);
            font-size: 1.1rem;
            padding: 10px 15px;
            border-bottom: 2px solid #f1f1f1;
            text-transform: uppercase;
        }

        .tv-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f8f9fa;
            font-weight: 600;
            color: var(--pal-dark-blue);
        }

    .rank-cell {
        font-family: var(--font-subheader);
        font-weight: 800;
        color: var(--pal-blue);
    }

    /* --- STATS CARD --- */
    .stat-box {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 1px solid #e9ecef;
    }

    .stat-label {
        font-family: var(--font-subheader);
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .stat-value {
        font-family: var(--font-header);
        font-size: 2rem;
        color: var(--pal-dark-blue);
        line-height: 1;
        margin-top: 5px;
    }

    .loading-spinner {
        color: var(--pal-blue);
    }

    .back-btn {
        font-family: var(--font-subheader);
        font-weight: 700;
        text-transform: uppercase;
    }
</style>

<div class="tv-screen-bg">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">

        @if (_isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="mt-16">
                <MudProgressCircular Indeterminate="true" Class="loading-spinner" Size="Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-4" Style="font-family:var(--font-header); color:var(--pal-blue);">LOADING EVENT...</MudText>
            </MudStack>
        }
        else if (_eventInfo == null)
        {
            <div class="dashboard-header">
                <div class="header-pill">
                    <h1 class="main-event-title">EVENT NOT FOUND</h1>
                </div>
            </div>
            <MudStack AlignItems="AlignItems.Center" Class="mt-8">
                <MudButton Href="/scoreboard/swimming" Variant="Variant.Filled" Color="Color.Primary" Class="header-pill back-btn" Style="min-width:auto; border-radius:10px;">
                    RETURN TO SCOREBOARD
                </MudButton>
            </MudStack>
        }
        else
        {
            <!-- HEADER -->
            <div class="dashboard-header">
                <div class="header-pill">
                    <h1 class="main-event-title">@_eventInfo.Subcategory</h1>
                    <div class="sub-header-text">
                        SWIMMING • @_eventInfo.Gender • @_eventInfo.Level
                    </div>
                </div>
            </div>

            <!-- STATUS PILL -->
            <div class="status-badge-container">
                @if (_eventInfo.EventStage?.ToLower() != "completed")
                {
                    <div class="status-pill">LIVE • @_eventInfo.EventStage</div>
                }
                else
                {
                    <div class="status-pill completed">OFFICIAL RESULT</div>
                }
            </div>

            <MudGrid Spacing="3">

                <!-- MEDAL WINNERS (TOP 3) -->
                @if (_medalWinners.Any())
                {
                    <MudItem xs="12">
                        <div class="section-title text-center" style="border:none; margin-bottom:10px;">PODIUM FINISHERS</div>
                    </MudItem>

                    <!-- GOLD -->
                    @if (_medalWinners.Count >= 1)
                    {
                        var gold = _medalWinners[0];
                        <MudItem xs="12" md="4">
                            <div class="tv-card gold-theme text-center">
                                <div class="medal-icon-large gold-icon">1</div>
                                <div class="winner-name">@gold.PlayerName</div>
                                <div class="winner-region">@gold.RegionName</div>
                                <div class="winner-time">@FormatTimeDisplay(gold.Result)</div>
                            </div>
                        </MudItem>
                    }

                    <!-- SILVER -->
                    @if (_medalWinners.Count >= 2)
                    {
                        var silver = _medalWinners[1];
                        <MudItem xs="12" md="4">
                            <div class="tv-card silver-theme text-center">
                                <div class="medal-icon-large silver-icon">2</div>
                                <div class="winner-name">@silver.PlayerName</div>
                                <div class="winner-region">@silver.RegionName</div>
                                <div class="winner-time">@FormatTimeDisplay(silver.Result)</div>
                            </div>
                        </MudItem>
                    }

                    <!-- BRONZE -->
                    @if (_medalWinners.Count >= 3)
                    {
                        var bronze = _medalWinners[2];
                        <MudItem xs="12" md="4">
                            <div class="tv-card bronze-theme text-center">
                                <div class="medal-icon-large bronze-icon">3</div>
                                <div class="winner-name">@bronze.PlayerName</div>
                                <div class="winner-region">@bronze.RegionName</div>
                                <div class="winner-time">@FormatTimeDisplay(bronze.Result)</div>
                            </div>
                        </MudItem>
                    }
                }

                <!-- LEFT COLUMN: HEATS / STATS -->
                <MudItem xs="12" lg="4">
                    <MudStack Spacing="3">

                        <!-- STATISTICS -->
                        <div class="tv-card" style="min-height:auto;">
                            <div class="section-title">EVENT STATS</div>
                            <MudGrid>
                                <MudItem xs="6">
                                    <div class="stat-box">
                                        <div class="stat-label">SWIMMERS</div>
                                        <div class="stat-value">@_participantCount</div>
                                    </div>
                                </MudItem>
                                <MudItem xs="6">
                                    <div class="stat-box">
                                        <div class="stat-label">HEATS</div>
                                        <div class="stat-value">@_eventHeats.Select(h => h.HeatName).Distinct().Count()</div>
                                    </div>
                                </MudItem>
                            </MudGrid>
                        </div>

                        <!-- HEATS LIST -->
                        @if (_hasHeats)
                        {
                            <div class="tv-card">
                                <div class="section-title">LANE ASSIGNMENTS</div>
                                <div style="max-height: 500px; overflow-y: auto;">
                                    @foreach (var lane in _eventHeats)
                                    {
                                        <div class="lane-row">
                                            <div class="lane-num-box">@lane.LaneOrder</div>
                                            <div class="swimmer-info">
                                                <div class="swimmer-name">@lane.PlayerName</div>
                                                <div class="swimmer-region">@lane.RegionAbbreviation • H@(lane.HeatOrder)</div>
                                            </div>
                                            <div class="swimmer-time">
                                                @(string.IsNullOrEmpty(lane.Result) ? "--:--" : FormatTimeDisplay(lane.Result))
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                    </MudStack>
                </MudItem>

                <!-- RIGHT COLUMN: FULL RANKING -->
                <MudItem xs="12" lg="8">
                    <div class="tv-card">
                        <div class="section-title">OFFICIAL RESULTS</div>

                        @if (_allRankings.Any())
                        {
                            <div class="results-table-container">
                                <table class="tv-table">
                                    <thead>
                                        <tr>
                                            <th style="width:10%;">RANK</th>
                                            <th style="width:40%;">SWIMMER</th>
                                            <th style="width:30%;">REGION</th>
                                            <th style="width:20%; text-align:right;">TIME</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var result in _allRankings)
                                        {
                                            <tr>
                                                <td class="rank-cell">#@result.Rank</td>
                                                <td>@result.PlayerName</td>
                                                <td style="color:#6c757d; font-size:0.9rem;">@result.RegionName</td>
                                                <td style="text-align:right; font-family:'Chakra Petch'; font-weight:700; font-size:1.1rem; color:var(--pal-dark-blue);">
                                                    @FormatTimeDisplay(result.Result)
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <MudStack AlignItems="AlignItems.Center" Class="py-12">
                                <MudIcon Icon="@Icons.Material.Filled.Timer" Size="Size.Large" Style="color:#dee2e6; font-size:4rem;" />
                                <MudText Class="mt-2" Style="font-family:var(--font-subheader); color:#adb5bd;">AWAITING RESULTS</MudText>
                            </MudStack>
                        }
                    </div>
                </MudItem>
            </MudGrid>

            <div class="py-8 text-center">
                <MudButton Href="/scoreboard/swimming" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack" Style="color:#6c757d; font-family:var(--font-subheader);">
                    BACK TO ALL EVENTS
                </MudButton>
            </div>
        }

    </MudContainer>
</div>

@code {
    [Parameter] public string EventID { get; set; } = "";

    // --- VARIABLES ---
    private EventInfo? _eventInfo;
    private List<HeatLaneDisplay> _eventHeats = new();
    private List<RankingResult> _allRankings = new();
    private List<RankingResult> _medalWinners = new();
    private int _participantCount = 0;
    private bool _isLoading = true;
    private bool _hasHeats = false;
    private System.Threading.Timer? _timer;

    // --- LIFECYCLE ---
    protected override async Task OnInitializedAsync()
    {
        await LoadEventData();
        _timer = new System.Threading.Timer(async _ => await InvokeAsync(LoadEventData), null, 15000, 15000);
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadEventData();
    }

    private async Task LoadEventData()
    {
        try
        {
            // _isLoading = true; // Don't show full loader on refresh to avoid flickering

            var participants = await apiService.GetAsync<EventInfo>("TimeDistanceEvents/Sports/AthleticsSwimming");

            if (participants != null)
            {
                var eventParticipants = participants
                    .Where(p => p.ID == EventID && p.Sport == "Swimming")
                    .ToList();

                if (eventParticipants.Any())
                {
                    var firstParticipant = eventParticipants.First();
                    _eventInfo = new EventInfo
                    {
                        ID = firstParticipant.ID,
                        Sport = firstParticipant.Sport,
                        Subcategory = firstParticipant.Subcategory,
                        Gender = firstParticipant.Gender,
                        Level = firstParticipant.Level,
                        EventStage = firstParticipant.EventStage,
                        Date = firstParticipant.Date,
                        Time = firstParticipant.Time,
                        SportMainCat = firstParticipant.SportMainCat
                    };

                    _participantCount = eventParticipants.Count;
                    await LoadSavedScoringData();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading event data: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadSavedScoringData()
    {
        try
        {
            var savedData = await apiService.GetSingleAsync<SavedScoringData>($"scoreboard/swimming/{EventID}");

            if (savedData != null)
            {
                _eventHeats.Clear();
                if (savedData.Heats != null && savedData.Heats.Any())
                {
                    _hasHeats = true;
                    foreach (var heat in savedData.Heats.OrderBy(h => h.HeatOrder))
                    {
                        if (heat.Lanes != null)
                        {
                            foreach (var lane in heat.Lanes.OrderBy(l => l.LaneOrder))
                            {
                                _eventHeats.Add(new HeatLaneDisplay
                                {
                                    HeatName = heat.HeatName,
                                    HeatOrder = heat.HeatOrder,
                                    LaneName = lane.LaneName,
                                    LaneOrder = lane.LaneOrder,
                                    PlayerName = lane.PlayerName,
                                    RegionAbbreviation = lane.RegionAbbreviation,
                                    Result = lane.Result
                                });
                            }
                        }
                    }
                }

                _allRankings = CalculateRankingsFromSavedData(savedData);
                _medalWinners = _allRankings.Take(3).ToList();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading saved scoring data: {ex.Message}");
        }
    }

    private List<RankingResult> CalculateRankingsFromSavedData(SavedScoringData savedData)
    {
        var rankings = new List<RankingResult>();

        if (savedData.Heats == null || !savedData.Heats.Any())
            return rankings;

        var allResults = new List<(string RegionName, string PlayerName, string Result, string Lane, double NumericResult)>();

        foreach (var heat in savedData.Heats)
        {
            if (heat.Lanes == null) continue;
            foreach (var lane in heat.Lanes)
            {
                if (!string.IsNullOrEmpty(lane.Result) &&
                    !string.IsNullOrEmpty(lane.RegionAbbreviation) &&
                    TryParseResult(lane.Result, out double numericResult))
                {
                    allResults.Add((
                        lane.RegionAbbreviation ?? "Unknown",
                        lane.PlayerName ?? "Unknown",
                        lane.Result,
                        $"{heat.HeatName}-{lane.LaneName}",
                        numericResult
                    ));
                }
            }
        }

        if (!allResults.Any()) return rankings;

        var sortedResults = allResults.OrderBy(r => r.NumericResult).ToList();

        for (int i = 0; i < sortedResults.Count; i++)
        {
            var result = sortedResults[i];
            rankings.Add(new RankingResult
            {
                RegionName = result.RegionName,
                PlayerName = result.PlayerName,
                Result = result.Result,
                AssignedLane = result.Lane,
                Rank = i + 1,
                NumericResult = result.NumericResult
            });
        }
        return rankings;
    }

    private bool TryParseResult(string result, out double numericResult)
    {
        numericResult = 0;
        if (string.IsNullOrEmpty(result)) return false;

        if (result.Contains(":") || result.Contains("."))
        {
            if (TimeSpan.TryParse(result, out TimeSpan timeResult))
            {
                numericResult = timeResult.TotalSeconds;
                return true;
            }
        }
        return double.TryParse(result, out numericResult);
    }

    private string FormatTimeDisplay(string result)
    {
        if (string.IsNullOrEmpty(result)) return "--:--";
        if (result.Contains(":") || result.Contains(".")) return result;

        if (double.TryParse(result, out double seconds))
        {
            if (seconds > 0)
            {
                var timeSpan = TimeSpan.FromSeconds(seconds);
                return timeSpan.TotalMinutes >= 1 ? timeSpan.ToString(@"m\:ss\.ff") : timeSpan.ToString(@"s\.ff");
            }
        }
        return result;
    }

    public void Dispose() => _timer?.Dispose();

    // --- MODELS ---
    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public DateTime? Date { get; set; }
        public string? Time { get; set; }
    }

    public class HeatLaneDisplay
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public string LaneName { get; set; } = "";
        public int LaneOrder { get; set; }
        public string? PlayerName { get; set; }
        public string? RegionAbbreviation { get; set; }
        public string? Result { get; set; }
    }

    public class RankingResult
    {
        public string RegionName { get; set; } = "";
        public string? PlayerName { get; set; }
        public string Result { get; set; } = "";
        public string AssignedLane { get; set; } = "";
        public int Rank { get; set; }
        public double NumericResult { get; set; }
    }

    public class SavedScoringData
    {
        public List<SavedHeat> Heats { get; set; } = new();
    }

    public class SavedHeat
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public List<SavedLane> Lanes { get; set; } = new();
    }

    public class SavedLane
    {
        public string LaneName { get; set; } = "";
        public int LaneOrder { get; set; }
        public string? Result { get; set; }
        public string? PlayerName { get; set; }
        public string? RegionAbbreviation { get; set; }
    }
}