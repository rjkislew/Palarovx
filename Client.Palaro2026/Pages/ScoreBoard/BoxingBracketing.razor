@page "/scoreboard/boxing"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>Boxing Tournament | PALARO 2026</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@600;700&display=swap');

    :root {
        --bg-dark: #121212;
        --panel-bg: rgba(20, 20, 25, 0.9);
        --accent-gold: #FFD700;
        --accent-blue: #00B0FF;
        --accent-red: #FF1744;
        --text-white: #ffffff;
        --accent-green: #4CAF50;
        --accent-purple: #9C27B0;
        --ring-red: #FF4136;
        --ring-blue: #0074D9;
    }

    body {
        background-color: black;
        overflow: hidden;
    }

    .tv-screen {
        min-height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at center, #1e1e24 0%, #000000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: 'Rajdhani', sans-serif;
        color: white;
        padding: 20px;
    }

    .tournament-header {
        text-align: center;
        margin-bottom: 2vh;
    }

    .palaro-branding {
        font-family: 'Orbitron', sans-serif;
        font-size: 2.5rem;
        color: var(--accent-gold);
        letter-spacing: 5px;
        font-weight: bold;
    }

    .sport-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 3rem;
        font-weight: 900;
        color: var(--accent-red);
        margin-bottom: 1vh;
    }

    .match-details {
        font-size: 1.5rem;
        color: #aaa;
        margin-top: 5px;
    }

    .status-badge {
        font-family: 'Orbitron', sans-serif;
        padding: 8px 30px;
        border-radius: 50px;
        font-size: 1.5rem;
        font-weight: bold;
    }

    .live {
        background: var(--accent-red);
        animation: pulse 1.5s infinite;
    }

    .final {
        background: #00C853;
    }

    .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255,255,255,0.1);
        color: white;
        border: 1px solid #333;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        z-index: 1000;
    }

        .back-button:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1
        }

        50% {
            opacity: 0.7
        }
    }

    .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        width: 95%;
        max-width: 1400px;
        margin-top: 2vh;
    }

    .event-card {
        background: var(--panel-bg);
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

        .event-card:hover {
            border-color: var(--accent-gold);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);
        }

        .event-card.active {
            border-color: var(--accent-red);
            background: rgba(255, 23, 68, 0.1);
        }

    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .event-category {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--accent-gold);
    }

    .event-status {
        font-family: 'Orbitron', sans-serif;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
    }

    .status-live {
        background: var(--accent-red);
    }

    .status-completed {
        background: var(--accent-green);
    }

    .status-upcoming {
        background: var(--accent-blue);
    }

    .event-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
    }

    .detail-label {
        color: #aaa;
        font-size: 0.9rem;
    }

    .detail-value {
        font-weight: bold;
        color: white;
        font-size: 1rem;
    }

    .bouts-count {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .view-bracket-btn {
        margin-top: 15px;
        width: 100%;
        background: rgba(255, 23, 68, 0.2);
        color: white;
        border: 1px solid var(--accent-red);
        padding: 10px;
        border-radius: 8px;
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

        .view-bracket-btn:hover {
            background: var(--accent-red);
            transform: scale(1.02);
        }

    .no-events {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px;
        color: #888;
        font-size: 1.2rem;
    }

    .loading-container {
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
    }

    .boxing-ring {
        width: 100px;
        height: 100px;
        border: 3px solid var(--accent-gold);
        border-radius: 50%;
        position: relative;
        margin-bottom: 20px;
    }

    .ring-inner {
        width: 70px;
        height: 70px;
        border: 2px solid var(--accent-red);
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .corner-red {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 20px;
        height: 20px;
        background: var(--ring-red);
        border-radius: 50%;
    }

    .corner-blue {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 20px;
        height: 20px;
        background: var(--ring-blue);
        border-radius: 50%;
    }
</style>

<div class="tv-screen">
    <button class="back-button" onclick="history.back()">← Back</button>

    <div class="tournament-header">
        <div class="palaro-branding">PALARONG PAMBANSA 2026</div>
        <div class="sport-name">BOXING TOURNAMENT</div>
        <div class="match-details">
            <div class="status-badge live">LIVE</div>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="loading-container">
            <div class="boxing-ring">
                <div class="ring-inner"></div>
                <div class="corner-red"></div>
                <div class="corner-blue"></div>
            </div>
            <MudText Typo="Typo.h6" Color="Color.Warning">Loading Boxing Events...</MudText>
        </div>
    }
    else if (!_events.Any())
    {
        <div class="no-events">
            <MudIcon Icon="@Icons.Material.Filled.SportsMma" Size="Size.Large" Color="Color.Warning" />
            <MudText Typo="Typo.h5" Class="mt-3">No Boxing Events Scheduled</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                Check back later for upcoming boxing matches
            </MudText>
        </div>
    }
    else
    {
        <div class="events-grid">
            @foreach (var evt in _events)
            {
                <div class="event-card @(evt.IsActive ? "active" : "")"
                     @onclick="@(() => NavigateToEvent(evt.Id))">

                    <div class="event-header">
                        <div class="event-category">@evt.MajorCategory</div>
                        <div class="event-status @GetStatusClass(evt.Status)">
                            @evt.Status.ToUpper()
                        </div>
                    </div>

                    <div class="event-details">
                        <div class="detail-row">
                            <span class="detail-label">Weight Class:</span>
                            <span class="detail-value">@evt.SubCategory</span>
                        </div>

                        <div class="detail-row">
                            <span class="detail-label">Division:</span>
                            <span class="detail-value">@evt.Level - @evt.Gender</span>
                        </div>

                        <div class="detail-row">
                            <span class="detail-label">Round:</span>
                            <span class="detail-value">@evt.CurrentRound</span>
                        </div>

                        <div class="detail-row">
                            <span class="detail-label">Total Bouts:</span>
                            <span class="detail-value">@evt.TotalBouts</span>
                        </div>
                    </div>

                    <div class="bouts-count">
                        <MudIcon Icon="@Icons.Material.Filled.SportsMma" Size="Size.Small" />
                        <span>@evt.CompletedBouts completed • @evt.RemainingBouts remaining</span>
                    </div>

                    <div class="view-bracket-btn" @onclick:stopPropagation>
                        VIEW BRACKET →
                    </div>
                </div>
            }
        </div>
    }

    <!-- Tournament Stats -->
    @if (!_isLoading && _events.Any())
    {
        <div style="margin-top: 30px; padding: 20px; background: var(--panel-bg); border-radius: 15px; width: 95%; max-width: 1400px;">
            <MudGrid Spacing="3">
                <MudItem xs="6" sm="3">
                    <div style="text-align: center;">
                        <MudText Typo="Typo.h3" Color="Color.Primary" Class="mb-1">@_totalEvents</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Total Events</MudText>
                    </div>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <div style="text-align: center;">
                        <MudText Typo="Typo.h3" Color="Color.Success" Class="mb-1">@_totalCompletedBouts</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Completed Bouts</MudText>
                    </div>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <div style="text-align: center;">
                        <MudText Typo="Typo.h3" Color="Color.Warning" Class="mb-1">@_totalActiveBouts</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Active Bouts</MudText>
                    </div>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <div style="text-align: center;">
                        <MudText Typo="Typo.h3" Color="Color.Info" Class="mb-1">@_totalRegions</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Regions Competing</MudText>
                    </div>
                </MudItem>
            </MudGrid>
        </div>
    }
</div>

@code {
    private List<BoxingEvent> _events = new();
    private bool _isLoading = true;
    private Timer? _timer;

    private int _totalEvents = 0;
    private int _totalCompletedBouts = 0;
    private int _totalActiveBouts = 0;
    private int _totalRegions = 0;

    public class BoxingEvent
    {
        public string Id { get; set; } = "";
        public string MajorCategory { get; set; } = "";
        public string SubCategory { get; set; } = "";
        public string Level { get; set; } = "";
        public string Gender { get; set; } = "";
        public string CurrentRound { get; set; } = "";
        public string Status { get; set; } = "Upcoming";
        public int TotalBouts { get; set; }
        public int CompletedBouts { get; set; }
        public int RemainingBouts { get; set; }
        public DateTime? LastUpdated { get; set; }
        public bool IsActive { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _timer = new Timer(async _ => await InvokeAsync(LoadData), null, 5000, 5000);
    }

    private async Task LoadData()
    {
        try
        {
            // Load events data from API
            var events = await apiService.GetAsync<EventDrawOfMatchDTO>("/score/BoxingBout/list_match");

            if (events != null && events.Any())
            {
                // Group events by category
                var groupedEvents = events
                    .GroupBy(e => new { e.MajorCategories_Id, e.Categories_Id })
                    .Select(g =>
                    {
                        var firstEvent = g.First();
                        var participants = g.SelectMany(e => e.Participants ?? new List<EventDrawOfMatchParticipantsDTO>()).ToList();

                        return new BoxingEvent
                        {
                            Id = $"{firstEvent.MajorCategories_Id}_{firstEvent.Categories_Id}",
                            MajorCategory = firstEvent.MajorCategory,
                            SubCategory = firstEvent.SubCategory,
                            Level = GetLevelFromCategory(firstEvent.MajorCategory),
                            Gender = GetGenderFromCategory(firstEvent.SubCategory),
                            CurrentRound = GetCurrentRound(g.ToList()),
                            TotalBouts = g.Count(),
                            CompletedBouts = 0, // You'll need to implement this based on your data
                            RemainingBouts = g.Count(), // You'll need to implement this based on your data
                            Status = GetEventStatus(g.ToList()),
                            LastUpdated = DateTime.Now,
                            IsActive = IsEventActive(g.ToList())
                        };
                    })
                    .ToList();

                _events = groupedEvents;

                // Calculate totals
                _totalEvents = _events.Count;
                _totalCompletedBouts = _events.Sum(e => e.CompletedBouts);
                _totalActiveBouts = _events.Sum(e => e.RemainingBouts);
                _totalRegions = CalculateUniqueRegions(events);
            }
            else
            {
                _events = new List<BoxingEvent>();
            }

            _isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading boxing data: {ex.Message}");
            _isLoading = false;
        }
    }

    private string GetLevelFromCategory(string category)
    {
        // Extract level from category name
        if (category.Contains("Elementary")) return "Elementary";
        if (category.Contains("Secondary")) return "Secondary";
        if (category.Contains("High School")) return "High School";
        return "Open";
    }

    private string GetGenderFromCategory(string subCategory)
    {
        // Extract gender from subcategory
        if (subCategory.ToLower().Contains("boys")) return "Boys";
        if (subCategory.ToLower().Contains("girls")) return "Girls";
        return "Mixed";
    }

    private string GetCurrentRound(List<EventDrawOfMatchDTO> matches)
    {
        if (!matches.Any()) return "Not Started";

        // Get the highest round from matches
        var rounds = matches.Select(m => m.Round_Name).Distinct().ToList();
        if (rounds.Contains("Finals")) return "Finals";
        if (rounds.Contains("Semi-Finals")) return "Semi-Finals";
        if (rounds.Contains("Quarter-Finals")) return "Quarter-Finals";
        if (rounds.Contains("Preliminary")) return "Preliminary";

        return rounds.FirstOrDefault() ?? "Not Started";
    }

    private string GetEventStatus(List<EventDrawOfMatchDTO> matches)
    {
        if (!matches.Any()) return "Upcoming";

        var hasCompleted = matches.Any(m =>
            m.Participants?.Any(p => !string.IsNullOrEmpty(p.Region_Abbr)) == true);
        var hasScheduled = matches.Any();

        if (hasCompleted) return "Live";
        if (hasScheduled) return "Scheduled";
        return "Upcoming";
    }

    private bool IsEventActive(List<EventDrawOfMatchDTO> matches)
    {
        // An event is active if it has matches in progress or recent activity
        return matches.Any(m =>
            m.Schedule.Date == DateTime.Today ||
            m.Schedule > DateTime.Now.AddHours(-2));
    }

    private int CalculateUniqueRegions(List<EventDrawOfMatchDTO> events)
    {
        var regions = events
            .SelectMany(e => e.Participants ?? new List<EventDrawOfMatchParticipantsDTO>())
            .Select(p => p.Region_Abbr)
            .Where(r => !string.IsNullOrEmpty(r))
            .Distinct()
            .Count();

        return regions;
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "live" => "status-live",
            "completed" => "status-completed",
            "scheduled" => "status-upcoming",
            _ => "status-upcoming"
        };
    }

    private void NavigateToEvent(string eventId)
    {
        Navigation.NavigateTo($"/scoreboard/boxing/{eventId}");
    }

    public void Dispose() => _timer?.Dispose();



    // DTO classes
    public class MajorCategoriesDTO
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    public class CategoriesDTO
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public int LevelId { get; set; }
    }

    public class RoundsDTO
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Abbreviation { get; set; } = string.Empty;
    }

    // API DTO classes
    public class EventDrawOfMatchDTO
    {
        public int Id { get; set; }
        public int Sport_Id { get; set; }
        public int MajorCategories_Id { get; set; }
        public string MajorCategory { get; set; } = string.Empty;
        public int Categories_Id { get; set; }
        public string SubCategory { get; set; } = string.Empty;
        public int Bout_Id { get; set; }
        public int Round_Id { get; set; }
        public string Round_Name { get; set; } = string.Empty;
        public int Arena_Id { get; set; }
        public string Arena_Name { get; set; } = string.Empty;
        public DateTime Schedule { get; set; }
        public string User_Id { get; set; } = string.Empty;
        public DateTime Datentime { get; set; }
        public List<EventDrawOfMatchParticipantsDTO> Participants { get; set; } = new();
    }

    public class EventDrawOfMatchParticipantsDTO
    {
        public int Id { get; set; }
        public int Match_Id { get; set; }
        public int Side_Id { get; set; }
        public string Side_Name { get; set; } = string.Empty;
        public int Region_Id { get; set; }
        public string Participant_Id { get; set; } = string.Empty;
        public string Participant_Name { get; set; } = string.Empty;
        public string Region_Name { get; set; } = string.Empty;
        public string Region_Abbr { get; set; } = string.Empty;
        public string Coach_Name { get; set; } = string.Empty;
    }

    // Updated BoxingBoutDto with all required properties
    // Updated BoxingBoutDto with all required properties including region IDs
    public class BoxingBoutDto
    {
        public int Id { get; set; }
        public int Number { get; set; }
        public string Round { get; set; } = string.Empty;
        public string Round_Name { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string MajorCategory { get; set; } = string.Empty;
        public string SubCategory { get; set; } = string.Empty;
        public string Arena_Name { get; set; } = string.Empty;
        public DateTime? Schedule { get; set; }
        public string RedCornerRegion { get; set; } = string.Empty;
        public string RedCornerName { get; set; } = string.Empty;
        public string RedCornerCoach { get; set; } = string.Empty;
        public int RedRegionId { get; set; } // Add this property
        public string BlueCornerRegion { get; set; } = string.Empty;
        public string BlueCornerName { get; set; } = string.Empty;
        public string BlueCornerCoach { get; set; } = string.Empty;
        public int BlueRegionId { get; set; } // Add this property
        public string WinnerRegion { get; set; } = string.Empty;
        public string VictoryType { get; set; } = string.Empty;
        public string Referee { get; set; } = string.Empty;
        public string Notes { get; set; } = string.Empty;
    }


    public class UpdateBoxingBoutDto
    {
        public string Status { get; set; } = string.Empty;
        public string Arena { get; set; } = string.Empty;
        public string Referee { get; set; } = string.Empty;
        public DateTime? Schedule { get; set; }
        public string Notes { get; set; } = string.Empty;
    }
}