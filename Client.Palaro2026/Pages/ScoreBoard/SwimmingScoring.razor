@page "/scoreboard/swimming"
@using System.Linq
@using Client.Palaro2026.Services
@layout NoMainLayout
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Swimming Events Scoreboard | PALARO 2026</PageTitle>

<style>
    /* --- IMPORTS --- */
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&display=swap');

    :root {
        --bg-dark: #0a0a0a;
        --card-bg: rgba(30, 30, 30, 0.7);
        --card-border: rgba(255, 255, 255, 0.1);
        --accent-gold: #FFD700;
        --accent-blue: #00e5ff;
        --accent-teal: #00ffcc;
        --accent-aqua: #00e5ff;
        --accent-red: #ff1744;
        --accent-green: #00ff88;
        --text-white: #ffffff;
        --swim-blue: #0066cc;
        --pool-lane: rgba(0, 229, 255, 0.1);
    }

    body {
        background-color: var(--bg-dark);
        background-image: radial-gradient(circle at 15% 50%, rgba(0, 102, 204, 0.05) 0%, transparent 25%), radial-gradient(circle at 85% 30%, rgba(0, 255, 204, 0.05) 0%, transparent 25%);
        font-family: 'Rajdhani', sans-serif;
        color: white;
        min-height: 100vh;
    }

    .scoreboard-header {
        text-align: center;
        padding: 40px 0 20px;
    }

    .main-title {
        font-family: 'Orbitron', sans-serif;
        font-weight: 900;
        font-size: 3rem;
        background: linear-gradient(180deg, var(--accent-aqua) 0%, var(--swim-blue) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: 4px;
        margin-bottom: 5px;
    }

    /* MODERN CARD FOR SWIMMING EVENTS */
    .modern-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        height: 550px;
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
    }

        .modern-card:hover {
            border-color: var(--accent-aqua);
            box-shadow: 0 10px 30px rgba(0, 229, 255, 0.3);
            transform: translateY(-2px);
        }

    /* SWIMMING HEADER STYLING */
    .card-header {
        padding: 15px 20px;
        background: linear-gradient(90deg, rgba(0,0,0,0.4) 0%, rgba(0,102,204,0.4) 100%);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        flex-shrink: 0;
    }

    .event-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--accent-aqua);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .event-details {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: #aaa;
        margin-top: 5px;
    }

    .event-detail-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* POOL VISUALIZATION */
    .pool-visual {
        padding: 15px;
        background: rgba(0,0,0,0.2);
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .pool-lanes {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 10px;
    }

    .pool-lane {
        display: flex;
        align-items: center;
        background: var(--pool-lane);
        border-radius: 8px;
        padding: 8px 12px;
        border-left: 4px solid var(--accent-teal);
        transition: all 0.3s ease;
    }

        .pool-lane:hover {
            background: rgba(0, 255, 204, 0.15);
            transform: translateX(5px);
        }

    .lane-number {
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
        color: var(--accent-teal);
        width: 30px;
        text-align: center;
    }

    .lane-region {
        flex-grow: 1;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .lane-time {
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
        color: var(--accent-green);
        text-align: right;
        min-width: 80px;
    }

    /* SCROLLABLE RESULTS LIST */
    .results-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
    }

        .results-container::-webkit-scrollbar {
            width: 6px;
        }

        .results-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }

        .results-container::-webkit-scrollbar-thumb {
            background: var(--accent-aqua);
            border-radius: 3px;
        }

    .result-row {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
    }

        .result-row:hover {
            background: rgba(255,255,255,0.05);
            transform: translateX(3px);
        }

    .result-rank {
        width: 40px;
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
        font-size: 1.1rem;
        text-align: center;
    }

    .rank-1 {
        color: #FFD700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .rank-2 {
        color: #C0C0C0;
    }

    .rank-3 {
        color: #CD7F32;
    }

    .result-info {
        flex-grow: 1;
        padding: 0 15px;
    }

    .result-player {
        font-weight: 700;
        font-size: 1rem;
        display: block;
    }

    .result-region {
        font-size: 0.8rem;
        color: var(--accent-aqua);
        margin-top: 2px;
    }

    .result-time {
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
        font-size: 1.1rem;
        color: var(--accent-green);
        min-width: 100px;
        text-align: right;
    }

    .result-lane {
        background: rgba(0, 229, 255, 0.15);
        color: var(--accent-aqua);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 10px;
    }

    /* FOOTER BUTTON */
    .card-footer {
        padding: 15px;
        background: rgba(0,0,0,0.3);
        border-top: 1px solid rgba(255,255,255,0.05);
        flex-shrink: 0;
    }

    .tv-btn {
        display: block;
        width: 100%;
        padding: 12px;
        background: linear-gradient(90deg, rgba(0,229,255,0.1) 0%, rgba(0,102,204,0.1) 100%);
        color: white;
        text-align: center;
        text-decoration: none;
        border-radius: 8px;
        font-family: 'Orbitron';
        font-size: 0.9rem;
        font-weight: bold;
        letter-spacing: 1px;
        transition: all 0.2s;
        border: 1px solid rgba(0, 229, 255, 0.2);
    }

        .tv-btn:hover {
            background: linear-gradient(90deg, var(--accent-aqua) 0%, var(--swim-blue) 100%);
            color: black;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.4);
            transform: translateY(-1px);
        }

    /* BADGES */
    .badge-live {
        background: var(--accent-red);
        color: white;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        float: right;
        animation: pulse 1.5s infinite;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .badge-final {
        background: var(--accent-green);
        color: black;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        float: right;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .badge-heat {
        background: rgba(0, 255, 204, 0.2);
        color: var(--accent-teal);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: bold;
        margin-left: 10px;
        border: 1px solid rgba(0, 255, 204, 0.3);
    }

    .swim-stroke {
        background: rgba(0, 102, 204, 0.2);
        color: var(--accent-blue);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: bold;
        margin-left: 10px;
        border: 1px solid rgba(0, 102, 204, 0.3);
    }

    @@keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.6;
        }

        100% {
            opacity: 1;
        }
    }

    /* TIME FORMAT STYLING */
    .time-result {
        font-variant-numeric: tabular-nums;
    }

    /* EMPTY STATE */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 40px;
        text-align: center;
        color: #666;
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        color: var(--pool-lane);
    }

    /* SWIM STROKE ICONS */
    .stroke-icon-backstroke {
        transform: rotate(180deg);
    }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pb-16">

    <div class="scoreboard-header">
        <div class="main-title">SWIMMING EVENTS</div>
        <MudText Typo="Typo.h6" Style="color: #aaa; letter-spacing: 2px;">OFFICIAL TIMING & RESULTS</MudText>
    </div>

    @if (_isLoading)
    {
        <MudStack AlignItems="AlignItems.Center" Class="mt-16">
            <MudProgressCircular Indeterminate="true" Color="Color.Info" Size="Size.Large" />
            <MudText Class="mt-4" Style="color: var(--accent-aqua)">Loading Swimming Events...</MudText>
        </MudStack>
    }
    else
    {
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" Centered="true" Color="Color.Dark" Class="mt-4">
            <!-- ALL SWIMMING EVENTS -->
            <MudTabPanel Text="ALL EVENTS" Icon="@Icons.Material.Filled.List">
                <MudGrid Class="mt-4" Spacing="3">
                    @if (!_allEvents.Any())
                    {
                        <MudItem xs="12">
                            <div class="empty-state">
                                <MudIcon Icon="@Icons.Material.Filled.Pool" Class="empty-state-icon" />
                                <MudText>No swimming events scheduled</MudText>
                            </div>
                        </MudItem>
                    }
                    else
                    {
                        @foreach (var evt in _allEvents)
                        {
                            <MudItem xs="12" sm="6" md="4" lg="3">
                                @RenderEventCard(evt)
                            </MudItem>
                        }
                    }
                </MudGrid>
            </MudTabPanel>

            <!-- FREESTYLE -->
            <MudTabPanel Text="FREESTYLE" Icon="@Icons.Material.Filled.Waves">
                <MudGrid Class="mt-4" Spacing="3">
                    @{
                        var freestyleEvents = _allEvents.Where(e =>
                        e.Subcategory?.ToLower().Contains("freestyle") == true).ToList();
                    }

                    @if (!freestyleEvents.Any())
                    {
                        <MudItem xs="12">
                            <div class="empty-state">
                                <MudIcon Icon="@Icons.Material.Filled.Waves" Class="empty-state-icon" />
                                <MudText>No freestyle events scheduled</MudText>
                            </div>
                        </MudItem>
                    }
                    else
                    {
                        @foreach (var evt in freestyleEvents)
                        {
                            <MudItem xs="12" sm="6" md="4" lg="3">
                                @RenderEventCard(evt)
                            </MudItem>
                        }
                    }
                </MudGrid>
            </MudTabPanel>

            <!-- BACKSTROKE -->
            <MudTabPanel Text="BACKSTROKE" Icon="@Icons.Material.Filled.Waves">
                <MudGrid Class="mt-4" Spacing="3">
                    @{
                        var backstrokeEvents = _allEvents.Where(e =>
                        e.Subcategory?.ToLower().Contains("backstroke") == true ||
                        e.SportMainCat?.ToLower() == "backstroke").ToList();
                    }

                    @if (!backstrokeEvents.Any())
                    {
                        <MudItem xs="12">
                            <div class="empty-state">
                                <MudIcon Icon="@Icons.Material.Filled.Waves" Class="stroke-icon-backstroke empty-state-icon" />
                                <MudText>No backstroke events scheduled</MudText>
                            </div>
                        </MudItem>
                    }
                    else
                    {
                        @foreach (var evt in backstrokeEvents)
                        {
                            <MudItem xs="12" sm="6" md="4" lg="3">
                                @RenderEventCard(evt)
                            </MudItem>
                        }
                    }
                </MudGrid>
            </MudTabPanel>

            <!-- BREASTSTROKE -->
            <MudTabPanel Text="BREASTSTROKE" Icon="@Icons.Material.Filled.Waves">
                <MudGrid Class="mt-4" Spacing="3">
                    @{
                        var breaststrokeEvents = _allEvents.Where(e =>
                        e.Subcategory?.ToLower().Contains("breaststroke") == true ||
                        e.SportMainCat?.ToLower() == "breaststroke").ToList();
                    }

                    @if (!breaststrokeEvents.Any())
                    {
                        <MudItem xs="12">
                            <div class="empty-state">
                                <MudIcon Icon="@Icons.Material.Filled.Waves" Class="empty-state-icon" />
                                <MudText>No breaststroke events scheduled</MudText>
                            </div>
                        </MudItem>
                    }
                    else
                    {
                        @foreach (var evt in breaststrokeEvents)
                        {
                            <MudItem xs="12" sm="6" md="4" lg="3">
                                @RenderEventCard(evt)
                            </MudItem>
                        }
                    }
                </MudGrid>
            </MudTabPanel>

            <!-- BUTTERFLY -->
            <MudTabPanel Text="BUTTERFLY" Icon="@Icons.Material.Filled.Waves">
                <MudGrid Class="mt-4" Spacing="3">
                    @{
                        var butterflyEvents = _allEvents.Where(e =>
                        e.Subcategory?.ToLower().Contains("butterfly") == true ||
                        e.SportMainCat?.ToLower() == "butterfly").ToList();
                    }

                    @if (!butterflyEvents.Any())
                    {
                        <MudItem xs="12">
                            <div class="empty-state">
                                <MudIcon Icon="@Icons.Material.Filled.Waves" Class="empty-state-icon" />
                                <MudText>No butterfly events scheduled</MudText>
                            </div>
                        </MudItem>
                    }
                    else
                    {
                        @foreach (var evt in butterflyEvents)
                        {
                            <MudItem xs="12" sm="6" md="4" lg="3">
                                @RenderEventCard(evt)
                            </MudItem>
                        }
                    }
                </MudGrid>
            </MudTabPanel>

            <!-- MEDLEY -->
            <MudTabPanel Text="MEDLEY" Icon="@Icons.Material.Filled.Waves">
                <MudGrid Class="mt-4" Spacing="3">
                    @{
                        var medleyEvents = _allEvents.Where(e =>
                        e.Subcategory?.ToLower().Contains("medley") == true).ToList();
                    }

                    @if (!medleyEvents.Any())
                    {
                        <MudItem xs="12">
                            <div class="empty-state">
                                <MudIcon Icon="@Icons.Material.Filled.Waves" Class="empty-state-icon" />
                                <MudText>No medley events scheduled</MudText>
                            </div>
                        </MudItem>
                    }
                    else
                    {
                        @foreach (var evt in medleyEvents)
                        {
                            <MudItem xs="12" sm="6" md="4" lg="3">
                                @RenderEventCard(evt)
                            </MudItem>
                        }
                    }
                </MudGrid>
            </MudTabPanel>

            <!-- RELAYS -->
            <MudTabPanel Text="RELAYS" Icon="@Icons.Material.Filled.Groups">
                <MudGrid Class="mt-4" Spacing="3">
                    @{
                        var relayEvents = _allEvents.Where(e =>
                        e.Subcategory?.ToLower().Contains("relay") == true ||
                        e.Subcategory?.ToLower().Contains("x") == true).ToList();
                    }

                    @if (!relayEvents.Any())
                    {
                        <MudItem xs="12">
                            <div class="empty-state">
                                <MudIcon Icon="@Icons.Material.Filled.Flag" Class="empty-state-icon" />
                                <MudText>No relay events scheduled</MudText>
                            </div>
                        </MudItem>
                    }
                    else
                    {
                        @foreach (var evt in relayEvents)
                        {
                            <MudItem xs="12" sm="6" md="4" lg="3">
                                @RenderEventCard(evt)
                            </MudItem>
                        }
                    }
                </MudGrid>
            </MudTabPanel>

            <!-- LIVE EVENTS -->
            <MudTabPanel Text="LIVE" Icon="@Icons.Material.Filled.LiveTv">
                <MudGrid Class="mt-4" Spacing="3">
                    @{
                        var liveEvents = _allEvents.Where(e => e.EventStage != "Completed").ToList();
                    }

                    @if (!liveEvents.Any())
                    {
                        <MudItem xs="12">
                            <div class="empty-state">
                                <MudIcon Icon="@Icons.Material.Filled.TimerOff" Class="empty-state-icon" />
                                <MudText>No live events at the moment</MudText>
                            </div>
                        </MudItem>
                    }
                    else
                    {
                        @foreach (var evt in liveEvents)
                        {
                            <MudItem xs="12" sm="6" md="4" lg="3">
                                @RenderEventCard(evt)
                            </MudItem>
                        }
                    }
                </MudGrid>
            </MudTabPanel>

        </MudTabs>
    }

</MudContainer>

@code {
    // --- VARIABLES ---
    private List<EventInfo> _allEvents = new();
    private Dictionary<string, List<HeatData>> _eventHeats = new();
    private Dictionary<string, List<RankingResult>> _eventRankings = new();
    private Dictionary<string, int> _eventParticipantCount = new();
    private bool _isLoading = true;
    private System.Threading.Timer? _timer;

    // --- LIFECYCLE ---
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        // Auto refresh every 10 seconds for real-time updates
        _timer = new System.Threading.Timer(async _ => await InvokeAsync(LoadData), null, 10000, 10000);
    }

    private async Task LoadData()
    {
        try
        {
            // Load all time/distance events using your existing endpoint
            var participants = await apiService.GetAsync<EventInfo>("TimeDistanceEvents/Sports/AthleticsSwimming");

            if (participants != null && participants.Any())
            {
                // FILTER: Only include events where Sport is "Swimming"
                var swimmingEventsOnly = participants
                    .Where(p => !string.IsNullOrEmpty(p.Sport) &&
                                p.Sport == "Swimming")
                    .ToList();

                // Group by event ID to create event list
                _allEvents = swimmingEventsOnly
                    .GroupBy(e => e.ID)
                    .Select(g =>
                    {
                        var first = g.First();
                        return new EventInfo
                        {
                            ID = first.ID,
                            Sport = first.Sport,
                            Subcategory = first.Subcategory,
                            Gender = first.Gender,
                            Level = first.Level,
                            EventStage = first.EventStage,
                            Date = first.Date,
                            Time = first.Time,
                            SportMainCat = first.SportMainCat
                        };
                    })
                    .OrderBy(e => e.EventStage == "Completed" ? 1 : 0) // Completed events last
                    .ThenBy(e => e.Gender)
                    .ThenBy(e => e.Level)
                    .ThenBy(e => e.Subcategory)
                    .ToList();

                // Count participants per event
                _eventParticipantCount.Clear();
                foreach (var evt in _allEvents)
                {
                    var count = swimmingEventsOnly
                        .Where(p => p.ID == evt.ID)
                        .Count();
                    _eventParticipantCount[evt.ID] = count;
                }

                // Load saved data for each event to get heats and rankings
                foreach (var evt in _allEvents)
                {
                    try
                    {
                        // Load saved scoring data for this event
                        var savedData = await LoadSavedScoringData(evt.ID);

                        if (savedData != null)
                        {
                            // Extract heat information
                            if (savedData.Heats != null && savedData.Heats.Any())
                            {
                                var heatInfos = new List<HeatData>();

                                foreach (var savedHeat in savedData.Heats.OrderBy(h => h.HeatOrder))
                                {
                                    var heatData = new HeatData
                                    {
                                        HeatName = savedHeat.HeatName,
                                        HeatOrder = savedHeat.HeatOrder,
                                        LaneCount = savedHeat.Lanes?.Count ?? 0
                                    };

                                    // Find fastest time in this heat
                                    if (savedHeat.Lanes != null && savedHeat.Lanes.Any())
                                    {
                                        var validResults = savedHeat.Lanes
                                            .Where(l => !string.IsNullOrEmpty(l.Result))
                                            .Select(l => l.Result)
                                            .ToList();

                                        if (validResults.Any())
                                        {
                                            heatData.FastestTime = GetFastestResult(validResults, evt.Subcategory);
                                        }
                                    }

                                    heatInfos.Add(heatData);
                                }

                                _eventHeats[evt.ID] = heatInfos;
                            }

                            // Calculate rankings from saved data
                            var rankings = CalculateRankingsFromSavedData(savedData, evt);
                            if (rankings.Any())
                            {
                                _eventRankings[evt.ID] = rankings;
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error loading saved data for event {evt.ID}: {ex.Message}");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading swimming events: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task<SavedScoringData?> LoadSavedScoringData(string eventId)
    {
        try
        {
            var savedData = await apiService.GetSingleAsync<SavedScoringData>($"TimeDistanceEvents/Sports/AthleticsSwimming/{eventId}");
            return savedData ?? new SavedScoringData();
        }
        catch
        {
            return new SavedScoringData();
        }
    }

    private List<RankingResult> CalculateRankingsFromSavedData(SavedScoringData savedData, EventInfo evt)
    {
        var rankings = new List<RankingResult>();

        if (savedData.Heats == null || !savedData.Heats.Any())
            return rankings;

        var allResults = new List<(string RegionName, string PlayerName, string Result, string Lane, double NumericResult)>();

        // Collect all results from all heats
        foreach (var heat in savedData.Heats)
        {
            if (heat.Lanes == null) continue;

            foreach (var lane in heat.Lanes)
            {
                if (!string.IsNullOrEmpty(lane.Result) &&
                    !string.IsNullOrEmpty(lane.RegionAbbreviation) &&
                    TryParseResult(lane.Result, out double numericResult))
                {
                    allResults.Add((
                        lane.RegionAbbreviation,
                        lane.PlayerName ?? "",
                        lane.Result,
                        $"{heat.HeatName}-{lane.LaneName}",
                        numericResult
                    ));
                }
            }
        }

        if (!allResults.Any())
            return rankings;

        // For swimming events, it's always time-based (lower is better)
        var sortedResults = allResults.OrderBy(r => r.NumericResult).ToList();

        for (int i = 0; i < sortedResults.Count; i++)
        {
            var result = sortedResults[i];
            rankings.Add(new RankingResult
            {
                RegionName = result.RegionName,
                PlayerName = result.PlayerName,
                Result = result.Result,
                AssignedLane = result.Lane,
                Rank = i + 1,
                NumericResult = result.NumericResult
            });
        }

        return rankings;
    }

    private string GetFastestResult(List<string> results, string? subcategory)
    {
        if (!results.Any()) return "";

        // Try to parse each result
        var parsedResults = new List<(string Original, double Numeric)>();

        foreach (var result in results)
        {
            if (TryParseResult(result, out double numeric))
            {
                parsedResults.Add((result, numeric));
            }
        }

        if (!parsedResults.Any()) return "";

        // For swimming events, fastest is lowest time
        var fastest = parsedResults.OrderBy(r => r.Numeric).First();
        return fastest.Original;
    }

    private bool TryParseResult(string result, out double numericResult)
    {
        numericResult = 0;

        if (string.IsNullOrEmpty(result))
            return false;

        // Try to parse as time (mm:ss.ff or ss.ff)
        if (result.Contains(":") || result.Contains("."))
        {
            if (TimeSpan.TryParse(result, out TimeSpan timeResult))
            {
                numericResult = timeResult.TotalSeconds;
                return true;
            }
        }

        // Try to parse as number
        return double.TryParse(result, out numericResult);
    }

    private RenderFragment RenderEventCard(EventInfo evt)
    {
        var isLive = evt.EventStage?.ToLower() != "completed";
        var hasHeats = _eventHeats.ContainsKey(evt.ID) && _eventHeats[evt.ID].Any();
        var hasRankings = _eventRankings.ContainsKey(evt.ID) && _eventRankings[evt.ID].Any();
        var participantCount = _eventParticipantCount.ContainsKey(evt.ID) ? _eventParticipantCount[evt.ID] : 0;
        var strokeType = GetStrokeType(evt.SportMainCat, evt.Subcategory);

        return @<div class="modern-card">
            <!-- HEADER -->
            <div class="card-header">
                @if (isLive)
                {
                    <span class="badge-live">LIVE</span>
                }
                else
                {
                    <span class="badge-final">FINAL</span>
                }
                <div class="event-name">@evt.Subcategory</div>
                <div class="event-details">
                    <span class="event-detail-item">
                        <MudIcon Icon="@Icons.Material.Filled.Pool" Size="Size.Small" />
                        SWIMMING
                    </span>
                    <span class="event-detail-item">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                        @evt.Gender
                    </span>
                    <span class="event-detail-item">
                        <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Small" />
                        @evt.Level
                    </span>
                </div>
                @if (!string.IsNullOrEmpty(strokeType))
                {
                    <div style="font-size: 0.8rem; color: var(--accent-teal); margin-top: 5px;">
                        <span class="swim-stroke">@strokeType.ToUpper()</span>
                    </div>
                }
                @if (evt.Date.HasValue)
                {
                    <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">
                        <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" />
                        @evt.Date.Value.ToString("MMM dd") @(!string.IsNullOrEmpty(evt.Time) ? $"• {evt.Time}" : "")
                    </div>
                }
            </div>

            <!-- POOL VISUALIZATION (HEATS) -->
        @if (hasHeats)
        {
                <div class="pool-visual">
                    <MudText Typo="Typo.caption" Style="color: #aaa; font-weight: bold;">
                        <MudIcon Icon="@Icons.Material.Filled.FormatListNumbered" Size="Size.Small" Class="mr-1" />
                        HEATS (@_eventHeats[evt.ID].Count) • @participantCount Swimmers
                    </MudText>
                    <div class="pool-lanes">
                        @foreach (var heat in _eventHeats[evt.ID].Take(3))
                        {
                            <div class="pool-lane">
                                <div class="lane-number">H@(heat.HeatOrder)</div>
                                <div class="lane-region">@heat.HeatName</div>
                                <div class="lane-time">
                                    @if (!string.IsNullOrEmpty(heat.FastestTime))
                                    {
                                        @FormatResultDisplay(heat.FastestTime, evt.Subcategory)
                                    }
                                    else
                                    {
                                        <span style="color: #666;">No time</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
        }
        else if (participantCount > 0)
        {
                <div class="pool-visual">
                    <MudText Typo="Typo.caption" Style="color: #aaa; font-weight: bold;">
                        <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Class="mr-1" />
                        @participantCount Swimmers Registered
                    </MudText>
                    <div style="padding: 10px; text-align: center; color: #888;">
                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mr-1" />
                        Event not started yet
                    </div>
                </div>
        }

            <!-- RESULTS LIST -->
            <div class="results-container">
                @if (hasRankings && _eventRankings[evt.ID].Any())
                {
                    @foreach (var result in _eventRankings[evt.ID].Take(8))
                    {
                        <div class="result-row">
                            <div class="result-rank @GetRankClass(result.Rank)">
                                @(result.Rank > 0 ? $"#{result.Rank}" : "-")
                            </div>
                            <div class="result-info">
                                <span class="result-player">@result.PlayerName</span>
                                <span class="result-region">@result.RegionName</span>
                            </div>
                            <div class="result-time time-result">
                                @FormatResultDisplay(result.Result, evt.Subcategory)
                            </div>
                            @if (!string.IsNullOrEmpty(result.AssignedLane))
                            {
                                <div class="result-lane">@result.AssignedLane.Split('-').LastOrDefault()</div>
                            }
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <MudIcon Icon="@Icons.Material.Filled.TimerOff" Class="empty-state-icon" />
                        <MudText Typo="Typo.caption" Style="color:#666">Waiting for results</MudText>
                        @if (participantCount > 0)
                        {
                            <MudText Typo="Typo.caption" Style="color:#444; margin-top:5px;">
                                @participantCount swimmers registered
                            </MudText>
                        }
                    </div>
                }
            </div>

            <!-- FOOTER LINK -->
            <div class="card-footer">
                <a href="/score/time-distance?eventId=@evt.ID" target="_blank" class="tv-btn">
                    @if (isLive)
                    {
                        <span>LIVE SCORING <MudIcon Icon="@Icons.Material.Filled.LiveTv" Size="Size.Small" Class="ml-2" /></span>
                    }
                    else
                    {
                        <span>VIEW RESULTS <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Small" Class="ml-2" /></span>
                    }
                </a>
            </div>
        </div>;
    }

    private string GetStrokeType(string? sportMainCat, string? subcategory)
    {
        if (!string.IsNullOrEmpty(sportMainCat) && sportMainCat != "Swimming")
        {
            return sportMainCat;
        }

        if (!string.IsNullOrEmpty(subcategory))
        {
            var subLower = subcategory.ToLower();
            if (subLower.Contains("freestyle")) return "Freestyle";
            if (subLower.Contains("backstroke")) return "Backstroke";
            if (subLower.Contains("breaststroke")) return "Breaststroke";
            if (subLower.Contains("butterfly")) return "Butterfly";
            if (subLower.Contains("medley")) return "Medley";
            if (subLower.Contains("relay")) return "Relay";
        }

        return "Swimming";
    }

    private string FormatResultDisplay(string result, string? subcategory)
    {
        if (string.IsNullOrEmpty(result)) return "--:--";

        // If it's already in time format, return as is
        if (result.Contains(":") || result.Contains("."))
        {
            return result;
        }

        // Try to format as time if it's a numeric value
        if (double.TryParse(result, out double seconds))
        {
            if (seconds > 0)
            {
                var timeSpan = TimeSpan.FromSeconds(seconds);
                if (timeSpan.TotalMinutes >= 1)
                {
                    return timeSpan.ToString(@"m\:ss\.ff");
                }
                else
                {
                    return timeSpan.ToString(@"s\.ff");
                }
            }
        }

        return result;
    }

    private string GetRankClass(int rank)
    {
        return rank switch
        {
            1 => "rank-1",
            2 => "rank-2",
            3 => "rank-3",
            _ => ""
        };
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }

    // --- MODELS ---
    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public DateTime? Date { get; set; }
        public string? Time { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class HeatData
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public int LaneCount { get; set; }
        public string? FastestTime { get; set; }
    }

    public class RankingResult
    {
        public string RegionName { get; set; } = "";
        public string? PlayerName { get; set; }
        public string Result { get; set; } = "";
        public string AssignedLane { get; set; } = "";
        public int Rank { get; set; }
        public double NumericResult { get; set; }
    }

    // These classes should match your original scoring page
    public class SavedScoringData
    {
        public List<SavedHeat> Heats { get; set; } = new();
        public List<SavedAssignment> Assignments { get; set; } = new();
    }

    public class SavedHeat
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public List<SavedLane> Lanes { get; set; } = new();
    }

    public class SavedLane
    {
        public string LaneName { get; set; } = "";
        public int LaneOrder { get; set; }
        public string? Result { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
        public string? RegionAbbreviation { get; set; }
    }

    public class SavedAssignment
    {
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string RegionAbbreviation { get; set; } = "";
        public string AssignedTable { get; set; } = "";
    }
}