@page "/scoreboard/swimming"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>Swimming Scoreboard | PALARO 2026</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&family=Chakra+Petch:wght@600;700&display=swap');

    :root {
        --bg-dark: #0a0a0a;
        --card-bg: rgba(30, 30, 30, 0.7);
        --card-border: rgba(255, 255, 255, 0.1);
        --text-primary: #ffffff;
        --accent-blue: #00e5ff;
        --accent-aqua: #00ffcc;
        --accent-teal: #00bcd4;
        --accent-green: #00ff88;
        --accent-red: #ff1744;
        --neon-blue: 0 0 10px rgba(0, 229, 255, 0.6), 0 0 20px rgba(0, 229, 255, 0.3);
        --neon-aqua: 0 0 10px rgba(0, 255, 204, 0.4);
        --neon-teal: 0 0 10px rgba(0, 188, 212, 0.6);
    }

    /* BACKGROUND TEXTURE */
    .dashboard-bg {
        background-color: var(--bg-dark);
        background-image: radial-gradient(circle at 10% 20%, rgba(0, 229, 255, 0.08) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(0, 255, 204, 0.05) 0%, transparent 40%), linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
        min-height: 100vh;
        color: var(--text-primary);
        font-family: 'Rajdhani', sans-serif;
    }

    /* HEADER */
    .header-container {
        text-align: center;
        margin-bottom: 40px;
        position: relative;
        padding: 30px 0;
        background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
        border-bottom: 1px solid rgba(0, 229, 255, 0.2);
    }

    .main-title {
        font-family: 'Orbitron', sans-serif;
        font-weight: 900;
        font-size: clamp(2rem, 5vw, 3.5rem);
        background: linear-gradient(180deg, var(--accent-aqua) 0%, var(--accent-blue) 50%, var(--accent-teal) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: 4px;
        text-transform: uppercase;
        margin-bottom: 5px;
        filter: drop-shadow(0 0 15px rgba(0, 229, 255, 0.4));
    }

    .sub-title {
        font-family: 'Chakra Petch', sans-serif;
        color: rgba(255, 255, 255, 0.7);
        font-size: clamp(1rem, 1.5vw, 1.3rem);
        letter-spacing: 8px;
        font-weight: 700;
        text-transform: uppercase;
        position: relative;
        display: inline-block;
    }

        .sub-title::before, .sub-title::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 60px;
            height: 2px;
            background: var(--accent-blue);
            opacity: 0.5;
        }

        .sub-title::before {
            left: -80px;
        }

        .sub-title::after {
            right: -80px;
        }

    /* EVENT LINK */
    .event-link {
        text-decoration: none;
        display: block;
        height: 100%;
    }

    /* CARD DESIGN */
    .event-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 20px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        height: 100%;
    }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            opacity: 0.5;
        }

        .event-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--accent-blue);
            box-shadow: 0 15px 40px rgba(0, 229, 255, 0.15);
        }

            .event-card:hover::before {
                opacity: 1;
            }

    /* BADGES */
    .status-container {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 8px;
        z-index: 5;
    }

    .event-type-badge {
        background: rgba(0,0,0,0.8);
        color: var(--accent-blue);
        padding: 4px 12px;
        border-radius: 6px;
        font-family: 'Chakra Petch';
        font-weight: 700;
        font-size: 0.8rem;
        border: 1px solid var(--accent-blue);
        box-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
    }

    .status-badge {
        padding: 4px 15px;
        border-radius: 6px;
        font-family: 'Chakra Petch';
        font-weight: 800;
        font-size: 0.8rem;
        letter-spacing: 1px;
    }

    .badge-live {
        background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-teal) 100%);
        color: #000;
        box-shadow: 0 0 15px rgba(0, 229, 255, 0.5);
        border: 1px solid #00e5ff;
        animation: pulse 2s infinite;
    }

    .badge-final {
        background: linear-gradient(135deg, var(--accent-green) 0%, #00c853 100%);
        color: black;
        border: 1px solid #66bb6a;
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
    }

    /* SWIMMING INFO */
    .swimming-info {
        background: rgba(0, 0, 0, 0.6);
        border-radius: 12px;
        padding: 12px;
        margin: 10px 0;
        border: 1px solid rgba(0, 229, 255, 0.3);
    }

    .swimmers-count {
        font-family: 'Orbitron', sans-serif;
        font-size: 2rem;
        font-weight: 900;
        color: var(--accent-aqua);
        line-height: 1;
        text-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        text-align: center;
    }

    .info-label {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.75rem;
        color: #aaa;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-align: center;
        margin-top: 5px;
    }

    .event-name {
        font-family: 'Chakra Petch', sans-serif;
        font-size: 1.1rem;
        font-weight: 700;
        color: white;
        margin-bottom: 4px;
    }

    .sport-icon {
        background: linear-gradient(135deg, rgba(0, 229, 255, 0.2), rgba(0, 229, 255, 0.05));
        border-radius: 50%;
        padding: 10px;
        border: 1px solid rgba(0, 229, 255, 0.3);
    }

    .stroke-type {
        display: inline-block;
        background: rgba(0, 229, 255, 0.2);
        color: var(--accent-blue);
        padding: 3px 10px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid rgba(0, 229, 255, 0.3);
    }

    .distance-badge {
        display: inline-block;
        background: rgba(0, 255, 204, 0.2);
        color: var(--accent-aqua);
        padding: 3px 10px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid rgba(0, 255, 204, 0.3);
        margin-left: 5px;
    }

    /* MUD TABS CUSTOMIZATION */
    .mud-tabs-tabbar {
        background-color: transparent !important;
        border-bottom: 1px solid #333;
    }

    .mud-tab {
        color: #888 !important;
        font-family: 'Orbitron';
        font-weight: 700;
        letter-spacing: 1px;
        transition: color 0.3s;
    }

    .mud-tab-active {
        color: var(--accent-blue) !important;
        font-weight: 900;
        text-shadow: 0 0 10px rgba(0, 229, 255, 0.4);
    }

    .mud-tabs-indicator {
        background-color: var(--accent-blue) !important;
        height: 3px;
        box-shadow: 0 0 10px var(--accent-blue);
    }

    @@keyframes pulse {
        0% {
            opacity: 1;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.5);
        }

        50% {
            opacity: 0.8;
            box-shadow: 0 0 5px rgba(0, 229, 255, 0.2);
        }

        100% {
            opacity: 1;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.5);
        }
    }
</style>

<div class="dashboard-bg">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">

        <!-- HEADER -->
        <div class="header-container">
            <div class="main-title">PALARONG PAMBANSA 2026</div>
            <div class="sub-title">SWIMMING SCOREBOARD</div>
        </div>

        @if (_isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="mt-16">
                <MudProgressCircular Indeterminate="true" Color="Color.Info" Size="Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-4" Style="font-family:'Orbitron'; color:var(--accent-blue);">LOADING SWIMMING EVENTS...</MudText>
            </MudStack>
        }
        else if (!_swimmingEvents.Any())
        {
            <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-4" Style="background-color: rgba(30,30,30,0.5); border: 1px dashed #444; border-radius: 20px;">
                <MudIcon Icon="@Icons.Material.Filled.Pool" Size="Size.Large" Style="color: #555; width: 60px; height: 60px;" />
                <MudText Typo="Typo.h5" Class="mt-4" Style="color: #666; font-family:'Orbitron'; font-weight:700;">NO SWIMMING EVENTS</MudText>
                <MudText Typo="Typo.body2" Style="color: #555;">Waiting for event data...</MudText>
            </MudPaper>
        }
        else
        {
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="mt-6" Centered="true">

                <!-- TAB 1: LIVE / ONGOING -->
                <MudTabPanel Text="LIVE / ONGOING">
                    @{
                        var liveEvents = _swimmingEvents.Where(e => e.EventStage != "Completed").ToList();
                    }

                    @if (!liveEvents.Any())
                    {
                        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-4" Style="background-color: rgba(30,30,30,0.5); border: 1px dashed #444; border-radius: 20px;">
                            <MudIcon Icon="@Icons.Material.Filled.Pool" Size="Size.Large" Style="color: #555; width: 60px; height: 60px;" />
                            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #666; font-family:'Orbitron'; font-weight:700;">NO LIVE SWIMMING EVENTS</MudText>
                            <MudText Typo="Typo.body2" Style="color: #555;">Stand by for upcoming heats</MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudGrid Spacing="3">
                            @foreach (var evt in liveEvents)
                            {
                                <MudItem xs="12" md="6" lg="4" xl="3">
                                    <a href="@GetEventUrl(evt)" class="event-link">
                                        <div class="event-card">
                                            <div class="status-container">
                                                <div class="event-type-badge">@(evt.Level ?? "Open")</div>
                                                <div class="status-badge badge-live">LIVE</div>
                                            </div>

                                            <div class="pa-5">
                                                <!-- Sport Header -->
                                                <div class="d-flex align-center mb-4">
                                                    <div class="sport-icon mr-3">
                                                        <MudIcon Icon="@GetSwimmingIcon(evt.SportMainCat)" Size="Size.Small" Style="color:var(--accent-blue);" />
                                                    </div>
                                                    <div>
                                                        <MudText Typo="Typo.subtitle1" Style="font-family:'Orbitron'; font-weight:900; color:white; line-height:1.2;">SWIMMING</MudText>
                                                        <MudText Typo="Typo.caption" Style="color:#aaa; font-family:'Rajdhani'; letter-spacing:1px; font-weight:600;">
                                                            @(evt.Gender ?? "Mixed") • @(evt.EventStage ?? "Heats")
                                                        </MudText>
                                                    </div>
                                                </div>

                                                <MudDivider Class="mb-4" Style="border-color: rgba(255,255,255,0.1);" />

                                                <!-- Race Info -->
                                                <div class="swimming-info">
                                                    <div class="event-name text-center mb-3">
                                                        @evt.Subcategory
                                                        <span class="distance-badge">@GetDistance(evt.Subcategory)</span>
                                                    </div>

                                                    <div class="swimmers-count">
                                                        @GetParticipantCount(evt.ID) <span style="font-size: 1rem; color: var(--accent-aqua);">SWIMMERS</span>
                                                    </div>
                                                    <div class="info-label">IN PROGRESS</div>
                                                </div>

                                                <!-- Event Details -->
                                                <div class="pa-2">
                                                    <MudText Typo="Typo.body2" Style="color: #ccc; margin-bottom: 8px;">
                                                        <b>Stroke:</b> @GetStrokeType(evt.SportMainCat, evt.Subcategory)
                                                    </MudText>
                                                    <MudText Typo="Typo.body2" Style="color: #ccc; margin-bottom: 8px;">
                                                        <b>Category:</b> @evt.Subcategory
                                                    </MudText>
                                                    <MudText Typo="Typo.body2" Style="color: #ccc; margin-bottom: 12px;">
                                                        <b>Format:</b> @GetSwimmingFormat(evt.Subcategory)
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Style="color: var(--accent-blue); font-weight:600;">
                                                        Click for live timing & results
                                                    </MudText>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudTabPanel>

                <!-- TAB 2: FINISHED RESULTS -->
                <MudTabPanel Text="RESULTS">
                    @{
                        var finishedEvents = _swimmingEvents.Where(e => e.EventStage == "Completed").ToList();
                    }

                    @if (!finishedEvents.Any())
                    {
                        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-4" Style="background-color: rgba(30,30,30,0.5); border: 1px dashed #444; border-radius: 20px;">
                            <MudIcon Icon="@Icons.Material.Filled.HistoryToggleOff" Size="Size.Large" Style="color: #555;" />
                            <MudText Typo="Typo.h6" Class="mt-4" Style="color: #777; font-family:'Orbitron'">NO COMPLETED EVENTS YET</MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudGrid Spacing="3">
                            @foreach (var evt in finishedEvents)
                            {
                                <MudItem xs="12" md="6" lg="4" xl="3">
                                    <a href="@GetEventUrl(evt)" class="event-link">
                                        <div class="event-card">
                                            <div class="status-container">
                                                <div class="event-type-badge">@(evt.Level ?? "Open")</div>
                                                <div class="status-badge badge-final">FINAL</div>
                                            </div>

                                            <div class="pa-5">
                                                <!-- Sport Header -->
                                                <div class="d-flex align-center mb-4">
                                                    <div class="sport-icon mr-3">
                                                        <MudIcon Icon="@GetSwimmingIcon(evt.SportMainCat)" Size="Size.Small" Style="color:var(--accent-blue);" />
                                                    </div>
                                                    <div>
                                                        <MudText Typo="Typo.subtitle1" Style="font-family:'Orbitron'; font-weight:900; color:white; line-height:1.2;">SWIMMING</MudText>
                                                        <MudText Typo="Typo.caption" Style="color:#aaa; font-family:'Rajdhani'; letter-spacing:1px; font-weight:600;">
                                                            @(evt.Gender ?? "Mixed") • @(evt.EventStage ?? "Final")
                                                        </MudText>
                                                    </div>
                                                </div>

                                                <MudDivider Class="mb-4" Style="border-color: rgba(255,255,255,0.1);" />

                                                <!-- Results Display -->
                                                <div class="swimming-info">
                                                    <div class="event-name text-center mb-3">
                                                        @evt.Subcategory
                                                        <span class="distance-badge">@GetDistance(evt.Subcategory)</span>
                                                    </div>

                                                    <div class="swimmers-count">
                                                        FINAL
                                                    </div>
                                                    <div class="info-label">RESULTS</div>
                                                </div>

                                                <!-- Event Details -->
                                                <div class="pa-2">
                                                    <MudText Typo="Typo.body2" Style="color: #ccc; margin-bottom: 8px;">
                                                        <b>Stroke:</b> @GetStrokeType(evt.SportMainCat, evt.Subcategory)
                                                    </MudText>
                                                    <MudText Typo="Typo.body2" Style="color: #ccc; margin-bottom: 8px;">
                                                        <b>Category:</b> @evt.Subcategory
                                                    </MudText>
                                                    <MudText Typo="Typo.body2" Style="color: #ccc; margin-bottom: 12px;">
                                                        <b>Fastest Time:</b> @GetFastestTime(evt.ID)
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Style="color: var(--accent-blue); font-weight:600;">
                                                        Click for final results & standings
                                                    </MudText>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudTabPanel>

                <!-- TAB 3: BY STROKE -->
                <MudTabPanel Text="BY STROKE">
                    <div class="mt-4">
                        <!-- FREESTYLE -->
                        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--accent-blue); font-family:'Orbitron';">FREESTYLE</MudText>
                        <MudGrid Spacing="3" Class="mb-6">
                            @{
                                var freestyleEvents = _swimmingEvents.Where(e =>
                                e.Subcategory?.ToLower().Contains("freestyle") == true ||
                                e.SportMainCat?.ToLower() == "freestyle").ToList();
                            }
                            @if (freestyleEvents.Any())
                            {
                                @foreach (var evt in freestyleEvents)
                                {
                                    <MudItem xs="12" md="6" lg="4" xl="3">
                                        @RenderEventCard(evt)
                                    </MudItem>
                                }
                            }
                            else
                            {
                                <MudItem xs="12">
                                    <MudPaper Class="pa-4 text-center" Style="background: rgba(0,0,0,0.3);">
                                        <MudText Style="color: #666;">No freestyle events</MudText>
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>

                        <!-- BACKSTROKE -->
                        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--accent-blue); font-family:'Orbitron';">BACKSTROKE</MudText>
                        <MudGrid Spacing="3" Class="mb-6">
                            @{
                                var backstrokeEvents = _swimmingEvents.Where(e =>
                                e.Subcategory?.ToLower().Contains("backstroke") == true ||
                                e.SportMainCat?.ToLower() == "backstroke").ToList();
                            }
                            @if (backstrokeEvents.Any())
                            {
                                @foreach (var evt in backstrokeEvents)
                                {
                                    <MudItem xs="12" md="6" lg="4" xl="3">
                                        @RenderEventCard(evt)
                                    </MudItem>
                                }
                            }
                            else
                            {
                                <MudItem xs="12">
                                    <MudPaper Class="pa-4 text-center" Style="background: rgba(0,0,0,0.3);">
                                        <MudText Style="color: #666;">No backstroke events</MudText>
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>

                        <!-- BREASTSTROKE -->
                        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--accent-blue); font-family:'Orbitron';">BREASTSTROKE</MudText>
                        <MudGrid Spacing="3" Class="mb-6">
                            @{
                                var breaststrokeEvents = _swimmingEvents.Where(e =>
                                e.Subcategory?.ToLower().Contains("breaststroke") == true ||
                                e.SportMainCat?.ToLower() == "breaststroke").ToList();
                            }
                            @if (breaststrokeEvents.Any())
                            {
                                @foreach (var evt in breaststrokeEvents)
                                {
                                    <MudItem xs="12" md="6" lg="4" xl="3">
                                        @RenderEventCard(evt)
                                    </MudItem>
                                }
                            }
                            else
                            {
                                <MudItem xs="12">
                                    <MudPaper Class="pa-4 text-center" Style="background: rgba(0,0,0,0.3);">
                                        <MudText Style="color: #666;">No breaststroke events</MudText>
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>

                        <!-- BUTTERFLY -->
                        <MudText Typo="Typo.h6" Class="mb-3" Style="color: var(--accent-blue); font-family:'Orbitron';">BUTTERFLY</MudText>
                        <MudGrid Spacing="3" Class="mb-6">
                            @{
                                var butterflyEvents = _swimmingEvents.Where(e =>
                                e.Subcategory?.ToLower().Contains("butterfly") == true ||
                                e.SportMainCat?.ToLower() == "butterfly").ToList();
                            }
                            @if (butterflyEvents.Any())
                            {
                                @foreach (var evt in butterflyEvents)
                                {
                                    <MudItem xs="12" md="6" lg="4" xl="3">
                                        @RenderEventCard(evt)
                                    </MudItem>
                                }
                            }
                            else
                            {
                                <MudItem xs="12">
                                    <MudPaper Class="pa-4 text-center" Style="background: rgba(0,0,0,0.3);">
                                        <MudText Style="color: #666;">No butterfly events</MudText>
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>
                    </div>
                </MudTabPanel>
            </MudTabs>
        }
    </MudContainer>
</div>

@code {
    /* ===================== MODELS ===================== */

    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Level { get; set; }
        public string? Gender { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public DateTime? Date { get; set; }
        public string? Time { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    /* ===================== STATE ===================== */

    private List<EventInfo> _swimmingEvents = new();
    private Dictionary<string, List<EventInfo>> _eventParticipants = new();
    private Dictionary<string, List<RankingResult>> _eventRankings = new();
    private bool _isLoading = true;
    private Timer? _refreshTimer;

    /* ===================== INIT ===================== */

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        // Auto-refresh every 10 seconds for live dashboard updates
        _refreshTimer = new Timer(async _ => await InvokeAsync(LoadData), null, 10000, 10000);
    }

    /* ===================== GET DATA ===================== */

    private async Task LoadData()
    {
        try
        {
            // Load all swimming events
            var participants = await apiService.GetAsync<EventInfo>("TimeDistanceEvents/Sports/AthleticsSwimming");

            if (participants != null && participants.Any())
            {
                // Filter for swimming events only
                var swimmingParticipants = participants
                    .Where(p => p.Sport == "Swimming")
                    .ToList();

                // Group events
                _swimmingEvents = swimmingParticipants
                    .GroupBy(x => x.ID)
                    .Select(g => g.First())
                    .OrderBy(x => x.EventStage == "Completed" ? 1 : 0)
                    .ThenBy(x => x.Gender)
                    .ThenBy(x => x.Level)
                    .ThenBy(x => x.Subcategory)
                    .ToList();

                // Store participants per event
                _eventParticipants.Clear();
                foreach (var evt in _swimmingEvents)
                {
                    var participantsForEvent = swimmingParticipants
                        .Where(p => p.ID == evt.ID)
                        .ToList();
                    _eventParticipants[evt.ID] = participantsForEvent;
                }

                // Load rankings for each event
                foreach (var evt in _swimmingEvents)
                {
                    try
                    {
                        var rankings = await CalculateRankingsForEvent(evt.ID);
                        if (rankings.Any())
                        {
                            _eventRankings[evt.ID] = rankings;
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error loading rankings for event {evt.ID}: {ex.Message}");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading swimming events: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task<List<RankingResult>> CalculateRankingsForEvent(string eventId)
    {
        var rankings = new List<RankingResult>();

        try
        {
            // Try to load saved scoring data
            var savedData = await apiService.GetSingleAsync<SavedScoringData>($"TimeDistanceEvents/Sports/AthleticsSwimming/{eventId}");

            if (savedData != null && savedData.Heats != null && savedData.Heats.Any())
            {
                var allResults = new List<(string RegionName, string PlayerName, string Result, string Lane, double NumericResult)>();

                // Collect all results from all heats
                foreach (var heat in savedData.Heats)
                {
                    if (heat.Lanes == null) continue;

                    foreach (var lane in heat.Lanes)
                    {
                        if (!string.IsNullOrEmpty(lane.Result) &&
                            !string.IsNullOrEmpty(lane.RegionAbbreviation) &&
                            TryParseResult(lane.Result, out double numericResult))
                        {
                            allResults.Add((
                                lane.RegionAbbreviation,
                                lane.PlayerName ?? "",
                                lane.Result,
                                $"{heat.HeatName}-{lane.LaneName}",
                                numericResult
                            ));
                        }
                    }
                }

                if (allResults.Any())
                {
                    // Sort by time (lower is better for swimming)
                    var sortedResults = allResults.OrderBy(r => r.NumericResult).ToList();

                    for (int i = 0; i < sortedResults.Count; i++)
                    {
                        var result = sortedResults[i];
                        rankings.Add(new RankingResult
                        {
                            RegionName = result.RegionName,
                            PlayerName = result.PlayerName,
                            Result = result.Result,
                            AssignedLane = result.Lane,
                            Rank = i + 1,
                            NumericResult = result.NumericResult
                        });
                    }
                }
            }
        }
        catch
        {
            // Ignore errors - rankings will be empty
        }

        return rankings;
    }

    private bool TryParseResult(string result, out double numericResult)
    {
        numericResult = 0;

        if (string.IsNullOrEmpty(result))
            return false;

        // Try to parse as time (mm:ss.ff or ss.ff)
        if (result.Contains(":") || result.Contains("."))
        {
            if (TimeSpan.TryParse(result, out TimeSpan timeResult))
            {
                numericResult = timeResult.TotalSeconds;
                return true;
            }
        }

        // Try to parse as number
        return double.TryParse(result, out numericResult);
    }

    /* ===================== HELPER METHODS ===================== */

    private string GetSwimmingIcon(string? sportMainCat)
    {
        if (string.IsNullOrEmpty(sportMainCat))
            return Icons.Material.Filled.Pool;

        var s = sportMainCat.ToLower();
        if (s.Contains("freestyle")) return Icons.Material.Filled.DirectionsRun;
        if (s.Contains("backstroke")) return Icons.Material.Filled.RotateLeft;
        if (s.Contains("breaststroke")) return Icons.Material.Filled.Waves;
        if (s.Contains("butterfly")) return Icons.Material.Filled.Flight;
        if (s.Contains("medley")) return Icons.Material.Filled.Merge;
        return Icons.Material.Filled.Pool;
    }

    private string GetStrokeType(string? sportMainCat, string? subcategory)
    {
        if (!string.IsNullOrEmpty(sportMainCat) && sportMainCat != "Swimming")
        {
            return sportMainCat;
        }

        if (!string.IsNullOrEmpty(subcategory))
        {
            var subLower = subcategory.ToLower();
            if (subLower.Contains("freestyle")) return "Freestyle";
            if (subLower.Contains("backstroke")) return "Backstroke";
            if (subLower.Contains("breaststroke")) return "Breaststroke";
            if (subLower.Contains("butterfly")) return "Butterfly";
            if (subLower.Contains("medley")) return "Medley";
            if (subLower.Contains("relay")) return "Relay";
        }

        return "Swimming";
    }

    private string GetDistance(string? subcategory)
    {
        if (string.IsNullOrEmpty(subcategory))
            return "50m";

        var matches = System.Text.RegularExpressions.Regex.Match(subcategory, @"(\d+)\s*(m|meter|meters)");
        if (matches.Success)
        {
            return $"{matches.Groups[1].Value}m";
        }
        return "50m";
    }

    private string GetSwimmingFormat(string? subcategory)
    {
        if (string.IsNullOrEmpty(subcategory))
            return "Individual";

        var s = subcategory.ToLower();
        if (s.Contains("relay")) return "Team Relay";
        if (s.Contains("medley")) return "Individual Medley";
        return "Individual";
    }

    private int GetParticipantCount(string eventId)
    {
        if (_eventParticipants.ContainsKey(eventId))
        {
            return _eventParticipants[eventId].Count;
        }
        return 0;
    }

    private string GetFastestTime(string eventId)
    {
        if (_eventRankings.ContainsKey(eventId) && _eventRankings[eventId].Any())
        {
            var fastest = _eventRankings[eventId].First();
            return FormatTimeDisplay(fastest.Result);
        }
        return "--:--";
    }

    private string FormatTimeDisplay(string result)
    {
        if (string.IsNullOrEmpty(result)) return "--:--";

        // If it's already in time format, return as is
        if (result.Contains(":") || result.Contains("."))
        {
            return result;
        }

        // Try to format as time if it's a numeric value
        if (double.TryParse(result, out double seconds))
        {
            if (seconds > 0)
            {
                var timeSpan = TimeSpan.FromSeconds(seconds);
                if (timeSpan.TotalMinutes >= 1)
                {
                    return timeSpan.ToString(@"m\:ss\.ff");
                }
                else
                {
                    return timeSpan.ToString(@"s\.ff");
                }
            }
        }

        return result;
    }

    private string GetEventUrl(EventInfo evt)
    {
        return $"/scoreboard/swimming/{evt.ID}";
    }

    /* ===================== CARD RENDERER ===================== */

    private RenderFragment RenderEventCard(EventInfo evt) => @<a href="@GetEventUrl(evt)" class="event-link">
        <div class="event-card">
            <div class="status-container">
                <div class="event-type-badge">@(evt.Level ?? "Open")</div>
                <div class="status-badge @(evt.EventStage == "Completed" ? "badge-final" : "badge-live")">
                    @(evt.EventStage == "Completed" ? "FINAL" : "LIVE")
                </div>
            </div>

            <div class="pa-5">
                <!-- Sport Header -->
                <div class="d-flex align-center mb-4">
                    <div class="sport-icon mr-3">
                        <MudIcon Icon="@GetSwimmingIcon(evt.SportMainCat)" Size="Size.Small" Style="color:var(--accent-blue);" />
                    </div>
                    <div>
                        <MudText Typo="Typo.subtitle1" Style="font-family:'Orbitron'; font-weight:900; color:white; line-height:1.2;">SWIMMING</MudText>
                        <MudText Typo="Typo.caption" Style="color:#aaa; font-family:'Rajdhani'; letter-spacing:1px; font-weight:600;">
                            @(evt.Gender ?? "Mixed") • @(evt.EventStage ?? "Heats")
                        </MudText>
                    </div>
                </div>

                <MudDivider Class="mb-4" Style="border-color: rgba(255,255,255,0.1);" />

                <!-- Race Info -->
                <div class="swimming-info">
                    <div class="event-name text-center mb-3">
                        @evt.Subcategory
                        <span class="distance-badge">@GetDistance(evt.Subcategory)</span>
                    </div>

                    <div class="swimmers-count">
                        @GetParticipantCount(evt.ID) <span style="font-size: 1rem; color: var(--accent-aqua);">SWIMMERS</span>
                    </div>
                    <div class="info-label">@(evt.EventStage == "Completed" ? "RESULTS" : "IN PROGRESS")</div>
                </div>

                <!-- Event Details -->
                <div class="pa-2">
                    <MudText Typo="Typo.body2" Style="color: #ccc; margin-bottom: 8px;">
                        <b>Stroke:</b> @GetStrokeType(evt.SportMainCat, evt.Subcategory)
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: #ccc; margin-bottom: 8px;">
                        <b>Category:</b> @evt.Subcategory
                    </MudText>
                    <MudText Typo="Typo.caption" Style="color: var(--accent-blue); font-weight:600;">
                        Click for timing & results
                    </MudText>
                </div>
            </div>
        </div>
    </a>;

    /* ===================== CLEANUP ===================== */

    public void Dispose() => _refreshTimer?.Dispose();

    /* ===================== SUPPORTING CLASSES ===================== */

    public class RankingResult
    {
        public string RegionName { get; set; } = "";
        public string? PlayerName { get; set; }
        public string Result { get; set; } = "";
        public string AssignedLane { get; set; } = "";
        public int Rank { get; set; }
        public double NumericResult { get; set; }
    }

    public class SavedScoringData
    {
        public List<SavedHeat> Heats { get; set; } = new();
        public List<SavedAssignment> Assignments { get; set; } = new();
    }

    public class SavedHeat
    {
        public string HeatName { get; set; } = "";
        public int HeatOrder { get; set; }
        public List<SavedLane> Lanes { get; set; } = new();
    }

    public class SavedLane
    {
        public string LaneName { get; set; } = "";
        public int LaneOrder { get; set; }
        public string? Result { get; set; }
        public int? RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
        public string? RegionAbbreviation { get; set; }
    }

    public class SavedAssignment
    {
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string RegionAbbreviation { get; set; } = "";
        public string AssignedTable { get; set; } = "";
    }
}