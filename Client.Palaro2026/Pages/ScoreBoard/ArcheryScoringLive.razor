@page "/scoreboard/archery/{EventID}"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>Archery Live | PALARO 2026</PageTitle>

<style>
    /* --- FONTS & VARS --- */
    @@import url('https://fonts.cdnfonts.com/css/evil-empire');
    @@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Chakra+Petch:wght@600;700;800&display=swap');

    :root {
        --pal-blue: #023E8A;
        --pal-dark-blue: #001845;
        --pal-gold: #FFB400;
        --pal-red: #EA0000;
        --bg-gradient-start: #f8f9fa;
        --card-bg: rgba(255, 255, 255, 0.98);
        --font-header: 'Evil Empire', sans-serif;
        --font-body: 'Nunito', sans-serif;
    }

    body {
        margin: 0;
        padding: 0;
        background-color: var(--bg-gradient-start);
        font-family: var(--font-body);
        overflow-x: hidden;
    }

    .tv-screen {
        min-height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at 50% 30%, #ffffff 0%, #e0e7ff 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-bottom: 8vh;
    }

    /* --- HEADER --- */
    .match-info-container {
        text-align: center;
        margin-top: 4vh;
        margin-bottom: 3vh;
        padding: 20px 60px;
        border-radius: 50px;
        background: var(--pal-dark-blue);
        border: 3px solid var(--pal-gold);
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
        min-width: 40%;
    }

    .sport-title {
        font-family: var(--font-header);
        font-size: clamp(2.5rem, 5vw, 4rem);
        color: white;
        text-transform: uppercase;
        letter-spacing: 2px;
        line-height: 1;
        text-shadow: 3px 3px 0px #000000;
    }

    .match-meta {
        font-family: 'Chakra Petch', sans-serif;
        font-size: clamp(1rem, 1.5vw, 1.2rem);
        color: var(--pal-gold);
        letter-spacing: 3px;
        font-weight: 700;
        text-transform: uppercase;
        margin-top: 5px;
    }

    /* --- CARDS --- */
    .pairings-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
        width: 90%;
        max-width: 1500px;
        margin-bottom: 50px;
        /* Center content if single card */
        align-items: center;
    }

    .match-card {
        width: 100%;
        background: var(--card-bg);
        border: 1px solid #d1d9e6;
        border-top: 6px solid var(--pal-gold);
        border-bottom: 6px solid var(--pal-blue);
        box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        border-radius: 30px;
        padding: 40px;
        position: relative;
    }

    .match-stage-label {
        position: absolute;
        top: -18px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--pal-red);
        color: white;
        padding: 8px 40px;
        border-radius: 30px;
        font-family: 'Chakra Petch';
        font-weight: 800;
        font-size: 1.1rem;
        text-transform: uppercase;
        border: 3px solid white;
        box-shadow: 0 5px 15px rgba(234, 0, 0, 0.3);
        letter-spacing: 1px;
    }

    .teams-grid {
        display: grid;
        grid-template-columns: 1fr 0.3fr 1fr;
        align-items: center;
        margin-bottom: 30px;
        margin-top: 10px;
    }

    .team-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .logo-circle {
        width: 130px;
        height: 130px;
        background: white;
        border-radius: 50%;
        border: 4px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        margin-bottom: 15px;
        transition: transform 0.3s;
    }

    .winning-glow {
        border-color: var(--pal-gold);
        box-shadow: 0 0 25px rgba(255, 180, 0, 0.4);
        transform: scale(1.05);
    }

    .team-name {
        font-family: var(--font-header);
        font-size: 2.2rem;
        color: var(--pal-dark-blue);
        line-height: 1;
        margin-bottom: 5px;
    }

    .team-region {
        font-size: 0.9rem;
        font-weight: 700;
        color: #888;
        background: #f1f3f5;
        padding: 4px 12px;
        border-radius: 10px;
    }

    .team-points {
        font-family: 'Chakra Petch', sans-serif;
        font-size: 6rem;
        font-weight: 800;
        color: #cfd8dc;
        line-height: 1;
        margin-top: 10px;
    }

    .points-lead {
        color: var(--pal-blue);
        text-shadow: 4px 4px 0px rgba(0,0,0,0.1);
    }

    .vs-separator {
        font-family: var(--font-header);
        font-size: 4rem;
        color: #e0e0e0;
        text-align: center;
        font-style: italic;
    }

    /* HISTORY TABLE */
    .history-section {
        border-top: 2px dashed #e9ecef;
        padding-top: 25px;
    }

    .set-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
        text-align: center;
    }

        .set-table th {
            font-family: 'Chakra Petch';
            color: #adb5bd;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 10px;
        }

        .set-table tr.score-row {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }

        .set-table td {
            font-family: 'Nunito';
            font-weight: 800;
            font-size: 1.4rem;
            color: var(--pal-dark-blue);
            padding: 12px 5px;
            border-top: 1px solid #f8f9fa;
            border-bottom: 1px solid #f8f9fa;
        }

            .set-table td:first-child {
                border-left: 1px solid #f8f9fa;
                border-radius: 10px 0 0 10px;
            }

            .set-table td:last-child {
                border-right: 1px solid #f8f9fa;
                border-radius: 0 10px 10px 0;
            }

        .set-table .team-col {
            text-align: left;
            font-size: 1.1rem;
            color: var(--pal-blue);
            padding-left: 20px;
            width: 25%;
        }

        .set-table .total-col {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #e9ecef !important;
        }

    .score-win {
        color: var(--pal-red) !important;
        transform: scale(1.1);
        display: inline-block;
    }

    /* RANKING TABLE */
    .ranking-card {
        background: var(--card-bg);
        border-radius: 20px;
        width: 90%;
        max-width: 1400px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-top: 5px solid var(--pal-blue);
    }

    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px;
    }

        .modern-table th {
            text-align: left;
            font-family: 'Chakra Petch';
            color: #777;
            font-weight: 600;
            padding: 10px 20px;
        }

        .modern-table td {
            background: white;
            padding: 15px 20px;
            font-family: 'Nunito';
            font-weight: 700;
            color: var(--pal-dark-blue);
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .modern-table tr td:first-child {
            border-left: 1px solid #eee;
            border-radius: 10px 0 0 10px;
        }

        .modern-table tr td:last-child {
            border-right: 1px solid #eee;
            border-radius: 0 10px 10px 0;
        }

    .rank-num {
        display: inline-block;
        width: 35px;
        height: 35px;
        line-height: 35px;
        text-align: center;
        border-radius: 50%;
        background: #eee;
        color: #555;
        font-weight: 900;
    }

    .rank-1 {
        background: var(--pal-gold);
        color: white;
        box-shadow: 0 3px 10px rgba(255, 180, 0, 0.4);
    }

    .rank-2 {
        background: #C0C0C0;
        color: white;
    }

    .rank-3 {
        background: #CD7F32;
        color: white;
    }

    /* FOOTER */
    .ticker-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 8vh;
        background: white;
        border-top: 4px solid var(--pal-gold);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }

    .footer-logo {
        height: 4vh;
        margin: 0 15px;
    }

</style>

<div class="tv-screen">

    <!-- HEADER -->
    <div class="match-info-container">
        @if (_isLoading)
        {
            <div class="sport-title" style="font-size:2rem;">LOADING...</div>
        }
        else if (_event == null)
        {
            <div class="sport-title" style="font-size:2rem; color:var(--pal-red);">EVENT NOT FOUND</div>
        }
        else
        {
            <div class="sport-title">ARCHERY</div>
            <div class="match-meta">
                @_event.Level • @_event.Gender • @GetCleanCategory(_event.Subcategory)
            </div>
        }
    </div>

    @if (!_isLoading && _event != null)
    {
        @if (Is1440Round)
        {
            <!-- RANKING VIEW -->
            <div class="ranking-card">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">RANK</th>
                            <th>ARCHER / TEAM</th>
                            <th>REGION</th>
                            <th style="text-align:center;">TENS</th>
                            <th style="text-align:center; color:var(--pal-blue);">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in _scoringRows.OrderBy(r => r.Rank == 0).ThenBy(r => r.Rank).ThenByDescending(r => r.TotalScore))
                        {
                            <tr>
                                <td style="text-align:center;"><span class="rank-num @(row.Rank == 1 ? "rank-1" : row.Rank == 2 ? "rank-2" : row.Rank == 3 ? "rank-3" : "")">@(row.Rank > 0 ? row.Rank : "-")</span></td>
                                <td>
                                    <div style="font-size:1.2rem;">@row.PlayerName</div>
                                    @if (!string.IsNullOrEmpty(row.TeamMembers))
                                    {
                                        <div style="font-size:0.8rem; color:#888;">@row.TeamMembers</div>
                                    }
                                </td>
                                <td>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <img src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{Uri.EscapeDataString(row.LogoFilename)}.webp")" style="width:30px; height:30px; object-fit:contain;" onerror="this.style.display='none'" />
                                        <span>@row.RegionName</span>
                                    </div>
                                </td>
                                <td style="text-align:center; color:#888;">@row.TensCount</td>
                                <td style="text-align:center; font-size:1.5rem; font-weight:900; color:var(--pal-blue);">@row.TotalScore</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <!-- MATCH PLAY VIEW -->
            <div class="pairings-container">
                @{
                    // FIXED: Ensure we filter based on manual _targetPairIndex
                    IEnumerable<TeamPairing> pairsToShow = _teamPairings;
                    if (_targetPairIndex.HasValue && _targetPairIndex.Value >= 0 && _targetPairIndex.Value < _teamPairings.Count)
                    {
                        pairsToShow = new List<TeamPairing> { _teamPairings[_targetPairIndex.Value] };
                    }
                }

                @foreach (var pairing in pairsToShow)
                {
                    <div class="match-card">
                        <div class="match-stage-label">
                            @(string.IsNullOrEmpty(pairing.MatchStage) ? "ELIMINATION ROUND" : pairing.MatchStage)
                        </div>

                        <div class="teams-grid">
                            <!-- Left Team -->
                            <div class="team-display">
                                <div class="logo-circle @(pairing.Team1MatchPoints > pairing.Team2MatchPoints ? "winning-glow" : "")">
                                    <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{pairing.Team1Logo}.webp")" ObjectFit="ObjectFit.Contain" Style="width:100%; height:100%;" />
                                </div>
                                <div class="team-name">@pairing.Team1Name</div>
                                <span class="team-region">@pairing.Team1Logo</span>
                                <div class="team-points @(pairing.Team1MatchPoints > pairing.Team2MatchPoints ? "points-lead" : "")">
                                    @pairing.Team1MatchPoints
                                </div>
                            </div>

                            <!-- VS -->
                            <div class="vs-separator">VS</div>

                            <!-- Right Team -->
                            <div class="team-display">
                                <div class="logo-circle @(pairing.Team2MatchPoints > pairing.Team1MatchPoints ? "winning-glow" : "")">
                                    <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{pairing.Team2Logo}.webp")" ObjectFit="ObjectFit.Contain" Style="width:100%; height:100%;" />
                                </div>
                                <div class="team-name">@pairing.Team2Name</div>
                                <span class="team-region">@pairing.Team2Logo</span>
                                <div class="team-points @(pairing.Team2MatchPoints > pairing.Team1MatchPoints ? "points-lead" : "")">
                                    @pairing.Team2MatchPoints
                                </div>
                            </div>
                        </div>

                        <!-- Score Table -->
                        <div class="history-section">
                            <table class="set-table">
                                <thead>
                                    <tr>
                                        <th class="team-col">TEAM</th>
                                        <th>END 1</th>
                                        <th>END 2</th>
                                        <th>END 3</th>
                                        <th>END 4</th>
                                        <th>END 5</th>
                                        <th>S.O.</th>
                                        <th class="total-col">ARROWS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="score-row">
                                        <td class="team-col">@pairing.Team1Name</td>
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            var s1 = pairing.SetScoresTeam1.ContainsKey(i) ? pairing.SetScoresTeam1[i] : 0;
                                            var s2 = pairing.SetScoresTeam2.ContainsKey(i) ? pairing.SetScoresTeam2[i] : 0;
                                            var win = s1 > 0 && s1 > s2;
                                            <td><span class="@(win ? "score-win" : "")">@(s1 > 0 ? s1.ToString() : "-")</span></td>
                                        }
                                        <td>-</td>
                                        <td class="total-col">@pairing.Team1TotalArrows</td>
                                    </tr>
                                    <tr class="score-row">
                                        <td class="team-col">@pairing.Team2Name</td>
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            var s1 = pairing.SetScoresTeam1.ContainsKey(i) ? pairing.SetScoresTeam1[i] : 0;
                                            var s2 = pairing.SetScoresTeam2.ContainsKey(i) ? pairing.SetScoresTeam2[i] : 0;
                                            var win = s2 > 0 && s2 > s1;
                                            <td><span class="@(win ? "score-win" : "")">@(s2 > 0 ? s2.ToString() : "-")</span></td>
                                        }
                                        <td>-</td>
                                        <td class="total-col">@pairing.Team2TotalArrows</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>
        }
    }

    <!-- FOOTER -->
    <div class="ticker-footer">
        <div class="ticker-track">
            <img src="/media/images/2031.png" class="footer-logo" />
            <img src="/media/images/deped.png" class="footer-logo" />
            <img src="/media/logo/Palarong Pambansa Logo.webp" class="footer-logo" />
        </div>
    </div>
</div>

@code {
    [Parameter] public string EventID { get; set; } = "";

    // We store the pair index here manually
    private int? _targetPairIndex;

    // --- MODELS ---
    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Subcategory { get; set; }
        public string? Level { get; set; }
        public string? Gender { get; set; }
        public string? SportMainCat { get; set; }
        public string? EventStage { get; set; }
        public bool? IsFinished { get; set; }
        public string? Sport { get; set; }
        public List<EventVersus>? EventVersusList { get; set; }
    }
    public class EventVersus
    {
        public int ID { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Rank { get; set; }
        public List<EventVersusTeamPlayers>? EventVersusTeamPlayersList { get; set; }
    }
    public class EventVersusTeamPlayers { public string? FirstName { get; set; } public string? LastName { get; set; } }
    public class SchoolRegions { public int ID { get; set; } public string? Region { get; set; } public string? Abbreviation { get; set; } }
    public class ArcheryScoringDTO { public int RegionID { get; set; } public string? PlayerID { get; set; } public string? PlayerName { get; set; } public int ShotScore { get; set; } public int EndNo { get; set; } public bool IsX { get; set; } public bool Is10 { get; set; } }
    public class ScoringRow { public int RegionID { get; set; } public string RegionName { get; set; } = ""; public string LogoFilename { get; set; } = ""; public string PlayerName { get; set; } = ""; public string TeamMembers { get; set; } = ""; public int TotalScore { get; set; } public int TensCount { get; set; } public int Rank { get; set; } }

    public class TeamPairing
    {
        public string MatchStage { get; set; } = "MATCH PLAY";
        public string Team1Name { get; set; } = ""; public string Team1Logo { get; set; } = "";
        public int Team1RegionID { get; set; }
        public int Team1MatchPoints { get; set; }
        public int Team1TotalArrows { get; set; }
        public Dictionary<int, int> SetScoresTeam1 { get; set; } = new();

        public string Team2Name { get; set; } = ""; public string Team2Logo { get; set; } = "";
        public int Team2RegionID { get; set; }
        public int Team2MatchPoints { get; set; }
        public int Team2TotalArrows { get; set; }
        public Dictionary<int, int> SetScoresTeam2 { get; set; } = new();
    }

    private EventInfo? _event;
    private List<ScoringRow> _scoringRows = new();
    private List<TeamPairing> _teamPairings = new();
    private List<SchoolRegions>? _allRegions;
    private bool _isLoading = true;
    private Timer? _timer;

    private bool Is1440Round => _event?.SportMainCat?.Contains("1440") == true || _event?.SportMainCat?.Contains("Quali") == true;

    // --- MANUAL PARAMETER PARSING ---
    protected override async Task OnParametersSetAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = uri.Query;
        
        // Parse query string manually
        if (!string.IsNullOrEmpty(query) && query.Contains("pair="))
        {
            var pairs = query.TrimStart('?').Split('&');
            foreach (var pair in pairs)
            {
                var parts = pair.Split('=');
                if (parts.Length == 2 && parts[0] == "pair" && int.TryParse(parts[1], out int p))
                {
                    _targetPairIndex = p;
                    break;
                }
            }
        }
        else
        {
            _targetPairIndex = null;
        }
        // If data is already loaded, we just trigger a re-render.
        if (!_isLoading) StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _timer = new Timer(async _ => await InvokeAsync(LoadData), null, 3000, 3000);
    }
    public void Dispose() => _timer?.Dispose();

    private async Task LoadData()
    {
        try
        {
            if (_allRegions == null) _allRegions = await apiService.GetAsync<SchoolRegions>("/Schools/Regions");

            var events = await apiService.GetAsync<EventInfo>("/Events/Details");
            _event = events?.FirstOrDefault(e => e.ID == EventID && e.Sport == "Archery");

            if (_event == null) { _isLoading = false; return; }

            _scoringRows.Clear();
            BuildBaseRows();

            var scores = await apiService.GetAsync<ArcheryScoringDTO>($"/score/ArcheryScoring/event/{EventID}");
            if (scores != null && scores.Any()) ProcessScores(scores);
            if (!Is1440Round) BuildPairings(scores);

            _isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); _isLoading = false; }
    }

    private void BuildBaseRows()
    {
        if (_event?.EventVersusList != null)
        {
            foreach (var vs in _event.EventVersusList)
            {
                var reg = _allRegions?.FirstOrDefault(r => r.Region == vs.Region || r.Abbreviation == vs.Abbreviation);
                var members = vs.EventVersusTeamPlayersList?.Select(p => $"{p.FirstName} {p.LastName}").ToList() ?? new List<string>();
                _scoringRows.Add(new ScoringRow
                {
                    RegionID = reg?.ID ?? 0,
                    RegionName = reg?.Abbreviation ?? vs.Region ?? "TBD",
                    LogoFilename = reg?.Region ?? "Default",
                    PlayerName = vs.Abbreviation ?? vs.Region ?? "Team",
                    TeamMembers = string.Join(", ", members),
                    Rank = int.TryParse(vs.Rank, out int r) ? r : 0
                });
            }
        }
    }

    private void ProcessScores(List<ArcheryScoringDTO> scores)
    {
        foreach (var row in _scoringRows)
        {
            var teamScores = scores.Where(s => s.RegionID == row.RegionID).ToList();
            row.TotalScore = teamScores.Sum(s => s.ShotScore);
            row.TensCount = teamScores.Count(s => s.ShotScore == 10 || s.IsX || s.Is10);
        }
        var ranked = _scoringRows.OrderByDescending(r => r.TotalScore).ToList();
        int rank = 1;
        for (int i = 0; i < ranked.Count; i++) ranked[i].Rank = rank++;
    }

    private void BuildPairings(List<ArcheryScoringDTO>? allScores)
    {
        _teamPairings.Clear();
        int count = _scoringRows.Count;
        int pairs = (int)Math.Ceiling(count / 2.0);

        for (int i = 0; i < pairs; i++)
        {
            var t1 = _scoringRows.ElementAtOrDefault(i * 2);
            var t2 = _scoringRows.ElementAtOrDefault(i * 2 + 1);
            if (t1 == null) continue;

            var pair = new TeamPairing
            {
                MatchStage = _event?.EventStage ?? "ELIMINATION",
                Team1Name = t1.PlayerName,
                Team1Logo = t1.LogoFilename,
                Team1RegionID = t1.RegionID,
                Team1TotalArrows = t1.TotalScore,
                Team2Name = t2?.PlayerName ?? "BYE",
                Team2Logo = t2?.LogoFilename ?? "Default",
                Team2RegionID = t2?.RegionID ?? 0,
                Team2TotalArrows = t2?.TotalScore ?? 0
            };

            if (allScores != null)
            {
                var t1Shots = allScores.Where(s => s.RegionID == t1.RegionID).ToList();
                pair.SetScoresTeam1 = t1Shots.GroupBy(s => s.EndNo).ToDictionary(g => g.Key, g => g.Sum(s => s.ShotScore));

                var t2Shots = t2 != null ? allScores.Where(s => s.RegionID == t2.RegionID).ToList() : new List<ArcheryScoringDTO>();
                pair.SetScoresTeam2 = t2Shots.GroupBy(s => s.EndNo).ToDictionary(g => g.Key, g => g.Sum(s => s.ShotScore));

                int maxSet = Math.Max(pair.SetScoresTeam1.Count > 0 ? pair.SetScoresTeam1.Keys.Max() : 0, pair.SetScoresTeam2.Count > 0 ? pair.SetScoresTeam2.Keys.Max() : 0);
                for (int set = 1; set <= maxSet; set++)
                {
                    int s1 = pair.SetScoresTeam1.ContainsKey(set) ? pair.SetScoresTeam1[set] : 0;
                    int s2 = pair.SetScoresTeam2.ContainsKey(set) ? pair.SetScoresTeam2[set] : 0;
                    if (s1 == 0 && s2 == 0) continue;
                    if (s1 > s2) pair.Team1MatchPoints += 2;
                    else if (s2 > s1) pair.Team2MatchPoints += 2;
                    else { pair.Team1MatchPoints += 1; pair.Team2MatchPoints += 1; }
                }
            }
            _teamPairings.Add(pair);
        }
    }

    private string GetCleanCategory(string? cat) => string.IsNullOrEmpty(cat) ? "Individual" : cat.Replace("Qualifying", "").Trim();
}