@page "/scoreboard/archery/{EventID}"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>Archery Scoring | PALARO 2026</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&family=Chakra+Petch:wght@600;700&display=swap');

    :root {
        --bg-dark: #121212;
        --panel-bg: rgba(20, 20, 25, 0.9);
        --accent-gold: #FFD700;
        --accent-blue: #00B0FF;
        --accent-red: #FF1744;
        --text-white: #ffffff;
        --accent-green: #4CAF50;
        --accent-purple: #9C27B0;
    }

    body {
        background-color: black;
        overflow-x: hidden;
        margin: 0;
    }

    .tv-screen {
        min-height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at center, #1e1e24 0%, #000000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: 'Rajdhani', sans-serif;
        color: white;
        padding: 20px 0;
    }

    /* --- ORIGINAL HEADER STYLES --- */
    .tournament-header {
        text-align: center;
        margin-bottom: 2vh;
    }

    .palaro-branding {
        font-family: 'Orbitron', sans-serif;
        font-size: 2.5rem;
        color: var(--accent-gold);
        letter-spacing: 5px;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    .sport-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 3rem;
        font-weight: 900;
        margin-top: 5px;
    }

    .match-details {
        font-size: 1.5rem;
        color: #aaa;
        margin-top: 5px;
    }

    /* --- ORIGINAL BADGES --- */
    .scoreboard-card {
        width: 95%;
        max-width: 1400px;
        background: var(--panel-bg);
        border-radius: 25px;
        padding: 30px;
        margin-bottom: 3vh;
        text-align: center;
        font-size: 1.8rem;
        font-family: 'Rajdhani', sans-serif;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .status-badge {
        font-family: 'Orbitron', sans-serif;
        padding: 8px 30px;
        border-radius: 50px;
        font-size: 1.5rem;
        font-weight: bold;
    }

    .live { background: var(--accent-red); animation: pulse 1.5s infinite; }
    .finish { background: #00C853; }

    .category-badge {
        display: inline-block;
        margin-left: 15px;
        padding: 5px 15px;
        border-radius: 20px;
        font-family: 'Orbitron', sans-serif;
        font-size: 1.2rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .category-team { background: var(--accent-blue); color: white; }
    .category-mixed { background: var(--accent-purple); color: white; }
    .category-individual { background: var(--accent-green); color: white; }

    /* --- TEAM PAIRINGS (The VS Card) --- */
    .pairings-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(700px, 1fr)); /* Wider for the table */
        gap: 20px;
        width: 95%;
        max-width: 1400px;
    }

    .pairing-card {
        background: var(--panel-bg);
        border-radius: 20px;
        padding: 25px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .pairing-header {
        text-align: center;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        font-family: 'Orbitron', sans-serif;
        font-size: 1.2rem;
        color: var(--accent-gold);
    }

    .team-vs-team {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 30px;
        margin-bottom: 10px;
    }

    .team-display {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding: 20px;
        border-radius: 15px;
        background: rgba(255,255,255,0.05);
        transition: all 0.3s;
    }

    .winning-team { border: 2px solid var(--accent-green); background: rgba(76, 175, 80, 0.1); }
    .losing-team { border: 2px solid var(--accent-red); background: rgba(255, 23, 68, 0.1); opacity: 0.8; }

    .team-logo {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        overflow: hidden;
        background: rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .team-logo img { width: 100%; height: 100%; object-fit: contain; }

    .team-name {
        font-weight: bold;
        font-size: 1.3rem;
        text-align: center;
        font-family: 'Chakra Petch', sans-serif;
    }

    .team-score {
        font-family: 'Orbitron', sans-serif;
        font-size: 3.5rem; /* Big Score for Match Points */
        font-weight: 900;
        color: white;
        margin-top: 5px;
        line-height: 1;
    }
    .score-lead { color: var(--accent-gold); text-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }

    .vs-separator {
        font-family: 'Orbitron', sans-serif;
        font-size: 2rem;
        color: var(--accent-red);
        font-weight: 900;
    }

    /* --- NEW: TENNIS STYLE SET TABLE (Styled to match original UI) --- */
    .match-scoreboard {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 12px;
        overflow: hidden;
        margin-top: 10px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .set-table {
        width: 100%;
        border-collapse: collapse;
    }

    .set-table th {
        background: rgba(255, 215, 0, 0.1);
        color: var(--accent-gold);
        font-family: 'Orbitron', sans-serif;
        font-size: 0.9rem;
        padding: 8px;
        text-align: center;
        border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    }

    .set-table td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700;
        font-size: 1.2rem;
        color: #888;
    }

    .set-table .team-col {
        text-align: left;
        padding-left: 20px;
        color: white;
        font-family: 'Chakra Petch', sans-serif;
        width: 35%;
        font-size: 1rem;
    }

    .set-table .total-col {
        background: rgba(255, 255, 255, 0.05);
        color: white;
        font-family: 'Orbitron';
        font-weight: bold;
    }

    /* Set Winner Colors */
    .set-win { color: var(--accent-green) !important; font-weight: 900; text-shadow: 0 0 5px rgba(0, 230, 118, 0.3); }
    .set-draw { color: white !important; }
    .set-loss { color: #555 !important; }

    /* --- ORIGINAL 1440 TABLE STYLES --- */
    .results-table {
        width: 95%;
        max-width: 1400px;
        background: rgba(255,255,255,0.05);
        border-radius: 15px;
        padding: 20px;
    }

    .team-table { border-collapse: separate; border-spacing: 0 10px; width: 100%; }
    
    .medal-badge {
        display: inline-flex; align-items: center; justify-content: center;
        width: 30px; height: 30px; border-radius: 50%; font-weight: bold; margin-right: 10px;
    }
    .gold-badge { background: var(--accent-gold); color: #000; }
    .silver-badge { background: #C0C0C0; color: #000; }
    .bronze-badge { background: #CD7F32; color: white; }

    .back-button {
        position: absolute; top: 20px; left: 20px;
        background: rgba(255,255,255,0.1); color: white; border: 1px solid #333;
        padding: 8px 16px; border-radius: 8px; cursor: pointer;
        font-family: 'Orbitron'; transition: 0.3s;
    }
    .back-button:hover { background: var(--accent-blue); }
    
    @@keyframes pulse { 0%, 100% { opacity: 1 } 50% { opacity: 0.7 } }
</style>

<div class="tv-screen">
    <button class="back-button" onclick="history.back()">← Back</button>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate Color="Color.Warning" Size="Size.Large" />
    }
    else if (_event == null)
    {
        <MudText Typo="Typo.h4" Color="Color.Error">EVENT NOT FOUND</MudText>
    }
    else
    {
        <!-- ORIGINAL HEADER LAYOUT -->
        <div class="tournament-header">
            <div class="palaro-branding">PALARONG PAMBANSA 2026</div>
            <div class="sport-name">ARCHERY</div>
            <div class="match-details">
                @if (_event.IsFinished == true)
                {
                    <div class="status-badge finish">FINISH</div>
                }
                else
                {
                    <div class="status-badge live">LIVE</div>
                }
            </div>
        </div>

        <!-- ORIGINAL BADGE ROW -->
        <div class="scoreboard-card">
            @_event.Level
            <span style="color:var(--accent-gold); margin:0 10px">•</span>
            @_event.Gender
            <span style="color:var(--accent-gold); margin:0 10px">•</span>
            @_event.Subcategory
            @if (!string.IsNullOrEmpty(_event.Subcategory))
            {
                var categoryType = GetCategoryType(_event.Subcategory);
                <span class="category-badge @GetCategoryClass(categoryType)">
                    @categoryType
                </span>
            }
        </div>

        @if (Is1440Round)
        {
            <!-- 1440 ROUND (Ranking Table) - Original Layout -->
            <div class="results-table">
                <MudTable Items="_scoringRows.OrderBy(r => r.Rank == 0).ThenBy(r => r.Rank).ThenByDescending(r => r.TotalScore)"
                          Dense Hover Class="team-table" Style="background:transparent;">
                    <HeaderContent>
                        <MudTh Style="color:#aaa; font-family:'Orbitron'">Rank</MudTh>
                        <MudTh Style="color:#aaa; font-family:'Orbitron'">Archer / Team</MudTh>
                        <MudTh Style="color:#aaa; font-family:'Orbitron'">Region</MudTh>
                        <MudTh Style="color:var(--accent-gold); font-family:'Orbitron'; text-align:center;">Total Score</MudTh>
                        <MudTh Style="text-align:center; color:#aaa; font-family:'Orbitron'">Tens</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            @if (context.Rank > 0)
                            {
                                <div style="display: flex;">
                                    @if (context.Rank == 1) { <div class="medal-badge gold-badge">1</div> }
                                    else if (context.Rank == 2) { <div class="medal-badge silver-badge">2</div> }
                                    else if (context.Rank == 3) { <div class="medal-badge bronze-badge">3</div> }
                                    else { <span style="font-family: Orbitron; font-weight:bold; color:white; font-size: 1.2rem;">#@context.Rank</span> }
                                </div>
                            }
                        </MudTd>
                        <MudTd>
                            <div style="font-weight: bold; font-size: 1.1rem;">@context.PlayerName</div>
                            @if(!string.IsNullOrEmpty(context.TeamMembers)) {
                                <div style="font-size:0.8rem; color:#aaa;">@context.TeamMembers</div>
                            }
                        </MudTd>
                        <MudTd>
                            <div style="display: flex; align-items: center;">
                                <img src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{Uri.EscapeDataString(context.LogoFilename)}.webp")"
                                     style="width: 30px; height: 30px; margin-right: 10px; object-fit: contain;" onerror="this.style.display='none'" />
                                <b>@context.RegionName</b>
                            </div>
                        </MudTd>
                        <MudTd Style="font-family: Orbitron; font-weight:bold; color: var(--accent-gold); text-align:center; font-size: 1.3rem;">
                            @context.TotalScore
                        </MudTd>
                        <MudTd Style="text-align:center; font-family: Orbitron; color: #aaa;">
                            @context.TensCount
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
        }
        else
        {
            <!-- OLYMPIC ROUND (Versus) - Original Layout + New Table -->
            <div class="pairings-container">
                @foreach (var pairing in _teamPairings)
                {
                    <div class="pairing-card">
                        <div class="pairing-header">
                            @(string.IsNullOrEmpty(pairing.MatchStage) ? "MATCH PLAY" : pairing.MatchStage)
                        </div>

                        <!-- VS DISPLAY -->
                        <div class="team-vs-team">
                            <!-- Team 1 -->
                            <div class="team-display @(pairing.Team1MatchPoints > pairing.Team2MatchPoints ? "winning-team" : pairing.Team1MatchPoints < pairing.Team2MatchPoints ? "losing-team" : "")">
                                <div class="team-logo">
                                    <img src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{Uri.EscapeDataString(pairing.Team1Logo)}.webp")" onerror="this.style.display='none'" />
                                </div>
                                <div class="team-name">@pairing.Team1Name</div>
                                <!-- Big Set Points -->
                                <div class="team-score @(pairing.Team1MatchPoints > pairing.Team2MatchPoints ? "score-lead" : "")">
                                    @pairing.Team1MatchPoints
                                </div>
                            </div>

                            <div class="vs-separator">VS</div>

                            <!-- Team 2 -->
                            <div class="team-display @(pairing.Team2MatchPoints > pairing.Team1MatchPoints ? "winning-team" : pairing.Team2MatchPoints < pairing.Team1MatchPoints ? "losing-team" : "")">
                                <div class="team-logo">
                                    <img src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{Uri.EscapeDataString(pairing.Team2Logo)}.webp")" onerror="this.style.display='none'" />
                                </div>
                                <div class="team-name">@pairing.Team2Name</div>
                                <!-- Big Set Points -->
                                <div class="team-score @(pairing.Team2MatchPoints > pairing.Team1MatchPoints ? "score-lead" : "")">
                                    @pairing.Team2MatchPoints
                                </div>
                            </div>
                        </div>

                        <!-- NEW: TENNIS STYLE SET SCORE TABLE -->
                        <div class="match-scoreboard">
                            <table class="set-table">
                                <thead>
                                    <tr>
                                        <th class="team-col">SET SCORE</th>
                                        <th>1</th>
                                        <th>2</th>
                                        <th>3</th>
                                        <th>4</th>
                                        <th>5</th>
                                        <th>S.O.</th>
                                        <th class="total-col">ARROWS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Team 1 Row -->
                                    <tr>
                                        <td class="team-col">@pairing.Team1Name</td>
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            var s1 = pairing.SetScoresTeam1.ContainsKey(i) ? pairing.SetScoresTeam1[i] : 0;
                                            var s2 = pairing.SetScoresTeam2.ContainsKey(i) ? pairing.SetScoresTeam2[i] : 0;
                                            var css = "";
                                            // Determine winner of set for color highlighting
                                            if (s1 > 0 || s2 > 0)
                                            {
                                                if (s1 > s2) css = "set-win";
                                                else if (s1 < s2) css = "set-loss";
                                                else css = "set-draw";
                                            }
                                            <td><span class="@css">@(s1 > 0 ? s1.ToString() : "-")</span></td>
                                        }
                                        <td>-</td>
                                        <td class="total-col">@pairing.Team1TotalArrows</td>
                                    </tr>

                                    <!-- Team 2 Row -->
                                    <tr>
                                        <td class="team-col">@pairing.Team2Name</td>
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            var s1 = pairing.SetScoresTeam1.ContainsKey(i) ? pairing.SetScoresTeam1[i] : 0;
                                            var s2 = pairing.SetScoresTeam2.ContainsKey(i) ? pairing.SetScoresTeam2[i] : 0;
                                            var css = "";
                                            if (s1 > 0 || s2 > 0)
                                            {
                                                if (s2 > s1) css = "set-win";
                                                else if (s2 < s1) css = "set-loss";
                                                else css = "set-draw";
                                            }
                                            <td><span class="@css">@(s2 > 0 ? s2.ToString() : "-")</span></td>
                                        }
                                        <td>-</td>
                                        <td class="total-col">@pairing.Team2TotalArrows</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter] public string EventID { get; set; } = "";

    /* --- DATA MODELS --- */

    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Subcategory { get; set; }
        public string? Level { get; set; }
        public string? Gender { get; set; }
        public string? SportMainCat { get; set; } 
        public string? EventStage { get; set; }
        public bool? IsFinished { get; set; }
        public string? Sport { get; set; }
        public List<EventVersus>? EventVersusList { get; set; }
    }

    public class EventVersus
    {
        public int ID { get; set; }
        public string? Score { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Rank { get; set; }
        public List<EventVersusTeamPlayers>? EventVersusTeamPlayersList { get; set; }
    }

    public class EventVersusTeamPlayers
    {
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
    }

    public class SchoolRegions
    {
        public int ID { get; set; }
        public string? Region { get; set; } 
        public string? Abbreviation { get; set; }
    }

    public class ArcheryScoringDTO
    {
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
        public int ShotScore { get; set; }
        public int EndNo { get; set; } // The Set Number (1, 2, 3...)
        public bool IsX { get; set; }
        public bool Is10 { get; set; }
    }

    /* --- VIEW MODELS --- */

    public class ScoringRow
    {
        public int RegionID { get; set; }
        public string RegionName { get; set; } = "";
        public string LogoFilename { get; set; } = "";
        public string PlayerName { get; set; } = "";
        public string TeamMembers { get; set; } = "";
        public int TotalScore { get; set; }
        public int TensCount { get; set; }
        public int Rank { get; set; }
    }

    public class TeamPairing
    {
        public string MatchStage { get; set; } = "MATCH PLAY";
        
        // Team 1 Info
        public string Team1Name { get; set; } = "";
        public string Team1Logo { get; set; } = "";
        public string Team1Members { get; set; } = "";
        public int Team1RegionID { get; set; }
        public int Team1MatchPoints { get; set; } // e.g. 6 (Set Points)
        public int Team1TotalArrows { get; set; } // Tie breaker score
        public Dictionary<int, int> SetScoresTeam1 { get; set; } = new();

        // Team 2 Info
        public string Team2Name { get; set; } = "";
        public string Team2Logo { get; set; } = "";
        public string Team2Members { get; set; } = "";
        public int Team2RegionID { get; set; }
        public int Team2MatchPoints { get; set; }
        public int Team2TotalArrows { get; set; }
        public Dictionary<int, int> SetScoresTeam2 { get; set; } = new();
    }

    /* --- STATE --- */

    private EventInfo? _event;
    private List<ScoringRow> _scoringRows = new();
    private List<TeamPairing> _teamPairings = new();
    private List<SchoolRegions>? _allRegions;
    private bool _isLoading = true;
    private Timer? _timer;

    // Helper to detect format
    private bool Is1440Round => _event?.SportMainCat?.Contains("1440") == true || _event?.SportMainCat?.Contains("Quali") == true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _timer = new Timer(async _ => await InvokeAsync(LoadData), null, 3000, 3000); 
    }

    public void Dispose() => _timer?.Dispose();

    private async Task LoadData()
    {
        try
        {
            if (_allRegions == null)
                _allRegions = await apiService.GetAsync<SchoolRegions>("/Schools/Regions");

            var events = await apiService.GetAsync<EventInfo>("/Events/Details");
            _event = events?.FirstOrDefault(e => e.ID == EventID && e.Sport == "Archery");

            if (_event == null) { _isLoading = false; return; }

            BuildBaseRows();

            var scores = await apiService.GetAsync<ArcheryScoringDTO>($"/score/ArcheryScoring/event/{EventID}");
            
            if (scores != null && scores.Any())
            {
                ProcessScores(scores);
            }

            if (!Is1440Round)
            {
                BuildPairings(scores);
            }

            _isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            _isLoading = false;
        }
    }

    private void BuildBaseRows()
    {
        if (_scoringRows.Any()) return;

        if (_event?.EventVersusList != null)
        {
            foreach (var vs in _event.EventVersusList)
            {
                var reg = _allRegions?.FirstOrDefault(r => r.Region == vs.Region || r.Abbreviation == vs.Abbreviation);
                var members = vs.EventVersusTeamPlayersList?.Select(p => $"{p.FirstName} {p.LastName}").ToList() ?? new List<string>();

                _scoringRows.Add(new ScoringRow
                {
                    RegionID = reg?.ID ?? 0,
                    RegionName = reg?.Abbreviation ?? vs.Region ?? "TBD",
                    LogoFilename = reg?.Region ?? "Default",
                    PlayerName = vs.Region ?? "Team",
                    TeamMembers = string.Join(", ", members),
                    Rank = int.TryParse(vs.Rank, out int r) ? r : 0
                });
            }
        }
    }

    private void ProcessScores(List<ArcheryScoringDTO> scores)
    {
        foreach (var row in _scoringRows)
        {
            var teamScores = scores.Where(s => s.RegionID == row.RegionID).ToList();
            row.TotalScore = teamScores.Sum(s => s.ShotScore);
            row.TensCount = teamScores.Count(s => s.ShotScore == 10 || s.IsX || s.Is10);
        }

        var ranked = _scoringRows.OrderByDescending(r => r.TotalScore).ToList();
        int rank = 1;
        for (int i = 0; i < ranked.Count; i++)
        {
            ranked[i].Rank = rank++;
        }
    }

    private void BuildPairings(List<ArcheryScoringDTO>? allScores)
    {
        _teamPairings.Clear();
        int count = _scoringRows.Count;
        int pairs = (int)Math.Ceiling(count / 2.0);

        for (int i = 0; i < pairs; i++)
        {
            var t1 = _scoringRows.ElementAtOrDefault(i * 2);
            var t2 = _scoringRows.ElementAtOrDefault(i * 2 + 1);

            if (t1 == null) continue;

            var pair = new TeamPairing
            {
                MatchStage = _event?.EventStage ?? "MATCH",
                
                Team1Name = t1.RegionName,
                Team1Logo = t1.LogoFilename,
                Team1Members = t1.TeamMembers,
                Team1RegionID = t1.RegionID,
                Team1TotalArrows = t1.TotalScore, 

                Team2Name = t2?.RegionName ?? "BYE",
                Team2Logo = t2?.LogoFilename ?? "Default",
                Team2Members = t2?.TeamMembers ?? "",
                Team2RegionID = t2?.RegionID ?? 0,
                Team2TotalArrows = t2?.TotalScore ?? 0
            };

            // LOGIC FOR SET SCORING
            if (allScores != null)
            {
                var t1Shots = allScores.Where(s => s.RegionID == t1.RegionID).ToList();
                pair.SetScoresTeam1 = t1Shots.GroupBy(s => s.EndNo).ToDictionary(g => g.Key, g => g.Sum(s => s.ShotScore));

                var t2Shots = t2 != null ? allScores.Where(s => s.RegionID == t2.RegionID).ToList() : new List<ArcheryScoringDTO>();
                pair.SetScoresTeam2 = t2Shots.GroupBy(s => s.EndNo).ToDictionary(g => g.Key, g => g.Sum(s => s.ShotScore));

                int maxSet = Math.Max(
                    pair.SetScoresTeam1.Keys.Count > 0 ? pair.SetScoresTeam1.Keys.Max() : 0,
                    pair.SetScoresTeam2.Keys.Count > 0 ? pair.SetScoresTeam2.Keys.Max() : 0
                );

                for (int set = 1; set <= maxSet; set++)
                {
                    int s1 = pair.SetScoresTeam1.ContainsKey(set) ? pair.SetScoresTeam1[set] : 0;
                    int s2 = pair.SetScoresTeam2.ContainsKey(set) ? pair.SetScoresTeam2[set] : 0;

                    if (s1 == 0 && s2 == 0) continue; 

                    if (s1 > s2) pair.Team1MatchPoints += 2;
                    else if (s2 > s1) pair.Team2MatchPoints += 2;
                    else { pair.Team1MatchPoints += 1; pair.Team2MatchPoints += 1; }
                }
            }

            _teamPairings.Add(pair);
        }
    }

    private string GetCategoryType(string? subcategory)
    {
        if (string.IsNullOrEmpty(subcategory)) return "Individual";
        var s = subcategory.ToLower();
        if (s.Contains("mixed")) return "Mixed";
        if (s.Contains("team")) return "Team";
        return "Individual";
    }

    private string GetCategoryClass(string categoryType)
    {
        return categoryType.ToLower() switch
        {
            "team" => "category-team",
            "mixed" => "category-mixed",
            _ => "category-individual"
        };
    }
}