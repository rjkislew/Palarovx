@page "/scoreboard/archery/{EventID}"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>Archery | PALARO 2026</PageTitle>

<style>
    /* --- FONTS & VARS --- */
    @@import url('https://fonts.cdnfonts.com/css/evil-empire');
    @@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Chakra+Petch:wght@600;700;800&display=swap');

    :root {
        --pal-blue: #023E8A;
        --pal-dark-blue: #001845;
        --pal-gold: #FFB400;
        --pal-red: #EA0000;
        --bg-gradient-start: #f8f9fa;
        --card-bg: rgba(255, 255, 255, 0.95);
        --font-header: 'Evil Empire', sans-serif;
        --font-body: 'Chakra Petch', sans-serif;
    }

    body {
        margin: 0;
        padding: 0;
        background-color: var(--bg-gradient-start);
        font-family: var(--font-body);
        overflow-x: hidden; /* Prevent horizontal scroll on body */
    }

    .tv-screen {
        min-height: 100vh;
        width: 100%;
        background: radial-gradient(circle at 50% 30%, #ffffff 0%, #e0e7ff 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-bottom: 10vh;
        box-sizing: border-box;
    }

    /* --- HEADER --- */
    .match-info-container {
        text-align: center;
        margin-top: 3vh;
        margin-bottom: 3vh;
        padding: 1.5vh 3vw;
        border-radius: 30px;
        background: var(--pal-dark-blue);
        border: 4px solid var(--pal-gold);
        box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
        width: 90%;
        max-width: 1200px;
    }

    .sport-title {
        font-family: var(--font-header);
        /* Scale from 40px (Mobile) to 120px (TV) */
        font-size: clamp(40px, 8vw, 120px);
        color: white;
        text-transform: uppercase;
        letter-spacing: 3px;
        line-height: 0.9;
        text-shadow: 4px 4px 0px #000000;
    }

    .match-meta {
        font-family: 'Chakra Petch', sans-serif;
        /* Scale from 14px (Mobile) to 40px (TV) */
        font-size: clamp(14px, 2.5vw, 40px);
        color: var(--pal-gold);
        letter-spacing: 2px;
        font-weight: 700;
        text-transform: uppercase;
        margin-top: 1vh;
        text-align: center;
    }

    /* --- MATCH PLAY CARD --- */
    .pairings-container {
        display: flex;
        flex-direction: column;
        gap: 4vh;
        width: 96%;
        max-width: 1800px;
        margin-bottom: 5vh;
    }

    .match-card {
        background: var(--card-bg);
        border: 2px solid #d1d9e6;
        border-top: 1vh solid var(--pal-gold);
        border-bottom: 1vh solid var(--pal-blue);
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        border-radius: 30px;
        padding: 4vh 2vw;
        position: relative;
    }

    .match-stage-label {
        position: absolute;
        top: -2.5vh;
        left: 50%;
        transform: translateX(-50%);
        background: var(--pal-red);
        color: white;
        padding: 0.5vh 3vw;
        border-radius: 50px;
        font-family: 'Chakra Petch';
        font-weight: 800;
        text-transform: uppercase;
        font-size: clamp(1rem, 2vw, 2.5rem);
        border: 3px solid white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        white-space: nowrap;
    }

    /* TEAMS GRID LAYOUT */
    .teams-grid {
        display: grid;
        /* Default: Side-by-Side */
        grid-template-columns: 1fr 0.1fr 1fr;
        align-items: center;
        margin-bottom: 3vh;
        gap: 10px;
    }

    .team-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .logo-circle {
        /* Scale from 80px (Mobile) to 250px (TV) */
        width: clamp(80px, 18vh, 250px);
        height: clamp(80px, 18vh, 250px);
        background: white;
        border-radius: 50%;
        border: clamp(3px, 0.5vw, 6px) solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        margin-bottom: 1.5vh;
    }

    .winning-glow {
        border-color: var(--pal-gold);
        box-shadow: 0 0 40px rgba(255, 180, 0, 0.6);
    }

    .team-name {
        font-family: var(--font-header);
        /* Scale from 1.5rem (Mobile) to 7rem (TV) */
        font-size: clamp(1.5rem, 6vw, 7rem);
        color: var(--pal-dark-blue);
        line-height: 1;
        margin-bottom: 1vh;
        text-transform: uppercase;
        word-break: break-word;
        max-width: 100%;
    }

    .team-points {
        font-family: 'Chakra Petch', sans-serif;
        /* Scale from 4rem (Mobile) to 18rem (TV) */
        font-size: clamp(4rem, 15vw, 18rem);
        font-weight: 800;
        color: #455a64;
        line-height: 0.9;
    }

    .points-lead {
        color: var(--pal-blue);
        text-shadow: 5px 5px 0px rgba(0,0,0,0.1);
    }

    .vs-separator {
        font-family: var(--font-header);
        font-size: clamp(2rem, 5vw, 6rem);
        color: #ddd;
        text-align: center;
        opacity: 0.7;
    }

    /* --- HISTORY TABLE (Responsive Scroll) --- */
    .history-section {
        border-top: 2px solid rgba(0,0,0,0.1);
        padding-top: 3vh;
        width: 100%;
        overflow-x: auto; /* Enable horizontal scroll for small screens */
    }

    .set-table {
        width: 100%;
        border-collapse: collapse;
        text-align: center;
        min-width: 600px; /* Force minimum width to ensure readability on mobile scroll */
    }

        .set-table th {
            font-family: 'Chakra Petch';
            color: #78909c;
            font-size: clamp(1rem, 2vw, 2.5rem);
            text-transform: uppercase;
            border-bottom: 4px solid var(--pal-gold);
            padding-bottom: 1vh;
            font-weight: 700;
            padding-left: 10px;
            padding-right: 10px;
        }

        .set-table td {
            font-family: 'Nunito';
            font-weight: 900;
            font-size: clamp(1.5rem, 4vw, 5rem);
            color: var(--pal-dark-blue);
            padding: 1.5vh 5px;
        }

        .set-table .team-col {
            text-align: left;
            font-size: clamp(1.2rem, 2.5vw, 3rem);
            color: var(--pal-blue);
            font-family: 'Chakra Petch';
            font-weight: 800;
            width: 30%;
            white-space: nowrap;
            position: sticky;
            left: 0;
            background: var(--card-bg); /* Keep background when scrolling */
            z-index: 5;
        }

        .set-table .total-col {
            background: rgba(0,0,0,0.03);
            color: #444;
            font-weight: 900;
        }

    .score-win {
        color: var(--pal-red) !important;
        transform: scale(1.1);
        display: inline-block;
    }

    /* --- 1440 RANKING TABLE --- */
    .ranking-card {
        background: var(--card-bg);
        border-radius: 30px;
        width: 96%;
        max-width: 1800px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-top: 1vh solid var(--pal-blue);
        overflow-x: auto; /* Allow scroll on mobile */
    }

    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 1vh;
        min-width: 800px; /* Prevent squishing */
    }

        .modern-table th {
            text-align: left;
            font-family: 'Chakra Petch';
            color: #666;
            font-weight: 700;
            font-size: clamp(1.2rem, 2vw, 2.5rem);
            padding: 10px 20px;
        }

        .modern-table td {
            background: white;
            padding: 2vh 20px;
            font-family: 'Nunito';
            font-weight: 800;
            color: var(--pal-dark-blue);
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

    /* Table Column Sizes */
    .rnk-col {
        width: 80px;
        text-align: center;
    }

    .name-col {
        font-size: clamp(1.5rem, 2.5vw, 3.5rem);
    }

    .sub-name {
        font-size: clamp(0.9rem, 1.5vw, 2rem);
        color: #888;
        font-weight: 600;
    }

    .reg-col {
        font-size: clamp(1.2rem, 2vw, 2.5rem);
        white-space: nowrap;
    }

    .score-col {
        font-size: clamp(2rem, 3.5vw, 5rem);
        color: var(--pal-blue);
        font-weight: 900;
        text-align: center;
    }

    .tens-col {
        font-size: clamp(1.2rem, 2vw, 2.5rem);
        text-align: center;
        color: #888;
    }

    .rank-num {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: clamp(40px, 6vh, 80px);
        height: clamp(40px, 6vh, 80px);
        border-radius: 50%;
        background: #eee;
        color: #555;
        font-weight: 900;
        font-size: clamp(1.2rem, 2.5vw, 3rem);
    }

    .rank-1 {
        background: var(--pal-gold);
        color: white;
        box-shadow: 0 5px 15px rgba(255, 180, 0, 0.4);
        transform: scale(1.1);
    }

    .rank-2 {
        background: #C0C0C0;
        color: white;
    }

    .rank-3 {
        background: #CD7F32;
        color: white;
    }

    /* --- FOOTER (TICKER) --- */
    .ticker-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 8vh;
        background: linear-gradient(to bottom, #ffffff, #f1f3f5);
        border-top: 0.5vh solid var(--pal-gold);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
    }

    .ticker-track {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5vw;
        width: 100%;
    }

    .footer-logo {
        height: 5vh;
        width: auto;
        object-fit: contain;
    }

    .back-btn {
        position: absolute;
        top: 3vh;
        left: 3vw;
        background: white;
        border: none;
        padding: 10px 20px;
        border-radius: 50px;
        font-family: 'Chakra Petch';
        font-weight: bold;
        font-size: clamp(1rem, 2vw, 1.5rem);
        cursor: pointer;
        box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        z-index: 20;
        color: var(--pal-blue);
    }

    .live-dot {
        display: inline-block;
        width: 1.5vh;
        height: 1.5vh;
        background: var(--pal-red);
        border-radius: 50%;
        margin-right: 10px;
        animation: blink 1s infinite;
    }

    @@keyframes blink {
        50% {
            opacity: 0.4;
        }
    }

    /* ========================================= */
    /*          MOBILE SPECIFIC OVERRIDES        */
    /* ========================================= */

    @@media (max-width: 768px) {
        .teams-grid {
            /* Stack vertically on mobile phones */
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto;
            gap: 20px;
        }

        .vs-separator {
            font-size: 2rem;
            margin: 10px 0;
        }

        .team-name {
            font-size: 2rem; /* Ensure names aren't tiny */
        }

        .team-points {
            font-size: 5rem; /* Readable score on phone */
        }

        .match-card {
            padding: 20px;
        }

        .ranking-card {
            padding: 15px;
        }

        .back-btn {
            top: 2vh;
            left: 2vw;
            padding: 5px 15px;
        }
    }

</style>

<div class="tv-screen">
    <button class="back-btn" onclick="history.back()">← BACK</button>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate Color="Color.Primary" Size="Size.Large" Style="margin-top:30vh; transform:scale(1.5);" />
    }
    else if (_event == null)
    {
        <h1 style="margin-top:20vh; color:var(--pal-red); font-family:var(--font-header); font-size: clamp(3rem, 5vw, 5rem);">EVENT NOT FOUND</h1>
    }
    else
    {
        <!-- HEADER -->
        <div class="match-info-container">
            <div class="sport-title">ARCHERY</div>
            <div class="match-meta">
                @_event.Level • @_event.Gender • @GetCleanCategory(_event.Subcategory)
            </div>
            @if (_event.IsFinished != true)
            {
                <div style="margin-top:1vh; font-family:'Chakra Petch'; color:var(--pal-red); font-weight:800; font-size:clamp(1rem, 2vw, 2.5rem);">
                    <span class="live-dot"></span> LIVE SCORING
                </div>
            }
        </div>

        @if (Is1440Round)
        {
            <!-- RANKING MODE (1440) -->
            <div class="ranking-card">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th class="rnk-col">RANK</th>
                            <th>ARCHER / TEAM</th>
                            <th>REGION</th>
                            <th style="text-align:center;">TENS</th>
                            <th style="text-align:center; color:var(--pal-blue);">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in _scoringRows.OrderBy(r => r.Rank == 0).ThenBy(r => r.Rank).ThenByDescending(r => r.TotalScore))
                        {
                            <tr>
                                <td class="rnk-col">
                                    <span class="rank-num @(row.Rank == 1 ? "rank-1" : row.Rank == 2 ? "rank-2" : row.Rank == 3 ? "rank-3" : "")">
                                        @(row.Rank > 0 ? row.Rank : "-")
                                    </span>
                                </td>
                                <td>
                                    <div class="name-col">@row.PlayerName</div>
                                    @if (!string.IsNullOrEmpty(row.TeamMembers))
                                    {
                                        <div class="sub-name">@row.TeamMembers</div>
                                    }
                                </td>
                                <td>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <img src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{Uri.EscapeDataString(row.LogoFilename)}.webp")"
                                             style="width:clamp(30px, 5vh, 50px); height:clamp(30px, 5vh, 50px); object-fit:contain;" onerror="this.style.display='none'" />
                                        <span class="reg-col">@row.RegionName</span>
                                    </div>
                                </td>
                                <td class="tens-col">@row.TensCount</td>
                                <td class="score-col">
                                    @row.TotalScore
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <!-- MATCH PLAY MODE (VS Cards) -->
            <div class="pairings-container">
                @foreach (var pairing in _teamPairings)
                {
                    <div class="match-card">
                        <div class="match-stage-label">
                            @(string.IsNullOrEmpty(pairing.MatchStage) ? "MATCH PLAY" : pairing.MatchStage)
                        </div>

                        <div class="teams-grid">
                            <!-- Team 1 -->
                            <div class="team-display">
                                <div class="logo-circle @(pairing.Team1MatchPoints > pairing.Team2MatchPoints ? "winning-glow" : "")">
                                    <img src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{Uri.EscapeDataString(pairing.Team1Logo)}.webp")"
                                         style="width:85%; height:85%; object-fit:contain;" onerror="this.style.display='none'" />
                                </div>
                                <div class="team-name">@pairing.Team1Name</div>
                                <div class="team-points @(pairing.Team1MatchPoints > pairing.Team2MatchPoints ? "points-lead" : "")">
                                    @pairing.Team1MatchPoints
                                </div>
                            </div>

                            <!-- VS -->
                            <div class="vs-separator">VS</div>

                            <!-- Team 2 -->
                            <div class="team-display">
                                <div class="logo-circle @(pairing.Team2MatchPoints > pairing.Team1MatchPoints ? "winning-glow" : "")">
                                    <img src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{Uri.EscapeDataString(pairing.Team2Logo)}.webp")"
                                         style="width:85%; height:85%; object-fit:contain;" onerror="this.style.display='none'" />
                                </div>
                                <div class="team-name">@pairing.Team2Name</div>
                                <div class="team-points @(pairing.Team2MatchPoints > pairing.Team1MatchPoints ? "points-lead" : "")">
                                    @pairing.Team2MatchPoints
                                </div>
                            </div>
                        </div>

                        <!-- SCORE HISTORY TABLE -->
                        <div class="history-section">
                            <table class="set-table">
                                <thead>
                                    <tr>
                                        <th class="team-col">TEAM</th>
                                        <th>END 1</th>
                                        <th>END 2</th>
                                        <th>END 3</th>
                                        <th>END 4</th>
                                        <th>END 5</th>
                                        <th>S.O.</th>
                                        <th class="total-col">ARROWS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Row 1 -->
                                    <tr>
                                        <td class="team-col">@pairing.Team1Name</td>
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            var s1 = pairing.SetScoresTeam1.ContainsKey(i) ? pairing.SetScoresTeam1[i] : 0;
                                            var s2 = pairing.SetScoresTeam2.ContainsKey(i) ? pairing.SetScoresTeam2[i] : 0;
                                            var css = (s1 > 0 && s1 > s2) ? "score-win" : "";
                                            <td><span class="@css">@(s1 > 0 ? s1.ToString() : "-")</span></td>
                                        }
                                        <td>-</td>
                                        <td class="total-col">@pairing.Team1TotalArrows</td>
                                    </tr>
                                    <!-- Row 2 -->
                                    <tr>
                                        <td class="team-col">@pairing.Team2Name</td>
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            var s1 = pairing.SetScoresTeam1.ContainsKey(i) ? pairing.SetScoresTeam1[i] : 0;
                                            var s2 = pairing.SetScoresTeam2.ContainsKey(i) ? pairing.SetScoresTeam2[i] : 0;
                                            var css = (s2 > 0 && s2 > s1) ? "score-win" : "";
                                            <td><span class="@css">@(s2 > 0 ? s2.ToString() : "-")</span></td>
                                        }
                                        <td>-</td>
                                        <td class="total-col">@pairing.Team2TotalArrows</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>
        }
    }

    <!-- FOOTER -->
    <div class="ticker-footer">
        <div class="ticker-track">
            <img src="/media/images/2031.png" class="footer-logo" alt="Palaro Logo" />
            <img src="/media/images/deped.png" class="footer-logo" alt="DepEd" />
            <img src="/media/images/bagongpilipinas.png" class="footer-logo" alt="Bagong Pilipinas" />
            <img src="/media/logo/Palarong Pambansa Logo.webp" onerror="this.src='/media/images/2031.png'" class="footer-logo" alt="Runner Logo" />
            <img src="/media/images/pgas.png" class="footer-logo" alt="LGU Agusan" />
        </div>
    </div>
</div>

@code {
    [Parameter] public string EventID { get; set; } = "";

    // --- DATA MODELS ---
    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Subcategory { get; set; }
        public string? Level { get; set; }
        public string? Gender { get; set; }
        public string? SportMainCat { get; set; }
        public string? EventStage { get; set; }
        public bool? IsFinished { get; set; }
        public string? Sport { get; set; }
        public List<EventVersus>? EventVersusList { get; set; }
    }

    public class EventVersus
    {
        public int ID { get; set; }
        public string? Score { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Rank { get; set; }
        public List<EventVersusTeamPlayers>? EventVersusTeamPlayersList { get; set; }
    }

    public class EventVersusTeamPlayers
    {
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
    }

    public class SchoolRegions
    {
        public int ID { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
    }

    public class ArcheryScoringDTO
    {
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
        public int ShotScore { get; set; }
        public int EndNo { get; set; }
        public bool IsX { get; set; }
        public bool Is10 { get; set; }
    }

    // --- VIEW MODELS ---
    public class ScoringRow
    {
        public int RegionID { get; set; }
        public string RegionName { get; set; } = "";
        public string LogoFilename { get; set; } = "";
        public string PlayerName { get; set; } = "";
        public string TeamMembers { get; set; } = "";
        public int TotalScore { get; set; }
        public int TensCount { get; set; }
        public int Rank { get; set; }
    }

    public class TeamPairing
    {
        public string MatchStage { get; set; } = "MATCH PLAY";
        public string Team1Name { get; set; } = "";
        public string Team1Logo { get; set; } = "";
        public string Team1Members { get; set; } = "";
        public int Team1RegionID { get; set; }
        public int Team1MatchPoints { get; set; }
        public int Team1TotalArrows { get; set; }
        public Dictionary<int, int> SetScoresTeam1 { get; set; } = new();

        public string Team2Name { get; set; } = "";
        public string Team2Logo { get; set; } = "";
        public string Team2Members { get; set; } = "";
        public int Team2RegionID { get; set; }
        public int Team2MatchPoints { get; set; }
        public int Team2TotalArrows { get; set; }
        public Dictionary<int, int> SetScoresTeam2 { get; set; } = new();
    }

    // --- STATE & LOGIC ---
    private EventInfo? _event;
    private List<ScoringRow> _scoringRows = new();
    private List<TeamPairing> _teamPairings = new();
    private List<SchoolRegions>? _allRegions;
    private bool _isLoading = true;
    private Timer? _timer;

    private bool Is1440Round => _event?.SportMainCat?.Contains("1440") == true || _event?.SportMainCat?.Contains("Quali") == true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _timer = new Timer(async _ => await InvokeAsync(LoadData), null, 3000, 3000);
    }

    public void Dispose() => _timer?.Dispose();

    private async Task LoadData()
    {
        try
        {
            if (_allRegions == null)
                _allRegions = await apiService.GetAsync<SchoolRegions>("/Schools/Regions");

            var events = await apiService.GetAsync<EventInfo>("/Events/Details");
            _event = events?.FirstOrDefault(e => e.ID == EventID && e.Sport == "Archery");

            if (_event == null) { _isLoading = false; return; }

            BuildBaseRows();

            var scores = await apiService.GetAsync<ArcheryScoringDTO>($"/score/ArcheryScoring/event/{EventID}");
            if (scores != null && scores.Any()) ProcessScores(scores);
            if (!Is1440Round) BuildPairings(scores);

            _isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            _isLoading = false;
        }
    }

    private void BuildBaseRows()
    {
        if (_scoringRows.Any()) return;
        if (_event?.EventVersusList != null)
        {
            foreach (var vs in _event.EventVersusList)
            {
                var reg = _allRegions?.FirstOrDefault(r => r.Region == vs.Region || r.Abbreviation == vs.Abbreviation);
                var members = vs.EventVersusTeamPlayersList?.Select(p => $"{p.FirstName} {p.LastName}").ToList() ?? new List<string>();
                _scoringRows.Add(new ScoringRow
                {
                    RegionID = reg?.ID ?? 0,
                    RegionName = reg?.Abbreviation ?? vs.Region ?? "TBD",
                    LogoFilename = reg?.Region ?? "Default",
                    PlayerName = vs.Region ?? "Team",
                    TeamMembers = string.Join(", ", members),
                    Rank = int.TryParse(vs.Rank, out int r) ? r : 0
                });
            }
        }
    }

    private void ProcessScores(List<ArcheryScoringDTO> scores)
    {
        foreach (var row in _scoringRows)
        {
            var teamScores = scores.Where(s => s.RegionID == row.RegionID).ToList();
            row.TotalScore = teamScores.Sum(s => s.ShotScore);
            row.TensCount = teamScores.Count(s => s.ShotScore == 10 || s.IsX || s.Is10);
        }
        var ranked = _scoringRows.OrderByDescending(r => r.TotalScore).ToList();
        int rank = 1;
        for (int i = 0; i < ranked.Count; i++) ranked[i].Rank = rank++;
    }

    private void BuildPairings(List<ArcheryScoringDTO>? allScores)
    {
        _teamPairings.Clear();
        int count = _scoringRows.Count;
        int pairs = (int)Math.Ceiling(count / 2.0);

        for (int i = 0; i < pairs; i++)
        {
            var t1 = _scoringRows.ElementAtOrDefault(i * 2);
            var t2 = _scoringRows.ElementAtOrDefault(i * 2 + 1);
            if (t1 == null) continue;

            var pair = new TeamPairing
            {
                MatchStage = _event?.EventStage ?? "MATCH",
                Team1Name = t1.RegionName,
                Team1Logo = t1.LogoFilename,
                Team1RegionID = t1.RegionID,
                Team1TotalArrows = t1.TotalScore,
                Team2Name = t2?.RegionName ?? "BYE",
                Team2Logo = t2?.LogoFilename ?? "Default",
                Team2RegionID = t2?.RegionID ?? 0,
                Team2TotalArrows = t2?.TotalScore ?? 0
            };

            if (allScores != null)
            {
                var t1Shots = allScores.Where(s => s.RegionID == t1.RegionID).ToList();
                pair.SetScoresTeam1 = t1Shots.GroupBy(s => s.EndNo).ToDictionary(g => g.Key, g => g.Sum(s => s.ShotScore));

                var t2Shots = t2 != null ? allScores.Where(s => s.RegionID == t2.RegionID).ToList() : new List<ArcheryScoringDTO>();
                pair.SetScoresTeam2 = t2Shots.GroupBy(s => s.EndNo).ToDictionary(g => g.Key, g => g.Sum(s => s.ShotScore));

                int maxSet = Math.Max(pair.SetScoresTeam1.Count > 0 ? pair.SetScoresTeam1.Keys.Max() : 0, pair.SetScoresTeam2.Count > 0 ? pair.SetScoresTeam2.Keys.Max() : 0);

                for (int set = 1; set <= maxSet; set++)
                {
                    int s1 = pair.SetScoresTeam1.ContainsKey(set) ? pair.SetScoresTeam1[set] : 0;
                    int s2 = pair.SetScoresTeam2.ContainsKey(set) ? pair.SetScoresTeam2[set] : 0;
                    if (s1 == 0 && s2 == 0) continue;
                    if (s1 > s2) pair.Team1MatchPoints += 2;
                    else if (s2 > s1) pair.Team2MatchPoints += 2;
                    else { pair.Team1MatchPoints += 1; pair.Team2MatchPoints += 1; }
                }
            }
            _teamPairings.Add(pair);
        }
    }

    private string GetCleanCategory(string? cat) => string.IsNullOrEmpty(cat) ? "Individual" : cat.Replace("Qualifying", "").Trim();
}