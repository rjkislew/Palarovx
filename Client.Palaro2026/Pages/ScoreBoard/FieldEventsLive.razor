@page "/scoreboard/field-events/{EventID}"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>Field Events Scoring | Palaro tu AgSur 2026</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@600;700&display=swap');

    :root {
        --bg-dark: #121212;
        --panel-bg: rgba(20, 20, 25, 0.9);
        --accent-gold: #FFD700;
        --accent-blue: #00B0FF;
        --accent-red: #FF1744;
        --text-white: #ffffff;
        --accent-green: #4CAF50;
        --accent-purple: #9C27B0;
    }

    body {
        background-color: black;
        overflow: hidden;
    }

    .tv-screen {
        min-height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at center, #1e1e24 0%, #000000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: 'Rajdhani', sans-serif;
        color: white;
        padding: 20px;
    }

    .tournament-header {
        text-align: center;
        margin-bottom: 2vh;
    }

    .palaro-branding {
        font-family: 'Orbitron', sans-serif;
        font-size: 2.5rem;
        color: var(--accent-gold);
        letter-spacing: 5px;
        font-weight: bold;
    }

    .sport-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 3rem;
        font-weight: 900;
    }

    .match-details {
        font-size: 1.5rem;
        color: #aaa;
        margin-top: 5px;
    }

    .scoreboard-card {
        width: 95%;
        max-width: 1400px;
        background: var(--panel-bg);
        border-radius: 25px;
        padding: 30px;
        margin-bottom: 3vh;
        text-align: center;
        font-size: 1.8rem;
        font-family: 'Rajdhani', sans-serif;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .status-badge {
        font-family: 'Orbitron', sans-serif;
        padding: 8px 30px;
        border-radius: 50px;
        font-size: 1.5rem;
        font-weight: bold;
    }

    .live {
        background: var(--accent-red);
        animation: pulse 1.5s infinite;
    }

    .finish {
        background: #00C853;
    }

    .category-badge {
        display: inline-block;
        margin-left: 15px;
        padding: 8px 20px;
        border-radius: 20px;
        font-family: 'Orbitron', sans-serif;
        font-size: 1.5rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .category-team {
        background: var(--accent-blue);
        color: white;
    }

    .category-mixed {
        background: var(--accent-purple);
        color: white;
    }

    .category-individual {
        background: var(--accent-green);
        color: white;
    }

    .results-table {
        width: 95%;
        max-width: 1400px;
        background: rgba(255,255,255,0.05);
        border-radius: 15px;
        padding: 20px;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1
        }

        50% {
            opacity: 0.7
        }
    }

    .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255,255,255,0.1);
        color: white;
        border: 1px solid #333;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

        .back-button:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

    .mixed-indicator {
        background: linear-gradient(45deg, #FFD700 0%, #9C27B0 50%, #00B0FF 100%);
        color: white;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.9rem;
        margin-left: 8px;
        font-weight: bold;
    }

    .team-indicator {
        background: var(--accent-blue);
        color: white;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.9rem;
        margin-left: 8px;
        font-weight: bold;
    }

    .individual-indicator {
        background: var(--accent-green);
        color: white;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.9rem;
        margin-left: 8px;
        font-weight: bold;
    }

    /* Gold, Silver, Bronze highlighting */
    .gold-row {
        background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05)) !important;
        border-left: 4px solid var(--accent-gold) !important;
    }

    .silver-row {
        background: linear-gradient(90deg, rgba(192, 192, 192, 0.15), rgba(192, 192, 192, 0.05)) !important;
        border-left: 4px solid #C0C0C0 !important;
    }

    .bronze-row {
        background: linear-gradient(90deg, rgba(205, 127, 50, 0.15), rgba(205, 127, 50, 0.05)) !important;
        border-left: 4px solid #CD7F32 !important;
    }

    .medal-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-weight: bold;
        margin-right: 10px;
    }

    .gold-badge {
        background: var(--accent-gold);
        color: #000;
    }

    .silver-badge {
        background: #C0C0C0;
        color: #000;
    }

    .bronze-badge {
        background: #CD7F32;
        color: white;
    }

    /* Field Events specific styling */
    .attempt-cell {
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
        text-align: center;
        font-size: 1.1rem;
    }

    .best-result-cell {
        font-family: 'Orbitron', sans-serif;
        font-weight: bold;
        text-align: center;
        font-size: 1.3rem;
        color: var(--accent-gold);
    }

    .region-flag {
        width: 30px;
        height: 30px;
        margin-right: 10px;
        border-radius: 50%;
        overflow: hidden;
        background: rgba(255,255,255,0.1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

        .region-flag img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

    /* Separator dot */
    .separator-dot {
        color: #666;
        font-size: 1.5rem;
    }
</style>

<div class="tv-screen">
    <button class="back-button" onclick="history.back()">← Back</button>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate Color="Color.Warning" Size="Size.Large" />
    }
    else if (_event == null)
    {
        <MudText Typo="Typo.h4" Color="Color.Error">EVENT NOT FOUND</MudText>
    }
    else
    {
        <div class="tournament-header">
            <div class="palaro-branding">PALARONG PAMBANSA 2026</div>
            <div class="sport-name">@_event.Subcategory</div>
            <div class="match-details">
                @if (_event.IsFinished == true)
                {
                    <div class="status-badge finish">FINISH</div>
                }
                else
                {
                    <div class="status-badge live">LIVE</div>
                }
            </div>
        </div>

        <div class="scoreboard-card">
            @_event.Sport
            <span class="separator-dot">•</span>
            @_event.Level
            <span class="separator-dot">•</span>
            @_event.Gender
            <span class="separator-dot">•</span>
            @_event.Subcategory
            @if (!string.IsNullOrEmpty(_event.Subcategory))
            {
                var categoryType = GetCategoryType(_event.Subcategory);
                <span class="category-badge @GetCategoryClass(categoryType)">
                    @categoryType
                </span>
            }
        </div>

        @if (_scoringRows.Any())
        {
            <div class="results-table">
                <MudTable Items="_scoringRows
                                                        .OrderByDescending(r => r.BestResult) // highest score first
                                                        .ThenBy(r => r.Rank)                  // optional: tie-break by rank if needed
                                                        .ToList()"
                  Dense Hover>
            <HeaderContent>
                <MudTh style=" font-size: 1.3rem;">Rank</MudTh>
                <MudTh style="  font-size: 1.3rem;">Athlete</MudTh>
                <MudTh style="  font-size: 1.3rem;">Region</MudTh>
                <MudTh style="text-align:center;  font-size: 1.3rem;">Attempt 1</MudTh>
                <MudTh style="text-align:center;  font-size: 1.3rem;">Attempt 2</MudTh>
                <MudTh style="text-align:center; font-size: 1.3rem;">Attempt 3</MudTh>
                <MudTh style="text-align:center; font-size: 1.3rem;">Best Result</MudTh>
            </HeaderContent>

                    <RowTemplate>
                        <MudTd>
                    @if (context.Rank > 0)
                            {
                                <span style="font-family: Orbitron; font-weight:bold; color:white; font-size: 1.3rem;">
                                    #@context.Rank
                                </span>
                            }
                            else
                            {
                                <span style="color: #666;">-</span>
                            }
                        </MudTd>
                        <MudTd>
                            <div style="font-weight: bold; font-size: 1.3rem;">@context.PlayerName</div>

                        </MudTd>
                        <MudTd>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="region-flag">
                                    <MudImage Src="@GetRegionLogo(context.RegionName)"
                                              ObjectFit="ObjectFit.Contain"
                                              Alt="@context.RegionName"
                                              Style="width:100%; height:100%;" />
                                </div>
                                <div style="font-weight:bold; font-size:1.3rem;">
                                    @context.RegionName
                                </div>
                            </div>
                        </MudTd>
                        <MudTd class="attempt-cell">
                            @(context.AttemptResults[0].HasValue ? context.AttemptResults[0].Value.ToString("F2") : "-")
                        </MudTd>
                        <MudTd class="attempt-cell">
                            @(context.AttemptResults[1].HasValue ? context.AttemptResults[1].Value.ToString("F2") : "-")
                        </MudTd>
                        <MudTd class="attempt-cell">
                            @(context.AttemptResults[2].HasValue ? context.AttemptResults[2].Value.ToString("F2") : "-")
                        </MudTd>
                        <MudTd style="font-family: Orbitron; font-weight:bold; color: var(--accent-gold); text-align:center; font-size: 1.3rem;">
                            @if (context.BestResult > 0)
                            {
                                @context.BestResult.ToString("F2")
                            }
                            else
                            {
                                <text>-</text>
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
        }
    }
</div>

@code {
    [Parameter] public string EventID { get; set; } = "";

    /* ===================== MODELS ===================== */

    public class EventDetailsDTO
    {
        public class Event
        {
            public string ID { get; set; } = null!;
            public string? EventStage { get; set; }
            public List<EventVersus>? EventVersusList { get; set; }
            public string? SportMainCat { get; set; }
            public string? Category { get; set; }
            public string? Sport { get; set; }
            public string? GamePhase { get; set; }
            public int? SubCategoryID { get; set; }
            public string? Subcategory { get; set; }
            public string? Gender { get; set; }
            public string? Level { get; set; }
            public string? Venue { get; set; }
            public decimal? Latitude { get; set; }
            public decimal? Longitude { get; set; }
            public DateTime? Date { get; set; }
            public TimeSpan? Time { get; set; }
            public bool? OnStream { get; set; }
            public string? StreamService { get; set; }
            public string? StreamURL { get; set; }
            public bool? IsFinished { get; set; }
            public bool? Archived { get; set; }
            public bool? Deleted { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }

        public class EventVersus
        {
            public int ID { get; set; }
            public string? Score { get; set; }
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
            public List<EventVersusTeamPlayers>? EventVersusTeamPlayersList { get; set; }
            public string? Rank { get; set; }
            public DateTime? RecentUpdateAt { get; set; }
        }

        public class EventVersusTeamPlayers
        {
            public int ID { get; set; }
            public int? EventVersusID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
            public string? School { get; set; }
        }
    }

    public class EventInfo
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Level { get; set; }
        public string? Gender { get; set; }
        public string? EventStage { get; set; }
        public int? RegionID { get; set; }
        public string? Abbreviation { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
        public bool? IsFinished { get; set; }
    }

    public class ScoringRow
    {
        public int RegionID { get; set; }
        public string RegionName { get; set; } = "";
        public string? PlayerID { get; set; }
        public string PlayerName { get; set; } = "";
        public decimal?[] AttemptResults { get; set; } = new decimal?[3];
        public decimal BestResult { get; set; }
        public int Rank { get; set; }
    }

    public class SchoolRegions
    {
        public int ID { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
    }

    public class FieldEventResult
    {
        public int RegionID { get; set; }
        public int AttemptNo { get; set; }
        public decimal Result { get; set; }
        public int? Rank { get; set; }
    }

    /* ===================== STATE ===================== */

    private EventInfo? _event;
    private List<ScoringRow> _scoringRows = new();
    private List<SchoolRegions>? _allRegions;
    private bool _isLoading = true;
    private Timer? _refreshTimer;
    private bool _debugMode = true; // Set to false in production

    /* ===================== INIT ===================== */

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"[FIELD EVENTS] Initializing for EventID: {EventID}");
        await LoadData();
        // Auto-refresh every 2 seconds for live updates
        _refreshTimer = new Timer(async _ => await InvokeAsync(LoadData), null, 2000, 2000);
    }

    /* ===================== GET DATA ===================== */

    private async Task LoadData()
    {
        try
        {
            if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Loading data for EventID: {EventID}");

            // Load regions
            _allRegions = await apiService.GetAsync<SchoolRegions>("/Schools/Regions");
            if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Regions loaded: {_allRegions?.Count ?? 0}");

            // LOAD EVENT DETAILS FROM /Events/Details ENDPOINT
            var allEvents = await apiService.GetAsync<EventDetailsDTO.Event>("/Events/Details");

            if (allEvents != null)
            {
                if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Total events from API: {allEvents.Count}");

                // Find the event by ID (regardless of sport)
                var eventDetails = allEvents.FirstOrDefault(e => e.ID == EventID);

                if (eventDetails != null)
                {
                    if (_debugMode)
                    {
                        Console.WriteLine($"[FIELD EVENTS SUCCESS] Found event {EventID}");
                        Console.WriteLine($"[FIELD EVENTS DETAILS] Sport: {eventDetails.Sport}");
                        Console.WriteLine($"[FIELD EVENTS DETAILS] Subcategory: {eventDetails.Subcategory}");
                        Console.WriteLine($"[FIELD EVENTS DETAILS] IsFinished: {eventDetails.IsFinished}");
                        Console.WriteLine($"[FIELD EVENTS DETAILS] Type of IsFinished: {eventDetails.IsFinished?.GetType()}");
                    }

                    // Map to EventInfo
                    _event = new EventInfo
                    {
                        ID = eventDetails.ID,
                        Sport = eventDetails.Sport,
                        Subcategory = eventDetails.Subcategory,
                        Level = eventDetails.Level,
                        Gender = eventDetails.Gender,
                        EventStage = eventDetails.EventStage,
                        // IMPORTANT: Get IsFinished from /Events/Details
                        IsFinished = eventDetails.IsFinished
                    };

                    if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Event object created with IsFinished: {_event.IsFinished}");
                }
                else
                {
                    if (_debugMode) Console.WriteLine($"[FIELD EVENTS ERROR] Event {EventID} not found in /Events/Details");
                    // Fallback to old API
                    await LoadEventFromFallback();
                }
            }
            else
            {
                if (_debugMode) Console.WriteLine($"[FIELD EVENTS ERROR] Could not load events from /Events/Details");
                await LoadEventFromFallback();
            }

            if (_event != null)
            {
                if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Loading scoring data for event: {_event.ID}");
                // Load scoring data from field events API
                await LoadScoringData();
            }
            else
            {
                if (_debugMode) Console.WriteLine($"[FIELD EVENTS ERROR] _event is null after loading");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[FIELD EVENTS ERROR] Error loading event: {ex.Message}");
            Console.WriteLine($"[FIELD EVENTS ERROR] Stack trace: {ex.StackTrace}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
            if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Data loading completed. IsLoading: {_isLoading}");
        }
    }

    private async Task LoadEventFromFallback()
    {
        if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Attempting fallback API...");

        // Fallback to old API if /Events/Details fails
        try
        {
            var events = await apiService.GetAsync<EventInfo>(
                $"FieldEvents/Sports/AthleticsFieldEvents?eventID={EventID}");

            if (events != null && events.Any())
            {
                _event = events.First();
                if (_debugMode) Console.WriteLine($"[FIELD EVENTS FALLBACK] Found event via fallback: {_event.ID}, IsFinished: {_event.IsFinished}");
            }
            else
            {
                if (_debugMode) Console.WriteLine($"[FIELD EVENTS FALLBACK] No events found via fallback API");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[FIELD EVENTS FALLBACK ERROR] Fallback API error: {ex.Message}");
        }
    }

    private async Task LoadScoringData()
    {
        if (_event == null) return;

        try
        {
            if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Loading scoring data...");

            // Clear existing rows
            _scoringRows.Clear();

            // Load athletes/participants for this event
            var participants = await apiService.GetAsync<EventInfo>(
                $"FieldEvents/Sports/AthleticsFieldEvents?eventID={_event.ID}");

            if (participants != null && participants.Any())
            {
                if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Participants loaded: {participants.Count}");

                // Populate scoring rows with participants
                PopulateScoringRows(participants);

                // Load saved results
                await LoadSavedResults();
            }
            else
            {
                if (_debugMode) Console.WriteLine($"[FIELD EVENTS] No participants found for this event");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[FIELD EVENTS ERROR] Error loading scoring data: {ex.Message}");
        }
    }

    private string GetRegionLogo(string regionName)
    {
        if (string.IsNullOrWhiteSpace(regionName))
            return "/images/region-placeholder.png";

        // Find the region by abbreviation or name
        var region = _allRegions?.FirstOrDefault(r =>
            r.Abbreviation?.Equals(regionName, StringComparison.OrdinalIgnoreCase) == true ||
            r.Region?.Equals(regionName, StringComparison.OrdinalIgnoreCase) == true);

        // Try to get the actual region name (not abbreviation) for the logo
        var actualRegionName = region?.Region ?? regionName;

        // Clean up the region name to match file naming conventions
        var cleanRegionName = CleanRegionName(actualRegionName);

        // Use Uri.EscapeDataString to properly encode the region name
        var encodedRegionName = Uri.EscapeDataString(cleanRegionName);

        if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Region logo: {regionName} -> {encodedRegionName}");

        return $"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{encodedRegionName}.webp";
    }

    private string CleanRegionName(string regionName)
    {
        if (string.IsNullOrWhiteSpace(regionName))
            return string.Empty;

        // Remove any characters that might cause issues in URLs
        return regionName.Trim();
    }

    private void PopulateScoringRows(List<EventInfo> events)
    {
        var regionMap = new Dictionary<int, ScoringRow>();

        foreach (var e in events)
        {
            if (!e.RegionID.HasValue) continue;

            var region = _allRegions?.FirstOrDefault(r => r.ID == e.RegionID.Value);
            if (region == null) continue;

            if (!regionMap.ContainsKey(region.ID))
            {
                regionMap[region.ID] = new ScoringRow
                {
                    RegionID = region.ID,
                    RegionName = region.Abbreviation ?? region.Region ?? "Unknown",
                    PlayerID = e.PlayerID,
                    PlayerName = e.PlayerName ?? "Unknown Athlete"
                };

                if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Added athlete: {e.PlayerName} from region: {region.Region}");
            }
        }

        _scoringRows = regionMap.Values.ToList();
        if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Total scoring rows: {_scoringRows.Count}");
    }

    private async Task LoadSavedResults()
    {
        if (_event == null) return;

        try
        {
            if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Loading saved results for event: {_event.ID}");

            var saved = await apiService.GetAsync<FieldEventResult>(
                $"FieldEvents/GetResults/{_event.ID}");

            if (saved != null && saved.Any())
            {
                if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Saved results loaded: {saved.Count}");

                // Initialize attempt results for all rows
                foreach (var r in _scoringRows)
                {
                    r.AttemptResults = new decimal?[3];
                    r.BestResult = 0;
                    r.Rank = 0;
                }

                foreach (var s in saved)
                {
                    var row = _scoringRows.FirstOrDefault(r => r.RegionID == s.RegionID);
                    if (row == null) continue;

                    if (s.AttemptNo >= 1 && s.AttemptNo <= 3)
                    {
                        row.AttemptResults[s.AttemptNo - 1] = s.Result;
                        if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Set attempt {s.AttemptNo} for region {s.RegionID}: {s.Result}");
                    }
                }

                // Calculate best results for each row
                _scoringRows.ForEach(CalculateBestResult);

                // Calculate rankings based on best results
                CalculateRankings();
            }
            else
            {
                if (_debugMode) Console.WriteLine($"[FIELD EVENTS] No saved results found");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[FIELD EVENTS ERROR] Error loading saved results: {ex.Message}");
        }
    }

    private void CalculateBestResult(ScoringRow row)
    {
        row.BestResult = row.AttemptResults.Where(r => r.HasValue).Select(r => r!.Value).DefaultIfEmpty(0).Max();
    }

    private void CalculateRankings()
    {
        // Reset all ranks
        foreach (var row in _scoringRows) row.Rank = 0;

        // Only rank rows with BestResult > 0
        var rankedRows = _scoringRows.Where(r => r.BestResult > 0)
                                     .OrderByDescending(r => r.BestResult)
                                     .ToList();

        if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Ranking {rankedRows.Count} rows with BestResult > 0");

        int currentRank = 1;

        for (int i = 0; i < rankedRows.Count; i++)
        {
            var row = rankedRows[i];

            if (i == 0)
            {
                // First place
                row.Rank = 1;
            }
            else
            {
                var previousRow = rankedRows[i - 1];

                if (row.BestResult == previousRow.BestResult)
                {
                    // Tie with previous - same rank
                    row.Rank = previousRow.Rank;
                }
                else
                {
                    // Different score - next sequential rank
                    row.Rank = currentRank + 1;
                }
            }

            currentRank = row.Rank;
            if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Rank {row.Rank}: {row.PlayerName} - {row.BestResult}");
        }

        // Sort back ascending by rank for display
        _scoringRows = _scoringRows.OrderBy(r => r.Rank > 0 ? r.Rank : int.MaxValue).ToList();
    }

    // Helper method to determine category type
    private string GetCategoryType(string? subcategory)
    {
        if (string.IsNullOrEmpty(subcategory))
            return "Individual";

        var subcategoryLower = subcategory.ToLower();

        if (subcategoryLower.Contains("mixed"))
            return "Mixed";
        else if (subcategoryLower.Contains("team"))
            return "Team";
        else
            return "Individual";
    }

    // Helper method to get CSS class for category badge
    private string GetCategoryClass(string categoryType)
    {
        return categoryType.ToLower() switch
        {
            "team" => "category-team",
            "mixed" => "category-mixed",
            "individual" => "category-individual",
            _ => "category-individual"
        };
    }

    private string GetRowClass(int rank)
    {
        return rank switch
        {
            1 => "gold-row",
            2 => "silver-row",
            3 => "bronze-row",
            _ => ""
        };
    }

    private string? GetMedalIcon(int rank)
    {
        return rank switch
        {
            1 => Icons.Material.Filled.EmojiEvents,
            2 => Icons.Material.Filled.MilitaryTech,
            3 => Icons.Material.Filled.WorkspacePremium,
            _ => null
        };
    }

    private string GetMedalIconClass(int rank)
    {
        return rank switch
        {
            1 => "gold-icon",
            2 => "silver-icon",
            3 => "bronze-icon",
            _ => ""
        };
    }

    private string GetMedalBadgeClass(int rank)
    {
        return rank switch
        {
            1 => "gold-badge",
            2 => "silver-badge",
            3 => "bronze-badge",
            _ => ""
        };
    }

    /* ===================== TEST FUNCTION ===================== */
    private async Task TestAPIConnection()
    {
        Console.WriteLine("=== TESTING API CONNECTION ===");
        try
        {
            var testEvents = await apiService.GetAsync<EventDetailsDTO.Event>("/Events/Details");
            Console.WriteLine($"API Test: Loaded {testEvents?.Count ?? 0} events");

            if (testEvents != null)
            {
                var myEvent = testEvents.FirstOrDefault(e => e.ID == EventID);
                if (myEvent != null)
                {
                    Console.WriteLine($"Found event: {myEvent.ID}");
                    Console.WriteLine($"Sport: {myEvent.Sport}");
                    Console.WriteLine($"Subcategory: {myEvent.Subcategory}");
                    Console.WriteLine($"IsFinished: {myEvent.IsFinished}");
                    Console.WriteLine($"IsFinished type: {myEvent.IsFinished?.GetType()}");
                    Console.WriteLine($"IsFinished == true: {myEvent.IsFinished == true}");
                    Console.WriteLine($"IsFinished == false: {myEvent.IsFinished == false}");
                    Console.WriteLine($"IsFinished is null: {myEvent.IsFinished == null}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"API Test Error: {ex.Message}");
        }
    }

    /* ===================== CLEANUP ===================== */

    public void Dispose()
    {
        _refreshTimer?.Dispose();
        if (_debugMode) Console.WriteLine($"[FIELD EVENTS] Component disposed for EventID: {EventID}");
    }
}