@page "/scoreboard/billiards"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>Billiards TV Dashboard | PALARO 2026</PageTitle>

<style>
    /* --- THEME IMPORTS (Standardized) --- */
    @@import url('https://fonts.cdnfonts.com/css/evil-empire');
    @@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Chakra+Petch:wght@600;700;800&display=swap');

    :root {
        --pal-blue: #023E8A;
        --pal-dark-blue: #001845;
        --pal-gold: #FFB400;
        --pal-red: #EA0000;
        --pal-white: #ffffff;
        --bg-gradient-start: #f8f9fa;
        --font-header: 'Evil Empire', sans-serif;
        --font-subheader: 'Chakra Petch', sans-serif;
        --font-body: 'Nunito', sans-serif;
    }

    body {
        background-color: var(--bg-gradient-start);
        margin: 0;
        font-family: var(--font-body);
        overflow-x: hidden;
    }

    .tv-screen-bg {
        min-height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at 50% 30%, #ffffff 0%, #e0e7ff 100%);
        padding-bottom: 50px;
    }

    /* --- HEADER --- */
    .dashboard-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 40px 0 30px 0;
    }

    .header-pill {
        background: var(--pal-dark-blue);
        border: 3px solid var(--pal-gold);
        padding: 20px 60px;
        border-radius: 50px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .main-event-title {
        font-family: var(--font-header);
        color: white;
        font-size: clamp(2rem, 4vw, 3.5rem);
        letter-spacing: 2px;
        margin: 0;
        line-height: 1;
        text-shadow: 2px 2px 0px black;
    }

    .sub-header-text {
        font-family: var(--font-subheader);
        color: var(--pal-gold);
        font-size: 1.1rem;
        letter-spacing: 3px;
        font-weight: 700;
        text-transform: uppercase;
        margin-top: 5px;
    }

    /* --- SEARCH --- */
    .search-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        padding: 0 20px;
    }

    .tv-search-field {
        width: 100%;
        max-width: 600px;
    }

        .tv-search-field .mud-input-control-input-container {
            background-color: white !important;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

    /* --- TABS --- */
    .mud-tabs-tabbar {
        background: transparent !important;
    }

    .mud-tab {
        font-family: var(--font-header) !important;
        font-size: 1.5rem !important;
        letter-spacing: 1px;
        color: #adb5bd !important;
    }

    .mud-tab-active {
        color: var(--pal-blue) !important;
    }

    .mud-tabs-indicator {
        background-color: var(--pal-gold) !important;
        height: 4px;
    }

    /* --- CATEGORY SECTION --- */
    .category-section {
        margin-bottom: 40px;
        background: white;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }

    .category-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--pal-gold);
    }

    .category-name {
        font-family: var(--font-header);
        font-size: 1.8rem;
        color: var(--pal-dark-blue);
        display: flex;
        align-items: center;
        gap: 10px;
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    .btn-carousel-gold {
        background-color: var(--pal-dark-blue);
        color: white;
        border: 2px solid var(--pal-gold);
        font-family: var(--font-subheader);
        font-weight: 700;
        font-size: 0.8rem;
        padding: 6px 20px;
        border-radius: 50px;
        text-decoration: none;
        transition: all 0.2s ease;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 5px;
    }

        .btn-carousel-gold:hover {
            background-color: var(--pal-gold);
            color: var(--pal-dark-blue);
            transform: scale(1.05);
        }

    /* --- MATCH CARDS --- */
    .match-link {
        text-decoration: none;
        display: block;
        height: 100%;
    }

    .tv-card {
        background-color: white;
        border: 1px solid #dee2e6;
        border-top: 5px solid var(--pal-blue);
        border-radius: 15px;
        padding: 15px;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

        .tv-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            border-top-color: var(--pal-gold);
        }

    .card-status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #f1f1f1;
        padding-bottom: 8px;
    }

    .live-badge {
        font-family: var(--font-subheader);
        font-weight: 800;
        font-size: 0.75rem;
        padding: 3px 12px;
        background: var(--pal-red);
        color: white;
        border-radius: 20px;
        letter-spacing: 1px;
    }

    .final-badge {
        font-family: var(--font-subheader);
        font-weight: 800;
        font-size: 0.75rem;
        padding: 3px 12px;
        background: #343a40;
        color: white;
        border-radius: 20px;
        letter-spacing: 1px;
    }

    .phase-text {
        font-family: var(--font-subheader);
        color: #6c757d;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .card-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-grow: 1;
        gap: 5px;
    }

    .player-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        text-align: center;
    }

    .logo-box-small {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: white;
        border: 2px solid #e9ecef;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.05);
    }

    .player-abbr {
        font-family: var(--font-subheader);
        font-size: 1rem;
        font-weight: 800;
        color: var(--pal-dark-blue);
        line-height: 1.1;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    .score-text {
        font-family: 'Corbel', sans-serif;
        font-size: 2.2rem;
        font-weight: 700;
        color: #495057;
        margin-top: 0px;
        line-height: 1;
    }

    .winner-text {
        color: var(--pal-blue);
        transform: scale(1.1);
        text-shadow: 0 0 1px rgba(0,0,0,0.1);
    }

    .winner-border {
        border-color: var(--pal-gold);
        box-shadow: 0 0 10px rgba(255, 180, 0, 0.3);
    }

    .vs-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 30px;
    }

    .vs-text {
        font-family: var(--font-subheader);
        font-size: 1rem;
        font-weight: 900;
        font-style: italic;
        color: #adb5bd;
    }

    .card-footer {
        text-align: center;
        margin-top: 12px;
        color: #6c757d;
        font-family: var(--font-subheader);
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        border-top: 1px solid #f1f1f1;
        padding-top: 8px;
    }
</style>

<div class="tv-screen-bg">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">

        <!-- HEADER -->
        <div class="dashboard-header">
            <div class="header-pill">
                <h1 class="main-event-title">BILLIARDS LIVE</h1>
                <div class="sub-header-text">OFFICIAL SCOREBOARD</div>
            </div>
        </div>

        <!-- SEARCH -->
        <div class="search-wrapper">
            <MudTextField @bind-Value="_searchString"
                          Placeholder="SEARCH PLAYER OR CATEGORY..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined"
                          Class="tv-search-field"
                          Immediate="true"
                          Clearable="true" />
        </div>

        @if (_isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="mt-16">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-4" Style="font-family:var(--font-header); color:var(--pal-blue);">LOADING BILLIARDS DATA...</MudText>
            </MudStack>
        }
        else
        {
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="mt-4" Centered="true">

                <!-- LIVE GAMES -->
                <MudTabPanel Text="LIVE MATCHES">
                    @{
                        var liveGames = _billiardsEvents
                        .Where(e => e.IsFinished != true)
                        .Where(e => FilterFunction(e))
                        .ToList();
                    }

                    @if (!liveGames.Any())
                    {
                        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-8" Elevation="0" Style="background: transparent;">
                            <MudIcon Icon="@Icons.Material.Filled.SportsBar" Size="Size.Large" Style="color: #dee2e6; width: 80px; height: 80px;" />
                            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #adb5bd; font-family:var(--font-header)">NO LIVE MATCHES</MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <!-- Group by Category (e.g., Secondary Boys 8-Ball) -->
                        @foreach (var group in liveGames.GroupBy(e => $"{e.Gender} {e.Subcategory}"))
                        {
                            <div class="category-section">
                                <div class="category-title-row">
                                    <div class="category-name">
                                        <MudIcon Icon="@Icons.Material.Filled.SportsBar" Style="color: var(--pal-gold); margin-right: 10px;" />
                                        @group.Key
                                    </div>
                                    <!-- Carousel Link -->
                                    <a href="/scoreboard/carousel/billiards/@(group.First().ID)" target="_blank" class="btn-carousel-gold">
                                        <MudIcon Icon="@Icons.Material.Filled.ViewCarousel" Size="Size.Small" /> CAROUSEL MODE
                                    </a>
                                </div>

                                <MudGrid Spacing="3">
                                    @foreach (var evt in group)
                                    {
                                        // SPLIT INTO PAIRS LOGIC
                                        // If an event has 4 players (Quarter Finals), we show 2 cards.
                                        if (evt.EventVersusList != null && evt.EventVersusList.Any())
                                        {
                                            int totalPlayers = evt.EventVersusList.Count;
                                            int pairs = (int)Math.Ceiling(totalPlayers / 2.0);

                                            for (int i = 0; i < pairs; i++)
                                            {
                                                var playerA = evt.EventVersusList.ElementAtOrDefault(i * 2);
                                                var playerB = evt.EventVersusList.ElementAtOrDefault(i * 2 + 1);

                                                int sA = GetScore(evt.ID, playerA?.Region);
                                                int sB = GetScore(evt.ID, playerB?.Region);
                                                bool leadA = sA > sB;
                                                bool leadB = sB > sA;

                                                <MudItem xs="12" sm="6" lg="4" xl="3">
                                                    <!-- Link to specific Pair Index -->
                                                    <a href="/scoreboard/billiards/@evt.ID?pair=@i" target="_blank" class="match-link">
                                                        <div class="tv-card">
                                                            <div class="card-status-bar">
                                                                <div class="live-badge">LIVE</div>
                                                                <div class="phase-text">@evt.EventStage</div>
                                                            </div>

                                                            <div class="card-content">
                                                                <!-- Player A -->
                                                                <div class="player-col">
                                                                    <div class="logo-box-small @(leadA ? "winner-border" : "")">
                                                                        <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{playerA?.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                                    </div>
                                                                    <div class="player-abbr @(leadA ? "winner-text" : "")">@(playerA?.Abbreviation ?? "TBD")</div>
                                                                    <div class="score-text @(leadA ? "winner-text" : "")">@sA</div>
                                                                </div>

                                                                <div class="vs-col"><div class="vs-text">VS</div></div>

                                                                <!-- Player B -->
                                                                <div class="player-col">
                                                                    <div class="logo-box-small @(leadB ? "winner-border" : "")">
                                                                        <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{playerB?.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                                    </div>
                                                                    <div class="player-abbr @(leadB ? "winner-text" : "")">@(playerB?.Abbreviation ?? "TBD")</div>
                                                                    <div class="score-text @(leadB ? "winner-text" : "")">@sB</div>
                                                                </div>
                                                            </div>

                                                            <div class="card-footer">
                                                                @evt.Level • @evt.Subcategory
                                                            </div>
                                                        </div>
                                                    </a>
                                                </MudItem>
                                            }
                                        }
                                    }
                                </MudGrid>
                            </div>
                        }
                    }
                </MudTabPanel>

                <!-- FINISHED GAMES -->
                <MudTabPanel Text="RECENT RESULTS">
                    @{
                        var finishedGames = _billiardsEvents
                        .Where(e => e.IsFinished == true)
                        .Where(e => FilterFunction(e))
                        .ToList();
                    }

                    @if (!finishedGames.Any())
                    {
                        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-8" Elevation="0" Style="background: transparent;">
                            <MudIcon Icon="@Icons.Material.Filled.HistoryToggleOff" Size="Size.Large" Style="color: #dee2e6;" />
                            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #adb5bd; font-family:var(--font-header)">NO RESULTS YET</MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudGrid Spacing="3">
                            @foreach (var evt in finishedGames)
                            {
                                if (evt.EventVersusList != null && evt.EventVersusList.Any())
                                {
                                    int pairs = (int)Math.Ceiling(evt.EventVersusList.Count / 2.0);
                                    for (int i = 0; i < pairs; i++)
                                    {
                                        var playerA = evt.EventVersusList.ElementAtOrDefault(i * 2);
                                        var playerB = evt.EventVersusList.ElementAtOrDefault(i * 2 + 1);

                                        int sA = GetScore(evt.ID, playerA?.Region);
                                        int sB = GetScore(evt.ID, playerB?.Region);
                                        bool winA = sA > sB;

                                        <MudItem xs="12" sm="6" lg="4" xl="3">
                                            <a href="/scoreboard/billiards/@evt.ID?pair=@i" target="_blank" class="match-link">
                                                <div class="tv-card" style="border-top-color: #6c757d; opacity: 0.9;">
                                                    <div class="card-status-bar">
                                                        <div class="final-badge">FINAL</div>
                                                        <div class="phase-text">@evt.EventStage</div>
                                                    </div>

                                                    <div class="card-content">
                                                        <div class="player-col">
                                                            <div class="logo-box-small @(winA ? "winner-border" : "")" style="@(!winA ? "filter:grayscale(1); opacity:0.6" : "")">
                                                                <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{playerA?.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                            </div>
                                                            <div class="player-abbr @(winA ? "winner-text" : "")" style="@(!winA ? "color:#adb5bd" : "")">@(playerA?.Abbreviation ?? "TBD")</div>
                                                            <div class="score-text @(winA ? "winner-text" : "")" style="@(!winA ? "color:#adb5bd" : "")">@sA</div>
                                                        </div>

                                                        <div class="vs-col"><div class="vs-text">VS</div></div>

                                                        <div class="player-col">
                                                            <div class="logo-box-small @(!winA && sB > sA ? "winner-border" : "")" style="@(winA ? "filter:grayscale(1); opacity:0.6" : "")">
                                                                <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{playerB?.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                            </div>
                                                            <div class="player-abbr @(!winA && sB > sA ? "winner-text" : "")" style="@(winA ? "color:#adb5bd" : "")">@(playerB?.Abbreviation ?? "TBD")</div>
                                                            <div class="score-text @(!winA && sB > sA ? "winner-text" : "")" style="@(winA ? "color:#adb5bd" : "")">@sB</div>
                                                        </div>
                                                    </div>

                                                    <div class="card-footer">
                                                        @evt.Level • @evt.Subcategory
                                                    </div>
                                                </div>
                                            </a>
                                        </MudItem>
                                    }
                                }
                            }
                        </MudGrid>
                    }
                </MudTabPanel>

            </MudTabs>
        }
    </MudContainer>
</div>

@code {
    private string _searchString = "";
    private bool _isLoading = true;
    private List<EventModel> _billiardsEvents = new();
    private List<ClientTeamMatchDTO> _scores = new();
    private Timer? _refreshTimer;

    // --- FILTER ---
    private bool FilterFunction(EventModel element)
    {
        if (string.IsNullOrWhiteSpace(_searchString)) return true;
        if (element.Subcategory?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        if (element.Gender?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;

        if (element.EventVersusList != null)
        {
            foreach (var team in element.EventVersusList)
            {
                if (team.Abbreviation?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
                if (team.Region?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
            }
        }
        return false;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _refreshTimer = new Timer(async _ => await InvokeAsync(LoadData), null, 3000, 3000);
    }

    private async Task LoadData()
    {
        try
        {
            var events = await apiService.GetAsync<EventModel>("/Events/Details");
            var scores = await apiService.GetAsync<ClientTeamMatchDTO>("score/TeamMatch");

            if (events != null)
            {
                _billiardsEvents = events
                    .Where(x => x.Sport == "Billiards")
                    .OrderByDescending(x => x.IsFinished == false)
                    .ThenBy(x => x.Subcategory)
                    .ToList();
            }

            if (scores != null) _scores = scores.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private int GetScore(string eventId, string? region)
    {
        if (string.IsNullOrEmpty(region)) return 0;
        return _scores.Where(s => s.EventID == eventId && s.Region == region).Sum(s => s.Score);
    }

    public void Dispose() => _refreshTimer?.Dispose();

    // --- MODELS ---
    public class EventModel
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Gender { get; set; }
        public string? EventStage { get; set; }
        public string? Level { get; set; }
        public string? Subcategory { get; set; }
        public bool? IsFinished { get; set; }
        public List<EventVersusTeams>? EventVersusList { get; set; }
    }

    public class EventVersusTeams
    {
        public string? Region { get; set; }
        public string? Abbreviation { get; set; } // Player Name or Code
    }

    public class ClientTeamMatchDTO
    {
        public string? EventID { get; set; }
        public string? Region { get; set; }
        public int Phase { get; set; }
        public int Score { get; set; }
    }
}