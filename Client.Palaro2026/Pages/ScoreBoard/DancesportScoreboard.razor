@page "/scoreboard/dancesport"
@layout NoMainLayout
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Dancesport | Palaro tu AgSur 2026</PageTitle>

<style>
    /* --- FONTS & VARS (MATCHING BILLIARDS THEME) --- */
    @@import url('https://fonts.cdnfonts.com/css/evil-empire');
    @@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Chakra+Petch:wght@600;700;800&display=swap');

    :root {
        --pal-blue: #023E8A;
        --pal-dark-blue: #001845;
        --pal-gold: #FFB400;
        --pal-red: #EA0000;
        --bg-gradient-start: #f8f9fa;
        --card-bg: #ffffff;
        --font-header: 'Evil Empire', sans-serif;
        --font-score: 'Chakra Petch', sans-serif;
        --font-body: 'Nunito', sans-serif;
    }

    html, body {
        height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 0;
        background-color: var(--bg-gradient-start);
        font-family: var(--font-body);
        overflow-x: hidden;
    }

    .dashboard-container {
        min-height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at 50% 30%, #ffffff 0%, #e0e7ff 100%);
        position: relative;
        padding: 2vh 4vw 10vh 4vw;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* --- HEADER --- */
    .header-pill {
        background: var(--pal-dark-blue);
        border: 3px solid var(--pal-gold);
        padding: 1vh 4vw;
        border-radius: 50px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        margin-bottom: 3vh;
        z-index: 10;
        min-width: 40vw;
    }

    .event-title {
        font-family: var(--font-header);
        color: white;
        font-size: clamp(40px, 6vh, 70px);
        line-height: 1;
        letter-spacing: 2px;
        text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
    }

    .event-sub {
        font-family: var(--font-score);
        color: var(--pal-gold);
        font-size: clamp(16px, 2.5vh, 24px);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* --- TABS --- */
    .custom-tabs {
        width: 100%;
        max-width: 1200px;
    }

    .mud-tabs-tabbar {
        background-color: transparent !important;
        border-bottom: 2px solid rgba(0,24,69,0.1);
        margin-bottom: 2vh;
    }

    .mud-tab {
        font-family: var(--font-header) !important;
        font-size: 1.5rem !important;
        color: var(--pal-blue) !important;
        letter-spacing: 1px;
    }

    .mud-tab-active {
        color: var(--pal-gold) !important;
        font-weight: bold;
        text-shadow: 1px 1px 0 var(--pal-dark-blue);
    }

    .mud-tabs-indicator {
        background-color: var(--pal-gold) !important;
        height: 4px !important;
    }

    /* --- EVENT CARD --- */
    .dancesport-card {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.2s;
        border: 1px solid #e0e0e0;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
        cursor: pointer;
    }

        .dancesport-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(2, 62, 138, 0.15);
            border-color: var(--pal-gold);
        }

    /* Card Header */
    .card-header {
        background: var(--pal-dark-blue);
        padding: 1.5vh 1.5vw;
        position: relative;
        border-bottom: 4px solid var(--pal-gold);
    }

    .category-title {
        font-family: var(--font-header);
        color: white;
        font-size: clamp(24px, 3vh, 32px);
        line-height: 1;
        margin-bottom: 4px;
    }

    .category-sub {
        font-family: var(--font-body);
        color: var(--pal-gold);
        font-size: 0.9rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .status-pill {
        position: absolute;
        top: 1.5vh;
        right: 1.5vw;
        padding: 4px 12px;
        border-radius: 20px;
        font-family: var(--font-score);
        font-weight: 700;
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    .status-live {
        background: var(--pal-red);
        color: white;
        animation: pulse 2s infinite;
    }

    .status-final {
        background: var(--pal-gold);
        color: var(--pal-dark-blue);
    }

    @@keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }

        100% {
            opacity: 1;
        }
    }

    /* Card Body */
    .card-body {
        padding: 2vh 1.5vw;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1.5vh;
    }

    .stage-badge {
        align-self: flex-start;
        background: #edf2f7;
        color: var(--pal-blue);
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        font-weight: 700;
        font-family: var(--font-score);
        border: 1px solid #cbd5e0;
    }

    /* Leaderboard in Card */
    .leaderboard-mini {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .couple-row {
        display: grid;
        grid-template-columns: 40px 1fr auto;
        align-items: center;
        background: #f8f9fa;
        padding: 8px;
        border-radius: 10px;
        border-left: 4px solid #ccc;
    }

    .rank-box {
        font-family: var(--font-header);
        font-size: 1.5rem;
        text-align: center;
        color: #555;
    }

    .couple-info {
        padding: 0 10px;
        display: flex;
        flex-direction: column;
    }

    .couple-region {
        font-family: var(--font-body);
        font-weight: 800;
        color: var(--pal-dark-blue);
        font-size: 0.9rem;
        line-height: 1.1;
    }

    .couple-names {
        font-size: 0.75rem;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
    }

    .couple-score {
        font-family: var(--font-score);
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--pal-blue);
    }

    /* Rank Colors */
    .rank-1 {
        border-left-color: var(--pal-gold);
        background: rgba(255, 180, 0, 0.1);
    }

        .rank-1 .rank-box {
            color: #b8860b;
        }

    .rank-2 {
        border-left-color: #C0C0C0;
    }

        .rank-2 .rank-box {
            color: #7f8c8d;
        }

    .rank-3 {
        border-left-color: #CD7F32;
    }

        .rank-3 .rank-box {
            color: #a0522d;
        }

    /* FOOTER (Same as Billiards) */
    .ticker-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 7vh;
        background: linear-gradient(to bottom, #ffffff, #f1f3f5);
        border-top: 3px solid var(--pal-gold);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
    }

    .ticker-track {
        display: flex;
        gap: 4vw;
        height: 100%;
        align-items: center;
    }

    .footer-logo {
        height: 4vh;
        width: auto;
    }
</style>

<div class="dashboard-container">

    <!-- HEADER -->
    <div class="header-pill">
        <div class="event-title">DANCESPORT</div>
        <div class="event-sub">PALARONG PAMBANSA 2026</div>
    </div>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="mt-16" />
    }
    else
    {
        <MudTabs Class="custom-tabs" Rounded="true" Centered="true" KeepPanelsAlive="true">

            <!-- LIVE EVENTS -->
            <MudTabPanel Text="LIVE EVENTS">
                <div class="py-4">
                    @{
                        var liveEvents = _dancesportEvents.Where(e => !e.IsFinished).ToList();
                    }

                    @if (!liveEvents.Any())
                    {
                        <div style="text-align:center; padding: 5vh; color:#999;">
                            <MudIcon Icon="@Icons.Material.Filled.EventBusy" Size="Size.Large" />
                            <div style="font-family: var(--font-header); font-size: 1.5rem; margin-top:10px;">NO LIVE EVENTS</div>
                        </div>
                    }
                    else
                    {
                        <MudGrid>
                            @foreach (var evt in liveEvents)
                            {
                                <MudItem xs="12" md="6" lg="4">
                                    <div class="dancesport-card" @onclick="() => NavigateToEvent(evt.ID)">
                                        <div class="card-header">
                                            <div class="category-title">@GetCategoryShort(evt.MainCategory)</div>
                                            <div class="category-sub">@GetSchoolLevelName(evt.LevelID) • @GetGenderName(evt.GenderID)</div>
                                            <div class="status-pill status-live">● LIVE</div>
                                        </div>
                                        <div class="card-body">
                                            <div class="stage-badge">STAGE: @GetEventStageName(evt.StageID)</div>

                                            <div class="leaderboard-mini">
                                                <div style="font-family:var(--font-score); font-size:0.8rem; color:#888; margin-bottom:5px;">CURRENT LEADERS</div>
                                                @foreach (var couple in GetTopCouples(evt.ID, 3))
                                                {
                                                    <div class="couple-row @($"rank-{couple.Rank}")">
                                                        <div class="rank-box">@couple.Rank</div>
                                                        <div class="couple-info">
                                                            <div class="couple-region">@couple.Region</div>
                                                            <div class="couple-names">@string.Join(" & ", couple.Dancers)</div>
                                                        </div>
                                                        <div class="couple-score">@couple.TotalScore</div>
                                                    </div>
                                                }
                                                @if (!GetTopCouples(evt.ID, 1).Any())
                                                {
                                                    <div style="text-align:center; color:#ccc; padding:10px;">Waiting for scores...</div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </div>
            </MudTabPanel>

            <!-- COMPLETED -->
            <MudTabPanel Text="OFFICIAL RESULTS">
                <div class="py-4">
                    @{
                        var finishedEvents = _dancesportEvents.Where(e => e.IsFinished).OrderByDescending(e => e.ID).ToList();
                    }

                    @if (!finishedEvents.Any())
                    {
                        <div style="text-align:center; padding: 5vh; color:#999;">
                            <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Large" />
                            <div style="font-family: var(--font-header); font-size: 1.5rem; margin-top:10px;">NO RESULTS YET</div>
                        </div>
                    }
                    else
                    {
                        <MudGrid>
                            @foreach (var evt in finishedEvents)
                            {
                                <MudItem xs="12" md="6" lg="4">
                                    <div class="dancesport-card" @onclick="() => NavigateToEvent(evt.ID)">
                                        <div class="card-header">
                                            <div class="category-title">@GetCategoryShort(evt.MainCategory)</div>
                                            <div class="category-sub">@GetSchoolLevelName(evt.LevelID) • @GetGenderName(evt.GenderID)</div>
                                            <div class="status-pill status-final">FINAL</div>
                                        </div>
                                        <div class="card-body">
                                            <div class="stage-badge">CHAMPION DECLARED</div>

                                            <div class="leaderboard-mini">
                                                @foreach (var couple in GetTopCouples(evt.ID, 3))
                                                {
                                                    <div class="couple-row @($"rank-{couple.Rank}")">
                                                        <div class="rank-box">@couple.Rank</div>
                                                        <div class="couple-info">
                                                            <div class="couple-region">@couple.Region</div>
                                                            <div class="couple-names">@string.Join(" & ", couple.Dancers)</div>
                                                        </div>
                                                        <div class="couple-score">@couple.TotalScore</div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </div>
            </MudTabPanel>

        </MudTabs>
    }

    <!-- FOOTER -->
    <div class="ticker-footer">
        <div class="ticker-track">
            <img src="/media/images/2031.png" class="footer-logo" />
            <img src="/media/images/deped.png" class="footer-logo" />
            <img src="/media/images/bagongpilipinas.png" class="footer-logo" />
            <img src="/media/logo/Palarong Pambansa Logo.webp" onerror="this.src='/media/images/2031.png'" class="footer-logo" />
            <img src="/media/images/pgas.png" class="footer-logo" />
        </div>
    </div>

</div>

@code {
    // --- MODELS ---
    public class PerformanceEvent { public int ID { get; set; } public string MainCategory { get; set; } = ""; public int? LevelID { get; set; } public int? GenderID { get; set; } public int? StageID { get; set; } public bool IsFinished { get; set; } }
    public class PerformanceTeam { public int PerformanceID { get; set; } public int? TeamID { get; set; } public int RegionID { get; set; } public string PlayerID { get; set; } = ""; }
    public class PerformanceScores { public int PerformanceID { get; set; } public int? TeamID { get; set; } public decimal Score { get; set; } public int Rank { get; set; } public int SportSubcategoryID { get; set; } }
    public class SchoolRegion { public int ID { get; set; } public string Region { get; set; } = ""; public string Abbreviation { get; set; } = ""; }
    public class Player { public string ID { get; set; } = ""; public string FirstName { get; set; } = ""; public string LastName { get; set; } = ""; }
    public class CoupleDisplay { public string Region { get; set; } = ""; public List<string> Dancers { get; set; } = new(); public int Rank { get; set; } public int TotalScore { get; set; } }

    // --- STATE ---
    private List<PerformanceEvent> _dancesportEvents = new();
    private List<PerformanceTeam> _allOpposingTeams = new();
    private List<PerformanceScores> _allDancesportScores = new();
    private List<SchoolRegion> _schoolRegions = new();
    private List<Player> _allPlayers = new();
    private bool _isLoading = true;
    private bool _staticDataLoaded = false;
    private Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
        // Refresh only dynamic data every 15 seconds (reduced from 10)
        _timer = new Timer(async _ => await InvokeAsync(RefreshDynamicData), null, 15000, 15000);
    }

    private async Task LoadInitialData()
    {
        _isLoading = true;
        try
        {
            // Load static data once (regions and players don't change frequently)
            var regionsTask = apiService.GetAsync<SchoolRegion>("/Schools/Regions");
            var playersTask = apiService.GetAsync<Player>("/Profiles/Player");

            await Task.WhenAll(regionsTask, playersTask);

            _schoolRegions = (await regionsTask) ?? new();
            _allPlayers = (await playersTask) ?? new();
            _staticDataLoaded = true;

            // Load dynamic data
            await RefreshDynamicData();
        }
        catch { }
        finally { _isLoading = false; StateHasChanged(); }
    }

    private async Task RefreshDynamicData()
    {
        try
        {
            // Only refresh event-related data that changes
            var eventsTask = apiService.GetAsync<PerformanceEvent>("/PerformanceBased/PerformanceEvents?sportID=10");
            var teamsTask = apiService.GetAsync<PerformanceTeam>("/PerformanceBased/OpposingTeams");
            var scoresTask = apiService.GetAsync<PerformanceScores>("/PerformanceScore/Scores");

            await Task.WhenAll(eventsTask, teamsTask, scoresTask);

            var events = await eventsTask;
            if (events != null) _dancesportEvents = events.OrderBy(x => x.IsFinished).ToList();

            var teams = await teamsTask;
            if (teams != null)
            {
                // Filter only dancesport-related teams
                var eventIds = _dancesportEvents.Select(e => e.ID).ToHashSet();
                _allOpposingTeams = teams.Where(t => eventIds.Contains(t.PerformanceID)).ToList();
            }

            var scores = await scoresTask;
            if (scores != null)
            {
                // Filter only dancesport-related scores
                var eventIds = _dancesportEvents.Select(e => e.ID).ToHashSet();
                _allDancesportScores = scores.Where(s => eventIds.Contains(s.PerformanceID)).ToList();
            }

            StateHasChanged();
        }
        catch { }
    }

    public void Dispose() => _timer?.Dispose();

    // --- NAVIGATION ---
    private void NavigateToEvent(int eventId)
    {
        Navigation.NavigateTo($"/scoreboard/dancesport/{eventId}");
    }

    // --- HELPERS ---
    private string GetCategoryShort(string cat) => cat.Contains("Latin") ? "LATIN" : (cat.Contains("Standard") ? "STANDARD" : "DANCESPORT");

    private string GetSchoolLevelName(int? id) => id switch { 1 => "ELEMENTARY", 2 => "SECONDARY", _ => "OPEN" };

    private string GetGenderName(int? id) => id switch { 1 => "MALE", 2 => "FEMALE", 3 => "MIXED", _ => "" };

    private string GetEventStageName(int? id) => id switch { 4 => "FINALS", 3 => "SEMI-FINALS", _ => "QUALIFIERS" };

    private List<CoupleDisplay> GetTopCouples(int eventId, int limit)
    {
        var result = new List<CoupleDisplay>();
        // Group teams to form couples
        var couples = _allOpposingTeams.Where(t => t.PerformanceID == eventId).GroupBy(t => new { t.RegionID, t.TeamID });

        foreach (var c in couples)
        {
            var reg = _schoolRegions.FirstOrDefault(r => r.ID == c.Key.RegionID)?.Abbreviation ?? "REG";
            var pIds = c.Select(x => x.PlayerID).ToList();
            var names = _allPlayers.Where(p => pIds.Contains(p.ID)).Select(p => $"{p.FirstName?[0]}. {p.LastName}").ToList();

            // Calculate Rank based on lowest Rank (Best) or specific logic
            var teamScores = _allDancesportScores.Where(s => s.PerformanceID == eventId && s.TeamID == c.Key.TeamID).ToList();
            int rank = teamScores.Any() ? teamScores.Min(s => s.Rank) : 99; // Simple rank logic
            int score = teamScores.Any() ? (int)teamScores.Sum(s => s.Score) : 0;

            if (rank < 99) // Only show ranked
            {
                result.Add(new CoupleDisplay { Region = reg, Dancers = names, Rank = rank, TotalScore = score });
            }
        }

        return result.OrderBy(x => x.Rank).Take(limit).ToList();
    }
}