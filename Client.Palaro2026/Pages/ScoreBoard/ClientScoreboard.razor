@page "/scoreboard/client/{EventID}"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@implements IDisposable
@layout NoMainLayout

<PageTitle>TV Broadcast | PALARO 2026</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&family=Chakra+Petch:wght@600;700;800&display=swap');

    :root {
        --bg-black: #000000;
        --card-bg: #0a0a0a;
        --border-color: #333333;
        --accent-gold: #FFD700;
        --accent-red: #FF0000;
        --text-white: #ffffff;
        --table-border: #444;
    }

    body {
        background-color: var(--bg-black);
        margin: 0;
        overflow: hidden;
        font-family: 'Rajdhani', sans-serif;
    }

    .tv-screen {
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 2vh;
        color: var(--text-white);
        box-sizing: border-box;
        background: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000000 70%);
        position: relative;
    }

    .palaro-main-logo {
        position: absolute;
        top: 30px;
        left: 40px;
        height: 14vh;
        min-height: 120px;
        width: auto;
        z-index: 100;
        filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.2));
    }

    .tournament-header {
        text-align: center;
        margin-bottom: 2vh;
        z-index: 10;
        width: 70%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .main-event-title {
        font-family: 'Orbitron', sans-serif;
        color: var(--accent-gold);
        font-size: clamp(1.5rem, 3vh, 2.5rem);
        font-weight: 900;
        letter-spacing: 6px;
        margin: 0 0 5px 0;
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        padding-bottom: 10px;
        width: 100%;
        text-align: center;
    }

    .sport-name {
        font-family: 'Orbitron', sans-serif;
        font-size: clamp(2rem, 5vh, 4rem);
        font-weight: 800;
        text-transform: uppercase;
        color: white;
        letter-spacing: 2px;
        line-height: 1.2;
        margin-top: 5px;
    }

    .match-details {
        font-family: 'Chakra Petch', sans-serif;
        font-size: clamp(1rem, 2vh, 1.4rem);
        color: #aaa;
        text-transform: uppercase;
        letter-spacing: 3px;
        font-weight: 600;
    }

    .scoreboard-card {
        display: grid;
        grid-template-columns: 1fr 2fr auto 2fr 1fr;
        grid-template-rows: auto 1fr;
        align-items: center;
        width: 96vw;
        flex-grow: 1;
        max-height: 65vh; 
        position: relative;
        background-color: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 30px;
        padding: 0 2vw;
        box-shadow: 0 0 60px rgba(0,0,0,0.9);
        margin-top: 1vh;
        overflow: visible; 
    }

    .team-panel {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        position: relative;
        z-index: 2;
        transition: transform 0.5s ease;
    }

    .team-a { grid-column: 1; grid-row: 2; }
    .team-b { grid-column: 5; grid-row: 2; }

    .is-winner { transform: scale(1.05); }
    .is-loser { filter: grayscale(100%) opacity(0.5); }

    .winner-badge {
        position: absolute;
        top: -30px;
        background-color: var(--accent-gold);
        color: black;
        font-family: 'Orbitron', sans-serif;
        font-weight: 900;
        font-size: 1.2rem;
        padding: 5px 25px;
        border-radius: 4px;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        z-index: 100;
        letter-spacing: 2px;
        animation: pop-in 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        white-space: nowrap;
    }

    @@keyframes pop-in {
        0% { transform: scale(0) translateY(20px); opacity: 0; }
        100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    .logo-container {
        height: clamp(100px, 16vh, 200px);
        width: clamp(100px, 16vh, 200px);
        margin-bottom: 1vh;
        position: relative;
    }

    .logo-box {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: #151515;
        border: 1px solid #333;
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .is-winner .logo-box {
        border-color: var(--accent-gold);
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
    }

    .team-abbr {
        font-family: 'Chakra Petch', sans-serif;
        font-size: clamp(2rem, 4vw, 3.5rem);
        font-weight: 800;
        margin-top: 1vh;
        line-height: 1;
        color: white;
    }

    .is-winner .team-abbr {
        color: var(--accent-gold);
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    .team-sub {
        font-size: clamp(0.8rem, 1vw, 1.1rem);
        color: #666;
        letter-spacing: 2px;
        font-weight: 600;
        text-transform: uppercase;
        margin-top: 5px;
        text-align: center;
    }

    .center-info-column {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        grid-column: 1 / -1;
        grid-row: 1;
        z-index: 20;
        padding-top: 1vh;
    }

    .status-badge {
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 800;
        font-size: clamp(1.2rem, 2.5vh, 2rem);
        padding: 5px 30px;
        background: #000;
        border: 2px solid #333;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 3px;
        color: white;
        margin-bottom: 1vh;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }

    .live {
        border-color: var(--accent-red);
        background: linear-gradient(180deg, #1a0000 0%, #000000 100%);
        color: var(--accent-red);
        text-shadow: 0 0 10px rgba(255,0,0,0.4);
    }

    .live-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        background: var(--accent-red);
        border-radius: 50%;
        margin-right: 10px;
        animation: blink 1.5s infinite;
    }

    .final {
        border-color: #00ff00;
        background: #001a00;
        color: #00ff00;
    }

    .sets-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgba(255, 255, 255, 0.05);
        padding: 5px 20px;
        border-radius: 8px;
        border: 1px solid #333;
        margin-bottom: 0.5vh;
    }

    .sets-label {
        font-size: 0.8rem;
        color: #888;
        letter-spacing: 2px;
        font-weight: 700;
        margin-bottom: -5px;
    }

    .sets-score {
        font-family: 'Orbitron', sans-serif;
        font-size: 2.5rem;
        font-weight: 900;
        color: white;
    }

    /* Scores */
    .score-container {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        z-index: 5;
        position: relative; /* Needed for absolute positioning of ball */
    }

    .score-a { grid-column: 2; grid-row: 2; }
    .score-b { grid-column: 4; grid-row: 2; }

    .score-text {
        font-family: 'Orbitron', sans-serif;
        font-weight: 900;
        font-size: clamp(8rem, 20vw, 35vh);
        line-height: 1;
        color: white;
        text-align: center;
        width: 100%;
    }

    .score-text.winner-score { color: var(--accent-gold); }

    /* ---- BASKETBALL ANIMATION ---- */
    .basket-ball-anim {
        position: absolute;
        top: -50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: clamp(5rem, 15vw, 20vh);
        z-index: 200;
        pointer-events: none;
        animation: shoot-ball 0.8s ease-in forwards;
        opacity: 0;
    }

    @@keyframes shoot-ball {
        0% {
            top: -100px;
            transform: translate(-50%, -50%) scale(0.5);
            opacity: 0;
        }
        50% {
            top: 40%;
            transform: translate(-50%, -50%) scale(1.2);
            opacity: 1;
        }
        70% {
            top: 55%;
            transform: translate(-50%, -50%) scale(0.9);
            opacity: 1;
        }
        100% {
            top: 150%;
            transform: translate(-50%, -50%) scale(0.5);
            opacity: 0;
        }
    }
    /* ----------------------------- */

    .vs-container {
        grid-column: 3;
        grid-row: 2;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        pointer-events: none;
        padding: 0 12px;
    }

    .vs-bg {
        width: 60px;
        height: 60px;
        background: #0f0f0f;
        border: 2px solid rgba(255, 215, 0, 0.35);
        transform: rotate(45deg);
        box-shadow: 0 0 26px rgba(255, 215, 0, 0.12);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .vs-text {
        font-family: 'Chakra Petch';
        font-size: 1.8rem;
        font-weight: 900;
        color: rgba(255,255,255,0.55);
        font-style: italic;
        transform: rotate(-45deg);
    }

    /* --- TABLE (HISTORY) --- */
    .history-strip {
        width: 96vw;
        margin-top: 15px;
        display: flex;
        justify-content: center;
        z-index: 1;
    }

    .history-card {
        background: #0f0f0f;
        border: 2px solid #333;
        border-radius: 15px;
        padding: 5px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        overflow: hidden;
    }

    .history-table {
        border-collapse: collapse;
        width: 100%;
        min-width: 600px; 
    }

    .history-table th {
        background: #1a1a1a;
        color: #888;
        font-family: 'Chakra Petch';
        font-size: 1rem;
        padding: 10px 15px;
        border: 1px solid var(--table-border);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .history-table td {
        font-family: 'Orbitron';
        font-size: 1.5rem;
        color: #eee;
        text-align: center;
        padding: 10px 20px;
        border: 1px solid var(--table-border);
    }

    .history-table td.team-name-cell {
        text-align: left;
        font-weight: 800;
        background: #111;
        width: 150px;
        color: white;
        border-right: 2px solid #555; 
    }

    .history-table td.team-name-cell.winner-row { color: var(--accent-gold); }

    .history-table td.phase-score { background: #0a0a0a; }

    .history-table td.active-phase {
        background: #222;
        color: var(--accent-gold);
        border: 1px solid var(--accent-gold);
    }

    .history-table th.total-header {
        background: #222;
        color: white;
        border-left: 2px solid #555;
    }

    .history-table td.total-cell {
        background: #151515;
        color: var(--accent-gold);
        font-weight: 900;
        font-size: 1.8rem;
        border-left: 2px solid #555;
    }

    /* MOBILE ADJUSTMENTS */
    @@media screen and (max-aspect-ratio: 1/1) {
        body { overflow-y: auto; }
        .tv-screen { height: auto; min-height: 100vh; padding: 10px 0 50px 0; background: black; justify-content: flex-start; }
        .palaro-main-logo { position: relative; top: auto; left: auto; height: 100px; margin: 0 auto 10px auto; }
        .tournament-header { width: 95%; margin-bottom: 10px; }
        .main-event-title { font-size: 1.5rem; letter-spacing: 2px; }
        .sport-name { font-size: 2rem; }
        .scoreboard-card { display: grid; grid-template-columns: 2fr 1fr; grid-template-rows: auto auto auto auto; gap: 10px; width: 95%; height: auto; max-height: none; padding: 10px; background: transparent; border: none; box-shadow: none; margin-top: 0; overflow: visible; }
        .winner-badge { top: -10px; right: 10px; left: auto; font-size: 0.9rem; padding: 2px 10px; }
        .center-info-column { position: relative; grid-column: 1 / -1; grid-row: 1; padding-top: 0; }
        .status-badge { font-size: 1rem; padding: 6px 18px; }
        .sets-display { margin-top: 8px; background: #111; padding: 8px 10px; width: 100%; }
        .sets-score { font-size: 1.5rem; }
        .team-a, .team-b { grid-column: 1; width: 100%; flex-direction: row; justify-content: flex-start; padding: 10px; background: #111; border: 1px solid #222; border-radius: 10px; }
        .team-a { grid-row: 2; }
        .team-b { grid-row: 4; }
        .score-a, .score-b { grid-column: 2; width: 100%; background: #000; border: 1px solid #222; border-radius: 10px; }
        .score-a { grid-row: 2; }
        .score-b { grid-row: 4; }
        .vs-container { grid-column: 1 / -1; grid-row: 3; margin: -6px 0; padding: 0; }
        .vs-bg { width: 36px; height: 36px; background: #222; }
        .vs-text { font-size: 1rem; }
        .logo-container { height: 46px; width: 46px; margin: 0 10px 0 0; }
        .logo-box { padding: 2px; border: none; background: transparent; }
        .team-abbr { font-size: 1.8rem; margin: 0; text-align: left; }
        .team-sub { display: none; }
        .score-text { font-size: 3.5rem; }
        .basket-ball-anim { font-size: 5rem; } /* Smaller ball on mobile */
        .history-strip { width: 95%; overflow-x: auto; display: block; }
        .history-card { border: none; background: transparent; padding: 0; box-shadow: none; }
        .history-table { min-width: 400px; border: 1px solid #333; }
        .history-table th { font-size: 0.8rem; padding: 5px; }
        .history-table td { font-size: 1.2rem; padding: 5px; }
        .history-table td.team-name-cell { width: auto; font-size: 1rem; }
    }

    @@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
</style>

<div class="tv-screen">
    <img src="~/media/images/palaro2026.png" class="palaro-main-logo" alt="Palaro Logo" onerror="this.style.display='none'" />

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Info" Size="Size.Large" Style="margin-top:40vh;" />
    }
    else if (_event == null)
    {
        <MudText Typo="Typo.h3" Color="Color.Error" Style="margin-top:40vh; font-family:'Orbitron'">NO SIGNAL</MudText>
    }
    else
    {
        bool showSets = IsSetBasedSport(_event.Sport);

        <div class="tournament-header">
            <div class="main-event-title">PALARONG PAMBANSA 2026</div>
            <div class="sport-name">@_event.Sport</div>
            <div class="match-details">
                @_event.Gender / @_event.Subcategory / @_event.EventStage
            </div>
        </div>

        <div class="scoreboard-card">
            <div class="center-info-column">
                @if (IsGameFinished())
                {
                    <div class="status-badge final">FINISHED</div>
                }
                else
                {
                    <div class="status-badge live"><span class="live-dot"></span>LIVE</div>
                }

                @if (showSets)
                {
                    <div class="sets-display">
                        <span class="sets-label">SETS</span>
                        <div class="sets-score">
                            <span style="@(IsTeamAWinner() ? "color:var(--accent-gold)" : "")">@_scoreSetsA</span>
                            <span style="opacity:0.3; margin:0 5px;">-</span>
                            <span style="@(IsTeamBWinner() ? "color:var(--accent-gold)" : "")">@_scoreSetsB</span>
                        </div>
                    </div>
                }
            </div>

            <!-- TEAM A -->
            <div class="team-panel team-a @(IsTeamAWinner() ? "is-winner" : (IsGameFinished() ? "is-loser" : ""))">
                @if (IsGameFinished() && IsTeamAWinner()) { <div class="winner-badge">WINNER</div> }
                <div class="logo-container">
                    <div class="logo-box">
                        <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{_teamA?.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                    </div>
                </div>
                <div class="team-abbr">@_teamA?.Abbreviation</div>
                <div class="team-sub">@_teamA?.Region</div>
            </div>

            <!-- SCORE A -->
            <div class="score-container score-a">
                @if (_showAnimA)
                {
                    <div class="basket-ball-anim">🏀</div>
                }
                <div class="score-text @(IsTeamAWinner() ? "winner-score" : "")">
                    @_displayPointsA
                </div>
            </div>

            <!-- VS -->
            <div class="vs-container">
                <div class="vs-bg"><div class="vs-text">VS</div></div>
            </div>

            <!-- SCORE B -->
            <div class="score-container score-b">
                 @if (_showAnimB)
                {
                    <div class="basket-ball-anim">🏀</div>
                }
                <div class="score-text @(IsTeamBWinner() ? "winner-score" : "")">
                    @_displayPointsB
                </div>
            </div>

            <!-- TEAM B -->
            <div class="team-panel team-b @(IsTeamBWinner() ? "is-winner" : (IsGameFinished() ? "is-loser" : ""))">
                @if (IsGameFinished() && IsTeamBWinner()) { <div class="winner-badge">WINNER</div> }
                <div class="logo-container">
                    <div class="logo-box">
                        <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{_teamB?.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                    </div>
                </div>
                <div class="team-abbr">@_teamB?.Abbreviation</div>
                <div class="team-sub">@_teamB?.Region</div>
            </div>
        </div>

        @if (_maxPhase > 0)
        {
            <div class="history-strip">
                <div class="history-card">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th style="text-align:left; border-right:2px solid #555;">TEAM</th>
                                @for (int i = 1; i <= _maxPhase; i++)
                                {
                                    <th>@GetPhaseHeader(_event.Sport, i)</th>
                                }
                                <th class="total-header">@(IsSetBasedSport(_event.Sport) ? "SETS" : "TOTAL")</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="team-name-cell @(IsTeamAWinner() ? "winner-row" : "")">@_teamA?.Abbreviation</td>
                                @for (int i = 1; i <= _maxPhase; i++)
                                {
                                    <td class="phase-score @(IsCurrentPhase(i) ? "active-phase" : "")">
                                        @GetPhaseScore(_teamA?.Region, i)
                                    </td>
                                }
                                <td class="total-cell">@(IsSetBasedSport(_event.Sport) ? _scoreSetsA : _displayPointsA)</td>
                            </tr>
                            <tr>
                                <td class="team-name-cell @(IsTeamBWinner() ? "winner-row" : "")">@_teamB?.Abbreviation</td>
                                @for (int i = 1; i <= _maxPhase; i++)
                                {
                                    <td class="phase-score @(IsCurrentPhase(i) ? "active-phase" : "")">
                                        @GetPhaseScore(_teamB?.Region, i)
                                    </td>
                                }
                                <td class="total-cell">@(IsSetBasedSport(_event.Sport) ? _scoreSetsB : _displayPointsB)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public string EventID { get; set; } = "";

    public class EventModel
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? EventStage { get; set; }
        public bool? IsFinished { get; set; }
        public List<EventVersusTeams>? EventVersusList { get; set; }
    }

    public class EventVersusTeams
    {
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
    }

    public class ClientTeamMatchDTO
    {
        public string? EventID { get; set; }
        public string? Region { get; set; }
        public int Phase { get; set; }
        public int Score { get; set; }
    }

    private EventModel? _event;
    private List<ClientTeamMatchDTO> _matches = new();
    private EventVersusTeams? _teamA;
    private EventVersusTeams? _teamB;

    private int _displayPointsA;
    private int _displayPointsB;
    
    // Previous Scores for Animation
    private int _prevPointsA = -1;
    private int _prevPointsB = -1;

    // Animation Triggers
    private bool _showAnimA = false;
    private bool _showAnimB = false;

    private int _scoreSetsA;
    private int _scoreSetsB;
    private int _maxPhase = 1;

    private bool _isLoading = true;
    private bool _isRefreshing = false;
    private bool _firstLoad = true;
    private Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _timer = new Timer(_ => _ = InvokeAsync(LoadDataSafe), null, 1500, 1500);
    }

    private async Task LoadDataSafe()
    {
        try { await LoadData(); }
        catch (Exception ex) { Console.WriteLine($"Timer error: {ex.Message}"); }
    }

    private async Task LoadData()
    {
        if (_isRefreshing) return;
        try
        {
            _isRefreshing = true;
            var eventDetails = await apiService.GetAsync<EventModel>($"/Events/Details/{EventID}");
            _event = eventDetails?.FirstOrDefault();

            if (_event != null && _event.EventVersusList?.Count == 2)
            {
                _teamA = _event.EventVersusList[0];
                _teamB = _event.EventVersusList[1];
            }

            var allMatches = await apiService.GetAsync<ClientTeamMatchDTO>($"score/TeamMatch?eventId={EventID}");
            _matches = allMatches?.ToList() ?? new();

            if (_matches.Any())
            {
                _maxPhase = _matches.Max(m => m.Phase);
                CalculateScores();
            }
            else
            {
                _maxPhase = 1; _displayPointsA = 0; _displayPointsB = 0; _scoreSetsA = 0; _scoreSetsB = 0;
            }
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        finally 
        { 
            _isLoading = false; 
            _isRefreshing = false; 
            _firstLoad = false;
            StateHasChanged(); 
        }
    }

    private void CalculateScores()
    {
        if (_event == null || _teamA == null || _teamB == null) return;
        if (IsSetBasedSport(_event.Sport))
        {
            _scoreSetsA = 0; _scoreSetsB = 0;
            for (int i = 1; i <= _maxPhase; i++)
            {
                if (i < _maxPhase || _event.IsFinished == true)
                {
                    int sA = GetPhaseScore(_teamA.Region, i);
                    int sB = GetPhaseScore(_teamB.Region, i);
                    if (sA > sB) _scoreSetsA++; else if (sB > sA) _scoreSetsB++;
                }
            }
            _displayPointsA = GetPhaseScore(_teamA.Region, _maxPhase);
            _displayPointsB = GetPhaseScore(_teamB.Region, _maxPhase);
        }
        else
        {
            // Total Score Calculation (Basketball etc.)
            int currentTotalA = _matches.Where(m => m.Region == _teamA.Region).Sum(m => m.Score);
            int currentTotalB = _matches.Where(m => m.Region == _teamB.Region).Sum(m => m.Score);

            // ANIMATION LOGIC FOR BASKETBALL
            if (!_firstLoad && (_event.Sport?.ToLower().Contains("basket") == true))
            {
                if (_prevPointsA != -1 && currentTotalA > _prevPointsA)
                {
                    TriggerAnimationA();
                }
                if (_prevPointsB != -1 && currentTotalB > _prevPointsB)
                {
                    TriggerAnimationB();
                }
            }

            // Update display and memory
            _displayPointsA = currentTotalA;
            _displayPointsB = currentTotalB;
            _prevPointsA = currentTotalA;
            _prevPointsB = currentTotalB;
        }
    }

    private async void TriggerAnimationA()
    {
        _showAnimA = true;
        StateHasChanged();
        await Task.Delay(1000); // Matches CSS duration
        _showAnimA = false;
        StateHasChanged();
    }

    private async void TriggerAnimationB()
    {
        _showAnimB = true;
        StateHasChanged();
        await Task.Delay(1000);
        _showAnimB = false;
        StateHasChanged();
    }

    private bool IsSetBasedSport(string? sport)
    {
        if (string.IsNullOrEmpty(sport)) return false;
        var s = sport.ToLower();
        return s.Contains("volley") || s.Contains("badminton") || s.Contains("tennis") || s.Contains("sepak") || s.Contains("table") || s.Contains("billiard");
    }

    private bool IsGameFinished() => _event?.IsFinished == true;

    private bool IsTeamAWinner()
    {
        if (!IsGameFinished() || _event == null) return false;
        if (IsSetBasedSport(_event.Sport)) return _scoreSetsA > _scoreSetsB;
        return _displayPointsA > _displayPointsB;
    }

    private bool IsTeamBWinner()
    {
        if (!IsGameFinished() || _event == null) return false;
        if (IsSetBasedSport(_event.Sport)) return _scoreSetsB > _scoreSetsA;
        return _displayPointsB > _displayPointsA;
    }

    private int GetPhaseScore(string? region, int phase) => _matches.FirstOrDefault(m => m.Region == region && m.Phase == phase)?.Score ?? 0;

    private string GetPhaseHeader(string? sport, int phase)
    {
        var s = sport?.ToLower() ?? "";
        if (s.Contains("basket"))
        {
            if (phase <= 4) return $"Q{phase}";
            if (phase == 5) return "OT";
            return $"{phase - 4}OT";
        }
        if (s.Contains("base") || s.Contains("soft")) return $"INN {phase}";
        return $"SET {phase}";
    }

    private bool IsCurrentPhase(int phase) => phase == _maxPhase && !IsGameFinished();

    public void Dispose() => _timer?.Dispose();
}