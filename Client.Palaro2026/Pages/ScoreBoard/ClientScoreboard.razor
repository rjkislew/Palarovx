@page "/scoreboard/client/{EventID}"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@implements IDisposable
@layout NoMainLayout

<PageTitle>@(_cleanSportName ?? "Live") | PALARO 2026</PageTitle>

<style>
    /* --- FONTS & VARS --- */
    @@import url('https://fonts.cdnfonts.com/css/evil-empire');
    @@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Chakra+Petch:wght@600;700;800&display=swap');

    :root {
        --pal-blue: #023E8A;
        --pal-dark-blue: #001845;
        --pal-gold: #FFB400;
        --pal-red: #EA0000;
        --bg-gradient-start: #f8f9fa;
        --card-bg: rgba(255, 255, 255, 0.95);
        --font-header: 'Evil Empire', sans-serif;
        --font-body: 'Avenir Book', 'Avenir', 'Nunito', sans-serif;
    }

    html, body {
        height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: var(--bg-gradient-start);
        font-family: var(--font-body);
    }

    .scoreboard-container {
        height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at 50% 30%, #ffffff 0%, #e0e7ff 100%);
        position: relative;
        padding: 4vh 8vw 10vh 8vw;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    /* --- FOOTER --- */
    .ticker-footer {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 7vh;
        background: linear-gradient(to bottom, #ffffff, #f1f3f5);
        border-top: 3px solid var(--pal-gold);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
    }

    .ticker-track {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4vw;
        width: 100%;
        height: 100%;
    }

    .footer-logo {
        height: 3vh;
        width: auto;
        object-fit: contain;
        filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
    }

    /* --- MATCH INFO --- */
    .match-info-container {
        text-align: center;
        margin-bottom: 5vh;
        padding: 40px 60px;
        border-radius: 40px;
        background: var(--pal-dark-blue);
        border: 3px solid var(--pal-gold);
        flex-shrink: 0;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .sport-title {
        font-family: var(--font-header);
        font-size: clamp(30px, 6vh, 70px);
        font-weight: 400;
        color: white;
        text-transform: uppercase;
        letter-spacing: 2px;
        line-height: 1;
        text-shadow: 2px 2px 0px #000000;
    }

    .match-meta {
        font-family: 'Chakra Petch', sans-serif;
        font-size: clamp(14px, 2.5vh, 25px);
        color: var(--pal-gold);
        letter-spacing: 2px;
        font-weight: 700;
        text-transform: uppercase;
    }

    /* --- MATCH CARD --- */
    .match-card {
        display: grid;
        grid-template-columns: 1fr 1fr 0.4fr 1fr 1fr;
        grid-template-rows: 1fr auto;
        grid-template-areas:
            "teamA scoreA center scoreB teamB"
            "history history history history history";
        align-items: center;
        width: 100%;
        height: auto;
        min-height: 55vh;
        background: var(--card-bg);
        border: 1px solid #d1d9e6;
        border-top: 5px solid var(--pal-gold);
        border-bottom: 5px solid var(--pal-blue);
        box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        border-radius: 30px;
        padding: 2vh 1vw;
        position: relative;
    }

    .area-team-a {
        grid-area: teamA;
    }

    .area-score-a {
        grid-area: scoreA;
    }

    .area-center {
        grid-area: center;
    }

    .area-score-b {
        grid-area: scoreB;
    }

    .area-team-b {
        grid-area: teamB;
    }

    .area-history {
        grid-area: history;
    }

    .team-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .logo-circle {
        width: clamp(90px, 16vh, 200px);
        height: clamp(90px, 16vh, 200px);
        background: white;
        border-radius: 50%;
        border: 5px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .winner-glow {
        border-color: var(--pal-gold);
        box-shadow: 0 0 25px rgba(255, 180, 0, 0.4);
    }

    .team-name {
        font-family: var(--font-header);
        font-size: clamp(20px, 4.5vh, 50px);
        font-weight: 400;
        color: var(--pal-dark-blue);
        line-height: 1.2;
        letter-spacing: 2px;
        margin-top: 2vh;
        margin-bottom: 1vh;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .team-region {
        font-family: var(--font-body);
        font-size: clamp(12px, 2vh, 40px);
        color: var(--pal-blue);
        text-transform: uppercase;
        font-weight: 700;
    }

    .score-col {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        height: 100%;
    }

    .main-score {
        font-family: 'Corbel', sans-serif;
        font-size: clamp(100px, 14vw, 400px);
        font-weight: 700;
        color: #455a64;
        line-height: 0.8;
        letter-spacing: -4px;
        z-index: 10;
        position: relative;
    }

    .score-winner {
        color: var(--pal-dark-blue);
        text-shadow: 5px 5px 0px rgba(255, 180, 0, 0.2);
    }

    .center-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1vh;
        z-index: 5;
    }

    .status-badge {
        padding: 5px 25px;
        border-radius: 50px;
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 700;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        font-size: clamp(14px, 2.2vh, 28px);
        background: var(--pal-red);
        border: 2px solid white;
        color: white;
        white-space: nowrap;
        box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    .sets-score {
        font-family: var(--font-body);
        font-size: clamp(35px, 6vh, 80px);
        color: var(--pal-dark-blue);
        font-weight: 800;
        white-space: nowrap;
        letter-spacing: -1px;
    }

    .vs-text {
        font-family: var(--font-subheader);
        font-size: 3vh;
        color: #90a4ae;
        font-style: italic;
        font-weight: 900;
    }

    /* HISTORY */
    .history-strip {
        grid-area: history;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        margin-top: 2vh;
        border-top: 1px solid rgba(0, 24, 69, 0.1);
        padding-top: 2vh;
    }

    .box-score-container {
        overflow-x: auto;
        max-width: 100%;
        display: flex;
        justify-content: center;
    }

    .history-table {
        border-collapse: collapse;
        text-align: center;
    }

        .history-table th {
            padding: 0 1.5vw 1vh 1.5vw;
            color: #90a4ae;
            font-family: 'Chakra Petch', sans-serif;
            font-size: clamp(12px, 1.8vh, 18px);
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 2px solid var(--pal-gold);
        }

        .history-table td {
            padding: 1.5vh 1.5vw 0 1.5vw;
            color: var(--pal-dark-blue);
            font-family: 'Nunito', sans-serif;
            font-size: clamp(16px, 2.5vh, 28px);
            font-weight: 800;
        }

    .team-head {
        text-align: right;
        padding-right: 2vw;
    }

    .team-abbr {
        text-align: right;
        padding-right: 2vw;
        font-weight: 700;
        color: var(--pal-blue);
    }

    .set-win {
        color: var(--pal-red) !important;
    }

    /* ========================================= */
    /*          ANIMATION STYLES                 */
    /* ========================================= */

    .anim-object {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 20;
        font-size: clamp(4rem, 10vw, 15rem);
        opacity: 0;
    }

    /* 1. BASKETBALL (Swoosh up and in) */
    .anim-active-basketball {
        animation: basket-swoosh 1s ease-in-out forwards;
    }

    @@keyframes basket-swoosh {
        0% {
            transform: translate(-50%, 150%) scale(0.5);
            opacity: 0;
        }

        40% {
            transform: translate(-50%, -80%) scale(1.2);
            opacity: 1;
        }

        60% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        100% {
            transform: translate(-50%, 50%) scale(0.8);
            opacity: 0;
        }
    }

    /* 2. VOLLEYBALL (Spike Down) */
    .anim-active-volleyball {
        animation: volley-spike 0.7s ease-in forwards;
    }

    @@keyframes volley-spike {
        0% {
            transform: translate(-50%, -200%) scale(0.5);
            opacity: 0;
        }

        40% {
            transform: translate(-50%, -100%) scale(1.5);
            opacity: 1;
        }

        60% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        /* HIT */
        80% {
            transform: translate(-50%, -20%) scale(0.9);
            opacity: 1;
        }
        /* Bounce Up */
        100% {
            transform: translate(-50%, 100%) scale(0.5);
            opacity: 0;
        }
    }

    /* 3. BADMINTON (Diagonal Smash) */
    .anim-active-badminton {
        animation: badminton-smash 0.6s linear forwards;
    }

    @@keyframes badminton-smash {
        0% {
            transform: translate(150%, -150%) rotate(45deg) scale(0.5);
            opacity: 0;
        }

        50% {
            transform: translate(-50%, -50%) rotate(0deg) scale(1.3);
            opacity: 1;
        }
        /* HIT */
        100% {
            transform: translate(-200%, 200%) rotate(-45deg) scale(0.5);
            opacity: 0;
        }
    }

    /* 4. TABLE TENNIS (Fast Zip/Bounce) */
    .anim-active-tabletennis {
        animation: pingpong-zip 0.5s cubic-bezier(0,1.27,.43,.84) forwards;
    }

    @@keyframes pingpong-zip {
        0% {
            transform: translate(-150%, -50%) scale(0.5);
            opacity: 0;
        }

        50% {
            transform: translate(0%, -50%) scale(1.2);
            opacity: 1;
        }

        100% {
            transform: translate(150%, -50%) scale(0.8);
            opacity: 0;
        }
    }

    /* 5. GENERIC POP (Flash) */
    .anim-active-pop .main-score {
        animation: score-pop 0.5s ease-out;
    }

    .anim-text-plus {
        position: absolute;
        top: 20%;
        right: 10%;
        font-family: 'Chakra Petch';
        font-weight: 900;
        color: var(--pal-gold);
        font-size: clamp(2rem, 5vw, 4rem);
        text-shadow: 0 0 10px rgba(0,0,0,0.5);
        opacity: 0;
        z-index: 25;
    }

    .anim-active-pop .anim-text-plus {
        animation: float-up 0.8s ease-out forwards;
    }

    @@keyframes score-pop {
        0% {
            transform: scale(1);
            color: var(--pal-gold);
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
        }
    }

    @@keyframes float-up {
        0% {
            transform: translateY(20px);
            opacity: 0;
        }

        50% {
            opacity: 1;
        }

        100% {
            transform: translateY(-50px);
            opacity: 0;
        }
    }

    /* RESPONSIVE */
    @@media (max-width: 1024px) {
        .scoreboard-container {
            padding: 2vh 3vw 12vh 3vw;
            height: 100vh;
        }

        .ticker-footer {
            height: 6vh;
        }

        .footer-logo {
            height: 2.5vh;
        }

        .match-card {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto auto auto;
            grid-template-areas: "center center" "teamA teamB" "scoreA scoreB" "history history";
            gap: 1vh 2vw;
            padding: 2vh 3vw;
            min-height: auto;
            transform: scale(0.95);
        }

        .main-score {
            font-size: 140px;
        }

        .history-strip {
            margin-top: 1vh;
            padding-top: 1vh;
        }
    }
</style>

<div class="scoreboard-container">

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Style="color: #023E8A;" Size="Size.Large" />
    }
    else if (_event == null)
    {
        <MudStack AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.TvOff" Style="color: #b0bec5; width: 10vh; height: 10vh;" />
            <MudText Typo="Typo.h4" Style="color:#001845; font-family:'Evil Empire'">NO SIGNAL</MudText>
        </MudStack>
    }
    else
    {
        <div class="match-info-container">
            <div class="sport-title">@_cleanSportName</div>
            <div class="match-meta">
                @_schoolLevel • @_event.Gender • @_event.EventStage
            </div>
        </div>

        <div class="match-card">
            <!-- Center -->
            <div class="center-col area-center">
                @if (!string.IsNullOrEmpty(_phaseText))
                {
                    <div class="status-badge">@_phaseText</div>
                }
                <div class="vs-text">VS</div>
                @if (_isSetGame)
                {
                    <div class="sets-container">
                        <div class="sets-score">@_setsA - @_setsB</div>
                    </div>
                }
            </div>

            <!-- Team A -->
            <div class="team-col area-team-a">
                <div class="logo-circle @(_isWinnerA ? "winner-glow" : "")">
                    <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{_teamA?.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:250%; height:250%;" />
                </div>
                <div class="team-name">@_teamA?.Abbreviation</div>
                <div class="team-region">@_teamA?.Region</div>
            </div>

            <!-- Score A -->
            <div class="score-col area-score-a @(_showAnimA && string.IsNullOrEmpty(_sportIcon) ? "anim-active-pop" : "")">

                @if (_showAnimA && !string.IsNullOrEmpty(_sportIcon))
                {
                    <div class="anim-object @GetAnimClass(_event.Sport)">@_sportIcon</div>
                }
                else if (_showAnimA)
                {
                    <div class="anim-text-plus">+POINT</div>
                }

                <div class="main-score @(_isWinnerA ? "score-winner" : "")">@_displayScoreA</div>
            </div>

            <!-- Score B -->
            <div class="score-col area-score-b @(_showAnimB && string.IsNullOrEmpty(_sportIcon) ? "anim-active-pop" : "")">

                @if (_showAnimB && !string.IsNullOrEmpty(_sportIcon))
                {
                    <div class="anim-object @GetAnimClass(_event.Sport)">@_sportIcon</div>
                }
                else if (_showAnimB)
                {
                    <div class="anim-text-plus">+POINT</div>
                }

                <div class="main-score @(_isWinnerB ? "score-winner" : "")">@_displayScoreB</div>
            </div>

            <!-- Team B -->
            <div class="team-col area-team-b">
                <div class="logo-circle @(_isWinnerB ? "winner-glow" : "")">
                    <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{_teamB?.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:250%; height:250%;" />
                </div>
                <div class="team-name">@_teamB?.Abbreviation</div>
                <div class="team-region">@_teamB?.Region</div>
            </div>

            <!-- HISTORY -->
            <div class="history-strip area-history">
                @if (_matchHistory != null && _matchHistory.Any())
                {
                    <div class="box-score-container">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th class="team-head">TEAM</th>
                                    @foreach (var set in _matchHistory)
                                    {
                                        <th>@GetTableColumnHeader(_event.Sport, set.PhaseNumber)</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="team-abbr">@_teamA?.Abbreviation</td>
                                    @foreach (var set in _matchHistory)
                                    {
                                        <td class="@(set.ScoreA > set.ScoreB ? "set-win" : "")">@set.ScoreA</td>
                                    }
                                </tr>
                                <tr>
                                    <td class="team-abbr">@_teamB?.Abbreviation</td>
                                    @foreach (var set in _matchHistory)
                                    {
                                        <td class="@(set.ScoreB > set.ScoreA ? "set-win" : "")">@set.ScoreB</td>
                                    }
                                </tr>
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    }

    <div class="ticker-footer">
        <div class="ticker-track">
            <img src="/media/images/2031.png" class="footer-logo" alt="Palaro Logo" />
            <img src="/media/images/deped.png" class="footer-logo" alt="DepEd" />
            <img src="/media/images/bagongpilipinas.png" class="footer-logo" alt="Bagong Pilipinas" />
            <img src="/media/logo/Palarong Pambansa Logo.webp" onerror="this.src='/media/images/2031.png'" class="footer-logo" alt="Runner Logo" />
            <img src="/media/images/pgas.png" class="footer-logo" alt="LGU Agusan" />
        </div>
    </div>
</div>

@code {
    [Parameter] public string EventID { get; set; } = "";

    // MODELS
    public class EventModel
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? EventStage { get; set; }
        public bool? IsFinished { get; set; }
        public List<EventVersusTeams>? EventVersusList { get; set; }
    }

    public class EventVersusTeams
    {
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
    }

    public class ClientTeamMatchDTO
    {
        public string? EventID { get; set; }
        public string? Region { get; set; }
        public int Phase { get; set; }
        public int Score { get; set; }
    }

    public class PhaseScoreModel
    {
        public int PhaseNumber { get; set; }
        public int ScoreA { get; set; }
        public int ScoreB { get; set; }
    }

    // STATE
    private EventModel? _event;
    private List<ClientTeamMatchDTO> _matches = new();
    private EventVersusTeams? _teamA;
    private EventVersusTeams? _teamB;

    private string _cleanSportName = "";
    private string _schoolLevel = "";
    private bool _isSetGame = false;
    private string _phaseText = "";

    // Animation Tracking
    private string _sportIcon = ""; // 🏀, 🏐, etc.
    private int _prevScoreA = -1;
    private int _prevScoreB = -1;
    private bool _showAnimA = false;
    private bool _showAnimB = false;

    private int _displayScoreA;
    private int _displayScoreB;
    private int _setsA;
    private int _setsB;
    private bool _isWinnerA;
    private bool _isWinnerB;

    private List<PhaseScoreModel> _matchHistory = new();

    private bool _isLoading = true;
    private bool _isRefreshing = false;
    private Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _timer = new Timer(_ => _ = InvokeAsync(LoadDataSafe), null, 2000, 2000);
    }

    private async Task LoadDataSafe()
    {
        try { await LoadData(); }
        catch (Exception ex) { Console.WriteLine($"Timer error: {ex.Message}"); }
    }

    private async Task LoadData()
    {
        if (_isRefreshing) return;
        try
        {
            _isRefreshing = true;
            var eventDetails = await apiService.GetAsync<EventModel>($"/Events/Details/{EventID}");
            _event = eventDetails?.FirstOrDefault();

            if (_event != null && _event.EventVersusList?.Count == 2)
            {
                _teamA = _event.EventVersusList[0];
                _teamB = _event.EventVersusList[1];

                _cleanSportName = GetCleanSportName(_event.Sport);
                _schoolLevel = GetSchoolLevel(_event.Sport);
                _isSetGame = IsSetBasedSport(_event.Sport);
                _sportIcon = GetSportIcon(_event.Sport);

                var allMatches = await apiService.GetAsync<ClientTeamMatchDTO>($"score/TeamMatch?eventId={EventID}");
                _matches = allMatches?.ToList() ?? new();

                CalculateScores();
            }
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        finally
        {
            _isLoading = false;
            _isRefreshing = false;
            StateHasChanged();
        }
    }

    private void CalculateScores()
    {
        if (_event == null || _teamA == null || _teamB == null) return;

        _matchHistory.Clear();
        _setsA = 0; _setsB = 0;
        _isWinnerA = false; _isWinnerB = false;

        int maxPhase = _matches.Any() ? _matches.Max(m => m.Phase) : 1;
        _phaseText = GetPhaseText(_event.Sport, maxPhase);

        if (_event.IsFinished == true) _phaseText = "FINAL";

        // Build History
        for (int i = 1; i <= maxPhase; i++)
        {
            var sA = GetScore(_matches, _teamA.Region, i);
            var sB = GetScore(_matches, _teamB.Region, i);
            if (sA > 0 || sB > 0 || i == maxPhase)
                _matchHistory.Add(new PhaseScoreModel { PhaseNumber = i, ScoreA = sA, ScoreB = sB });
        }

        int currentScoreA = 0;
        int currentScoreB = 0;

        if (_isSetGame)
        {
            for (int i = 1; i <= maxPhase; i++)
            {
                var sA = GetScore(_matches, _teamA.Region, i);
                var sB = GetScore(_matches, _teamB.Region, i);
                if (i < maxPhase || _event.IsFinished == true)
                {
                    if (sA > sB) _setsA++;
                    else if (sB > sA) _setsB++;
                }
            }
            if (_setsA > _setsB) _isWinnerA = true;
            if (_setsB > _setsA) _isWinnerB = true;

            currentScoreA = GetScore(_matches, _teamA.Region, maxPhase);
            currentScoreB = GetScore(_matches, _teamB.Region, maxPhase);
        }
        else
        {
            currentScoreA = _matches.Where(m => m.Region == _teamA.Region).Sum(m => m.Score);
            currentScoreB = _matches.Where(m => m.Region == _teamB.Region).Sum(m => m.Score);

            if (currentScoreA > currentScoreB) _isWinnerA = true;
            if (currentScoreB > currentScoreA) _isWinnerB = true;
        }

        // ANIMATION TRIGGERS
        if (_prevScoreA != -1 && currentScoreA > _prevScoreA) TriggerAnimA();
        if (_prevScoreB != -1 && currentScoreB > _prevScoreB) TriggerAnimB();

        _displayScoreA = currentScoreA;
        _displayScoreB = currentScoreB;
        _prevScoreA = currentScoreA;
        _prevScoreB = currentScoreB;
    }

    private async void TriggerAnimA()
    {
        _showAnimA = true;
        StateHasChanged();
        await Task.Delay(1000);
        _showAnimA = false;
        StateHasChanged();
    }

    private async void TriggerAnimB()
    {
        _showAnimB = true;
        StateHasChanged();
        await Task.Delay(1000);
        _showAnimB = false;
        StateHasChanged();
    }

    // --- SPORT ICONS & ANIMATION CLASSES ---
    private string GetSportIcon(string? sport)
    {
        var s = sport?.ToLower() ?? "";
        if (s.Contains("basket")) return "🏀";
        if (s.Contains("volley")) return "🏐";
        if (s.Contains("badminton")) return "🏸";
        if (s.Contains("table")) return "🏓";
        if (s.Contains("soccer") || s.Contains("foot")) return "⚽";
        if (s.Contains("sepak")) return "🧶";
        if (s.Contains("base") || s.Contains("soft")) return "⚾";
        return ""; // Fallback to text
    }

    private string GetAnimClass(string? sport)
    {
        var s = sport?.ToLower() ?? "";
        if (s.Contains("basket")) return "anim-active-basketball";
        if (s.Contains("volley")) return "anim-active-volleyball";
        if (s.Contains("badminton")) return "anim-active-badminton";
        if (s.Contains("table")) return "anim-active-tabletennis";
        return "anim-active-pop";
    }

    // --- HELPERS ---
    private int GetScore(List<ClientTeamMatchDTO> scores, string? region, int phase) => scores.FirstOrDefault(s => s.Region == region && s.Phase == phase)?.Score ?? 0;

    private bool IsSetBasedSport(string? sport)
    {
        if (string.IsNullOrEmpty(sport)) return false;
        var s = sport.ToLower();
        return s.Contains("volley") || s.Contains("tennis") || s.Contains("badminton") || s.Contains("sepak") || s.Contains("table");
    }

    private string GetPhaseText(string? sport, int phase)
    {
        var s = sport?.ToLower() ?? "";
        if (s.Contains("basket"))
        {
            if (phase <= 4) return $"{phase}{GetOrdinal(phase)} QTR";
            if (phase == 5) return "OT";
            return $"{phase - 4}OT";
        }
        if (s.Contains("base") || s.Contains("soft")) return $"INN {phase}";
        return $"SET {phase}";
    }

    private string GetOrdinal(int num)
    {
        if (num == 1) return "ST";
        if (num == 2) return "ND";
        if (num == 3) return "RD";
        return "TH";
    }

    private string GetTableColumnHeader(string? sport, int phase)
    {
        var s = sport?.ToLower() ?? "";
        if (s.Contains("basket")) return phase <= 4 ? $"Q{phase}" : (phase == 5 ? "OT" : $"{phase - 4}OT");
        return $"{phase}";
    }

    private string GetSchoolLevel(string? sport)
    {
        if (string.IsNullOrEmpty(sport)) return "SECONDARY";
        return sport.ToUpper().Contains("ELEM") ? "ELEMENTARY" : "SECONDARY";
    }

    private string GetCleanSportName(string? sport)
    {
        if (string.IsNullOrEmpty(sport)) return "";
        return sport.Replace("(Elementary)", "", StringComparison.OrdinalIgnoreCase)
                    .Replace("(Secondary)", "", StringComparison.OrdinalIgnoreCase)
                    .Replace("Elementary", "", StringComparison.OrdinalIgnoreCase)
                    .Replace("Secondary", "", StringComparison.OrdinalIgnoreCase)
                    .Trim();
    }

    public void Dispose() => _timer?.Dispose();
}