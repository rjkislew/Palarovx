@page "/scoreboard/teammatch-live"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>TV Dashboard | PALARO 2026</PageTitle>

<style>
    /* --- FONTS & THEME --- */
    @@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&family=Chakra+Petch:wght@600;700;800&display=swap');

    :root {
        --bg-black: #000000;
        --card-bg: #0a0a0a;
        --border-color: #333333;
        --accent-gold: #FFD700;
        --accent-red: #FF0000;
        --text-white: #ffffff;
    }

    ::-webkit-scrollbar {
        display: none;
    }

    body {
        background-color: var(--bg-black);
        margin: 0;
        color: var(--text-white);
        font-family: 'Rajdhani', sans-serif;
        overflow-x: hidden;
    }

    .tv-screen-bg {
        min-height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000000 70%);
        padding-bottom: 50px;
    }

    /* HEADER */
    .dashboard-header {
        text-align: center;
        padding: 40px 0 10px 0;
        border-bottom: 1px solid #222;
        margin-bottom: 20px;
    }

    .main-event-title {
        font-family: 'Orbitron', sans-serif;
        color: var(--accent-gold);
        font-size: clamp(2rem, 4vw, 3.5rem);
        font-weight: 900;
        letter-spacing: 6px;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        margin: 0;
    }

    .sub-header-text {
        font-family: 'Chakra Petch', sans-serif;
        color: #888;
        font-size: 1.2rem;
        letter-spacing: 4px;
        text-transform: uppercase;
        margin-top: 5px;
    }

    /* --- SEARCH BAR STYLING --- */
    .search-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        padding: 0 20px;
    }

    .tv-search-field {
        width: 100%;
        max-width: 600px;
    }

        /* Override MudBlazor Input Styles for Dark/Gold Theme */
        .tv-search-field .mud-input-control-input-container {
            background-color: #111 !important;
            border: 1px solid #333;
            border-radius: 8px;
        }

        .tv-search-field .mud-input-slot {
            color: var(--accent-gold) !important;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
        }

        .tv-search-field .mud-icon-root {
            color: #666 !important;
        }

        .tv-search-field:focus-within .mud-input-control-input-container {
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

    /* --- SPORT SECTION --- */
    .sport-section {
        margin-bottom: 50px;
        border-top: 2px solid var(--border-color);
        padding-top: 20px;
    }

    .sport-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding: 0 10px;
    }

    .sport-name {
        font-family: 'Orbitron', sans-serif;
        font-size: 2rem;
        font-weight: 800;
        text-transform: uppercase;
        color: white;
        letter-spacing: 2px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .btn-carousel-gold {
        background-color: transparent;
        color: var(--accent-gold);
        border: 2px solid var(--accent-gold);
        font-family: 'Orbitron', sans-serif;
        font-weight: 900;
        font-size: 0.9rem;
        padding: 8px 25px;
        border-radius: 4px;
        text-decoration: none;
        letter-spacing: 2px;
        transition: all 0.3s ease;
        text-transform: uppercase;
    }

        .btn-carousel-gold:hover {
            background-color: var(--accent-gold);
            color: black;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }

    /* --- CARDS --- */
    .match-link {
        text-decoration: none;
        display: block;
        height: 100%;
    }

    .tv-card {
        background-color: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 20px;
        padding: 15px;
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: transform 0.3s ease, border-color 0.3s ease;
    }

        .tv-card:hover {
            transform: translateY(-5px);
            border-color: #555;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

    .card-status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #222;
        padding-bottom: 10px;
    }

    .live-badge {
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 800;
        font-size: 0.8rem;
        padding: 2px 10px;
        background: linear-gradient(180deg, #1a0000 0%, #000000 100%);
        border: 1px solid var(--accent-red);
        color: var(--accent-red);
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(255,0,0,0.2);
    }

    .live-dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        background: var(--accent-red);
        border-radius: 50%;
        margin-right: 5px;
        animation: blink 1.5s infinite;
    }

    .phase-text {
        font-family: 'Chakra Petch';
        color: #888;
        font-size: 0.9rem;
        font-weight: 700;
    }

    .card-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-grow: 1;
    }

    .team-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
    }

    .logo-box-small {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: #151515;
        border: 1px solid #333;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
    }

    .team-abbr {
        font-family: 'Chakra Petch', sans-serif;
        font-size: 1.5rem;
        font-weight: 800;
        color: white;
        line-height: 1;
    }

    .score-text {
        font-family: 'Orbitron', sans-serif;
        font-size: 2.5rem;
        font-weight: 900;
        color: white;
        margin-top: 5px;
    }

    .winner-text {
        color: var(--accent-gold);
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }

    .winner-border {
        border-color: var(--accent-gold);
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
    }

    .vs-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 40px;
    }

    .vs-diamond {
        width: 30px;
        height: 30px;
        background: #0f0f0f;
        border: 1px solid rgba(255, 215, 0, 0.35);
        transform: rotate(45deg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
    }

    .vs-inner-text {
        font-family: 'Chakra Petch';
        font-size: 0.8rem;
        font-weight: 900;
        color: #555;
        transform: rotate(-45deg);
    }

    @@keyframes blink {
        0%, 100% {
            opacity: 1;
        }

        50% {
            opacity: 0.3;
        }
    }

    .mud-tabs-tabbar {
        background: transparent !important;
        border-bottom: 1px solid #333;
    }

    .mud-tab {
        color: #666 !important;
        font-family: 'Orbitron';
        font-weight: 700;
        letter-spacing: 1px;
        font-size: 1.1rem;
    }

    .mud-tab-active {
        color: var(--accent-gold) !important;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
    }

    .mud-tabs-indicator {
        background-color: var(--accent-gold) !important;
        height: 3px;
    }
</style>

<div class="tv-screen-bg">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">

        <!-- HEADER -->
        <div class="dashboard-header">
            <h1 class="main-event-title">PALARONG PAMBANSA 2026</h1>
            <div class="sub-header-text">OFFICIAL LIVE SCOREBOARD</div>
        </div>

        <!-- SEARCH BAR -->
        <div class="search-wrapper">
            <MudTextField @bind-Value="_searchString"
                          Placeholder="SEARCH MATCHES (SPORT, TEAM, STAGE...)"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined"
                          Class="tv-search-field"
                          Immediate="true"
                          Clearable="true" />
        </div>

        @if (_isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="mt-16">
                <MudProgressCircular Indeterminate="true" Color="Color.Warning" Size="Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-4" Style="font-family:'Orbitron'; color:#888;">INITIALIZING SYSTEM...</MudText>
            </MudStack>
        }
        else
        {
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="mt-4" Centered="true">

                <!-- LIVE GAMES TAB -->
                <MudTabPanel Text="LIVE MATCHES">
                    @{
                        // Filter logic applied here
                        var liveGames = _versusEvents
                        .Where(e => e.IsFinished != true)
                        .Where(e => FilterFunction(e)) // Apply Search
                        .ToList();
                    }

                    @if (!liveGames.Any())
                    {
                        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-8" Style="background-color: #0a0a0a; border: 1px dashed #333; border-radius: 20px;">
                            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Style="color: #333; width: 60px; height: 60px;" />
                            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #555; font-family:'Orbitron'">
                                @(_searchString == "" ? "NO LIVE GAMES" : "NO MATCHES FOUND")
                            </MudText>
                        </MudPaper>
                    }
                    else
                    {
                        @foreach (var sportGroup in liveGames.GroupBy(e => e.Sport))
                        {
                            <div class="sport-section">
                                <div class="sport-title-row">
                                    <div class="sport-name">
                                        <MudIcon Icon="@GetSportIcon(sportGroup.Key)" /> @sportGroup.Key
                                    </div>
                                    <a href="/scoreboard/carousel/@sportGroup.Key" target="_blank" class="btn-carousel-gold">
                                        CAROUSEL MODE
                                    </a>
                                </div>

                                <MudGrid Spacing="3">
                                    @foreach (var evt in sportGroup)
                                    {
                                        var teamA = evt.EventVersusList![0];
                                        var teamB = evt.EventVersusList![1];
                                        bool isFinished = evt.IsFinished ?? false;
                                        bool isSetGame = IsSetBasedSport(evt.Sport);

                                        int sA = 0; int sB = 0;
                                        if (isSetGame) { var setScores = CalculateSets(evt.ID, teamA.Region, teamB.Region, isFinished); sA = setScores.Item1; sB = setScores.Item2; }
                                        else { sA = GetTeamTotalPoints(evt.ID, teamA.Region); sB = GetTeamTotalPoints(evt.ID, teamB.Region); }

                                        string phaseText = GetCurrentGamePhase(evt.ID, evt.Sport, isFinished);
                                        bool leadA = sA > sB; bool leadB = sB > sA;

                                        <MudItem xs="12" sm="6" lg="4" xl="3">
                                            <a href="/scoreboard/client/@evt.ID" target="_blank" class="match-link">
                                                <div class="tv-card">
                                                    <div class="card-status-bar">
                                                        <div class="live-badge"><span class="live-dot"></span>LIVE</div>
                                                        <div class="phase-text">@(!string.IsNullOrEmpty(phaseText) ? phaseText : evt.Gender)</div>
                                                    </div>

                                                    <div class="card-content">
                                                        <div class="team-col">
                                                            <div class="logo-box-small @(leadA ? "winner-border" : "")">
                                                                <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{teamA.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                            </div>
                                                            <div class="team-abbr @(leadA ? "winner-text" : "")">@teamA.Abbreviation</div>
                                                            <div class="score-text @(leadA ? "winner-text" : "")">@sA</div>
                                                        </div>
                                                        <div class="vs-col">
                                                            <div class="vs-diamond"><span class="vs-inner-text">VS</span></div>
                                                        </div>
                                                        <div class="team-col">
                                                            <div class="logo-box-small @(leadB ? "winner-border" : "")">
                                                                <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{teamB.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                            </div>
                                                            <div class="team-abbr @(leadB ? "winner-text" : "")">@teamB.Abbreviation</div>
                                                            <div class="score-text @(leadB ? "winner-text" : "")">@sB</div>
                                                        </div>
                                                    </div>

                                                    <div style="text-align:center; margin-top:10px; color:#555; font-size:0.8rem; font-weight:600; text-transform:uppercase; border-top:1px solid #222; padding-top:5px;">
                                                        @evt.EventStage
                                                    </div>
                                                </div>
                                            </a>
                                        </MudItem>
                                    }
                                </MudGrid>
                            </div>
                        }
                    }
                </MudTabPanel>

                <!-- FINISHED GAMES TAB -->
                <MudTabPanel Text="RECENT RESULTS">
                    @{
                        // Filter logic applied here too
                        var finishedGames = _versusEvents
                        .Where(e => e.IsFinished == true)
                        .Where(e => FilterFunction(e)) // Apply Search
                        .ToList();
                    }

                    @if (!finishedGames.Any())
                    {
                        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-8" Style="background-color: #0a0a0a; border: 1px dashed #333; border-radius: 20px;">
                            <MudIcon Icon="@Icons.Material.Filled.HistoryToggleOff" Size="Size.Large" Style="color: #333;" />
                            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #555; font-family:'Orbitron'">
                                @(_searchString == "" ? "NO RESULTS" : "NO MATCHES FOUND")
                            </MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudGrid Spacing="3">
                            @foreach (var evt in finishedGames)
                            {
                                var teamA = evt.EventVersusList![0]; var teamB = evt.EventVersusList![1];
                                bool isSetGame = IsSetBasedSport(evt.Sport);
                                int sA = 0; int sB = 0;
                                if (isSetGame) { var setScores = CalculateSets(evt.ID, teamA.Region, teamB.Region, true); sA = setScores.Item1; sB = setScores.Item2; }
                                else { sA = GetTeamTotalPoints(evt.ID, teamA.Region); sB = GetTeamTotalPoints(evt.ID, teamB.Region); }

                                bool winA = sA > sB; bool winB = sB > sA;

                                <MudItem xs="12" sm="6" lg="4" xl="3">
                                    <a href="/scoreboard/client/@evt.ID" target="_blank" class="match-link">
                                        <div class="tv-card" style="border-color: #222; filter: opacity(0.8);">

                                            <div class="card-status-bar">
                                                <div style="font-family:'Chakra Petch'; font-weight:800; font-size:0.8rem; color:#00ff00;">FINAL</div>
                                                <div class="phase-text">@evt.Gender</div>
                                            </div>

                                            <div class="card-content">
                                                <div class="team-col">
                                                    <div class="logo-box-small @(winA ? "winner-border" : "")" style="@(!winA ? "border-color:transparent; filter:grayscale(1)" : "")">
                                                        <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{teamA.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                    </div>
                                                    <div class="team-abbr @(winA ? "winner-text" : "")">@teamA.Abbreviation</div>
                                                    <div class="score-text @(winA ? "winner-text" : "")">@sA</div>
                                                </div>

                                                <div class="vs-col" style="opacity:0.3;">
                                                    <div class="vs-diamond" style="background:#222; border-color:#444;"></div>
                                                </div>

                                                <div class="team-col">
                                                    <div class="logo-box-small @(winB ? "winner-border" : "")" style="@(!winB ? "border-color:transparent; filter:grayscale(1)" : "")">
                                                        <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{teamB.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                    </div>
                                                    <div class="team-abbr @(winB ? "winner-text" : "")">@teamB.Abbreviation</div>
                                                    <div class="score-text @(winB ? "winner-text" : "")">@sB</div>
                                                </div>
                                            </div>
                                            <div style="text-align:center; margin-top:10px; color:#444; font-size:0.8rem; font-weight:600; text-transform:uppercase; border-top:1px solid #222; padding-top:5px;">
                                                @evt.Sport
                                            </div>

                                        </div>
                                    </a>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudTabPanel>
            </MudTabs>
        }
    </MudContainer>
</div>

@code {
    // --- SEARCH STATE ---
    private string _searchString = "";

    // --- FILTER LOGIC ---
    private bool FilterFunction(EventModel element)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (element.Sport?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        if (element.Gender?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        if (element.EventStage?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;

        // Search Teams
        if (element.EventVersusList != null)
        {
            foreach (var team in element.EventVersusList)
            {
                if (team.Abbreviation?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
                if (team.Region?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
            }
        }

        return false;
    }

    // --- MODELS & VARIABLES ---
    public class EventModel
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Gender { get; set; }
        public string? EventStage { get; set; }
        public bool? IsFinished { get; set; }
        public List<EventVersusTeams>? EventVersusList { get; set; }
    }

    public class EventVersusTeams
    {
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
    }

    public class ClientTeamMatchDTO
    {
        public string? EventID { get; set; }
        public string? Region { get; set; }
        public int Phase { get; set; }
        public int Score { get; set; }
    }

    private List<EventModel> _versusEvents = new();
    private List<ClientTeamMatchDTO> _liveScores = new();
    private bool _isLoading = true;
    private Timer? _refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _refreshTimer = new Timer(async _ => await InvokeAsync(LoadData), null, 3000, 3000);
    }

    private async Task LoadData()
    {
        try
        {
            var events = await apiService.GetAsync<EventModel>("/Events/Details");
            var scores = await apiService.GetAsync<ClientTeamMatchDTO>("score/TeamMatch");

            if (events != null)
            {
                _versusEvents = events
                    .Where(x => x.EventVersusList != null
                             && x.EventVersusList.Count == 2
                             && IsTeamSport(x.Sport))
                    .OrderByDescending(x => x.IsFinished == false)
                    .ThenBy(x => x.Sport)
                    .ToList();
            }

            if (scores != null)
            {
                _liveScores = scores.ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string GetCurrentGamePhase(string eventId, string? sport, bool isFinished)
    {
        if (isFinished || string.IsNullOrEmpty(sport)) return "";
        var eventScores = _liveScores.Where(s => s.EventID == eventId).ToList();
        if (!eventScores.Any()) return "START";
        int maxPhase = eventScores.Max(s => s.Phase);
        var s = sport.ToLower();
        if (s.Contains("basket")) { if (maxPhase <= 4) return $"Q{maxPhase}"; if (maxPhase == 5) return "OT"; return $"{maxPhase - 4}OT"; }
        if (s.Contains("volley") || s.Contains("tennis") || s.Contains("badminton") || s.Contains("sepak")) return $"SET {maxPhase}";
        if (s.Contains("base") || s.Contains("soft")) return $"INN {maxPhase}";
        return "";
    }

    private (int, int) CalculateSets(string eventId, string? regionA, string? regionB, bool isMatchFinished)
    {
        int setsA = 0; int setsB = 0;
        var eventScores = _liveScores.Where(s => s.EventID == eventId).ToList();
        if (!eventScores.Any()) return (0, 0);
        int maxPhase = eventScores.Max(s => s.Phase);
        for (int i = 1; i <= maxPhase; i++)
        {
            if (i < maxPhase || isMatchFinished)
            {
                var scoreA = eventScores.FirstOrDefault(s => s.Region == regionA && s.Phase == i)?.Score ?? 0;
                var scoreB = eventScores.FirstOrDefault(s => s.Region == regionB && s.Phase == i)?.Score ?? 0;
                if (scoreA > scoreB) setsA++; else if (scoreB > scoreA) setsB++;
            }
        }
        return (setsA, setsB);
    }

    private int GetTeamTotalPoints(string eventId, string? region)
    {
        if (string.IsNullOrEmpty(region)) return 0;
        return _liveScores.Where(s => s.EventID == eventId && s.Region == region).Sum(s => s.Score);
    }

    private bool IsSetBasedSport(string? sport)
    {
        if (string.IsNullOrEmpty(sport)) return false;
        var s = sport.ToLower();
        return s.Contains("volley") || s.Contains("tennis") || s.Contains("badminton") || s.Contains("sepak");
    }

    private bool IsTeamSport(string? sport)
    {
        if (string.IsNullOrEmpty(sport)) return false;
        var s = sport.ToLower();
        return s.Contains("basket") || s.Contains("volley") || s.Contains("football") ||
               s.Contains("futsal") || s.Contains("soccer") || s.Contains("tennis") ||
               s.Contains("badminton") || s.Contains("sepak") || s.Contains("base") ||
               s.Contains("soft");
    }

    private string GetSportIcon(string? sport)
    {
        var s = sport?.ToLower() ?? "";
        if (s.Contains("basket")) return Icons.Material.Filled.SportsBasketball;
        if (s.Contains("volley")) return Icons.Material.Filled.SportsVolleyball;
        if (s.Contains("soccer") || s.Contains("foot") || s.Contains("futsal")) return Icons.Material.Filled.SportsSoccer;
        if (s.Contains("tennis") || s.Contains("badminton")) return Icons.Material.Filled.SportsTennis;
        if (s.Contains("base") || s.Contains("soft")) return Icons.Material.Filled.SportsBaseball;
        if (s.Contains("sepak")) return Icons.Material.Filled.SportsKabaddi;
        return Icons.Material.Filled.SportsEsports;
    }

    public void Dispose() => _refreshTimer?.Dispose();
}