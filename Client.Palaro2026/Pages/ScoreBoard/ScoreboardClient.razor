@page "/scoreboard/teammatch-live"
@using System.Threading
@using System.Linq
@using Client.Palaro2026.Services
@inject APIService apiService
@inject NavigationManager Navigation
@implements IDisposable
@layout NoMainLayout

<PageTitle>TV Dashboard | Palaro tu AgSur 2026</PageTitle>

<style>
    /* --- THEME IMPORTS (MATCHING CAROUSEL) --- */
    @@import url('https://fonts.cdnfonts.com/css/evil-empire');
    @@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Chakra+Petch:wght@600;700;800&display=swap');

    :root {
        /* PALARO COLOR PALETTE */
        --pal-blue: #023E8A;
        --pal-dark-blue: #001845;
        --pal-gold: #FFB400;
        --pal-red: #EA0000;
        --pal-white: #ffffff;
        /* LIGHT THEME VARS */
        --bg-gradient-start: #f8f9fa;
        --card-bg: rgba(255, 255, 255, 0.95);
        /* FONTS */
        --font-header: 'Evil Empire', sans-serif;
        --font-subheader: 'Chakra Petch', sans-serif;
        --font-body: 'Nunito', sans-serif;
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--pal-blue);
        }

    body {
        background-color: var(--bg-gradient-start);
        margin: 0;
        font-family: var(--font-body);
        overflow-x: hidden;
    }

    .tv-screen-bg {
        min-height: 100vh;
        width: 100vw;
        background: radial-gradient(circle at 50% 30%, #ffffff 0%, #e0e7ff 100%);
        padding-bottom: 50px;
    }

    /* --- HEADER (PILL STYLE) --- */
    .dashboard-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 40px 0 30px 0;
    }

    .header-pill {
        background: var(--pal-dark-blue);
        border: 3px solid var(--pal-gold);
        padding: 20px 60px;
        border-radius: 50px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .main-event-title {
        font-family: var(--font-header);
        color: white;
        font-size: clamp(2rem, 4vw, 3.5rem);
        letter-spacing: 2px;
        margin: 0;
        line-height: 1;
        text-shadow: 2px 2px 0px black;
    }

    .sub-header-text {
        font-family: var(--font-subheader);
        color: var(--pal-gold);
        font-size: 1.1rem;
        letter-spacing: 3px;
        font-weight: 700;
        text-transform: uppercase;
        margin-top: 5px;
    }

    /* --- SEARCH BAR --- */
    .search-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        padding: 0 20px;
    }

    .tv-search-field {
        width: 100%;
        max-width: 600px;
    }

        /* Override MudBlazor for Light Theme */
        .tv-search-field .mud-input-control-input-container {
            background-color: white !important;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .tv-search-field .mud-input-slot {
            font-family: var(--font-body);
            font-weight: 700;
            color: var(--pal-dark-blue) !important;
            padding-left: 10px;
        }

        .tv-search-field .mud-icon-root {
            color: var(--pal-blue) !important;
        }

    /* --- TABS --- */
    .mud-tabs-tabbar {
        background: transparent !important;
    }

    .mud-tab {
        font-family: var(--font-header) !important;
        font-size: 1.5rem !important;
        letter-spacing: 1px;
        color: #adb5bd !important; /* Greyed out */
        text-transform: uppercase;
    }

    .mud-tab-active {
        color: var(--pal-blue) !important;
        text-shadow: 0 0 1px rgba(2, 62, 138, 0.5);
    }

    .mud-tabs-indicator {
        background-color: var(--pal-gold) !important;
        height: 4px;
        border-radius: 4px;
    }

    /* --- SPORT SECTION --- */
    .sport-section {
        margin-bottom: 40px;
        background: white;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }

    .sport-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--pal-gold);
    }

    .sport-name {
        font-family: var(--font-header);
        font-size: 1.8rem;
        color: var(--pal-dark-blue);
        display: flex;
        align-items: center;
        gap: 10px;
        letter-spacing: 1px;
    }

    .btn-carousel-gold {
        background-color: var(--pal-dark-blue);
        color: white;
        border: 2px solid var(--pal-gold);
        font-family: var(--font-subheader);
        font-weight: 700;
        font-size: 0.8rem;
        padding: 6px 20px;
        border-radius: 50px;
        text-decoration: none;
        transition: all 0.2s ease;
        text-transform: uppercase;
    }

        .btn-carousel-gold:hover {
            background-color: var(--pal-gold);
            color: var(--pal-dark-blue);
            transform: scale(1.05);
        }

    /* --- MATCH CARD (Light Theme) --- */
    .match-link {
        text-decoration: none;
        display: block;
        height: 100%;
    }

    .tv-card {
        background-color: white;
        border: 1px solid #dee2e6;
        border-top: 5px solid var(--pal-blue);
        border-radius: 15px;
        padding: 15px;
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

        .tv-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            border-top-color: var(--pal-gold);
        }

    .card-status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #f1f1f1;
        padding-bottom: 8px;
    }

    /* Live Badge - Official Style */
    .live-badge {
        font-family: var(--font-subheader);
        font-weight: 800;
        font-size: 0.75rem;
        padding: 3px 12px;
        background: var(--pal-red);
        color: white;
        border-radius: 20px;
        letter-spacing: 1px;
        box-shadow: 0 2px 5px rgba(234, 0, 0, 0.3);
    }

    .final-badge {
        font-family: var(--font-subheader);
        font-weight: 800;
        font-size: 0.75rem;
        padding: 3px 12px;
        background: #343a40;
        color: white;
        border-radius: 20px;
        letter-spacing: 1px;
    }

    .phase-text {
        font-family: var(--font-subheader);
        color: #6c757d;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .card-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-grow: 1;
        gap: 5px;
    }

    .team-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        text-align: center;
    }

    .logo-box-small {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: white;
        border: 2px solid #e9ecef;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.05);
    }

    .winner-border {
        border-color: var(--pal-gold);
        box-shadow: 0 0 10px rgba(255, 180, 0, 0.3);
    }

    .team-abbr {
        font-family: var(--font-subheader);
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--pal-blue);
        line-height: 1;
        margin-bottom: 2px;
    }

    .score-text {
        font-family: 'Corbel', sans-serif;
        font-size: 2.2rem;
        font-weight: 700;
        color: #495057;
        margin-top: 0px;
        line-height: 1;
    }

    .winner-text {
        color: var(--pal-dark-blue);
        transform: scale(1.1);
        text-shadow: 0 0 1px rgba(0,0,0,0.1);
    }

    .vs-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 30px;
    }

    .vs-text {
        font-family: var(--font-subheader);
        font-size: 1rem;
        font-weight: 900;
        font-style: italic;
        color: #adb5bd;
    }

    .card-footer {
        text-align: center;
        margin-top: 12px;
        color: #6c757d;
        font-family: var(--font-subheader);
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        border-top: 1px solid #f1f1f1;
        padding-top: 8px;
    }

    /* Loading */
    .loading-spinner {
        color: var(--pal-blue);
    }
</style>

<div class="tv-screen-bg">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">

        <!-- HEADER -->
        <div class="dashboard-header">
            <div class="header-pill">
                <h1 class="main-event-title">PALARONG PAMBANSA 2026</h1>
                <div class="sub-header-text">OFFICIAL LIVE SCOREBOARD</div>
            </div>
        </div>

        <!-- SEARCH BAR -->
        <div class="search-wrapper">
            <MudTextField @bind-Value="_searchString"
                          Placeholder="SEARCH MATCHES..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined"
                          Class="tv-search-field"
                          Immediate="true"
                          Clearable="true" />
        </div>

        @if (_isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="mt-16">
                <MudProgressCircular Indeterminate="true" Class="loading-spinner" Size="Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-4" Style="font-family:var(--font-header); color:var(--pal-blue);">INITIALIZING SYSTEM...</MudText>
            </MudStack>
        }
        else
        {
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="mt-4" Centered="true">

                <!-- LIVE GAMES TAB -->
                <MudTabPanel Text="LIVE MATCHES">
                    @{
                        var liveGames = _versusEvents
                        .Where(e => e.IsFinished != true)
                        .Where(e => FilterFunction(e))
                        .ToList();
                    }

                    @if (!liveGames.Any())
                    {
                        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-8" Style="background-color: white; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Style="color: #dee2e6; width: 80px; height: 80px;" />
                            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #adb5bd; font-family:var(--font-header)">
                                @(_searchString == "" ? "NO LIVE GAMES" : "NO MATCHES FOUND")
                            </MudText>
                        </MudPaper>
                    }
                    else
                    {
                        @foreach (var sportGroup in liveGames.GroupBy(e => e.Sport))
                        {
                            <div class="sport-section">
                                <div class="sport-title-row">
                                    <div class="sport-name">
                                        <MudIcon Icon="@GetSportIcon(sportGroup.Key)" Style="color: var(--pal-gold); margin-right: 10px;" /> @sportGroup.Key
                                    </div>
                                    <a href="/scoreboard/carousel/@sportGroup.Key" target="_blank" class="btn-carousel-gold">
                                        CAROUSEL MODE
                                    </a>
                                </div>

                                <MudGrid Spacing="3">
                                    @foreach (var evt in sportGroup)
                                    {
                                        var teamA = evt.EventVersusList![0];
                                        var teamB = evt.EventVersusList![1];
                                        bool isFinished = evt.IsFinished ?? false;
                                        bool isSetGame = IsSetBasedSport(evt.Sport);

                                        int sA = 0; int sB = 0;
                                        if (isSetGame) { var setScores = CalculateSets(evt.ID, teamA.Region, teamB.Region, isFinished); sA = setScores.Item1; sB = setScores.Item2; }
                                        else { sA = GetTeamTotalPoints(evt.ID, teamA.Region); sB = GetTeamTotalPoints(evt.ID, teamB.Region); }

                                        string phaseText = GetCurrentGamePhase(evt.ID, evt.Sport, isFinished);
                                        bool leadA = sA > sB; bool leadB = sB > sA;

                                        <MudItem xs="12" sm="6" lg="4" xl="3">
                                            <a href="/scoreboard/client/@evt.ID" target="_blank" class="match-link">
                                                <div class="tv-card">
                                                    <div class="card-status-bar">
                                                        <div class="live-badge">LIVE</div>
                                                        <div class="phase-text">@(!string.IsNullOrEmpty(phaseText) ? phaseText : evt.Gender)</div>
                                                    </div>

                                                    <div class="card-content">
                                                        <div class="team-col">
                                                            <div class="logo-box-small @(leadA ? "winner-border" : "")">
                                                                <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{teamA.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                            </div>
                                                            <div class="team-abbr @(leadA ? "winner-text" : "")">@teamA.Abbreviation</div>
                                                            <div class="score-text @(leadA ? "winner-text" : "")">@sA</div>
                                                        </div>
                                                        <div class="vs-col">
                                                            <div class="vs-text">VS</div>
                                                        </div>
                                                        <div class="team-col">
                                                            <div class="logo-box-small @(leadB ? "winner-border" : "")">
                                                                <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{teamB.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                            </div>
                                                            <div class="team-abbr @(leadB ? "winner-text" : "")">@teamB.Abbreviation</div>
                                                            <div class="score-text @(leadB ? "winner-text" : "")">@sB</div>
                                                        </div>
                                                    </div>

                                                    <div class="card-footer">
                                                        @evt.EventStage
                                                    </div>
                                                </div>
                                            </a>
                                        </MudItem>
                                    }
                                </MudGrid>
                            </div>
                        }
                    }
                </MudTabPanel>

                <!-- FINISHED GAMES TAB -->
                <MudTabPanel Text="RECENT RESULTS">
                    @{
                        var finishedGames = _versusEvents
                        .Where(e => e.IsFinished == true)
                        .Where(e => FilterFunction(e))
                        .ToList();
                    }

                    @if (!finishedGames.Any())
                    {
                        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center mt-8" Style="background-color: white; border-radius: 20px;">
                            <MudIcon Icon="@Icons.Material.Filled.HistoryToggleOff" Size="Size.Large" Style="color: #dee2e6;" />
                            <MudText Typo="Typo.h5" Class="mt-4" Style="color: #adb5bd; font-family:var(--font-header)">
                                @(_searchString == "" ? "NO RESULTS" : "NO MATCHES FOUND")
                            </MudText>
                        </MudPaper>
                    }
                    else
                    {
                        <MudGrid Spacing="3">
                            @foreach (var evt in finishedGames)
                            {
                                var teamA = evt.EventVersusList![0]; var teamB = evt.EventVersusList![1];
                                bool isSetGame = IsSetBasedSport(evt.Sport);
                                int sA = 0; int sB = 0;
                                if (isSetGame) { var setScores = CalculateSets(evt.ID, teamA.Region, teamB.Region, true); sA = setScores.Item1; sB = setScores.Item2; }
                                else { sA = GetTeamTotalPoints(evt.ID, teamA.Region); sB = GetTeamTotalPoints(evt.ID, teamB.Region); }

                                bool winA = sA > sB; bool winB = sB > sA;

                                <MudItem xs="12" sm="6" lg="4" xl="3">
                                    <a href="/scoreboard/client/@evt.ID" target="_blank" class="match-link">
                                        <div class="tv-card" style="border-top-color: #6c757d; opacity: 0.9;">

                                            <div class="card-status-bar">
                                                <div class="final-badge">FINAL</div>
                                                <div class="phase-text">@evt.Gender</div>
                                            </div>

                                            <div class="card-content">
                                                <div class="team-col">
                                                    <div class="logo-box-small @(winA ? "winner-border" : "")" style="@(!winA ? "filter:grayscale(1); opacity:0.6" : "")">
                                                        <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{teamA.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                    </div>
                                                    <div class="team-abbr @(winA ? "winner-text" : "")" style="@(!winA ? "color:#adb5bd" : "")">@teamA.Abbreviation</div>
                                                    <div class="score-text @(winA ? "winner-text" : "")" style="@(!winA ? "color:#adb5bd" : "")">@sA</div>
                                                </div>

                                                <div class="vs-col">
                                                    <div class="vs-text">VS</div>
                                                </div>

                                                <div class="team-col">
                                                    <div class="logo-box-small @(winB ? "winner-border" : "")" style="@(!winB ? "filter:grayscale(1); opacity:0.6" : "")">
                                                        <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{teamB.Region}.webp")" ObjectFit="ObjectFit.Contain" Style="width:90%; height:90%;" />
                                                    </div>
                                                    <div class="team-abbr @(winB ? "winner-text" : "")" style="@(!winB ? "color:#adb5bd" : "")">@teamB.Abbreviation</div>
                                                    <div class="score-text @(winB ? "winner-text" : "")" style="@(!winB ? "color:#adb5bd" : "")">@sB</div>
                                                </div>
                                            </div>
                                            <div class="card-footer">
                                                @evt.Sport • @evt.EventStage
                                            </div>

                                        </div>
                                    </a>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudTabPanel>
            </MudTabs>
        }
    </MudContainer>
</div>

@code {
    // --- SEARCH STATE ---
    private string _searchString = "";

    // --- FILTER LOGIC ---
    private bool FilterFunction(EventModel element)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (element.Sport?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        if (element.Gender?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        if (element.EventStage?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;

        // Search Teams
        if (element.EventVersusList != null)
        {
            foreach (var team in element.EventVersusList)
            {
                if (team.Abbreviation?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
                if (team.Region?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
            }
        }

        return false;
    }

    // --- MODELS & VARIABLES ---
    public class EventModel
    {
        public string ID { get; set; } = "";
        public string? Sport { get; set; }
        public string? Gender { get; set; }
        public string? EventStage { get; set; }
        public bool? IsFinished { get; set; }
        public List<EventVersusTeams>? EventVersusList { get; set; }
    }

    public class EventVersusTeams
    {
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
    }

    public class ClientTeamMatchDTO
    {
        public string? EventID { get; set; }
        public string? Region { get; set; }
        public int Phase { get; set; }
        public int Score { get; set; }
    }

    private List<EventModel> _versusEvents = new();
    private List<ClientTeamMatchDTO> _liveScores = new();
    private bool _isLoading = true;
    private Timer? _refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _refreshTimer = new Timer(async _ => await InvokeAsync(LoadData), null, 3000, 3000);
    }

    private async Task LoadData()
    {
        try
        {
            var events = await apiService.GetAsync<EventModel>("/Events/Details");
            var scores = await apiService.GetAsync<ClientTeamMatchDTO>("score/TeamMatch");

            if (events != null)
            {
                _versusEvents = events
                    .Where(x => x.EventVersusList != null
                             && x.EventVersusList.Count == 2
                             && IsTeamSport(x.Sport))
                    .OrderByDescending(x => x.IsFinished == false)
                    .ThenBy(x => x.Sport)
                    .ToList();
            }

            if (scores != null)
            {
                _liveScores = scores.ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string GetCurrentGamePhase(string eventId, string? sport, bool isFinished)
    {
        if (isFinished || string.IsNullOrEmpty(sport)) return "";
        var eventScores = _liveScores.Where(s => s.EventID == eventId).ToList();
        if (!eventScores.Any()) return "START";
        int maxPhase = eventScores.Max(s => s.Phase);
        var s = sport.ToLower();
        if (s.Contains("basket")) { if (maxPhase <= 4) return $"Q{maxPhase}"; if (maxPhase == 5) return "OT"; return $"{maxPhase - 4}OT"; }
        if (s.Contains("volley") || s.Contains("tennis") || s.Contains("badminton") || s.Contains("sepak")) return $"SET {maxPhase}";
        if (s.Contains("base") || s.Contains("soft")) return $"INN {maxPhase}";
        return "";
    }

    private (int, int) CalculateSets(string eventId, string? regionA, string? regionB, bool isMatchFinished)
    {
        int setsA = 0; int setsB = 0;
        var eventScores = _liveScores.Where(s => s.EventID == eventId).ToList();
        if (!eventScores.Any()) return (0, 0);
        int maxPhase = eventScores.Max(s => s.Phase);
        for (int i = 1; i <= maxPhase; i++)
        {
            if (i < maxPhase || isMatchFinished)
            {
                var scoreA = eventScores.FirstOrDefault(s => s.Region == regionA && s.Phase == i)?.Score ?? 0;
                var scoreB = eventScores.FirstOrDefault(s => s.Region == regionB && s.Phase == i)?.Score ?? 0;
                if (scoreA > scoreB) setsA++; else if (scoreB > scoreA) setsB++;
            }
        }
        return (setsA, setsB);
    }

    private int GetTeamTotalPoints(string eventId, string? region)
    {
        if (string.IsNullOrEmpty(region)) return 0;
        return _liveScores.Where(s => s.EventID == eventId && s.Region == region).Sum(s => s.Score);
    }

    private bool IsSetBasedSport(string? sport)
    {
        if (string.IsNullOrEmpty(sport)) return false;
        var s = sport.ToLower();
        return s.Contains("volley") || s.Contains("tennis") || s.Contains("badminton") || s.Contains("sepak");
    }

    private bool IsTeamSport(string? sport)
    {
        if (string.IsNullOrEmpty(sport)) return false;
        var s = sport.ToLower();
        return s.Contains("basket") || s.Contains("volley") || s.Contains("football") ||
               s.Contains("futsal") || s.Contains("soccer") || s.Contains("tennis") ||
               s.Contains("badminton") || s.Contains("sepak") || s.Contains("base") ||
               s.Contains("soft");
    }

    private string GetSportIcon(string? sport)
    {
        var s = sport?.ToLower() ?? "";
        if (s.Contains("basket")) return Icons.Material.Filled.SportsBasketball;
        if (s.Contains("volley")) return Icons.Material.Filled.SportsVolleyball;
        if (s.Contains("soccer") || s.Contains("foot") || s.Contains("futsal")) return Icons.Material.Filled.SportsSoccer;
        if (s.Contains("tennis") || s.Contains("badminton")) return Icons.Material.Filled.SportsTennis;
        if (s.Contains("base") || s.Contains("soft")) return Icons.Material.Filled.SportsBaseball;
        if (s.Contains("sepak")) return Icons.Material.Filled.SportsKabaddi;
        return Icons.Material.Filled.SportsEsports;
    }

    public void Dispose() => _refreshTimer?.Dispose();
}