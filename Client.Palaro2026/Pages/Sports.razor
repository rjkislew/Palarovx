@page "/sports"

@using System.Net.Http
@using System.Text.Json
@using System.Threading.Tasks

<MudGrid Spacing="10" Justify="Justify.Center">
    @if (sports == null || sports.Count == 0)
    {
        <MudItem xs="12">
            <MudProgressLinear Color="Color.Secondary" Indeterminate="true" Class="my-7" />
        </MudItem>
    }
    else
    {
        <Virtualize Items="sports" Context="categoryData" OverscanCount="5">
            <MudItem xs="12">
                <MudStack Spacing="2">
                    <MudText Color="Color.Secondary" Typo="Typo.h2">
                        @categoryData.Category
                    </MudText>
                    <MudDivider Class="mud-border-tertiary" />
                    <MudGrid>
                        <Virtualize Items="categoryData.Sports" Context="sportData">
                            <MudItem xs="12" md="6">
                                <MudPaper Outlined Class="pa-3 mud-border-tertiary" id="@sportData.Sport">
                                    <MudStack Row AlignItems="AlignItems.Center">
                                        <MudImage Width="50" Height="50" Src="@($"Media/Sports/Icons/{sportData.Sport}.png")"></MudImage>
                                        <MudStack Spacing="1">
                                            <MudText Typo="Typo.h3" Color="Color.Primary">@sportData.Sport</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Tertiary">@sportData.Description</MudText>
                                        </MudStack>
                                    </MudStack>
                                    <MudGrid>
                                        <MudItem xs="12" md="6">
                                            <!-- Schedules-->
                                            <MudStack Class="mt-5" Spacing="2">
                                                <MudText Typo="Typo.body2">Live Now</MudText>
                                                <MudDivider Class="mud-border-tertiary" />
                                                <MudPaper Outlined Class="mud-border-primary pa-3">
                                                    <MudStack Row Wrap="Wrap.Wrap" Spacing="1">
                                                        <MudIcon Icon="@Icons.Material.Filled.WarningAmber" Color="Color.Warning"></MudIcon>
                                                        <MudText Typo="Typo.caption">No Live Feed</MudText>
                                                    </MudStack>
                                                </MudPaper>
                                            </MudStack>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <!-- Live Now -->
                                            <MudStack Class="mt-5" Spacing="2">
                                                <MudText Typo="Typo.body2">Upcoming Schedules</MudText>
                                                <MudDivider Class="mud-border-tertiary" />
                                                <MudPaper Outlined Class="mud-border-primary pa-3">
                                                    <MudStack Row Wrap="Wrap.Wrap" Spacing="1">
                                                        <MudIcon Icon="@Icons.Material.Filled.WarningAmber" Color="Color.Warning"></MudIcon>
                                                        <MudText Typo="Typo.caption">No Upcoming Schedules</MudText>
                                                    </MudStack>
                                                </MudPaper>
                                            </MudStack>
                                        </MudItem>
                                    </MudGrid>
                                    <MudStack AlignItems="AlignItems.End" Class="mt-5">
                                        <!-- Categories -->
                                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@(e => OnExpandCollapseClick(sportData))">
                                            <MudText Typo="Typo.body2" Color="Color.Tertiary">@(sportData.IsExpanded ? "Close" : "Sub Categories")</MudText>
                                        </MudButton>
                                    </MudStack>
                                    <MudCollapse Expanded="sportData.IsExpanded">
                                        <MudStack Spacing="1">
                                            <MudText Typo="Typo.body2">Categories</MudText>
                                            <MudDivider Class="mud-border-tertiary" />
                                            <MudStack Row Wrap="Wrap.Wrap" Spacing="1">
                                                <Virtualize Items="sportData.SubCategories" Context="subCategoryData" ItemSize="5">
                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Secondary">
                                                        <MudText Color="Color.Tertiary" Typo="Typo.caption">@subCategoryData.SubCategory</MudText>
                                                    </MudChip>
                                                </Virtualize>
                                            </MudStack>
                                        </MudStack>
                                    </MudCollapse>
                                </MudPaper>
                            </MudItem>
                        </Virtualize>
                    </MudGrid>
                </MudStack>
            </MudItem>
        </Virtualize>
    }
</MudGrid>

@code {
    // Get API URL
    private readonly string API_URL = APIService.Palaro2026API;
    private List<scsc_CategoriesDTO>? sports;

    public class scsc_CategoriesDTO
    {
        public string? Category { get; set; }
        public List<scsc_SportsDTO>? Sports { get; set; }
    }

    public class scsc_SportsDTO
    {
        public string? Sport { get; set; }
        public string? Description { get; set; }
        public List<scsc_SubCategoriesDTO>? SubCategories { get; set; }
        public bool IsExpanded { get; set; } // Use a different property name to avoid conflicts
    }

    public class scsc_SubCategoriesDTO
    {
        public string? SubCategory { get; set; }
    }

    private void OnExpandCollapseClick(scsc_SportsDTO sportData)
    {
        sportData.IsExpanded = !sportData.IsExpanded;
    }

    // Initialization method to fetch data and update UI elements
    protected override async Task OnInitializedAsync()
    {
        await GetSportsList();
        StateHasChanged();
    }

    private async Task GetSportsList()
    {
        try
        {
            using HttpClient httpClient = new HttpClient();
            HttpResponseMessage httpResponse = await httpClient.GetAsync($"{API_URL}/Sports/SportSubCategories");
            httpResponse.EnsureSuccessStatusCode();

            using var responseStream = await httpResponse.Content.ReadAsStreamAsync();
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            var fetchedSports = await JsonSerializer.DeserializeAsync<List<scsc_CategoriesDTO>>(responseStream, options);

            // Check if fetchedSports is null or empty
            if (fetchedSports == null || !fetchedSports.Any())
            {
                Console.WriteLine("No sports data received.");
                sports = new List<scsc_CategoriesDTO>(); // Initialize to an empty list
                return; // Exit early if no data is fetched
            }

            // Assign the fetched data to the sports variable
            sports = fetchedSports;

            // Set IsExpanded to false for each sport
            foreach (var category in sports)
            {
                category.Sports?.ForEach(sport => sport.IsExpanded = false);
            }
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }

}
