@* @page "/regional-teams/{Abbreviation}-{Region}"
 *@
@using System.Net.Http
@using System.Text.Json
@using System.Threading.Tasks
@using Client.Palaro2026.Services
@inject IDialogService DialogService
@inject APIService apiService
@inject HttpClient httpClient
@inject NavigationManager navigationManager

<PageTitle>@Region | PALARO 2026 - Agusan del Sur</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudGrid>
        <MudItem xs="12">
            <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h2">@Abbreviation</MudText>
                    <MudText Typo="Typo.subtitle1">@Region</MudText>
                </MudStack>
                <MudStack Row>
                    <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/team_logo/{Region}.webp")" Height="100" />
                    <MudImage Src="@($"https://palarongpambansa2026.com/attachments/media/regions/region_logo/{Region}.webp")" Height="100" />
                </MudStack>
            </MudStack>
        </MudItem>
        <MudItem xs="12">
            <MudBreadcrumbs Style="font-size: 15px" Class="pa-0" Items="_items"></MudBreadcrumbs>
            <MudDivider />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudLink Href="@($"./regional-teams/{Abbreviation}-{Region}/players")" Underline="Underline.None">
                <MudPaper Outlined Class="scale-up-center">
                    <MudStack Spacing="0" Class="pa-3">
                        <MudText Typo="Typo.h3">Players 🙋‍♂️🙋‍♀️</MudText>
                        <MudText>View the performance of each region.</MudText>
                        <MudText Typo="Typo.caption">This section displays the official medal tally of participating regions, helping you track gold, silver, and bronze standings in real-time.</MudText>
                    </MudStack>
                </MudPaper>
            </MudLink>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudLink Href="./regional-teams/billeting-quarters" Underline="Underline.None">
                <MudPaper Outlined Class="scale-up-center">
                    <MudStack Spacing="0" Class="pa-3">
                        <MudText Typo="Typo.h3">Billeting Quarters 🏘️</MudText>
                        <MudText>Know where each delegation stays.</MudText>
                        <MudText Typo="Typo.caption">This section lists the billeting quarters assigned to each region, providing accommodation details for teams and officials.</MudText>
                    </MudStack>
                </MudPaper>
            </MudLink>
        </MudItem>
        <MudItem xs="12">
            <MudDivider />
        </MudItem>
        <MudItem xs="12">
            <MudTabs KeepPanelsAlive Elevation="0" ApplyEffectsToContainer="true" PanelClass="pt-6" Centered>
                <MudTabPanel Style="text-transform: none" Text="Grand Total">
                    <MudPaper Outlined Class="pa-3">
                        <MudGrid>
                            <MudItem xs="3">
                                <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                    <MudText>Gold</MudText>
                                    <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.Amber.Accent4}")" />
                                    <MudText Typo="Typo.h5">
                                        @((_regionalMedalTallies?.Gold ?? 0) == 0 ? "-" : _regionalMedalTallies?.Gold)
                                    </MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="3">
                                <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                    <MudText>Silver</MudText>
                                    <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.BlueGray.Lighten4}")" />
                                    <MudText Typo="Typo.h5">
                                        @((_regionalMedalTallies?.Silver ?? 0) == 0 ? "-" : _regionalMedalTallies?.Silver)
                                    </MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="3">
                                <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                    <MudText>Bronze</MudText>
                                    <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.DeepOrange.Lighten1}")" />
                                    <MudText Typo="Typo.h5">
                                        @((_regionalMedalTallies?.Bronze ?? 0) == 0 ? "-" : _regionalMedalTallies?.Bronze)
                                    </MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="3">
                                <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                    <MudText>Total</MudText>
                                    <MudStack Row Spacing="0">
                                        <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.Amber.Accent4}")" />
                                        <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.BlueGray.Lighten4}")" />
                                        <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.DeepOrange.Lighten1}")" />
                                    </MudStack>
                                    <MudText Typo="Typo.h5">
                                        @_regionalMedalTallies?.Total
                                    </MudText>
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudTabPanel>

                <MudVirtualize Items="_schoolLevelMedalTallies" Context="schoolLevelMedalTally">
                    <MudTabPanel Style="text-transform: none" Text="@schoolLevelMedalTally.Level">
                        <MudVirtualize Items="@schoolLevelMedalTally.RegionalMedalTallyList" Context="medal">
                            <MudPaper Outlined Class="pa-3">
                                <MudGrid>
                                    <MudItem xs="3">
                                        <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                            <MudText>Gold</MudText>
                                            <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.Amber.Accent4}")" />
                                            <MudText Typo="Typo.h5">
                                                @medal.Gold
                                            </MudText>
                                        </MudStack>
                                    </MudItem>
                                    <MudItem xs="3">
                                        <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                            <MudText>Silver</MudText>
                                            <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.BlueGray.Lighten4}")" />
                                            <MudText Typo="Typo.h5">
                                                @medal.Silver
                                            </MudText>
                                        </MudStack>
                                    </MudItem>
                                    <MudItem xs="3">
                                        <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                            <MudText>Bronze</MudText>
                                            <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.DeepOrange.Lighten1}")" />
                                            <MudText Typo="Typo.h5">
                                                @medal.Bronze
                                            </MudText>
                                        </MudStack>
                                    </MudItem>
                                    <MudItem xs="3">
                                        <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                            <MudText>Total</MudText>
                                            <MudStack Row Spacing="0">
                                                <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.Amber.Accent4}")" />
                                                <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.BlueGray.Lighten4}")" />
                                                <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {Colors.DeepOrange.Lighten1}")" />
                                            </MudStack>
                                            <MudText Typo="Typo.h5">
                                                @medal.Total
                                            </MudText>
                                        </MudStack>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>

                        </MudVirtualize>
                    </MudTabPanel>
                </MudVirtualize>
            </MudTabs>
        </MudItem>

        <MudFlexBreak />

        <MudItem xs="12">
            @if (isEmpty)
            {
                <MudText>No ongoing events for this region, yet.</MudText>
            }
            else if (noConnection)
            {
                <MudText>Check your internet connection.    </MudText>
            }
            else
            {
                <MudTabs KeepPanelsAlive Elevation="0" ApplyEffectsToContainer="true" PanelClass="pt-6" Centered>
                    @foreach (var isFinished in new[] { false, true }) // Loop for both Ongoing & Finished
                    {
                        var filteredEvents = _eventDetails?.Where(e => e.IsFinished == isFinished).ToList();

                        if (filteredEvents?.Any() == true) // Create tab only if there are events
                        {
                            <MudTabPanel Style="text-transform: none" Text="@(isFinished ? "Finished" : "Ongoing")">
                                <MudGrid Justify="Justify.Center">
                                    <MudVirtualize Items="filteredEvents" Context="eventDetail">
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudPaper Outlined Style="height: 100%" Class="scale-up-center">
                                                @* Content *@
                                                <MudLink Href="@($"./events/{(eventDetail.IsFinished == true ? "Finished" : "Ongoing")}/{eventDetail.ID}")" Underline="Underline.None" Color="Color.Dark" Style="height: 100%; user-select: text; -webkit-user-drag: none;" draggable="auto">
                                                    <MudStack Style="height: 100%" Spacing="0">

                                                        @* Image *@
                                                        @if (eventDetail.OnStream == true && eventDetail.IsFinished == false)
                                                        {
                                                            <MudStack Class="relative">
                                                                <MudChip Icon="@Icons.Material.Filled.FiberManualRecord" T="string" Variant="Variant.Filled" Color="Color.Error" Size="Size.Small" Class="absolute ml-3 mt-3 animate-blink">
                                                                    Live
                                                                </MudChip>
                                                                <MudImage Src="@GetThumbnailUrl(eventDetail.StreamURL)"
                                                                          Style="width: 100%; height: 250px"
                                                                          Class="rounded-t"
                                                                          ObjectFit="ObjectFit.Cover" />
                                                            </MudStack>
                                                        }
                                                        else if (eventDetail.OnStream == true && eventDetail.IsFinished == true)
                                                        {
                                                            <MudStack Class="relative">
                                                                <MudChip Icon="@Icons.Material.Filled.PlayCircleFilled" T="string" Variant="Variant.Filled" Color="Color.Info" Size="Size.Small" Class="absolute ml-3 mt-3">
                                                                    Was Live
                                                                </MudChip>
                                                                <MudImage Src="@GetThumbnailUrl(eventDetail.StreamURL)"
                                                                          Style="width: 100%; height: 250px"
                                                                          Class="rounded-t"
                                                                          ObjectFit="ObjectFit.Cover" />
                                                            </MudStack>
                                                        }
                                                        else
                                                        {
                                                            <MudStack Class="relative">
                                                                <MudChip Icon="@Icons.Material.Filled.CircleNotifications" T="string" Variant="Variant.Filled" Color="Color.Warning" Size="Size.Small" Style="z-index: 10" Class="absolute ml-3 mt-3">
                                                                    Not on live
                                                                </MudChip>
                                                                <MudImage Src="@($"media/sports/icons/white/{eventDetail.Sport}.webp")"
                                                                          Style="width: 50px; height: 50px; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10"
                                                                          Class="rounded-t absolute "
                                                                          ObjectFit="ObjectFit.Cover" />
                                                                <MudStack Style="background-color: rgba(0,0,0,0.5); width: 100%; height: 250px" Class="rounded-t absolute" />
                                                                <MudImage Src="@($"media/sports/images/{eventDetail.Sport}.webp")"
                                                                          Style="width: 100%; height: 250px"
                                                                          Class="rounded-t"
                                                                          ObjectFit="ObjectFit.Cover" />
                                                            </MudStack>
                                                        }

                                                        @* Title *@
                                                        @* Sport Details *@
                                                        <MudStack Justify="Justify.SpaceBetween" Style="height: 100%" Class="pa-3">
                                                            <MudStack Spacing="0">
                                                                <MudText Style="font-weight: bold">@eventDetail.Subcategory</MudText>
                                                                <MudText Typo="Typo.caption">@eventDetail.EventStage ∙ @eventDetail.Sport</MudText><MudText Typo="Typo.caption">
                                                                    @{
                                                                        var eventDate = eventDetail.Date;
                                                                        var displayDate = eventDate.HasValue
                                                                        ? (eventDate.Value.Date == DateTime.Today ? "Today"
                                                                        : eventDate.Value.Date == DateTime.Today.AddDays(1) ? "Tomorrow"
                                                                        : eventDate.Value.ToString("dddd - MMMM d"))
                                                                        : "No Date";

                                                                        var displayTime = eventDetail.Time.HasValue
                                                                        ? DateTime.Today.Add(eventDetail.Time.Value).ToString("hh:mm tt")
                                                                        : "No Time";
                                                                    }
                                                                    @displayDate - @displayTime ∙ @eventDetail.Venue
                                                                </MudText>
                                                            </MudStack>

                                                            <MudText Typo="Typo.caption" Class="mt-3" Style="word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                                                                #@eventDetail.Category?.Replace(" ", "") #@eventDetail.Level?.Replace(" ", "") #@eventDetail.EventStage?.Replace(" ", "")
                                                                <MudElement>
                                                                    #
                                                                    @if (eventDetail.Gender == "Male")
                                                                    {
                                                                        <MudText Typo="Typo.caption">Male♂️</MudText>
                                                                    }
                                                                    else if (eventDetail.Gender == "Female")
                                                                    {
                                                                        <MudText Typo="Typo.caption">Female♀️</MudText>
                                                                    }
                                                                    else
                                                                    {
                                                                        <MudText Typo="Typo.caption">Mixed♂️♀️</MudText>
                                                                    }
                                                                </MudElement>
                                                            </MudText>
                                                        </MudStack>
                                                    </MudStack>
                                                </MudLink>
                                            </MudPaper>
                                        </MudItem>
                                    </MudVirtualize>
                                </MudGrid>
                            </MudTabPanel>
                        }
                    }
                </MudTabs>
            }
        </MudItem>
    </MudGrid>
</MudContainer>

<FooterComponent />

@code {

    // parameters to be passed via URL
    [Parameter] public string? Region { get; set; }
    [Parameter] public string? Abbreviation { get; set; }

    // variables to store data from API calls
    private List<EventsDTO.EventDetails.Event>? _eventDetails;
    private MedalTallyDTO.RegionalMedalTally? _regionalMedalTallies;
    private List<MedalTallyDTO.SchoolLevelMedalTally.SchoolLevel>? _schoolLevelMedalTallies;

    // list to store breadcrumb items
    private List<BreadcrumbItem> _items = new();

    // status flags
    private bool isEmpty = false;
    private bool noConnection = false;

    
    // method to get YouTube thumbnail URL or default image
    private string GetThumbnailUrl(string? url)
    {
        if (string.IsNullOrWhiteSpace(url)) return string.Empty;

        if (url.Contains("youtube.com/watch?v="))
        {
            var videoId = url.Split("v=")[1].Split('&')[0];
            return $"https://img.youtube.com/vi/{videoId}/hqdefault.jpg";
        }

        return "media/images/no-thumbnail-default.webp";
    }

    // method to get medal color based on index
    private string GetMedalColor(int index)
    {
        return index switch
        {
            0 => Colors.Amber.Accent4,       // Gold
            1 => Colors.BlueGray.Lighten4,   // Silver
            2 => Colors.DeepOrange.Lighten1, // Bronze
            _ => "transparent"
        };
    }

    // decode url and fetches data when the component is initialized
    protected override async Task OnInitializedAsync()
    {
        // Decode URL parameters
        if (!string.IsNullOrEmpty(Abbreviation))
            Abbreviation = Uri.UnescapeDataString(Abbreviation);

        if (!string.IsNullOrEmpty(Region))
            Region = Uri.UnescapeDataString(Region);

        // Fetch data from APIs
        await GetEventsAsync();
        await GetMedalTallyByRegionAsync();
        await GetMedalTallyBySchoolLevelAsync();

        // Check if there are no events
        _items = new List<BreadcrumbItem>
        {
            new("Home", href: "./"),
            new("Regional Teams", href: "./regional-teams"),
            new($"{Region}", href: null, disabled: true)
        };
    }

    // Fetches event details for the specified region from the API
    private async Task GetEventsAsync()
    {
        string url = $"/Events/Details?region={Region}";
        _eventDetails = await apiService.GetAsync<EventsDTO.EventDetails.Event>(url);
    }

    // Fetches medal tally for the specified region from the API
    private async Task GetMedalTallyByRegionAsync()
    {
        string url = $"/MedalTally?region={Region}";
        _regionalMedalTallies = await apiService.GetSingleAsync<MedalTallyDTO.RegionalMedalTally>(url);
    }

    // Fetches medal tally by school level for the specified region from the API
    private async Task GetMedalTallyBySchoolLevelAsync()
    {
        string url = $"/MedalTally/BySchoolLevel?region={Region}";
        _schoolLevelMedalTallies = await apiService.GetAsync<MedalTallyDTO.SchoolLevelMedalTally.SchoolLevel>(url);
    }

    // Events DTO
    public class EventsDTO
    {
        public class EventDetails
        {
            public class Event
            {
                public string ID { get; set; } = null!;
                public string? EventStage { get; set; }
                public List<EventVersusTeams>? EventVersusList { get; set; }
                public string? Category { get; set; }
                public string? Sport { get; set; }
                public int? SubCategoryID { get; set; }
                public string? Subcategory { get; set; }
                public string? Gender { get; set; }
                public string? Level { get; set; }
                public string? Venue { get; set; }
                public decimal? Latitude { get; set; }
                public decimal? Longitude { get; set; }
                public DateTime? Date { get; set; }
                public TimeSpan? Time { get; set; }
                public bool? OnStream { get; set; }
                public string? StreamService { get; set; }
                public string? StreamURL { get; set; }
                public string? StreamTitle { get; set; }
                public bool? IsFinished { get; set; }
                public bool? Archived { get; set; }
                public bool? Deleted { get; set; }
                public string? FirstName { get; set; }
                public string? LastName { get; set; }
            }

            public class EventVersusTeams
            {
                public int ID { get; set; }
                public string? Score { get; set; }
                public string? Region { get; set; }
                public string? Abbreviation { get; set; }
                public List<EventVersusTeamPlayers>? EventVersusTeamPlayersList { get; set; }
                public DateTime? RecentUpdateAt { get; set; }
            }

            public class EventVersusTeamPlayers
            {
                public int ID { get; set; }
                public int? EventVersusID { get; set; }
                public string? FirstName { get; set; }
                public string? LastName { get; set; }
                public string? School { get; set; }
            }
        }
    }

    // Medal Tally DTO
    public class MedalTallyDTO
    {
        public class RegionalMedalTally
        {
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
            public int? Gold { get; set; }
            public int? Silver { get; set; }
            public int? Bronze { get; set; }
            public int? Total { get; set; }
        }

        public class SchoolLevelMedalTally
        {
            public class SchoolLevel
            {
                public string? Level { get; set; }
                public List<RegionalMedalTally>? RegionalMedalTallyList { get; set; }
            }

            public class RegionalMedalTally
            {
                public string? Region { get; set; }
                public string? Abbreviation { get; set; }
                public int? Gold { get; set; }
                public int? Silver { get; set; }
                public int? Bronze { get; set; }
                public int? Total { get; set; }
            }
        }
    }
}

