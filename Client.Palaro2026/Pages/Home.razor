@page "/"

@using System.Text.Json
@using System.Threading.Tasks
@using Client.Palaro2026.Services
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject APIService apiService
@inject HttpClient httpClient
@inject ThemeService ThemeService

<MudGrid Spacing="20">

    <!-- Hero Section -->
    <MudItem xs="12">
        <MudContainer MaxWidth="MaxWidth.False" Gutters=false>

            <!-- Large screen view -->
            <MudStack Class="pt-20 absolute pa-5 z-10" Style="left: 0; top: 0" Spacing="1">
                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <MudStack Row Spacing="4" AlignItems="AlignItems.Start" Class="text-blur-out pa-3">

                        <!-- Original logo -->
                       @*  <MudImage Src="media/logo/PalaroTuAgsur.png" Height="200" Width="200" /> *@

                        <!-- White logo with countdown below -->
                        <MudStack Spacing="2" AlignItems="AlignItems.Start">

                            <!-- White logo -->
                            <MudImage Src="media/logo/WHITE LOGO.png" Height="250" Width="500" />

                            <!-- Countdown and Ongoing Development -->
                            <MudStack Row Spacing="2" AlignItems="AlignItems.Center">

                                <MudPaper Outlined Style="@($"background-color: {Color.Dark}; width: 200px")"
                                          Elevation="0" Class="pa-2 rounded-0">
                                    @days d : @hours h : @min m : @sec s
                                </MudPaper>

                                <MudText Typo="Typo.body2" Style="color: white">
                                    Ongoing Development
                                </MudText>

                            </MudStack>

                        </MudStack>

                    </MudStack>
                </MudHidden>



                <!-- Mobile view -->
                <MudHidden Breakpoint="Breakpoint.SmAndUp">
                    <MudStack Spacing="1" AlignItems="AlignItems.Start" Class="text-blur-out pl-2">
                        <MudImage Src="media/logo/Logo with 2026.webp" Height="200" Width="200" />
                        <MudText HtmlTag="h1" Style="color: white; font-weight: bold; font-size: 25px">
                            PALARONG PAMBANSA
                            <MudElement>
                                <MudText Class="mt-n2" Style="color: white; font-weight: 200; font-size: 20px">Agusan del Sur | 2026</MudText>
                            </MudElement>
                        </MudText>
                        <MudPaper Outlined Style="@($"background-color: {Color.Dark}")" Elevation="0" Class="pa-2 rounded-0">
                            @days d : @hours h : @min m : @sec s
                        </MudPaper>
                        <MudText Typo="Typo.body2" Style="color: white">Ongoing Development</MudText>
                    </MudStack>
                </MudHidden>
            </MudStack>
            <MudStack Style="position: absolute; width: 100%; height:  calc(100vh - 64px); background: rgba(0,0,0,0.0); z-index: 2;" />

            <!-- Background Image -->
            @if (_sports?.Any() == true)
            {
                <MudCarousel TData="object" Style="height: calc(100vh - 64px); touch-action: none" ShowArrows="false" ShowBullets="false">
                    <MudVirtualize Items="_randomSports" Context="sportData">
                        <MudCarouselItem>
                            <MudStack Style="width: 100%; height: 100%;" Class="relative">

                                <!-- Text Content -->
                                <MudStack Class="absolute pa-5 z-10" Style="left: 0; bottom: 0;" Spacing="0">
                                    <MudText Typo="Typo.h2" Style="color: white; font-weight: bold;">@sportData.Sport</MudText>
                                    <MudText Typo="Typo.body1" Style="color: white;">@sportData.Description</MudText>
                                </MudStack>

                                <!-- Dark Overlay -->
                                <MudStack Style="position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2;">
                                </MudStack>
                                <!-- Background Image -->
                                <MudImage Style="width: 100%; height: 100%;"
                                          Class="absolute z-1 rounded-0 kenburns-top"
                                          Fluid ObjectFit="ObjectFit.Cover"
                                          ObjectPosition="ObjectPosition.Top"
                                          Src="@($"media/sports/images/{sportData.Sport}.webp")" />
                            </MudStack>

                        </MudCarouselItem>
                    </MudVirtualize>
                </MudCarousel>
            }
            else
            {
                <MudPaper Outlined Square Elevation="0" Style="height: 100vh; background-color: dimgrey" Class="z-1" />
            }
        </MudContainer>
    </MudItem>

    <!-- Content Section -->
    <MudItem xs="12">
        <MudContainer MaxWidth="MaxWidth.Large">
            <MudGrid Spacing="20">

                <!-- Introduction Section -->
                <MudItem xs="12" md="4">
                    <MudStack>
                        <MudText Typo="Typo.h2">Palarong Pambansa</MudText>
                        <MudText Typo="Typo.caption">Agusan del Sur | 2026</MudText>
                    </MudStack>
                </MudItem>
                <MudItem xs="12" md=8>
                    <MudStack>
                        <MudText>
                            Palarong Pambansa 2026 is set to be a vibrant celebration of athleticism, unity, and Filipino pride. Hosted in the beautiful province of Agusan del Sur, this year’s games promise to be a memorable showcase of youth talent, sportsmanship, and regional camaraderie.
                        </MudText>
                        <MudText>
                            The Palarong Pambansa serves as the premier national sporting event for student-athletes across the Philippines, bringing together the best from public and private schools under the Department of Education. More than just a competition, it’s a platform for nurturing future champions and promoting values such as discipline, teamwork, and resilience.
                        </MudText>
                        <MudText>
                            This year’s Palaro embraces a forward-thinking vision—highlighting innovation in sports management, promoting inclusivity, and celebrating the diverse cultural identity of every Filipino region. Agusan del Sur stands ready to offer not only world-class competition venues, but also an immersive experience that bridges athletic achievement with rich heritage.
                        </MudText>
                        <MudText>
                            As the whole nation gathers in support, Palarong Pambansa 2026 becomes a symbol of hope, strength, and unity—where dreams are built, friendships are formed, and the spirit of the Filipino youth takes center stage.
                        </MudText>
                    </MudStack>
                </MudItem>

                <!-- Featured News Section -->
                <MudItem xs="12">
                    <MudStack>
                        <MudStack>
                            <MudText Typo="Typo.h2">Featured News</MudText>
                            <MudText Typo="Typo.caption">Catch up on the latest updates and highlights from Palarong Pambansa 2026, including event preparations, athlete profiles, and more.</MudText>
                        </MudStack>
                        <MudDivider />
                        <MudGrid>
                            @if (_newsContents?.Any() == true)
                            {
                                @foreach (var news in _newsContents.Take(3))
                                {
                                    <MudItem xs="12" md="4">
                                        <MudLink Href="@($"news/{news.Category}/{news.Title}")" Underline="Underline.None">
                                            <MudPaper Outlined Style="height: 100%" Class="scale-up-center">
                                                <MudStack Spacing="0" AlignItems="AlignItems.Start">

                                                    @if (_newsImageMap.TryGetValue(news.ID!, out var images) && images?.Any() == true)
                                                    {
                                                        <MudImage ObjectFit="ObjectFit.Contain"
                                                                  Style="height: 100%; width: 100%"
                                                                  Src="@images.First()" />
                                                    }

                                                    <MudStack Class="pa-3">
                                                        <MudText Typo="Typo.body1">
                                                            <b>@news.Title</b>
                                                        </MudText>
                                                        <MudText Typo="Typo.caption">@news.Excerpt</MudText>
                                                    </MudStack>
                                                </MudStack>
                                            </MudPaper>
                                        </MudLink>
                                    </MudItem>
                                }
                            }
                        </MudGrid>

                    </MudStack>
                </MudItem>

                <!-- Tourism Section -->
                <MudItem xs="12">
                    <MudStack>
                        <MudStack>
                            <MudText Typo="Typo.h2">Tourism</MudText>
                            <MudText Typo="Typo.caption">Explore the rich culture, scenic landscapes, and must-visit destinations of Agusan del Sur as it prepares to host Palarong Pambansa 2026.</MudText>
                            <MudDivider />
                        </MudStack>
                        <MudStack Class="flex-md-row">
                            <MudStack Spacing="0">
                                <MudImage ObjectFit="ObjectFit.Contain" Style="height: 100%; width: 100%" Src="media/images/unlock-the-landlocked.png" />
                            </MudStack>
                            <MudStack>
                                <MudText Typo="Typo.body1">
                                    <b>
                                        Unlock Your Golden Adventure
                                    </b>
                                </MudText>
                                <MudText Typo="Typo.caption">
                                    Agusan del Sur—where the excitement goes beyond the games! Discover the natural beauty, rich traditions, and warm hospitality that make this province a one-of-a-kind destination. Whether you’re here to cheer, compete, or explore, Agusan del Sur offers a perfect mix of adventure and relaxation. Come for the competition, stay for the unforgettable experience!
                                </MudText>
                            </MudStack>
                        </MudStack>
                        <MudStack>
                            <MudButton EndIcon="@Icons.Material.Filled.ArrowForward" Variant="Variant.Text" Size="Size.Large" Href="https://tourism.agusandelsur.gov.ph/" Target="_blank">Visit the Official Site</MudButton>
                        </MudStack>
                    </MudStack>
                </MudItem>

                <!-- Sports Section -->
                <MudItem xs="12">
                    <MudStack>
                        <MudStack>
                            <MudText Typo="Typo.h2">Sports</MudText>
                            <MudText Typo="Typo.caption">Palaro Sports features diverse athletic events, promoting competition, teamwork, and inclusivity across various disciplines.</MudText>
                            <MudDivider />
                        </MudStack>
                        <MudTabs KeepPanelsAlive Elevation="0" ApplyEffectsToContainer="true" PanelClass="pt-6">
                            <MudVirtualize Items="_sportCategories" Context="categoryData">
                                <MudTabPanel Style="text-transform: none" Text="@categoryData.Category">
                                    <MudGrid>
                                        <MudVirtualize Items="_sports?.Where(s => s.SportCategoryID == categoryData.ID).ToList()" Context="sport">
                                            <MudItem xs="6" sm="4" md="6" lg="4" xl="3">
                                                <MudLink Href="@($"sports/{categoryData.Category}/{sport.Sport}")" Underline="Underline.None">
                                                    <MudPaper Outlined Class="scale-up-center">
                                                        <MudStack AlignItems="AlignItems.Center" Class="pa-3">
                                                            <MudImage ObjectFit="ObjectFit.Contain" Height="70" Src="@($"media/sports/icons/{(ThemeService.IsDarkMode == true ? "white" : "black")}/{sport.Sport}.webp")" />
                                                            <MudText>@sport.Sport</MudText>
                                                        </MudStack>
                                                    </MudPaper>
                                                </MudLink>
                                            </MudItem>
                                        </MudVirtualize>
                                    </MudGrid>
                                </MudTabPanel>
                            </MudVirtualize>
                        </MudTabs>
                        <MudButton EndIcon="@Icons.Material.Filled.ArrowForward" Variant="Variant.Text" Size="Size.Large" Href="./venues">Sporting Event Venues</MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </MudItem>
</MudGrid>
<FooterComponent />

@code {
    /* ---------------------------
       Injected Services, Variables, and Data Mapping

       - handles dialogs and modals
       - manages and stores and data coming from API calls

    --------------------------- */

    // Dialog instance
    private IMudDialogInstance? MudDialog { get; set; }

    // Countdown variables
    private string eventStarted = string.Empty;
    private string days = string.Empty;
    private string hours = string.Empty;
    private string min = string.Empty;
    private string sec = string.Empty;

    // use target date to the selected date and time for the palaro 2026 event
    private readonly DateTime targetDate = new(2026, 5, 24, 0, 0, 0);
    private Timer? timer;

    // stored data from API calls
    private List<SportsDTO.Sports>? _sports;
    private List<SportsDTO.Sports>? _randomSports;
    private List<SportsDTO.SportCategories>? _sportCategories;
    private List<NewsDTO.NewsDetails.NewsContent>? _newsContents;

    // Maps newsID → list of image URLs
    private Dictionary<string, List<string>> _newsImageMap = new();

    /* ---------------------------
        Lifecycle Methods

        - methods that manage the component's lifecycle and state

    --------------------------- */

    // loads theme preference and fetches initial data
    protected override async Task OnInitializedAsync()
    {
        // load theme preference
        ThemeService.OnThemeChanged += StateHasChanged;
        await ThemeService.LoadThemePreference();

        // start countdown and fetch data
        await StartCountdown();
        
        // load data from API
        await GetNewsDetailsAsync();
        await GetSportsAsync();
        await GetSportCategoriesAsync();
    }

    /* ---------------------------
        Countdown Logic

        - manages the countdown timer to the event date
    --------------------------- */
    private Task StartCountdown()
    {
        // trigger every second
        timer = new Timer(UpdateCountdown, null, 0, 1000);
        return Task.CompletedTask;
    }

    private void UpdateCountdown(object? state)
    {
        var timeLeft = targetDate - DateTime.Now;

        if (timeLeft.TotalSeconds > 0)
        {
            days = timeLeft.Days.ToString("D2");
            hours = timeLeft.Hours.ToString("D2");
            min = timeLeft.Minutes.ToString("D2");
            sec = timeLeft.Seconds.ToString("D2");
        }
        else
        {
            eventStarted = "The event has started!";
            timer?.Dispose();
            timer = null;
        }

        InvokeAsync(StateHasChanged);
    }

    /* ---------------------------
       API Calls

       - methods for fetching data from APIs

    --------------------------- */

    // Fetches sports data and randomizes the order for display
    private async Task GetSportsAsync()
    {
        string url = "/Sports";
        _sports = await apiService.GetAsync<SportsDTO.Sports>(url);

        var random = new Random();
        _randomSports = _sports?.OrderBy(_ => random.Next()).ToList();
    }

    // Fetches sport categories data
    private async Task GetSportCategoriesAsync()
    {
        string url = "/Sports/Categories";
        _sportCategories = await apiService.GetAsync<SportsDTO.SportCategories>(url);
    }

    // Fetches news details and associated images
    private async Task GetNewsDetailsAsync()
    {
        string url = "/News/Details?isArchived=false&isPublished=false";
        _newsContents = await apiService.GetAsync<NewsDTO.NewsDetails.NewsContent>(url);

        if (_newsContents is not null)
            await LoadNewsImagesAsync(_newsContents.Select(n => n.ID));
    }

    // Loads images for each news item based on its ID
    private async Task LoadNewsImagesAsync(IEnumerable<string?> newsIDs)
    {
        var baseUrl = "https://palarongpambansa2026.com/attachments/media/news";

        foreach (var newsID in newsIDs.Where(id => !string.IsNullOrWhiteSpace(id))!)
        {
            try
            {
                var apiUrl = $"/News/NewsImages?newsID={newsID}";
                var imageFiles = await apiService.GetAsync<string>(apiUrl);

                if (imageFiles?.Count > 0)
                {
                    var fullUrls = imageFiles
                        .Where(file => !string.IsNullOrWhiteSpace(file))
                        .Select(file => $"{baseUrl}/{newsID}/{file}")
                        .ToList();

                    _newsImageMap[newsID!] = fullUrls;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading images for news {newsID}: {ex.Message}");
            }
        }
    }

    /* ---------------------------
       DTO Classes

       - Data Transfer Objects for handling API responses
       Note: Please refer to the API documentation for more details.

    --------------------------- */

    // DTO for Sports data
    public class SportsDTO
    {
        public class SportCategories
        {
            public int ID { get; set; }
            public string? Category { get; set; }
        }

        public class Sports
        {
            public int ID { get; set; }
            public string? Sport { get; set; }
            public string? Description { get; set; }
            public int? SportCategoryID { get; set; }
        }
    }

    // DTO for News data
    public class NewsDTO
    {
        public class NewsDetails
        {
            public class NewsContent
            {
                public string? ID { get; set; }
                public string? Category { get; set; }
                public string? Author { get; set; }
                public string? Title { get; set; }
                public string? Content { get; set; }
                public string? Excerpt { get; set; }
                public DateTime? DateCreated { get; set; }
                public bool? IsPublished { get; set; }
                public DateTime? DatePublished { get; set; }
                public bool? IsArchived { get; set; }
                public List<string> ImageUrls { get; set; } = new();
            }
        }
    }
}
