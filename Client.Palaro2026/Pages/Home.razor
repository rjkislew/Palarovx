@page "/"

@using System.Text.Json
@using System.Threading.Tasks
@inject IJSRuntime JSRuntime
@inject APIService apiService
@inject HttpClient httpClient
@inject ThemeService ThemeService

<MudGrid Spacing="20">
    <!-- Hero Content / Header -->
    <MudItem xs="12">
        <MudContainer MaxWidth="MaxWidth.False" Gutters=false>
            <MudStack Class="pt-20 absolute pa-5 z-10" Style="left: 0; top: 0" Spacing="1">
                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <MudStack Row Spacing="0" AlignItems="AlignItems.Center" Class="text-blur-out">
                        <MudImage Src="media/logo/logo with 2026.webp" Height="200" Width="200" />
                        <MudStack Spacing="1" Class="pl-2">
                            <MudText Typo="Typo.h2"HtmlTag="h1" Style="color: white; font-weight: bold">
                                PALARONG PAMBANSA
                                <MudElement>
                                    <MudText Typo="Typo.h3" Class="mt-n3" Style="color: white; font-weight: 200">Agusan del Sur | 2026</MudText>
                                </MudElement>
                            </MudText>
                            <MudStack Row AlignItems="AlignItems.Center">
                                <MudPaper Style="@($"background-color: {Color.Dark}")" Elevation="0" Class="pa-2 rounded-0">
                                    @days d : @hours h : @min m : @sec s
                                </MudPaper>
                                <MudText Typo="Typo.body2" Style="color: white">Ongoing Development</MudText>
                            </MudStack>
                        </MudStack>
                    </MudStack>
                </MudHidden>
                <MudHidden Breakpoint="Breakpoint.SmAndUp">
                    <MudStack Spacing="1" AlignItems="AlignItems.Start" Class="text-blur-out pl-2">
                        <MudImage Src="media/logo/Logo with 2026.webp" Height="200" Width="200" />
                        <MudText HtmlTag="h1" Style="color: white; font-weight: bold; font-size: 25px">
                            PALARONG PAMBANSA
                            <MudElement>
                                <MudText Class="mt-n2" Style="color: white; font-weight: 200; font-size: 20px">Agusan del Sur | 2026</MudText>
                            </MudElement>
                        </MudText>
                        <MudStack Row AlignItems="AlignItems.Center">
                            <MudPaper Style="@($"background-color: {Color.Dark}")" Elevation="0" Class="pa-2 rounded-0">
                                @days d : @hours h : @min m : @sec s
                            </MudPaper>
                            <MudText Typo="Typo.body2" Style="color: white">Ongoing Development</MudText>
                        </MudStack>
                    </MudStack>
                </MudHidden>
            </MudStack>
            <MudStack Style="position: absolute; width: 100%; height:  calc(100vh - 64px); background: rgba(0,0,0,0.0); z-index: 2;" />
            @if (_sports?.Any() == true)
            {
                <MudCarousel TData="object" Style="height: calc(100vh - 64px); touch-action: none" ShowArrows="false" ShowBullets="false">
                    <MudVirtualize Items="_randomSports" Context="sportData">
                        <MudCarouselItem>
                            <MudStack Style="width: 100%; height: 100%;" Class="relative">

                                <!-- Text Content -->
                                <MudStack Class="absolute pa-5 z-10" Style="left: 0; bottom: 0;" Spacing="0">
                                    <MudText Typo="Typo.h2" Style="color: white; font-weight: bold;">@sportData.Sport</MudText>
                                    <MudText Typo="Typo.body1" Style="color: white;">@sportData.Description</MudText>
                                </MudStack>

                                <!-- Dark Overlay -->
                                <MudStack Style="position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2;">
                                </MudStack>
                                <!-- Background Image -->
                                <MudImage Style="width: 100%; height: 100%;"
                                          Class="absolute z-1 rounded-0 kenburns-top"
                                          Fluid ObjectFit="ObjectFit.Cover"
                                          ObjectPosition="ObjectPosition.Top"
                                          Src="@($"media/sports/images/{sportData.Sport}.webp")" />
                            </MudStack>

                        </MudCarouselItem>
                    </MudVirtualize>
                </MudCarousel>
            }
            else
            {
                <MudPaper Square Elevation="0" Style="height: 100vh; background-color: white" Class="z-1" />
            }
        </MudContainer>
    </MudItem>

    <!-- Home Content -->
    <MudItem xs="12">
        <MudContainer MaxWidth="MaxWidth.Large">
            <MudGrid Spacing="20">

                <!-- Featured News Section -->
                <MudItem xs="12">
                    <MudStack>
                        <MudStack Style="width: 100%" AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h2">News</MudText>
                            <MudText Typo="Typo.caption">Stay updated with the latest news and developments on Palarong Pambansa 2026, including event preparations, venue updates, and more.</MudText>
                        </MudStack>
                        <MudDivider />
                        <MudGrid>
                            <MudItem xs="12" md="5">
                                <MudStack>
                                    <MudImage ObjectFit="ObjectFit.Contain" Style="height: 100%; width: 100%" Src="media/images/DO-Plaza-Memorial-Sports-Complex.jpg" />
                                    <MudText Typo="Typo.caption" Class="mb-3"><b>Aerial View of Sports Complex:</b> A drone shot showcasing the expansive layout of the D.O. Plaza Memorial Sports Complex, highlighting its modern infrastructure.</MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12" md="7">
                                <MudStack>
                                    <MudText Typo="Typo.body1">
                                        <b>
                                            Agusan del Sur to Host 66th Palarong Pambansa in 2026
                                        </b>
                                    </MudText>
                                    <MudText Typo="Typo.body2" Style="line-height: 2">
                                        The 66th Palarong Pambansa is scheduled to be held in 2026 in Prosperidad, Agusan del Sur, marking the first time the province will host this national sporting event. This opportunity is considered a <i>"dream come true"</i> for the province, which has been aspiring to host the Palaro for about three decades.

                                        The decision to award the hosting rights to Agusan del Sur was announced during the closing ceremonies of the 2024 Palarong Pambansa in Cebu City. The province's bid highlighted its extensive sports facilities, accommodations, and transportation infrastructure, emphasizing its readiness to welcome athletes, coaches, and spectators from across the Philippines.
                                    </MudText>
                                    <MudStack Spacing="0" AlignItems="AlignItems.Start">
                                        <MudButton StartIcon="@Icons.Material.Filled.Newspaper" Href="https://www.manilatimes.net/2024/07/19/sports/agusan-del-sur-to-host-palaro-in-2026/1958316" Target="blanks" Style="text-transform: none">Agusan del Sur to host Palaro in 2026</MudButton>
                                        <MudButton StartIcon="@Icons.Material.Filled.Newspaper" Href="https://newsinfo.inquirer.net/1919116/agusan-del-sur-bids-to-host-palarong-pambansa-in-2026" Target="blanks" Style="text-transform: none">Agusan del Sur bids to host Palarong Pambansa in 2026</MudButton>
                                        <MudButton StartIcon="@Icons.Material.Filled.Newspaper" Href="https://mindanews.com/top-stories/2024/07/hosting-of-palaro-2026-is-dream-come-true-for-agusan-sur-governor-says/" Target="blanks" Style="text-transform: none">Hosting of Palaro 2026 is ‘dream come true’ for Agusan Sur, governor says</MudButton>
                                    </MudStack>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12" md="5">
                                <MudStack>
                                    <MudImage ObjectFit="ObjectFit.Contain" Style="height: 100%; width: 100%" Src="media/images/CRAG 2024.jpg" />
                                    <MudText Typo="Typo.caption" Class="mb-3"><b>Elias Tabac ignites the spirit of CRAG 2024</b> - Caraga’s standout athlete, Elias Tabac, proudly raises the torch during the opening ceremony of the Caraga Regional Athletic Games 2024, symbolizing unity, determination, and sports excellence.</MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12" md="7">
                                <MudStack>
                                    <MudText Typo="Typo.body1">
                                        <b>
                                            CRAG 2024 Unveils Upgraded Facilities, Setting the Stage for Palaro 2026
                                        </b>
                                    </MudText>
                                    <MudText Typo="Typo.body2" Style="line-height: 2">
                                        The Agusan del Sur Sports Complex, with its newly upgraded facilities, hosted the Caraga Regional Athletic Games (CRAG) 2024 in Prosperidad, providing a top-tier venue for athletes across the region. Featuring modern sports amenities, the complex demonstrated the province’s commitment to sports development and its capability to host major competitions.

                                        This successful hosting strengthens Agusan del Sur’s preparations for the 66th Palarong Pambansa in 2026, marking the first time the province will welcome this prestigious national sporting event. The province’s bid emphasized its enhanced sports infrastructure, accommodations, and transportation network, ensuring a world-class experience for athletes, coaches, and spectators from across the country.
                                    </MudText>
                                    <MudStack Spacing="0" AlignItems="AlignItems.Start">
                                        <MudButton StartIcon="@Icons.Custom.Brands.Facebook" Href="https://www.facebook.com/CaRAGa2024" Target="blanks" Style="text-transform: none">Read More: Caraga Regional Athletic Games 2024 </MudButton>
                                    </MudStack>
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudItem>

                <!-- Tourism Section -->
                <MudItem xs="12">
                    <MudStack>
                        <MudStack Style="width: 100%" AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h2">Tourism</MudText>
                            <MudText Typo="Typo.caption">Explore the rich culture, scenic landscapes, and must-visit destinations of Agusan del Sur as it prepares to host Palarong Pambansa 2026.</MudText>
                            <MudDivider />
                        </MudStack>
                        <MudStack Class="flex-md-row">
                            <MudStack Spacing="0">
                                <MudImage ObjectFit="ObjectFit.Contain" Style="height: 100%; width: 100%" Src="media/images/unlock-the-landlocked.png" />
                            </MudStack>
                            <MudStack>
                                <MudText Typo="Typo.body1">
                                    <b>
                                        Discover Agusan del Sur: Beyond the Games
                                    </b>
                                </MudText>
                                <MudText Typo="Typo.body2" Style="line-height: 2">
                                    Welcome to Palaro 2026 in Agusan del Sur—where the excitement goes beyond the competition! Explore hidden gems like the serene Agusan Marsh, the stunning Gibong River, and the untouched beauty of Lake Himbang. Dive into the rich culture of the Manobo people, savor local flavors, and experience warm hospitality. Whether you’re up for adventure or relaxation, Agusan del Sur is ready to amaze you. Come for the games, stay for the experience!
                                </MudText>
                                <MudButton Href="https://tourism.agusandelsur.gov.ph/" Target="blank" Style="text-transform: none">Visit the Official Site</MudButton>
                            </MudStack>
                        </MudStack>
                    </MudStack>
                </MudItem>

                <!-- SPORTS -->
                <MudItem xs="12">
                    <MudStack>
                        <MudStack Style="width: 100%" AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h2">Sports</MudText>
                            <MudText Typo="Typo.caption">Palaro Sports features diverse athletic events, promoting competition, teamwork, and inclusivity across various disciplines.</MudText>
                            <MudDivider />
                        </MudStack>
                        <MudTabs Elevation="0" ApplyEffectsToContainer="true" PanelClass="pa-6" Centered>
                            <MudVirtualize Items="_sportCategories" Context="categoryData">
                                <MudTabPanel Style="text-transform: none" Text="@categoryData.Category">
                                    <MudStack Row Wrap="Wrap.Wrap" Justify="Justify.Center">
                                        <MudVirtualize Items="_sports?.Where(s => s.SportCategoryID == categoryData.ID).ToList()" Context="sport">
                                            <MudChip T="string" Variant="Variant.Outlined" Href="@($"sports/{categoryData.Category}/{sport.Sport}")" Size="Size.Large">
                                                <MudStack Row AlignItems="AlignItems.Center">
                                                    <MudImage ObjectFit="ObjectFit.Contain" Height="20" Src="@($"media/sports/icons/{(ThemeService.IsDarkMode == true ? "white" : "black")}/{sport.Sport}.webp")" />
                                                    @sport.Sport
                                                </MudStack>
                                            </MudChip>
                                        </MudVirtualize>
                                    </MudStack>
                                </MudTabPanel>
                            </MudVirtualize>
                        </MudTabs>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </MudItem>
</MudGrid>
<FooterComponent />

@code
{
    private string eventStarted = string.Empty;
    private string days = string.Empty;
    private string hours = string.Empty;
    private string min = string.Empty;
    private string sec = string.Empty;
    private DateTime targetDate = new DateTime(2026, 7, 10, 0, 0, 0);
    private Timer? timer;
    private List<SportsDTO.Sports>? _sports;
    private List<SportsDTO.Sports>? _randomSports;
    private List<SportsDTO.SportCategories>? _sportCategories;


    public class SportsDTO
    {
        public class SportCategories
        {
            public int ID { get; set; }
            public string? Category { get; set; }
        }

        public class Sports
        {
            public int ID { get; set; }
            public string? Sport { get; set; }
            public string? Description { get; set; }
            public int? SportCategoryID { get; set; }
        }
    }

    // Initialization method to fetch data and update UI elements
    protected override async Task OnInitializedAsync()
    {
        ThemeService.OnThemeChanged += StateHasChanged;
        await ThemeService.LoadThemePreference();
        await StartCountdown();
        await GetSportsAsync();
        await GetSportCategoriesAsync();
    }


    private Task StartCountdown()
    {
        // Set up a timer to trigger every second
        timer = new Timer(UpdateCountdown, null, 0, 1000);
        return Task.CompletedTask;
    }

    private void UpdateCountdown(object? state)
    {
        var timeLeft = targetDate - DateTime.Now;

        if (timeLeft.TotalSeconds > 0)
        {
            days = timeLeft.Days.ToString("D2");
            hours = timeLeft.Hours.ToString("D2");
            min = timeLeft.Minutes.ToString("D2");
            sec = timeLeft.Seconds.ToString("D2");
        }
        else
        {
            // Event has started
            eventStarted = "The event has started!";
            timer?.Dispose(); // Stop the timer when the countdown is over
            timer = null; // Clear the reference to the disposed timer
        }

        InvokeAsync(StateHasChanged); // Update UI
    }

    private async Task GetSportsAsync()
    {
        try
        {
            var storedData = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "sportsData");

            if (!string.IsNullOrEmpty(storedData) && storedData != "null")
            {
                //Console.WriteLine($"📦 Raw JSON from localStorage...");

                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                _sports = JsonSerializer.Deserialize<List<SportsDTO.Sports>>(storedData, options);
            }

            else
            {
                //Console.WriteLine("🌐 Fetching sports from API...");

                string url = $"{apiService.Palaro2026API}/Sports";
                HttpResponseMessage httpResponse = await httpClient.GetAsync(url);
                httpResponse.EnsureSuccessStatusCode();

                using var responseStream = await httpResponse.Content.ReadAsStreamAsync();
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                _sports = await JsonSerializer.DeserializeAsync<List<SportsDTO.Sports>>(responseStream, options);

                var jsonData = JsonSerializer.Serialize(_sports);
                await JSRuntime.InvokeVoidAsync("localStorageHelper.set", "sportsData", jsonData);
            }

            var random = new Random();
            _randomSports = _sports?.OrderBy(_ => random.Next()).ToList();
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"❌ Error fetching data: {ex.Message}");
        }
    }

    private async Task GetSportCategoriesAsync()
    {
        try
        {
            string url = $"{apiService.Palaro2026API}/Sports/Categories";

            HttpResponseMessage httpResponse = await httpClient.GetAsync(url);
            httpResponse.EnsureSuccessStatusCode(); // Ensure a successful response

            using var responseStream = await httpResponse.Content.ReadAsStreamAsync();
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            _sportCategories = await JsonSerializer.DeserializeAsync<List<SportsDTO.SportCategories>>(responseStream, options);
        }
        catch (HttpRequestException ex)
        {
            // Handle exception, log, or display an error message
            Console.WriteLine($"Error fetching data: {ex.Message}");
        }
    }
}