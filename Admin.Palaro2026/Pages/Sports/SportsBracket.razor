@page "/sports/brackets"
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject APIService apiService


<PageTitle>Sports Brackets | Palaro tu AgSur 2026</PageTitle>

<MudGrid Spacing="0">
    @if (_brackets != null && _brackets.Any())
    {
        <MudItem xs="12">
            <MudStack Row Spacing="0" Justify="Justify.FlexEnd">
                <MudButton Size="Size.Large" Style="text-transform: none" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddBracketDialog">Add Bracket</MudButton>
                <MudDivider Vertical="true" FlexItem="true" />
                <MudButton Size="Size.Large" StartIcon="@Icons.Material.Filled.Refresh" OnClick="GetBracketsAsync">Refresh Data</MudButton>
            </MudStack>
        </MudItem>

        <MudItem xs="12" Class="my-4">
            <MudStack Row Spacing="2">
                <MudSelect T="int?" Label="Select Bracket"
                           Value="_selectedBracketID"
                           ValueChanged="OnBracketChanged"
                           Dense="true" Variant="Variant.Outlined"
                           Style="width: 250px;">

                    @foreach (var bracket in _brackets)
                    {
                        <MudSelectItem T="int?" Value="bracket.ID">@bracket.BracketName</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect T="int?" Label="Select Region" @bind-Value="_selectedRegionID" Dense="true" Variant="Variant.Outlined" Style="width: 250px;"
                           Disabled="_regionsForSelectedBracket == null || !_regionsForSelectedBracket.Any()">
                    @if (_regionsForSelectedBracket?.Any() == true)
                    {
                        @foreach (var region in _regionsForSelectedBracket)
                        {
                            <MudSelectItem T="int?" Value="region.RegionID">@region.RegionName (@region.RegionAbbreviation)</MudSelectItem>
                        }
                    }
                </MudSelect>
            </MudStack>
        </MudItem>

        <MudItem xs="12">
            <MudTable Outlined Items="_brackets" Context="bracket" FixedHeader FixedFooter Height="calc(87vh - 150px)" Virtualize="true" Filter="FilterFunc" Elevation="0">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Sports Brackets</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchString" Immediate Placeholder="Search"
                    Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.Search"
                    IconSize="Size.Medium" Clearable />
                </ToolBarContent>

                <HeaderContent>
                    <MudTh>Bracket Name</MudTh>
                    <MudTh>Sport</MudTh>
                    <MudTh>Regions</MudTh>
                    <MudTh style="width: 100px; text-align: center;">Actions</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>@bracket.BracketName</MudTd>
                    <MudTd>@bracket.SportName</MudTd>
                    <MudTd>
                        @if (bracket.RegionsList?.Any() == true)
                        {
                            <MudChipSet T="string" Dense="true">
                                @foreach (var region in bracket.RegionsList)
                                {
                                    <MudChip T="string" Color="Color.Primary" Label="true">@region.RegionAbbreviation</MudChip>
                                }
                            </MudChipSet>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption">No Regions</MudText>
                        }
                    </MudTd>
                    <MudTd Style="text-align: center">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="() => OpenEditBracketDialog(bracket.ID)" />
                    </MudTd>
                </RowTemplate>

                <NoRecordsContent>
                    <MudText Typo="Typo.caption">No matching records found.</MudText>
                </NoRecordsContent>

                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudItem>
    }
    else
    {
        <MudItem xs="12">
            <MudProgressLinear Indeterminate="true" />
        </MudItem>
    }
</MudGrid>

@code {
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }

    private List<BracketDisplayRow> _brackets = new();

    private int? _selectedBracketID;
    private int? _selectedRegionID;
    private List<SportsDTO.SportsBracketRegions>? _regionsForSelectedBracket;
    private List<BracketDisplayRow> _filteredBrackets = new();

    private string _searchString = "";

    private bool FilterFunc(BracketDisplayRow bracket)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        return bracket.BracketName?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true
            || bracket.SportName?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true
            || (bracket.RegionsList != null && bracket.RegionsList.Any(r =>
                   r.RegionName?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true ||
                   r.RegionAbbreviation?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true));
    }

    public class SportsDTO
    {
        public class SportsBracket
        {
            public int ID { get; set; }
            public int SportID { get; set; }
            public string? BracketName { get; set; }
            public string? SportName { get; set; }
            public List<SportsBracketRegions>? RegionsList { get; set; }
        }

        public class SportsBracketRegions
        {
            public int ID { get; set; }
            public int BracketID { get; set; }
            public int RegionID { get; set; }
            public string? RegionName { get; set; }
            public string? RegionAbbreviation { get; set; }
        }
    }

    public class BracketDisplayRow
    {
        public int ID { get; set; }
        public int SportID { get; set; }
        public string? BracketName { get; set; }
        public string? SportName { get; set; }
        public List<SportsDTO.SportsBracketRegions>? RegionsList { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await GetBracketsAsync();
        _filteredBrackets = _brackets;
    }

    private async Task GetBracketsAsync()
    {
        string url = "Sports/SportsBracketWithRegions";
        var bracketsDto = await apiService.GetAsync<SportsDTO.SportsBracket>(url);

        _brackets = bracketsDto.Select(b => new BracketDisplayRow
            {
                ID = b.ID,
                SportID = b.SportID,
                BracketName = b.BracketName,
                SportName = b.SportName,
                RegionsList = b.RegionsList
            }).ToList();
    }

    private async Task OnBracketChanged(int? bracketId)
    {
        _selectedBracketID = bracketId;
        _selectedRegionID = null;

        if (bracketId.HasValue)
        {
            var selected = _brackets.FirstOrDefault(b => b.ID == bracketId);
            _regionsForSelectedBracket = selected?.RegionsList ?? new();
            _filteredBrackets = new List<BracketDisplayRow> { selected! };
        }
        else
        {
            _regionsForSelectedBracket = null;
            _filteredBrackets = _brackets;
        }
    }

    private async Task OpenAddBracketDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true, CloseOnEscapeKey = true, BackdropClick = false };
        var dialog = await DialogService.ShowAsync<BracketDialog>("Add Bracket", options); // no parameters needed for Add
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await GetBracketsAsync();
            Snackbar.Add("Bracket added successfully.", Severity.Success);
        }
    }


    private async Task OpenEditBracketDialog(int bracketID)
    {
        var parameters = new DialogParameters
            {
                ["BracketID"] = bracketID
            };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true, CloseOnEscapeKey = true, BackdropClick = false };


        var dialog = DialogService.Show<BracketDialog>("Edit Bracket", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await GetBracketsAsync();
            Snackbar.Add("Bracket updated successfully.", Severity.Success);
        }
    }
}
