@page "/score/chess"
@inject ISnackbar Snackbar
@inject APIService apiService

<PageTitle>Chess Scoring | PALARO 2026</PageTitle>
<MudText Typo="Typo.h6" Align="Align.Center">Chess Match (Sets / Games)</MudText>

<!-- FILTERS SECTION -->
<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-4">Event Filters</MudText>
    <MudGrid Spacing="3" Justify="Justify.Center">
        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedSportIDValue" Margin="Margin.Dense" Label="Sport"
                       T="int?"
                       ShrinkLabel Variant="Variant.Outlined"
                       SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                  {
                                                      _selectedSchoolLevelAndGenderID = null;
                                                      _selectedSportSubcategoryIDValue = null;
                                                      _selectedMainCategoryValue = null;
                                                      await FilterSchoolLevelAndGenderAsync();
                                                  }))">
                <MudSelectItem T="int?" Value="9">Chess</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="_selectedSchoolLevelAndGenderID" Margin="Margin.Dense"
                       Label="School Level and Gender" T="string"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="_selectedSportIDValue == null"
                       SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                  {
                                                      _selectedSportSubcategoryIDValue = null;
                                                      _selectedMainCategoryValue = null;
                                                      await GetSportSubCategoriesSLGAsync();
                                                      LoadMainCategories();
                                                  }))">
                <MudVirtualize Items="_combinedSchoolLevelAndGenderNames" Context="combinedID">
                    <MudSelectItem T="string" Value="@combinedID">
                        @combinedID
                    </MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedMainCategoryValue" Margin="Margin.Dense"
                       Label="Event" T="string"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                @foreach (var mc in _sportMainCat)
                {
                    <MudSelectItem Value="@mc">@mc</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="_selectedSportSubcategoryIDValue" Margin="Margin.Dense"
                       Label="Category" T="int?"
                       HelperText="@((_sportSubcategories?.Any() != true && _selectedSchoolLevelAndGenderID != null) ? "No subcategory available for this gender or school level." : null)"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                <MudVirtualize Items="@GetFilteredSubcategories()" Context="subCategory">
                    <MudSelectItem T="int?" Value="@subCategory.ID">@subCategory.Subcategory</MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedEventStagesIDValue" Margin="Margin.Dense"
                       Label="Stage" T="int?"
                       ShrinkLabel Variant="Variant.Outlined" Clearable>
                <MudVirtualize Items="_eventStages" Context="eventStage">
                    <MudSelectItem T="int?" Value="eventStage.ID">@eventStage.Stage</MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-3" Justify="Justify.Center">
        <MudItem xs="12" sm="4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="ApplyFilters" FullWidth StartIcon="@Icons.Material.Filled.Search">
                Apply Filters
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                       OnClick="ClearFilters" FullWidth StartIcon="@Icons.Material.Filled.Clear">
                Clear Filters
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<!-- SELECTED EVENT INFO -->
@if (SelectedEvent != null)
{
    <MudPaper Class="pa-3 mb-4" Elevation="1" Style="background-color: #e3f2fd;">
        <MudGrid Spacing="3">
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.body2"><strong>Event:</strong> @SelectedEvent.Sport - @SelectedEvent.Subcategory</MudText>
            </MudItem>
            <MudItem xs="12" sm="5">
                <MudText Typo="Typo.body2"><strong>Level and Gender:</strong> @SelectedEvent.Level - @SelectedEvent.Gender</MudText>
            </MudItem>
            @* <MudItem xs="12" sm="3">
                <MudText Typo="Typo.body2"><strong>Level:</strong> @SelectedEvent.Level</MudText>
            </MudItem> *@
            <MudItem xs="12" sm="3">
                <MudText Typo="Typo.body2"><strong>Stage:</strong> @SelectedEvent.EventStage</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>
}

<!-- MATCH TABLES -->
<MudGrid Spacing="3">
    <MudItem xs="12">
        @if (Regions == null)
        {
            <MudText Align="Align.Center" Class="ma-4">Please apply filters to see regions</MudText>
        }
        else if (!Regions.Any())
        {
            <MudText Align="Align.Center" Class="ma-4">No regions found. Please apply filters to see regions.</MudText>
        }
        else
        {
            <MudDropContainer T="RegionItem"
                              Items="Regions"
                              ItemsSelector="SelectItemsForZone"
                              ItemDropped="OnItemDropped"
                              @key="@($"dropcontainer_{SelectedSet}")">

                <ChildContent>
                    <MudPaper Class="pa-2 mt-4 mb-6"
                              Elevation="3"
                              Style="position:sticky; top:0; z-index:1000; background-color:white;">

                        <MudGrid Class="my-2" Justify="Justify.Center" Spacing="4">
                            <MudItem xs="12" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Success" OnClick="AddTable" FullWidth>
                                    Add Table
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="NextSet" FullWidth>
                                    Next Set / Game
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudSelect T="int" Label="Preview Set" FullWidth
                                           Value="SelectedSet"
                                           ValueChanged="OnSetChanged">
                                    @foreach (var setNum in Enumerable.Range(1, AllSets.Count))
                                    {
                                        <MudSelectItem Value="@setNum">Set @setNum</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                        </MudGrid>

                        <MudText Typo="Typo.subtitle1" Align="Align.Center">Regions (Set @SelectedSet) - Total: @Regions.Count</MudText>
                        <MudDropZone T="RegionItem"
                                     Identifier="Unassigned"
                                     Class="d-flex flex-wrap justify-center pa-2"
                                     Style="min-height:100px; gap:6px; border:1px dashed gray;" />
                    </MudPaper>

                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.h6" Align="Align.Center">Match Tables</MudText>
                    <MudDivider Class="my-2" />

                    <MudGrid Spacing="3" Class="my-2" Justify="Justify.Center">
                        @foreach (var table in Tables)
                        {
                            var whiteId = $"{SelectedSet}_{table}_White";
                            var blackId = $"{SelectedSet}_{table}_Black";
                            bool isLastTable = table == Tables.Last();

                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Elevation="2" Class="pa-3" Style="position:relative;">

                                    @if (isLastTable)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Cancel"
                                                       Color="Color.Error"
                                                       Size="Size.Small"
                                                       Style="position:absolute; top:4px; right:4px;"
                                                       OnClick="@(() => RemoveTable(table))"
                                                       Title="Remove last table" />
                                    }

                                    <MudText Typo="Typo.subtitle1" Align="Align.Center">@table</MudText>
                                    <MudDivider Class="my-2" />

                                    <MudGrid>
                                        <!-- White -->
                                        <MudItem xs="6">
                                            <MudStack Row="true" Style="align-items:center" Justify="Justify.Center" Spacing="1">
                                                <MudText Typo="Typo.body2">White</MudText>

                                                @if (GetResultIndicator(table, "White") != null)
                                                {
                                                    <MudText Typo="Typo.body2"
                                                             Color="@GetResultColor(table, "White")"
                                                             Class="font-weight-bold">
                                                        @GetResultIndicator(table, "White")
                                                    </MudText>
                                                }
                                            </MudStack>

                                            <MudDropZone T="RegionItem"
                                                         Identifier="@whiteId"
                                                         Class="pa-1 d-flex flex-wrap justify-center"
                                                         Style="min-height:60px; border:1px dashed gray;" />
                                        </MudItem>

                                        <!-- Black -->
                                        <MudItem xs="6">
                                            <MudStack Row="true" Style="align-items:center" Justify="Justify.Center" Spacing="1">
                                                <MudText Typo="Typo.body2">Black</MudText>

                                                @if (GetResultIndicator(table, "Black") != null)
                                                {
                                                    <MudText Typo="Typo.body2"
                                                             Color="@GetResultColor(table, "Black")"
                                                             Class="font-weight-bold">
                                                        @GetResultIndicator(table, "Black")
                                                    </MudText>
                                                }
                                            </MudStack>

                                            <MudDropZone T="RegionItem"
                                                         Identifier="@blackId"
                                                         Class="pa-1 d-flex flex-wrap justify-center"
                                                         Style="min-height:60px; border:1px dashed gray;" />
                                        </MudItem>
                                    </MudGrid>


                                    <MudGrid Class="mt-1">
                                        <MudItem xs="4">
                                            <MudButton Variant="Variant.Outlined"
                                                       Color="Color.Primary"
                                                       FullWidth
                                                       OnClick="@(() => UpdateScore(table, "win", "White"))">
                                                Win
                                            </MudButton>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <MudButton Variant="Variant.Outlined"
                                                       Color="Color.Secondary"
                                                       FullWidth
                                                       OnClick="@(() => UpdateScore(table, "draw", "White"))">
                                                Draw
                                            </MudButton>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <MudButton Variant="Variant.Outlined"
                                                       Color="Color.Primary"
                                                       FullWidth
                                                       OnClick="@(() => UpdateScore(table, "win", "Black"))">
                                                Win
                                            </MudButton>
                                        </MudItem>
                                    </MudGrid>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                </ChildContent>

                <ItemRenderer Context="item">
                    <MudChip T="string"
                             Variant="Variant.Filled"
                             Color="Color.Primary"
                             Class="ma-1 cursor-move"
                             Style="max-width: 130px; height: auto; min-height: 52px; padding: 8px 12px; display: flex; align-items: center;">
                        <MudStack Spacing="0" Style="line-height: 1.3; text-align: center; width: 100%;">
                            <MudText Typo="Typo.body2"
                                     Class="font-weight-bold"
                                     Style="font-size: 0.75rem; margin-bottom: 2px;">
                                @item.Name
                            </MudText>
                            @if (!string.IsNullOrEmpty(item.PlayerName))
                            {
                                <MudText Typo="Typo.caption"
                                         Style="font-size: 0.65rem; word-break: break-word; opacity: 0.9;">
                                    @item.PlayerName
                                </MudText>
                            }
                        </MudStack>
                    </MudChip>
                </ItemRenderer>
            </MudDropContainer>
        }
    </MudItem>


    <!-- STANDINGS SECTION -->
    <MudItem xs="12">
        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-3">
                Chess Standings - Overall
            </MudText>

            <MudGrid Class="mb-3" Spacing="2" Justify="Justify.Center">
                <MudItem xs="12" lg="4">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="RefreshStandings"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               Size="Size.Small"
                               FullWidth>
                        Refresh Standings
                    </MudButton>
                </MudItem>
            </MudGrid>

            <MudGrid Spacing="2">
                @{
                    var standings = GetOverallStandings();
                    var rank = 1;
                }
                @foreach (var regionStanding in standings)
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-2" Elevation="@(rank <= 3 ? 1 : 0)"
                                  Style="@(rank <= 3 ? "border: 2px solid var(--mud-palette-primary);" : "")">
                            <MudGrid Spacing="2" Style="align-items:center">
                                <MudItem xs="10">
                                    <MudGrid Spacing="1" Style="align-items:center">

                                        <MudStack Row="true" Spacing="1" Style="align-items:center">
                                                <MudText Typo="Typo.body1"
                                                         Class="font-weight-bold"
                                                         Color="@(rank <= 3 ? Color.Primary : Color.Default)">
                                                    @regionStanding.RegionName
                                                </MudText>

                                            @if (!string.IsNullOrEmpty(regionStanding.PlayerName))
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    - @regionStanding.PlayerName
                                                </MudText>
                                            }

                                                @if (regionStanding.GamesPlayed > 0)
                                                {
                                                <MudStack Row="true" Spacing="1" Justify="Justify.FlexStart" Style="align-items:center">
                                                            <MudText Typo="Typo.caption" Color="Color.Success">
                                                                @regionStanding.Wins W
                                                            </MudText>
                                                            <MudText Typo="Typo.caption" Color="Color.Warning">
                                                                @regionStanding.Draws D
                                                            </MudText>
                                                            <MudText Typo="Typo.caption" Color="Color.Error">
                                                                @regionStanding.Losses L
                                                            </MudText>
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                                (@regionStanding.GamesPlayed games)
                                                            </MudText>
                                                        </MudStack>
                                                }
                                            </MudStack>
                                        
                                    </MudGrid>
                                </MudItem>

                                <!-- Total Points -->
                                <MudItem xs="2">
                                    <MudText Typo="Typo.h6"
                                             Color="@GetPointsColor(regionStanding.TotalPoints)"
                                             Align="Align.Right"
                                             Class="font-weight-bold">
                                        @regionStanding.TotalPoints.ToString("F1")
                                    </MudText>
                                </MudItem>
                            </MudGrid>

                            @if (rank < standings.Count)
                            {
                                <MudDivider Class="my-2" />
                            }
                        </MudPaper>
                    </MudItem>
                    rank++;
                }

                @if (!standings.Any())
                {
                    <MudItem xs="12">
                        <MudText Align="Align.Center" Color="Color.Secondary" Class="ma-4">
                            No standings data available
                        </MudText>
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>
    </MudItem>

</MudGrid>

@code {
    private List<RegionItem>? Regions;
    private List<string> Tables = new();
    private List<List<RegionItem>> AllSets = new();
    private int CurrentSet = 1;
    private int SelectedSet = 1;

    private int? _selectedSportIDValue = 9;
    private string? _selectedSchoolLevelAndGenderID;
    private string? _selectedMainCategoryValue;
    private int? _selectedSportSubcategoryIDValue;
    private int? _selectedEventStagesIDValue;

    private List<EventsDTO.EventStages>? _eventStages;
    private List<SportsDTO.SportGenderCategories>? _sportGenderCategories;
    private List<SchoolsDTO.SchoolLevels>? _schoolLevels;
    private List<SportsDTO.SportSubcategories>? _sportSubcategories;

    private List<string> _combinedSchoolLevelAndGenderNames = new();
    private List<string> _sportMainCat = new();

    private ChessEventDTO? SelectedEvent;

    private Dictionary<string, string> _tableResults = new Dictionary<string, string>();
    private Dictionary<int, (string? PlayerID, string? PlayerName)> _regionPlayerMap = new();

    private List<RegionItem> BaseRegions = new();

    public class RegionItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string AssignedTable { get; set; } = "Unassigned";
        public string? PlayerName { get; set; }
        public int SetNumber { get; set; } = 1;
    }

    public class RegionStanding
    {
        public string RegionName { get; set; } = "";
        public int RegionId { get; set; }
        public string? PlayerName { get; set; }
        public decimal TotalPoints { get; set; }
        public int GamesPlayed { get; set; }
        public int Wins { get; set; }
        public int Draws { get; set; }
        public int Losses { get; set; }
        public int SetsPlayed { get; set; }
        public string CurrentTable { get; set; } = "Unassigned";
    }

    public class ChessScoringDTO
    {
        public int ID { get; set; }
        public int? SportsID { get; set; }
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int SetNo { get; set; }
        public int TableNo { get; set; }
        public string? ColorGroup { get; set; }
        public decimal? Score { get; set; }
        public DateTime? CreatedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class ChessEventDTO
    {
        public string? ID { get; set; }
        public DateTime? Date { get; set; }
        public TimeSpan? Time { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class CreateChessScoringDTO
    {
        public int? SportsID { get; set; }
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int SetNo { get; set; }
        public int TableNo { get; set; }
        public string? ColorGroup { get; set; }
        public decimal? Score { get; set; }
        public string? PlayerID { get; set; }
    }

    public class UpdateChessScoringDTO
    {
        public int ID { get; set; }
        public int? TableNo { get; set; }
        public string? ColorGroup { get; set; }
        public decimal? Score { get; set; }
        public int? SetNo { get; set; }
        public string? PlayerID { get; set; }
    }

    public class EventsDTO
    {
        public class EventStages
        {
            public int ID { get; set; }
            public string? Stage { get; set; }
        }
    }

    public class SportsDTO
    {
        public class SportSubcategories
        {
            public int ID { get; set; }
            public string? Subcategory { get; set; }
            public int? SportID { get; set; }
            public int? SportGenderCategoryID { get; set; }
            public int? SchoolLevelID { get; set; }
            public string? MainCategory { get; set; }
        }

        public class SportGenderCategories
        {
            public int ID { get; set; }
            public string? Gender { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class SchoolLevels
        {
            public int ID { get; set; }
            public string? Level { get; set; }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableOptions();
        Tables = new List<string> { "Table 1", "Table 2", "Table 3", "Table 4" };
        await FilterSchoolLevelAndGenderAsync();
    }

    private string? GetResultIndicator(string tableName, string color)
    {
        var key = $"{SelectedSet}_{tableName}_{color}";
        return _tableResults.ContainsKey(key) ? _tableResults[key] : null;
    }

    private Color GetResultColor(string tableName, string color)
    {
        var indicator = GetResultIndicator(tableName, color);
        return indicator switch
        {
            "W" => Color.Success,
            "L" => Color.Error,
            "D" => Color.Warning,
            _ => Color.Default
        };
    }

    private void SetResultIndicator(string tableName, string color, string result)
    {
        var key = $"{SelectedSet}_{tableName}_{color}";
        _tableResults[key] = result;
    }

    private void ClearResultIndicatorsForTable(string tableName)
    {
        var whiteKey = $"{SelectedSet}_{tableName}_White";
        var blackKey = $"{SelectedSet}_{tableName}_Black";
        _tableResults.Remove(whiteKey);
        _tableResults.Remove(blackKey);
    }

    private void ClearAllResultIndicatorsForSet(int setNumber)
    {
        var keysToRemove = _tableResults.Keys.Where(key => key.StartsWith($"{setNumber}_")).ToList();
        foreach (var key in keysToRemove)
        {
            _tableResults.Remove(key);
        }
    }



    private (decimal TotalPoints, int GamesPlayed, int Wins, int Draws, int Losses)
        CalculateRegionStatsForSet(RegionItem region, int setNumber)
    {
        decimal totalPoints = 0;
        int gamesPlayed = 0;
        int wins = 0;
        int draws = 0;
        int losses = 0;

        try
        {
            foreach (var result in _tableResults)
            {
                if (result.Key.StartsWith($"{setNumber}_"))
                {
                    var parts = result.Key.Split('_');
                    if (parts.Length == 3)
                    {
                        var tableName = parts[1];
                        var color = parts[2];

                        var expectedAssignment = $"{setNumber}_{tableName}_{color}";
                        if (region.AssignedTable == expectedAssignment)
                        {
                            gamesPlayed++;

                            switch (result.Value)
                            {
                                case "W":
                                    totalPoints += 1.0m;
                                    wins++;
                                    break;
                                case "D":
                                    totalPoints += 0.5m;
                                    draws++;
                                    break;
                                case "L":
                                    totalPoints += 0.0m;
                                    losses++;
                                    break;
                            }
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error calculating stats for {region.Name}: {ex.Message}");
        }

        return (totalPoints, gamesPlayed, wins, draws, losses);
    }

    private Color GetPointsColor(decimal points)
    {
        return points switch
        {
            > 0 => Color.Primary,
            0 => Color.Default,
            _ => Color.Default
        };
    }

    private async Task RefreshStandings()
    {
        try
        {
            if (SelectedEvent != null)
            {
                await LoadExistingChessAssignments();
                StateHasChanged();
                Snackbar.Add("Standings refreshed", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing standings: {ex.Message}", Severity.Error);
        }
    }

    private void RefreshStandingsAfterScoreUpdate()
    {
        StateHasChanged();
    }

    private async Task LoadAvailableOptions()
    {
        try
        {
            await GetEventStagesAsync();
            await GetGenderCategoriesAsync();
            await GetSchoolLevelsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading options: {ex.Message}", Severity.Error);
        }
    }

    private async Task GetEventStagesAsync()
    {
        string url = "/Events/Stages";
        _eventStages = await apiService.GetAsync<EventsDTO.EventStages>(url);
    }

    private async Task GetGenderCategoriesAsync()
    {
        string url = "/Sports/GenderCategories";
        _sportGenderCategories = await apiService.GetAsync<SportsDTO.SportGenderCategories>(url);
    }

    private async Task GetSchoolLevelsAsync()
    {
        string url = "/Schools/Levels";
        _schoolLevels = await apiService.GetAsync<SchoolsDTO.SchoolLevels>(url);
    }

    private async Task GetSportSubCategoriesSLGAsync()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
            return;
        }

        var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
        var schoolLevelName = parts[0];
        var genderName = parts[1];

        var schoolLevelID = _schoolLevels?.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
        var genderID = _sportGenderCategories?.FirstOrDefault(x => x.Gender == genderName)?.ID;

        if (schoolLevelID != null && genderID != null && _selectedSportIDValue != null)
        {
            _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(
                $"/Sports/Subcategories?sportID={_selectedSportIDValue}&schoolLevelID={schoolLevelID}&sportGenderCategoryID={genderID}");
        }
        else
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        }
    }

    private List<SportsDTO.SportSubcategories> GetFilteredSubcategories()
    {
        if (_sportSubcategories == null) return new List<SportsDTO.SportSubcategories>();
        return !string.IsNullOrEmpty(_selectedMainCategoryValue)
            ? _sportSubcategories.Where(sc => sc.MainCategory == _selectedMainCategoryValue).ToList()
            : _sportSubcategories.Where(sc => string.IsNullOrEmpty(sc.MainCategory)).ToList();
    }

    private async Task FilterSchoolLevelAndGenderAsync()
    {
        if (_selectedSportIDValue == null)
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var subcats = await apiService.GetAsync<SportsDTO.SportSubcategories>($"/Sports/Subcategories?sportID={_selectedSportIDValue}");
        if (subcats == null || !subcats.Any())
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var schoolLevelIDs = subcats.Where(x => x.SchoolLevelID.HasValue).Select(x => x.SchoolLevelID.Value).Distinct();
        var genderIDs = subcats.Where(x => x.SportGenderCategoryID.HasValue).Select(x => x.SportGenderCategoryID.Value).Distinct();

        var schoolLevelNames = _schoolLevels?.Where(s => schoolLevelIDs.Contains(s.ID)).Select(s => s.Level) ?? new List<string>();
        var genderNames = _sportGenderCategories?.Where(g => genderIDs.Contains(g.ID)).Select(g => g.Gender) ?? new List<string>();

        _combinedSchoolLevelAndGenderNames = schoolLevelNames.SelectMany(s => genderNames, (s, g) => $"{s} - {g}").ToList();
    }

    private void LoadMainCategories()
    {
        _sportMainCat = _sportSubcategories?.Where(sc => !string.IsNullOrEmpty(sc.MainCategory))
            .Select(sc => sc.MainCategory!).Distinct().ToList() ?? new List<string>();
    }

    private async Task ApplyFilters()
    {
        try
        {
            var queryParams = new List<string>();

            if (_selectedSportSubcategoryIDValue.HasValue)
            {
                var subcategoryName = _sportSubcategories?.FirstOrDefault(s => s.ID == _selectedSportSubcategoryIDValue.Value)?.Subcategory;
                if (!string.IsNullOrEmpty(subcategoryName))
                    queryParams.Add($"subcategory={Uri.EscapeDataString(subcategoryName)}");
            }

            if (!string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
            {
                var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
                if (parts.Length == 2)
                {
                    queryParams.Add($"level={Uri.EscapeDataString(parts[0])}");
                    queryParams.Add($"gender={Uri.EscapeDataString(parts[1])}");
                }
            }

            if (_selectedEventStagesIDValue.HasValue)
            {
                var stageName = _eventStages?.FirstOrDefault(e => e.ID == _selectedEventStagesIDValue.Value)?.Stage;
                if (!string.IsNullOrEmpty(stageName))
                    queryParams.Add($"eventStage={Uri.EscapeDataString(stageName)}");
            }

            var queryString = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
            var events = await apiService.GetAsync<ChessEventDTO>($"/ChessScoring/events{queryString}");

            if (events != null && events.Any())
            {
                _regionPlayerMap.Clear();

                BaseRegions = events
                    .Where(evt => !string.IsNullOrEmpty(evt.Abbreviation))
                    .GroupBy(evt => evt.Abbreviation)
                    .Select(group =>
                    {
                        var firstEvent = group.First();
                        var regionItem = new RegionItem
                            {
                                Id = firstEvent.RegionID,
                                Name = group.Key!,
                                AssignedTable = "Unassigned",
                                SetNumber = 1,
                                PlayerName = firstEvent.PlayerName
                            };

                        if (!string.IsNullOrEmpty(firstEvent.PlayerID))
                        {
                            _regionPlayerMap[firstEvent.RegionID] = (firstEvent.PlayerID, firstEvent.PlayerName);
                        }

                        return regionItem;
                    })
                    .ToList();

                AllSets.Clear();
                var firstSet = BaseRegions.Select(r => new RegionItem
                    {
                        Id = r.Id,
                        Name = r.Name,
                        AssignedTable = "Unassigned",
                        SetNumber = 1,
                        PlayerName = r.PlayerName
                    }).ToList();
                AllSets.Add(firstSet);

                Regions = firstSet;
                SelectedEvent = events.First();
                SelectedSet = 1;
                CurrentSet = 1;

                _tableResults.Clear();

                await LoadExistingChessAssignments();

                if (SelectedSet <= AllSets.Count)
                {
                    Regions = AllSets[SelectedSet - 1];
                }

                Snackbar.Add($"Found {events.Count} events with {Regions.Count} regions. Loaded {AllSets.Count} set(s).", Severity.Success);
            }
            else
            {
                Regions = new List<RegionItem>();
                BaseRegions = new List<RegionItem>();
                SelectedEvent = null;
                _tableResults.Clear();
                Snackbar.Add("No Chess events found with the selected filters", Severity.Warning);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error applying filters: {ex.Message}", Severity.Error);
            Regions = new List<RegionItem>();
            BaseRegions = new List<RegionItem>();
        }
    }

    private async Task ClearFilters()
    {
        _selectedSchoolLevelAndGenderID = null;
        _selectedMainCategoryValue = null;
        _selectedSportSubcategoryIDValue = null;
        _selectedEventStagesIDValue = null;
        SelectedEvent = null;
        Regions = new List<RegionItem>();
        BaseRegions = new List<RegionItem>();
        _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        _combinedSchoolLevelAndGenderNames = new List<string>();
        _sportMainCat = new List<string>();
        _tableResults.Clear();
        AllSets.Clear();
        CurrentSet = 1;
        SelectedSet = 1;
        _regionPlayerMap.Clear();

        Snackbar.Add("Filters cleared", Severity.Info);
        StateHasChanged();
    }

    private async Task LoadExistingChessAssignments()
    {
        try
        {
            if (SelectedEvent == null) return;

            var existingAssignments = await apiService.GetAsync<ChessScoringDTO>($"/ChessScoring/event/{SelectedEvent.ID}");
            if (existingAssignments != null && existingAssignments.Any())
            {
                var maxSetNo = existingAssignments.Max(a => a.SetNo);

                while (AllSets.Count < maxSetNo)
                {
                    var newSetNumber = AllSets.Count + 1;
                    var newSet = BaseRegions.Select(baseRegion => new RegionItem
                        {
                            Id = baseRegion.Id,
                            Name = baseRegion.Name,
                            AssignedTable = "Unassigned",
                            SetNumber = newSetNumber,
                            PlayerName = baseRegion.PlayerName 
                        }).ToList();
                    AllSets.Add(newSet);
                }

                foreach (var assignment in existingAssignments)
                {
                    if (assignment.SetNo <= AllSets.Count && assignment.TableNo > 0 && !string.IsNullOrEmpty(assignment.ColorGroup))
                    {
                        var setToUpdate = AllSets[assignment.SetNo - 1];
                        var regionInSet = setToUpdate.FirstOrDefault(r => r.Id == assignment.RegionID);

                        if (regionInSet != null)
                        {
                            regionInSet.AssignedTable = $"{assignment.SetNo}_Table {assignment.TableNo}_{assignment.ColorGroup}";

                            if (!string.IsNullOrEmpty(assignment.PlayerName))
                            {
                                regionInSet.PlayerName = assignment.PlayerName;
                            }
                            else
                            {
                                var baseRegion = BaseRegions.FirstOrDefault(br => br.Id == assignment.RegionID);
                                if (baseRegion != null)
                                {
                                    regionInSet.PlayerName = baseRegion.PlayerName;
                                }
                            }

                            if (assignment.Score.HasValue)
                            {
                                var tableName = $"Table {assignment.TableNo}";
                                var resultKey = $"{assignment.SetNo}_{tableName}_{assignment.ColorGroup}";
                                _tableResults[resultKey] = assignment.Score switch
                                {
                                    1.0m => "W",
                                    0.5m => "D",
                                    0.0m => "L",
                                    _ => ""
                                };
                            }
                        }
                    }
                }

                if (maxSetNo > CurrentSet)
                {
                    CurrentSet = maxSetNo;
                }

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error loading existing chess assignments", Severity.Warning);
        }
    }

    private void AddTable() => Tables.Add($"Table {Tables.Count + 1}");

    private void NextSet()
    {
        if (!BaseRegions.Any())
        {
            Snackbar.Add("No regions available. Please apply filters first.", Severity.Warning);
            return;
        }

        CurrentSet++;

        var newSet = BaseRegions.Select(baseRegion => new RegionItem
            {
                Id = baseRegion.Id,
                Name = baseRegion.Name,
                AssignedTable = "Unassigned",
                SetNumber = CurrentSet,
                PlayerName = baseRegion.PlayerName 
            }).ToList();

        AllSets.Add(newSet);
        SelectedSet = CurrentSet;
        Regions = newSet;

        ClearAllResultIndicatorsForSet(CurrentSet);

        Snackbar.Add($"Set {CurrentSet} created with {Regions.Count} regions!", Severity.Success);
        StateHasChanged();
    }

    private void OnSetChanged(int setNumber)
    {
        if (setNumber >= 1 && setNumber <= AllSets.Count)
        {
            SelectedSet = setNumber;
            Regions = AllSets[setNumber - 1];

            foreach (var region in Regions)
            {
                var baseRegion = BaseRegions.FirstOrDefault(br => br.Id == region.Id);
                if (baseRegion != null && string.IsNullOrEmpty(region.PlayerName))
                {
                    region.PlayerName = baseRegion.PlayerName;
                }
            }

            StateHasChanged();
        }
        else
        {
            Snackbar.Add($"Set {setNumber} is not available. Total sets: {AllSets.Count}", Severity.Warning);
        }
    }

    private bool SelectItemsForZone(RegionItem item, string dropzone)
    {
        return item.SetNumber == SelectedSet && item.AssignedTable == dropzone;
    }

    private async Task OnItemDropped(MudItemDropInfo<RegionItem> info)
    {
        info.Item.AssignedTable = info.DropzoneIdentifier;
        info.Item.SetNumber = SelectedSet;

        Snackbar.Add($"{info.Item.Name} moved to {info.Item.AssignedTable} (Set {SelectedSet})", Severity.Success);
        await SaveRegionAssignment(info.Item);
        StateHasChanged();
    }

    private async Task SaveRegionAssignment(RegionItem region)
    {
        try
        {
            var (tableNo, colorGroup) = ParseAssignedTable(region.AssignedTable);

            if (tableNo > 0 && colorGroup != "Unassigned" && SelectedEvent != null)
            {
                string? playerId = null;
                if (_regionPlayerMap.ContainsKey(region.Id))
                {
                    playerId = _regionPlayerMap[region.Id].PlayerID;
                }

                var createDto = new CreateChessScoringDTO
                    {
                        SportsID = 9,
                        EventID = SelectedEvent.ID,
                        EventVersusID = null,
                        RegionID = region.Id,
                        SetNo = region.SetNumber,
                        TableNo = tableNo,
                        ColorGroup = colorGroup,
                        Score = 0,
                        PlayerID = playerId 
                    };

                var result = await apiService.PostAsync<CreateChessScoringDTO, int>("/ChessScoring", createDto);
                if (result > 0)
                {
                    Snackbar.Add($"Saved {region.Name} assignment successfully!", Severity.Success);
                }
                else
                {
                    Snackbar.Add($"Failed to save assignment for {region.Name}", Severity.Warning);
                }
            }
            else if (region.AssignedTable == "Unassigned")
            {
                await DeleteAssignment(region.Id, region.SetNumber);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving assignment: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteAssignment(int regionId, int setNumber)
    {
        try
        {
            await apiService.DeleteAsync($"/ChessScoring/region/{regionId}/set/{setNumber}");
            Snackbar.Add("Assignment removed", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error removing assignment", Severity.Warning);
        }
    }

    private async Task UpdateScore(string tableName, string result, string color)
    {
        try
        {
            var tableId = $"{SelectedSet}_{tableName}_{color}";
            var region = Regions!.FirstOrDefault(r => r.AssignedTable == tableId);

            if (region != null)
            {
                var (tableNo, colorGroup) = ParseAssignedTable(tableId);
                ClearResultIndicatorsForTable(tableName);

                if (result == "draw")
                {
                    var opponentColor = color == "White" ? "Black" : "White";
                    var opponentTableId = $"{SelectedSet}_{tableName}_{opponentColor}";
                    var opponentRegion = Regions!.FirstOrDefault(r => r.AssignedTable == opponentTableId);

                    if (opponentRegion != null)
                    {
                        var (opponentTableNo, opponentColorGroup) = ParseAssignedTable(opponentTableId);
                        await UpdatePlayerScore(region.Id, SelectedSet, tableNo, colorGroup, 0.5m, region.Name);
                        await UpdatePlayerScore(opponentRegion.Id, SelectedSet, opponentTableNo, opponentColorGroup, 0.5m, opponentRegion.Name);
                        SetResultIndicator(tableName, color, "D");
                        SetResultIndicator(tableName, opponentColor, "D");
                        Snackbar.Add($"Draw recorded: Both {region.Name} and {opponentRegion.Name} get 0.5 points", Severity.Success);
                    }
                }
                else
                {
                    decimal score = result == "win" ? 1.0m : 0.0m;
                    await UpdatePlayerScore(region.Id, SelectedSet, tableNo, colorGroup, score, region.Name);

                    if (result == "win")
                    {
                        var opponentColor = color == "White" ? "Black" : "White";
                        var opponentTableId = $"{SelectedSet}_{tableName}_{opponentColor}";
                        var opponentRegion = Regions!.FirstOrDefault(r => r.AssignedTable == opponentTableId);

                        if (opponentRegion != null)
                        {
                            var (opponentTableNo, opponentColorGroup) = ParseAssignedTable(opponentTableId);
                            await UpdatePlayerScore(opponentRegion.Id, SelectedSet, opponentTableNo, opponentColorGroup, 0.0m, opponentRegion.Name);
                            SetResultIndicator(tableName, color, "W");
                            SetResultIndicator(tableName, opponentColor, "L");
                        }
                        else
                        {
                            SetResultIndicator(tableName, color, "W");
                        }
                        Snackbar.Add($"Win recorded: {region.Name} gets 1.0 point", Severity.Success);
                    }
                }

                RefreshStandingsAfterScoreUpdate();
                StateHasChanged();
            }
            else
            {
                Snackbar.Add($"No region assigned to {color} side of {tableName}", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating score: {ex.Message}", Severity.Error);
        }
    }

    private async Task UpdatePlayerScore(int regionId, int setNo, int tableNo, string colorGroup, decimal score, string regionName)
    {
        try
        {
            var recordId = await GetOrCreateChessScoringId(regionId, setNo, tableNo, colorGroup);
            if (recordId > 0)
            {
                string? playerId = null;
                if (_regionPlayerMap.ContainsKey(regionId))
                {
                    playerId = _regionPlayerMap[regionId].PlayerID;
                }

                var updateDto = new UpdateChessScoringDTO
                    {
                        ID = recordId,
                        TableNo = tableNo,
                        ColorGroup = colorGroup,
                        Score = score,
                        SetNo = setNo,
                        PlayerID = playerId
                    };
                await apiService.PutAsync($"/ChessScoring/{recordId}", updateDto);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating score for {regionName}: {ex.Message}", Severity.Error);
        }
    }

    private async Task<int> GetOrCreateChessScoringId(int regionId, int setNo, int tableNo, string colorGroup)
    {
        try
        {
            var existing = await apiService.GetAsync<ChessScoringDTO>($"/ChessScoring/event/{SelectedEvent?.ID}");
            var record = existing?.FirstOrDefault(r => r.RegionID == regionId && r.SetNo == setNo && r.TableNo == tableNo && r.ColorGroup == colorGroup);

            if (record != null) return record.ID;

            string? playerId = null;
            if (_regionPlayerMap.ContainsKey(regionId))
            {
                playerId = _regionPlayerMap[regionId].PlayerID;
            }

            var createDto = new CreateChessScoringDTO
                {
                    SportsID = 9,
                    EventID = SelectedEvent?.ID,
                    RegionID = regionId,
                    SetNo = setNo,
                    TableNo = tableNo,
                    ColorGroup = colorGroup,
                    Score = 0,
                    PlayerID = playerId
                };

            var newId = await apiService.PostAsync<CreateChessScoringDTO, int>("/ChessScoring", createDto);
            return newId > 0 ? newId : 0;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error getting record ID: {ex.Message}", Severity.Error);
            return 0;
        }
    }

    private (int tableNo, string colorGroup) ParseAssignedTable(string assignedTable)
    {
        if (assignedTable == "Unassigned") return (0, "Unassigned");

        try
        {
            var parts = assignedTable.Split('_');
            if (parts.Length == 3)
            {
                var tableName = parts[1];
                var color = parts[2];
                var tableNo = int.Parse(tableName.Replace("Table ", ""));
                return (tableNo, color);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing assigned table: {ex.Message}");
        }
        return (0, "Unassigned");
    }

    private void RemoveTable(string tableName)
    {
        if (Tables.Contains(tableName))
        {
            Tables.Remove(tableName);
            foreach (var region in Regions!)
            {
                if (region.AssignedTable == $"{SelectedSet}_{tableName}_White" || region.AssignedTable == $"{SelectedSet}_{tableName}_Black")
                {
                    region.AssignedTable = "Unassigned";
                }
            }
            ClearResultIndicatorsForTable(tableName);
            Snackbar.Add($"{tableName} removed.", Severity.Info);
            StateHasChanged();
        }
    }

    private List<RegionStanding> GetOverallStandings()
    {
        var standings = new List<RegionStanding>();

        if (BaseRegions == null || !BaseRegions.Any())
            return standings;

        try
        {
            var regionGroups = BaseRegions.GroupBy(r => r.Name);

            foreach (var regionGroup in regionGroups)
            {
                var regionName = regionGroup.Key;
                var regionId = regionGroup.First().Id;

                var baseRegion = BaseRegions.FirstOrDefault(br => br.Name == regionName);
                var playerName = baseRegion?.PlayerName;

                var standing = new RegionStanding
                    {
                        RegionName = regionName,
                        RegionId = regionId,
                        PlayerName = playerName,
                    };

                decimal totalPoints = 0;
                int gamesPlayed = 0;
                int wins = 0;
                int draws = 0;
                int losses = 0;
                int setsPlayed = 0;

                foreach (var set in AllSets)
                {
                    var regionInSet = set.FirstOrDefault(r => r.Name == regionName);
                    if (regionInSet != null)
                    {
                        var setStats = CalculateRegionStatsForSet(regionInSet, AllSets.IndexOf(set) + 1);
                        totalPoints += setStats.TotalPoints;
                        gamesPlayed += setStats.GamesPlayed;
                        wins += setStats.Wins;
                        draws += setStats.Draws;
                        losses += setStats.Losses;

                        if (setStats.GamesPlayed > 0)
                            setsPlayed++;
                    }
                }

                standing.TotalPoints = totalPoints;
                standing.GamesPlayed = gamesPlayed;
                standing.Wins = wins;
                standing.Draws = draws;
                standing.Losses = losses;
                standing.SetsPlayed = setsPlayed;

                standings.Add(standing);
            }

            return standings.OrderByDescending(s => s.TotalPoints)
                           .ThenByDescending(s => s.Wins)
                           .ThenBy(s => s.Losses)
                           .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error calculating standings: {ex.Message}", Severity.Error);
            return new List<RegionStanding>();
        }
    }
}