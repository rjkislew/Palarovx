@page "/score/chess"
@inject ISnackbar Snackbar
@inject APIService apiService
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>Chess Scoring | PALARO 2026</PageTitle>
<MudText Typo="Typo.h6" Align="Align.Center">Chess Match (Sets / Games)</MudText>

<!-- FILTERS SECTION -->
<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-4">Event Filters</MudText>
    <MudGrid Spacing="3" Justify="Justify.Center">
        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedSportIDValue" Margin="Margin.Dense" Label="Sport"
                       T="int?"
                       ShrinkLabel Variant="Variant.Outlined"
                       SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                  {
                                                      _selectedSchoolLevelAndGenderID = null;
                                                      _selectedSportSubcategoryIDValue = null;
                                                      _selectedMainCategoryValue = null;
                                                      await FilterSchoolLevelAndGenderAsync();
                                                  }))">
                <MudSelectItem T="int?" Value="9">Chess</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="_selectedSchoolLevelAndGenderID" Margin="Margin.Dense"
                       Label="School Level and Gender" T="string"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="_selectedSportIDValue == null"
                       SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                  {
                                                      _selectedSportSubcategoryIDValue = null;
                                                      _selectedMainCategoryValue = null;
                                                      await GetSportSubCategoriesSLGAsync();
                                                      LoadMainCategories();
                                                  }))">
                <MudVirtualize Items="_combinedSchoolLevelAndGenderNames" Context="combinedID">
                    <MudSelectItem T="string" Value="@combinedID">
                        @combinedID
                    </MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedMainCategoryValue" Margin="Margin.Dense"
                       Label="Event" T="string"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                @foreach (var mc in _sportMainCat)
                {
                    <MudSelectItem Value="@mc">@mc</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="_selectedSportSubcategoryIDValue" Margin="Margin.Dense"
                       Label="Category" T="int?"
                       HelperText="@((_sportSubcategories?.Any() != true && _selectedSchoolLevelAndGenderID != null) ? "No subcategory available for this gender or school level." : null)"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                <MudVirtualize Items="@GetFilteredSubcategories()" Context="subCategory">
                    <MudSelectItem T="int?" Value="@subCategory.ID">@subCategory.Subcategory</MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedEventStagesIDValue" Margin="Margin.Dense"
                       Label="Stage" T="int?"
                       ShrinkLabel Variant="Variant.Outlined" Clearable>
                <MudVirtualize Items="_eventStages" Context="eventStage">
                    <MudSelectItem T="int?" Value="eventStage.ID">@eventStage.Stage</MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-3" Justify="Justify.Center">
        <MudItem xs="12" sm="4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="ApplyFilters" FullWidth StartIcon="@Icons.Material.Filled.Search">
                Apply Filters
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                       OnClick="ClearFilters" FullWidth StartIcon="@Icons.Material.Filled.Clear">
                Clear Filters
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<!-- SELECTED EVENT INFO -->
@if (SelectedEvent != null)
{
    <MudPaper Class="pa-3 mb-4" Elevation="1" Style="background-color: #e3f2fd;">
        <MudGrid Spacing="3">
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.body2"><strong>Event:</strong> @SelectedEvent.Sport - @SelectedEvent.Subcategory</MudText>
            </MudItem>
            <MudItem xs="12" sm="5">
                <MudText Typo="Typo.body2"><strong>Level and Gender:</strong> @SelectedEvent.Level - @SelectedEvent.Gender</MudText>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudText Typo="Typo.body2"><strong>Stage:</strong> @SelectedEvent.EventStage</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>
}

<!-- MATCH TABLES -->
<MudGrid Spacing="3">
    <MudItem xs="12">
        @if (Regions == null)
        {
            <MudText Align="Align.Center" Class="ma-4">Please apply filters to see regions</MudText>
        }
        else if (!Regions.Any())
        {
            <MudText Align="Align.Center" Class="ma-4">No regions found. Please apply filters to see regions.</MudText>
        }
        else
        {
            <MudDropContainer T="RegionItem"
                              Items="Regions"
                              ItemsSelector="SelectItemsForZone"
                              ItemDropped="OnItemDropped"
                              @key="@($"dropcontainer_{SelectedSet}")">

                <ChildContent>
                    <MudPaper Class="pa-2 mt-4 mb-6"
                              Elevation="3"
                              Style="position:sticky; top:0; z-index:1000; background-color:white;">

                        <MudGrid Class="my-2" Justify="Justify.Center" Spacing="4">
                            <MudItem xs="12" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Success" OnClick="AddTable" FullWidth>
                                    Add Table
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="NextSet" FullWidth>
                                    Next Set / Game
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudSelect T="int" Label="Preview Set" FullWidth
                                           Value="SelectedSet"
                                           ValueChanged="OnSetChanged">
                                    @foreach (var setNum in Enumerable.Range(1, AllSets.Count))
                                    {
                                        <MudSelectItem Value="@setNum">Set @setNum</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                        </MudGrid>

                        <MudText Typo="Typo.subtitle1" Align="Align.Center">Regions (Set @SelectedSet) - Total: @Regions.Count</MudText>
                        <MudDropZone T="RegionItem"
                                     Identifier="Unassigned"
                                     Class="d-flex flex-wrap justify-center pa-2"
                                     Style="min-height:100px; gap:6px; border:1px dashed gray;" />
                    </MudPaper>

                    <MudDivider Class="my-2" />
                    <MudGrid Class="" Style="align-items:center"
                             Spacing="4">

                        <!-- Left spacer -->
                        <MudItem xs="4" />

                        <!-- Center title -->
                        <MudItem xs="4">
                            <MudText Typo="Typo.h6" Align="Align.Center">
                                Matches
                            </MudText>
                        </MudItem>

                        <!-- Right button -->
                        <MudItem xs="4">
                            <MudStack Row="true" Justify="Justify.FlexEnd">
                                <MudIconButton Icon="@Icons.Material.Filled.Settings"
                                               OnClick="@(() => OpenEditEventDialog(SelectedEvent?.ID))">
                                </MudIconButton>
                                <MudButton Color="Color.Tertiary" Variant="Variant.Filled"
                                           StartIcon="@Icons.Material.Filled.ArrowCircleRight"
                                           OnClick="ProceedToNextStage">
                                    Proceed to next stage
                                </MudButton>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                    <MudDivider Class="my-2" />

                    <MudGrid Spacing="3" Class="my-2" Justify="Justify.Center">
                        @foreach (var table in Tables)
                        {
                            var whiteId = $"{SelectedSet}_{table}_White";
                            var blackId = $"{SelectedSet}_{table}_Black";
                            bool isLastTable = table == Tables.Last();

                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Elevation="2" Class="pa-3" Style="position:relative;">

                                    @if (isLastTable)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Cancel"
                                                       Color="Color.Error"
                                                       Size="Size.Small"
                                                       Style="position:absolute; top:4px; right:4px;"
                                                       OnClick="@(() => RemoveTable(table))"
                                                       Title="Remove last table" />
                                    }

                                    <MudText Typo="Typo.subtitle1" Align="Align.Center">@table</MudText>
                                    <MudDivider Class="my-2" />

                                    <MudGrid>
                                        <!-- White -->
                                        <MudItem xs="6">
                                            <MudStack Row="true" Style="align-items:center" Justify="Justify.Center" Spacing="1">
                                                <MudText Typo="Typo.body2">White</MudText>

                                                @if (GetResultIndicator(table, "White") != null)
                                                {
                                                    <MudText Typo="Typo.body2"
                                                             Color="@GetResultColor(table, "White")"
                                                             Class="font-weight-bold">
                                                        @GetResultIndicator(table, "White")
                                                    </MudText>
                                                }
                                            </MudStack>

                                            <MudDropZone T="RegionItem"
                                                         Identifier="@whiteId"
                                                         Class="pa-1 d-flex flex-wrap justify-center"
                                                         Style="min-height:60px; border:1px dashed gray;" />
                                        </MudItem>

                                        <!-- Black -->
                                        <MudItem xs="6">
                                            <MudStack Row="true" Style="align-items:center" Justify="Justify.Center" Spacing="1">
                                                <MudText Typo="Typo.body2">Black</MudText>

                                                @if (GetResultIndicator(table, "Black") != null)
                                                {
                                                    <MudText Typo="Typo.body2"
                                                             Color="@GetResultColor(table, "Black")"
                                                             Class="font-weight-bold">
                                                        @GetResultIndicator(table, "Black")
                                                    </MudText>
                                                }
                                            </MudStack>

                                            <MudDropZone T="RegionItem"
                                                         Identifier="@blackId"
                                                         Class="pa-1 d-flex flex-wrap justify-center"
                                                         Style="min-height:60px; border:1px dashed gray;" />
                                        </MudItem>
                                    </MudGrid>


                                    <MudGrid Class="mt-1">
                                        <MudItem xs="4">
                                            <MudButton Variant="Variant.Outlined"
                                                       Color="Color.Primary"
                                                       FullWidth
                                                       OnClick="@(() => UpdateScore(table, "win", "White"))">
                                                Win
                                            </MudButton>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <MudButton Variant="Variant.Outlined"
                                                       Color="Color.Secondary"
                                                       FullWidth
                                                       OnClick="@(() => UpdateScore(table, "draw", "White"))">
                                                Draw
                                            </MudButton>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <MudButton Variant="Variant.Outlined"
                                                       Color="Color.Primary"
                                                       FullWidth
                                                       OnClick="@(() => UpdateScore(table, "win", "Black"))">
                                                Win
                                            </MudButton>
                                        </MudItem>
                                    </MudGrid>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                </ChildContent>

                <ItemRenderer Context="item">
                    <MudChip T="string"
                             Variant="Variant.Filled"
                             Color="Color.Primary"
                             Class="ma-1 cursor-move"
                             Style="max-width: 130px; height: auto; min-height: 52px; padding: 8px 12px; display: flex; align-items: center;">
                        <MudStack Spacing="0" Style="line-height: 1.3; text-align: center; width: 100%;">
                            <MudText Typo="Typo.body2"
                                     Class="font-weight-bold"
                                     Style="font-size: 0.75rem; margin-bottom: 2px;">
                                @item.Name
                            </MudText>
                            @if (!string.IsNullOrEmpty(item.PlayerName))
                            {
                                <MudText Typo="Typo.caption"
                                         Style="font-size: 0.65rem; word-break: break-word; opacity: 0.9;">
                                    @item.PlayerName
                                </MudText>
                            }
                        </MudStack>
                    </MudChip>
                </ItemRenderer>
            </MudDropContainer>
        }
    </MudItem>


    <!-- STANDINGS SECTION -->
    <MudItem xs="12">
        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-3">
                Chess Standings - Overall
            </MudText>

            <MudGrid Class="mb-3" Spacing="2" Justify="Justify.Center">
                <MudItem xs="12" lg="4">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="RefreshStandings"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               Size="Size.Small"
                               FullWidth>
                        Refresh Standings
                    </MudButton>
                </MudItem>
            </MudGrid>

            <MudGrid Spacing="2">
                @{
                    var standings = GetOverallStandings();
                    var rank = 1;
                }
                @foreach (var regionStanding in standings)
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-2" Elevation="@(rank <= 3 ? 1 : 0)"
                                  Style="@(rank <= 3 ? "border: 2px solid var(--mud-palette-primary);" : "")">
                            <MudGrid Spacing="2" Style="align-items:center">
                                <MudItem xs="10">
                                    <MudGrid Spacing="1" Style="align-items:center">

                                        <MudStack Row="true" Spacing="1" Style="align-items:center">
                                            <MudText Typo="Typo.body1"
                                                     Class="font-weight-bold"
                                                     Color="@(rank <= 3 ? Color.Primary : Color.Default)">
                                                @regionStanding.RegionName
                                            </MudText>

                                            @if (!string.IsNullOrEmpty(regionStanding.PlayerName))
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    - @regionStanding.PlayerName
                                                </MudText>
                                            }

                                            @if (regionStanding.GamesPlayed > 0)
                                            {
                                                <MudStack Row="true" Spacing="1" Justify="Justify.FlexStart" Style="align-items:center">
                                                    <MudText Typo="Typo.caption" Color="Color.Success">
                                                        @regionStanding.Wins W
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Warning">
                                                        @regionStanding.Draws D
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Error">
                                                        @regionStanding.Losses L
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        (@regionStanding.GamesPlayed games)
                                                    </MudText>
                                                </MudStack>
                                            }
                                        </MudStack>

                                    </MudGrid>
                                </MudItem>

                                <!-- Total Points -->
                                <MudItem xs="2">
                                    <MudText Typo="Typo.h6"
                                             Color="@GetPointsColor(regionStanding.TotalPoints)"
                                             Align="Align.Right"
                                             Class="font-weight-bold">
                                        @regionStanding.TotalPoints.ToString("F1")
                                    </MudText>
                                </MudItem>
                            </MudGrid>

                            @if (rank < standings.Count)
                            {
                                <MudDivider Class="my-2" />
                            }
                        </MudPaper>
                    </MudItem>
                    rank++;
                }

                @if (!standings.Any())
                {
                    <MudItem xs="12">
                        <MudText Align="Align.Center" Color="Color.Secondary" Class="ma-4">
                            No standings data available
                        </MudText>
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>
    </MudItem>

</MudGrid>

@code {
    private List<RegionItem>? Regions;
    private List<string> Tables = new();
    private List<List<RegionItem>> AllSets = new();
    private int CurrentSet = 1;
    private int SelectedSet = 1;

    private int? _selectedSportIDValue = 9;
    private string? _selectedSchoolLevelAndGenderID;
    private string? _selectedMainCategoryValue;
    private int? _selectedSportSubcategoryIDValue;
    private int? _selectedEventStagesIDValue;

    private List<EventsDTO.EventStages>? _eventStages;
    private List<SportsDTO.SportGenderCategories>? _sportGenderCategories;
    private List<SchoolsDTO.SchoolLevels>? _schoolLevels;
    private List<SportsDTO.SportSubcategories>? _sportSubcategories;

    private List<string> _combinedSchoolLevelAndGenderNames = new();
    private List<string> _sportMainCat = new();

    private ChessEventDTO? SelectedEvent;

    private Dictionary<string, string> _tableResults = new Dictionary<string, string>();
    private Dictionary<int, (string? PlayerID, string? PlayerName)> _regionPlayerMap = new();

    private List<RegionItem> BaseRegions = new();

    // Add these private fields for query parameter handling
    private string? _selectedEventId;
    private string? _storedSubcategoryName;
    private string? _storedStageName;

    public class RegionItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string AssignedTable { get; set; } = "Unassigned";
        public string? PlayerName { get; set; }
        public string? PlayerID { get; set; }
        public int SetNumber { get; set; } = 1;
    }

    public class RegionStanding
    {
        public string RegionName { get; set; } = "";
        public int RegionId { get; set; }
        public string? PlayerName { get; set; }
        public decimal TotalPoints { get; set; }
        public int GamesPlayed { get; set; }
        public int Wins { get; set; }
        public int Draws { get; set; }
        public int Losses { get; set; }
        public int SetsPlayed { get; set; }
        public string CurrentTable { get; set; } = "Unassigned";
    }

    public class ChessScoringDTO
    {
        public int ID { get; set; }
        public int? SportsID { get; set; }
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int SetNo { get; set; }
        public int TableNo { get; set; }
        public string? ColorGroup { get; set; }
        public decimal? Score { get; set; }
        public DateTime? CreatedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class ChessEventDTO
    {
        public string? ID { get; set; }
        public DateTime? Date { get; set; }
        public TimeSpan? Time { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class CreateChessScoringDTO
    {
        public int? SportsID { get; set; }
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int SetNo { get; set; }
        public int TableNo { get; set; }
        public string? ColorGroup { get; set; }
        public decimal? Score { get; set; }
        public string? PlayerID { get; set; }
    }

    public class UpdateChessScoringDTO
    {
        public int ID { get; set; }
        public int? TableNo { get; set; }
        public string? ColorGroup { get; set; }
        public decimal? Score { get; set; }
        public int? SetNo { get; set; }
        public string? PlayerID { get; set; }
    }

    public class EventsDTO
    {
        public class EventStages
        {
            public int ID { get; set; }
            public string? Stage { get; set; }
        }

        public class EventDetails
        {
            public string ID { get; set; } = null!;
            public string? EventStage { get; set; }
            public string? SportMainCat { get; set; }
            public string? Subcategory { get; set; }
            public string? Gender { get; set; }
            public string? Level { get; set; }
        }

        public class EventVersusTeams
        {
            public int ID { get; set; }
            public string? EventID { get; set; }
            public int? SchoolRegionID { get; set; }
            public string? Score { get; set; }
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
            public List<EventVersusTeamPlayers>? EventVersusTeamPlayersList { get; set; }
            public string? Rank { get; set; }
            public DateTime? RecentUpdateAt { get; set; }
        }

        public class EventVersusTeamPlayers
        {
            public int ID { get; set; }
            public int? EventVersusID { get; set; }
            public string? ProfilePlayerID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
            public string? School { get; set; }
        }
    }

    public class SportsDTO
    {
        public class SportSubcategories
        {
            public int ID { get; set; }
            public string? Subcategory { get; set; }
            public int? SportID { get; set; }
            public int? SportGenderCategoryID { get; set; }
            public int? SchoolLevelID { get; set; }
            public string? MainCategory { get; set; }
        }

        public class SportGenderCategories
        {
            public int ID { get; set; }
            public string? Gender { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class SchoolLevels
        {
            public int ID { get; set; }
            public string? Level { get; set; }
        }
    }

    // UPDATED OnInitializedAsync method
    protected override async Task OnInitializedAsync()
    {
        // Parse query parameters first
        await ParseQueryParameters();

        // If eventId is provided, auto-fill filters
        if (!string.IsNullOrEmpty(_selectedEventId))
        {
            await LoadEventAndAutoFillFilters();
        }
        else
        {
            // Original initialization
            await LoadAvailableOptions();
            await FilterSchoolLevelAndGenderAsync();
        }

        Tables = new List<string> { "Table 1", "Table 2", "Table 3", "Table 4" };
    }

    // ADDED: ParseQueryParameters method
    private async Task ParseQueryParameters()
    {
        try
        {
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

            // Get query parameters
            _selectedEventId = query["eventId"];

            // Check for other parameters
            var levelGender = query["levelGender"] ?? query["levelgender"];
            var mainCat = query["mainCat"] ?? query["maincat"];
            var subcategory = query["subcategory"] ?? query["subcate"];
            var stage = query["stage"];
            var sport = query["sport"];

            // Store these for later use
            if (!string.IsNullOrEmpty(levelGender))
            {
                _selectedSchoolLevelAndGenderID = levelGender;
            }

            if (!string.IsNullOrEmpty(mainCat))
            {
                _selectedMainCategoryValue = mainCat;
            }

            if (!string.IsNullOrEmpty(subcategory))
            {
                _storedSubcategoryName = Uri.UnescapeDataString(subcategory);
            }

            if (!string.IsNullOrEmpty(stage))
            {
                _storedStageName = Uri.UnescapeDataString(stage);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error parsing query parameters: {ex.Message}", Severity.Warning);
        }
    }

    // ADDED: LoadEventAndAutoFillFilters method
    // ADDED: LoadEventAndAutoFillFilters method
    private async Task LoadEventAndAutoFillFilters()
    {
        try
        {
            // Load available options first
            await LoadAvailableOptions();
            await FilterSchoolLevelAndGenderAsync();

            // First, try to get all chess events
            var allEvents = await apiService.GetAsync<ChessEventDTO>($"/ChessScoring/events");

            if (allEvents != null && allEvents.Any())
            {
                // Filter by eventId client-side
                var eventDetail = allEvents.FirstOrDefault(e => e.ID == _selectedEventId);

                if (eventDetail != null)
                {
                    // Auto-fill school level and gender
                    if (!string.IsNullOrEmpty(eventDetail.Level) && !string.IsNullOrEmpty(eventDetail.Gender))
                    {
                        _selectedSchoolLevelAndGenderID = $"{eventDetail.Level} - {eventDetail.Gender}";

                        // Load subcategories for this combination
                        await GetSportSubCategoriesSLGAsync();
                        LoadMainCategories();

                        // Auto-fill main category
                        if (!string.IsNullOrEmpty(eventDetail.SportMainCat))
                        {
                            _selectedMainCategoryValue = eventDetail.SportMainCat;
                        }

                        // Auto-fill subcategory
                        if (!string.IsNullOrEmpty(eventDetail.Subcategory) && _sportSubcategories != null)
                        {
                            var subcat = _sportSubcategories.FirstOrDefault(s =>
                                s.Subcategory != null && (
                                    s.Subcategory.Equals(eventDetail.Subcategory, StringComparison.OrdinalIgnoreCase) ||
                                    eventDetail.Subcategory.Contains(s.Subcategory, StringComparison.OrdinalIgnoreCase) ||
                                    s.Subcategory.Contains(eventDetail.Subcategory, StringComparison.OrdinalIgnoreCase)
                                ));

                            if (subcat != null)
                            {
                                _selectedSportSubcategoryIDValue = subcat.ID;
                            }
                            else
                            {
                                // Try to find by main category
                                subcat = _sportSubcategories.FirstOrDefault(s =>
                                    s.MainCategory == eventDetail.SportMainCat);
                                if (subcat != null)
                                {
                                    _selectedSportSubcategoryIDValue = subcat.ID;
                                }
                            }
                        }

                        // Auto-fill stage
                        if (!string.IsNullOrEmpty(eventDetail.EventStage) && _eventStages != null)
                        {
                            var stage = _eventStages.FirstOrDefault(e =>
                                e.Stage != null && e.Stage.Equals(eventDetail.EventStage, StringComparison.OrdinalIgnoreCase));
                            if (stage != null)
                            {
                                _selectedEventStagesIDValue = stage.ID;
                            }
                        }

                        // Set SelectedEvent so ApplyFilters can use it
                        SelectedEvent = eventDetail;

                        // Apply filters automatically
                        await ApplyFilters();
                    }
                    else
                    {
                        Snackbar.Add("Event details are incomplete", Severity.Warning);
                    }
                }
                else
                {
                    Snackbar.Add("Event not found", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("No chess events found", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading event: {ex.Message}", Severity.Error);
            // Fall back to normal initialization
            await FilterSchoolLevelAndGenderAsync();
        }
    }

    private string? GetResultIndicator(string tableName, string color)
    {
        var key = $"{SelectedSet}_{tableName}_{color}";
        return _tableResults.ContainsKey(key) ? _tableResults[key] : null;
    }

    private Color GetResultColor(string tableName, string color)
    {
        var indicator = GetResultIndicator(tableName, color);
        return indicator switch
        {
            "W" => Color.Success,
            "L" => Color.Error,
            "D" => Color.Warning,
            _ => Color.Default
        };
    }

    private void SetResultIndicator(string tableName, string color, string result)
    {
        var key = $"{SelectedSet}_{tableName}_{color}";
        _tableResults[key] = result;
    }

    private void ClearResultIndicatorsForTable(string tableName)
    {
        var whiteKey = $"{SelectedSet}_{tableName}_White";
        var blackKey = $"{SelectedSet}_{tableName}_Black";
        _tableResults.Remove(whiteKey);
        _tableResults.Remove(blackKey);
    }

    private void ClearAllResultIndicatorsForSet(int setNumber)
    {
        var keysToRemove = _tableResults.Keys.Where(key => key.StartsWith($"{setNumber}_")).ToList();
        foreach (var key in keysToRemove)
        {
            _tableResults.Remove(key);
        }
    }

    private (decimal TotalPoints, int GamesPlayed, int Wins, int Draws, int Losses)
        CalculateRegionStatsForSet(RegionItem region, int setNumber)
    {
        decimal totalPoints = 0;
        int gamesPlayed = 0;
        int wins = 0;
        int draws = 0;
        int losses = 0;

        try
        {
            foreach (var result in _tableResults)
            {
                if (result.Key.StartsWith($"{setNumber}_"))
                {
                    var parts = result.Key.Split('_');
                    if (parts.Length == 3)
                    {
                        var tableName = parts[1];
                        var color = parts[2];

                        var expectedAssignment = $"{setNumber}_{tableName}_{color}";
                        if (region.AssignedTable == expectedAssignment)
                        {
                            gamesPlayed++;

                            switch (result.Value)
                            {
                                case "W":
                                    totalPoints += 1.0m;
                                    wins++;
                                    break;
                                case "D":
                                    totalPoints += 0.5m;
                                    draws++;
                                    break;
                                case "L":
                                    totalPoints += 0.0m;
                                    losses++;
                                    break;
                            }
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error calculating stats for {region.Name}: {ex.Message}");
        }

        return (totalPoints, gamesPlayed, wins, draws, losses);
    }

    private Color GetPointsColor(decimal points)
    {
        return points switch
        {
            > 0 => Color.Primary,
            0 => Color.Default,
            _ => Color.Default
        };
    }

    private async Task RefreshStandings()
    {
        try
        {
            if (SelectedEvent != null)
            {
                await LoadExistingChessAssignments();
                StateHasChanged();
                Snackbar.Add("Standings refreshed", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing standings: {ex.Message}", Severity.Error);
        }
    }

    private void RefreshStandingsAfterScoreUpdate()
    {
        StateHasChanged();
    }

    private async Task LoadAvailableOptions()
    {
        try
        {
            await GetEventStagesAsync();
            await GetGenderCategoriesAsync();
            await GetSchoolLevelsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading options: {ex.Message}", Severity.Error);
        }
    }

    // UPDATED: GetEventStagesAsync method
    private async Task GetEventStagesAsync()
    {
        string url = "/Events/Stages";
        _eventStages = await apiService.GetAsync<EventsDTO.EventStages>(url);

        // Try to auto-select stage if we have a stored name
        if (!string.IsNullOrEmpty(_storedStageName) && _eventStages != null)
        {
            var stage = _eventStages.FirstOrDefault(e =>
                e.Stage != null && e.Stage.Equals(_storedStageName, StringComparison.OrdinalIgnoreCase));

            if (stage != null)
            {
                _selectedEventStagesIDValue = stage.ID;
                _storedStageName = null; // Clear after use
            }
        }
    }

    private async Task GetGenderCategoriesAsync()
    {
        string url = "/Sports/GenderCategories";
        _sportGenderCategories = await apiService.GetAsync<SportsDTO.SportGenderCategories>(url);
    }

    private async Task GetSchoolLevelsAsync()
    {
        string url = "/Schools/Levels";
        _schoolLevels = await apiService.GetAsync<SchoolsDTO.SchoolLevels>(url);
    }

    // UPDATED: GetSportSubCategoriesSLGAsync method
    private async Task GetSportSubCategoriesSLGAsync()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
            return;
        }

        var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
        var schoolLevelName = parts[0];
        var genderName = parts[1];

        var schoolLevelID = _schoolLevels?.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
        var genderID = _sportGenderCategories?.FirstOrDefault(x => x.Gender == genderName)?.ID;

        if (schoolLevelID != null && genderID != null && _selectedSportIDValue != null)
        {
            _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(
                $"/Sports/Subcategories?sportID={_selectedSportIDValue}&schoolLevelID={schoolLevelID}&sportGenderCategoryID={genderID}");

            // Try to auto-select subcategory if we have a stored name
            if (!string.IsNullOrEmpty(_storedSubcategoryName) && _sportSubcategories != null)
            {
                // Try multiple matching strategies
                var subcat = _sportSubcategories.FirstOrDefault(s =>
                    s.Subcategory != null && (
                        s.Subcategory.Equals(_storedSubcategoryName, StringComparison.OrdinalIgnoreCase) ||
                        s.Subcategory.Replace(" ", "").Equals(_storedSubcategoryName.Replace(" ", ""), StringComparison.OrdinalIgnoreCase) ||
                        _storedSubcategoryName.Contains(s.Subcategory, StringComparison.OrdinalIgnoreCase) ||
                        s.Subcategory.Contains(_storedSubcategoryName, StringComparison.OrdinalIgnoreCase)
                    ));

                if (subcat != null)
                {
                    _selectedSportSubcategoryIDValue = subcat.ID;
                    _storedSubcategoryName = null; // Clear after use
                }
            }
        }
        else
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        }
    }

    private List<SportsDTO.SportSubcategories> GetFilteredSubcategories()
    {
        if (_sportSubcategories == null) return new List<SportsDTO.SportSubcategories>();
        return !string.IsNullOrEmpty(_selectedMainCategoryValue)
            ? _sportSubcategories.Where(sc => sc.MainCategory == _selectedMainCategoryValue).ToList()
            : _sportSubcategories.Where(sc => string.IsNullOrEmpty(sc.MainCategory)).ToList();
    }

    private async Task FilterSchoolLevelAndGenderAsync()
    {
        if (_selectedSportIDValue == null)
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var subcats = await apiService.GetAsync<SportsDTO.SportSubcategories>($"/Sports/Subcategories?sportID={_selectedSportIDValue}");
        if (subcats == null || !subcats.Any())
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var schoolLevelIDs = subcats.Where(x => x.SchoolLevelID.HasValue).Select(x => x.SchoolLevelID.Value).Distinct();
        var genderIDs = subcats.Where(x => x.SportGenderCategoryID.HasValue).Select(x => x.SportGenderCategoryID.Value).Distinct();

        var schoolLevelNames = _schoolLevels?.Where(s => schoolLevelIDs.Contains(s.ID)).Select(s => s.Level) ?? new List<string>();
        var genderNames = _sportGenderCategories?.Where(g => genderIDs.Contains(g.ID)).Select(g => g.Gender) ?? new List<string>();

        _combinedSchoolLevelAndGenderNames = schoolLevelNames.SelectMany(s => genderNames, (s, g) => $"{s} - {g}").ToList();
    }

    private void LoadMainCategories()
    {
        _sportMainCat = _sportSubcategories?.Where(sc => !string.IsNullOrEmpty(sc.MainCategory))
            .Select(sc => sc.MainCategory!).Distinct().ToList() ?? new List<string>();
    }

    // UPDATED: ApplyFilters method
    // UPDATED: ApplyFilters method
    private async Task ApplyFilters()
    {
        try
        {
            // If we have a SelectedEvent (from LoadEventAndAutoFillFilters), use it directly
            if (SelectedEvent != null && !string.IsNullOrEmpty(SelectedEvent.ID))
            {
                // Directly set up the regions for this specific event
                await SetupRegionsForEvent(SelectedEvent);
                return;
            }

            // Original filter logic for when no eventId is provided
            var queryParams = new List<string>();

            if (_selectedSportSubcategoryIDValue.HasValue)
            {
                var subcategoryName = _sportSubcategories?.FirstOrDefault(s => s.ID == _selectedSportSubcategoryIDValue.Value)?.Subcategory;
                if (!string.IsNullOrEmpty(subcategoryName))
                    queryParams.Add($"subcategory={Uri.EscapeDataString(subcategoryName)}");
            }

            if (!string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
            {
                var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
                if (parts.Length == 2)
                {
                    queryParams.Add($"level={Uri.EscapeDataString(parts[0])}");
                    queryParams.Add($"gender={Uri.EscapeDataString(parts[1])}");
                }
            }

            if (_selectedEventStagesIDValue.HasValue)
            {
                var stageName = _eventStages?.FirstOrDefault(e => e.ID == _selectedEventStagesIDValue.Value)?.Stage;
                if (!string.IsNullOrEmpty(stageName))
                    queryParams.Add($"eventStage={Uri.EscapeDataString(stageName)}");
            }

            var queryString = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
            var events = await apiService.GetAsync<ChessEventDTO>($"/ChessScoring/events{queryString}");

            if (events != null && events.Any())
            {
                await SetupRegionsForEvent(events.First());
            }
            else
            {
                Regions = new List<RegionItem>();
                BaseRegions = new List<RegionItem>();
                SelectedEvent = null;
                _tableResults.Clear();
                Snackbar.Add("No Chess events found with the selected filters", Severity.Warning);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error applying filters: {ex.Message}", Severity.Error);
            Regions = new List<RegionItem>();
            BaseRegions = new List<RegionItem>();
            StateHasChanged();
        }
    }

    private async Task SetupRegionsForEvent(ChessEventDTO eventItem)
    {
        _regionPlayerMap.Clear();

        // Get all events with the same filters to get all regions
        var queryParams = new List<string>();

        if (!string.IsNullOrEmpty(eventItem.Subcategory))
            queryParams.Add($"subcategory={Uri.EscapeDataString(eventItem.Subcategory)}");

        if (!string.IsNullOrEmpty(eventItem.Level))
            queryParams.Add($"level={Uri.EscapeDataString(eventItem.Level)}");

        if (!string.IsNullOrEmpty(eventItem.Gender))
            queryParams.Add($"gender={Uri.EscapeDataString(eventItem.Gender)}");

        if (!string.IsNullOrEmpty(eventItem.EventStage))
            queryParams.Add($"eventStage={Uri.EscapeDataString(eventItem.EventStage)}");

        var queryString = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
        var allEvents = await apiService.GetAsync<ChessEventDTO>($"/ChessScoring/events{queryString}");

        if (allEvents != null && allEvents.Any())
        {
            // Process each event individually - NO GROUPING
            BaseRegions = allEvents
                .Where(evt => !string.IsNullOrEmpty(evt.Abbreviation))
                .Select(evt =>
                {
                    var regionItem = new RegionItem
                        {
                            Id = evt.RegionID, // Keep original RegionID
                            Name = evt.Abbreviation!,
                            AssignedTable = "Unassigned",
                            SetNumber = 1,
                            PlayerName = evt.PlayerName,
                            PlayerID = evt.PlayerID // Store PlayerID here
                        };

                    // Keep the map for backward compatibility
                    if (!string.IsNullOrEmpty(evt.PlayerID))
                    {
                        _regionPlayerMap[evt.RegionID] = (evt.PlayerID, evt.PlayerName);
                    }

                    return regionItem;
                })
                .ToList();

            AllSets.Clear();
            var firstSet = BaseRegions.Select(r => new RegionItem
                {
                    Id = r.Id,
                    Name = r.Name,
                    AssignedTable = "Unassigned",
                    SetNumber = 1,
                    PlayerName = r.PlayerName,
                    PlayerID = r.PlayerID // Copy PlayerID to set
                }).ToList();
            AllSets.Add(firstSet);

            Regions = firstSet;
            SelectedEvent = eventItem;
            SelectedSet = 1;
            CurrentSet = 1;

            _tableResults.Clear();

            await LoadExistingChessAssignments();

            if (SelectedSet <= AllSets.Count)
            {
                Regions = AllSets[SelectedSet - 1];
            }

            Snackbar.Add($"Loaded {Regions.Count} items for the selected event.", Severity.Success);
        }
        else
        {
            Regions = new List<RegionItem>();
            BaseRegions = new List<RegionItem>();
            SelectedEvent = null;
            _tableResults.Clear();
            Snackbar.Add("No items found for the selected event", Severity.Warning);
        }
    }

    private async Task ClearFilters()
    {
        _selectedSchoolLevelAndGenderID = null;
        _selectedMainCategoryValue = null;
        _selectedSportSubcategoryIDValue = null;
        _selectedEventStagesIDValue = null;
        _selectedEventId = null; // Clear event ID too
        SelectedEvent = null;
        Regions = new List<RegionItem>();
        BaseRegions = new List<RegionItem>();
        _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        _combinedSchoolLevelAndGenderNames = new List<string>();
        _sportMainCat = new List<string>();
        _tableResults.Clear();
        AllSets.Clear();
        CurrentSet = 1;
        SelectedSet = 1;
        _regionPlayerMap.Clear();

        Snackbar.Add("Filters cleared", Severity.Info);
        StateHasChanged();
    }

    private async Task LoadExistingChessAssignments()
    {
        try
        {
            if (SelectedEvent == null) return;

            var existingAssignments = await apiService.GetAsync<ChessScoringDTO>($"/ChessScoring/event/{SelectedEvent.ID}");
            if (existingAssignments != null && existingAssignments.Any())
            {
                var maxSetNo = existingAssignments.Max(a => a.SetNo);

                while (AllSets.Count < maxSetNo)
                {
                    var newSetNumber = AllSets.Count + 1;
                    var newSet = BaseRegions.Select(baseRegion => new RegionItem
                        {
                            Id = baseRegion.Id,
                            Name = baseRegion.Name,
                            AssignedTable = "Unassigned",
                            SetNumber = newSetNumber,
                            PlayerName = baseRegion.PlayerName,
                            PlayerID = baseRegion.PlayerID // Copy PlayerID
                        }).ToList();
                    AllSets.Add(newSet);
                }

                foreach (var assignment in existingAssignments)
                {
                    if (assignment.SetNo <= AllSets.Count && assignment.TableNo > 0 && !string.IsNullOrEmpty(assignment.ColorGroup))
                    {
                        var setToUpdate = AllSets[assignment.SetNo - 1];
                        var regionInSet = setToUpdate.FirstOrDefault(r => r.Id == assignment.RegionID);

                        if (regionInSet != null)
                        {
                            regionInSet.AssignedTable = $"{assignment.SetNo}_Table {assignment.TableNo}_{assignment.ColorGroup}";

                            if (!string.IsNullOrEmpty(assignment.PlayerName))
                            {
                                regionInSet.PlayerName = assignment.PlayerName;
                            }
                            else
                            {
                                var baseRegion = BaseRegions.FirstOrDefault(br => br.Id == assignment.RegionID);
                                if (baseRegion != null)
                                {
                                    regionInSet.PlayerName = baseRegion.PlayerName;
                                }
                            }

                            // Also update PlayerID from assignment
                            if (!string.IsNullOrEmpty(assignment.PlayerID))
                            {
                                regionInSet.PlayerID = assignment.PlayerID;
                            }

                            if (assignment.Score.HasValue)
                            {
                                var tableName = $"Table {assignment.TableNo}";
                                var resultKey = $"{assignment.SetNo}_{tableName}_{assignment.ColorGroup}";
                                _tableResults[resultKey] = assignment.Score switch
                                {
                                    1.0m => "W",
                                    0.5m => "D",
                                    0.0m => "L",
                                    _ => ""
                                };
                            }
                        }
                    }
                }

                if (maxSetNo > CurrentSet)
                {
                    CurrentSet = maxSetNo;
                }

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error loading existing chess assignments", Severity.Warning);
        }
    }

    private void AddTable() => Tables.Add($"Table {Tables.Count + 1}");

    private void NextSet()
    {
        if (!BaseRegions.Any())
        {
            Snackbar.Add("No regions available. Please apply filters first.", Severity.Warning);
            return;
        }

        CurrentSet++;

        var newSet = BaseRegions.Select(baseRegion => new RegionItem
            {
                Id = baseRegion.Id,
                Name = baseRegion.Name,
                AssignedTable = "Unassigned",
                SetNumber = CurrentSet,
                PlayerName = baseRegion.PlayerName,
                PlayerID = baseRegion.PlayerID // Copy PlayerID
            }).ToList();

        AllSets.Add(newSet);
        SelectedSet = CurrentSet;
        Regions = newSet;

        ClearAllResultIndicatorsForSet(CurrentSet);

        Snackbar.Add($"Set {CurrentSet} created with {Regions.Count} regions!", Severity.Success);
        StateHasChanged();
    }

    private void OnSetChanged(int setNumber)
    {
        if (setNumber >= 1 && setNumber <= AllSets.Count)
        {
            SelectedSet = setNumber;
            Regions = AllSets[setNumber - 1];

            foreach (var region in Regions)
            {
                var baseRegion = BaseRegions.FirstOrDefault(br => br.Id == region.Id);
                if (baseRegion != null)
                {
                    if (string.IsNullOrEmpty(region.PlayerName))
                    {
                        region.PlayerName = baseRegion.PlayerName;
                    }
                    if (string.IsNullOrEmpty(region.PlayerID))
                    {
                        region.PlayerID = baseRegion.PlayerID; // Copy PlayerID too
                    }
                }
            }

            StateHasChanged();
        }
        else
        {
            Snackbar.Add($"Set {setNumber} is not available. Total sets: {AllSets.Count}", Severity.Warning);
        }
    }

    private bool SelectItemsForZone(RegionItem item, string dropzone)
    {
        return item.SetNumber == SelectedSet && item.AssignedTable == dropzone;
    }

    private async Task OnItemDropped(MudItemDropInfo<RegionItem> info)
    {
        info.Item.AssignedTable = info.DropzoneIdentifier;
        info.Item.SetNumber = SelectedSet;

        Snackbar.Add($"{info.Item.Name} moved to {info.Item.AssignedTable} (Set {SelectedSet})", Severity.Success);
        await SaveRegionAssignment(info.Item);
        StateHasChanged();
    }

    private async Task SaveRegionAssignment(RegionItem region)
    {
        try
        {
            var (tableNo, colorGroup) = ParseAssignedTable(region.AssignedTable);

            if (tableNo > 0 && colorGroup != "Unassigned" && SelectedEvent != null)
            {
                // Use the PlayerID stored in the region item itself
                var playerId = region.PlayerID;

                var createDto = new CreateChessScoringDTO
                    {
                        SportsID = 9,
                        EventID = SelectedEvent.ID,
                        EventVersusID = null,
                        RegionID = region.Id,
                        SetNo = region.SetNumber,
                        TableNo = tableNo,
                        ColorGroup = colorGroup,
                        Score = 0,
                        PlayerID = playerId // Use the player ID from the region
                    };

                var result = await apiService.PostAsync<CreateChessScoringDTO, int>("/ChessScoring", createDto);
                if (result > 0)
                {
                    Snackbar.Add($"Saved {region.Name} assignment successfully!", Severity.Success);
                }
                else
                {
                    Snackbar.Add($"Failed to save assignment for {region.Name}", Severity.Warning);
                }
            }
            else if (region.AssignedTable == "Unassigned")
            {
                await DeleteAssignment(region.Id, region.SetNumber);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving assignment: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteAssignment(int regionId, int setNumber)
    {
        try
        {
            await apiService.DeleteAsync($"/ChessScoring/region/{regionId}/set/{setNumber}");
            Snackbar.Add("Assignment removed", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error removing assignment", Severity.Warning);
        }
    }

    private async Task UpdateScore(string tableName, string result, string color)
    {
        try
        {
            var tableId = $"{SelectedSet}_{tableName}_{color}";
            var region = Regions!.FirstOrDefault(r => r.AssignedTable == tableId);

            if (region != null)
            {
                var (tableNo, colorGroup) = ParseAssignedTable(tableId);
                ClearResultIndicatorsForTable(tableName);

                if (result == "draw")
                {
                    var opponentColor = color == "White" ? "Black" : "White";
                    var opponentTableId = $"{SelectedSet}_{tableName}_{opponentColor}";
                    var opponentRegion = Regions!.FirstOrDefault(r => r.AssignedTable == opponentTableId);

                    if (opponentRegion != null)
                    {
                        var (opponentTableNo, opponentColorGroup) = ParseAssignedTable(opponentTableId);
                        await UpdatePlayerScore(region.Id, SelectedSet, tableNo, colorGroup, 0.5m, region.Name);
                        await UpdatePlayerScore(opponentRegion.Id, SelectedSet, opponentTableNo, opponentColorGroup, 0.5m, opponentRegion.Name);
                        SetResultIndicator(tableName, color, "D");
                        SetResultIndicator(tableName, opponentColor, "D");
                        Snackbar.Add($"Draw recorded: Both {region.Name} and {opponentRegion.Name} get 0.5 points", Severity.Success);
                    }
                }
                else
                {
                    decimal score = result == "win" ? 1.0m : 0.0m;
                    await UpdatePlayerScore(region.Id, SelectedSet, tableNo, colorGroup, score, region.Name);

                    if (result == "win")
                    {
                        var opponentColor = color == "White" ? "Black" : "White";
                        var opponentTableId = $"{SelectedSet}_{tableName}_{opponentColor}";
                        var opponentRegion = Regions!.FirstOrDefault(r => r.AssignedTable == opponentTableId);

                        if (opponentRegion != null)
                        {
                            var (opponentTableNo, opponentColorGroup) = ParseAssignedTable(opponentTableId);
                            await UpdatePlayerScore(opponentRegion.Id, SelectedSet, opponentTableNo, opponentColorGroup, 0.0m, opponentRegion.Name);
                            SetResultIndicator(tableName, color, "W");
                            SetResultIndicator(tableName, opponentColor, "L");
                        }
                        else
                        {
                            SetResultIndicator(tableName, color, "W");
                        }
                        Snackbar.Add($"Win recorded: {region.Name} gets 1.0 point", Severity.Success);
                    }
                }

                RefreshStandingsAfterScoreUpdate();
                StateHasChanged();
            }
            else
            {
                Snackbar.Add($"No region assigned to {color} side of {tableName}", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating score: {ex.Message}", Severity.Error);
        }
    }

    private async Task UpdatePlayerScore(int regionId, int setNo, int tableNo, string colorGroup, decimal score, string regionName)
    {
        try
        {
            var recordId = await GetOrCreateChessScoringId(regionId, setNo, tableNo, colorGroup);
            if (recordId > 0)
            {
                // Get the region to find the player ID
                var region = Regions?.FirstOrDefault(r => r.Id == regionId);
                var playerId = region?.PlayerID;

                var updateDto = new UpdateChessScoringDTO
                    {
                        ID = recordId,
                        TableNo = tableNo,
                        ColorGroup = colorGroup,
                        Score = score,
                        SetNo = setNo,
                        PlayerID = playerId // Use the player ID from the region
                    };
                await apiService.PutAsync($"/ChessScoring/{recordId}", updateDto);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating score for {regionName}: {ex.Message}", Severity.Error);
        }
    }

    private async Task<int> GetOrCreateChessScoringId(int regionId, int setNo, int tableNo, string colorGroup)
    {
        try
        {
            var existing = await apiService.GetAsync<ChessScoringDTO>($"/ChessScoring/event/{SelectedEvent?.ID}");
            var record = existing?.FirstOrDefault(r => r.RegionID == regionId && r.SetNo == setNo && r.TableNo == tableNo && r.ColorGroup == colorGroup);

            if (record != null) return record.ID;

            // Get the region to find the player ID
            var region = Regions?.FirstOrDefault(r => r.Id == regionId);
            var playerId = region?.PlayerID;

            var createDto = new CreateChessScoringDTO
                {
                    SportsID = 9,
                    EventID = SelectedEvent?.ID,
                    RegionID = regionId,
                    SetNo = setNo,
                    TableNo = tableNo,
                    ColorGroup = colorGroup,
                    Score = 0,
                    PlayerID = playerId // Use the player ID from the region
                };

            var newId = await apiService.PostAsync<CreateChessScoringDTO, int>("/ChessScoring", createDto);
            return newId > 0 ? newId : 0;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error getting record ID: {ex.Message}", Severity.Error);
            return 0;
        }
    }
    private (int tableNo, string colorGroup) ParseAssignedTable(string assignedTable)
    {
        if (assignedTable == "Unassigned") return (0, "Unassigned");

        try
        {
            var parts = assignedTable.Split('_');
            if (parts.Length == 3)
            {
                var tableName = parts[1];
                var color = parts[2];
                var tableNo = int.Parse(tableName.Replace("Table ", ""));
                return (tableNo, color);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing assigned table: {ex.Message}");
        }
        return (0, "Unassigned");
    }

    private void RemoveTable(string tableName)
    {
        if (Tables.Contains(tableName))
        {
            Tables.Remove(tableName);
            foreach (var region in Regions!)
            {
                if (region.AssignedTable == $"{SelectedSet}_{tableName}_White" || region.AssignedTable == $"{SelectedSet}_{tableName}_Black")
                {
                    region.AssignedTable = "Unassigned";
                }
            }
            ClearResultIndicatorsForTable(tableName);
            Snackbar.Add($"{tableName} removed.", Severity.Info);
            StateHasChanged();
        }
    }

    private List<RegionStanding> GetOverallStandings()
    {
        var standings = new List<RegionStanding>();

        if (BaseRegions == null || !BaseRegions.Any())
            return standings;

        try
        {
            var regionGroups = BaseRegions.GroupBy(r => r.Name);

            foreach (var regionGroup in regionGroups)
            {
                var regionName = regionGroup.Key;
                var regionId = regionGroup.First().Id;

                var baseRegion = BaseRegions.FirstOrDefault(br => br.Name == regionName);
                var playerName = baseRegion?.PlayerName;

                var standing = new RegionStanding
                    {
                        RegionName = regionName,
                        RegionId = regionId,
                        PlayerName = playerName,
                    };

                decimal totalPoints = 0;
                int gamesPlayed = 0;
                int wins = 0;
                int draws = 0;
                int losses = 0;
                int setsPlayed = 0;

                foreach (var set in AllSets)
                {
                    var regionInSet = set.FirstOrDefault(r => r.Name == regionName);
                    if (regionInSet != null)
                    {
                        var setStats = CalculateRegionStatsForSet(regionInSet, AllSets.IndexOf(set) + 1);
                        totalPoints += setStats.TotalPoints;
                        gamesPlayed += setStats.GamesPlayed;
                        wins += setStats.Wins;
                        draws += setStats.Draws;
                        losses += setStats.Losses;

                        if (setStats.GamesPlayed > 0)
                            setsPlayed++;
                    }
                }

                standing.TotalPoints = totalPoints;
                standing.GamesPlayed = gamesPlayed;
                standing.Wins = wins;
                standing.Draws = draws;
                standing.Losses = losses;
                standing.SetsPlayed = setsPlayed;

                standings.Add(standing);
            }

            return standings.OrderByDescending(s => s.TotalPoints)
                           .ThenByDescending(s => s.Wins)
                           .ThenBy(s => s.Losses)
                           .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error calculating standings: {ex.Message}", Severity.Error);
            return new List<RegionStanding>();
        }
    }

    private async Task OpenEditEventDialog(string? selectedEventID)
    {
        var parameters = new DialogParameters<AddEditDialog>
        {
            { x => x.SelectedEventID, selectedEventID },
            { x => x.IsEditMode, true }
        };

        var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseOnEscapeKey = true,
                BackdropClick = false
            };

        var dialog = await DialogService.ShowAsync<AddEditDialog>("Edit Event", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {

        }
    }

    private async Task ProceedToNextStage()
    {
        try
        {
            // 1. Validate current event
            if (SelectedEvent == null)
            {
                Snackbar.Add("No event selected. Please apply filters first.", Severity.Warning);
                return;
            }

            // 2. Check if all matches in current set have results
            var tablesWithPlayers = Tables.Where(table =>
            {
                var whiteId = $"{SelectedSet}_{table}_White";
                var blackId = $"{SelectedSet}_{table}_Black";
                return Regions.Any(r => r.AssignedTable == whiteId) &&
                       Regions.Any(r => r.AssignedTable == blackId);
            }).ToList();

            var tablesWithoutResults = tablesWithPlayers.Where(table =>
            {
                var whiteId = $"{SelectedSet}_{table}_White";
                var blackId = $"{SelectedSet}_{table}_Black";
                var whiteResult = GetResultIndicator(table, "White");
                var blackResult = GetResultIndicator(table, "Black");
                return whiteResult == null || blackResult == null;
            }).ToList();

            if (tablesWithoutResults.Any())
            {
                Snackbar.Add($"Please record results for all matches before proceeding to next stage.", Severity.Warning);
                return;
            }

            // 3. Get current stage ID and next stage ID
            var currentStageId = await GetCurrentEventStageId();
            if (!currentStageId.HasValue)
            {
                Snackbar.Add("Could not determine current event stage.", Severity.Error);
                return;
            }

            var nextStageId = GetNextStageId(currentStageId.Value);
            if (nextStageId == 0)
            {
                Snackbar.Add("No next stage available for progression.", Severity.Warning);
                return;
            }

            // 4. Get the next stage name
            var nextStage = _eventStages?.FirstOrDefault(s => s.ID == nextStageId);
            if (nextStage == null)
            {
                Snackbar.Add($"Could not find stage with ID {nextStageId}", Severity.Error);
                return;
            }

            // 5. Fetch ALL EventVersusTeams (not just winners)
            var progressionTeams = new List<Dictionary<string, object>>();

            // Get ALL EventVersusTeams for the current event (not filtered by rank)
            var versusTeams = await apiService.GetAsync<EventsDTO.EventVersusTeams>(
                $"/Events/VersusTeams?eventID={SelectedEvent.ID}");

            if (versusTeams != null && versusTeams.Any())
            {
                // Get overall standings to determine ranks
                var standings = GetOverallStandings();

                foreach (var team in versusTeams)
                {
                    // Get players for this team
                    var teamPlayers = await apiService.GetAsync<EventsDTO.EventVersusTeamPlayers>(
                        $"/Events/VersusTeams/Players?eventVersusID={team.ID}");

                    var selectedPlayerIds = new List<string>();
                    var playerNames = new List<string>();

                    if (teamPlayers != null && teamPlayers.Any())
                    {
                        foreach (var player in teamPlayers)
                        {
                            if (!string.IsNullOrEmpty(player.ProfilePlayerID))
                            {
                                selectedPlayerIds.Add(player.ProfilePlayerID);

                                // Build full name
                                var fullName = "";
                                if (!string.IsNullOrEmpty(player.FirstName) && !string.IsNullOrEmpty(player.LastName))
                                    fullName = $"{player.FirstName} {player.LastName}";
                                else if (!string.IsNullOrEmpty(player.FirstName))
                                    fullName = player.FirstName;
                                else if (!string.IsNullOrEmpty(player.LastName))
                                    fullName = player.LastName;
                                else
                                    fullName = player.ProfilePlayerID;

                                playerNames.Add(fullName);
                            }
                        }
                    }

                    // Calculate total points for this region from standings
                    var regionStanding = standings.FirstOrDefault(s => s.RegionId == team.SchoolRegionID);
                    var totalPoints = regionStanding?.TotalPoints ?? 0;

                    // Determine rank from standings position
                    var rank = "";
                    var position = standings.FindIndex(s => s.RegionId == team.SchoolRegionID) + 1;
                    if (position > 0)
                    {
@*                         rank = GetRankForPosition(position); *@                    
                    }

                    // Add to progression teams (ALL teams, not just winners)
                    var teamData = new Dictionary<string, object>
                        {
                            ["SelectedRegionID"] = team.SchoolRegionID,
                            ["ExistingVersusTeamID"] = team.ID,
                            ["Score"] = totalPoints.ToString("F1"), // Use actual points from standings
                            ["Rank"] = rank,
                            ["SelectedPlayerIDs"] = selectedPlayerIds,
                            ["PlayerNames"] = playerNames,
                            ["RegionName"] = team.Region ?? team.Abbreviation ?? "Unknown",
@*                             ["IsWinner"] = position <= GetNumberOfQualifiersForNextStage() // Mark if they qualify *@                        
                        };

                    progressionTeams.Add(teamData);
                }
            }
            else
            {
                Snackbar.Add("No teams found in EventVersusTeams for this event.", Severity.Warning);
                return;
            }

            if (!progressionTeams.Any())
            {
                Snackbar.Add("No teams found to proceed to next stage.", Severity.Warning);
                return;
            }

            // 6. Prepare dialog parameters for creating new event
            var parameters = new DialogParameters<AddEditDialog>
        {
            { x => x.IsProgressionMode, true },
            { x => x.PreviousEventID, SelectedEvent.ID },
            { x => x.ProgressionTeams, progressionTeams }
    @* { x => x.QualificationThreshold, GetNumberOfQualifiersForNextStage() } // Number of teams that qualify *@
        };

            // 7. Open the dialog
            var options = new DialogOptions
                {
                    CloseButton = true,
                    MaxWidth = MaxWidth.Medium,
                    FullWidth = true,
                    CloseOnEscapeKey = true,
                    BackdropClick = false
                };

            var dialog = await DialogService.ShowAsync<AddEditDialog>("Create Next Stage Event", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled)
            {
                Snackbar.Add("Next stage event created successfully!", Severity.Success);

                // Refresh the page with new event
                await ApplyFilters();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error proceeding to next stage: {ex.Message}", Severity.Error);
        }
    }

    // Add these helper methods to your @code section:

    private async Task<int?> GetCurrentEventStageId()
    {
        if (SelectedEvent?.ID == null) return null;

        try
        {
            var eventUrl = $"/Events?id={SelectedEvent.ID}";
            var events = await apiService.GetAsync<EventsDTO.EventStages>(eventUrl);

            if (events != null && events.Any())
            {
                return events.First().ID;
            }

            // Fallback: Try to get from stage name
            if (!string.IsNullOrEmpty(SelectedEvent.EventStage) && _eventStages != null)
            {
                var stage = _eventStages.FirstOrDefault(s =>
                    s.Stage != null && s.Stage.Equals(SelectedEvent.EventStage, StringComparison.OrdinalIgnoreCase));
                return stage?.ID;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error getting current event stage ID: {ex.Message}", Severity.Warning);
        }

        return null;
    }

    private int GetNextStageId(int currentStageId)
    {
        // Map chess tournament progression stages
        // Common chess tournament stages: 1=Preliminary, 2=Swiss, 3=Quarter-finals, 4=Semi-finals, 5=Finals

        var stageProgression = new Dictionary<int, int>
    {
        {1, 2},  // Preliminary -> Swiss
        {2, 3},  // Swiss -> Quarter-finals
        {3, 4},  // Quarter-finals -> Semi-finals
        {4, 5},  // Semi-finals -> Finals
        {5, 0}   // Finals -> No next stage
    };

        return stageProgression.ContainsKey(currentStageId) ? stageProgression[currentStageId] : 0;
    }

}