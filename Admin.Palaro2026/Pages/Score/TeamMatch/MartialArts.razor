@page "/score/martialarts"
@inject ISnackbar Snackbar
@inject APIService apiService

<PageTitle>Martial Arts Scoring | PALARO 2026</PageTitle>
<MudText Typo="Typo.h6" Align="Align.Center">Martial Arts Match (Sets/Rounds per Match)</MudText>

<!-- FILTERS SECTION -->
<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-4">Event Filters</MudText>
    <MudGrid Spacing="3" Justify="Justify.Center">
        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedSportIDValue" Margin="Margin.Dense" Label="Sport"
                       T="int?"
                       ShrinkLabel Variant="Variant.Outlined"
                       SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                  {
                                                      _selectedSchoolLevelAndGenderID = null;
                                                      _selectedSportSubcategoryIDValue = null;
                                                      _selectedMainCategoryValue = null;
                                                      await FilterSchoolLevelAndGenderAsync();
                                                  }))">
                <MudSelectItem T="int?" Value="2">Arnis</MudSelectItem>
                <MudSelectItem T="int?" Value="8">Boxing</MudSelectItem>
                <MudSelectItem T="int?" Value="18">Taekwondo</MudSelectItem>
                <MudSelectItem T="int?" Value="21">Wrestling</MudSelectItem>
                <MudSelectItem T="int?" Value="22">Wushu</MudSelectItem>
                <MudSelectItem T="int?" Value="23">Pencak Silat</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="_selectedSchoolLevelAndGenderID" Margin="Margin.Dense"
                       Label="School Level and Gender" T="string"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="_selectedSportIDValue == null"
                       SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                  {
                                                      _selectedSportSubcategoryIDValue = null;
                                                      _selectedMainCategoryValue = null;
                                                      await GetSportSubCategoriesSLGAsync();
                                                      LoadMainCategories();
                                                  }))">
                <MudVirtualize Items="_combinedSchoolLevelAndGenderNames" Context="combinedID">
                    <MudSelectItem T="string" Value="@combinedID">
                        @combinedID
                    </MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedMainCategoryValue" Margin="Margin.Dense"
                       Label="Event" T="string"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                @foreach (var mc in _sportMainCat)
                {
                    <MudSelectItem Value="@mc">@mc</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="_selectedSportSubcategoryIDValue" Margin="Margin.Dense"
                       Label="Category" T="int?"
                       HelperText="@((_sportSubcategories?.Any() != true && _selectedSchoolLevelAndGenderID != null) ? "No subcategory available for this gender or school level." : null)"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                <MudVirtualize Items="@GetFilteredSubcategories()" Context="subCategory">
                    <MudSelectItem T="int?" Value="@subCategory.ID">@subCategory.Subcategory</MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedEventStagesIDValue" Margin="Margin.Dense"
                       Label="Stage" T="int?"
                       ShrinkLabel Variant="Variant.Outlined" Clearable>
                <MudVirtualize Items="_eventStages" Context="eventStage">
                    <MudSelectItem T="int?" Value="eventStage.ID">@eventStage.Stage</MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-3" Justify="Justify.Center">
        <MudItem xs="12" sm="4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="ApplyFilters" FullWidth StartIcon="@Icons.Material.Filled.Search">
                Apply Filters
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                       OnClick="ClearFilters" FullWidth StartIcon="@Icons.Material.Filled.Clear">
                Clear Filters
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<!-- SELECTED EVENT INFO -->
@if (SelectedEvent != null)
{
    <MudPaper Class="pa-3 mb-4" Elevation="1" Style="background-color: #e3f2fd;">
        <MudGrid Spacing="3">
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.body2"><strong>Event:</strong> @SelectedEvent.Sport - @SelectedEvent.Subcategory</MudText>
            </MudItem>
            <MudItem xs="12" sm="5">
                <MudText Typo="Typo.body2"><strong>Level and Gender:</strong> @SelectedEvent.Level - @SelectedEvent.Gender</MudText>
            </MudItem>
            @* <MudItem xs="12" sm="3">
                <MudText Typo="Typo.body2"><strong>Level:</strong> @SelectedEvent.Level</MudText>
            </MudItem> *@
            <MudItem xs="12" sm="3">
                <MudText Typo="Typo.body2"><strong>Stage:</strong> @SelectedEvent.EventStage</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>
}

<!-- MATCH CARD -->
<MudGrid Spacing="3">
    <MudItem xs="12">
        @if (AllRegions == null)
        {
            <MudText Align="Align.Center" Class="ma-4">Please apply filters to see regions</MudText>
        }
        else if (!AllRegions.Any())
        {
            <MudText Align="Align.Center" Class="ma-4">No regions found. Please apply filters to see regions.</MudText>
        }
        else
        {
            <MudDropContainer T="RegionItem"
                              Items="GetRegionsForCurrentGame()"
                              ItemsSelector="SelectItemsForZone"
                              ItemDropped="OnItemDropped"
                              @key="@($"dropcontainer_{_selectedGameNo}")">

                <ChildContent>
                    <MudPaper Class="pa-2 mt-4 mb-6"
                              Elevation="3"
                              Style="position:sticky; top:0; z-index:1000; background-color:white;">

                        <MudGrid Class="my-2" Justify="Justify.Center" Spacing="4">
                            <MudItem xs="12" sm="3">
                                <MudSelect @bind-Value="_selectedGameNo"
                                           Label="Preview Game"
                                           T="int?"
                                           OnValueChanged="(value) => LoadGameMatches(value)">
                                    @foreach (var gameNo in _availableGameNos)
                                    {
                                        <MudSelectItem T="int?" Value="@gameNo">Game @gameNo</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12" sm="3">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Info"
                                           OnClick="AddNewGame"
                                           FullWidth>
                                    New Game
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                @if (_availableGameNos.Count > 1)
                                {
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Error"
                                               OnClick="@(() => RemoveGame(_selectedGameNo ?? 1))"
                                               FullWidth>
                                        Remove Current Game
                                    </MudButton>
                                }
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Success" OnClick="AddMatchCard" FullWidth>
                                    Add Match
                                </MudButton>
                            </MudItem>
                        </MudGrid>

                        <MudText Typo="Typo.subtitle1" Align="Align.Center">Regions - Total: @GetRegionsForCurrentGame().Count</MudText>
                        <MudDropZone T="RegionItem"
                                     Identifier="Unassigned"
                                     Class="d-flex flex-wrap justify-center pa-2"
                                     Style="min-height:100px; gap:6px; border:1px dashed gray;" />
                    </MudPaper>

                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.h6" Align="Align.Center">Match Cards - Game @_selectedGameNo</MudText>
                    <MudDivider Class="my-2" />

                    <MudGrid Spacing="3" Class="my-2" Justify="Justify.Center">
                        @foreach (var matchCard in GetMatchesForCurrentGame())
                        {
                            <MudItem xs="12" sm="6" md="4">
                                <MudPaper Elevation="2" Class="pa-3" Style="position:relative;">

                                    <MudIconButton Icon="@Icons.Material.Filled.Cancel"
                                                   Color="Color.Error"
                                                   Size="Size.Small"
                                                   Style="position:absolute; top:4px; right:4px;"
                                                   OnClick="@(() => RemoveMatchCard(matchCard.Id))"
                                                   Title="Remove match" />

                                    <MudText Typo="Typo.subtitle1" Align="Align.Center">
                                        Game @_selectedGameNo - Match @matchCard.Id
                                    </MudText>

                                    <MudDivider Class="my-2" />

                                    <!-- Current Set Display -->
                                    <MudGrid Class="mb-2" Justify="Justify.Center">
                                        <MudItem xs="12">
                                            <MudText Typo="Typo.body1" Color="Color.Primary" Class="font-weight-bold" Align="Align.Center">
                                                Round @GetCurrentSet(matchCard.Id)
                                            </MudText>
                                        </MudItem>
                                    </MudGrid>


                                    <MudGrid>

                                        <!-- Region A -->
                                        <MudItem xs="6">
                                            <MudStack Row="true" Style="align-items:center" Justify="Justify.Center" Spacing="1">
                                                <MudText Typo="Typo.body2">Red Side</MudText>
                                            </MudStack>

                                            <MudDropZone T="RegionItem"
                                                         Identifier="@($"Match{matchCard.Id}_RegionA")"
                                                         Class="pa-1 d-flex flex-wrap justify-center"
                                                         Style="min-height:60px; border:1px dashed gray;" />

                                            @if (GetRegionAssignedToMatch(matchCard.Id, "RegionA") != null)
                                            {
                                                <MudStack Row="true"
                                                          Spacing="1"
                                                          Class="mt-1 d-flex flex-row flex-wrap"
                                                          AlignItems="AlignItems.Center"
                                                          Justify="Justify.Center">

                                                    @foreach (var setResult in GetSetResults(matchCard.Id, "RegionA"))
                                                    {
                                                        <MudChip T="string"
                                                                 Size="Size.Small"
                                                                 Color="@(setResult == "W" ? Color.Success : Color.Error)"
                                                                 Variant="Variant.Filled">
                                                            @setResult
                                                        </MudChip>
                                                    }

                                                    @if (CanAddSet(matchCard.Id))
                                                    {
                                                        <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Small"
                                                                       OnClick="@(() => AddSetToMatch(matchCard.Id, "RegionA"))"
                                                                       Title="Add set win for Red Side" />
                                                    }

                                                </MudStack>
                                            }
                                        </MudItem>


                                        <!-- Region B -->
                                        <MudItem xs="6">
                                            <MudStack Row="true" Style="align-items:center" Justify="Justify.Center" Spacing="1">
                                                <MudText Typo="Typo.body2">Blue Side</MudText>
                                            </MudStack>

                                            <MudDropZone T="RegionItem"
                                                         Identifier="@($"Match{matchCard.Id}_RegionB")"
                                                         Class="pa-1 d-flex flex-wrap justify-center"
                                                         Style="min-height:60px; border:1px dashed gray;" />

                                            @if (GetRegionAssignedToMatch(matchCard.Id, "RegionB") != null)
                                            {
                                                <MudStack Row="true"
                                                          Spacing="1"
                                                          Class="mt-1 d-flex flex-row flex-wrap"
                                                          AlignItems="AlignItems.Center"
                                                          Justify="Justify.Center">

                                                    @foreach (var setResult in GetSetResults(matchCard.Id, "RegionB"))
                                                    {
                                                        <MudChip T="string"
                                                                 Size="Size.Small"
                                                                 Color="@(setResult == "W" ? Color.Success : Color.Error)"
                                                                 Variant="Variant.Filled">
                                                            @setResult
                                                        </MudChip>
                                                    }

                                                    @if (CanAddSet(matchCard.Id))
                                                    {
                                                        <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Small"
                                                                       OnClick="@(() => AddSetToMatch(matchCard.Id, "RegionB"))"
                                                                       Title="Add set win for Blue Side" />
                                                    }

                                                </MudStack>
                                            }
                                        </MudItem>
                                    </MudGrid>

                                    <!-- Set Result Buttons -->
                                    @if (BothRegionsAssigned(matchCard.Id))
                                    {
                                        <MudGrid Class="mt-2">
                                            <MudItem xs="6">
                                                <MudButton Variant="Variant.Outlined"
                                                           Color="Color.Success"
                                                           FullWidth
                                                           Size="Size.Small"
                                                           OnClick="@(() => RecordSetResult(matchCard.Id, "RegionA"))"
                                                           Disabled="@(GetSetResult(matchCard.Id, GetCurrentSet(matchCard.Id)) != null)">
                                                    Red Side Wins Set @GetCurrentSet(matchCard.Id)
                                                </MudButton>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudButton Variant="Variant.Outlined"
                                                           Color="Color.Success"
                                                           FullWidth
                                                           Size="Size.Small"
                                                           OnClick="@(() => RecordSetResult(matchCard.Id, "RegionB"))"
                                                           Disabled="@(GetSetResult(matchCard.Id, GetCurrentSet(matchCard.Id)) != null)">
                                                    Blue Side Wins Set @GetCurrentSet(matchCard.Id)
                                                </MudButton>
                                            </MudItem>
                                        </MudGrid>

                                        @if (GetSetResult(matchCard.Id, GetCurrentSet(matchCard.Id)) != null)
                                        {
                                            <MudGrid Class="mt-1">
                                                <MudItem xs="12">
                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Error"
                                                               FullWidth
                                                               Size="Size.Small"
                                                               OnClick="@(() => ClearSetResult(matchCard.Id, GetCurrentSet(matchCard.Id)))">
                                                        Clear Set @GetCurrentSet(matchCard.Id) Result
                                                    </MudButton>
                                                </MudItem>
                                            </MudGrid>
                                        }
                                    }

                                    <!-- Match Summary -->
                                    @if (BothRegionsAssigned(matchCard.Id))
                                    {
                                        var regionA = GetRegionAssignedToMatch(matchCard.Id, "RegionA");
                                        var regionB = GetRegionAssignedToMatch(matchCard.Id, "RegionB");
                                        var matchWinner = GetMatchWinner(matchCard.Id);

                                        <MudPaper Class="pa-2 mt-3" Elevation="0" Style="background-color: #f5f5f5;">
                                            <MudText Typo="Typo.body2" Class="font-weight-bold" Align="Align.Center">
                                                Match Summary
                                            </MudText>
                                            <MudGrid Spacing="0">
                                                <MudItem xs="5">
                                                    <MudText Typo="Typo.body2"
                                                             Color="@(matchWinner == regionA?.Name ? Color.Success : Color.Default)">
                                                        @regionA?.Name
                                                    </MudText>
                                                </MudItem>
                                                <MudItem xs="2">
                                                    <MudText Typo="Typo.body2" Align="Align.Center">vs</MudText>
                                                </MudItem>
                                                <MudItem xs="5">
                                                    <MudText Typo="Typo.body2"
                                                             Color="@(matchWinner == regionB?.Name ? Color.Success : Color.Default)"
                                                             Align="Align.Right">
                                                        @regionB?.Name
                                                    </MudText>
                                                </MudItem>
                                            </MudGrid>
                                            @if (!string.IsNullOrEmpty(matchWinner))
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Success" Align="Align.Center">
                                                    Winner: @matchWinner
                                                </MudText>
                                            }
                                        </MudPaper>
                                    }
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                </ChildContent>

                <ItemRenderer Context="item">
                    <MudChip T="string"
                             Variant="Variant.Filled"
                             Color="@GetRegionChipColor(item)"
                             Class="ma-1 cursor-move"
                             Style="max-width: 130px; height: auto; min-height: 52px; padding: 8px 12px; display: flex; align-items: center;">
                        <MudStack Spacing="0" Style="line-height: 1.3; text-align: center; width: 100%;">
                            <MudText Typo="Typo.body2"
                                     Class="font-weight-bold"
                                     Style="font-size: 0.75rem; margin-bottom: 2px;">
                                @item.Name
                            </MudText>
                            @if (!string.IsNullOrEmpty(item.PlayerName))
                            {
                                <MudText Typo="Typo.caption"
                                         Style="font-size: 0.65rem; word-break: break-word; opacity: 0.9;">
                                    @item.PlayerName
                                </MudText>
                            }
                        </MudStack>
                    </MudChip>
                </ItemRenderer>
            </MudDropContainer>
        }
    </MudItem>

    <!-- STANDINGS VIEW -->
    <MudItem xs="12">
        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-3">
                Martial Arts Standings
            </MudText>

            <MudGrid Class="mb-3" Spacing="2" Justify="Justify.Center">
                <MudItem xs="12" lg="4">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="RefreshStandings"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               Size="Size.Small"
                               FullWidth>
                        Refresh Standings
                    </MudButton>
                </MudItem>
            </MudGrid>

            <!-- Region Standings -->
            <MudTable Items="@GetRegionStandings()" Hover="true" Dense="true" Class="mt-3">
                <HeaderContent>
                    @* <MudTh>Rank</MudTh> *@
                    <MudTh>Region</MudTh>
                    <MudTh>Player</MudTh>
                    <MudTh>Matches Won</MudTh>
                    <MudTh>Matches Lost</MudTh>
                    <MudTh>Sets Won</MudTh>
                    <MudTh>Sets Lost</MudTh>
                    <MudTh>Win Rate</MudTh>
                </HeaderContent>
                <RowTemplate>
                    @{
                        var standing = context;
                        // var rank = GetRegionStandings().IndexOf(standing) + 1;
                    }
                    @* <MudTd>@rank</MudTd> *@
                    <MudTd>
                        <MudText Typo="Typo.body2" Class="font-weight-bold">
                            @standing.RegionName
                        </MudText>
                    </MudTd>
                    <MudTd>@standing.PlayerName</MudTd>
                    <MudTd>
                        <MudText Color="Color.Success" Class="font-weight-bold">
                            @standing.MatchesWon
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudText Color="Color.Error" Class="font-weight-bold">
                            @standing.MatchesLost
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudText Color="Color.Success">
                            @standing.SetsWon
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudText Color="Color.Error">
                            @standing.SetsLost
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudText Color="@(standing.WinRate >= 0 ? Color.Success : Color.Error)" Class="font-weight-bold">
                            @standing.WinRate.ToString("P0")
                        </MudText>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>

            @if (!GetRegionStandings().Any())
            {
                <MudText Align="Align.Center" Color="Color.Secondary" Class="ma-4">
                    No standings data available. Start some matches to see standings.
                </MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private List<RegionItem>? AllRegions;
    private List<MatchCard> MatchCards = new();
    private int SelectedSet = 1;

    private int? _selectedSportIDValue;
    private string? _selectedSchoolLevelAndGenderID;
    private string? _selectedMainCategoryValue;
    private int? _selectedSportSubcategoryIDValue;
    private int? _selectedEventStagesIDValue;

    private int? _selectedGameNo = 1;
    private List<int> _availableGameNos = new List<int> { 1 };

    private List<EventsDTO.EventStages>? _eventStages;
    private List<SportsDTO.SportGenderCategories>? _sportGenderCategories;
    private List<SchoolsDTO.SchoolLevels>? _schoolLevels;
    private List<SportsDTO.SportSubcategories>? _sportSubcategories;

    private List<string> _combinedSchoolLevelAndGenderNames = new();
    private List<string> _sportMainCat = new();

    private MartialArtsEventDTO? SelectedEvent;

    private Dictionary<int, List<RegionItem>> _gameRegions = new Dictionary<int, List<RegionItem>>();
    private Dictionary<int, Dictionary<string, Dictionary<int, string>>> _gameMatchSetResults = new Dictionary<int, Dictionary<string, Dictionary<int, string>>>();
    private Dictionary<int, Dictionary<string, int>> _gameMatchCurrentSets = new Dictionary<int, Dictionary<string, int>>();
    private Dictionary<int, List<int>> _gameMatches = new Dictionary<int, List<int>>();
    private Dictionary<int, int> _gameNextMatchId = new Dictionary<int, int>();

    private Dictionary<int, (string? PlayerID, string? PlayerName)> _regionPlayerMap = new();

    public class RegionItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string AssignedMatch { get; set; } = "Unassigned";
        public string? PlayerName { get; set; }
        public string MatchPosition { get; set; } = "";
        public int GameNo { get; set; } = 1;
    }

    public class MatchCard
    {
        public int Id { get; set; }
        public int GameNo { get; set; }
        public string RegionA { get; set; } = "";
        public string RegionB { get; set; } = "";
        public int CurrentSet { get; set; } = 1;
        public int MaxSet { get; set; } = 1;
    }

    public class RegionStanding
    {
        public string RegionName { get; set; } = "";
        public int RegionId { get; set; }
        public string? PlayerName { get; set; }
        public int MatchesWon { get; set; }
        public int MatchesLost { get; set; }
        public int SetsWon { get; set; }
        public int SetsLost { get; set; }
        public decimal WinRate { get; set; }
    }

    public class MartialArtsScoringDTO
    {
        public int ID { get; set; }
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int GameNo { get; set; }
        public int MatchId { get; set; }
        public string? MatchPosition { get; set; }
        public int SetNo { get; set; }
        public string? Result { get; set; }
        public DateTime? CreatedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class MartialArtsEventDTO
    {
        public string? ID { get; set; }
        public DateTime? Date { get; set; }
        public TimeSpan? Time { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class CreateMartialArtsScoringDTO
    {
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int GameNo { get; set; }
        public int MatchId { get; set; }
        public string? MatchPosition { get; set; }
        public int SetNo { get; set; }
        public string? Result { get; set; }
        public string? PlayerID { get; set; }
    }

    public class UpdateMartialArtsScoringDTO
    {
        public int ID { get; set; }
        public int GameNo { get; set; }
        public int MatchId { get; set; }
        public string? MatchPosition { get; set; }
        public int SetNo { get; set; }
        public string? Result { get; set; }
        public string? PlayerID { get; set; }
    }

    public class EventsDTO
    {
        public class EventStages
        {
            public int ID { get; set; }
            public string? Stage { get; set; }
        }
    }

    public class SportsDTO
    {
        public class SportSubcategories
        {
            public int ID { get; set; }
            public string? Subcategory { get; set; }
            public int? SportID { get; set; }
            public int? SportGenderCategoryID { get; set; }
            public int? SchoolLevelID { get; set; }
            public string? MainCategory { get; set; }
        }

        public class SportGenderCategories
        {
            public int ID { get; set; }
            public string? Gender { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class SchoolLevels
        {
            public int ID { get; set; }
            public string? Level { get; set; }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableOptions();
        await FilterSchoolLevelAndGenderAsync();

        InitializeGame(1);
        _availableGameNos = new List<int> { 1 };
        _selectedGameNo = 1;
    }

    private List<RegionItem> GetRegionsForCurrentGame()
    {
        if (!_selectedGameNo.HasValue) return new List<RegionItem>();

        if (_gameRegions.ContainsKey(_selectedGameNo.Value))
        {
            return _gameRegions[_selectedGameNo.Value];
        }

        return new List<RegionItem>();
    }

    private void InitializeGame(int gameNo)
    {
        if (AllRegions != null && !_gameRegions.ContainsKey(gameNo))
        {
            _gameRegions[gameNo] = AllRegions.Select(r => new RegionItem
                {
                    Id = r.Id,
                    Name = r.Name,
                    AssignedMatch = "Unassigned",
                    PlayerName = r.PlayerName,
                    MatchPosition = "",
                    GameNo = gameNo
                }).ToList();
        }

        if (!_gameMatches.ContainsKey(gameNo))
        {
            _gameMatches[gameNo] = new List<int>();
        }

        if (!_gameNextMatchId.ContainsKey(gameNo))
        {
            _gameNextMatchId[gameNo] = 1;
        }

        if (!_gameMatchSetResults.ContainsKey(gameNo))
        {
            _gameMatchSetResults[gameNo] = new Dictionary<string, Dictionary<int, string>>();
        }

        if (!_gameMatchCurrentSets.ContainsKey(gameNo))
        {
            _gameMatchCurrentSets[gameNo] = new Dictionary<string, int>();
        }

        for (int i = 0; i < 3; i++)
        {
            AddMatchToGame(gameNo);
        }
    }

    private void AddMatchToGame(int gameNo)
    {
        if (!_gameMatches.ContainsKey(gameNo))
        {
            _gameMatches[gameNo] = new List<int>();
        }

        if (!_gameNextMatchId.ContainsKey(gameNo))
        {
            _gameNextMatchId[gameNo] = 1;
        }

        var matchId = _gameNextMatchId[gameNo]++;

        var matchCard = new MatchCard
            {
                Id = matchId,
                GameNo = gameNo
            };

        MatchCards.Add(matchCard);
        _gameMatches[gameNo].Add(matchId);
    }

    private Color GetRegionChipColor(RegionItem region)
    {
        if (region.AssignedMatch != "Unassigned")
            return Color.Secondary;

        return Color.Primary;
    }

    private RegionItem? GetRegionAssignedToMatch(int matchId, string position)
    {
        if (!_selectedGameNo.HasValue) return null;

        var regions = GetRegionsForCurrentGame();
        return regions?.FirstOrDefault(r => r.AssignedMatch == $"Match{matchId}_{position}");
    }

    private List<string> GetSetResults(int matchId, string position)
    {
        var results = new List<string>();

        if (!_selectedGameNo.HasValue) return results;

        var matchKey = $"Match{matchId}";

        if (_gameMatchSetResults.ContainsKey(_selectedGameNo.Value) &&
            _gameMatchSetResults[_selectedGameNo.Value].ContainsKey(matchKey))
        {
            var region = GetRegionAssignedToMatch(matchId, position);
            if (region != null)
            {
                foreach (var kvp in _gameMatchSetResults[_selectedGameNo.Value][matchKey])
                {
                    var winnerRegion = GetWinnerForSet(matchId, kvp.Key);
                    if (winnerRegion == region.Name)
                        results.Add("W");
                    else if (!string.IsNullOrEmpty(winnerRegion) && winnerRegion != region.Name)
                        results.Add("L");
                }
            }
        }

        return results;
    }

    private string? GetWinnerForSet(int matchId, int setNo)
    {
        if (!_selectedGameNo.HasValue) return null;

        var matchKey = $"Match{matchId}";

        if (_gameMatchSetResults.ContainsKey(_selectedGameNo.Value) &&
            _gameMatchSetResults[_selectedGameNo.Value].ContainsKey(matchKey) &&
            _gameMatchSetResults[_selectedGameNo.Value][matchKey].ContainsKey(setNo))
        {
            var winningPosition = _gameMatchSetResults[_selectedGameNo.Value][matchKey][setNo];
            var region = GetRegionAssignedToMatch(matchId, winningPosition);
            return region?.Name;
        }
        return null;
    }

    private string? GetSetResult(int matchId, int setNo)
    {
        if (!_selectedGameNo.HasValue) return null;

        var matchKey = $"Match{matchId}";

        if (_gameMatchSetResults.ContainsKey(_selectedGameNo.Value) &&
            _gameMatchSetResults[_selectedGameNo.Value].ContainsKey(matchKey) &&
            _gameMatchSetResults[_selectedGameNo.Value][matchKey].ContainsKey(setNo))
        {
            return _gameMatchSetResults[_selectedGameNo.Value][matchKey][setNo];
        }
        return null;
    }

    private bool CanAddSet(int matchId)
    {
        return BothRegionsAssigned(matchId);
    }

    private bool BothRegionsAssigned(int matchId)
    {
        var regionA = GetRegionAssignedToMatch(matchId, "RegionA");
        var regionB = GetRegionAssignedToMatch(matchId, "RegionB");
        return regionA != null && regionB != null;
    }

    private int GetCurrentSet(int matchId)
    {
        if (!_selectedGameNo.HasValue) return 1;

        var matchKey = $"Match{matchId}";

        if (_gameMatchCurrentSets.ContainsKey(_selectedGameNo.Value) &&
            _gameMatchCurrentSets[_selectedGameNo.Value].ContainsKey(matchKey))
        {
            return _gameMatchCurrentSets[_selectedGameNo.Value][matchKey];
        }
        return 1;
    }

    private string? GetMatchWinner(int matchId)
    {
        var regionA = GetRegionAssignedToMatch(matchId, "RegionA");
        var regionB = GetRegionAssignedToMatch(matchId, "RegionB");

        if (regionA == null || regionB == null) return null;

        if (!_selectedGameNo.HasValue) return null;

        var matchKey = $"Match{matchId}";

        if (!_gameMatchSetResults.ContainsKey(_selectedGameNo.Value) ||
            !_gameMatchSetResults[_selectedGameNo.Value].ContainsKey(matchKey))
            return null;

        var regionAWins = _gameMatchSetResults[_selectedGameNo.Value][matchKey].Count(kvp => kvp.Value == "RegionA");
        var regionBWins = _gameMatchSetResults[_selectedGameNo.Value][matchKey].Count(kvp => kvp.Value == "RegionB");

        if (regionAWins > regionBWins) return regionA.Name;
        if (regionBWins > regionAWins) return regionB.Name;
        return null;
    }

    private async Task LoadAvailableOptions()
    {
        try
        {
            await GetEventStagesAsync();
            await GetGenderCategoriesAsync();
            await GetSchoolLevelsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading options: {ex.Message}", Severity.Error);
        }
    }

    private async Task GetEventStagesAsync()
    {
        string url = "/Events/Stages";
        _eventStages = await apiService.GetAsync<EventsDTO.EventStages>(url);
    }

    private async Task GetGenderCategoriesAsync()
    {
        string url = "/Sports/GenderCategories";
        _sportGenderCategories = await apiService.GetAsync<SportsDTO.SportGenderCategories>(url);
    }

    private async Task GetSchoolLevelsAsync()
    {
        string url = "/Schools/Levels";
        _schoolLevels = await apiService.GetAsync<SchoolsDTO.SchoolLevels>(url);
    }

    private async Task GetSportSubCategoriesSLGAsync()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
            return;
        }

        var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
        var schoolLevelName = parts[0];
        var genderName = parts[1];

        var schoolLevelID = _schoolLevels?.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
        var genderID = _sportGenderCategories?.FirstOrDefault(x => x.Gender == genderName)?.ID;

        if (schoolLevelID != null && genderID != null && _selectedSportIDValue != null)
        {
            _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(
                $"/Sports/Subcategories?sportID={_selectedSportIDValue}&schoolLevelID={schoolLevelID}&sportGenderCategoryID={genderID}");
        }
        else
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        }
    }

    private List<SportsDTO.SportSubcategories> GetFilteredSubcategories()
    {
        if (_sportSubcategories == null) return new List<SportsDTO.SportSubcategories>();
        return !string.IsNullOrEmpty(_selectedMainCategoryValue)
            ? _sportSubcategories.Where(sc => sc.MainCategory == _selectedMainCategoryValue).ToList()
            : _sportSubcategories.Where(sc => string.IsNullOrEmpty(sc.MainCategory)).ToList();
    }

    private async Task FilterSchoolLevelAndGenderAsync()
    {
        if (_selectedSportIDValue == null)
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var subcats = await apiService.GetAsync<SportsDTO.SportSubcategories>($"/Sports/Subcategories?sportID={_selectedSportIDValue}");
        if (subcats == null || !subcats.Any())
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var schoolLevelIDs = subcats.Where(x => x.SchoolLevelID.HasValue).Select(x => x.SchoolLevelID.Value).Distinct();
        var genderIDs = subcats.Where(x => x.SportGenderCategoryID.HasValue).Select(x => x.SportGenderCategoryID.Value).Distinct();

        var schoolLevelNames = _schoolLevels?.Where(s => schoolLevelIDs.Contains(s.ID)).Select(s => s.Level) ?? new List<string>();
        var genderNames = _sportGenderCategories?.Where(g => genderIDs.Contains(g.ID)).Select(g => g.Gender) ?? new List<string>();

        _combinedSchoolLevelAndGenderNames = schoolLevelNames.SelectMany(s => genderNames, (s, g) => $"{s} - {g}").ToList();
    }

    private void LoadMainCategories()
    {
        _sportMainCat = _sportSubcategories?.Where(sc => !string.IsNullOrEmpty(sc.MainCategory))
            .Select(sc => sc.MainCategory!).Distinct().ToList() ?? new List<string>();
    }

    private async Task ApplyFilters()
    {
        try
        {
            var queryParams = new List<string>();

            if (_selectedSportSubcategoryIDValue.HasValue)
            {
                var subcategoryName = _sportSubcategories?.FirstOrDefault(s => s.ID == _selectedSportSubcategoryIDValue.Value)?.Subcategory;
                if (!string.IsNullOrEmpty(subcategoryName))
                    queryParams.Add($"subcategory={Uri.EscapeDataString(subcategoryName)}");
            }

            if (!string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
            {
                var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
                if (parts.Length == 2)
                {
                    queryParams.Add($"level={Uri.EscapeDataString(parts[0])}");
                    queryParams.Add($"gender={Uri.EscapeDataString(parts[1])}");
                }
            }

            if (_selectedEventStagesIDValue.HasValue)
            {
                var stageName = _eventStages?.FirstOrDefault(e => e.ID == _selectedEventStagesIDValue.Value)?.Stage;
                if (!string.IsNullOrEmpty(stageName))
                    queryParams.Add($"eventStage={Uri.EscapeDataString(stageName)}");
            }

            var queryString = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
            var events = await apiService.GetAsync<MartialArtsEventDTO>($"/MartialArtsScoring/events{queryString}");

            if (events != null && events.Any())
            {
                _regionPlayerMap.Clear();

                AllRegions = events
                    .Where(evt => !string.IsNullOrEmpty(evt.Abbreviation))
                    .GroupBy(evt => evt.Abbreviation)
                    .Select(group =>
                    {
                        var firstEvent = group.First();
                        var regionItem = new RegionItem
                            {
                                Id = firstEvent.RegionID,
                                Name = group.Key!,
                                AssignedMatch = "Unassigned",
                                PlayerName = firstEvent.PlayerName,
                                MatchPosition = "",
                                GameNo = 1
                            };

                        if (!string.IsNullOrEmpty(firstEvent.PlayerID))
                        {
                            _regionPlayerMap[firstEvent.RegionID] = (firstEvent.PlayerID, firstEvent.PlayerName);
                        }

                        return regionItem;
                    })
                    .ToList();

                SelectedEvent = events.First();

                _gameRegions.Clear();
                _gameMatches.Clear();
                _gameNextMatchId.Clear();
                _gameMatchSetResults.Clear();
                _gameMatchCurrentSets.Clear();
                MatchCards.Clear();

                var existingAssignments = await apiService.GetAsync<MartialArtsScoringDTO>($"/MartialArtsScoring/event/{SelectedEvent.ID}");
                if (existingAssignments != null && existingAssignments.Any())
                {
                    var allGameNos = existingAssignments.Select(a => a.GameNo).Distinct().ToList();
                    _availableGameNos = allGameNos.Any() ? allGameNos : new List<int> { 1 };
                    _availableGameNos.Sort();
                    _selectedGameNo = _availableGameNos.First();

                    foreach (var gameNo in _availableGameNos)
                    {
                        await InitializeGameFromDatabase(gameNo, existingAssignments);
                    }
                }
                else
                {
                    _availableGameNos = new List<int> { 1 };
                    _selectedGameNo = 1;
                    InitializeGame(1);
                }

                Snackbar.Add($"Found {events.Count} events with {AllRegions.Count} regions.", Severity.Success);
            }
            else
            {
                AllRegions = new List<RegionItem>();
                SelectedEvent = null;

                _gameRegions.Clear();
                _gameMatches.Clear();
                _gameNextMatchId.Clear();
                _gameMatchSetResults.Clear();
                _gameMatchCurrentSets.Clear();
                MatchCards.Clear();

                _availableGameNos = new List<int> { 1 };
                _selectedGameNo = 1;
                InitializeGame(1);

                Snackbar.Add("No Martial Arts events found with the selected filters", Severity.Warning);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error applying filters: {ex.Message}", Severity.Error);
            AllRegions = new List<RegionItem>();
        }
    }

    private async Task InitializeGameFromDatabase(int gameNo, IEnumerable<MartialArtsScoringDTO> existingAssignments)
    {
        InitializeGame(gameNo);

        var matchesForGame = existingAssignments
            .Where(a => a.GameNo == gameNo)
            .ToList();

        if (!matchesForGame.Any()) return;

        var matchIds = matchesForGame.Select(a => a.MatchId).Distinct().ToList();

        var highestMatchId = matchIds.Any() ? matchIds.Max() : 0;
        _gameNextMatchId[gameNo] = highestMatchId + 1;

        var existingMatchCards = MatchCards.Where(m => m.GameNo == gameNo).ToList();
        foreach (var match in existingMatchCards)
        {
            MatchCards.Remove(match);
        }
        _gameMatches[gameNo].Clear();

        foreach (var matchId in matchIds.OrderBy(id => id))
        {
            var matchCard = new MatchCard
                {
                    Id = matchId,
                    GameNo = gameNo
                };

            MatchCards.Add(matchCard);
            _gameMatches[gameNo].Add(matchId);
        }

        await LoadGameDataFromDatabase(gameNo, matchesForGame);
    }

    private async Task LoadGameDataFromDatabase(int gameNo, List<MartialArtsScoringDTO> assignmentsForGame)
    {
        if (AllRegions != null && _gameRegions.ContainsKey(gameNo))
        {
            _gameRegions[gameNo] = AllRegions.Select(r => new RegionItem
                {
                    Id = r.Id,
                    Name = r.Name,
                    AssignedMatch = "Unassigned",
                    PlayerName = r.PlayerName,
                    MatchPosition = "",
                    GameNo = gameNo
                }).ToList();
        }

        if (_gameMatchSetResults.ContainsKey(gameNo))
        {
            _gameMatchSetResults[gameNo].Clear();
        }

        if (_gameMatchCurrentSets.ContainsKey(gameNo))
        {
            _gameMatchCurrentSets[gameNo].Clear();
        }

        foreach (var assignment in assignmentsForGame)
        {
            var matchId = assignment.MatchId;
            var matchKey = $"Match{matchId}";

            if (!_gameMatchSetResults[gameNo].ContainsKey(matchKey))
            {
                _gameMatchSetResults[gameNo][matchKey] = new Dictionary<int, string>();
            }

            if (_gameRegions.ContainsKey(gameNo))
            {
                var regions = _gameRegions[gameNo];
                var region = regions.FirstOrDefault(r => r.Id == assignment.RegionID);
                if (region != null)
                {
                    region.AssignedMatch = $"Match{matchId}_{assignment.MatchPosition}";
                    region.MatchPosition = assignment.MatchPosition;

                    if (!string.IsNullOrEmpty(assignment.PlayerName))
                    {
                        region.PlayerName = assignment.PlayerName;
                    }
                }
            }

            if (!string.IsNullOrEmpty(assignment.Result) && assignment.Result == "W")
            {
                _gameMatchSetResults[gameNo][matchKey][assignment.SetNo] = assignment.MatchPosition;
            }

            if (!_gameMatchCurrentSets[gameNo].ContainsKey(matchKey) || assignment.SetNo >= _gameMatchCurrentSets[gameNo][matchKey])
            {
                _gameMatchCurrentSets[gameNo][matchKey] = assignment.SetNo + 1;
            }
        }
    }

    private async Task ClearFilters()
    {
        _selectedSportIDValue = null;
        _selectedSchoolLevelAndGenderID = null;
        _selectedMainCategoryValue = null;
        _selectedSportSubcategoryIDValue = null;
        _selectedEventStagesIDValue = null;
        SelectedEvent = null;
        AllRegions = new List<RegionItem>();
        _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        _combinedSchoolLevelAndGenderNames = new List<string>();
        _sportMainCat = new List<string>();

        _gameRegions.Clear();
        _gameMatches.Clear();
        _gameNextMatchId.Clear();
        _gameMatchSetResults.Clear();
        _gameMatchCurrentSets.Clear();
        _regionPlayerMap.Clear();
        MatchCards.Clear();

        _availableGameNos = new List<int> { 1 };
        _selectedGameNo = 1;
        InitializeGame(1);

        Snackbar.Add("Filters cleared", Severity.Info);
        StateHasChanged();
    }

    private List<MatchCard> GetMatchesForCurrentGame()
    {
        if (!_selectedGameNo.HasValue || !_gameMatches.ContainsKey(_selectedGameNo.Value))
            return new List<MatchCard>();

        var matchIds = _gameMatches[_selectedGameNo.Value];
        return MatchCards
            .Where(m => m.GameNo == _selectedGameNo.Value && matchIds.Contains(m.Id))
            .OrderBy(m => m.Id)
            .ToList();
    }

    private async Task LoadGameMatches(int? gameNo)
    {
        if (gameNo == _selectedGameNo || !gameNo.HasValue) return;

        _selectedGameNo = gameNo;

        if (!_availableGameNos.Contains(gameNo.Value))
        {
            _availableGameNos.Add(gameNo.Value);
            _availableGameNos.Sort();
        }

        if (!_gameRegions.ContainsKey(gameNo.Value))
        {
            InitializeGame(gameNo.Value);
        }

        if (SelectedEvent != null)
        {
            await LoadGameDataFromDatabase(gameNo.Value);
        }

        StateHasChanged();
    }

    private async Task LoadGameDataFromDatabase(int gameNo)
    {
        try
        {
            if (SelectedEvent == null) return;

            var existingAssignments = await apiService.GetAsync<MartialArtsScoringDTO>($"/MartialArtsScoring/event/{SelectedEvent.ID}");
            if (existingAssignments != null && existingAssignments.Any())
            {
                var assignmentsForGame = existingAssignments
                    .Where(a => a.GameNo == gameNo)
                    .ToList();

                await LoadGameDataFromDatabase(gameNo, assignmentsForGame);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading game data: {ex.Message}", Severity.Warning);
        }
    }

    private void AddNewGame()
    {
        var newGameNo = _availableGameNos.Any() ? _availableGameNos.Max() + 1 : 1;
        _availableGameNos.Add(newGameNo);
        _availableGameNos.Sort();
        _selectedGameNo = newGameNo;

        InitializeGame(newGameNo);

        Snackbar.Add($"Game {newGameNo} created with 3 matches", Severity.Success);
        StateHasChanged();
    }

    private void AddMatchCard()
    {
        if (!_selectedGameNo.HasValue) return;

        AddMatchToGame(_selectedGameNo.Value);
        StateHasChanged();
    }

    private void RemoveGame(int gameNo)
    {
        if (_availableGameNos.Count <= 1)
        {
            Snackbar.Add("Cannot delete the only game", Severity.Warning);
            return;
        }

        var otherGame = _availableGameNos.First(g => g != gameNo);

        if (SelectedEvent != null)
        {
            _ = Task.Run(async () =>
            {
                await apiService.DeleteAsync($"/MartialArtsScoring/game/{gameNo}");
            });
        }

        var matchesToRemove = MatchCards
            .Where(m => m.GameNo == gameNo)
            .ToList();

        foreach (var match in matchesToRemove)
        {
            MatchCards.Remove(match);
        }

        _gameRegions.Remove(gameNo);
        _gameMatches.Remove(gameNo);
        _gameNextMatchId.Remove(gameNo);
        _gameMatchSetResults.Remove(gameNo);
        _gameMatchCurrentSets.Remove(gameNo);

        _availableGameNos.Remove(gameNo);

        _selectedGameNo = otherGame;

        Snackbar.Add($"Game {gameNo} removed", Severity.Info);
        StateHasChanged();
    }

    private void RemoveMatchCard(int matchId)
    {
        if (!_selectedGameNo.HasValue) return;

        var matchCard = MatchCards.FirstOrDefault(m => m.Id == matchId && m.GameNo == _selectedGameNo);
        if (matchCard != null)
        {
            if (_gameRegions.ContainsKey(_selectedGameNo.Value))
            {
                var regions = _gameRegions[_selectedGameNo.Value];
                foreach (var region in regions)
                {
                    if (region.AssignedMatch.StartsWith($"Match{matchId}_"))
                    {
                        region.AssignedMatch = "Unassigned";
                        region.MatchPosition = "";
                    }
                }
            }

            if (_gameMatches.ContainsKey(_selectedGameNo.Value))
            {
                _gameMatches[_selectedGameNo.Value].Remove(matchId);
            }

            if (_gameMatchSetResults.ContainsKey(_selectedGameNo.Value))
            {
                var matchKey = $"Match{matchId}";
                _gameMatchSetResults[_selectedGameNo.Value].Remove(matchKey);
            }

            if (_gameMatchCurrentSets.ContainsKey(_selectedGameNo.Value))
            {
                var matchKey = $"Match{matchId}";
                _gameMatchCurrentSets[_selectedGameNo.Value].Remove(matchKey);
            }

            MatchCards.Remove(matchCard);

            Snackbar.Add($"Match {matchId} removed", Severity.Info);
            StateHasChanged();
        }
    }

    private bool SelectItemsForZone(RegionItem item, string dropzone)
    {
        return item.AssignedMatch == dropzone;
    }

    private async Task OnItemDropped(MudItemDropInfo<RegionItem> info)
    {
        if (info.DropzoneIdentifier == "Unassigned")
        {
            if (info.Item.AssignedMatch != "Unassigned")
            {
                info.Item.AssignedMatch = "Unassigned";
                info.Item.MatchPosition = "";
                Snackbar.Add($"{info.Item.Name} moved to unassigned", Severity.Info);
                await SaveRegionAssignment(info.Item, true);
                StateHasChanged();
            }
            return;
        }

        var parts = info.DropzoneIdentifier.Split('_');
        if (parts.Length == 2)
        {
            var matchId = int.Parse(parts[0].Replace("Match", ""));
            var position = parts[1];

            if (info.Item.AssignedMatch == info.DropzoneIdentifier)
                return;

            var regions = GetRegionsForCurrentGame();
            var existingRegion = regions.FirstOrDefault(r => r.AssignedMatch == info.DropzoneIdentifier);

            if (existingRegion != null && existingRegion.Id != info.Item.Id)
            {
                existingRegion.AssignedMatch = "Unassigned";
                existingRegion.MatchPosition = "";
                await SaveRegionAssignment(existingRegion, true);
            }

            if (info.Item.AssignedMatch != "Unassigned")
            {
                await SaveRegionAssignment(info.Item, true);
            }

            info.Item.AssignedMatch = info.DropzoneIdentifier;
            info.Item.MatchPosition = position;

            Snackbar.Add($"{info.Item.Name} assigned to {position} in Match {matchId}", Severity.Success);
            await SaveRegionAssignment(info.Item, false);
            StateHasChanged();
        }
    }

    private async Task SaveRegionAssignment(RegionItem region, bool isUnassign)
    {
        try
        {
            if (SelectedEvent == null || !_selectedGameNo.HasValue) return;

            if (isUnassign)
            {
                if (region.AssignedMatch != "Unassigned")
                {
                    var parts = region.AssignedMatch.Split('_');
                    if (parts.Length == 2)
                    {
                        var matchId = int.Parse(parts[0].Replace("Match", ""));
                        await apiService.DeleteAsync($"/MartialArtsScoring/region/{region.Id}/match/{matchId}");
                    }
                }
                return;
            }

            if (region.AssignedMatch != "Unassigned")
            {
                var parts = region.AssignedMatch.Split('_');
                if (parts.Length == 2)
                {
                    var matchId = int.Parse(parts[0].Replace("Match", ""));
                    var position = parts[1];
                    var gameNo = _selectedGameNo.Value;

                    string? playerId = null;
                    if (_regionPlayerMap.ContainsKey(region.Id))
                    {
                        playerId = _regionPlayerMap[region.Id].PlayerID;
                    }

                    var existingAssignments = await apiService.GetAsync<MartialArtsScoringDTO>($"/MartialArtsScoring/event/{SelectedEvent.ID}");
                    var existingAssignment = existingAssignments?.FirstOrDefault(a =>
                        a.RegionID == region.Id &&
                        a.MatchId == matchId &&
                        a.MatchPosition == position &&
                        a.GameNo == gameNo);

                    if (existingAssignment == null)
                    {
                        var createDto = new CreateMartialArtsScoringDTO
                            {
                                EventID = SelectedEvent.ID,
                                EventVersusID = null,
                                RegionID = region.Id,
                                GameNo = gameNo,
                                MatchId = matchId,
                                MatchPosition = position,
                                SetNo = 1,
                                Result = null,
                                PlayerID = playerId
                            };

                        await apiService.PostAsync<CreateMartialArtsScoringDTO, int>("/MartialArtsScoring", createDto);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving assignment: {ex.Message}", Severity.Error);
        }
    }

    private async Task AddSetToMatch(int matchId, string winningPosition)
    {
        try
        {
            if (!BothRegionsAssigned(matchId))
            {
                Snackbar.Add("Both regions must be assigned to record a set", Severity.Warning);
                return;
            }

            if (!_selectedGameNo.HasValue) return;

            var gameNo = _selectedGameNo.Value;
            var matchKey = $"Match{matchId}";
            var currentSet = GetCurrentSet(matchId);

            if (_gameMatchSetResults.ContainsKey(gameNo) &&
                _gameMatchSetResults[gameNo].ContainsKey(matchKey) &&
                _gameMatchSetResults[gameNo][matchKey].ContainsKey(currentSet))
            {
                Snackbar.Add($"Set {currentSet} already has a result", Severity.Warning);
                return;
            }

            if (!_gameMatchSetResults.ContainsKey(gameNo))
            {
                _gameMatchSetResults[gameNo] = new Dictionary<string, Dictionary<int, string>>();
            }

            if (!_gameMatchSetResults[gameNo].ContainsKey(matchKey))
            {
                _gameMatchSetResults[gameNo][matchKey] = new Dictionary<int, string>();
            }

            _gameMatchSetResults[gameNo][matchKey][currentSet] = winningPosition;

            var winningRegion = GetRegionAssignedToMatch(matchId, winningPosition);
            var losingPosition = winningPosition == "RegionA" ? "RegionB" : "RegionA";
            var losingRegion = GetRegionAssignedToMatch(matchId, losingPosition);

            if (winningRegion != null && losingRegion != null && SelectedEvent != null)
            {
                await SaveSetResult(winningRegion.Id, matchId, winningPosition, currentSet, "W");
                await SaveSetResult(losingRegion.Id, matchId, losingPosition, currentSet, "L");

                if (!_gameMatchCurrentSets.ContainsKey(gameNo))
                {
                    _gameMatchCurrentSets[gameNo] = new Dictionary<string, int>();
                }

                _gameMatchCurrentSets[gameNo][matchKey] = currentSet + 1;

                await LoadGameDataFromDatabase(gameNo);

                Snackbar.Add($"Set {currentSet}: {winningRegion.Name} wins!", Severity.Success);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error recording set: {ex.Message}", Severity.Error);
        }
    }

    private async Task RecordSetResult(int matchId, string winningPosition)
    {
        await AddSetToMatch(matchId, winningPosition);
    }

    private async Task SaveSetResult(int regionId, int matchId, string position, int setNo, string result)
    {
        try
        {
            if (SelectedEvent == null || !_selectedGameNo.HasValue) return;

            string? playerId = null;
            if (_regionPlayerMap.ContainsKey(regionId))
            {
                playerId = _regionPlayerMap[regionId].PlayerID;
            }

            var existingRecords = await apiService.GetAsync<MartialArtsScoringDTO>($"/MartialArtsScoring/event/{SelectedEvent.ID}");
            var existingRecord = existingRecords?.FirstOrDefault(r =>
                r.RegionID == regionId &&
                r.MatchId == matchId &&
                r.SetNo == setNo &&
                r.GameNo == _selectedGameNo.Value);

            if (existingRecord != null)
            {
                var updateDto = new UpdateMartialArtsScoringDTO
                    {
                        ID = existingRecord.ID,
                        MatchId = matchId,
                        MatchPosition = position,
                        SetNo = setNo,
                        Result = result,
                        PlayerID = playerId
                    };

                await apiService.PutAsync($"/MartialArtsScoring/{existingRecord.ID}", updateDto);
            }
            else
            {
                var placeholderRecord = existingRecords?.FirstOrDefault(r =>
                    r.RegionID == regionId &&
                    r.MatchId == matchId &&
                    r.MatchPosition == position &&
                    r.GameNo == _selectedGameNo.Value &&
                    string.IsNullOrEmpty(r.Result));

                if (placeholderRecord != null)
                {
                    var updateDto = new UpdateMartialArtsScoringDTO
                        {
                            ID = placeholderRecord.ID,
                            MatchId = matchId,
                            MatchPosition = position,
                            SetNo = setNo,
                            Result = result,
                            PlayerID = playerId
                        };

                    await apiService.PutAsync($"/MartialArtsScoring/{placeholderRecord.ID}", updateDto);
                }
                else
                {
                    var createDto = new CreateMartialArtsScoringDTO
                        {
                            EventID = SelectedEvent.ID,
                            EventVersusID = null,
                            RegionID = regionId,
                            GameNo = _selectedGameNo.Value,
                            MatchId = matchId,
                            MatchPosition = position,
                            SetNo = setNo,
                            Result = result,
                            PlayerID = playerId
                        };

                    await apiService.PostAsync<CreateMartialArtsScoringDTO, int>("/MartialArtsScoring", createDto);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving set result: {ex.Message}", Severity.Error);
        }
    }

    private async Task ClearSetResult(int matchId, int setNo)
    {
        try
        {
            if (!_selectedGameNo.HasValue) return;

            var gameNo = _selectedGameNo.Value;
            var matchKey = $"Match{matchId}";

            if (_gameMatchSetResults.ContainsKey(gameNo) &&
                _gameMatchSetResults[gameNo].ContainsKey(matchKey) &&
                _gameMatchSetResults[gameNo][matchKey].ContainsKey(setNo))
            {
                var winningPosition = _gameMatchSetResults[gameNo][matchKey][setNo];
                var winningRegion = GetRegionAssignedToMatch(matchId, winningPosition);

                if (winningRegion != null && SelectedEvent != null)
                {
                    await apiService.DeleteAsync($"/MartialArtsScoring/match/{matchId}/set/{setNo}");

                    _gameMatchSetResults[gameNo][matchKey].Remove(setNo);

                    if (_gameMatchCurrentSets.ContainsKey(gameNo) &&
                        _gameMatchCurrentSets[gameNo].ContainsKey(matchKey) &&
                        _gameMatchCurrentSets[gameNo][matchKey] > 1)
                    {
                        _gameMatchCurrentSets[gameNo][matchKey]--;
                    }

                    Snackbar.Add($"Set {setNo} result cleared", Severity.Info);
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error clearing set result: {ex.Message}", Severity.Error);
        }
    }

    private List<RegionStanding> GetRegionStandings()
    {
        var standings = new List<RegionStanding>();

        if (AllRegions == null || !AllRegions.Any())
            return standings;

        try
        {
            foreach (var region in AllRegions)
            {
                var standing = new RegionStanding
                    {
                        RegionName = region.Name,
                        RegionId = region.Id,
                        PlayerName = region.PlayerName,
                    };

                int matchesWon = 0;
                int matchesLost = 0;
                int setsWon = 0;
                int setsLost = 0;

                foreach (var gameNo in _availableGameNos)
                {
                    if (_gameRegions.ContainsKey(gameNo))
                    {
                        var gameRegion = _gameRegions[gameNo].FirstOrDefault(r => r.Id == region.Id);
                        if (gameRegion != null && gameRegion.AssignedMatch != "Unassigned")
                        {
                            var matchId = GetMatchIdFromAssignedMatch(gameRegion.AssignedMatch);
                            var matchKey = $"Match{matchId}";

                            if (_gameMatchSetResults.ContainsKey(gameNo) &&
                                _gameMatchSetResults[gameNo].ContainsKey(matchKey))
                            {
                                var position = gameRegion.MatchPosition;
                                var opponentPosition = position == "RegionA" ? "RegionB" : "RegionA";

                                var regionWins = _gameMatchSetResults[gameNo][matchKey].Count(kvp => kvp.Value == position);
                                var opponentWins = _gameMatchSetResults[gameNo][matchKey].Count(kvp => kvp.Value == opponentPosition);

                                setsWon += regionWins;
                                setsLost += opponentWins;

                                if (regionWins > opponentWins)
                                    matchesWon++;
                                else if (opponentWins > regionWins)
                                    matchesLost++;
                            }
                        }
                    }
                }

                standing.MatchesWon = matchesWon;
                standing.MatchesLost = matchesLost;
                standing.SetsWon = setsWon;
                standing.SetsLost = setsLost;
                standing.WinRate = (matchesWon + matchesLost) > 0 ?
                    (decimal)matchesWon / (matchesWon + matchesLost) : 0;

                standings.Add(standing);
            }

            return standings.OrderByDescending(s => s.MatchesWon)
                           .ThenByDescending(s => s.SetsWon)
                           .ThenBy(s => s.SetsLost)
                           .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error calculating standings: {ex.Message}", Severity.Error);
            return new List<RegionStanding>();
        }
    }

    private int GetMatchIdFromAssignedMatch(string assignedMatch)
    {
        if (assignedMatch.StartsWith("Match") && assignedMatch.Contains("_"))
        {
            var parts = assignedMatch.Split('_');
            var matchPart = parts[0];
            return int.Parse(matchPart.Replace("Match", ""));
        }
        return 0;
    }

    private async Task RefreshStandings()
    {
        try
        {
            if (SelectedEvent != null && _selectedGameNo.HasValue)
            {
                await LoadGameDataFromDatabase(_selectedGameNo.Value);
                StateHasChanged();
                Snackbar.Add("Standings refreshed", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing standings: {ex.Message}", Severity.Error);
        }
    }
}