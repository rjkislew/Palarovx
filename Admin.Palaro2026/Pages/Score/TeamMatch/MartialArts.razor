@page "/score/martialarts"
@inject ISnackbar Snackbar
@inject APIService apiService
@inject NavigationManager Navigation
@inject IDialogService DialogService


<PageTitle>Martial Arts Scoring | PALARO 2026</PageTitle>
<MudText Typo="Typo.h6" Align="Align.Center">Martial Arts Match (Sets/Rounds per Match)</MudText>

<!-- FILTERS SECTION -->
<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-4">Event Filters</MudText>
    <MudGrid Spacing="3" Justify="Justify.Center">
        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedSportIDValue" Margin="Margin.Dense" Label="Sport"
                       T="int?"
                       ShrinkLabel Variant="Variant.Outlined"
                       SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                  {
                                                      _selectedSchoolLevelAndGenderID = null;
                                                      _selectedSportSubcategoryIDValue = null;
                                                      _selectedMainCategoryValue = null;
                                                      await FilterSchoolLevelAndGenderAsync();
                                                  }))">
                <MudSelectItem T="int?" Value="2">Arnis</MudSelectItem>
                <MudSelectItem T="int?" Value="8">Boxing</MudSelectItem>
                <MudSelectItem T="int?" Value="18">Taekwondo</MudSelectItem>
                <MudSelectItem T="int?" Value="21">Wrestling</MudSelectItem>
                <MudSelectItem T="int?" Value="22">Wushu</MudSelectItem>
                <MudSelectItem T="int?" Value="23">Pencak Silat</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="_selectedSchoolLevelAndGenderID" Margin="Margin.Dense"
                       Label="School Level and Gender" T="string"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="_selectedSportIDValue == null"
                       SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                  {
                                                      _selectedSportSubcategoryIDValue = null;
                                                      _selectedMainCategoryValue = null;
                                                      await GetSportSubCategoriesSLGAsync();
                                                      LoadMainCategories();
                                                  }))">
                <MudVirtualize Items="_combinedSchoolLevelAndGenderNames" Context="combinedID">
                    <MudSelectItem T="string" Value="@combinedID">
                        @combinedID
                    </MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedMainCategoryValue" Margin="Margin.Dense"
                       Label="Event" T="string"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                @foreach (var mc in _sportMainCat)
                {
                    <MudSelectItem Value="@mc">@mc</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="_selectedSportSubcategoryIDValue" Margin="Margin.Dense"
                       Label="Category" T="int?"
                       HelperText="@((_sportSubcategories?.Any() != true && _selectedSchoolLevelAndGenderID != null) ? "No subcategory available for this gender or school level." : null)"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                <MudVirtualize Items="@GetFilteredSubcategories()" Context="subCategory">
                    <MudSelectItem T="int?" Value="@subCategory.ID">@subCategory.Subcategory</MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedEventStagesIDValue" Margin="Margin.Dense"
                       Label="Stage" T="int?"
                       ShrinkLabel Variant="Variant.Outlined" Clearable>
                <MudVirtualize Items="_eventStages" Context="eventStage">
                    <MudSelectItem T="int?" Value="eventStage.ID">@eventStage.Stage</MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-3" Justify="Justify.Center">
        <MudItem xs="12" sm="4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="ApplyFilters" FullWidth StartIcon="@Icons.Material.Filled.Search">
                Apply Filters
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                       OnClick="ClearFilters" FullWidth StartIcon="@Icons.Material.Filled.Clear">
                Clear Filters
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<!-- SELECTED EVENT INFO -->
@if (SelectedEvent != null)
{
    <MudPaper Class="pa-3 mb-4" Elevation="1" Style="background-color: #e3f2fd;">
        <MudGrid Spacing="3">
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.body2"><strong>Event:</strong> @SelectedEvent.Sport - @SelectedEvent.Subcategory</MudText>
            </MudItem>
            <MudItem xs="12" sm="5">
                <MudText Typo="Typo.body2"><strong>Level and Gender:</strong> @SelectedEvent.Level - @SelectedEvent.Gender</MudText>
            </MudItem>
            @* <MudItem xs="12" sm="3">
                <MudText Typo="Typo.body2"><strong>Level:</strong> @SelectedEvent.Level</MudText>
            </MudItem> *@
            <MudItem xs="12" sm="3">
                <MudText Typo="Typo.body2"><strong>Stage:</strong> @SelectedEvent.EventStage</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>
}

<!-- MATCH CARD -->
<MudGrid Spacing="3">
    <MudItem xs="12">
        @if (AllRegions == null)
        {
            <MudText Align="Align.Center" Class="ma-4">Please apply filters to see regions</MudText>
        }
        else if (!AllRegions.Any())
        {
            <MudText Align="Align.Center" Class="ma-4">No regions found. Please apply filters to see regions.</MudText>
        }
        else
        {
            <MudDropContainer T="RegionItem"
                              Items="GetRegionsForCurrentGame()"
                              ItemsSelector="SelectItemsForZone"
                              ItemDropped="OnItemDropped"
                              @key="@($"dropcontainer_{_selectedGameNo}")">

                <ChildContent>
                    <MudPaper Class="pa-2 mt-4 mb-6"
                              Elevation="3"
                              Style="position:sticky; top:0; z-index:1000; background-color:white;">

                        <MudGrid Class="my-2" Justify="Justify.Center" Spacing="4">
                            <MudItem xs="12" sm="3">
                                <MudSelect @bind-Value="_selectedGameNo"
                                           Label="Preview Game"
                                           T="int?"
                                           OnValueChanged="(value) => LoadGameMatches(value)">
                                    @foreach (var gameNo in _availableGameNos)
                                    {
                                        <MudSelectItem T="int?" Value="@gameNo">Game @gameNo</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12" sm="3">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Info"
                                           OnClick="AddNewGame"
                                           FullWidth>
                                    New Game
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                @if (_availableGameNos.Count > 1)
                                {
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Error"
                                               OnClick="@(() => RemoveGame(_selectedGameNo ?? 1))"
                                               FullWidth>
                                        Remove Current Game
                                    </MudButton>
                                }
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Success" OnClick="AddMatchCard" FullWidth>
                                    Add Match
                                </MudButton>
                            </MudItem>
                        </MudGrid>

                        <MudText Typo="Typo.subtitle1" Align="Align.Center">Regions - Total: @GetRegionsForCurrentGame().Count</MudText>
                        <MudDropZone T="RegionItem"
                                     Identifier="Unassigned"
                                     Class="d-flex flex-wrap justify-center pa-2"
                                     Style="min-height:100px; gap:6px; border:1px dashed gray;" />
                    </MudPaper>

                    <MudDivider Class="my-2" />
                    <MudGrid Class="" Style="align-items:center"
                             Spacing="4">

                        <!-- Left spacer -->
                        <MudItem xs="4" />

                        <!-- Center title -->
                        <MudItem xs="4">
                            <MudText Typo="Typo.h6" Align="Align.Center">
                                <MudText Typo="Typo.h6" Align="Align.Center">Match Cards - Game @_selectedGameNo</MudText>
                            </MudText>
                        </MudItem>

                        <!-- Right button -->
                        <MudItem xs="4">
                            <MudStack Row="true" Justify="Justify.FlexEnd">
                                <MudIconButton Icon="@Icons.Material.Filled.Settings"
                                               OnClick="@(() => OpenEditEventDialog(SelectedEvent?.ID))">
                                </MudIconButton>
                                <MudButton Color="Color.Tertiary" Variant="Variant.Filled"
                                           StartIcon="@Icons.Material.Filled.ArrowCircleRight"
                                           OnClick="ProceedToNextStage">
                                    Proceed to next stage
                                </MudButton>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                    <MudDivider Class="my-2" />

                    <MudGrid Spacing="3" Class="my-2" Justify="Justify.Center">
                        @foreach (var matchCard in GetMatchesForCurrentGame())
                        {
                            <MudItem xs="12" sm="6" md="4">
                                <MudPaper Elevation="2" Class="pa-3" Style="position:relative;">

                                    <MudIconButton Icon="@Icons.Material.Filled.Cancel"
                                                   Color="Color.Error"
                                                   Size="Size.Small"
                                                   Style="position:absolute; top:4px; right:4px;"
                                                   OnClick="@(() => RemoveMatchCard(matchCard.Id))"
                                                   Title="Remove match" />

                                    <MudText Typo="Typo.subtitle1" Align="Align.Center">
                                        Game @_selectedGameNo - Match @matchCard.Id
                                    </MudText>

                                    <MudDivider Class="my-2" />

                                    <!-- Current Set Display -->
                                    <MudGrid Class="mb-2" Justify="Justify.Center">
                                        <MudItem xs="12">
                                            <MudText Typo="Typo.body1" Color="Color.Primary" Class="font-weight-bold" Align="Align.Center">
                                                Round @GetCurrentSet(matchCard.Id)
                                            </MudText>
                                        </MudItem>
                                    </MudGrid>


                                    <MudGrid>

                                        <!-- Region A -->
                                        <MudItem xs="6">
                                            <MudStack Row="true" Style="align-items:center" Justify="Justify.Center" Spacing="1">
                                                <MudText Typo="Typo.body2">Red Side</MudText>
                                            </MudStack>

                                            <MudDropZone T="RegionItem"
                                                         Identifier="@($"Match{matchCard.Id}_RegionA")"
                                                         Class="pa-1 d-flex flex-wrap justify-center"
                                                         Style="min-height:60px; border:1px dashed gray;" />

                                            @if (GetRegionAssignedToMatch(matchCard.Id, "RegionA") != null)
                                            {
                                                <MudStack Row="true"
                                                          Spacing="1"
                                                          Class="mt-1 d-flex flex-row flex-wrap"
                                                          AlignItems="AlignItems.Center"
                                                          Justify="Justify.Center">

                                                    @foreach (var setResult in GetSetResults(matchCard.Id, "RegionA"))
                                                    {
                                                        <MudChip T="string"
                                                                 Size="Size.Small"
                                                                 Color="@(setResult == "W" ? Color.Success : Color.Error)"
                                                                 Variant="Variant.Filled">
                                                            @setResult
                                                        </MudChip>
                                                    }

                                                    @if (CanAddSet(matchCard.Id))
                                                    {
                                                        <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Small"
                                                                       OnClick="@(() => AddSetToMatch(matchCard.Id, "RegionA"))"
                                                                       Title="Add set win for Red Side" />
                                                    }

                                                </MudStack>
                                            }
                                        </MudItem>


                                        <!-- Region B -->
                                        <MudItem xs="6">
                                            <MudStack Row="true" Style="align-items:center" Justify="Justify.Center" Spacing="1">
                                                <MudText Typo="Typo.body2">Blue Side</MudText>
                                            </MudStack>

                                            <MudDropZone T="RegionItem"
                                                         Identifier="@($"Match{matchCard.Id}_RegionB")"
                                                         Class="pa-1 d-flex flex-wrap justify-center"
                                                         Style="min-height:60px; border:1px dashed gray;" />

                                            @if (GetRegionAssignedToMatch(matchCard.Id, "RegionB") != null)
                                            {
                                                <MudStack Row="true"
                                                          Spacing="1"
                                                          Class="mt-1 d-flex flex-row flex-wrap"
                                                          AlignItems="AlignItems.Center"
                                                          Justify="Justify.Center">

                                                    @foreach (var setResult in GetSetResults(matchCard.Id, "RegionB"))
                                                    {
                                                        <MudChip T="string"
                                                                 Size="Size.Small"
                                                                 Color="@(setResult == "W" ? Color.Success : Color.Error)"
                                                                 Variant="Variant.Filled">
                                                            @setResult
                                                        </MudChip>
                                                    }

                                                    @if (CanAddSet(matchCard.Id))
                                                    {
                                                        <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Small"
                                                                       OnClick="@(() => AddSetToMatch(matchCard.Id, "RegionB"))"
                                                                       Title="Add set win for Blue Side" />
                                                    }

                                                </MudStack>
                                            }
                                        </MudItem>
                                    </MudGrid>

                                    <!-- Set Result Buttons -->
                                    @if (BothRegionsAssigned(matchCard.Id))
                                    {
                                        <MudGrid Class="mt-2">
                                            <MudItem xs="6">
                                                <MudButton Variant="Variant.Outlined"
                                                           Color="Color.Success"
                                                           FullWidth
                                                           Size="Size.Small"
                                                           OnClick="@(() => RecordSetResult(matchCard.Id, "RegionA"))"
                                                           Disabled="@(GetSetResult(matchCard.Id, GetCurrentSet(matchCard.Id)) != null)">
                                                    Red Side Wins Set @GetCurrentSet(matchCard.Id)
                                                </MudButton>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudButton Variant="Variant.Outlined"
                                                           Color="Color.Success"
                                                           FullWidth
                                                           Size="Size.Small"
                                                           OnClick="@(() => RecordSetResult(matchCard.Id, "RegionB"))"
                                                           Disabled="@(GetSetResult(matchCard.Id, GetCurrentSet(matchCard.Id)) != null)">
                                                    Blue Side Wins Set @GetCurrentSet(matchCard.Id)
                                                </MudButton>
                                            </MudItem>
                                        </MudGrid>

                                        @if (GetSetResult(matchCard.Id, GetCurrentSet(matchCard.Id)) != null)
                                        {
                                            <MudGrid Class="mt-1">
                                                <MudItem xs="12">
                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Error"
                                                               FullWidth
                                                               Size="Size.Small"
                                                               OnClick="@(() => ClearSetResult(matchCard.Id, GetCurrentSet(matchCard.Id)))">
                                                        Clear Set @GetCurrentSet(matchCard.Id) Result
                                                    </MudButton>
                                                </MudItem>
                                            </MudGrid>
                                        }
                                    }

                                    <!-- Match Summary -->
                                    @if (BothRegionsAssigned(matchCard.Id))
                                    {
                                        var regionA = GetRegionAssignedToMatch(matchCard.Id, "RegionA");
                                        var regionB = GetRegionAssignedToMatch(matchCard.Id, "RegionB");
                                        var matchWinner = GetMatchWinner(matchCard.Id);

                                        <MudPaper Class="pa-2 mt-3" Elevation="0" Style="background-color: #f5f5f5;">
                                            <MudText Typo="Typo.body2" Class="font-weight-bold" Align="Align.Center">
                                                Match Summary
                                            </MudText>
                                            <MudGrid Spacing="0">
                                                <MudItem xs="5">
                                                    <MudText Typo="Typo.body2"
                                                             Color="@(matchWinner == regionA?.Name ? Color.Success : Color.Default)">
                                                        @regionA?.Name
                                                    </MudText>
                                                </MudItem>
                                                <MudItem xs="2">
                                                    <MudText Typo="Typo.body2" Align="Align.Center">vs</MudText>
                                                </MudItem>
                                                <MudItem xs="5">
                                                    <MudText Typo="Typo.body2"
                                                             Color="@(matchWinner == regionB?.Name ? Color.Success : Color.Default)"
                                                             Align="Align.Right">
                                                        @regionB?.Name
                                                    </MudText>
                                                </MudItem>
                                            </MudGrid>
                                            @if (!string.IsNullOrEmpty(matchWinner))
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Success" Align="Align.Center">
                                                    Winner: @matchWinner
                                                </MudText>
                                            }
                                        </MudPaper>
                                    }
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                </ChildContent>

                <ItemRenderer Context="item">
                    <MudChip T="string"
                             Variant="Variant.Filled"
                             Color="@GetRegionChipColor(item)"
                             Class="ma-1 cursor-move"
                             Style="max-width: 130px; height: auto; min-height: 52px; padding: 8px 12px; display: flex; align-items: center;">
                        <MudStack Spacing="0" Style="line-height: 1.3; text-align: center; width: 100%;">
                            <MudText Typo="Typo.body2"
                                     Class="font-weight-bold"
                                     Style="font-size: 0.75rem; margin-bottom: 2px;">
                                @item.Name
                            </MudText>
                            @if (!string.IsNullOrEmpty(item.PlayerName))
                            {
                                <MudText Typo="Typo.caption"
                                         Style="font-size: 0.65rem; word-break: break-word; opacity: 0.9;">
                                    @item.PlayerName
                                </MudText>
                            }
                        </MudStack>
                    </MudChip>
                </ItemRenderer>
            </MudDropContainer>
        }
    </MudItem>

    <!-- STANDINGS VIEW -->
    <MudItem xs="12">
        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-3">
                Martial Arts Standings
            </MudText>

            <MudGrid Class="mb-3" Spacing="2" Justify="Justify.Center">
                <MudItem xs="12" lg="4">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="RefreshStandings"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               Size="Size.Small"
                               FullWidth>
                        Refresh Standings
                    </MudButton>
                </MudItem>
            </MudGrid>

            <!-- Region Standings -->
            <MudTable Items="@GetRegionStandings()" Hover="true" Dense="true" Class="mt-3">
                <HeaderContent>
                    @* <MudTh>Rank</MudTh> *@
                    <MudTh>Region</MudTh>
                    <MudTh>Player</MudTh>
                    <MudTh>Matches Won</MudTh>
                    <MudTh>Matches Lost</MudTh>
                    <MudTh>Sets Won</MudTh>
                    <MudTh>Sets Lost</MudTh>
                    <MudTh>Win Rate</MudTh>
                </HeaderContent>
                <RowTemplate>
                    @{
                        var standing = context;
                        // var rank = GetRegionStandings().IndexOf(standing) + 1;
                    }
                    @* <MudTd>@rank</MudTd> *@
                    <MudTd>
                        <MudText Typo="Typo.body2" Class="font-weight-bold">
                            @standing.RegionName
                        </MudText>
                    </MudTd>
                    <MudTd>@standing.PlayerName</MudTd>
                    <MudTd>
                        <MudText Color="Color.Success" Class="font-weight-bold">
                            @standing.MatchesWon
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudText Color="Color.Error" Class="font-weight-bold">
                            @standing.MatchesLost
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudText Color="Color.Success">
                            @standing.SetsWon
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudText Color="Color.Error">
                            @standing.SetsLost
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudText Color="@(standing.WinRate >= 0 ? Color.Success : Color.Error)" Class="font-weight-bold">
                            @standing.WinRate.ToString("P0")
                        </MudText>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>

            @if (!GetRegionStandings().Any())
            {
                <MudText Align="Align.Center" Color="Color.Secondary" Class="ma-4">
                    No standings data available. Start some matches to see standings.
                </MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private List<RegionItem>? AllRegions;
    private List<MatchCard> MatchCards = new();
    private int SelectedSet = 1;

    private int? _selectedSportIDValue;
    private string? _selectedSchoolLevelAndGenderID;
    private string? _selectedMainCategoryValue;
    private int? _selectedSportSubcategoryIDValue;
    private int? _selectedEventStagesIDValue;

    private string? _selectedEventId;
    private string? _storedSubcategoryName;
    private string? _storedStageName;
    private string? _storedLevelGender;
    private string? _storedMainCategory;

    private int? _selectedGameNo = 1;
    private List<int> _availableGameNos = new List<int> { 1 };

    private List<EventsDTO.EventStages>? _eventStages;
    private List<SportsDTO.SportGenderCategories>? _sportGenderCategories;
    private List<SchoolsDTO.SchoolLevels>? _schoolLevels;
    private List<SportsDTO.SportSubcategories>? _sportSubcategories;

    private List<string> _combinedSchoolLevelAndGenderNames = new();
    private List<string> _sportMainCat = new();

    private MartialArtsEventDTO? SelectedEvent;

    private Dictionary<int, List<RegionItem>> _gameRegions = new Dictionary<int, List<RegionItem>>();
    private Dictionary<int, Dictionary<string, Dictionary<int, string>>> _gameMatchSetResults = new Dictionary<int, Dictionary<string, Dictionary<int, string>>>();
    private Dictionary<int, Dictionary<string, int>> _gameMatchCurrentSets = new Dictionary<int, Dictionary<string, int>>();
    private Dictionary<int, List<int>> _gameMatches = new Dictionary<int, List<int>>();
    private Dictionary<int, int> _gameNextMatchId = new Dictionary<int, int>();

    private Dictionary<int, (string? PlayerID, string? PlayerName)> _regionPlayerMap = new();

    public class RegionItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string AssignedMatch { get; set; } = "Unassigned";
        public string? PlayerName { get; set; }
        public string? PlayerID { get; set; }
        public string MatchPosition { get; set; } = "";
        public int GameNo { get; set; } = 1;
    }

    public class MatchCard
    {
        public int Id { get; set; }
        public int GameNo { get; set; }
        public string RegionA { get; set; } = "";
        public string RegionB { get; set; } = "";
        public int CurrentSet { get; set; } = 1;
        public int MaxSet { get; set; } = 1;
    }

    public class RegionStanding
    {
        public string RegionName { get; set; } = "";
        public int RegionId { get; set; }
        public string? PlayerName { get; set; }
        public string? PlayerID { get; set; }
        public int MatchesWon { get; set; }
        public int MatchesLost { get; set; }
        public int SetsWon { get; set; }
        public int SetsLost { get; set; }
        public decimal WinRate { get; set; }
    }

    public class MartialArtsScoringDTO
    {
        public int ID { get; set; }
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int GameNo { get; set; }
        public int MatchId { get; set; }
        public string? MatchPosition { get; set; }
        public int SetNo { get; set; }
        public string? Result { get; set; }
        public DateTime? CreatedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class MartialArtsEventDTO
    {
        public string? ID { get; set; }
        public DateTime? Date { get; set; }
        public TimeSpan? Time { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class CreateMartialArtsScoringDTO
    {
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int GameNo { get; set; }
        public int MatchId { get; set; }
        public string? MatchPosition { get; set; }
        public int SetNo { get; set; }
        public string? Result { get; set; }
        public string? PlayerID { get; set; }
    }

    public class UpdateMartialArtsScoringDTO
    {
        public int ID { get; set; }
        public int GameNo { get; set; }
        public int MatchId { get; set; }
        public string? MatchPosition { get; set; }
        public int SetNo { get; set; }
        public string? Result { get; set; }
        public string? PlayerID { get; set; }
    }

    public class EventsDTO
    {
        public class EventStages
        {
            public int ID { get; set; }
            public string? Stage { get; set; }
        }

        public class EventDetails
        {
            public string ID { get; set; } = null!;
            public int? EventStageID { get; set; }
            public string? EventStage { get; set; }
            public List<EventVersusTeams>? EventVersusList { get; set; }
            public string? SportMainCat { get; set; }
            public string? Category { get; set; }
            public string? Sport { get; set; }
            public int? SubCategoryID { get; set; }
            public string? Subcategory { get; set; }
            public string? Gender { get; set; }
            public string? Level { get; set; }
            public int? EventVenuesID { get; set; }
            public string? Venue { get; set; }
            public decimal? Latitude { get; set; }
            public decimal? Longitude { get; set; }
            public bool? IsFinished { get; set; }
            public int? BracketID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }

        public class EventVersusTeams
        {
            public int ID { get; set; }
            public string? EventID { get; set; }
            public int? SchoolRegionID { get; set; }
            public string? Score { get; set; }
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
            public List<EventVersusTeamPlayers>? EventVersusTeamPlayersList { get; set; }
            public string? Rank { get; set; }
            public DateTime? RecentUpdateAt { get; set; }
        }

        public class EventVersusTeamPlayers
        {
            public int ID { get; set; }
            public int? EventVersusID { get; set; }
            public string? ProfilePlayerID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
            public string? School { get; set; }
        }
    }

    public class ProfilesDTO
    {
        public class ProfilePlayer
        {
            public string? ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }
    }

    public class SportsDTO
    {
        public class SportSubcategories
        {
            public int ID { get; set; }
            public string? Subcategory { get; set; }
            public int? SportID { get; set; }
            public int? SportGenderCategoryID { get; set; }
            public int? SchoolLevelID { get; set; }
            public string? MainCategory { get; set; }
        }

        public class SportGenderCategories
        {
            public int ID { get; set; }
            public string? Gender { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class SchoolLevels
        {
            public int ID { get; set; }
            public string? Level { get; set; }
        }
    }

    public class ProgressionDTO
    {
        public class ProgressionTeamSelection
        {
            public int? SelectedRegionID { get; set; }
            public List<string> SelectedPlayerIDs { get; set; } = new();
            public List<ProfilePlayerDTO> AvailablePlayers { get; set; } = new();
            public int ExistingVersusTeamID { get; set; }
            public string? Score { get; set; }
            public string? Rank { get; set; }
        }

        public class ProfilePlayerDTO
        {
            public string? ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }
    }

    public class WinnerResponse
    {
        public int ID { get; set; }
        public int? SchoolRegionID { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Score { get; set; }
        public string? Rank { get; set; }
        public List<PlayerResponse> Players { get; set; } = new();
    }

    public class PlayerResponse
    {
        public string? ProfilePlayerID { get; set; }
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // Parse query parameters
        await ParseQueryParameters();

        // If eventId is provided, auto-fill filters
        if (!string.IsNullOrEmpty(_selectedEventId))
        {
            await LoadEventAndAutoFillFilters();
        }
        else
        {
            // Original initialization
            await LoadAvailableOptions();
            await FilterSchoolLevelAndGenderAsync();

            // Initialize game
            InitializeGame(1);
            _availableGameNos = new List<int> { 1 };
            _selectedGameNo = 1;
        }
    }

    private List<RegionItem> GetRegionsForCurrentGame()
    {
        if (!_selectedGameNo.HasValue) return new List<RegionItem>();

        if (_gameRegions.ContainsKey(_selectedGameNo.Value))
        {
            return _gameRegions[_selectedGameNo.Value];
        }

        return new List<RegionItem>();
    }

    private void InitializeGame(int gameNo)
    {
        if (AllRegions != null && !_gameRegions.ContainsKey(gameNo))
        {
            _gameRegions[gameNo] = AllRegions.Select(r => new RegionItem
                {
                    Id = r.Id,
                    Name = r.Name,
                    AssignedMatch = "Unassigned",
                    PlayerName = r.PlayerName,
                    PlayerID = r.PlayerID, // Copy PlayerID
                    MatchPosition = "",
                    GameNo = gameNo
                }).ToList();
        }

        if (!_gameMatches.ContainsKey(gameNo))
        {
            _gameMatches[gameNo] = new List<int>();
        }

        if (!_gameNextMatchId.ContainsKey(gameNo))
        {
            _gameNextMatchId[gameNo] = 1;
        }

        if (!_gameMatchSetResults.ContainsKey(gameNo))
        {
            _gameMatchSetResults[gameNo] = new Dictionary<string, Dictionary<int, string>>();
        }

        if (!_gameMatchCurrentSets.ContainsKey(gameNo))
        {
            _gameMatchCurrentSets[gameNo] = new Dictionary<string, int>();
        }

        for (int i = 0; i < 3; i++)
        {
            AddMatchToGame(gameNo);
        }
    }

    private void AddMatchToGame(int gameNo)
    {
        if (!_gameMatches.ContainsKey(gameNo))
        {
            _gameMatches[gameNo] = new List<int>();
        }

        if (!_gameNextMatchId.ContainsKey(gameNo))
        {
            _gameNextMatchId[gameNo] = 1;
        }

        var matchId = _gameNextMatchId[gameNo]++;

        var matchCard = new MatchCard
            {
                Id = matchId,
                GameNo = gameNo
            };

        MatchCards.Add(matchCard);
        _gameMatches[gameNo].Add(matchId);
    }

    private Color GetRegionChipColor(RegionItem region)
    {
        if (region.AssignedMatch != "Unassigned")
            return Color.Secondary;

        return Color.Primary;
    }

    private RegionItem? GetRegionAssignedToMatch(int matchId, string position)
    {
        if (!_selectedGameNo.HasValue) return null;

        var regions = GetRegionsForCurrentGame();

        // Look for region assigned to this specific match position
        return regions?.FirstOrDefault(r =>
            r.AssignedMatch == $"Match{matchId}_{position}" &&
            r.MatchPosition == position);
    }

    private List<string> GetSetResults(int matchId, string position)
    {
        var results = new List<string>();

        if (!_selectedGameNo.HasValue) return results;

        var matchKey = $"Match{matchId}";

        if (_gameMatchSetResults.ContainsKey(_selectedGameNo.Value) &&
            _gameMatchSetResults[_selectedGameNo.Value].ContainsKey(matchKey))
        {
            var region = GetRegionAssignedToMatch(matchId, position);
            if (region != null)
            {
                foreach (var kvp in _gameMatchSetResults[_selectedGameNo.Value][matchKey])
                {
                    var winnerRegion = GetWinnerForSet(matchId, kvp.Key);
                    if (winnerRegion == region.Name)
                        results.Add("W");
                    else if (!string.IsNullOrEmpty(winnerRegion) && winnerRegion != region.Name)
                        results.Add("L");
                }
            }
        }

        return results;
    }

    private string? GetWinnerForSet(int matchId, int setNo)
    {
        if (!_selectedGameNo.HasValue) return null;

        var matchKey = $"Match{matchId}";

        if (_gameMatchSetResults.ContainsKey(_selectedGameNo.Value) &&
            _gameMatchSetResults[_selectedGameNo.Value].ContainsKey(matchKey) &&
            _gameMatchSetResults[_selectedGameNo.Value][matchKey].ContainsKey(setNo))
        {
            var winningPosition = _gameMatchSetResults[_selectedGameNo.Value][matchKey][setNo];
            var region = GetRegionAssignedToMatch(matchId, winningPosition);
            return region?.Name;
        }
        return null;
    }

    private string? GetSetResult(int matchId, int setNo)
    {
        if (!_selectedGameNo.HasValue) return null;

        var matchKey = $"Match{matchId}";

        if (_gameMatchSetResults.ContainsKey(_selectedGameNo.Value) &&
            _gameMatchSetResults[_selectedGameNo.Value].ContainsKey(matchKey) &&
            _gameMatchSetResults[_selectedGameNo.Value][matchKey].ContainsKey(setNo))
        {
            return _gameMatchSetResults[_selectedGameNo.Value][matchKey][setNo];
        }
        return null;
    }

    private bool CanAddSet(int matchId)
    {
        return BothRegionsAssigned(matchId);
    }

    private bool BothRegionsAssigned(int matchId)
    {
        var regionA = GetRegionAssignedToMatch(matchId, "RegionA");
        var regionB = GetRegionAssignedToMatch(matchId, "RegionB");
        return regionA != null && regionB != null;
    }

    private int GetCurrentSet(int matchId)
    {
        if (!_selectedGameNo.HasValue) return 1;

        var matchKey = $"Match{matchId}";

        if (_gameMatchCurrentSets.ContainsKey(_selectedGameNo.Value) &&
            _gameMatchCurrentSets[_selectedGameNo.Value].ContainsKey(matchKey))
        {
            return _gameMatchCurrentSets[_selectedGameNo.Value][matchKey];
        }
        return 1;
    }

    private string? GetMatchWinner(int matchId)
    {
        var regionA = GetRegionAssignedToMatch(matchId, "RegionA");
        var regionB = GetRegionAssignedToMatch(matchId, "RegionB");

        if (regionA == null || regionB == null) return null;

        if (!_selectedGameNo.HasValue) return null;

        var matchKey = $"Match{matchId}";

        if (!_gameMatchSetResults.ContainsKey(_selectedGameNo.Value) ||
            !_gameMatchSetResults[_selectedGameNo.Value].ContainsKey(matchKey))
            return null;

        var regionAWins = _gameMatchSetResults[_selectedGameNo.Value][matchKey].Count(kvp => kvp.Value == "RegionA");
        var regionBWins = _gameMatchSetResults[_selectedGameNo.Value][matchKey].Count(kvp => kvp.Value == "RegionB");

        if (regionAWins > regionBWins) return regionA.Name;
        if (regionBWins > regionAWins) return regionB.Name;
        return null;
    }

    private async Task LoadAvailableOptions()
    {
        try
        {
            await GetEventStagesAsync();
            await GetGenderCategoriesAsync();
            await GetSchoolLevelsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading options: {ex.Message}", Severity.Error);
        }
    }

    private async Task GetEventStagesAsync()
    {
        string url = "/Events/Stages";
        _eventStages = await apiService.GetAsync<EventsDTO.EventStages>(url);
    }

    private async Task GetGenderCategoriesAsync()
    {
        string url = "/Sports/GenderCategories";
        _sportGenderCategories = await apiService.GetAsync<SportsDTO.SportGenderCategories>(url);
    }

    private async Task GetSchoolLevelsAsync()
    {
        string url = "/Schools/Levels";
        _schoolLevels = await apiService.GetAsync<SchoolsDTO.SchoolLevels>(url);
    }

    private async Task GetSportSubCategoriesSLGAsync()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
            return;
        }

        var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
        var schoolLevelName = parts[0];
        var genderName = parts[1];

        var schoolLevelID = _schoolLevels?.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
        var genderID = _sportGenderCategories?.FirstOrDefault(x => x.Gender == genderName)?.ID;

        if (schoolLevelID != null && genderID != null && _selectedSportIDValue != null)
        {
            _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(
                $"/Sports/Subcategories?sportID={_selectedSportIDValue}&schoolLevelID={schoolLevelID}&sportGenderCategoryID={genderID}");
        }
        else
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        }
    }

    private List<SportsDTO.SportSubcategories> GetFilteredSubcategories()
    {
        if (_sportSubcategories == null) return new List<SportsDTO.SportSubcategories>();
        return !string.IsNullOrEmpty(_selectedMainCategoryValue)
            ? _sportSubcategories.Where(sc => sc.MainCategory == _selectedMainCategoryValue).ToList()
            : _sportSubcategories.Where(sc => string.IsNullOrEmpty(sc.MainCategory)).ToList();
    }

    private async Task FilterSchoolLevelAndGenderAsync()
    {
        if (_selectedSportIDValue == null)
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var subcats = await apiService.GetAsync<SportsDTO.SportSubcategories>($"/Sports/Subcategories?sportID={_selectedSportIDValue}");
        if (subcats == null || !subcats.Any())
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var schoolLevelIDs = subcats.Where(x => x.SchoolLevelID.HasValue).Select(x => x.SchoolLevelID.Value).Distinct();
        var genderIDs = subcats.Where(x => x.SportGenderCategoryID.HasValue).Select(x => x.SportGenderCategoryID.Value).Distinct();

        var schoolLevelNames = _schoolLevels?.Where(s => schoolLevelIDs.Contains(s.ID)).Select(s => s.Level) ?? new List<string>();
        var genderNames = _sportGenderCategories?.Where(g => genderIDs.Contains(g.ID)).Select(g => g.Gender) ?? new List<string>();

        _combinedSchoolLevelAndGenderNames = schoolLevelNames.SelectMany(s => genderNames, (s, g) => $"{s} - {g}").ToList();
    }

    private void LoadMainCategories()
    {
        _sportMainCat = _sportSubcategories?.Where(sc => !string.IsNullOrEmpty(sc.MainCategory))
            .Select(sc => sc.MainCategory!).Distinct().ToList() ?? new List<string>();
    }

    private async Task ApplyFilters()
    {
        try
        {
            var queryParams = new List<string>();

            if (_selectedSportSubcategoryIDValue.HasValue)
            {
                var subcategoryName = _sportSubcategories?.FirstOrDefault(s => s.ID == _selectedSportSubcategoryIDValue.Value)?.Subcategory;
                if (!string.IsNullOrEmpty(subcategoryName))
                    queryParams.Add($"subcategory={Uri.EscapeDataString(subcategoryName)}");
            }

            if (!string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
            {
                var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
                if (parts.Length == 2)
                {
                    queryParams.Add($"level={Uri.EscapeDataString(parts[0])}");
                    queryParams.Add($"gender={Uri.EscapeDataString(parts[1])}");
                }
            }

            if (_selectedEventStagesIDValue.HasValue)
            {
                var stageName = _eventStages?.FirstOrDefault(e => e.ID == _selectedEventStagesIDValue.Value)?.Stage;
                if (!string.IsNullOrEmpty(stageName))
                    queryParams.Add($"eventStage={Uri.EscapeDataString(stageName)}");
            }

            var queryString = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
            var events = await apiService.GetAsync<MartialArtsEventDTO>($"/MartialArtsScoring/events{queryString}");

            if (events != null && events.Any())
            {
                AllRegions = events
                    .Where(evt => !string.IsNullOrEmpty(evt.Abbreviation))
                    .Select(evt =>
                    {
                        var regionItem = new RegionItem
                            {
                                Id = evt.RegionID,
                                Name = evt.Abbreviation!,
                                AssignedMatch = "Unassigned",
                                PlayerName = evt.PlayerName,
                                PlayerID = evt.PlayerID, // Make sure this is set
                                MatchPosition = "",
                                GameNo = 1
                            };

                        return regionItem;
                    })
                    .ToList();

                SelectedEvent = events.First();

                _gameRegions.Clear();
                _gameMatches.Clear();
                _gameNextMatchId.Clear();
                _gameMatchSetResults.Clear();
                _gameMatchCurrentSets.Clear();
                MatchCards.Clear();

                var existingAssignments = await apiService.GetAsync<MartialArtsScoringDTO>($"/MartialArtsScoring/event/{SelectedEvent.ID}");
                if (existingAssignments != null && existingAssignments.Any())
                {
                    var allGameNos = existingAssignments.Select(a => a.GameNo).Distinct().ToList();
                    _availableGameNos = allGameNos.Any() ? allGameNos : new List<int> { 1 };
                    _availableGameNos.Sort();
                    _selectedGameNo = _availableGameNos.First();

                    foreach (var gameNo in _availableGameNos)
                    {
                        await InitializeGameFromDatabase(gameNo, existingAssignments);
                    }
                }
                else
                {
                    _availableGameNos = new List<int> { 1 };
                    _selectedGameNo = 1;
                    InitializeGame(1);
                }

                Snackbar.Add($"Found {events.Count} events with {AllRegions.Count} participants.", Severity.Success);
            }
            else
            {
                AllRegions = new List<RegionItem>();
                SelectedEvent = null;

                _gameRegions.Clear();
                _gameMatches.Clear();
                _gameNextMatchId.Clear();
                _gameMatchSetResults.Clear();
                _gameMatchCurrentSets.Clear();
                MatchCards.Clear();

                _availableGameNos = new List<int> { 1 };
                _selectedGameNo = 1;
                InitializeGame(1);

                Snackbar.Add("No Martial Arts events found with the selected filters", Severity.Warning);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error applying filters: {ex.Message}", Severity.Error);
            AllRegions = new List<RegionItem>();
        }
    }

    private async Task ParseQueryParameters()
    {
        try
        {
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

            // Get query parameters
            _selectedEventId = query["eventId"];

            // Store filter parameters for later use
            _storedLevelGender = query["levelGender"] ?? query["levelgender"];
            _storedMainCategory = query["mainCat"] ?? query["maincat"];
            _storedSubcategoryName = query["subcategory"] ?? query["subcate"];
            _storedStageName = query["stage"];
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error parsing query parameters: {ex.Message}", Severity.Warning);
        }
    }

    private async Task LoadEventAndAutoFillFilters()
    {
        try
        {
            // Load available options first
            await LoadAvailableOptions();
            await FilterSchoolLevelAndGenderAsync();

            // Get event details by ID - Use the correct API endpoint and DTO
            var eventDetails = await apiService.GetAsync<MartialArtsEventDTO>($"/Events/Details/{_selectedEventId}");

            if (eventDetails != null && eventDetails.Any())
            {
                // Get the first event from the list
                var eventDetail = eventDetails.FirstOrDefault();

                if (eventDetail != null)
                {
                    // Auto-fill sport based on event
                    _selectedSportIDValue = GetSportIdFromName(eventDetail.Sport);

                    // Auto-fill school level and gender
                    if (!string.IsNullOrEmpty(eventDetail.Level) && !string.IsNullOrEmpty(eventDetail.Gender))
                    {
                        _selectedSchoolLevelAndGenderID = $"{eventDetail.Level} - {eventDetail.Gender}";

                        // Load subcategories for this combination
                        await GetSportSubCategoriesSLGAsync();
                        LoadMainCategories();

                        // Auto-fill main category
                        if (!string.IsNullOrEmpty(eventDetail.SportMainCat))
                        {
                            _selectedMainCategoryValue = eventDetail.SportMainCat;
                        }

                        // Auto-fill subcategory
                        if (!string.IsNullOrEmpty(eventDetail.Subcategory) && _sportSubcategories != null)
                        {
                            var subcat = _sportSubcategories.FirstOrDefault(s =>
                                s.Subcategory != null && (
                                    s.Subcategory.Equals(eventDetail.Subcategory, StringComparison.OrdinalIgnoreCase) ||
                                    eventDetail.Subcategory.Contains(s.Subcategory, StringComparison.OrdinalIgnoreCase) ||
                                    s.Subcategory.Contains(eventDetail.Subcategory, StringComparison.OrdinalIgnoreCase)
                                ));

                            if (subcat != null)
                            {
                                _selectedSportSubcategoryIDValue = subcat.ID;
                            }
                            else
                            {
                                // Try to find by main category
                                subcat = _sportSubcategories.FirstOrDefault(s =>
                                    s.MainCategory == eventDetail.SportMainCat);
                                if (subcat != null)
                                {
                                    _selectedSportSubcategoryIDValue = subcat.ID;
                                }
                            }
                        }

                        // Auto-fill stage
                        if (!string.IsNullOrEmpty(eventDetail.EventStage) && _eventStages != null)
                        {
                            var stage = _eventStages.FirstOrDefault(e =>
                                e.Stage != null && e.Stage.Equals(eventDetail.EventStage, StringComparison.OrdinalIgnoreCase));
                            if (stage != null)
                            {
                                _selectedEventStagesIDValue = stage.ID;
                            }
                        }

                        // Apply filters automatically
                        await ApplyFilters();
                    }
                    else
                    {
                        Snackbar.Add("Event details are incomplete", Severity.Warning);
                    }
                }
                else
                {
                    Snackbar.Add("Event not found in the list", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("Event not found", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading event: {ex.Message}", Severity.Error);
            // Fall back to normal initialization
            await FilterSchoolLevelAndGenderAsync();
        }
    }

    private int? GetSportIdFromName(string? sportName)
    {
        if (string.IsNullOrEmpty(sportName)) return null;

        var sportMap = new Dictionary<string, int>
    {
        { "Arnis", 2 },
        { "Boxing", 8 },
        { "Taekwondo", 18 },
        { "Wrestling", 21 },
        { "Wushu", 22 },
        { "Pencak Silat", 23 }
    };

        return sportMap.TryGetValue(sportName, out var sportId) ? sportId : null;
    }

    private async Task InitializeGameFromDatabase(int gameNo, IEnumerable<MartialArtsScoringDTO> existingAssignments)
    {
        InitializeGame(gameNo);

        var matchesForGame = existingAssignments
            .Where(a => a.GameNo == gameNo)
            .ToList();

        if (!matchesForGame.Any()) return;

        // Get unique matches based on RegionID + PlayerID + MatchId
        var uniqueMatches = matchesForGame
            .Select(a => new { a.RegionID, a.PlayerID, a.MatchId })
            .Distinct()
            .Select(x => x.MatchId)
            .Distinct()
            .ToList();

        var highestMatchId = uniqueMatches.Any() ? uniqueMatches.Max() : 0;
        _gameNextMatchId[gameNo] = highestMatchId + 1;

        // Clear existing matches for this game
        var existingMatchCards = MatchCards.Where(m => m.GameNo == gameNo).ToList();
        foreach (var match in existingMatchCards)
        {
            MatchCards.Remove(match);
        }
        _gameMatches[gameNo].Clear();

        // Add matches
        foreach (var matchId in uniqueMatches.OrderBy(id => id))
        {
            var matchCard = new MatchCard
                {
                    Id = matchId,
                    GameNo = gameNo
                };

            MatchCards.Add(matchCard);
            _gameMatches[gameNo].Add(matchId);
        }

        await LoadGameDataFromDatabase(gameNo, matchesForGame);
    }

    private async Task LoadGameDataFromDatabase(int gameNo, List<MartialArtsScoringDTO> assignmentsForGame)
    {
        // Create a fresh region list for this game from AllRegions
        if (AllRegions != null)
        {
            // Filter AllRegions to only include regions that have assignments in this game
            var assignedRegionPlayerPairs = assignmentsForGame
                .Select(a => new { a.RegionID, a.PlayerID })
                .Distinct()
                .ToList();

            _gameRegions[gameNo] = AllRegions
                .Where(r => assignedRegionPlayerPairs.Any(p =>
                    p.RegionID == r.Id && p.PlayerID == r.PlayerID))
                .Select(r => new RegionItem
                    {
                        Id = r.Id,
                        Name = r.Name,
                        AssignedMatch = "Unassigned", // Start as unassigned
                        PlayerName = r.PlayerName,
                        PlayerID = r.PlayerID,
                        MatchPosition = "",
                        GameNo = gameNo
                    })
                .ToList();
        }

        if (!_gameMatchSetResults.ContainsKey(gameNo))
            _gameMatchSetResults[gameNo] = new Dictionary<string, Dictionary<int, string>>();

        if (!_gameMatchCurrentSets.ContainsKey(gameNo))
            _gameMatchCurrentSets[gameNo] = new Dictionary<string, int>();

        // Group assignments by match
        var matchesGrouped = assignmentsForGame
            .GroupBy(a => a.MatchId)
            .ToList();

        foreach (var matchGroup in matchesGrouped)
        {
            var matchId = matchGroup.Key;
            var matchKey = $"Match{matchId}";

            // Group by position within the match
            var positionsGrouped = matchGroup
                .GroupBy(a => a.MatchPosition)
                .ToList();

            foreach (var positionGroup in positionsGrouped)
            {
                var position = positionGroup.Key;

                // Get the specific assignment for this position
                var assignment = positionGroup.FirstOrDefault();
                if (assignment == null) continue;

                // Find the region in this game using BOTH RegionID and PlayerID
                var region = _gameRegions[gameNo].FirstOrDefault(r =>
                    r.Id == assignment.RegionID &&
                    r.PlayerID == assignment.PlayerID); // ADDED: Check PlayerID

                if (region != null)
                {
                    region.AssignedMatch = $"Match{matchId}_{position}";
                    region.MatchPosition = position;

                    // Update set results
                    var winningSets = positionGroup.Where(a => a.Result == "W");
                    foreach (var win in winningSets)
                    {
                        if (!_gameMatchSetResults[gameNo].ContainsKey(matchKey))
                            _gameMatchSetResults[gameNo][matchKey] = new Dictionary<int, string>();

                        _gameMatchSetResults[gameNo][matchKey][win.SetNo] = position;
                    }

                    // Update current set
                    var maxSet = positionGroup.Max(a => a.SetNo);
                    if (maxSet > 0)
                    {
                        _gameMatchCurrentSets[gameNo][matchKey] = maxSet + 1;
                    }
                }
            }
        }
    }

    private async Task ClearFilters()
    {
        _selectedSportIDValue = null;
        _selectedSchoolLevelAndGenderID = null;
        _selectedMainCategoryValue = null;
        _selectedSportSubcategoryIDValue = null;
        _selectedEventStagesIDValue = null;
        SelectedEvent = null;
        AllRegions = new List<RegionItem>();
        _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        _combinedSchoolLevelAndGenderNames = new List<string>();
        _sportMainCat = new List<string>();

        _gameRegions.Clear();
        _gameMatches.Clear();
        _gameNextMatchId.Clear();
        _gameMatchSetResults.Clear();
        _gameMatchCurrentSets.Clear();
        _regionPlayerMap.Clear();
        MatchCards.Clear();

        _availableGameNos = new List<int> { 1 };
        _selectedGameNo = 1;
        InitializeGame(1);

        Snackbar.Add("Filters cleared", Severity.Info);
        StateHasChanged();
    }

    private List<MatchCard> GetMatchesForCurrentGame()
    {
        if (!_selectedGameNo.HasValue || !_gameMatches.ContainsKey(_selectedGameNo.Value))
            return new List<MatchCard>();

        var matchIds = _gameMatches[_selectedGameNo.Value];
        return MatchCards
            .Where(m => m.GameNo == _selectedGameNo.Value && matchIds.Contains(m.Id))
            .OrderBy(m => m.Id)
            .ToList();
    }

    private async Task LoadGameMatches(int? gameNo)
    {
        if (gameNo == _selectedGameNo || !gameNo.HasValue) return;

        _selectedGameNo = gameNo;

        if (!_availableGameNos.Contains(gameNo.Value))
        {
            _availableGameNos.Add(gameNo.Value);
            _availableGameNos.Sort();
        }

        if (!_gameRegions.ContainsKey(gameNo.Value))
        {
            InitializeGame(gameNo.Value);
        }

        if (SelectedEvent != null)
        {
            await LoadGameDataFromDatabase(gameNo.Value);
        }

        StateHasChanged();
    }

    private async Task LoadGameDataFromDatabase(int gameNo)
    {
        try
        {
            if (SelectedEvent == null) return;

            var existingAssignments = await apiService.GetAsync<MartialArtsScoringDTO>($"/MartialArtsScoring/event/{SelectedEvent.ID}");
            if (existingAssignments != null && existingAssignments.Any())
            {
                var assignmentsForGame = existingAssignments
                    .Where(a => a.GameNo == gameNo)
                    .ToList();

                await LoadGameDataFromDatabase(gameNo, assignmentsForGame);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading game data: {ex.Message}", Severity.Warning);
        }
    }

    private void AddNewGame()
    {
        var newGameNo = _availableGameNos.Any() ? _availableGameNos.Max() + 1 : 1;
        _availableGameNos.Add(newGameNo);
        _availableGameNos.Sort();
        _selectedGameNo = newGameNo;

        InitializeGame(newGameNo);

        Snackbar.Add($"Game {newGameNo} created with 3 matches", Severity.Success);
        StateHasChanged();
    }

    private void AddMatchCard()
    {
        if (!_selectedGameNo.HasValue) return;

        AddMatchToGame(_selectedGameNo.Value);
        StateHasChanged();
    }

    private void RemoveGame(int gameNo)
    {
        if (_availableGameNos.Count <= 1)
        {
            Snackbar.Add("Cannot delete the only game", Severity.Warning);
            return;
        }

        var otherGame = _availableGameNos.First(g => g != gameNo);

        if (SelectedEvent != null)
        {
            _ = Task.Run(async () =>
            {
                await apiService.DeleteAsync($"/MartialArtsScoring/game/{gameNo}");
            });
        }

        var matchesToRemove = MatchCards
            .Where(m => m.GameNo == gameNo)
            .ToList();

        foreach (var match in matchesToRemove)
        {
            MatchCards.Remove(match);
        }

        _gameRegions.Remove(gameNo);
        _gameMatches.Remove(gameNo);
        _gameNextMatchId.Remove(gameNo);
        _gameMatchSetResults.Remove(gameNo);
        _gameMatchCurrentSets.Remove(gameNo);

        _availableGameNos.Remove(gameNo);

        _selectedGameNo = otherGame;

        Snackbar.Add($"Game {gameNo} removed", Severity.Info);
        StateHasChanged();
    }

    private void RemoveMatchCard(int matchId)
    {
        if (!_selectedGameNo.HasValue) return;

        var matchCard = MatchCards.FirstOrDefault(m => m.Id == matchId && m.GameNo == _selectedGameNo);
        if (matchCard != null)
        {
            if (_gameRegions.ContainsKey(_selectedGameNo.Value))
            {
                var regions = _gameRegions[_selectedGameNo.Value];
                foreach (var region in regions)
                {
                    if (region.AssignedMatch.StartsWith($"Match{matchId}_"))
                    {
                        region.AssignedMatch = "Unassigned";
                        region.MatchPosition = "";
                    }
                }
            }

            if (_gameMatches.ContainsKey(_selectedGameNo.Value))
            {
                _gameMatches[_selectedGameNo.Value].Remove(matchId);
            }

            if (_gameMatchSetResults.ContainsKey(_selectedGameNo.Value))
            {
                var matchKey = $"Match{matchId}";
                _gameMatchSetResults[_selectedGameNo.Value].Remove(matchKey);
            }

            if (_gameMatchCurrentSets.ContainsKey(_selectedGameNo.Value))
            {
                var matchKey = $"Match{matchId}";
                _gameMatchCurrentSets[_selectedGameNo.Value].Remove(matchKey);
            }

            MatchCards.Remove(matchCard);

            Snackbar.Add($"Match {matchId} removed", Severity.Info);
            StateHasChanged();
        }
    }

    private bool SelectItemsForZone(RegionItem item, string dropzone)
    {
        return item.AssignedMatch == dropzone;
    }

    private async Task OnItemDropped(MudItemDropInfo<RegionItem> info)
    {
        if (info.DropzoneIdentifier == "Unassigned")
        {
            if (info.Item.AssignedMatch != "Unassigned")
            {
                info.Item.AssignedMatch = "Unassigned";
                info.Item.MatchPosition = "";
                Snackbar.Add($"{info.Item.Name} moved to unassigned", Severity.Info);
                await SaveRegionAssignment(info.Item, true);
                StateHasChanged();
            }
            return;
        }

        var parts = info.DropzoneIdentifier.Split('_');
        if (parts.Length == 2)
        {
            var matchId = int.Parse(parts[0].Replace("Match", ""));
            var position = parts[1];

            if (info.Item.AssignedMatch == info.DropzoneIdentifier)
                return;

            var regions = GetRegionsForCurrentGame();
            var existingRegion = regions.FirstOrDefault(r => r.AssignedMatch == info.DropzoneIdentifier);

            if (existingRegion != null && existingRegion.Id != info.Item.Id)
            {
                existingRegion.AssignedMatch = "Unassigned";
                existingRegion.MatchPosition = "";
                await SaveRegionAssignment(existingRegion, true);
            }

            if (info.Item.AssignedMatch != "Unassigned")
            {
                await SaveRegionAssignment(info.Item, true);
            }

            info.Item.AssignedMatch = info.DropzoneIdentifier;
            info.Item.MatchPosition = position;

            Snackbar.Add($"{info.Item.Name} assigned to {position} in Match {matchId}", Severity.Success);
            await SaveRegionAssignment(info.Item, false);
            StateHasChanged();
        }
    }

    private async Task SaveRegionAssignment(RegionItem region, bool isUnassign)
    {
        try
        {
            if (SelectedEvent == null || !_selectedGameNo.HasValue) return;

            if (isUnassign)
            {
                if (region.AssignedMatch != "Unassigned")
                {
                    var parts = region.AssignedMatch.Split('_');
                    if (parts.Length == 2)
                    {
                        var matchId = int.Parse(parts[0].Replace("Match", ""));
                        var position = parts[1];

                        // Get PlayerID from the region
                        var playerId = region.PlayerID;

                        // We need to find the specific record to delete using BOTH RegionID and PlayerID
                        var existingRecords = await apiService.GetAsync<MartialArtsScoringDTO>($"/MartialArtsScoring/event/{SelectedEvent.ID}");
                        var recordsToDelete = existingRecords?.Where(r =>
                            r.RegionID == region.Id &&
                            r.MatchId == matchId &&
                            r.GameNo == _selectedGameNo.Value &&
                            r.PlayerID == playerId).ToList(); // ADDED: Filter by PlayerID

                        if (recordsToDelete != null)
                        {
                            foreach (var record in recordsToDelete)
                            {
                                await apiService.DeleteAsync($"/MartialArtsScoring/{record.ID}");
                            }
                        }
                    }
                }
                return;
            }

            if (region.AssignedMatch != "Unassigned")
            {
                var parts = region.AssignedMatch.Split('_');
                if (parts.Length == 2)
                {
                    var matchId = int.Parse(parts[0].Replace("Match", ""));
                    var position = parts[1];
                    var gameNo = _selectedGameNo.Value;
                    var playerId = region.PlayerID; // Get PlayerID from region

                    // When checking for existing assignment, include PlayerID
                    var existingAssignments = await apiService.GetAsync<MartialArtsScoringDTO>($"/MartialArtsScoring/event/{SelectedEvent.ID}");
                    var existingAssignment = existingAssignments?.FirstOrDefault(a =>
                        a.RegionID == region.Id &&
                        a.MatchId == matchId &&
                        a.MatchPosition == position &&
                        a.GameNo == gameNo &&
                        a.PlayerID == playerId); // ADDED: Check PlayerID

                    if (existingAssignment == null)
                    {
                        var createDto = new CreateMartialArtsScoringDTO
                            {
                                EventID = SelectedEvent.ID,
                                EventVersusID = null,
                                RegionID = region.Id,
                                GameNo = gameNo,
                                MatchId = matchId,
                                MatchPosition = position,
                                SetNo = 1,
                                Result = null,
                                PlayerID = playerId // Include PlayerID
                            };

                        await apiService.PostAsync<CreateMartialArtsScoringDTO, int>("/MartialArtsScoring", createDto);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving assignment: {ex.Message}", Severity.Error);
        }
    }

    private async Task AddSetToMatch(int matchId, string winningPosition)
    {
        try
        {
            if (!BothRegionsAssigned(matchId))
            {
                Snackbar.Add("Both regions must be assigned to record a set", Severity.Warning);
                return;
            }

            if (!_selectedGameNo.HasValue) return;

            var gameNo = _selectedGameNo.Value;
            var matchKey = $"Match{matchId}";
            var currentSet = GetCurrentSet(matchId);

            if (_gameMatchSetResults.ContainsKey(gameNo) &&
                _gameMatchSetResults[gameNo].ContainsKey(matchKey) &&
                _gameMatchSetResults[gameNo][matchKey].ContainsKey(currentSet))
            {
                Snackbar.Add($"Set {currentSet} already has a result", Severity.Warning);
                return;
            }

            if (!_gameMatchSetResults.ContainsKey(gameNo))
            {
                _gameMatchSetResults[gameNo] = new Dictionary<string, Dictionary<int, string>>();
            }

            if (!_gameMatchSetResults[gameNo].ContainsKey(matchKey))
            {
                _gameMatchSetResults[gameNo][matchKey] = new Dictionary<int, string>();
            }

            _gameMatchSetResults[gameNo][matchKey][currentSet] = winningPosition;

            // Get the actual regions assigned to this match position
            var winningRegion = GetRegionAssignedToMatch(matchId, winningPosition);
            var losingPosition = winningPosition == "RegionA" ? "RegionB" : "RegionA";
            var losingRegion = GetRegionAssignedToMatch(matchId, losingPosition);

            if (winningRegion != null && losingRegion != null && SelectedEvent != null)
            {
                // CRITICAL FIX: Get PlayerID from the actual region assigned to this match
                var winningPlayerId = winningRegion.PlayerID; // Directly from the assigned region
                var losingPlayerId = losingRegion.PlayerID;   // Directly from the assigned region

                // Save results with the correct PlayerID
                await SaveSetResult(winningRegion.Id, matchId, winningPosition, currentSet, "W", winningPlayerId);
                await SaveSetResult(losingRegion.Id, matchId, losingPosition, currentSet, "L", losingPlayerId);

                if (!_gameMatchCurrentSets.ContainsKey(gameNo))
                {
                    _gameMatchCurrentSets[gameNo] = new Dictionary<string, int>();
                }

                _gameMatchCurrentSets[gameNo][matchKey] = currentSet + 1;

                await LoadGameDataFromDatabase(gameNo);

                Snackbar.Add($"Set {currentSet}: {winningRegion.Name} wins!", Severity.Success);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error recording set: {ex.Message}", Severity.Error);
        }
    }

    private string? GetPlayerIdForRegion(int regionId, string regionName)
    {
        try
        {
            // First, check if this region is currently assigned to any match in this game
            if (_selectedGameNo.HasValue && _gameRegions.ContainsKey(_selectedGameNo.Value))
            {
                var gameRegions = _gameRegions[_selectedGameNo.Value];

                // Find the region that matches both ID and Name
                var region = gameRegions.FirstOrDefault(r =>
                    r.Id == regionId &&
                    r.Name == regionName &&
                    r.AssignedMatch != "Unassigned");

                if (region != null)
                {
                    return region.PlayerID;
                }
            }

            // Fallback: Get from AllRegions
            var fallbackRegion = AllRegions?.FirstOrDefault(r =>
                r.Id == regionId &&
                r.Name == regionName);

            return fallbackRegion?.PlayerID;
        }
        catch
        {
            return null;
        }
    }

    private async Task RecordSetResult(int matchId, string winningPosition)
    {
        await AddSetToMatch(matchId, winningPosition);
    }

    private async Task SaveSetResult(int regionId, int matchId, string position, int setNo, string result, string? playerId = null)
    {
        try
        {
            if (SelectedEvent == null || !_selectedGameNo.HasValue) return;

            var existingRecords = await apiService.GetAsync<MartialArtsScoringDTO>($"/MartialArtsScoring/event/{SelectedEvent.ID}");

            // FIX: First, try to find an existing record with NO result but matching all other criteria
            var placeholderRecord = existingRecords?.FirstOrDefault(r =>
                r.RegionID == regionId &&
                r.MatchId == matchId &&
                r.MatchPosition == position &&
                r.GameNo == _selectedGameNo.Value &&
                r.SetNo == setNo &&
                string.IsNullOrEmpty(r.Result) &&
                r.PlayerID == playerId);

            if (placeholderRecord != null)
            {
                // Update the placeholder with the result
                var updateDto = new UpdateMartialArtsScoringDTO
                    {
                        ID = placeholderRecord.ID,
                        MatchId = matchId,
                        MatchPosition = position,
                        SetNo = setNo,
                        Result = result,
                        PlayerID = playerId
                    };

                await apiService.PutAsync($"/MartialArtsScoring/{placeholderRecord.ID}", updateDto);
                return;
            }

            // If no placeholder, look for existing record with result
            var existingRecord = existingRecords?.FirstOrDefault(r =>
                r.RegionID == regionId &&
                r.MatchId == matchId &&
                r.SetNo == setNo &&
                r.GameNo == _selectedGameNo.Value &&
                r.PlayerID == playerId);

            if (existingRecord != null)
            {
                var updateDto = new UpdateMartialArtsScoringDTO
                    {
                        ID = existingRecord.ID,
                        MatchId = matchId,
                        MatchPosition = position,
                        SetNo = setNo,
                        Result = result,
                        PlayerID = playerId
                    };

                await apiService.PutAsync($"/MartialArtsScoring/{existingRecord.ID}", updateDto);
            }
            else
            {
                // Create new record
                var createDto = new CreateMartialArtsScoringDTO
                    {
                        EventID = SelectedEvent.ID,
                        EventVersusID = null,
                        RegionID = regionId,
                        GameNo = _selectedGameNo.Value,
                        MatchId = matchId,
                        MatchPosition = position,
                        SetNo = setNo,
                        Result = result,
                        PlayerID = playerId
                    };

                await apiService.PostAsync<CreateMartialArtsScoringDTO, int>("/MartialArtsScoring", createDto);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving set result: {ex.Message}", Severity.Error);
        }
    }

    private async Task ClearSetResult(int matchId, int setNo)
    {
        try
        {
            if (!_selectedGameNo.HasValue) return;

            var gameNo = _selectedGameNo.Value;
            var matchKey = $"Match{matchId}";

            if (_gameMatchSetResults.ContainsKey(gameNo) &&
                _gameMatchSetResults[gameNo].ContainsKey(matchKey) &&
                _gameMatchSetResults[gameNo][matchKey].ContainsKey(setNo))
            {
                var winningPosition = _gameMatchSetResults[gameNo][matchKey][setNo];
                var winningRegion = GetRegionAssignedToMatch(matchId, winningPosition);

                if (winningRegion != null && SelectedEvent != null)
                {
                    await apiService.DeleteAsync($"/MartialArtsScoring/match/{matchId}/set/{setNo}");

                    _gameMatchSetResults[gameNo][matchKey].Remove(setNo);

                    if (_gameMatchCurrentSets.ContainsKey(gameNo) &&
                        _gameMatchCurrentSets[gameNo].ContainsKey(matchKey) &&
                        _gameMatchCurrentSets[gameNo][matchKey] > 1)
                    {
                        _gameMatchCurrentSets[gameNo][matchKey]--;
                    }

                    Snackbar.Add($"Set {setNo} result cleared", Severity.Info);
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error clearing set result: {ex.Message}", Severity.Error);
        }
    }

    private List<RegionStanding> GetRegionStandings()
    {
        var standings = new List<RegionStanding>();

        if (AllRegions == null || !AllRegions.Any())
            return standings;

        try
        {
            // Group by Region + Player to show individual standings
            var playerGroups = AllRegions
                .Where(r => !string.IsNullOrEmpty(r.PlayerID))
                .GroupBy(r => new { r.Id, r.Name, r.PlayerID, r.PlayerName });

            foreach (var playerGroup in playerGroups)
            {
                var firstRegion = playerGroup.First();
                var regionName = firstRegion.Name;

                // Get the specific region from the group
                var region = AllRegions.FirstOrDefault(r =>
                    r.Id == firstRegion.Id &&
                    r.PlayerID == firstRegion.PlayerID);

                if (region == null) continue;

                var standing = new RegionStanding
                    {
                        RegionName = regionName,
                        RegionId = region.Id,
                        PlayerName = region.PlayerName ?? "No Player",
                        PlayerID = region.PlayerID
                    };

                int matchesWon = 0;
                int matchesLost = 0;
                int setsWon = 0;
                int setsLost = 0;

                // Check all games for this specific region-player combination
                foreach (var gameNo in _availableGameNos)
                {
                    if (_gameRegions.ContainsKey(gameNo))
                    {
                        // Find the specific region in this game (by ID AND PlayerID)
                        var gameRegion = _gameRegions[gameNo].FirstOrDefault(r =>
                            r.Id == region.Id &&
                            r.PlayerID == region.PlayerID);

                        if (gameRegion != null && gameRegion.AssignedMatch != "Unassigned")
                        {
                            var matchId = GetMatchIdFromAssignedMatch(gameRegion.AssignedMatch);
                            var matchKey = $"Match{matchId}";

                            if (_gameMatchSetResults.ContainsKey(gameNo) &&
                                _gameMatchSetResults[gameNo].ContainsKey(matchKey))
                            {
                                var position = gameRegion.MatchPosition;
                                var opponentPosition = position == "RegionA" ? "RegionB" : "RegionA";

                                var regionWins = _gameMatchSetResults[gameNo][matchKey]
                                    .Count(kvp => kvp.Value == position);
                                var opponentWins = _gameMatchSetResults[gameNo][matchKey]
                                    .Count(kvp => kvp.Value == opponentPosition);

                                setsWon += regionWins;
                                setsLost += opponentWins;

                                if (regionWins > opponentWins)
                                    matchesWon++;
                                else if (opponentWins > regionWins)
                                    matchesLost++;
                            }
                        }
                    }
                }

                standing.MatchesWon = matchesWon;
                standing.MatchesLost = matchesLost;
                standing.SetsWon = setsWon;
                standing.SetsLost = setsLost;
                standing.WinRate = (matchesWon + matchesLost) > 0 ?
                    (decimal)matchesWon / (matchesWon + matchesLost) : 0;

                standings.Add(standing);
            }

            return standings.OrderByDescending(s => s.MatchesWon)
                           .ThenByDescending(s => s.SetsWon)
                           .ThenBy(s => s.SetsLost)
                           .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error calculating standings: {ex.Message}", Severity.Error);
            return new List<RegionStanding>();
        }
    }

    private int GetMatchIdFromAssignedMatch(string assignedMatch)
    {
        if (assignedMatch.StartsWith("Match") && assignedMatch.Contains("_"))
        {
            var parts = assignedMatch.Split('_');
            var matchPart = parts[0];
            return int.Parse(matchPart.Replace("Match", ""));
        }
        return 0;
    }

    private async Task RefreshStandings()
    {
        try
        {
            if (SelectedEvent != null && _selectedGameNo.HasValue)
            {
                await LoadGameDataFromDatabase(_selectedGameNo.Value);
                StateHasChanged();
                Snackbar.Add("Standings refreshed", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing standings: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenEditEventDialog(string? selectedEventID)
    {
        var parameters = new DialogParameters<AddEditDialog>
        {
            { x => x.SelectedEventID, selectedEventID },
            { x => x.IsEditMode, true }
        };

        var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseOnEscapeKey = true,
                BackdropClick = false
            };

        var dialog = await DialogService.ShowAsync<AddEditDialog>("Edit Event", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            // 
        }
    }

    private async Task ProceedToNextStage()
    {
        try
        {
            // 1. Validate current event
            if (SelectedEvent == null)
            {
                Snackbar.Add("No event selected. Please apply filters first.", Severity.Warning);
                return;
            }

            // 2. Check if all matches in current stage are completed
            if (!AreAllMatchesCompleted())
            {
                Snackbar.Add("Please complete all matches in current stage before proceeding.", Severity.Warning);
                return;
            }

            // 3. Get current stage ID and next stage ID
            var currentStageId = await GetCurrentEventStageId();
            if (!currentStageId.HasValue)
            {
                Snackbar.Add("Could not determine current event stage.", Severity.Error);
                return;
            }

            var nextStageId = GetNextStageId(currentStageId.Value);
            if (nextStageId == 0)
            {
                Snackbar.Add("No next stage available for progression.", Severity.Warning);
                return;
            }

            // 4. Get the next stage name
            var nextStage = _eventStages?.FirstOrDefault(s => s.ID == nextStageId);
            if (nextStage == null)
            {
                Snackbar.Add($"Could not find stage with ID {nextStageId}", Severity.Error);
                return;
            }

            // 5. Get winners from completed matches using GetMatchWinner
            var progressionTeams = new List<Dictionary<string, object>>();

            // Get all matches for current game
            var matches = GetMatchesForCurrentGame();

            // Track unique winners to avoid duplicates
            var processedWinners = new HashSet<int>();

            foreach (var match in matches)
            {
                // Only process completed matches
                if (BothRegionsAssigned(match.Id))
                {
                    var matchWinnerName = GetMatchWinner(match.Id);

                    if (!string.IsNullOrEmpty(matchWinnerName))
                    {
                        // Get the winner region object
                        var regionA = GetRegionAssignedToMatch(match.Id, "RegionA");
                        var regionB = GetRegionAssignedToMatch(match.Id, "RegionB");
                        var winnerRegion = regionA?.Name == matchWinnerName ? regionA : regionB;

                        if (winnerRegion != null && !processedWinners.Contains(winnerRegion.Id))
                        {
                            processedWinners.Add(winnerRegion.Id);

                            // Get EventVersusTeams entry for this winner
                            var versusTeams = await apiService.GetAsync<EventsDTO.EventVersusTeams>(
                                $"/Events/VersusTeams?eventID={SelectedEvent.ID}");

                            var winnerTeam = versusTeams?.FirstOrDefault(t =>
                                t.SchoolRegionID == winnerRegion.Id);

                            if (winnerTeam != null)
                            {
                                // Get players for this team - check EventVersusTeamPlayersList
                                var teamPlayers = winnerTeam.EventVersusTeamPlayersList;
                                var selectedPlayerIds = new List<string>();
                                var playerNames = new List<string>();

                                if (teamPlayers != null && teamPlayers.Any())
                                {
                                    foreach (var player in teamPlayers)
                                    {
                                        if (!string.IsNullOrEmpty(player.ProfilePlayerID))
                                        {
                                            selectedPlayerIds.Add(player.ProfilePlayerID);

                                            // Build full name
                                            var fullName = "";
                                            if (!string.IsNullOrEmpty(player.FirstName) && !string.IsNullOrEmpty(player.LastName))
                                                fullName = $"{player.FirstName} {player.LastName}";
                                            else if (!string.IsNullOrEmpty(player.FirstName))
                                                fullName = player.FirstName;
                                            else if (!string.IsNullOrEmpty(player.LastName))
                                                fullName = player.LastName;
                                            else
                                                fullName = player.ProfilePlayerID;

                                            playerNames.Add(fullName);
                                        }
                                    }
                                }
                                else
                                {
                                    // If no team players found in the list, fetch them from API
                                    teamPlayers = await apiService.GetAsync<EventsDTO.EventVersusTeamPlayers>(
                                        $"/Events/VersusTeams/Players?eventVersusID={winnerTeam.ID}");

                                    if (teamPlayers != null && teamPlayers.Any())
                                    {
                                        foreach (var player in teamPlayers)
                                        {
                                            if (!string.IsNullOrEmpty(player.ProfilePlayerID))
                                            {
                                                selectedPlayerIds.Add(player.ProfilePlayerID);

                                                var fullName = "";
                                                if (!string.IsNullOrEmpty(player.FirstName) && !string.IsNullOrEmpty(player.LastName))
                                                    fullName = $"{player.FirstName} {player.LastName}";
                                                else if (!string.IsNullOrEmpty(player.FirstName))
                                                    fullName = player.FirstName;
                                                else if (!string.IsNullOrEmpty(player.LastName))
                                                    fullName = player.LastName;
                                                else
                                                    fullName = player.ProfilePlayerID;

                                                playerNames.Add(fullName);
                                            }
                                        }
                                    }
                                    else if (!string.IsNullOrEmpty(winnerRegion.PlayerID))
                                    {
                                        // Use the player from the region if no team players found
                                        selectedPlayerIds.Add(winnerRegion.PlayerID);
                                        playerNames.Add(winnerRegion.PlayerName ?? "Unknown Player");
                                    }
                                }

                                // Get match score for this winner
                                var matchScore = GetMatchScoreForRegion(winnerRegion.Id);

                                // Add to progression teams
                                var teamData = new Dictionary<string, object>
                                    {
                                        ["SelectedRegionID"] = winnerRegion.Id,
                                        ["ExistingVersusTeamID"] = winnerTeam.ID,
                                        ["Score"] = matchScore,
                                        ["Rank"] = "Winner",
                                        ["SelectedPlayerIDs"] = selectedPlayerIds,
                                        ["RegionName"] = winnerRegion.Name,
                                        ["PlayerName"] = string.Join(", ", playerNames)
                                    };

                                progressionTeams.Add(teamData);
                            }
                            else
                            {
                                // If no EventVersusTeams entry found, create a basic entry
                                var teamData = new Dictionary<string, object>
                                    {
                                        ["SelectedRegionID"] = winnerRegion.Id,
                                        ["ExistingVersusTeamID"] = 0, // Will be created in next stage
                                        ["Score"] = GetMatchScoreForRegion(winnerRegion.Id),
                                        ["Rank"] = "Winner",
                                        ["SelectedPlayerIDs"] = new List<string> { winnerRegion.PlayerID ?? "" },
                                        ["RegionName"] = winnerRegion.Name,
                                        ["PlayerName"] = winnerRegion.PlayerName ?? ""
                                    };

                                progressionTeams.Add(teamData);
                            }
                        }
                    }
                }
            }

            if (!progressionTeams.Any())
            {
                Snackbar.Add("No winners found in completed matches. Please complete matches first.", Severity.Warning);
                return;
            }

            // 6. Prepare dialog parameters for creating new event
            var parameters = new DialogParameters<AddEditDialog>
        {
            { x => x.IsProgressionMode, true },
            { x => x.PreviousEventID, SelectedEvent.ID },
            { x => x.ProgressionTeams, progressionTeams }
        };

            // 7. Open the dialog
            var options = new DialogOptions
                {
                    CloseButton = true,
                    MaxWidth = MaxWidth.Medium,
                    FullWidth = true,
                    CloseOnEscapeKey = true,
                    BackdropClick = false
                };

            var dialog = await DialogService.ShowAsync<AddEditDialog>("Create Next Stage Event", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled)
            {
                Snackbar.Add("Next stage event created successfully!", Severity.Success);

                // Optionally update winners in EventVersusTeams
                // await MarkWinnersInEventVersusTeams();

                // Refresh the current view
                await ApplyFilters();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error proceeding to next stage: {ex.Message}", Severity.Error);
        }
    }

    private bool AreAllMatchesCompleted()
    {
        if (!_selectedGameNo.HasValue) return false;

        var matchesForGame = GetMatchesForCurrentGame();

        // Check if we have any assigned matches
        bool hasAssignedMatches = false;

        foreach (var match in matchesForGame)
        {
            if (BothRegionsAssigned(match.Id))
            {
                hasAssignedMatches = true;
                var matchWinner = GetMatchWinner(match.Id);
                if (string.IsNullOrEmpty(matchWinner))
                {
                    return false; // Match not completed
                }
            }
        }

        return hasAssignedMatches; // Return true only if we have at least one assigned AND completed match
    }

    // private string GetMatchScoreForRegion(int regionId)
    // {
    //     if (!_selectedGameNo.HasValue) return "0-0";

    //     // Find matches where this region participated
    //     var matches = GetMatchesForCurrentGame();
    //     foreach (var match in matches)
    //     {
    //         var regionA = GetRegionAssignedToMatch(match.Id, "RegionA");
    //         var regionB = GetRegionAssignedToMatch(match.Id, "RegionB");

    //         if (regionA?.Id == regionId || regionB?.Id == regionId)
    //         {
    //             var matchKey = $"Match{match.Id}";
    //             if (_gameMatchSetResults.ContainsKey(_selectedGameNo.Value) &&
    //                 _gameMatchSetResults[_selectedGameNo.Value].ContainsKey(matchKey))
    //             {
    //                 var wins = _gameMatchSetResults[_selectedGameNo.Value][matchKey].Count(kvp =>
    //                     kvp.Value == (regionA?.Id == regionId ? "RegionA" : "RegionB"));
    //                 var losses = _gameMatchSetResults[_selectedGameNo.Value][matchKey].Count - wins;

    //                 return $"{wins}-{losses}";
    //             }
    //         }
    //     }

    //     return "0-0";
    // }
    private string GetMatchScoreForRegion(int? regionId)
    {
        if (!_selectedGameNo.HasValue || !regionId.HasValue) return "0-0";

        // Find matches where this region participated
        var matches = GetMatchesForCurrentGame();
        foreach (var match in matches)
        {
            var regionA = GetRegionAssignedToMatch(match.Id, "RegionA");
            var regionB = GetRegionAssignedToMatch(match.Id, "RegionB");

            if (regionA?.Id == regionId.Value || regionB?.Id == regionId.Value)
            {
                var matchKey = $"Match{match.Id}";
                if (_gameMatchSetResults.ContainsKey(_selectedGameNo.Value) &&
                    _gameMatchSetResults[_selectedGameNo.Value].ContainsKey(matchKey))
                {
                    var wins = _gameMatchSetResults[_selectedGameNo.Value][matchKey].Count(kvp =>
                        kvp.Value == (regionA?.Id == regionId.Value ? "RegionA" : "RegionB"));
                    var losses = _gameMatchSetResults[_selectedGameNo.Value][matchKey].Count - wins;

                    return $"{wins}-{losses}";
                }
            }
        }

        return "0-0";
    }

    private bool IsWinningRank(string rank)
    {
        if (string.IsNullOrEmpty(rank)) return false;

        var winningRanks = new List<string>
    {
        "Winner",
        "Gold",
        "1st",
        "First",
        "Champion",
        "1",
        "Advance",
        "Qualified",
        "W",
        "Win",
        "Advancing"
    };

        return winningRanks.Any(r =>
            rank.Equals(r, StringComparison.OrdinalIgnoreCase) ||
            rank.Contains(r, StringComparison.OrdinalIgnoreCase));
    }

    private int GetNextStageId(int currentStageId)
    {
        // Define your stage progression here
        // Example: 1=Elimination, 2=Quarter-finals, 3=Semi-finals, 4=Finals
        return currentStageId switch
        {
            1 => 2, // Elimination -> Quarter-finals
            2 => 3, // Quarter-finals -> Semi-finals
            3 => 4, // Semi-finals -> Finals
            4 => 4, // Finals (no next stage)
            _ => 0  // Unknown stage
        };
    }

    private async Task<int?> GetCurrentEventStageId()
    {
        if (SelectedEvent?.ID == null) return null;

        var eventUrl = $"/Events?id={SelectedEvent.ID}";
        var events = await apiService.GetAsync<EventsDTO.EventDetails>(eventUrl);

        if (events != null && events.Any())
        {
            return events.First().EventStageID;
        }

        return null;
    }
    private async Task MarkWinnersInEventVersusTeams()
    {
        try
        {
            if (SelectedEvent == null || !_selectedGameNo.HasValue) return;

            var matches = GetMatchesForCurrentGame();
            foreach (var match in matches)
            {
                if (BothRegionsAssigned(match.Id))
                {
                    var matchWinner = GetMatchWinner(match.Id);
                    if (!string.IsNullOrEmpty(matchWinner))
                    {
                        var regionA = GetRegionAssignedToMatch(match.Id, "RegionA");
                        var regionB = GetRegionAssignedToMatch(match.Id, "RegionB");

                        // Determine winner and loser
                        RegionItem winnerRegion, loserRegion;
                        if (regionA?.Name == matchWinner)
                        {
                            winnerRegion = regionA;
                            loserRegion = regionB;
                        }
                        else
                        {
                            winnerRegion = regionB;
                            loserRegion = regionA;
                        }

                        // Get EventVersusTeams
                        var versusTeams = await apiService.GetAsync<EventsDTO.EventVersusTeams>(
                            $"/Events/VersusTeams?eventID={SelectedEvent.ID}");

                        if (versusTeams != null)
                        {
                            // Update winner team - find by SchoolRegionID
                            var winnerTeam = versusTeams.FirstOrDefault(t =>
                                t.SchoolRegionID == winnerRegion.Id);
                            if (winnerTeam != null)
                            {
                                // Create update object
                                var updateWinner = new
                                {
                                    ID = winnerTeam.ID,
                                    Rank = "Winner",
                                    Score = GetMatchScoreForRegion(winnerRegion.Id)
                                };
                                await apiService.PutAsync($"/Events/VersusTeams/{winnerTeam.ID}", updateWinner);
                            }

                            // Update loser team
                            if (loserRegion != null)
                            {
                                var loserTeam = versusTeams.FirstOrDefault(t =>
                                    t.SchoolRegionID == loserRegion.Id);
                                if (loserTeam != null)
                                {
                                    var updateLoser = new
                                    {
                                        ID = loserTeam.ID,
                                        Rank = "Eliminated",
                                        Score = GetMatchScoreForRegion(loserRegion.Id)
                                    };
                                    await apiService.PutAsync($"/Events/VersusTeams/{loserTeam.ID}", updateLoser);
                                }
                            }
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error marking winners: {ex.Message}", Severity.Error);
        }
    }
}