@page "/score/billiards"
@inject ISnackbar Snackbar
@inject APIService apiService
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>Billiards Scoring | PALARO 2026</PageTitle>
<MudText Typo="Typo.h6" Align="Align.Center">Billiards Match</MudText>

<!-- FILTERS SECTION -->
<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-4">Event Filters</MudText>
    <MudGrid Spacing="3" Justify="Justify.Center">
        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedSportIDValue" Margin="Margin.Dense" Label="Sport"
                       T="int?"
                       ShrinkLabel Variant="Variant.Outlined"
                       SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                  {
                                                      _selectedSchoolLevelAndGenderID = null;
                                                      _selectedSportSubcategoryIDValue = null;
                                                      _selectedMainCategoryValue = null;
                                                      await FilterSchoolLevelAndGenderAsync();
                                                  }))">
                <MudSelectItem T="int?" Value="7">Billiards</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="_selectedSchoolLevelAndGenderID" Margin="Margin.Dense"
                       Label="School Level and Gender" T="string"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="_selectedSportIDValue == null"
                       SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                  {
                                                      _selectedSportSubcategoryIDValue = null;
                                                      _selectedMainCategoryValue = null;
                                                      await GetSportSubCategoriesSLGAsync();
                                                      LoadMainCategories();
                                                  }))">
                <MudVirtualize Items="_combinedSchoolLevelAndGenderNames" Context="combinedID">
                    <MudSelectItem T="string" Value="@combinedID">
                        @combinedID
                    </MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedMainCategoryValue" Margin="Margin.Dense"
                       Label="Event" T="string"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                @foreach (var mc in _sportMainCat)
                {
                    <MudSelectItem Value="@mc">@mc</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="_selectedSportSubcategoryIDValue" Margin="Margin.Dense"
                       Label="Category" T="int?"
                       HelperText="@((_sportSubcategories?.Any() != true && _selectedSchoolLevelAndGenderID != null) ? "No subcategory available for this gender or school level." : null)"
                       ShrinkLabel Variant="Variant.Outlined" Clearable
                       Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                <MudVirtualize Items="@GetFilteredSubcategories()" Context="subCategory">
                    <MudSelectItem T="int?" Value="@subCategory.ID">@subCategory.Subcategory</MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect @bind-Value="_selectedEventStagesIDValue" Margin="Margin.Dense"
                       Label="Stage" T="int?"
                       ShrinkLabel Variant="Variant.Outlined" Clearable>
                <MudVirtualize Items="_eventStages" Context="eventStage">
                    <MudSelectItem T="int?" Value="eventStage.ID">@eventStage.Stage</MudSelectItem>
                </MudVirtualize>
            </MudSelect>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-3" Justify="Justify.Center">
        <MudItem xs="12" sm="4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="ApplyFilters" FullWidth StartIcon="@Icons.Material.Filled.Search">
                Apply Filters
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                       OnClick="ClearFilters" FullWidth StartIcon="@Icons.Material.Filled.Clear">
                Clear Filters
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<!-- SELECTED EVENT INFO -->
@if (SelectedEvent != null)
{
    <MudPaper Class="pa-3 mb-4" Elevation="1" Style="background-color: #e3f2fd;">
        <MudGrid Spacing="3">
            <MudItem xs="12" sm="4">
                <MudText Typo="Typo.body2"><strong>Event:</strong> @SelectedEvent.Sport - @SelectedEvent.Subcategory</MudText>
            </MudItem>
            <MudItem xs="12" sm="5">
                <MudText Typo="Typo.body2"><strong>Level and Gender:</strong> @SelectedEvent.Level - @SelectedEvent.Gender</MudText>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudText Typo="Typo.body2"><strong>Stage:</strong> @SelectedEvent.EventStage</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>
}

<!-- MATCH CARD -->
<MudGrid Spacing="3">
    <MudItem xs="12">
        @if (Regions == null || !Regions.Any())
        {
            <MudText Align="Align.Center" Class="ma-4">No regions found. Please apply filters to see regions.</MudText>
        }
        else
        {
            <MudDropContainer T="RegionItem"
                              Items="Regions"
                              ItemsSelector="SelectItemsForZone"
                              ItemDropped="OnItemDropped"
                              @key="@($"dropcontainer_{SelectedSet}")">

                <ChildContent>
                    <MudPaper Class="pa-2 mt-4 mb-6"
                              Elevation="3"
                              Style="position:sticky; top:0; z-index:1000; background-color:white;">

                        <MudGrid Class="my-2" Justify="Justify.Center" Spacing="4">
                            <MudItem xs="12" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Success" OnClick="AddTable" FullWidth>
                                    Add Table
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="NextSet" FullWidth>
                                    Next Round
                                </MudButton>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudSelect T="int" Label="Preview Round" FullWidth
                                           Value="SelectedSet"
                                           ValueChanged="OnSetChanged">
                                    @foreach (var setNum in Enumerable.Range(1, AllSets.Count))
                                    {
                                        <MudSelectItem Value="@setNum">Round @setNum</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                        </MudGrid>

                        <MudText Typo="Typo.subtitle1" Align="Align.Center">
                            @if (SelectedSet == 1)
                            {
                                <span>All Regions (Round @SelectedSet) - Total: @Regions.Count</span>
                            }
                            else
                            {
                                <span>Winners from Round @(SelectedSet - 1) (Round @SelectedSet) - Total: @Regions.Count</span>
                            }
                        </MudText>

                        <MudDropZone T="RegionItem"
                                     Identifier="Unassigned"
                                     Class="d-flex flex-wrap justify-center pa-2"
                                     Style="min-height:100px; gap:6px; border:1px dashed gray;" />
                    </MudPaper>

                    <MudDivider Class="my-2" />

                    <MudGrid Class="" Style="align-items:center"
                             Spacing="4">

                        <!-- Left spacer -->
                        <MudItem xs="4" />

                        <!-- Center title -->
                        <MudItem xs="4">
                            <MudText Typo="Typo.h6" Align="Align.Center">
                                Match Tables
                            </MudText>
                        </MudItem>

                        <!-- Right button -->
                        <MudItem xs="4">
                            <MudStack Row="true" Justify="Justify.FlexEnd">
                                <MudIconButton Icon="@Icons.Material.Filled.Settings"
                                               OnClick="@(() => OpenEditEventDialog(SelectedEvent?.ID))">
                                </MudIconButton>
                                <MudButton Color="Color.Tertiary" Variant="Variant.Filled"
                                           StartIcon="@Icons.Material.Filled.ArrowCircleRight"
                                           OnClick="ProceedToNextStage">
                                    Proceed to next stage
                                </MudButton>
                            </MudStack>
                        </MudItem>

                    </MudGrid>



                    <MudDivider Class="my-2" />

                    <MudGrid Spacing="3" Class="my-2" Justify="Justify.Center">
                        @foreach (var table in Tables)
                        {
                            var player1Id = $"{SelectedSet}_{table}_Player1";
                            var player2Id = $"{SelectedSet}_{table}_Player2";
                            bool isLastTable = table == Tables.Last();

                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Elevation="2" Class="pa-3" Style="position:relative;">

                                    @if (isLastTable)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Cancel"
                                                       Color="Color.Error"
                                                       Size="Size.Small"
                                                       Style="position:absolute; top:4px; right:4px;"
                                                       OnClick="@(() => RemoveTable(table))"
                                                       Title="Remove last table" />
                                    }

                                    <MudText Typo="Typo.subtitle1" Align="Align.Center">@table</MudText>
                                    <MudDivider Class="my-2" />

                                    <MudGrid>
                                        <!-- Player 1 -->
                                        <MudItem xs="6">
                                            <MudStack Row="true" Style="align-items:center" Justify="Justify.Center" Spacing="1">
                                                <MudText Typo="Typo.body2">Player 1</MudText>

                                                @if (GetResultIndicator(table, "Player1") != null)
                                                {
                                                    <MudText Typo="Typo.body2"
                                                             Color="@GetResultColor(table, "Player1")"
                                                             Class="font-weight-bold">
                                                        @GetResultIndicator(table, "Player1")
                                                    </MudText>
                                                }
                                            </MudStack>

                                            <MudDropZone T="RegionItem"
                                                         Identifier="@player1Id"
                                                         Class="pa-1 d-flex flex-wrap justify-center"
                                                         Style="min-height:60px; border:1px dashed gray;" />
                                        </MudItem>

                                        <!-- Player 2 -->
                                        <MudItem xs="6">
                                            <MudStack Row="true" Style="align-items:center" Justify="Justify.Center" Spacing="1">
                                                <MudText Typo="Typo.body2">Player 2</MudText>

                                                @if (GetResultIndicator(table, "Player2") != null)
                                                {
                                                    <MudText Typo="Typo.body2"
                                                             Color="@GetResultColor(table, "Player2")"
                                                             Class="font-weight-bold">
                                                        @GetResultIndicator(table, "Player2")
                                                    </MudText>
                                                }
                                            </MudStack>

                                            <MudDropZone T="RegionItem"
                                                         Identifier="@player2Id"
                                                         Class="pa-1 d-flex flex-wrap justify-center"
                                                         Style="min-height:60px; border:1px dashed gray;" />
                                        </MudItem>
                                    </MudGrid>

                                    <!-- SCORE INPUT SECTION -->
                                    <MudGrid Class="mt-1">
                                        <!-- Player 1 Score Input -->
                                        <MudItem xs="6">
                                            <MudStack Style="text-align: center;">
                                                <MudText Typo="Typo.caption" Class="mb-1" Align="Align.Center">Player 1 Score</MudText>
                                                <MudStack Row="true" Justify="Justify.Center" Spacing="2">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Remove"
                                                                   Size="Size.Small"
                                                                   OnClick="@(() => AdjustScore(table, "Player1", -1))"
                                                                   Disabled="@(GetPlayerScore(table, "Player1") <= 0 || IsMatchCompleted(table))" />

                                                    @{
                                                        var player1ScoreStr = GetPlayerScore(table, "Player1").ToString();
                                                    }
                                                    <MudText Typo="Typo.body2" Align="Align.Center">
                                                        @player1ScoreStr
                                                    </MudText>

                                                    <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                                   Size="Size.Small"
                                                                   OnClick="@(() => AdjustScore(table, "Player1", 1))"
                                                                   Disabled="@IsMatchCompleted(table)" />
                                                </MudStack>
                                            </MudStack>
                                        </MudItem>

                                        <!-- Player 2 Score Input -->
                                        <MudItem xs="6">
                                            <MudStack Style="text-align: center;">
                                                <MudText Typo="Typo.caption" Class="mb-1" Align="Align.Center">Player 2 Score</MudText>
                                                <MudStack Row="true" Justify="Justify.Center" Spacing="2">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Remove"
                                                                   Size="Size.Small"
                                                                   OnClick="@(() => AdjustScore(table, "Player2", -1))"
                                                                   Disabled="@(GetPlayerScore(table, "Player2") <= 0 || IsMatchCompleted(table))" />

                                                    @{
                                                        var player2ScoreStr = GetPlayerScore(table, "Player2").ToString();
                                                    }
                                                    <MudText Typo="Typo.body2" Align="Align.Center">
                                                        @player2ScoreStr
                                                    </MudText>

                                                    <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                                   Size="Size.Small"
                                                                   OnClick="@(() => AdjustScore(table, "Player2", 1))"
                                                                   Disabled="@IsMatchCompleted(table)" />
                                                </MudStack>
                                            </MudStack>
                                        </MudItem>
                                    </MudGrid>

                                    <!-- MATCH STATUS AND CONTROLS -->
                                    <MudGrid Class="mt-2">
                                        <MudItem xs="12">
                                            @if (IsMatchCompleted(table))
                                            {
                                                <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Dense>
                                                    @GetMatchResultText(table)
                                                </MudAlert>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.body2" Class="text-center" Color="Color.Default">
                                                    Race to @GetTargetScore(table) racks
                                                </MudText>
                                            }
                                        </MudItem>
                                    </MudGrid>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                </ChildContent>

                <ItemRenderer Context="item">
                    <MudChip T="string"
                             Variant="Variant.Filled"
                             Color="@GetRegionChipColor(item)"
                             Class="ma-1 cursor-move"
                             Style="max-width: 130px; height: auto; min-height: 52px; padding: 8px 12px; display: flex; align-items: center;">
                        <MudStack Spacing="0" Style="line-height: 1.3; text-align: center; width: 100%;">
                            <MudText Typo="Typo.body2"
                                     Class="font-weight-bold"
                                     Style="font-size: 0.75rem; margin-bottom: 2px;">
                                @item.Name
                            </MudText>
                            @if (!string.IsNullOrEmpty(item.PlayerName))
                            {
                                <MudText Typo="Typo.caption"
                                         Style="font-size: 0.65rem; word-break: break-word; opacity: 0.9;">
                                    @item.PlayerName
                                </MudText>
                            }
                            @if (item.HasLost)
                            {
                                <MudText Typo="Typo.caption"
                                         Color="Color.Error"
                                         Style="font-size: 0.65rem; font-weight: bold;">
                                    (ELIMINATED)
                                </MudText>
                            }
                            @if (item.HasWon)
                            {
                                <MudText Typo="Typo.caption"
                                         Color="Color.Secondary"
                                         Style="font-size: 0.65rem; font-weight: bold;">
                                    (ADVANCED)
                                </MudText>
                            }
                        </MudStack>
                    </MudChip>
                </ItemRenderer>
            </MudDropContainer>
        }
    </MudItem>
</MudGrid>

@code {
    private List<RegionItem> Regions = new();
    private List<string> Tables = new();
    private List<List<RegionItem>> AllSets = new();
    private int CurrentSet = 1;
    private int SelectedSet = 1;

    private int? _selectedSportIDValue = 7;
    private string? _selectedSchoolLevelAndGenderID;
    private string? _selectedMainCategoryValue;
    private int? _selectedSportSubcategoryIDValue;
    private int? _selectedEventStagesIDValue;

    private List<EventsDTO.EventStages>? _eventStages;
    private List<SportsDTO.SportGenderCategories>? _sportGenderCategories;
    private List<SchoolsDTO.SchoolLevels>? _schoolLevels;
    private List<SportsDTO.SportSubcategories>? _sportSubcategories;

    private List<string> _combinedSchoolLevelAndGenderNames = new();
    private List<string> _sportMainCat = new();

    private BilliardsEventDTO? SelectedEvent;

    private Dictionary<string, string> _tableResults = new Dictionary<string, string>();
    private Dictionary<int, (string? PlayerID, string? PlayerName)> _regionPlayerMap = new();
    private HashSet<int> _eliminatedRegions = new HashSet<int>();

    private Dictionary<string, (int player1Score, int player2Score, bool matchCompleted)> _tableScores = new();

    private List<RegionItem> BaseRegions = new();

    private string? _selectedEventId;
    private string? _storedSubcategoryName;
    private string? _storedStageName;

    public class RegionItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string AssignedTable { get; set; } = "Unassigned";
        public string? PlayerName { get; set; }
        public int SetNumber { get; set; } = 1;
        public bool HasLost { get; set; } = false;
        public bool HasWon { get; set; } = false;
        public int RoundEliminated { get; set; } = 0;
    }

    public class BilliardsMatch
    {
        public string TableName { get; set; } = "";
        public string Player1Name { get; set; } = "";
        public string Player2Name { get; set; } = "";
        public string? Player1Result { get; set; }
        public string? Player2Result { get; set; }
    }

    public class BilliardsScoringDTO
    {
        public int ID { get; set; }
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int SetNo { get; set; }
        public int TableNo { get; set; }
        public string? PlayerPosition { get; set; }
        public int? Score { get; set; }
        public bool? IsWinner { get; set; }
        public DateTime? CreatedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class BilliardsEventDTO
    {
        public string? ID { get; set; }
        public DateTime? Date { get; set; }
        public TimeSpan? Time { get; set; }
        public string? Sport { get; set; }
        public string? Subcategory { get; set; }
        public string? Gender { get; set; }
        public string? Level { get; set; }
        public string? EventStage { get; set; }
        public string? SportMainCat { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public int RegionID { get; set; }
        public string? PlayerID { get; set; }
        public string? PlayerName { get; set; }
    }

    public class CreateBilliardsScoringDTO
    {
        public string? EventID { get; set; }
        public int? EventVersusID { get; set; }
        public int RegionID { get; set; }
        public int SetNo { get; set; }
        public int TableNo { get; set; }
        public string? PlayerPosition { get; set; }
        public int? Score { get; set; }
        public bool? IsWinner { get; set; }
        public string? PlayerID { get; set; }
    }

    public class UpdateBilliardsScoringDTO
    {
        public int ID { get; set; }
        public int? TableNo { get; set; }
        public string? PlayerPosition { get; set; }
        public int? Score { get; set; }
        public bool? IsWinner { get; set; }
        public int? SetNo { get; set; }
        public string? PlayerID { get; set; }
    }

    public class ProgressionDTO
    {
        public class ProgressionTeamSelection
        {
            public int? SelectedRegionID { get; set; }
            public List<string> SelectedPlayerIDs { get; set; } = new();
            public List<ProfilePlayerDTO> AvailablePlayers { get; set; } = new();
            public int ExistingVersusTeamID { get; set; }
            public string? Score { get; set; }
            public string? Rank { get; set; }
        }

        public class ProfilePlayerDTO
        {
            public string? ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }
    }

    public class WinnerResponse
    {
        public int ID { get; set; }
        public int? SchoolRegionID { get; set; }
        public string? Region { get; set; }
        public string? Abbreviation { get; set; }
        public string? Score { get; set; }
        public string? Rank { get; set; }
        public List<PlayerResponse> Players { get; set; } = new();
    }

    public class PlayerResponse
    {
        public string? ProfilePlayerID { get; set; }
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
    }

    public class EventsDTO
    {
        public class EventStages
        {
            public int ID { get; set; }
            public string? Stage { get; set; }
        }

        public class EventDetails
        {
            public string ID { get; set; } = null!;
            public int? EventStageID { get; set; }
            public string? EventStage { get; set; }
            public List<EventVersusTeams>? EventVersusList { get; set; }
            public string? SportMainCat { get; set; }
            public string? Category { get; set; }
            public string? Sport { get; set; }
            public string? GamePhase { get; set; }
            public int? SubCategoryID { get; set; }
            public string? Subcategory { get; set; }
            public string? Gender { get; set; }
            public string? Level { get; set; }
            public int? EventVenuesID { get; set; }
            public string? Venue { get; set; }
            public decimal? Latitude { get; set; }
            public decimal? Longitude { get; set; }
            public DateTime? Date { get; set; }
            public TimeSpan? Time { get; set; }
            public bool? OnStream { get; set; }
            public int? EventStreamID { get; set; }
            public int? EventStreamServiceID { get; set; }
            public string? StreamService { get; set; }
            public string? StreamURL { get; set; }
            public bool? IsFinished { get; set; }
            public bool? Archived { get; set; }
            public bool? Deleted { get; set; }
            public string? UserID { get; set; }
            public int? BracketID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }

        public class EventVersusTeams
        {
            public int ID { get; set; }
            public string? EventID { get; set; }
            public int? SchoolRegionID { get; set; }
            public string? Score { get; set; }
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
            public List<EventVersusTeamPlayers>? EventVersusTeamPlayersList { get; set; }
            public string? Rank { get; set; }
            public DateTime? RecentUpdateAt { get; set; }
        }

        public class EventVersusTeamPlayers
        {
            public int ID { get; set; }
            public int? EventVersusID { get; set; }
            public string? ProfilePlayerID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
            public string? School { get; set; }
        }
    }

    public class ProfilesDTO
    {
        public class ProfilePlayerEvent
        {
            public string? ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
            public int? RegionID { get; set; }
            public int? SubCategoryID { get; set; }
        }

        public class ProfilePlayer
        {
            public string? ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }
    }

    public class SportsDTO
    {
        public class SportSubcategories
        {
            public int ID { get; set; }
            public string? Subcategory { get; set; }
            public int? SportID { get; set; }
            public int? SportGenderCategoryID { get; set; }
            public int? SchoolLevelID { get; set; }
            public string? MainCategory { get; set; }
        }

        public class SportGenderCategories
        {
            public int ID { get; set; }
            public string? Gender { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class SchoolLevels
        {
            public int ID { get; set; }
            public string? Level { get; set; }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Parse query parameters first
        await ParseQueryParameters();

        // If eventId is provided, auto-fill filters
        if (!string.IsNullOrEmpty(_selectedEventId))
        {
            await LoadEventAndAutoFillFilters();
        }
        else
        {
            await LoadAvailableOptions();
            await FilterSchoolLevelAndGenderAsync();
        }

        Tables = new List<string> { "Table 1", "Table 2", "Table 3", "Table 4" };
        InitializeTableScores();
    }

    private async Task ParseQueryParameters()
    {
        try
        {
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

            // Get query parameters
            _selectedEventId = query["eventId"];

            // Check for other parameters
            var levelGender = query["levelGender"] ?? query["levelgender"];
            var mainCat = query["mainCat"] ?? query["maincat"];
            var subcategory = query["subcategory"] ?? query["subcate"];
            var stage = query["stage"];
            var sport = query["sport"];

            // Store these for later use
            if (!string.IsNullOrEmpty(levelGender))
            {
                _selectedSchoolLevelAndGenderID = levelGender;
            }

            if (!string.IsNullOrEmpty(mainCat))
            {
                _selectedMainCategoryValue = mainCat;
            }

            if (!string.IsNullOrEmpty(subcategory))
            {
                _storedSubcategoryName = Uri.UnescapeDataString(subcategory);
            }

            if (!string.IsNullOrEmpty(stage))
            {
                _storedStageName = Uri.UnescapeDataString(stage);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error parsing query parameters: {ex.Message}", Severity.Warning);
        }
    }

    private async Task LoadEventAndAutoFillFilters()
    {
        try
        {
            // Load available options first
            await LoadAvailableOptions();
            await FilterSchoolLevelAndGenderAsync();

            // Try the BilliardsScoring events endpoint first
            var events = await apiService.GetAsync<BilliardsEventDTO>($"/BilliardsScoring/events?eventId={_selectedEventId}");

            if (events != null && events.Any())
            {
                var eventDetail = events.FirstOrDefault();

                if (eventDetail != null)
                {
                    // Auto-fill school level and gender
                    if (!string.IsNullOrEmpty(eventDetail.Level) && !string.IsNullOrEmpty(eventDetail.Gender))
                    {
                        _selectedSchoolLevelAndGenderID = $"{eventDetail.Level} - {eventDetail.Gender}";

                        // Load subcategories for this combination
                        await GetSportSubCategoriesSLGAsync();
                        LoadMainCategories();

                        // Auto-fill main category
                        if (!string.IsNullOrEmpty(eventDetail.SportMainCat))
                        {
                            _selectedMainCategoryValue = eventDetail.SportMainCat;
                        }

                        // Auto-fill subcategory
                        if (!string.IsNullOrEmpty(eventDetail.Subcategory) && _sportSubcategories != null)
                        {
                            var subcat = _sportSubcategories.FirstOrDefault(s =>
                                s.Subcategory != null && (
                                    s.Subcategory.Equals(eventDetail.Subcategory, StringComparison.OrdinalIgnoreCase) ||
                                    eventDetail.Subcategory.Contains(s.Subcategory, StringComparison.OrdinalIgnoreCase) ||
                                    s.Subcategory.Contains(eventDetail.Subcategory, StringComparison.OrdinalIgnoreCase)
                                ));

                            if (subcat != null)
                            {
                                _selectedSportSubcategoryIDValue = subcat.ID;
                            }
                            else
                            {
                                // Try to find by main category
                                subcat = _sportSubcategories.FirstOrDefault(s =>
                                    s.MainCategory == eventDetail.SportMainCat);
                                if (subcat != null)
                                {
                                    _selectedSportSubcategoryIDValue = subcat.ID;
                                }
                            }
                        }

                        // Auto-fill stage
                        if (!string.IsNullOrEmpty(eventDetail.EventStage) && _eventStages != null)
                        {
                            var stage = _eventStages.FirstOrDefault(e =>
                                e.Stage != null && e.Stage.Equals(eventDetail.EventStage, StringComparison.OrdinalIgnoreCase));
                            if (stage != null)
                            {
                                _selectedEventStagesIDValue = stage.ID;
                            }
                        }

                        // Apply filters automatically
                        await ApplyFilters();
                    }
                    else
                    {
                        Snackbar.Add("Event details are incomplete", Severity.Warning);
                    }
                }
                else
                {
                    Snackbar.Add("Event not found", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("No events found for the specified ID", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading event: {ex.Message}", Severity.Error);
            await FilterSchoolLevelAndGenderAsync();
        }
    }

    private Color GetRegionChipColor(RegionItem region)
    {
        if (region.HasLost)
            return Color.Default;

        if (region.HasWon && region.AssignedTable != "Unassigned")
            return Color.Primary;

        if (region.AssignedTable != "Unassigned" && region.AssignedTable.StartsWith($"{SelectedSet}_"))
            return Color.Primary;

        return Color.Primary;
    }

    private string? GetResultIndicator(string tableName, string position)
    {
        var key = $"{SelectedSet}_{tableName}_{position}";
        return _tableResults.ContainsKey(key) ? _tableResults[key] : null;
    }

    private Color GetResultColor(string tableName, string position)
    {
        var indicator = GetResultIndicator(tableName, position);
        return indicator switch
        {
            "W" => Color.Success,
            "L" => Color.Error,
            _ => Color.Default
        };
    }

    private void SetResultIndicator(string tableName, string position, string result)
    {
        var key = $"{SelectedSet}_{tableName}_{position}";
        _tableResults[key] = result;
    }

    private void ClearResultIndicatorsForTable(string tableName)
    {
        var player1Key = $"{SelectedSet}_{tableName}_Player1";
        var player2Key = $"{SelectedSet}_{tableName}_Player2";
        _tableResults.Remove(player1Key);
        _tableResults.Remove(player2Key);
    }

    private void ClearAllResultIndicatorsForSet(int setNumber)
    {
        var keysToRemove = _tableResults.Keys.Where(key => key.StartsWith($"{setNumber}_")).ToList();
        foreach (var key in keysToRemove)
        {
            _tableResults.Remove(key);
        }
    }

    private async Task LoadAvailableOptions()
    {
        try
        {
            await GetEventStagesAsync();
            await GetGenderCategoriesAsync();
            await GetSchoolLevelsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading options: {ex.Message}", Severity.Error);
        }
    }

    private async Task GetEventStagesAsync()
    {
        string url = "/Events/Stages";
        _eventStages = await apiService.GetAsync<EventsDTO.EventStages>(url);

        if (!string.IsNullOrEmpty(_storedStageName) && _eventStages != null)
        {
            var stage = _eventStages.FirstOrDefault(e =>
                e.Stage != null && e.Stage.Equals(_storedStageName, StringComparison.OrdinalIgnoreCase));

            if (stage != null)
            {
                _selectedEventStagesIDValue = stage.ID;
                _storedStageName = null;
            }
        }
    }

    private async Task GetGenderCategoriesAsync()
    {
        string url = "/Sports/GenderCategories";
        _sportGenderCategories = await apiService.GetAsync<SportsDTO.SportGenderCategories>(url);
    }

    private async Task GetSchoolLevelsAsync()
    {
        string url = "/Schools/Levels";
        _schoolLevels = await apiService.GetAsync<SchoolsDTO.SchoolLevels>(url);
    }

    private async Task GetSportSubCategoriesSLGAsync()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
            return;
        }

        var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
        var schoolLevelName = parts[0];
        var genderName = parts[1];

        var schoolLevelID = _schoolLevels?.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
        var genderID = _sportGenderCategories?.FirstOrDefault(x => x.Gender == genderName)?.ID;

        if (schoolLevelID != null && genderID != null && _selectedSportIDValue != null)
        {
            _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(
                $"/Sports/Subcategories?sportID={_selectedSportIDValue}&schoolLevelID={schoolLevelID}&sportGenderCategoryID={genderID}");

            // Try to auto-select subcategory if we have a stored name
            if (!string.IsNullOrEmpty(_storedSubcategoryName) && _sportSubcategories != null)
            {
                // Try multiple matching strategies
                var subcat = _sportSubcategories.FirstOrDefault(s =>
                    s.Subcategory != null && (
                        s.Subcategory.Equals(_storedSubcategoryName, StringComparison.OrdinalIgnoreCase) ||
                        s.Subcategory.Replace(" ", "").Equals(_storedSubcategoryName.Replace(" ", ""), StringComparison.OrdinalIgnoreCase) ||
                        _storedSubcategoryName.Contains(s.Subcategory, StringComparison.OrdinalIgnoreCase) ||
                        s.Subcategory.Contains(_storedSubcategoryName, StringComparison.OrdinalIgnoreCase)
                    ));

                if (subcat != null)
                {
                    _selectedSportSubcategoryIDValue = subcat.ID;
                    _storedSubcategoryName = null; 
                }
            }
        }
        else
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        }
    }

    private List<SportsDTO.SportSubcategories> GetFilteredSubcategories()
    {
        if (_sportSubcategories == null) return new List<SportsDTO.SportSubcategories>();
        return !string.IsNullOrEmpty(_selectedMainCategoryValue)
            ? _sportSubcategories.Where(sc => sc.MainCategory == _selectedMainCategoryValue).ToList()
            : _sportSubcategories.Where(sc => string.IsNullOrEmpty(sc.MainCategory)).ToList();
    }

    private async Task FilterSchoolLevelAndGenderAsync()
    {
        if (_selectedSportIDValue == null)
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var subcats = await apiService.GetAsync<SportsDTO.SportSubcategories>($"/Sports/Subcategories?sportID={_selectedSportIDValue}");
        if (subcats == null || !subcats.Any())
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var schoolLevelIDs = subcats.Where(x => x.SchoolLevelID.HasValue).Select(x => x.SchoolLevelID.Value).Distinct();
        var genderIDs = subcats.Where(x => x.SportGenderCategoryID.HasValue).Select(x => x.SportGenderCategoryID.Value).Distinct();

        var schoolLevelNames = _schoolLevels?.Where(s => schoolLevelIDs.Contains(s.ID)).Select(s => s.Level) ?? new List<string>();
        var genderNames = _sportGenderCategories?.Where(g => genderIDs.Contains(g.ID)).Select(g => g.Gender) ?? new List<string>();

        _combinedSchoolLevelAndGenderNames = schoolLevelNames.SelectMany(s => genderNames, (s, g) => $"{s} - {g}").ToList();
    }

    private void LoadMainCategories()
    {
        _sportMainCat = _sportSubcategories?.Where(sc => !string.IsNullOrEmpty(sc.MainCategory))
            .Select(sc => sc.MainCategory!).Distinct().ToList() ?? new List<string>();
    }

    // ApplyFilters method
    private async Task ApplyFilters()
    {
        try
        {
            var queryParams = new List<string>();

            // Always include sport filter
            queryParams.Add("sport=Billiards");

            // If eventId exist, use it as the primary filter
            if (!string.IsNullOrEmpty(_selectedEventId))
            {
                queryParams.Add($"eventId={Uri.EscapeDataString(_selectedEventId)}");
            }
            else
            {
                // Add subcategory filter
                if (_selectedSportSubcategoryIDValue.HasValue)
                {
                    var subcategoryName = _sportSubcategories?.FirstOrDefault(s => s.ID == _selectedSportSubcategoryIDValue.Value)?.Subcategory;
                    if (!string.IsNullOrEmpty(subcategoryName))
                        queryParams.Add($"subcategory={Uri.EscapeDataString(subcategoryName)}");
                }

                // Add school level and gender filters
                if (!string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
                {
                    var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
                    if (parts.Length == 2)
                    {
                        queryParams.Add($"level={Uri.EscapeDataString(parts[0])}");
                        queryParams.Add($"gender={Uri.EscapeDataString(parts[1])}");
                    }
                }

                // Add event stage filter
                if (_selectedEventStagesIDValue.HasValue)
                {
                    var stageName = _eventStages?.FirstOrDefault(e => e.ID == _selectedEventStagesIDValue.Value)?.Stage;
                    if (!string.IsNullOrEmpty(stageName))
                        queryParams.Add($"eventStage={Uri.EscapeDataString(stageName)}");
                }
            }

            var queryString = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";

            // Use BilliardsScoring events endpoint
            var events = await apiService.GetAsync<BilliardsEventDTO>($"/BilliardsScoring/events{queryString}");

            if (events != null && events.Any())
            {
                _regionPlayerMap.Clear();
                _eliminatedRegions.Clear();
                _tableResults.Clear();
                _tableScores.Clear();
                AllSets.Clear();

                BaseRegions = events
                    .Where(evt => !string.IsNullOrEmpty(evt.Abbreviation))
                    .GroupBy(evt => evt.Abbreviation)
                    .Select(group =>
                    {
                        var firstEvent = group.First();
                        var regionItem = new RegionItem
                            {
                                Id = firstEvent.RegionID,
                                Name = group.Key!,
                                AssignedTable = "Unassigned",
                                SetNumber = 1,
                                PlayerName = firstEvent.PlayerName,
                                HasLost = false,
                                RoundEliminated = 0
                            };

                        if (!string.IsNullOrEmpty(firstEvent.PlayerID))
                        {
                            _regionPlayerMap[firstEvent.RegionID] = (firstEvent.PlayerID, firstEvent.PlayerName);
                        }

                        return regionItem;
                    })
                    .ToList();

                var firstSet = BaseRegions.Select(r => new RegionItem
                    {
                        Id = r.Id,
                        Name = r.Name,
                        AssignedTable = "Unassigned",
                        SetNumber = 1,
                        PlayerName = r.PlayerName,
                        HasLost = false,
                        RoundEliminated = 0
                    }).ToList();

                AllSets.Add(firstSet);
                Regions = firstSet;

                // Select the first event for display
                SelectedEvent = events.FirstOrDefault();
                SelectedSet = 1;
                CurrentSet = 1;

                InitializeTableScores();
                await LoadExistingBilliardsAssignments();

                Snackbar.Add($"Found {events.Count} events with {Regions.Count} regions. Loaded {AllSets.Count} round(s).", Severity.Success);
            }
            else
            {
                Regions = new List<RegionItem>();
                BaseRegions = new List<RegionItem>();
                SelectedEvent = null;
                _tableResults.Clear();
                _tableScores.Clear();
                Snackbar.Add("No Billiards events found with the selected filters", Severity.Warning);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error applying filters: {ex.Message}", Severity.Error);
            Regions = new List<RegionItem>();
            BaseRegions = new List<RegionItem>();
            StateHasChanged();
        }
    }

    private async Task ClearFilters()
    {
        _selectedSchoolLevelAndGenderID = null;
        _selectedMainCategoryValue = null;
        _selectedSportSubcategoryIDValue = null;
        _selectedEventStagesIDValue = null;
        _selectedEventId = null;
        SelectedEvent = null;
        Regions = new List<RegionItem>();
        BaseRegions = new List<RegionItem>();
        _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        _combinedSchoolLevelAndGenderNames = new List<string>();
        _sportMainCat = new List<string>();
        _tableResults.Clear();
        _tableScores.Clear();
        _eliminatedRegions.Clear();
        AllSets.Clear();
        CurrentSet = 1;
        SelectedSet = 1;
        _regionPlayerMap.Clear();

        Snackbar.Add("Filters cleared", Severity.Info);
        StateHasChanged();
    }

    private async Task LoadExistingBilliardsAssignments()
    {
        try
        {
            if (SelectedEvent == null) return;

            var existingAssignments = await apiService.GetAsync<BilliardsScoringDTO>($"/BilliardsScoring/event/{SelectedEvent.ID}");
            if (existingAssignments != null && existingAssignments.Any())
            {
                var maxSetNo = existingAssignments.Max(a => a.SetNo);

                for (int i = AllSets.Count; i < maxSetNo; i++)
                {
                    var newSetNumber = i + 1;

                    var previousRound = AllSets.LastOrDefault();
                    if (previousRound != null && previousRound.Any())
                    {
                        var winnersFromPreviousRound = previousRound
                            .Where(r => r.HasWon)
                            .Select(r => new RegionItem
                                {
                                    Id = r.Id,
                                    Name = r.Name,
                                    AssignedTable = "Unassigned",
                                    SetNumber = newSetNumber,
                                    PlayerName = r.PlayerName,
                                    HasLost = false,
                                    HasWon = false,
                                    RoundEliminated = 0
                                }).ToList();

                        AllSets.Add(winnersFromPreviousRound);
                    }
                    else
                    {
                        AllSets.Add(new List<RegionItem>());
                    }
                }

                foreach (var assignment in existingAssignments)
                {
                    if (assignment.SetNo > 0 && assignment.SetNo <= AllSets.Count)
                    {
                        var setToUpdate = AllSets[assignment.SetNo - 1];

                        var regionInSet = setToUpdate.FirstOrDefault(r => r.Id == assignment.RegionID);
                        if (regionInSet == null)
                        {
                            var baseRegion = BaseRegions.FirstOrDefault(br => br.Id == assignment.RegionID);
                            if (baseRegion != null)
                            {
                                regionInSet = new RegionItem
                                    {
                                        Id = baseRegion.Id,
                                        Name = baseRegion.Name,
                                        AssignedTable = "Unassigned",
                                        SetNumber = assignment.SetNo,
                                        PlayerName = baseRegion.PlayerName,
                                        HasLost = false,
                                        HasWon = false,
                                        RoundEliminated = 0
                                    };
                                setToUpdate.Add(regionInSet);
                            }
                        }

                        if (regionInSet != null && assignment.TableNo > 0 && !string.IsNullOrEmpty(assignment.PlayerPosition))
                        {
                            regionInSet.AssignedTable = $"{assignment.SetNo}_Table {assignment.TableNo}_{assignment.PlayerPosition}";

                            // Load score from database
                            var tableName = $"Table {assignment.TableNo}";
                            var scoreKey = $"{assignment.SetNo}_{tableName}";
                            if (!_tableScores.ContainsKey(scoreKey))
                            {
                                _tableScores[scoreKey] = (0, 0, false);
                            }

                            var currentScores = _tableScores[scoreKey];
                            if (assignment.PlayerPosition == "Player1" && assignment.Score.HasValue)
                            {
                                _tableScores[scoreKey] = (assignment.Score.Value, currentScores.player2Score, currentScores.matchCompleted);
                            }
                            else if (assignment.PlayerPosition == "Player2" && assignment.Score.HasValue)
                            {
                                _tableScores[scoreKey] = (currentScores.player1Score, assignment.Score.Value, currentScores.matchCompleted);
                            }

                            if (assignment.IsWinner.HasValue)
                            {
                                regionInSet.HasLost = !assignment.IsWinner.Value;
                                regionInSet.HasWon = assignment.IsWinner.Value;
                                if (regionInSet.HasLost && regionInSet.RoundEliminated == 0)
                                {
                                    regionInSet.RoundEliminated = assignment.SetNo;
                                    _eliminatedRegions.Add(regionInSet.Id);
                                }

                                var resultKey = $"{assignment.SetNo}_{tableName}_{assignment.PlayerPosition}";
                                _tableResults[resultKey] = assignment.IsWinner == true ? "W" : "L";

                                // Mark match as completed if winner is set
                                if (assignment.IsWinner == true)
                                {
                                    _tableScores[scoreKey] = (_tableScores[scoreKey].player1Score, _tableScores[scoreKey].player2Score, true);
                                }
                            }

                            if (!string.IsNullOrEmpty(assignment.PlayerName))
                            {
                                regionInSet.PlayerName = assignment.PlayerName;
                            }
                        }
                    }
                }

                if (maxSetNo > CurrentSet)
                {
                    CurrentSet = maxSetNo;
                }

                if (SelectedSet <= AllSets.Count)
                {
                    Regions = AllSets[SelectedSet - 1];
                }

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading existing billiards assignments: {ex.Message}", Severity.Warning);
        }
    }

    private void AddTable() => Tables.Add($"Table {Tables.Count + 1}");

    private void NextSet()
    {
        if (!BaseRegions.Any())
        {
            Snackbar.Add("No regions available. Please apply filters first.", Severity.Warning);
            return;
        }

        var tablesWithoutResults = Tables.Where(table =>
            GetResultIndicator(table, "Player1") == null &&
            GetResultIndicator(table, "Player2") == null &&
            Regions.Any(r => r.AssignedTable == $"{CurrentSet}_{table}_Player1" ||
                           r.AssignedTable == $"{CurrentSet}_{table}_Player2")
        ).ToList();

        if (tablesWithoutResults.Any())
        {
            Snackbar.Add($"Please complete all matches in Round {CurrentSet} before advancing.", Severity.Warning);
            return;
        }

        var winnersFromCurrentSet = AllSets[CurrentSet - 1]
            .Where(r => r.HasWon && r.AssignedTable != "Unassigned")
            .Select(winner => new RegionItem
                {
                    Id = winner.Id,
                    Name = winner.Name,
                    AssignedTable = "Unassigned",
                    SetNumber = CurrentSet + 1,
                    PlayerName = winner.PlayerName,
                    HasLost = false,
                    HasWon = false,
                    RoundEliminated = 0
                }).ToList();

        var eliminatedThisRound = AllSets[CurrentSet - 1]
            .Where(r => r.HasLost)
            .Select(r => r.Id);
        _eliminatedRegions.UnionWith(eliminatedThisRound);

        if (winnersFromCurrentSet.Any())
        {
            CurrentSet++;
            AllSets.Add(winnersFromCurrentSet);
            SelectedSet = CurrentSet;
            Regions = winnersFromCurrentSet;

            ClearAllResultIndicatorsForSet(CurrentSet);

            Snackbar.Add($"Round {CurrentSet} created with {Regions.Count} winners advancing!", Severity.Success);
        }
        else
        {
            Snackbar.Add($"No winners found in Round {CurrentSet}. Cannot create next round.", Severity.Warning);
        }

        StateHasChanged();
    }

    private void OnSetChanged(int setNumber)
    {
        if (setNumber >= 1 && setNumber <= AllSets.Count)
        {
            SelectedSet = setNumber;

            Regions = AllSets[setNumber - 1];

            foreach (var region in Regions)
            {
                if (string.IsNullOrEmpty(region.PlayerName))
                {
                    var baseRegion = BaseRegions.FirstOrDefault(br => br.Id == region.Id);
                    if (baseRegion != null)
                    {
                        region.PlayerName = baseRegion.PlayerName;
                    }
                }
            }

            StateHasChanged();
        }
        else
        {
            Snackbar.Add($"Round {setNumber} is not available. Total rounds: {AllSets.Count}", Severity.Warning);
        }
    }

    private bool SelectItemsForZone(RegionItem item, string dropzone)
    {
        return item.SetNumber == SelectedSet && item.AssignedTable == dropzone;
    }

    private async Task OnItemDropped(MudItemDropInfo<RegionItem> info)
    {
        if (info.Item.HasLost)
        {
            Snackbar.Add($"{info.Item.Name} has been eliminated and cannot be moved", Severity.Warning);
            return;
        }

        if (info.Item.HasWon)
        {
            Snackbar.Add($"{info.Item.Name} has already won and will advance to next round", Severity.Warning);
            return;
        }

        info.Item.AssignedTable = info.DropzoneIdentifier;
        info.Item.SetNumber = SelectedSet;

        Snackbar.Add($"{info.Item.Name} moved to {info.Item.AssignedTable} (Round {SelectedSet})", Severity.Success);
        await SaveRegionAssignment(info.Item);
        StateHasChanged();
    }

    private async Task SaveRegionAssignment(RegionItem region)
    {
        try
        {
            var (tableNo, playerPosition) = ParseAssignedTable(region.AssignedTable);

            if (tableNo > 0 && playerPosition != "Unassigned" && SelectedEvent != null)
            {
                string? playerId = null;
                if (_regionPlayerMap.ContainsKey(region.Id))
                {
                    playerId = _regionPlayerMap[region.Id].PlayerID;
                }

                var createDto = new CreateBilliardsScoringDTO
                    {
                        EventID = SelectedEvent.ID,
                        EventVersusID = null,
                        RegionID = region.Id,
                        SetNo = region.SetNumber,
                        TableNo = tableNo,
                        PlayerPosition = playerPosition,
                        Score = 0,
                        IsWinner = null,
                        PlayerID = playerId
                    };

                var result = await apiService.PostAsync<CreateBilliardsScoringDTO, int>("/BilliardsScoring", createDto);
                if (result > 0)
                {
                    Snackbar.Add($"Saved {region.Name} assignment successfully!", Severity.Success);
                }
                else
                {
                    Snackbar.Add($"Failed to save assignment for {region.Name}", Severity.Warning);
                }
            }
            else if (region.AssignedTable == "Unassigned")
            {
                await DeleteAssignment(region.Id, region.SetNumber, region.AssignedTable);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving assignment: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteAssignment(int regionId, int setNumber, string assignedTable)
    {
        try
        {
            var (tableNo, playerPosition) = ParseAssignedTable(assignedTable);
            if (tableNo > 0 && !string.IsNullOrEmpty(playerPosition))
            {
                await apiService.DeleteAsync($"/BilliardsScoring/region/{regionId}/set/{setNumber}/table/{tableNo}/position/{playerPosition}");
            }
            else
            {
                await apiService.DeleteAsync($"/BilliardsScoring/region/{regionId}/set/{setNumber}");
            }
            Snackbar.Add("Assignment removed", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error removing assignment", Severity.Warning);
        }
    }

    #region Score Management Methods

    // Initialize table scores
    private void InitializeTableScores()
    {
        foreach (var table in Tables)
        {
            var key = $"{SelectedSet}_{table}";
            if (!_tableScores.ContainsKey(key))
            {
                _tableScores[key] = (0, 0, false);
            }
        }
    }

    // Get player score
    private int GetPlayerScore(string tableName, string playerPosition)
    {
        var key = $"{SelectedSet}_{tableName}";
        if (_tableScores.ContainsKey(key))
        {
            return playerPosition == "Player1" ? _tableScores[key].player1Score : _tableScores[key].player2Score;
        }
        return 0;
    }

    // Get player score as string for binding
    private string GetPlayerScoreString(string tableName, string playerPosition)
    {
        return GetPlayerScore(tableName, playerPosition).ToString();
    }

    // Set player score string 
    private async Task SetPlayerScoreString(string tableName, string playerPosition, string value)
    {
        if (int.TryParse(value, out int score) && score >= 0)
        {
            var key = $"{SelectedSet}_{tableName}";
            if (!_tableScores.ContainsKey(key))
            {
                _tableScores[key] = (0, 0, false);
            }

            var current = _tableScores[key];
            if (playerPosition == "Player1")
            {
                _tableScores[key] = (score, current.player2Score, current.matchCompleted);
            }
            else
            {
                _tableScores[key] = (current.player1Score, score, current.matchCompleted);
            }

            // Find the region and save the score to database
            var playerId = $"{SelectedSet}_{tableName}_{playerPosition}";
            var region = Regions!.FirstOrDefault(r => r.AssignedTable == playerId);
            if (region != null)
            {
                var tableNo = GetTableNumber(tableName);
                await UpdatePlayerScore(region.Id, SelectedSet, tableNo, playerPosition, score);
            }

            await CheckForWinner(tableName);
            StateHasChanged();
        }
    }

    private async Task UpdatePlayerScore(int regionId, int setNo, int tableNo, string playerPosition, int score)
    {
        try
        {
            var recordId = await GetOrCreateBilliardsScoringId(regionId, setNo, tableNo, playerPosition);
            if (recordId > 0)
            {
                string? playerId = null;
                if (_regionPlayerMap.ContainsKey(regionId))
                {
                    playerId = _regionPlayerMap[regionId].PlayerID;
                }

                // just update the score , isWinner is null here
                var updateDto = new UpdateBilliardsScoringDTO
                    {
                        ID = recordId,
                        TableNo = tableNo,
                        PlayerPosition = playerPosition,
                        Score = score, 
                        SetNo = setNo,
                        PlayerID = playerId
                    };

                await apiService.PutAsync($"/BilliardsScoring/{recordId}", updateDto);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating score: {ex.Message}", Severity.Error);
        }
    }

    // Adjust score with plus/minus buttons
    private async Task AdjustScore(string tableName, string playerPosition, int adjustment)
    {
        var currentScore = GetPlayerScore(tableName, playerPosition);
        var newScore = Math.Max(0, currentScore + adjustment);

        await SetPlayerScoreString(tableName, playerPosition, newScore.ToString());
    }

    // Validate score input
    private async Task ValidateScore(string tableName, string playerPosition)
    {
        var currentScore = GetPlayerScore(tableName, playerPosition);
        if (currentScore < 0)
        {
            await SetPlayerScoreString(tableName, playerPosition, "0");
        }
    }

    // Get target score based on event stage
    private int GetTargetScore(string tableName)
    {
        if (SelectedEvent == null || string.IsNullOrEmpty(SelectedEvent.EventStage))
        {
            // Fallback to round-based scoring if no event stage info
            if (SelectedSet == 1) return 4;
            if (SelectedSet == 2) return 5;
            return 6;
        }

        // Get target score based on event stage
        var stage = SelectedEvent.EventStage.ToLower();

        if (stage.Contains("elimination")) return 4;  // Elimination Round: Race to 4
        if (stage.Contains("semi")) return 5;         // Semi-finals: Race to 5
        if (stage.Contains("final")) return 6;        // Finals: Race to 6

        // Default fallback based on round
        if (SelectedSet == 1) return 4;
        if (SelectedSet == 2) return 5;
        return 6;
    }

    // Check if match is completed
    private bool IsMatchCompleted(string tableName)
    {
        var key = $"{SelectedSet}_{tableName}";
        return _tableScores.ContainsKey(key) && _tableScores[key].matchCompleted;
    }

    // Check for winner
    private async Task CheckForWinner(string tableName)
    {
        var key = $"{SelectedSet}_{tableName}";
        if (!_tableScores.ContainsKey(key)) return;

        var scores = _tableScores[key];
        var targetScore = GetTargetScore(tableName);

        // Check if any player reached target score
        if (scores.player1Score >= targetScore || scores.player2Score >= targetScore)
        {
            // Determine winner (whoever reaches target first)
            var winner = scores.player1Score >= targetScore ? "Player1" : "Player2";
            var loser = winner == "Player1" ? "Player2" : "Player1";

            // Mark match as completed
            _tableScores[key] = (scores.player1Score, scores.player2Score, true);

            // Update regions
            await UpdateMatchResult(tableName, winner, loser);
        }
    }

    // Update match result
    private async Task UpdateMatchResult(string tableName, string winnerPosition, string loserPosition)
    {
        try
        {
            var winnerId = $"{SelectedSet}_{tableName}_{winnerPosition}";
            var loserId = $"{SelectedSet}_{tableName}_{loserPosition}";

            var winnerRegion = Regions!.FirstOrDefault(r => r.AssignedTable == winnerId);
            var loserRegion = Regions!.FirstOrDefault(r => r.AssignedTable == loserId);

            if (winnerRegion != null && loserRegion != null)
            {
                ClearResultIndicatorsForTable(tableName);

                // Set winner
                SetResultIndicator(tableName, winnerPosition, "W");
                winnerRegion.HasWon = true;
                winnerRegion.HasLost = false;

                // Set loser
                SetResultIndicator(tableName, loserPosition, "L");
                loserRegion.HasLost = true;
                loserRegion.HasWon = false;
                loserRegion.RoundEliminated = SelectedSet;
                _eliminatedRegions.Add(loserRegion.Id);

                // Update in database
                await UpdatePlayerResult(winnerRegion.Id, SelectedSet, GetTableNumber(tableName), winnerPosition, true, winnerRegion.Name);
                await UpdatePlayerResult(loserRegion.Id, SelectedSet, GetTableNumber(tableName), loserPosition, false, loserRegion.Name);

                // Update EventVersusTeams with winner/loser status
                await MarkWinnersInEventVersusTeams(tableName, winnerPosition, loserPosition);

                Snackbar.Add($"{winnerRegion.Name} wins {GetPlayerScore(tableName, winnerPosition)}-{GetPlayerScore(tableName, loserPosition)} and advances! {loserRegion.Name} is eliminated.", Severity.Success);

                RefreshStandingsAfterScoreUpdate();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating match result: {ex.Message}", Severity.Error);
        }
    }

    // Get table number from table name
    private int GetTableNumber(string tableName)
    {
        return int.Parse(tableName.Replace("Table ", ""));
    }

    // Get match result text
    private string GetMatchResultText(string tableName)
    {
        var key = $"{SelectedSet}_{tableName}";
        if (!_tableScores.ContainsKey(key)) return "";

        var scores = _tableScores[key];
        var winnerId = $"{SelectedSet}_{tableName}_{(scores.player1Score > scores.player2Score ? "Player1" : "Player2")}";
        var winnerRegion = Regions!.FirstOrDefault(r => r.AssignedTable == winnerId);

        return winnerRegion != null
            ? $"{winnerRegion.Name} wins {scores.player1Score}-{scores.player2Score}"
            : "Match Completed";
    }

    // Check if match can be updated
    private bool CanUpdateMatch(string tableName)
    {
        var key = $"{SelectedSet}_{tableName}";
        if (!_tableScores.ContainsKey(key)) return false;

        var scores = _tableScores[key];
        return !scores.matchCompleted && (scores.player1Score > 0 || scores.player2Score > 0);
    }

    // Update score manually
    private async Task UpdateScore(string tableName)
    {
        await CheckForWinner(tableName);
    }


    #endregion

    private async Task UpdatePlayerResult(int regionId, int setNo, int tableNo, string playerPosition, bool isWinner, string regionName)
    {
        try
        {
            var recordId = await GetOrCreateBilliardsScoringId(regionId, setNo, tableNo, playerPosition);
            if (recordId > 0)
            {
                string? playerId = null;
                if (_regionPlayerMap.ContainsKey(regionId))
                {
                    playerId = _regionPlayerMap[regionId].PlayerID;
                }

                // Get the current score before updating
                var currentScore = GetPlayerScore($"Table {tableNo}", playerPosition);

                var updateDto = new UpdateBilliardsScoringDTO
                    {
                        ID = recordId,
                        TableNo = tableNo,
                        PlayerPosition = playerPosition,
                        Score = currentScore,
                        IsWinner = isWinner,
                        SetNo = setNo,
                        PlayerID = playerId
                    };
                await apiService.PutAsync($"/BilliardsScoring/{recordId}", updateDto);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating result for {regionName}: {ex.Message}", Severity.Error);
        }
    }
    private async Task ClearPlayerResult(int regionId, int setNo, string tableName)
    {
        try
        {
            var (tableNo, playerPosition) = ParseAssignedTable($"{setNo}_{tableName}_Player1");
            var recordId = await GetOrCreateBilliardsScoringId(regionId, setNo, tableNo, playerPosition);

            if (recordId > 0)
            {
                var updateDto = new UpdateBilliardsScoringDTO
                    {
                        ID = recordId,
                        IsWinner = null
                    };
                await apiService.PutAsync($"/BilliardsScoring/{recordId}", updateDto);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error clearing result: {ex.Message}", Severity.Error);
        }
    }

    private async Task<int> GetOrCreateBilliardsScoringId(int regionId, int setNo, int tableNo, string playerPosition)
    {
        try
        {
            var existing = await apiService.GetAsync<BilliardsScoringDTO>($"/BilliardsScoring/event/{SelectedEvent?.ID}");

            // More specific query to find the exact record
            var record = existing?.FirstOrDefault(r =>
                r.RegionID == regionId &&
                r.SetNo == setNo &&
                r.TableNo == tableNo &&
                r.PlayerPosition == playerPosition &&
                r.EventID == SelectedEvent?.ID);

            if (record != null) return record.ID;

            // Only create new if no existing record found
            string? playerId = null;
            if (_regionPlayerMap.ContainsKey(regionId))
            {
                playerId = _regionPlayerMap[regionId].PlayerID;
            }

            var createDto = new CreateBilliardsScoringDTO
                {
                    EventID = SelectedEvent?.ID,
                    RegionID = regionId,
                    SetNo = setNo,
                    TableNo = tableNo,
                    PlayerPosition = playerPosition,
                    Score = 0,
                    IsWinner = null,
                    PlayerID = playerId
                };

            var newId = await apiService.PostAsync<CreateBilliardsScoringDTO, int>("/BilliardsScoring", createDto);
            return newId > 0 ? newId : 0;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error getting record ID: {ex.Message}", Severity.Error);
            return 0;
        }
    }

    private (int tableNo, string playerPosition) ParseAssignedTable(string assignedTable)
    {
        if (assignedTable == "Unassigned") return (0, "Unassigned");

        try
        {
            var parts = assignedTable.Split('_');
            if (parts.Length == 3)
            {
                var tableName = parts[1];
                var position = parts[2];
                var tableNo = int.Parse(tableName.Replace("Table ", ""));
                return (tableNo, position);
            }
        }
        catch (Exception ex)
        {
            // Console.WriteLine($"Error parsing assigned table: {ex.Message}");
        }
        return (0, "Unassigned");
    }

    private void RemoveTable(string tableName)
    {
        if (Tables.Contains(tableName))
        {
            Tables.Remove(tableName);
            foreach (var region in Regions!)
            {
                if (region.AssignedTable == $"{SelectedSet}_{tableName}_Player1" || region.AssignedTable == $"{SelectedSet}_{tableName}_Player2")
                {
                    region.AssignedTable = "Unassigned";
                }
            }

            // Remove score tracking for this table
            var key = $"{SelectedSet}_{tableName}";
            _tableScores.Remove(key);

            ClearResultIndicatorsForTable(tableName);
            Snackbar.Add($"{tableName} removed.", Severity.Info);
            StateHasChanged();
        }
    }

    private void RefreshStandingsAfterScoreUpdate()
    {
        StateHasChanged();
    }

    private async Task OpenEditEventDialog(string? selectedEventID)
    {
        var parameters = new DialogParameters<AddEditDialog>
        {
            { x => x.SelectedEventID, selectedEventID },
            { x => x.IsEditMode, true }
        };

        var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseOnEscapeKey = true,
                BackdropClick = false
            };

        var dialog = await DialogService.ShowAsync<AddEditDialog>("Edit Event", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadExistingBilliardsAssignments();
        }
    }

    private async Task ProceedToNextStage()
    {
        try
        {
            // 1. Validate current event
            if (SelectedEvent == null)
            {
                Snackbar.Add("No event selected. Please apply filters first.", Severity.Warning);
                return;
            }

            // 2. Check if all matches in current stage are completed
            var tablesWithResults = Tables.Where(table =>
                GetResultIndicator(table, "Player1") == "W" ||
                GetResultIndicator(table, "Player2") == "W"
            ).ToList();

            var tablesWithoutResults = Tables.Where(table =>
                GetResultIndicator(table, "Player1") == null &&
                GetResultIndicator(table, "Player2") == null &&
                Regions.Any(r => r.AssignedTable == $"{SelectedSet}_{table}_Player1" ||
                               r.AssignedTable == $"{SelectedSet}_{table}_Player2")
            ).ToList();

            if (tablesWithoutResults.Any())
            {
                Snackbar.Add($"Please complete all matches in current round before proceeding to next stage.", Severity.Warning);
                return;
            }

            if (!tablesWithResults.Any())
            {
                Snackbar.Add("No completed matches found. Please score matches first.", Severity.Warning);
                return;
            }

            // 3. Get current stage ID and next stage ID
            var currentStageId = await GetCurrentEventStageId();
            if (!currentStageId.HasValue)
            {
                Snackbar.Add("Could not determine current event stage.", Severity.Error);
                return;
            }

            var nextStageId = GetNextStageId(currentStageId.Value);
            if (nextStageId == 0)
            {
                Snackbar.Add("No next stage available for progression.", Severity.Warning);
                return;
            }

            // 4. Get the next stage name
            var nextStage = _eventStages?.FirstOrDefault(s => s.ID == nextStageId);
            if (nextStage == null)
            {
                Snackbar.Add($"Could not find stage with ID {nextStageId}", Severity.Error);
                return;
            }

            // 5. Fetch winners from EventVersusTeams with "Winner" rank
            var progressionTeams = new List<Dictionary<string, object>>();

            // Get EventVersusTeams for the current event
            var versusTeams = await apiService.GetAsync<EventsDTO.EventVersusTeams>(
                $"/Events/VersusTeams?eventID={SelectedEvent.ID}");

            if (versusTeams != null)
            {
                // Filter teams with "Winner" rank (case-insensitive)
                var winningTeams = versusTeams
                    .Where(t => !string.IsNullOrEmpty(t.Rank) &&
                               IsWinningRank(t.Rank))
                    .ToList();

                if (!winningTeams.Any())
                {
                    Snackbar.Add("No winning teams found with 'Winner' rank. Please mark winners in the current event first.", Severity.Warning);
                    return;
                }

                foreach (var team in winningTeams)
                {
                    // Get players for this team
                    var teamPlayers = await apiService.GetAsync<EventsDTO.EventVersusTeamPlayers>(
                        $"/Events/VersusTeams/Players?eventVersusID={team.ID}");

                    var selectedPlayerIds = new List<string>();
                    var playerNames = new List<string>();

                    if (teamPlayers != null && teamPlayers.Any())
                    {
                        foreach (var player in teamPlayers)
                        {
                            if (!string.IsNullOrEmpty(player.ProfilePlayerID))
                            {
                                selectedPlayerIds.Add(player.ProfilePlayerID);

                                // full name
                                var fullName = "";
                                if (!string.IsNullOrEmpty(player.FirstName) && !string.IsNullOrEmpty(player.LastName))
                                    fullName = $"{player.FirstName} {player.LastName}";
                                else if (!string.IsNullOrEmpty(player.FirstName))
                                    fullName = player.FirstName;
                                else if (!string.IsNullOrEmpty(player.LastName))
                                    fullName = player.LastName;
                                else
                                    fullName = player.ProfilePlayerID;

                                playerNames.Add(fullName);
                            }
                        }
                    }


                    // Add to progression teams 
                    var teamData = new Dictionary<string, object>
                        {
                            ["SelectedRegionID"] = team.SchoolRegionID,
                            ["ExistingVersusTeamID"] = team.ID,
                            ["Score"] = team.Score,
                            ["Rank"] = team.Rank,
                            ["SelectedPlayerIDs"] = selectedPlayerIds
                        };

                    progressionTeams.Add(teamData);
                }
            }

            // 6. Prepare dialog parameters for creating new event
            var parameters = new DialogParameters<AddEditDialog>
        {
            { x => x.IsProgressionMode, true },
            { x => x.PreviousEventID, SelectedEvent.ID },
            { x => x.ProgressionTeams, progressionTeams }
        };

            // 7. Open the dialog
            var options = new DialogOptions
                {
                    CloseButton = true,
                    MaxWidth = MaxWidth.Medium,
                    FullWidth = true,
                    CloseOnEscapeKey = true,
                    BackdropClick = false
                };

            var dialog = await DialogService.ShowAsync<AddEditDialog>("Create Next Stage Event", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled)
            {
                Snackbar.Add("Next stage event created successfully!", Severity.Success);

                await ApplyFilters();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error proceeding to next stage: {ex.Message}", Severity.Error);
        }
    }

    // Helper method to check if a rank is considered "winning"
    private bool IsWinningRank(string rank)
    {
        if (string.IsNullOrEmpty(rank)) return false;

        var winningRanks = new List<string>
    {
        "Winner",
        "Gold",
        "1st",
        "First",
        "Champion",
        "1",
        "Advance",
        "Qualified",
        "W",
        "Win",
        "Advancing"
    };

        return winningRanks.Any(r =>
            rank.Equals(r, StringComparison.OrdinalIgnoreCase) ||
            rank.Contains(r, StringComparison.OrdinalIgnoreCase));
    }

    private int GetNextStageId(int currentStageId)
    {
        // stages: 1=Elimination, 2=Quarter-finals, 3=Semi-finals, 4=Finals
        return currentStageId switch
        {
            1 => 2, 
            2 => 3, 
            3 => 4, 
            4 => 4,
            _ => 0  
        };
    }

 
    private async Task<int?> GetCurrentEventStageId()
    {
        if (SelectedEvent?.ID == null) return null;

        var eventUrl = $"/Events?id={SelectedEvent.ID}";
        var events = await apiService.GetAsync<EventsDTO.EventDetails>(eventUrl);

        if (events != null && events.Any())
        {
            return events.First().EventStageID;
        }

        return null;
    }

    // sync winners
    private async Task MarkWinnersInEventVersusTeams(string tableName, string winnerPosition, string loserPosition)
    {
        try
        {
            var winnerId = $"{SelectedSet}_{tableName}_{winnerPosition}";
            var loserId = $"{SelectedSet}_{tableName}_{loserPosition}";

            var winnerRegion = Regions!.FirstOrDefault(r => r.AssignedTable == winnerId);
            var loserRegion = Regions!.FirstOrDefault(r => r.AssignedTable == loserId);

            if (winnerRegion != null && loserRegion != null && SelectedEvent != null)
            {
                // Get EventVersusTeams for both regions
                var versusTeams = await apiService.GetAsync<EventsDTO.EventVersusTeams>(
                    $"/Events/VersusTeams?eventID={SelectedEvent.ID}");

                if (versusTeams != null)
                {
                    // Update winner
                    var winnerTeam = versusTeams.FirstOrDefault(t => t.SchoolRegionID == winnerRegion.Id);
                    if (winnerTeam != null)
                    {
                        var updateWinner = new EventsDTO.EventVersusTeams
                            {
                                ID = winnerTeam.ID,
                                Rank = "Winner",
                                Score = GetPlayerScore(tableName, winnerPosition).ToString()
                            };
                        await apiService.PutAsync($"/Events/VersusTeams/{winnerTeam.ID}", updateWinner);
                    }

                    // Update loser
                    var loserTeam = versusTeams.FirstOrDefault(t => t.SchoolRegionID == loserRegion.Id);
                    if (loserTeam != null)
                    {
                        var updateLoser = new EventsDTO.EventVersusTeams
                            {
                                ID = loserTeam.ID,
                                Rank = "Eliminated",
                                Score = GetPlayerScore(tableName, loserPosition).ToString()
                            };
                        await apiService.PutAsync($"/Events/VersusTeams/{loserTeam.ID}", updateLoser);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // Console.WriteLine($"Error marking winners in EventVersusTeams: {ex.Message}");
        }
    }
}