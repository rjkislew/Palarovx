@page "/score/gymnastics"
@using Admin.Palaro2026.Dialogs.ScorePage.Gymnastics

@inject APIService apiService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge">

    <MudTabs Centered="true" MinimumTabWidth="300px">
        <MudTabPanel Text="Events">
            <MudItem xs="12" Style="margin-top: 1rem;">
                <MudStack Class="flex-lg-row" Justify="Justify.FlexEnd" Style="margin-bottom: 1rem">
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                        <MudButton Variant="Variant.Text"
                                   Size="Size.Large"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="OpenDialogAsync"
                                   Class="ml-auto">
                            Add Gymnastics Event
                        </MudButton>
                        <MudDivider Vertical="true" FlexItem="true" />
                        <MudButton Size="Size.Large" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Refresh"
                                   OnClick="LoadDataAsync">
                            Refresh Table
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudItem>

            <MudTable Items="@_gymnasticsEvents" FixedHeader FixedFooter Height="calc(87vh - 150px)"
                      Context="gymnasticsEvent"
                      Outlined="true"
                      Elevation="1"
                      Style="border-radius: 8px; overflow: hidden;">

                <ColGroup>
                    <col style="width: 20%" />
                    <col style="width: 20%" />
                    <col style="width: 15%" />
                    <col style="width: 35%" />
                    <col style="width: 10%" />
                </ColGroup>

                <HeaderContent>
                    <MudTh>Event</MudTh>
                    <MudTh>School Level - Gender</MudTh>
                    <MudTh>Stage</MudTh>
                    <MudTh>Opposing Team</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd DataLabel="Event">
                        <MudText Typo="Typo.caption">@gymnasticsEvent.MainCategory</MudText>
                    </MudTd>
                    <MudTd DataLabel="School Level - Gender">
                        <MudText Typo="Typo.caption">
                            @GetSchoolLevelName(gymnasticsEvent.LevelID) - @GetGenderName(gymnasticsEvent.GenderID)
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Stage">
                        <MudText Typo="Typo.caption">@GetEventStageName(gymnasticsEvent.StageID)</MudText>
                    </MudTd>
                    <MudTd DataLabel="Opposing Team">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudVirtualize Items="@GetOpposingTeamsForEvent(gymnasticsEvent.ID)" Context="team">
                                    <MudTooltip Duration="0" Arrow="true">
                                        <ChildContent>
                                            <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small"
                                                     Class="pa-2 px-3 mx-1">
                                                @GetRegionAbbreviation(team.RegionID)
                                            </MudChip>
                                        </ChildContent>
                                        <TooltipContent>
                                            <MudVirtualize Items="@GetPlayersForTeam(team.RegionID, gymnasticsEvent.ID)"
                                                           Context="player">
                                                <MudStack Spacing="0">
                                                    <MudText Typo="Typo.caption">@player.FirstName @player.LastName</MudText>
                                                    @if (player != GetPlayersForTeam(team.RegionID, gymnasticsEvent.ID)?.Last())
                                                    {
                                                        <MudDivider />
                                                    }
                                                </MudStack>
                                            </MudVirtualize>
                                        </TooltipContent>
                                    </MudTooltip>
                                </MudVirtualize>
                            </MudItem>
                        </MudGrid>
                    </MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Settings"
                                       OnClick="() => OpenEditEventDialog(gymnasticsEvent.ID)" />
                    </MudTd>
                </RowTemplate>

                <NoRecordsContent>
                    <MudTd ColSpan="5" Class="text-center py-4">
                        <MudText>No events found.</MudText>
                    </MudTd>
                </NoRecordsContent>

                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Scoreboard">

            <!-- FILTERS SECTION -->
            <MudCard Class="pa-4 mb-4" Outlined="true">
                <MudText Typo="Typo.h6" Class="mb-4">Event Filters</MudText>
                <MudGrid Spacing="3" Justify="Justify.Center">

                    <MudItem xs="12" sm="3">
                        <MudSelect @bind-Value="_selectedSportIDValue" Margin="Margin.Dense" Label="Sport"
                                   T="int?"
                                   ShrinkLabel Variant="Variant.Outlined" Clearable ReadOnly="true"
                                   SelectedValuesChanged="@(async (_) => await FilterSchoolLevelAndGenderAsync())">
                            <MudVirtualize Items="_sports" Context="sport">
                                <MudSelectItem T="int?" Value="sport.ID">@sport.Sport</MudSelectItem>
                            </MudVirtualize>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="3">
                        <MudSelect @bind-Value="_selectedSchoolLevelAndGenderID" Margin="Margin.Dense"
                                   Label="School Level and Gender" T="string"
                                   ShrinkLabel Variant="Variant.Outlined" Clearable
                                   Disabled="_selectedSportIDValue == null"
                                   SelectedValuesChanged="@((values) => OnSchoolLevelGenderChanged())">
                            <MudVirtualize Items="_combinedSchoolLevelAndGenderNames" Context="combinedID">
                                <MudSelectItem T="string" Value="@combinedID">@combinedID</MudSelectItem>
                            </MudVirtualize>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="3">
                        <MudSelect @bind-Value="_selectedMainCategoryValue" Margin="Margin.Dense"
                                   Label="Event" T="string"
                                   SelectedValuesChanged="@((values) => OnMainCategoryChanged())"
                                   ShrinkLabel Variant="Variant.Outlined" Clearable
                                   Disabled="@(!_sportMainCat?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                            @foreach (var mc in _sportMainCat)
                            {
                                <MudSelectItem Value="@mc">@mc</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="3">
                        <MudSelect @bind-Value="_selectedEventStagesIDValue" Margin="Margin.Dense"
                                   Label="Stage" T="int?"
                                   ShrinkLabel Variant="Variant.Outlined" Clearable>
                            <MudVirtualize Items="_eventStages" Context="eventStage">
                                <MudSelectItem T="int?" Value="eventStage.ID">@eventStage.Stage</MudSelectItem>
                            </MudVirtualize>
                        </MudSelect>
                    </MudItem>
                </MudGrid>

                <!-- Action Buttons -->
                <MudGrid Class="mt-3" Justify="Justify.Center">
                    <MudItem xs="12" sm="4">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!IsApplyButtonEnabled)"
                                   OnClick="ApplyFilters" FullWidth StartIcon="@Icons.Material.Filled.Search">
                            Apply Filters
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                                   OnClick="ClearFilters" FullWidth StartIcon="@Icons.Material.Filled.Clear">
                            Clear Filters
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudCard>

            @if (_filtersApplied && _filteredGymnasticsEvents?.Any() == true)
            {
                @foreach (var evt in _filteredGymnasticsEvents)
                {
                    <!-- Event Header -->
                    <MudCard Class="mb-2" Outlined="true">
                        <MudCardContent>

                            @if (IsAerobicEvent(evt) && IsMixedGender(evt) && IsMixed(evt) && HasFiveToEightPlayersPerRegion(evt))
                            {
                                <MudText Typo="Typo.h6">
                                    (Aero) Aerobic Dance - @GetSchoolLevelName(evt.LevelID)
                                </MudText>
                            }

                            else if (IsAerobicEvent(evt) && IsSecondary(evt) && IsMixedGender(evt) && HasTwoPlayersPerRegion(evt))
                            {
                                <MudText Typo="Typo.h6">
                                    (Aero) Mixed Pair - @GetSchoolLevelName(evt.LevelID)
                                </MudText>
                            }

                            else if (IsAerobicEvent(evt) && IsMixedGender(evt) && HasThreePlayersPerRegion(evt))
                            {
                                <MudText Typo="Typo.h6">
                                    (Aero) Trio - @GetSchoolLevelName(evt.LevelID)
                                </MudText>
                            }

                            else if (IsAerobicEvent(evt))
                            {
                                <MudText Typo="Typo.h6">
                                    @($"{GetSportSubcategoryName(evt)} - {GetSchoolLevelName(evt.LevelID)}")
                                </MudText>
                            }

                            else
                            {
                                <MudText Typo="Typo.h6">
                                    @evt.MainCategory - @GetSchoolLevelName(evt.LevelID)
                                </MudText>
                            }

                        </MudCardContent>

                    </MudCard>


                    @if (IsWAGEventC1(evt) && IsElementaryGirls(evt))
                    {
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" SortLabel="Sort By" Outlined="true"
                                  Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 10%" />
                                <col style="width: 25%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Balance Beam</MudTh>
                                <MudTh Style="text-align: center">Floor Exercise</MudTh>
                                <MudTh Style="text-align: center">Single Bar</MudTh>
                                <MudTh Style="text-align: center">Vault</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Balance Beam" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 214) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 214)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 214)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Floor Exercise" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 216) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 216)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 216)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Single Bar" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 221) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 221)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 221)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Vault" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 223) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 223)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 223)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Score" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for WAG (C1) - Elementary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (GetEventStageName(evt.StageID)?.Contains("Elimination", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <MudStack Row>
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>
                                    <MudTable Items="@GetTeamRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.TeamTotal.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center"> 
                                                <MudButton Variant="Variant.Text"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               OnClick="@(async () => await AddTeamChampionshipScore(evt.ID, context.RegionID))">
                                                        Set Score
                                                </MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Individual All-Around Championship</MudText>
                                    <MudTable Items="@GetIndividualAllAroundRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Gymnast</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.PlayerName</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.Total.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddIndividualAllAroundScore(evt.ID, context.RegionID, context.PlayerID))">
                                                    Set Score
                                                </MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>
                            </MudStack>
                        }
                    }
                    else if (IsWAGEventC2(evt) && IsElementaryGirls(evt))
                    {
                        <!-- WAG - C2: Elementary Girls -->
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 15%" />
                                <col style="width: 20%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Balance Beam</MudTh>
                                <MudTh Style="text-align: center">Floor Exercise</MudTh>
                                <MudTh Style="text-align: center">Uneven Bars</MudTh>
                                <MudTh Style="text-align: center">Vault</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Balance Beam" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 215) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 215)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 215)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Floor Exercise" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 217) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 217)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 217)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Uneven Bars" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 220) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 220)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 220)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Vault" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 224) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 224)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 224)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Score" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for WAG (C2) - Elementary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (GetEventStageName(evt.StageID)?.Contains("Elimination", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <MudStack Row>
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>
                                    <MudTable Items="@GetTeamRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.TeamTotal.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                @if (HasTeamOrCombined(evt.ID, context.RegionID))
                                                {
                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               OnClick="@(async () => await AddTeamChampionshipScore(evt.ID, context.RegionID))">
                                                        Set Score
                                                    </MudButton>

                                                }
                                                else
                                                {
                                                    <MudButton StartIcon="@Icons.Material.Filled.Groups"
                                                               OnClick="@(async () => await SetAsTeam(evt.ID, context.RegionID))"
                                                               Variant="Variant.Filled"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               FullWidth="true">
                                                        Set as Team
                                                    </MudButton>
                                                }
                                            </MudTd>

                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Individual All-Around Championship</MudText>
                                    <MudTable Items="@GetIndividualAllAroundRanking(evt.ID)" Outlined="true"
                                              Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Gymnast</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.PlayerName</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.Total.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddIndividualAllAroundScore(evt.ID, context.RegionID, context.PlayerID))">
                                                    Set Score
                                                </MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>
                            </MudStack>
                        }
                    }
                    else if (IsWAGEventC3(evt) && IsSecondaryGirls(evt))
                    {
                        <!-- WAG - C3: Secondary Girls -->
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 15%" />
                                <col style="width: 20%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Balance Beam</MudTh>
                                <MudTh Style="text-align: center">Floor Exercise</MudTh>
                                <MudTh Style="text-align: center">Uneven Bars</MudTh>
                                <MudTh Style="text-align: center">Vault</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Balance Beam" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 243) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 243)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 243)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Floor Exercise" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 244) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 244)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 244)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Uneven Bars" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 247) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 247)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 247)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Vault" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 248) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 248)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 248)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Score" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for WAG (C3) - Secondary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (GetEventStageName(evt.StageID)?.Contains("Elimination", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <MudStack Row>
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>
                                    <MudTable Items="@GetTeamRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.TeamTotal.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                @if (HasTeamOrCombined(evt.ID, context.RegionID))
                                                {
                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               OnClick="@(async () => await AddTeamChampionshipScore(evt.ID, context.RegionID))">
                                                        Set Score
                                                    </MudButton>
                                                }
                                                else
                                                {
                                                    <MudButton StartIcon="@Icons.Material.Filled.Groups"
                                                               OnClick="@(async () => await SetAsTeam(evt.ID, context.RegionID))"
                                                               Variant="Variant.Filled"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               FullWidth="true">
                                                        Set as Team
                                                    </MudButton>
                                                }
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Individual All-Around Championship</MudText>
                                    <MudTable Items="@GetIndividualAllAroundRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Gymnast</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.PlayerName</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.Total.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddIndividualAllAroundScore(evt.ID, context.RegionID, context.PlayerID))">
                                                    Set Score
                                                </MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>
                            </MudStack>
                        }
                    }
                    else if (IsMAGEventC1(evt) && IsElementaryBoys(evt))
                    {
                        <!-- MAG: Men's Artistic Gymnastics -->
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 15%" />
                                <col style="width: 20%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Floor Exercise</MudTh>
                                <MudTh Style="text-align: center">Horizontal Bar</MudTh>
                                <MudTh Style="text-align: center">Pommel Horse</MudTh>
                                <MudTh Style="text-align: center">Vaulting Table</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Floor Exercise" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 197) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 197)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 197)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Horizontal Bar" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 198) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 198)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 198)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Pommel Horse" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 200) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 200)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 200)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Vaulting Table" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 201) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 201)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 201)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Score" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for MAG (C1) - Elementary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (GetEventStageName(evt.StageID)?.Contains("Elimination", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <MudStack Row>
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>
                                    <MudTable Items="@GetTeamRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.TeamTotal.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddTeamChampionshipScore(evt.ID, context.RegionID))">
                                                    Set Score
                                                </MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Individual All-Around Championship</MudText>
                                    <MudTable Items="@GetIndividualAllAroundRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Gymnast</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.PlayerName</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.Total.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddIndividualAllAroundScore(evt.ID, context.RegionID, context.PlayerID))">
                                                    Set Score
                                                </MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>
                            </MudStack>
                        }
                    }
                    else if (IsMAGEventC2(evt) && IsElementaryBoys(evt))
                    {
                        <!-- MAG: Men's Artistic Gymnastics -->
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 15%" />
                                <col style="width: 20%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Floor Exercise</MudTh>
                                <MudTh Style="text-align: center">Horizontal Bar</MudTh>
                                <MudTh Style="text-align: center">Pommel Horse</MudTh>
                                <MudTh Style="text-align: center">Vaulting Table</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Floor Exercise" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 203) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 203)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 203)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Horizontal Bar" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 204) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 204)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 204)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Pommel Horse" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 205) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 205)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 205)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Vaulting Table" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 206) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 206)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 206)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Score" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for MAG (C2) - Elementary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (GetEventStageName(evt.StageID)?.Contains("Elimination", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <MudStack Row>
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>
                                    <MudTable Items="@GetTeamRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.TeamTotal.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                @if (HasTeamOrCombined(evt.ID, context.RegionID))
                                                {
                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               OnClick="@(async () => await AddTeamChampionshipScore(evt.ID, context.RegionID))">
                                                        Set Score
                                                    </MudButton>
                                                }
                                                else
                                                {
                                                    <MudButton StartIcon="@Icons.Material.Filled.Groups"
                                                               OnClick="@(async () => await SetAsTeam(evt.ID, context.RegionID))"
                                                               Variant="Variant.Filled"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               FullWidth="true">
                                                        Set as Team
                                                    </MudButton>
                                                }
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Individual All-Around Championship</MudText>
                                    <MudTable Items="@GetIndividualAllAroundRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Gymnast</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.PlayerName</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.Total.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddIndividualAllAroundScore(evt.ID, context.RegionID, context.PlayerID))">
                                                    Set Score
                                                </MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>
                            </MudStack>
                        }
                    }
                    else if (IsMAGEventC3(evt) && IsSecondaryBoys(evt))
                    {
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 15%" />
                                <col style="width: 20%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Floor Exercise</MudTh>
                                <MudTh Style="text-align: center">Horizontal Bar</MudTh>
                                <MudTh Style="text-align: center">Pommel Horse</MudTh>
                                <MudTh Style="text-align: center">Vaulting Table</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Floor Exercise" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 231) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 231)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 231)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Horizontal Bar" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 232) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 232)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 232)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Pommel Horse" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 234) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 234)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 234)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Vaulting Table" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 236) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 236)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 236)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Score" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for MAG (C3) - Secondary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (GetEventStageName(evt.StageID)?.Contains("Elimination", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <MudStack Row>
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>
                                    <MudTable Items="@GetTeamRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.TeamTotal.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                @if (HasTeamOrCombined(evt.ID, context.RegionID))
                                                {
                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               OnClick="@(async () => await AddTeamChampionshipScore(evt.ID, context.RegionID))">
                                                        Set Score
                                                    </MudButton>
                                                }
                                                else
                                                {
                                                    <MudButton StartIcon="@Icons.Material.Filled.Groups"
                                                               OnClick="@(async () => await SetAsTeam(evt.ID, context.RegionID))"
                                                               Variant="Variant.Filled"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               FullWidth="true">
                                                        Set as Team
                                                    </MudButton>
                                                }
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Individual All-Around Championship</MudText>
                                    <MudTable Items="@GetIndividualAllAroundRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Gymnast</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.PlayerName</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.Total.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddIndividualAllAroundScore(evt.ID, context.RegionID, context.PlayerID))">
                                                    Set Score
                                                </MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>
                            </MudStack>
                        }
                    }
                    else if (IsRhythmicEvent(evt) && IsElementary(evt))
                    {
                        <!-- Rhythmic Gymnastics Elementary -->
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 15%" />
                                <col style="width: 20%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Ball</MudTh>
                                <MudTh Style="text-align: center">Freehand</MudTh>
                                <MudTh Style="text-align: center">Hoop</MudTh>
                                <MudTh Style="text-align: center">Rope</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Ball" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 209) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 209)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 209)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Freehand" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 210) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 210)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 210)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Hoop" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 211) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 211)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 211)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Rope" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 212) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 212)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 212)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Score" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Rhythmic Gymnastics - Elementary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (GetEventStageName(evt.StageID)?.Contains("Elimination", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <MudStack Row>
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>
                                    <MudTable Items="@GetTeamRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.TeamTotal.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                @if (HasTeamOrCombined(evt.ID, context.RegionID))
                                                {
                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               OnClick="@(async () => await AddTeamChampionshipScore_Rhythmic(evt.ID, context.RegionID))">
                                                        Set Score
                                                    </MudButton>
                                                }
                                                else
                                                {
                                                    <MudButton StartIcon="@Icons.Material.Filled.Groups"
                                                               OnClick="@(async () => await SetAsTeam(evt.ID, context.RegionID))"
                                                               Variant="Variant.Filled"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               FullWidth="true">
                                                        Set as Team
                                                    </MudButton>
                                                }
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Individual All-Around Championship</MudText>
                                    <MudTable Items="@GetIndividualAllAroundRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Gymnast</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.PlayerName</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.Total.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddIndividualAllAroundScore(evt.ID, context.RegionID, context.PlayerID))">
                                                    Set Score
                                                </MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>
                            </MudStack>
                        }
                    }
                    else if (IsRhythmicEvent(evt) && IsSecondary(evt))
                    {
                        <!-- Rhythmic Gymnastics Secondary -->
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 15%" />
                                <col style="width: 20%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                                <col style="width: 13%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Ball</MudTh>
                                <MudTh Style="text-align: center">Clubs</MudTh>
                                <MudTh Style="text-align: center">Hoop</MudTh>
                                <MudTh Style="text-align: center">Ribbon</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Ball" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 238) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 238)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 238)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Clubs" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 239) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 239)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 239)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Hoop" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 240) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 240)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 240)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Ribbon" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 241) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 241)
                                        </MudText>

                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 241)
                                        </MudText>

                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Score" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Rhythmic Gymnastics - Secondary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (GetEventStageName(evt.StageID)?.Contains("Elimination", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <MudStack Row>
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>
                                    <MudTable Items="@GetTeamRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.TeamTotal.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                @if (HasTeamOrCombined(evt.ID, context.RegionID))
                                                {
                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               OnClick="@(async () => await AddTeamChampionshipScore_Rhythmic(evt.ID, context.RegionID))">
                                                        Set Score
                                                    </MudButton>
                                                }
                                                else
                                                {
                                                    <MudButton StartIcon="@Icons.Material.Filled.Groups"
                                                               OnClick="@(async () => await SetAsTeam(evt.ID, context.RegionID))"
                                                               Variant="Variant.Filled"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               FullWidth="true">
                                                        Set as Team
                                                    </MudButton>
                                                }
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">Individual All-Around Championship</MudText>
                                    <MudTable Items="@GetIndividualAllAroundRanking(evt.ID)" Outlined="true" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Rank</MudTh>
                                            <MudTh>Gymnast</MudTh>
                                            <MudTh>Region</MudTh>
                                            <MudTh Style="text-align: center">Total Score</MudTh>
                                            <MudTh Style="text-align: center">Action</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd>@context.Rank</MudTd>
                                            <MudTd>@context.PlayerName</MudTd>
                                            <MudTd>@context.RegionName</MudTd>
                                            <MudTd Style="text-align: center">@context.Total.ToString("0.000")</MudTd>
                                            <MudTd Style="text-align: center">
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddIndividualAllAroundScore(evt.ID, context.RegionID, context.PlayerID))">
                                                    Set Score
                                                </MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                </MudItem>
                            </MudStack>
                        }
                    }
                    else if (IsAerobicEvent(evt) && IsElementary(evt) && IsElementaryGirls(evt))
                    {
                        <!-- Aerobic Gymnastics Elementary - Girls -->
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 30%" />
                                <col style="width: 40%" />
                                <col style="width: 20%" />
                                <col style="width: 10%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Individual Women</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Individual Women" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 193) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 193)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 193)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Individual Women - Elementary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>
                    }
                    else if (IsAerobicEvent(evt) && IsSecondary(evt) && IsSecondaryGirls(evt))
                    {
                        <!-- Aerobic Gymnastics Secondary - Girls -->
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 30%" />
                                <col style="width: 40%" />
                                <col style="width: 20%" />
                                <col style="width: 10%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Individual Women</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Individual Women" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 227) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 227)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 227)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Individual Women - Secondary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>
                    }
                    else if (IsAerobicEvent(evt) && IsElementary(evt) && IsElementaryBoys(evt))
                    {
                        <!-- Aerobic Gymnastics Elementary - Boys -->
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 30%" />
                                <col style="width: 40%" />
                                <col style="width: 20%" />
                                <col style="width: 10%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Individual Men</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Individual Men" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 192) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 192)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 192)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Individual Men - Elementary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>
                    }
                    else if (IsAerobicEvent(evt) && IsSecondary(evt) && IsSecondaryBoys(evt))
                    {
                        <!-- Aerobic Gymnastics Secondary - Boys -->
                        <MudTable Items="@GetEventIndividualScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 30%" />
                                <col style="width: 40%" />
                                <col style="width: 20%" />
                                <col style="width: 10%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Gymnast</MudTh>
                                <MudTh Style="text-align: center">Individual Men</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Gymnast">@context.Gymnast</MudTd>
                                <MudTd DataLabel="Individual Men" Style="text-align: center">
                                    @if (GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 226) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetScoreForApparatus(evt.ID, context.RegionID, context.PlayerID, 226)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 226)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddScores(evt.ID, context.RegionID, context.PlayerID))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Individual Men - Secondary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>
                    }
                    else if (IsAerobicEvent(evt) && IsElementary(evt) && IsMixedGender(evt) && HasTwoPlayersPerRegion(evt))
                    {
                        <!-- Aerobic Gymnastics Elementary - Mixed Pair (2 players) -->
                        <MudTable Items="@GetEventTeamScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 25%" />
                                <col style="width: 35%" />
                                <col style="width: 20%" />
                                <col style="width: 20%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Team Members</MudTh>
                                <MudTh Style="text-align: center">Mixed Pair</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Team Members">
                                    @foreach (var gymnast in context.TeamGymnasts)
                                    {
                                        <MudText Typo="Typo.body2">@gymnast</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Mixed Pair" Style="text-align: center">
                                    @if (GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 194) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 194)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetTeamRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 194)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddTeamScores(evt.ID, context.RegionID, context.TeamPlayerIDs))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Mixed Pair - Elementary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>
                    }
                    else if (IsAerobicEvent(evt) && IsSecondary(evt) && IsMixedGender(evt) && HasTwoPlayersPerRegion(evt))
                    {
                        <!-- Aerobic Gymnastics Secondary - Mixed Pair (2 players) -->
                        <MudTable Items="@GetEventTeamScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 25%" />
                                <col style="width: 35%" />
                                <col style="width: 20%" />
                                <col style="width: 20%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Team Members</MudTh>
                                <MudTh Style="text-align: center">Mixed Pair</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Team Members">
                                    @foreach (var gymnast in context.TeamGymnasts)
                                    {
                                        <MudText Typo="Typo.body2">@gymnast</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Mixed Pair" Style="text-align: center">
                                    @if (GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 228) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 228)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetTeamRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 228)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddTeamScores(evt.ID, context.RegionID, context.TeamPlayerIDs))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Mixed Pair - Secondary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>
                    }
                    else if (IsAerobicEvent(evt) && IsElementary(evt) && IsMixedGender(evt) && HasThreePlayersPerRegion(evt))
                    {
                        <!-- Aerobic Gymnastics Elementary - Trio (3 players) -->
                        <MudTable Items="@GetEventTeamScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 25%" />
                                <col style="width: 35%" />
                                <col style="width: 20%" />
                                <col style="width: 20%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Team Members</MudTh>
                                <MudTh Style="text-align: center">Trio</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Team Members">
                                    @foreach (var gymnast in context.TeamGymnasts)
                                    {
                                        <MudText Typo="Typo.body2">@gymnast</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Trio" Style="text-align: center">
                                    @if (GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 196) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 196)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetTeamRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 196)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddTeamScores(evt.ID, context.RegionID, context.TeamPlayerIDs))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Trio - Elementary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>
                    }
                    else if (IsAerobicEvent(evt) && IsSecondary(evt) && IsMixedGender(evt) && HasThreePlayersPerRegion(evt))
                    {
                        <!-- Aerobic Gymnastics Secondary - Trio (3 players) -->
                        <MudTable Items="@GetEventTeamScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 25%" />
                                <col style="width: 35%" />
                                <col style="width: 20%" />
                                <col style="width: 20%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Team Members</MudTh>
                                <MudTh Style="text-align: center">Trio</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Team Members">
                                    @foreach (var gymnast in context.TeamGymnasts)
                                    {
                                        <MudText Typo="Typo.body2">@gymnast</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Trio" Style="text-align: center">
                                    @if (GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 230) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 230)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetTeamRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 230)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddTeamScores(evt.ID, context.RegionID, context.TeamPlayerIDs))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Trio - Secondary Level</MudText>
                            </NoRecordsContent>
                        </MudTable>
                    }
                    else if (IsAerobicEvent(evt) && IsMixedGender(evt) && IsMixed(evt) && HasFiveToEightPlayersPerRegion(evt))
                    {
                        <!-- Aerobic Gymnastics - Aerobic Dance (5-8 players) -->
                        <MudTable Items="@GetEventTeamScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 20%" />
                                <col style="width: 40%" />
                                <col style="width: 20%" />
                                <col style="width: 20%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Team Members</MudTh>
                                <MudTh Style="text-align: center">Aerobic Dance</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Team Members">
                                    <MudStack Spacing="0">
                                        @foreach (var gymnast in context.TeamGymnasts)
                                        {
                                            <MudText Typo="Typo.body2" Class="mb-1">@gymnast</MudText>
                                        }
                                    </MudStack>
                                </MudTd>
                                <MudTd DataLabel="Aerobic Dance" Style="text-align: center">
                                    @if (GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 520) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 520)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetTeamRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 520)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddTeamScores(evt.ID, context.RegionID, context.TeamPlayerIDs))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Aerobic Dance</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (ShouldShowAerobicTeamChampionship(evt))
                        {
                            <MudItem xs="12" Class="mb-3">
                                <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>

                                <MudTable Items="@GetAerobicTeamChampionshipRanking()" Outlined="true" Dense="true">
                                    <HeaderContent>
                                        <MudTh>No.</MudTh>
                                        <MudTh>Region</MudTh>
                                        <MudTh Style="text-align: center">Action</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>@context.Rank</MudTd>
                                        <MudTd>@context.RegionName</MudTd>
                                        <MudTd Style="text-align: center">
                                            @if (HasTeamOrCombined(evt.ID, context.RegionID, isAerobicTeamChampionship: true))
                                            {
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddAerobicTeamChampionshipScore(evt.ID, context.RegionID))">
                                                    Set Score
                                                </MudButton>
                                            }
                                            else
                                            {
                                                <MudButton StartIcon="@Icons.Material.Filled.Groups"
                                                           OnClick="@(async () => await SetAsTeam(evt.ID, context.RegionID, isAerobicTeamChampionship: true))"
                                                           Variant="Variant.Filled"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           FullWidth="true">
                                                    Set as Team
                                                </MudButton>
                                            }
                                        </MudTd>

                                    </RowTemplate>

                                    <NoRecordsContent>
                                        <MudText>No aerobic team championship data found.</MudText>
                                    </NoRecordsContent>
                                </MudTable>
                            </MudItem>
                        }

                    }
                    else if (IsAerobicEvent(evt) && IsMixedGender(evt) && IsElementary(evt) && HasFiveToEightPlayersPerRegion(evt))
                    {
                        <!-- Aerobic Gymnastics - Aerobic Dance (5-8 players) -->
                        <MudTable Items="@GetEventTeamScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 20%" />
                                <col style="width: 40%" />
                                <col style="width: 20%" />
                                <col style="width: 20%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Team Members</MudTh>
                                <MudTh Style="text-align: center">Aerobic Dance</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Team Members">
                                    <MudStack Spacing="0">
                                        @foreach (var gymnast in context.TeamGymnasts)
                                        {
                                            <MudText Typo="Typo.body2" Class="mb-1">@gymnast</MudText>
                                        }
                                    </MudStack>
                                </MudTd>
                                <MudTd DataLabel="Aerobic Dance" Style="text-align: center">
                                    @if (GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 518) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 518)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetTeamRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 518)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddTeamScores(evt.ID, context.RegionID, context.TeamPlayerIDs))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Aerobic Dance</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (ShouldShowAerobicTeamChampionship(evt))
                        {
                            <MudItem xs="12" Class="mb-3">
                                <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>

                                <MudTable Items="@GetAerobicTeamChampionshipRanking()" Outlined="true" Dense="true">
                                    <HeaderContent>
                                        <MudTh>Rank</MudTh>
                                        <MudTh>Region</MudTh>
                                        <MudTh Style="text-align: center">Total Points</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>@context.Rank</MudTd>
                                        <MudTd>@context.RegionName</MudTd>
                                        <MudTd Style="text-align: center">@context.TeamTotal.ToString("0")</MudTd>
                                        <MudTd Style="text-align: center">
                                            @if (HasTeamOrCombined(evt.ID, context.RegionID, isAerobicTeamChampionship: true))
                                            {
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddAerobicTeamChampionshipScore(evt.ID, context.RegionID))">
                                                    Set Score
                                                </MudButton>
                                            }
                                            else
                                            {
                                                <MudButton StartIcon="@Icons.Material.Filled.Groups"
                                                           OnClick="@(async () => await SetAsTeam(evt.ID, context.RegionID, isAerobicTeamChampionship: true))"
                                                           Variant="Variant.Filled"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           FullWidth="true">
                                                    Set as Team
                                                </MudButton>
                                            }
                                        </MudTd>

                                    </RowTemplate>
                                </MudTable>
                            </MudItem>
                        }

                    }
                    else if (IsAerobicEvent(evt) && IsMixedGender(evt) && IsSecondary(evt) && HasFiveToEightPlayersPerRegion(evt))
                    {
                        <!-- Aerobic Gymnastics - Aerobic Dance (5-8 players) -->
                        <MudTable Items="@GetEventTeamScoreboardData(evt.ID)" Outlined="true" Elevation="1"
                                  Style="border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                            <ColGroup>
                                <col style="width: 20%" />
                                <col style="width: 40%" />
                                <col style="width: 20%" />
                                <col style="width: 20%" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Region</MudTh>
                                <MudTh>Team Members</MudTh>
                                <MudTh Style="text-align: center">Aerobic Dance</MudTh>
                                <MudTh Style="text-align: center">Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Region">@context.Region</MudTd>
                                <MudTd DataLabel="Team Members">
                                    <MudStack Spacing="0">
                                        @foreach (var gymnast in context.TeamGymnasts)
                                        {
                                            <MudText Typo="Typo.body2" Class="mb-1">@gymnast</MudText>
                                        }
                                    </MudStack>
                                </MudTd>
                                <MudTd DataLabel="Aerobic Dance" Style="text-align: center">
                                    @if (GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 519) > 0)
                                    {
                                        <MudText Typo="Typo.body2">
                                            @GetTeamScoreForApparatus(evt.ID, context.RegionID, context.TeamPlayerIDs, 519)
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Rank: @GetTeamRankForApparatus(evt.ID, context.RegionID, context.PlayerID, 519)
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2">-</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Action" Style="text-align: center">
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => AddTeamScores(evt.ID, context.RegionID, context.TeamPlayerIDs))">
                                        Set Score
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText>No event found for Aerobic Dance</MudText>
                            </NoRecordsContent>
                        </MudTable>

                        @if (ShouldShowAerobicTeamChampionship(evt))
                        {
                            <MudItem xs="12" Class="mb-3">
                                <MudText Typo="Typo.h6" Align="Align.Center">Team Championship</MudText>

                                <MudTable Items="@GetAerobicTeamChampionshipRanking()" Outlined="true" Dense="true">
                                    <HeaderContent>
                                        <MudTh>Rank</MudTh>
                                        <MudTh>Region</MudTh>
                                        <MudTh Style="text-align: center">Actions</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>@context.Rank</MudTd>
                                        <MudTd>@context.RegionName</MudTd>
                                        <MudTd Style="text-align: center">
                                            @if (HasTeamOrCombined(evt.ID, context.RegionID, isAerobicTeamChampionship: true))
                                            {
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(async () => await AddAerobicTeamChampionshipScore(evt.ID, context.RegionID))">
                                                    Set Score
                                                </MudButton>
                                            }
                                            else
                                            {
                                                <MudButton StartIcon="@Icons.Material.Filled.Groups"
                                                           OnClick="@(async () => await SetAsTeam(evt.ID, context.RegionID, isAerobicTeamChampionship: true))"
                                                           Variant="Variant.Filled"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           FullWidth="true">
                                                    Set as Team
                                                </MudButton>
                                            }
                                        </MudTd>

                                    </RowTemplate>
                                </MudTable>
                            </MudItem>
                        }

                    }
                }
            }

            @if (!_filtersApplied)
            {
                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.Center" Style="margin-top: 3rem;">
                    <MudText Typo="Typo.h6" Class="ma-4">
                        Apply filter to view events.
                    </MudText>
                </MudStack>
            }
            else if (_filtersApplied && !_filteredGymnasticsEvents.Any())
            {
                <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="margin-top: 3rem;">
                    <MudText Typo="Typo.h6" Class="ma-4">No Results Found</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Default">
                        No event matches your filter criteria. Try adjusting your selections.
                    </MudText>
                </MudStack>
            }
        </MudTabPanel>
    </MudTabs>

</MudContainer>

@code {
    private List<SportsDTO.SportCategories>? _sportCategories;
    private List<SportsDTO.SportGenderCategories>? _sportGenderCategories;
    private List<SchoolsDTO.SchoolLevels>? _schoolLevels;
    private List<SportsDTO.SportSubcategories>? _sportSubcategories;
    private List<EventsDTO.EventStages>? _eventStages;
    private List<PerformanceBasedDTO.PerformanceEvent>? _gymnasticsEvents;
    private List<PerformanceBasedDTO.PerformanceTeam>? _allOpposingTeams;
    private List<SchoolsDTO.SchoolRegion>? _schoolRegions;
    private List<ProfilePlayersDTO.Players>? _allPlayers;
    private List<PerformanceBasedDTO.PerformanceScore> _allScores = new();
    private List<PerformanceBasedDTO.PerformanceEvent> _filteredGymnasticsEvents = new();

    private string? _selectedSchoolLevelAndGenderID;
    private List<string> _combinedSchoolLevelAndGenderNames = new();
    private int? _selectedEventStagesIDValue;
    private List<string> _filteredSchoolLevelAndGenderNames = new();
    private string? _selectedMainCategoryValue;
    private List<string> _sportMainCat = new();
    private int? _selectedSportSubcategoryIDValue;
    private int? _selectedSportCategoryIDValue = 1;
    private int? _selectedSportIDValue = 13;
    private List<SportsDTO.Sports>? _sports;

    private bool _isEventDialogOpen = false;
    private string? _selectedEventID;
    private bool _isEditMode = false;
    private bool _filtersApplied = false;

    private bool _showScoreboard = false;

    private PerformanceBasedDTO.PerformanceEvent? _selectedEvent;
    private List<ScoreboardItem> _scoreboardData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _selectedSportCategoryIDValue = 1;
        _selectedSportIDValue = 13; // Sport ID = 13 (Gymnastics)

        await GetSportsAsync();
        await GetGymnasticsEventsAsync();
        await GetEventStagesAsync();
        await GetGenderCategoriesAsync();
        await GetSchoolLevelsAsync();
        await GetOpposingTeamsAsync();
        await GetSportSubCategoriesAsync();
        await GetSchoolRegionsAsync();
        await GetAllPlayersAsync();
        await FilterSchoolLevelAndGenderAsync();
        LoadMainCategories();
        _filteredSchoolLevelAndGenderNames = _combinedSchoolLevelAndGenderNames;
    }

    private async Task GetGymnasticsEventsAsync()
    {
        string url = "/PerformanceBased/PerformanceEvents?sportID=13";
        _gymnasticsEvents = await apiService.GetAsync<PerformanceBasedDTO.PerformanceEvent>(url);
        StateHasChanged();
    }

    private async Task GetOpposingTeamsAsync()
    {
        string url = "/PerformanceBased/OpposingTeams";
        _allOpposingTeams = await apiService.GetAsync<PerformanceBasedDTO.PerformanceTeam>(url);
        StateHasChanged();
    }

    private List<PerformanceBasedDTO.PerformanceTeam> GetOpposingTeamsForEvent(int eventId)
{
    return _allOpposingTeams?
        .Where(t =>
            t.PerformanceID == eventId &&
            t.RegionID != 0 &&
            IsEditableTeamId(t.TeamID))          // ✅ exclude unique TeamIDs
        .GroupBy(t => t.RegionID)
        .Select(g => g.First())
        .ToList()
        ?? new List<PerformanceBasedDTO.PerformanceTeam>();
}


    private async Task GetSportsAsync()
    {
        string url = "/Sports";
        _sports = await apiService.GetAsync<SportsDTO.Sports>(url);
    }

    private async Task GetEventStagesAsync()
    {
        string url = "/Events/Stages";
        _eventStages = await apiService.GetAsync<EventsDTO.EventStages>(url);
    }

    private async Task GetGenderCategoriesAsync()
    {
        string url = "/Sports/GenderCategories";
        _sportGenderCategories = await apiService.GetAsync<SportsDTO.SportGenderCategories>(url);
    }

    private async Task GetSchoolLevelsAsync()
    {
        string url = "/Schools/Levels";
        _schoolLevels = await apiService.GetAsync<SchoolsDTO.SchoolLevels>(url);
        await GetSportSubCategoriesAsync();
    }

    private async Task GetSchoolRegionsAsync()
    {
        string url = "/Schools/Regions";
        _schoolRegions = await apiService.GetAsync<SchoolsDTO.SchoolRegion>(url);
    }

    private async Task GetAllPlayersAsync()
    {
        string url = $"/Profiles/Player";
        _allPlayers = await apiService.GetAsync<ProfilePlayersDTO.Players>(url);
    }

    private async Task GetSportSubCategoriesAsync()
    {
        string url = $"/Sports/Subcategories?sportID={_selectedSportIDValue}";
        _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(url);
    }

    private void LoadMainCategories()
    {
        if (_selectedSportIDValue == null || string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
        {
            _sportMainCat = new List<string>();
            return;
        }

        _sportMainCat = _sportSubcategories?.Where(sc => !string.IsNullOrEmpty(sc.MainCategory))
            .Select(sc => sc.MainCategory!)
            .Distinct()
            .ToList() ?? new List<string>();
    }

    private string GetSchoolLevelName(int? schoolLevelId)
    {
        if (!schoolLevelId.HasValue) return "Unknown";
        var level = _schoolLevels?.FirstOrDefault(sl => sl.ID == schoolLevelId.Value);
        return level?.Level ?? "Unknown";
    }

    private List<ProfilePlayersDTO.Players> GetPlayersForTeam(int regionId, int eventId)
    {
        var playerIds = _allOpposingTeams?
            .Where(t =>
                t.PerformanceID == eventId &&
                t.RegionID == regionId &&
                IsEditableTeamId(t.TeamID))          // ✅ exclude unique TeamIDs
            .Select(t => t.PlayerID)
            .Where(pid => !string.IsNullOrWhiteSpace(pid))
            .Distinct()
            .ToList()
            ?? new List<string>();

        return _allPlayers?
            .Where(p => playerIds.Contains(p.ID))
            .ToList()
            ?? new List<ProfilePlayersDTO.Players>();
    }


    private string GetGenderName(int? genderCategoryId)
    {
        if (!genderCategoryId.HasValue) return "Unknown";
        var gender = _sportGenderCategories?.FirstOrDefault(g => g.ID == genderCategoryId.Value);
        return gender?.Gender ?? "Unknown";
    }

    private string GetEventStageName(int? eventStageId)
    {
        if (!eventStageId.HasValue) return "Unknown";
        var stage = _eventStages?.FirstOrDefault(es => es.ID == eventStageId.Value);
        return stage?.Stage ?? "Unknown";
    }

    private string GetSportSubcategoryName(PerformanceBasedDTO.PerformanceEvent evt)
    {
        var sub = _sportSubcategories.FirstOrDefault(s =>
            s.SportID == evt.SportID &&
            s.SchoolLevelID == evt.LevelID &&
            s.MainCategory == evt.MainCategory);

        return sub?.Subcategory ?? string.Empty;
    }


    //FILTERS

    private async Task ApplyFilters()
    {
        try
        {
            if (_gymnasticsEvents == null)
            {
                Snackbar.Add("No events available.", Severity.Warning);
                return;
            }

            var query = _gymnasticsEvents.AsQueryable();

            // SPORT
            if (_selectedSportIDValue != null)
                query = query.Where(e => e.SportID == _selectedSportIDValue);

            // SCHOOL LEVEL + GENDER
            if (!string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
            {
                var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
                var schoolLevelID = _schoolLevels?.FirstOrDefault(x => x.Level == parts[0])?.ID;
                var genderID = _sportGenderCategories?.FirstOrDefault(x => x.Gender == parts[1])?.ID;

                if (schoolLevelID != null)
                    query = query.Where(e => e.LevelID == schoolLevelID);

                if (genderID != null)
                    query = query.Where(e => e.GenderID == genderID);
            }

            // MAIN CATEGORY
            if (!string.IsNullOrWhiteSpace(_selectedMainCategoryValue))
                query = query.Where(e => e.MainCategory == _selectedMainCategoryValue);

            // EVENT STAGE
            if (_selectedEventStagesIDValue != null)
                query = query.Where(e => e.StageID == _selectedEventStagesIDValue);

            _filteredGymnasticsEvents = query.ToList();
            _filtersApplied = true;

            await LoadScoreboardDataForFilteredEvents();

            Snackbar.Add("Filters applied", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error applying filters: {ex.Message}", Severity.Error);
        }
    }

    private async Task ClearFilters()
    {
        // Clear only the selected values
        _selectedSchoolLevelAndGenderID = null;
        _selectedMainCategoryValue = null;
        _selectedEventStagesIDValue = null;

        if (_selectedSportIDValue != null)
        {
            await FilterSchoolLevelAndGenderAsync();
            LoadMainCategories();
        }
        else
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            _sportMainCat = new List<string>();
        }

        _filteredGymnasticsEvents = new List<PerformanceBasedDTO.PerformanceEvent>();

        Snackbar.Add("Filters cleared", Severity.Info);
        StateHasChanged();
    }

    private bool IsApplyButtonEnabled =>
        _selectedSportIDValue != null &&
        !string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID) &&
        !string.IsNullOrEmpty(_selectedMainCategoryValue) &&
        _selectedEventStagesIDValue != null;

    private async Task LoadScoreboardDataForFilteredEvents()
    {
        if (_filteredGymnasticsEvents == null || !_filteredGymnasticsEvents.Any())
        {
            _scoreboardData = new List<ScoreboardItem>();
            return;
        }

        try
        {
            _scoreboardData = new List<ScoreboardItem>();

            if (_allOpposingTeams == null || _schoolRegions == null || _allPlayers == null)
            {
                await LoadSupportingData();
            }

            var eventIds = _filteredGymnasticsEvents.Select(e => e.ID).ToList();

            var eventTeams = _allOpposingTeams?
                .Where(t => eventIds.Contains(t.PerformanceID))
                .ToList() ?? new List<PerformanceBasedDTO.PerformanceTeam>();

            var individualPlayers = eventTeams
                .Where(t => !t.TeamID.HasValue)
                .ToList();

            foreach (var team in individualPlayers)
            {
                var region = _schoolRegions?.FirstOrDefault(r => r.ID == team.RegionID);
                var player = _allPlayers?.FirstOrDefault(p => p.ID == team.PlayerID);

                if (region != null && player != null)
                {
                    _scoreboardData.Add(new ScoreboardItem
                    {
                        RegionID = team.RegionID,
                        Region = region.Abbreviation ?? region.Region,
                        PlayerID = team.PlayerID,
                        Gymnast = $"{player.FirstName} {player.LastName}",
                        TeamID = null,
                        TeamPlayerIDs = new List<string> { team.PlayerID },
                        TeamGymnasts = new List<string> { $"{player.FirstName} {player.LastName}" },
                        PerformanceID = team.PerformanceID
                    });
                }
            }

            var teamGroups = eventTeams
                .Where(team => team.TeamID.HasValue)
                .GroupBy(team => new { team.RegionID, team.TeamID, team.PerformanceID })
                .ToList();

            foreach (var teamGroup in teamGroups)
            {
                var region = _schoolRegions?.FirstOrDefault(r => r.ID == teamGroup.Key.RegionID);
                if (region == null) continue;

                var teamPlayers = new List<string>();
                var teamGymnastNames = new List<string>();

                foreach (var team in teamGroup)
                {
                    var player = _allPlayers?.FirstOrDefault(p => p.ID == team.PlayerID);
                    if (player != null)
                    {
                        teamPlayers.Add(team.PlayerID);
                        teamGymnastNames.Add($"{player.FirstName} {player.LastName}");
                    }
                }

                if (teamPlayers.Any())
                {
                    _scoreboardData.Add(new ScoreboardItem
                    {
                        RegionID = teamGroup.Key.RegionID,
                        Region = region.Abbreviation ?? region.Region,
                        PlayerID = teamPlayers.First(),
                        Gymnast = string.Join(" / ", teamGymnastNames),
                        TeamID = teamGroup.Key.TeamID,
                        TeamPlayerIDs = teamPlayers,
                        TeamGymnasts = teamGymnastNames,
                        PerformanceID = teamGroup.Key.PerformanceID
                    });
                }
            }

            await LoadAllScoresForFilteredEvents(eventIds);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading scoreboard: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAllScoresForFilteredEvents(List<int> filteredEventIds)
    {
        try
        {
            if (filteredEventIds == null || !filteredEventIds.Any())
            {
                _allScores = new List<PerformanceBasedDTO.PerformanceScore>();
                return;
            }

            // Get ALL event IDs needed (including combined events for Elementary)
            var allEventIdsNeeded = new HashSet<int>();

            foreach (var eventId in filteredEventIds)
            {
                var eventObj = _gymnasticsEvents?.FirstOrDefault(e => e.ID == eventId);
                if (eventObj != null)
                {
                    var schoolLevelName = GetSchoolLevelName(eventObj.LevelID);
                    bool isElementary = schoolLevelName?.Contains("Elementary", StringComparison.OrdinalIgnoreCase) == true;

                    if (isElementary)
                    {
                        // For elementary, get combined events (C1 + C2)
                        var eventStageId = eventObj.StageID; // Get the stage ID
                        var combinedIds = GetCombinedEventIds(eventId, true, eventStageId);
                        foreach (var id in combinedIds)
                        {
                            allEventIdsNeeded.Add(id);
                        }
                    }
                    else
                    {
                        // For non-elementary, just add the event
                        allEventIdsNeeded.Add(eventId);
                    }
                }
            }

            // Load scores for all needed events
            _allScores = new List<PerformanceBasedDTO.PerformanceScore>();
            foreach (var eventId in allEventIdsNeeded)
            {
                try
                {
                    string url = $"/PerformanceScore/Score/{eventId}";
                    var eventScores = await apiService.GetAsync<PerformanceBasedDTO.PerformanceScore>(url)
                                      ?? new List<PerformanceBasedDTO.PerformanceScore>();
                    _allScores.AddRange(eventScores);
                }
                catch (Exception ex)
                {
                    // Log but continue
                    Console.WriteLine($"Error loading scores for event {eventId}: {ex.Message}");
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading scores: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenDialogAsync()
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true,
            BackdropClick = false
        };

        var dialog = await DialogService.ShowAsync<AddGymnasticsEvent>("Add Event", options);

        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await GetGymnasticsEventsAsync();
            await GetOpposingTeamsAsync();
        }
    }

    private async Task OnSchoolLevelGenderChanged()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
        {
            _selectedMainCategoryValue = null;
            _sportMainCat = new List<string>();
        }
        else
        {
            await GetSportSubCategoriesSLGAsync();
            LoadMainCategories();
        }

        StateHasChanged();
    }

    private async Task GetSportSubCategoriesSLGAsync()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
            return;
        }

        var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
        var schoolLevelName = parts[0];
        var genderName = parts[1];

        var schoolLevelID = _schoolLevels.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
        var genderID = _sportGenderCategories.FirstOrDefault(x => x.Gender == genderName)?.ID;

        if (schoolLevelID != null && genderID != null)
        {
            _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(
                $"/Sports/Subcategories?sportID={_selectedSportIDValue}&schoolLevelID={schoolLevelID}&sportGenderCategoryID={genderID}");
        }
        else
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        }
    }

    private async Task FilterSchoolLevelAndGenderAsync()
    {
        if (_selectedSportIDValue == null)
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            StateHasChanged();
            return;
        }

        var subcats = await apiService.GetAsync<SportsDTO.SportSubcategories>(
            $"/Sports/Subcategories?sportID={_selectedSportIDValue}");

        if (subcats == null || !subcats.Any())
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var schoolLevelIDs = subcats.Where(x => x.SchoolLevelID.HasValue).Select(x => x.SchoolLevelID.Value).Distinct();
        var genderIDs = subcats.Where(x => x.SportGenderCategoryID.HasValue).Select(x => x.SportGenderCategoryID.Value).Distinct();

        var schoolLevelNames = _schoolLevels?.Where(s => schoolLevelIDs.Contains(s.ID)).Select(s => s.Level) ?? new List<string>();
        var genderNames = _sportGenderCategories?.Where(g => genderIDs.Contains(g.ID)).Select(g => g.Gender) ?? new List<string>();

        _combinedSchoolLevelAndGenderNames = schoolLevelNames.SelectMany(s => genderNames, (s, g) => $"{s} - {g}").ToList();
    }

    private async Task OnMainCategoryChanged()
    {
        LoadMainCategories();
        StateHasChanged();
    }

    private async Task OpenEditEventDialog(int? selectedEventID)
    {
        var parameters = new DialogParameters<AddGymnasticsEvent>
        {
            { x => x.SelectedEventID, selectedEventID },
            { x => x.IsEditMode, true }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true,
            BackdropClick = false
        };

        var dialog = await DialogService.ShowAsync<AddGymnasticsEvent>("Edit Event", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadDataAsync();
        }
    }

    private bool HasScores(int eventId)
    {
        return _allScores?.Any(score => score.PerformanceID == eventId) == true;
    }

    //SCOREBOARD

    private string GetRegionAbbreviation(int regionId)
    {
        var region = _schoolRegions?.FirstOrDefault(r => r.ID == regionId);
        return region?.Abbreviation ?? regionId.ToString();
    }

    private async Task LoadSupportingData()
    {
        var tasks = new List<Task>
        {
            LoadAllScores()
        };

        await Task.WhenAll(tasks);
    }

    private async Task LoadAllScores()
    {
        try
        {
            if (_selectedEvent?.ID == null)
            {
                _allScores = new List<PerformanceBasedDTO.PerformanceScore>();
                return;
            }

            string url = $"/PerformanceScore/Score/{_selectedEvent.ID}";
            _allScores = await apiService.GetAsync<PerformanceBasedDTO.PerformanceScore>(url) ?? new List<PerformanceBasedDTO.PerformanceScore>();

            await CalculateAndSaveRanks();

            _allScores = await apiService.GetAsync<PerformanceBasedDTO.PerformanceScore>(url) ?? new List<PerformanceBasedDTO.PerformanceScore>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading scores: {ex.Message}", Severity.Error);
        }
    }

    private bool IsWAGEventC1(PerformanceBasedDTO.PerformanceEvent evt) =>
        evt?.MainCategory?.Contains("Women's Artistic Gymnastics (C1)", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsWAGEventC2(PerformanceBasedDTO.PerformanceEvent evt) =>
        evt?.MainCategory?.Contains("Women's Artistic Gymnastics (C2)", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsWAGEventC3(PerformanceBasedDTO.PerformanceEvent evt) =>
        evt?.MainCategory?.Contains("Women's Artistic Gymnastics (C3)", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsMAGEventC1(PerformanceBasedDTO.PerformanceEvent evt) =>
        evt?.MainCategory?.Contains("Men's Artistic Gymnastics (C1)", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsMAGEventC2(PerformanceBasedDTO.PerformanceEvent evt) =>
        evt?.MainCategory?.Contains("Men's Artistic Gymnastics (C2)", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsMAGEventC3(PerformanceBasedDTO.PerformanceEvent evt) =>
        evt?.MainCategory?.Contains("Men's Artistic Gymnastics (C3)", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsRhythmicEvent(PerformanceBasedDTO.PerformanceEvent evt) =>
        evt?.MainCategory?.Contains("Rhythmic Gymnastics", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsAerobicEvent(PerformanceBasedDTO.PerformanceEvent evt) =>
        evt?.MainCategory?.Contains("Aerobic Gymnastics", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsElementary(PerformanceBasedDTO.PerformanceEvent evt) =>
        GetSchoolLevelName(evt?.LevelID)?.Contains("Elementary", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsSecondary(PerformanceBasedDTO.PerformanceEvent evt) =>
        GetSchoolLevelName(evt?.LevelID)?.Contains("Secondary", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsMixed(PerformanceBasedDTO.PerformanceEvent evt) =>
        GetSchoolLevelName(evt?.LevelID)?.Contains("Mixed", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsElementaryGirls(PerformanceBasedDTO.PerformanceEvent evt) =>
        IsElementary(evt) && GetGenderName(evt?.GenderID)?.Contains("Girls", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsElementaryBoys(PerformanceBasedDTO.PerformanceEvent evt) =>
        IsElementary(evt) && GetGenderName(evt?.GenderID)?.Contains("Boys", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsSecondaryGirls(PerformanceBasedDTO.PerformanceEvent evt) =>
        IsSecondary(evt) && GetGenderName(evt?.GenderID)?.Contains("Girls", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsSecondaryBoys(PerformanceBasedDTO.PerformanceEvent evt) =>
        IsSecondary(evt) && GetGenderName(evt?.GenderID)?.Contains("Boys", StringComparison.OrdinalIgnoreCase) == true;

    private bool IsMixedGender(PerformanceBasedDTO.PerformanceEvent evt) =>
        GetGenderName(evt?.GenderID)?.Contains("Mix", StringComparison.OrdinalIgnoreCase) == true;

    private bool HasTwoPlayersPerRegion(PerformanceBasedDTO.PerformanceEvent evt)
    {
        if (_allOpposingTeams == null || evt?.ID == null) return false;

        var teamGroups = _allOpposingTeams
            .Where(team => team.PerformanceID == evt.ID)
            .GroupBy(team => new { team.RegionID, team.TeamID })
            .ToList();

        return teamGroups.Any(group => group.Count() == 2);
    }

    private bool HasThreePlayersPerRegion(PerformanceBasedDTO.PerformanceEvent evt)
    {
        if (_allOpposingTeams == null || evt?.ID == null) return false;

        var teamGroups = _allOpposingTeams
            .Where(team => team.PerformanceID == evt.ID)
            .GroupBy(team => new { team.RegionID, team.TeamID })
            .ToList();

        return teamGroups.Any(group => group.Count() == 3);
    }

    private bool HasFiveToEightPlayersPerRegion(PerformanceBasedDTO.PerformanceEvent evt)
    {
        if (_allOpposingTeams == null || evt?.ID == null) return false;

        var teamGroups = _allOpposingTeams
            .Where(team => team.PerformanceID == evt.ID)
            .GroupBy(team => new { team.RegionID, team.TeamID })
            .ToList();

        return teamGroups.Any(group => group.Count() >= 5 && group.Count() <= 8);
    }

    private List<ScoreboardItem> GetEventIndividualScoreboardData(int eventId)
    {
        return _scoreboardData
            .Where(x =>
                x.PerformanceID == eventId &&
                x.IsIndividual &&
                (!x.TeamID.HasValue || x.TeamID.Value < 80000000)) // exclude unique/combined/team-champ rows
            .GroupBy(x => new
            {
                x.PerformanceID,
                x.RegionID,
                x.PlayerID
            })
            .Select(g => g.First())
            .ToList();
    }

    private List<ScoreboardItem> GetEventTeamScoreboardData(int eventId)
    {
        return _scoreboardData
            .Where(x =>
                x.PerformanceID == eventId &&
                x.IsTeam &&
                x.TeamID.HasValue &&
                x.TeamID.Value < 80000000) // exclude unique/combined/team-champ buckets
            .GroupBy(x => new { x.PerformanceID, x.RegionID, TeamID = x.TeamID!.Value })
            .Select(g =>
            {
                // pick a representative row
                var first = g.First();

                // merge members + ids (dedupe)
                first.TeamPlayerIDs = g
                    .SelectMany(x => x.TeamPlayerIDs ?? new List<string>())
                    .Where(id => !string.IsNullOrWhiteSpace(id))
                    .Distinct()
                    .ToList();

                first.TeamGymnasts = g
                    .SelectMany(x => x.TeamGymnasts ?? new List<string>())
                    .Where(n => !string.IsNullOrWhiteSpace(n))
                    .Distinct()
                    .ToList();

                return first;
            })
            .OrderBy(x => x.Region)  // optional
            .ToList();
    }

    private decimal GetScoreForApparatus(int eventId, int regionId, string playerId, int apparatusId)
    {
        if (_allOpposingTeams == null || _allScores == null) return 0;

        var opposingTeam = _allOpposingTeams.FirstOrDefault(ot =>
            ot.PerformanceID == eventId &&
            ot.RegionID == regionId &&
            ot.PlayerID == playerId);

        if (opposingTeam == null) return 0;

        var score = _allScores.FirstOrDefault(s =>
            s.PerformanceID == eventId &&
            s.PerformanceTeamID == opposingTeam.ID &&
            s.SportSubcategoryID == apparatusId &&
            !s.TeamID.HasValue);

        return score?.Score ?? 0;
    }

    private int GetTeamRankForApparatus(int eventId, int regionId, string playerId, int apparatusId)
    {
        if (_allOpposingTeams == null || _allScores == null)
            return 0;

        // Find the team (PerformanceTeam) based on event + region + playerId
        var opposingTeam = _allOpposingTeams.FirstOrDefault(ot =>
            ot.PerformanceID == eventId &&
            ot.RegionID == regionId &&
            ot.PlayerID == playerId &&
            ot.TeamID.HasValue);

        if (opposingTeam == null)
            return 0;

        // Get the score entry for that team & apparatus
        var score = _allScores.FirstOrDefault(s =>
            s.PerformanceID == eventId &&
            s.PerformanceTeamID == opposingTeam.ID &&
            s.SportSubcategoryID == apparatusId &&
            s.TeamID == opposingTeam.TeamID);

        return score?.Rank ?? 0;
    }

    private int GetRankForApparatus(int eventId, int regionId, string playerId, int apparatusId)
    {
        if (_allOpposingTeams == null || _allScores == null) return 0;

        var opposingTeam = _allOpposingTeams.FirstOrDefault(ot =>
            ot.PerformanceID == eventId &&
            ot.RegionID == regionId &&
            ot.PlayerID == playerId);

        if (opposingTeam == null) return 0;

        var score = _allScores.FirstOrDefault(s =>
            s.PerformanceID == eventId &&
            s.PerformanceTeamID == opposingTeam.ID &&
            s.SportSubcategoryID == apparatusId &&
            !s.TeamID.HasValue);

        return score?.Rank ?? 0;
    }


    private decimal GetScoreForApparatusForTeamRanking(int eventId, int regionId, string playerId, int apparatusId)
    {
        if (_allOpposingTeams == null || _allScores == null) return 0;

        // Find the PerformanceTeam for this player in this event
        var opposingTeam = _allOpposingTeams.FirstOrDefault(ot =>
            ot.PerformanceID == eventId &&
            ot.RegionID == regionId &&
            ot.PlayerID == playerId);

        if (opposingTeam == null) return 0;

        // Find the score using PerformanceTeamID
        var score = _allScores.FirstOrDefault(s =>
            s.PerformanceID == eventId &&
            s.PerformanceTeamID == opposingTeam.ID &&
            s.SportSubcategoryID == apparatusId &&
            !s.TeamID.HasValue);

        return score?.Score ?? 0;
    }

    private decimal GetTeamScoreForApparatus(int eventId, int regionId, List<string> playerIds, int apparatusId)
    {
        if (playerIds == null || !playerIds.Any() || _allOpposingTeams == null || _allScores == null)
            return 0;

        var teamItem = _scoreboardData.FirstOrDefault(item =>
            item.PerformanceID == eventId &&
            item.RegionID == regionId &&
            item.TeamPlayerIDs != null &&
            item.TeamPlayerIDs.SequenceEqual(playerIds) &&
            item.TeamID.HasValue);

        if (teamItem?.TeamID == null) return 0;

        var opposingTeam = _allOpposingTeams.FirstOrDefault(ot =>
            ot.PerformanceID == eventId &&
            ot.RegionID == regionId &&
            ot.TeamID == teamItem.TeamID);

        if (opposingTeam == null) return 0;

        var score = _allScores.FirstOrDefault(s =>
            s.PerformanceID == eventId &&
            s.PerformanceTeamID == opposingTeam.ID &&
            s.SportSubcategoryID == apparatusId &&
            s.TeamID == teamItem.TeamID);

        return score?.Score ?? 0;
    }


    private async Task AddScores(int eventId, int regionId, string playerId)
    {
        var parameters = new DialogParameters<GymnasticsScore>
        {
            { x => x.RegionID, regionId },
            { x => x.PlayerID, playerId },
            { x => x.EventID, eventId },
            { x => x.OnScoreSaved, EventCallback.Factory.Create(this, HandleScoreSaved) }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<GymnasticsScore>("", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await HandleScoreSaved();
        }
    }

    private async Task AddTeamScores(int eventId, int regionId, List<string> playerIds)
    {
        if (playerIds == null || !playerIds.Any()) return;

        var teamItem = _scoreboardData.FirstOrDefault(item =>
            item.PerformanceID == eventId &&
            item.RegionID == regionId &&
            item.TeamPlayerIDs != null &&
            item.TeamPlayerIDs.SequenceEqual(playerIds));

        var parameters = new DialogParameters<GymnasticsScore>
        {
            { x => x.RegionID, regionId },
            { x => x.PlayerID, playerIds.First() },
            { x => x.EventID, eventId },
            { x => x.IsTeamEvent, true },
            { x => x.TeamPlayerIDs, playerIds },
            { x => x.TeamID, teamItem?.TeamID },
            { x => x.OnScoreSaved, EventCallback.Factory.Create(this, HandleScoreSaved) }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<GymnasticsScore>("", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await HandleScoreSaved();
        }
    }

    private async Task HandleScoreSaved()
    {
        try
        {
            // Reload scores for ALL events (including combined ones)
            if (_filteredGymnasticsEvents != null && _filteredGymnasticsEvents.Any())
            {
                await LoadAllScoresForFilteredEvents(_filteredGymnasticsEvents.Select(e => e.ID).ToList());
            }

            // Recalculate ranks if needed
            await CalculateAndSaveRanks();

            // Reload scoreboard data
            await LoadScoreboardDataForFilteredEvents();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing data: {ex.Message}", Severity.Error);
        }
    }

    //RANKING CALCULATION

    private async Task CalculateAndSaveRanks()
    {
        try
        {
            if (_selectedEvent?.ID == null || _allScores == null || !_allScores.Any())
                return;

            var eventIds = GetCombinedEventIds(_selectedEvent.ID, false, _selectedEvent.StageID);

            var allApparatus = eventIds
                .SelectMany(evtId => GetApparatusForEvent(evtId))
                .Distinct()
                .ToList();

            foreach (var apparatusId in allApparatus)
            {
                var apparatusScores = _allScores
                    .Where(s => eventIds.Contains(s.PerformanceID) &&
                                s.SportSubcategoryID == apparatusId)
                    .ToList();

                if (!apparatusScores.Any()) continue;

                var individualScores = apparatusScores.Where(s => !s.TeamID.HasValue).ToList();
                var teamScores = apparatusScores.Where(s => s.TeamID.HasValue).ToList();

                await UpdateRanksForScoresGlobal(individualScores, apparatusId);
                await UpdateRanksForScoresGlobal(teamScores, apparatusId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error calculating ranks: {ex.Message}");
        }
    }

    private async Task UpdateRanksForScoresGlobal(List<PerformanceBasedDTO.PerformanceScore> scores, int apparatusId)
    {
        if (!scores.Any()) return;

        // Group by score and order by score descending
        var groupedByScore = scores
            .GroupBy(s => s.Score)
            .OrderByDescending(g => g.Key)
            .ToList();

        int currentRank = 1;

        foreach (var group in groupedByScore)
        {
            // All scores in this group get the same rank
            foreach (var score in group)
            {
                score.Rank = currentRank;
                await UpdateScoreRankInDatabase(score);
            }

            // For dense ranking: next rank = current rank + 1
            currentRank++;
        }
    }

    private async Task UpdateScoreRankInDatabase(PerformanceBasedDTO.PerformanceScore score)
    {
        try
        {
            string url = $"/PerformanceScore/Score/{score.ID}";

            // Create a proper GymnasticsScores object with only the rank updated
            var updateData = new PerformanceBasedDTO.PerformanceScore
            {
                ID = score.ID,
                PerformanceID = score.PerformanceID,
                PerformanceTeamID = score.PerformanceTeamID,
                SportSubcategoryID = score.SportSubcategoryID,
                Score = score.Score,
                Rank = score.Rank,
                UserID = score.UserID,
                UpdatedAt = DateTime.Now,
                TeamID = score.TeamID
            };

            var result = await apiService.PutAsync<PerformanceBasedDTO.PerformanceScore>(url, updateData);

            if (result == null)
            {
                Console.WriteLine($"Failed to update rank for score ID {score.ID}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating rank for score {score.ID}: {ex.Message}");
        }
    }

    //Individual All-Around Ranking
    private List<IndividualAllAroundRank> GetIndividualAllAroundRanking(int eventId)
    {
        var currentEvent = _gymnasticsEvents?.FirstOrDefault(e => e.ID == eventId);
        var currentStageId = currentEvent?.StageID ?? 0;
        var eventIds = GetCombinedEventIds(eventId, false, currentStageId);
        var players = GetCombinedPlayers(eventIds);

        var rankings = new List<IndividualAllAroundRank>();

        foreach (var player in players)
        {
            decimal totalScore = 0m;

            foreach (var evtId in eventIds)
            {
                var apparatusList = GetApparatusForEvent(evtId);
                totalScore += apparatusList.Sum(apparatus =>
                    GetScoreForApparatus(evtId, player.RegionID, player.PlayerID, apparatus));
            }

            rankings.Add(new IndividualAllAroundRank
            {
                PlayerID = player.PlayerID,
                PlayerName = player.Gymnast,
                RegionID = player.RegionID,
                RegionName = player.Region,
                Total = totalScore
            });
        }

        return CalculateRanks(rankings, r => r.Total);
    }

    // Team Ranking

    private List<TeamRank> GetTeamRanking(int eventId)
    {
        var currentEvent = _gymnasticsEvents?.FirstOrDefault(e => e.ID == eventId);
        if (currentEvent == null) return new();

        var currentStageId = currentEvent.StageID;
        var schoolLevelName = GetSchoolLevelName(currentEvent.LevelID);
        bool isElementary = schoolLevelName?.Contains("Elementary", StringComparison.OrdinalIgnoreCase) == true;

        var eventIds = (currentStageId == 1 && isElementary)
            ? GetCombinedEventIds(eventId, true, currentStageId)
            : new List<int> { eventId };

        var excludedSubcategoryIds = GetIndividualAllAroundSubcategoryIds();

        var teamTotals = new Dictionary<int, decimal>();

        foreach (var evtId in eventIds)
        {
            var eventTeams = _allOpposingTeams
                .Where(t => t.PerformanceID == evtId && !t.TeamID.HasValue)
                .ToList();

            foreach (var team in eventTeams)
            {
                var teamScores = _allScores
                    .Where(s => s.PerformanceTeamID == team.ID &&
                               !excludedSubcategoryIds.Contains(s.SportSubcategoryID))
                    .ToList();

                if (teamScores.Any())
                {
                    var regionId = team.RegionID;
                    if (!teamTotals.ContainsKey(regionId))
                    {
                        teamTotals[regionId] = 0;
                    }
                    teamTotals[regionId] += teamScores.Sum(s => s.Score);
                }
            }
        }

        var result = teamTotals.Select(kvp =>
{
    var region = _schoolRegions.FirstOrDefault(r => r.ID == kvp.Key);

    return new TeamRank
    {
        RegionID = kvp.Key,
        RegionName = region?.Abbreviation ?? region?.Region ?? "Unknown",
        TeamTotal = kvp.Value
    };
}).ToList();

        return CalculateRanks(result, t => t.TeamTotal);
    }

    private List<int> GetCombinedEventIds(int currentEventId, bool isTeamRanking, int currentStageId)
    {
        var currentEvent = _gymnasticsEvents?.FirstOrDefault(e => e.ID == currentEventId);
        if (currentEvent == null)
            return new List<int> { currentEventId };

        if (currentStageId != 1)
        {
            return new List<int> { currentEventId };
        }

        var schoolLevelName = GetSchoolLevelName(currentEvent.LevelID);
        bool isElementary = schoolLevelName != null &&
                           schoolLevelName.Contains("Elementary", StringComparison.OrdinalIgnoreCase);

        if (!isElementary || !isTeamRanking)
            return new List<int> { currentEventId };

        var currentCategory = currentEvent.MainCategory ?? "";

        // Hardcoded category names
        if (currentCategory == "Women's Artistic Gymnastics (C1)" || currentCategory == "Women's Artistic Gymnastics (C2)")
        {
            return _gymnasticsEvents
                .Where(e =>
                    e.StageID == 1 &&
                    GetSchoolLevelName(e.LevelID)?.Contains("Elementary", StringComparison.OrdinalIgnoreCase) == true &&
                    (e.MainCategory == "Women's Artistic Gymnastics (C1)" ||
                     e.MainCategory == "Women's Artistic Gymnastics (C2)"))
                .Select(e => e.ID)
                .Distinct()
                .ToList();
        }
        else if (currentCategory == "Men's Artistic Gymnastics (C1)" || currentCategory == "Men's Artistic Gymnastics (C2)")
        {
            return _gymnasticsEvents
                .Where(e =>
                    e.StageID == 1 &&
                    GetSchoolLevelName(e.LevelID)?.Contains("Elementary", StringComparison.OrdinalIgnoreCase) == true &&
                    (e.MainCategory == "Men's Artistic Gymnastics (C1)" ||
                     e.MainCategory == "Men's Artistic Gymnastics (C2)"))
                .Select(e => e.ID)
                .Distinct()
                .ToList();
        }

        return new List<int> { currentEventId };
    }

    private List<int> GetIndividualAllAroundSubcategoryIds()
    {
        var excludedIds = new List<int>();

        if (_sportSubcategories != null)
        {
            foreach (var subcategory in _sportSubcategories)
            {
                if (!string.IsNullOrEmpty(subcategory.Subcategory) &&
                    (subcategory.Subcategory.Contains("Individual All-Around", StringComparison.OrdinalIgnoreCase) ||
                     subcategory.Subcategory.Contains("Team Championship", StringComparison.OrdinalIgnoreCase)))
                {
                    excludedIds.Add(subcategory.ID);
                }
            }
        }

        return excludedIds;
    }

    private List<T> CalculateRanks<T>(List<T> items, Func<T, decimal> scoreSelector) where T : class
    {
        if (!items.Any()) return items;

        // Group by score and order by score descending
        var groupedByScore = items
            .GroupBy(item => scoreSelector(item))
            .OrderByDescending(g => g.Key)
            .ToList();

        int currentRank = 1;
        var result = new List<T>();

        foreach (var group in groupedByScore)
        {
            // All items in this group get the same rank
            foreach (var item in group)
            {
                var property = item.GetType().GetProperty("Rank");
                if (property != null && property.CanWrite)
                {
                    property.SetValue(item, currentRank);
                }
                result.Add(item);
            }

            // For dense ranking: next rank = current rank + 1
            currentRank++;
        }

        return result;
    }

    private List<ScoreboardItem> GetCombinedPlayers(List<int> eventIds)
    {
        var allPlayers = new List<ScoreboardItem>();

        foreach (var eventId in eventIds)
        {
            var eventPlayers = GetEventIndividualScoreboardData(eventId);
            allPlayers.AddRange(eventPlayers.Where(p =>
                !allPlayers.Any(ap => ap.PlayerID == p.PlayerID && ap.RegionID == p.RegionID)));
        }

        return allPlayers;
    }

    private int[] GetApparatusForEvent(int eventId)
    {
        var evt = _gymnasticsEvents?.FirstOrDefault(e => e.ID == eventId);

        if (evt == null)
            return Array.Empty<int>();

        if (IsWAGEventC1(evt)) return new[] { 221, 223, 216, 214 };
        if (IsWAGEventC2(evt)) return new[] { 220, 224, 217, 215 };
        if (IsWAGEventC3(evt)) return new[] { 247, 248, 244, 243 };

        if (IsMAGEventC1(evt)) return new[] { 198, 201, 197, 200 };
        if (IsMAGEventC2(evt)) return new[] { 204, 206, 203, 205 };
        if (IsMAGEventC3(evt)) return new[] { 232, 236, 231, 234 };

        // Rhythmic Gymnastics - Elementary
        if (IsRhythmicEvent(evt) && IsElementary(evt)) return new[] { 210, 212, 211, 209 };

        // Rhythmic Gymnastics - Secondary
        if (IsRhythmicEvent(evt) && IsSecondary(evt)) return new[] { 239, 241, 240, 238 };

        return Array.Empty<int>();
    }

    //AEROBIC GYMNASTICS TEAM RANKING

    private List<TeamRank>? _aerobicTeamChampionship;
    private int? _aerobicTeamChampionshipStageId;

    private bool ShouldShowAerobicTeamChampionship(PerformanceBasedDTO.PerformanceEvent evt)
    {
        if (evt == null)
            return false;

        // Hardcoded: Show for Aerobic Gymnastics Finals only
        return evt.MainCategory == "Aerobic Gymnastics" && evt.StageID == 4;
    }

    private List<TeamRank> GetAerobicTeamChampionshipRanking()
    {
        Console.WriteLine("===============================================");
        Console.WriteLine("=== AEROBIC TEAM CHAMPIONSHIP (ACCUMULATED SCORE) ===");
        Console.WriteLine("=== MainCategory = 'Aerobic Gymnastics', StageID = 4 ===");

        if (_gymnasticsEvents == null || !_gymnasticsEvents.Any())
        {
            Console.WriteLine("❌ _gymnasticsEvents is null/empty");
            return new();
        }

        if (_allOpposingTeams == null || !_allOpposingTeams.Any())
        {
            Console.WriteLine("❌ _allOpposingTeams is null/empty");
            return new();
        }

        if (_allScores == null || !_allScores.Any())
        {
            Console.WriteLine("❌ _allScores is null/empty");
            return new();
        }

        // Cache the result
        if (_aerobicTeamChampionship != null)
        {
            Console.WriteLine($"✅ Returning cached result: {_aerobicTeamChampionship.Count} rows");
            return _aerobicTeamChampionship;
        }

        // ✅ Aerobic Gymnastics FINALS events only
        var aerobicFinalsEvents = _gymnasticsEvents
            .Where(e =>
                e.StageID == 4 &&
                !string.IsNullOrWhiteSpace(e.MainCategory) &&
                e.MainCategory.Contains("Aerobic Gymnastics", StringComparison.OrdinalIgnoreCase))
            .ToList();

        Console.WriteLine($"Aerobic Gymnastics Finals Events found: {aerobicFinalsEvents.Count}");

        if (!aerobicFinalsEvents.Any())
        {
            Console.WriteLine("❌ No Aerobic Gymnastics finals events found.");
            return new();
        }

        var aerobicFinalEventIds = aerobicFinalsEvents.Select(e => e.ID).Distinct().ToList();

        // ==========================================================
        // 1) FIRST: regions that compete in ANY subcategory in Aerobic Finals
        //    => simply: any opposingTeam row in any aerobic finals event
        // ==========================================================
        var competingRegionIds = _allOpposingTeams
            .Where(t => aerobicFinalEventIds.Contains(t.PerformanceID))
            .Select(t => t.RegionID)
            .Distinct()
            .ToList();

        Console.WriteLine($"Competing regions found: {competingRegionIds.Count}");

        if (!competingRegionIds.Any())
        {
            Console.WriteLine("❌ No regions found competing in Aerobic Finals.");
            return new();
        }

        // ==========================================================
        // Build lookups to map scores -> region
        // ==========================================================

        // PerformanceTeamID -> RegionID (individual linking)
        var perfTeamToRegion = _allOpposingTeams
            .Where(t => aerobicFinalEventIds.Contains(t.PerformanceID))
            .GroupBy(t => t.ID)
            .ToDictionary(g => g.Key, g => g.First().RegionID);

        // (PerformanceID, TeamID) -> RegionID (team linking)
        var perfTeamIdToRegion = _allOpposingTeams
            .Where(t => aerobicFinalEventIds.Contains(t.PerformanceID) && t.TeamID.HasValue)
            .GroupBy(t => new { t.PerformanceID, TeamID = t.TeamID!.Value })
            .ToDictionary(g => (g.Key.PerformanceID, g.Key.TeamID), g => g.First().RegionID);

        // ==========================================================
        // 2) SECOND: accumulate ALL scores across ALL subcategories per region
        //    - Deduplicate TEAM scores (one per team per perf per subcat)
        //    - Deduplicate INDIV scores (one per perfTeam per perf per subcat)
        // ==========================================================

        // Only scores from aerobic finals performances
        var relevantScores = _allScores
            .Where(s => aerobicFinalEventIds.Contains(s.PerformanceID))
            .ToList();

        if (!relevantScores.Any())
        {
            Console.WriteLine("❌ No scores found for Aerobic Finals performances.");
            return new();
        }

        // TEAM scores: dedupe by (PerformanceID, SportSubcategoryID, TeamID)
        var teamScoreUnits = relevantScores
            .Where(s => s.TeamID.HasValue)
            .GroupBy(s => new { s.PerformanceID, s.SportSubcategoryID, TeamID = s.TeamID!.Value })
            .Select(g =>
            {
                var any = g.First();
                var bestScore = g.Max(x => x.Score);

                int regionId = 0;
                if (!perfTeamIdToRegion.TryGetValue((any.PerformanceID, any.TeamID!.Value), out regionId))
                    regionId = 0; // unknown (should not happen if opposingTeams data is complete)

                return new
                {
                    RegionID = regionId,
                    Score = bestScore
                };
            })
            .Where(x => x.RegionID != 0) // keep only resolvable
            .ToList();

        // INDIV scores: dedupe by (PerformanceID, SportSubcategoryID, PerformanceTeamID)
        var indivScoreUnits = relevantScores
            .Where(s => !s.TeamID.HasValue && s.PerformanceTeamID.HasValue)
            .GroupBy(s => new { s.PerformanceID, s.SportSubcategoryID, PerfTeamID = s.PerformanceTeamID!.Value })
            .Select(g =>
            {
                var any = g.First();
                var bestScore = g.Max(x => x.Score);

                int regionId = 0;
                if (!perfTeamToRegion.TryGetValue(any.PerformanceTeamID!.Value, out regionId))
                    regionId = 0;

                return new
                {
                    RegionID = regionId,
                    Score = bestScore
                };
            })
            .Where(x => x.RegionID != 0)
            .ToList();

        // Combine and sum by region
        var regionTotals = teamScoreUnits
            .Concat(indivScoreUnits)
            .GroupBy(x => x.RegionID)
            .ToDictionary(g => g.Key, g => g.Sum(x => x.Score));

        // Make sure regions with participation but no score still show (total = 0)
        foreach (var rid in competingRegionIds)
            if (!regionTotals.ContainsKey(rid))
                regionTotals[rid] = 0m;

        // ==========================================================
        // 3) Convert to TeamRank and rank DESC (higher total = better)
        // ==========================================================
        var list = regionTotals
            .Select(kvp =>
            {
                var region = _schoolRegions?.FirstOrDefault(r => r.ID == kvp.Key);
                var regionName = region?.Abbreviation ?? region?.Region ?? $"Region {kvp.Key}";

                return new TeamRank
                {
                    RegionID = kvp.Key,
                    RegionName = regionName,
                    TeamTotal = kvp.Value
                };
            })
            .OrderByDescending(x => x.TeamTotal)
            .ToList();

        _aerobicTeamChampionship = CalculateRanksDescending(list, x => x.TeamTotal);

        Console.WriteLine("FINAL TEAM CHAMPIONSHIP RANKING (ACCUMULATED SCORE):");
        foreach (var r in _aerobicTeamChampionship.OrderBy(x => x.Rank))
            Console.WriteLine($"  Rank {r.Rank}: {r.RegionName} => {r.TeamTotal}");

        Console.WriteLine("=== END ===");
        Console.WriteLine("===============================================");

        return _aerobicTeamChampionship;
    }


    // Hardcoded helper methods
    private string GetLevelName(int levelId)
    {
        // Hardcoded level mapping
        return levelId switch
        {
            1 => "Elementary",
            2 => "Secondary",
            8 => "Mixed",
            _ => $"Level {levelId}"
        };
    }

    private string GetGenderName(int genderId)
    {
        // Hardcoded gender mapping
        return genderId switch
        {
            1 => "Boys",
            2 => "Girls",
            3 => "Mix",
            _ => $"Gender {genderId}"
        };
    }

    private List<T> CalculateRanksDescending<T>(List<T> items, Func<T, decimal> scoreSelector) where T : class
    {
        if (!items.Any())
            return items;

        var groupedByScore = items
            .GroupBy(item => scoreSelector(item))
            .OrderByDescending(g => g.Key) // DESC: higher total score = better rank
            .ToList();

        int currentRank = 1;
        var result = new List<T>();

        foreach (var group in groupedByScore)
        {
            foreach (var item in group)
            {
                var rankProperty = item.GetType().GetProperty("Rank");
                if (rankProperty != null && rankProperty.CanWrite)
                    rankProperty.SetValue(item, currentRank);

                result.Add(item);
            }

            currentRank++; // dense ranking
        }

        return result;
    }

    //TEAM CHAMPIONSHIP AND IAA

    private int GetTeamGroupKey(List<int> eventIds)
    {
        // same key for C1+C2 (or any combined set)
        return eventIds.Min();
    }

    private List<int> GetTeamChampionshipEventIds(int eventId)
    {
        var currentEvent = _gymnasticsEvents?.FirstOrDefault(e => e.ID == eventId);
        if (currentEvent == null) return new List<int> { eventId };

        var currentStageId = currentEvent.StageID;
        var schoolLevelName = GetSchoolLevelName(currentEvent.LevelID);
        bool isElementary = schoolLevelName?.Contains("Elementary", StringComparison.OrdinalIgnoreCase) == true;

        return (currentStageId == 1 && isElementary)
            ? GetCombinedEventIds(eventId, true, currentStageId)
            : new List<int> { eventId };
    }


    private async Task SetAsTeam(int performanceId, int regionId, bool isAerobicTeamChampionship = false)
{
    try
    {
        var currentEvent = _gymnasticsEvents?.FirstOrDefault(e => e.ID == performanceId);
        if (currentEvent == null)
        {
            Snackbar.Add("Event not found.", Severity.Warning);
            return;
        }

        // ✅ AEROBIC FINALS — TEAM CHAMPIONSHIP TEAM CREATION
        // Save each player ONCE ONLY across all finals aerobic events (prevents repeats across categories)
        if (isAerobicTeamChampionship && IsAerobicGymnasticsEvent(currentEvent) && currentEvent.StageID == 4)
        {
            var aerobicFinalEventIds = await GetAllAerobicFinalsEventIds_AllLevelsAllGenders(currentEvent);
            if (aerobicFinalEventIds == null || aerobicFinalEventIds.Count == 0)
            {
                Snackbar.Add("No Aerobic Gymnastics Finals events found.", Severity.Warning);
                return;
            }

            int teamChampTeamId = GetAerobicTeamChampionshipTeamId(regionId, currentEvent.SportID);

            // ✅ Use Aerobic Dance PerformanceID as the roster PerformanceID (stable + matches UI)
            int rosterPerformanceId = GetAerobicDanceEventIdOrFallback(currentEvent, aerobicFinalEventIds);

            // ✅ Block if roster already exists for this exact team
            bool alreadyHasTeamChampRows = _allOpposingTeams.Any(t =>
                t.PerformanceID == rosterPerformanceId &&
                t.RegionID == regionId &&
                t.TeamID.HasValue &&
                t.TeamID.Value == teamChampTeamId);

            if (alreadyHasTeamChampRows)
            {
                Snackbar.Add("Team Championship team already exists for this region.", Severity.Info);
                return;
            }

            // ✅ Collect unique players ACROSS ALL finals events (Dance + Trio + MP + etc.)
            var allFinalsPlayerIds = _allOpposingTeams
                .Where(t =>
                    aerobicFinalEventIds.Contains(t.PerformanceID) &&
                    t.RegionID == regionId &&
                    !string.IsNullOrWhiteSpace(t.PlayerID))
                .Select(t => t.PlayerID.Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();

            if (!allFinalsPlayerIds.Any())
            {
                Snackbar.Add("No players found to create Team Championship roster.", Severity.Warning);
                return;
            }

            int createdCount = 0;

            foreach (var pid in allFinalsPlayerIds)
            {
                // ✅ prevent duplicates if user clicks again
                bool exists = _allOpposingTeams.Any(t =>
                    t.PerformanceID == rosterPerformanceId &&
                    t.RegionID == regionId &&
                    t.TeamID.HasValue &&
                    t.TeamID.Value == teamChampTeamId &&
                    string.Equals(t.PlayerID, pid, StringComparison.OrdinalIgnoreCase));

                if (exists) continue;

                var payload = new PerformanceBasedDTO.PerformanceTeam
                {
                    PerformanceID = rosterPerformanceId, // ✅ save ONCE only here
                    RegionID = regionId,
                    PlayerID = pid,
                    TeamID = teamChampTeamId
                };

                var created = await apiService.PostAsync<PerformanceBasedDTO.PerformanceTeam>(
                    "/PerformanceBased/AddOpposingTeam", payload);

                if (created) createdCount++;
            }

            if (createdCount == 0)
            {
                Snackbar.Add("Failed to create Team Championship team entries.", Severity.Error);
                return;
            }

            Snackbar.Add($"Aerobic Team Championship team created! ({createdCount} members)", Severity.Success);

            await GetOpposingTeamsAsync();
            await LoadScoreboardDataForFilteredEvents();
            StateHasChanged();
            return;
        }

        // ✅ DEFAULT TEAM CREATION (WAG/MAG combined + Aerobic combined)
        List<int> combinedEventIds;

        // If Aerobic Gymnastics: combine ALL Aerobic Gymnastics + Aerobic Dance for same sport + stage
        if (IsAerobicGymnasticsEvent(currentEvent))
        {
            combinedEventIds = _gymnasticsEvents?
                .Where(e =>
                    e.StageID == currentEvent.StageID &&
                    e.SportID == currentEvent.SportID &&
                    !string.IsNullOrWhiteSpace(e.MainCategory) &&
                    e.MainCategory.Contains("Aerobic", StringComparison.OrdinalIgnoreCase)) // ✅ includes Aerobic Dance
                .Select(e => e.ID)
                .Distinct()
                .ToList()
                ?? new List<int> { performanceId };
        }
        else
        {
            // WAG/MAG: existing combined C1+C2 behavior
            combinedEventIds = GetCombinedEventIds(performanceId, true, currentEvent.StageID);
        }

        int combinedGroupKey = GetTeamGroupKey(combinedEventIds);
        int combinedTeamId = GetCombinedEventsTeamId(regionId, currentEvent.SportID, currentEvent.StageID, combinedGroupKey);

        // ✅ SPECIAL: Aerobic Gymnastics must save players ONCE ONLY across all categories
        if (IsAerobicGymnasticsEvent(currentEvent))
        {
            // ✅ Use Aerobic Dance as the one roster PerformanceID
            int rosterPerformanceId = GetAerobicDanceEventIdOrFallback(currentEvent, combinedEventIds);

            // ✅ Block if team already exists for rosterPerformanceId + combinedTeamId
            bool alreadyHasTeam = _allOpposingTeams.Any(t =>
                t.PerformanceID == rosterPerformanceId &&
                t.RegionID == regionId &&
                t.TeamID.HasValue &&
                t.TeamID.Value == combinedTeamId);

            if (alreadyHasTeam)
            {
                Snackbar.Add("Team already exists for this region.", Severity.Info);
                return;
            }

            // ✅ Unique players across ALL aerobic events
            var allPlayerIds = _allOpposingTeams
                .Where(t =>
                    combinedEventIds.Contains(t.PerformanceID) &&
                    t.RegionID == regionId &&
                    !string.IsNullOrWhiteSpace(t.PlayerID))
                .Select(t => t.PlayerID.Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();

            if (!allPlayerIds.Any())
            {
                Snackbar.Add("No players found to create a team.", Severity.Warning);
                return;
            }

            int createdCount = 0;

            foreach (var pid in allPlayerIds)
            {
                bool exists = _allOpposingTeams.Any(t =>
                    t.PerformanceID == rosterPerformanceId &&
                    t.RegionID == regionId &&
                    t.TeamID.HasValue &&
                    t.TeamID.Value == combinedTeamId &&
                    string.Equals(t.PlayerID, pid, StringComparison.OrdinalIgnoreCase));

                if (exists) continue;

                var payload = new PerformanceBasedDTO.PerformanceTeam
                {
                    PerformanceID = rosterPerformanceId, // ✅ saved ONCE ONLY
                    RegionID = regionId,
                    PlayerID = pid,
                    TeamID = combinedTeamId
                };

                var created = await apiService.PostAsync<PerformanceBasedDTO.PerformanceTeam>(
                    "/PerformanceBased/AddOpposingTeam", payload);

                if (created) createdCount++;
            }

            if (createdCount == 0)
            {
                Snackbar.Add("Failed to create team entries.", Severity.Error);
                return;
            }

            Snackbar.Add($"Team created! ({createdCount} members)", Severity.Success);

            await GetOpposingTeamsAsync();
            await LoadScoreboardDataForFilteredEvents();
            StateHasChanged();
            return;
        }

        // ✅ Non-aerobic: keep existing behavior (save per PerformanceID)
        bool alreadyHasNonAerobicTeam = _allOpposingTeams.Any(t =>
            combinedEventIds.Contains(t.PerformanceID) &&
            t.RegionID == regionId &&
            t.TeamID.HasValue &&
            t.TeamID.Value == combinedTeamId);

        if (alreadyHasNonAerobicTeam)
        {
            Snackbar.Add("Team already exists for this region.", Severity.Info);
            return;
        }

        int createdCountDefault = 0;

        foreach (var evtId in combinedEventIds)
        {
            var playerIdsForThisEvent = _allOpposingTeams
                .Where(t =>
                    t.PerformanceID == evtId &&
                    t.RegionID == regionId &&
                    !string.IsNullOrWhiteSpace(t.PlayerID))
                .Select(t => t.PlayerID.Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();

            if (!playerIdsForThisEvent.Any())
                continue;

            foreach (var pid in playerIdsForThisEvent)
            {
                bool exists = _allOpposingTeams.Any(t =>
                    t.PerformanceID == evtId &&
                    t.RegionID == regionId &&
                    t.TeamID.HasValue &&
                    t.TeamID.Value == combinedTeamId &&
                    string.Equals(t.PlayerID, pid, StringComparison.OrdinalIgnoreCase));

                if (exists) continue;

                var payload = new PerformanceBasedDTO.PerformanceTeam
                {
                    PerformanceID = evtId, // ✅ save corresponding PerformanceID
                    RegionID = regionId,
                    PlayerID = pid,
                    TeamID = combinedTeamId
                };

                var created = await apiService.PostAsync<PerformanceBasedDTO.PerformanceTeam>(
                    "/PerformanceBased/AddOpposingTeam", payload);

                if (created) createdCountDefault++;
            }
        }

        if (createdCountDefault == 0)
        {
            Snackbar.Add("Failed to create team entries.", Severity.Error);
            return;
        }

        Snackbar.Add($"Team created! ({createdCountDefault} members)", Severity.Success);

        await GetOpposingTeamsAsync();
        await LoadScoreboardDataForFilteredEvents();
        StateHasChanged();
    }
    catch (Exception ex)
    {
        Snackbar.Add($"Error setting team: {ex.Message}", Severity.Error);
    }
}




    private bool HasTeamOrCombined(int performanceId, int regionId, bool isAerobicTeamChampionship = false)
    {
        var currentEvent = _gymnasticsEvents?.FirstOrDefault(e => e.ID == performanceId);
        if (currentEvent == null) return false;

        // ✅ Aerobic Finals Team Championship existence check (should match how you SAVE it: anchor-only)
        if (isAerobicTeamChampionship && IsAerobicGymnasticsEvent(currentEvent) && currentEvent.StageID == 4)
        {
            int teamChampTeamId = GetAerobicTeamChampionshipTeamId(regionId, currentEvent.SportID);

            var finalsIds = _gymnasticsEvents?
                .Where(e =>
                    e.StageID == 4 &&
                    e.SportID == currentEvent.SportID &&
                    !string.IsNullOrWhiteSpace(e.MainCategory) &&
                    e.MainCategory.Contains("Aerobic", StringComparison.OrdinalIgnoreCase)) // ✅ include Dance too
                .Select(e => e.ID)
                .Distinct()
                .ToList() ?? new List<int> { performanceId };

            int anchorFinalsId = GetAerobicDanceEventIdOrFallback(currentEvent, finalsIds);

            return _allOpposingTeams.Any(t =>
                t.PerformanceID == anchorFinalsId &&
                t.RegionID == regionId &&
                t.TeamID.HasValue &&
                t.TeamID.Value == teamChampTeamId);
        }

        // ✅ DEFAULT combined team check
        List<int> eventIds;

        if (IsAerobicGymnasticsEvent(currentEvent))
        {
            // Aerobic combined = ALL aerobic (includes Dance) same sport + stage
            eventIds = _gymnasticsEvents?
                .Where(e =>
                    e.StageID == currentEvent.StageID &&
                    e.SportID == currentEvent.SportID &&
                    !string.IsNullOrWhiteSpace(e.MainCategory) &&
                    e.MainCategory.Contains("Aerobic", StringComparison.OrdinalIgnoreCase))
                .Select(e => e.ID)
                .Distinct()
                .ToList()
                ?? new List<int> { performanceId };
        }
        else
        {
            // WAG/MAG combined C1+C2 (your existing logic)
            eventIds = GetCombinedEventIds(performanceId, true, currentEvent.StageID);
        }

        int groupKey = GetTeamGroupKey(eventIds);
        int combinedTeamId = GetCombinedEventsTeamId(regionId, currentEvent.SportID, currentEvent.StageID, groupKey);

        int anchorEventId = IsAerobicGymnasticsEvent(currentEvent)
            ? GetAerobicDanceEventIdOrFallback(currentEvent, eventIds) // ✅ use Aerobic Dance PerformanceID
            : eventIds.Min();

        return _allOpposingTeams.Any(t =>
            t.PerformanceID == anchorEventId &&
            t.RegionID == regionId &&
            t.TeamID.HasValue &&
            t.TeamID.Value == combinedTeamId);
    }


    private async Task AddTeamChampionshipScore(int eventId, int regionId)
    {
        // ✅ resolve both C1+C2 event IDs (same gender/level/stage)
        var linkedEventIds = GetPairedC1C2EventIds(eventId);

        // ✅ pick a "source" event to get the team members (use the clicked eventId, or fallback to whichever has data)
        var sourceEventId = linkedEventIds.Contains(eventId) ? eventId : linkedEventIds.First();

        // Load opposing teams for source event
        string teamUrl = $"/PerformanceBased/OpposingTeams/{sourceEventId}";
        var teams = await apiService.GetAsync<PerformanceBasedDTO.PerformanceTeam>(teamUrl)
                   ?? new List<PerformanceBasedDTO.PerformanceTeam>();

        // "Team Championship" in your system is: Region has a TeamID and members
        var regionTeamRows = teams
            .Where(t => t.RegionID == regionId && t.TeamID.HasValue)
            .ToList();

        if (!regionTeamRows.Any())
        {
            Snackbar.Add("No team found for this region. Click 'Set as Team' first (C2).", Severity.Warning);
            return;
        }

        int teamId = regionTeamRows.First().TeamID!.Value;

        var playerIds = regionTeamRows
            .Where(t => !string.IsNullOrWhiteSpace(t.PlayerID))
            .Select(t => t.PlayerID)
            .Distinct()
            .ToList();

        if (!playerIds.Any())
        {
            Snackbar.Add("Team has no players.", Severity.Warning);
            return;
        }

        // ✅ Open dialog and tell it to save to both C1+C2
        var parameters = new DialogParameters<GymnasticsScore>
    {
        { x => x.RegionID, regionId },
        { x => x.PlayerID, playerIds.First() }, // dialog wants one ID for display
        { x => x.EventID, sourceEventId },

        { x => x.IsTeamEvent, true },
        { x => x.TeamPlayerIDs, playerIds },
        { x => x.TeamID, teamId },

        { x => x.ForcedCategoryName, "Team Championship" },

        // ✅ NEW: tell dialog to save to BOTH events
        { x => x.SaveToLinkedPerformances, true },
        { x => x.LinkedPerformanceIDs, linkedEventIds },

        { x => x.OnScoreSaved, EventCallback.Factory.Create(this, HandleScoreSaved) }
    };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<GymnasticsScore>("", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
            await HandleScoreSaved();
    }


    private async Task AddIndividualAllAroundScore(int eventId, int regionId, string playerId)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(playerId))
            {
                Snackbar.Add("Player info not found.", Severity.Warning);
                return;
            }

            // ✅ Make sure opposing team row exists for THIS player+event
            // This is required because SaveScore uses PerformanceTeamID (_opposingTeamId)
            var opposingRow = _allOpposingTeams.FirstOrDefault(t =>
                t.PerformanceID == eventId &&
                t.RegionID == regionId &&
                t.PlayerID == playerId &&
                !t.TeamID.HasValue);

            // If your page doesn't have _allOpposingTeams populated for this event,
            // you can fallback to API fetch:
            if (opposingRow == null)
            {
                string url = $"/PerformanceBased/OpposingTeams/{eventId}";
                var teams = await apiService.GetAsync<PerformanceBasedDTO.PerformanceTeam>(url)
                           ?? new List<PerformanceBasedDTO.PerformanceTeam>();

                opposingRow = teams.FirstOrDefault(t =>
                    t.PerformanceID == eventId &&
                    t.RegionID == regionId &&
                    t.PlayerID == playerId &&
                    !t.TeamID.HasValue);

                if (opposingRow == null)
                {
                    Snackbar.Add("Could not find opposing team row for this gymnast.", Severity.Warning);
                    return;
                }
            }

            // ✅ Open the SAME dialog component
            var parameters = new DialogParameters<GymnasticsScore>
        {
            { x => x.RegionID, regionId },
            { x => x.PlayerID, playerId },
            { x => x.EventID, eventId },

            // ✅ IMPORTANT: Individual, not team event
            { x => x.IsTeamEvent, false },
            { x => x.TeamID, (int?)null },
            { x => x.TeamPlayerIDs, new List<string>() },

            // ✅ Force the subcategory and lock it in the dialog
            { x => x.ForcedCategoryName, "Individual All-Around" },

            { x => x.OnScoreSaved, EventCallback.Factory.Create(this, HandleScoreSaved) }
        };

            var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Small,
                FullWidth = true,
                CloseOnEscapeKey = true
            };

            var dialog = await DialogService.ShowAsync<GymnasticsScore>("", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled)
                await HandleScoreSaved();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error opening Individual All-Around score dialog: {ex.Message}", Severity.Error);
        }
    }

    private async Task AddTeamChampionshipScore_Rhythmic(int eventId, int regionId)
    {
        var currentEvent = _gymnasticsEvents?.FirstOrDefault(e => e.ID == eventId);
        if (currentEvent == null)
        {
            Snackbar.Add("Event not found.", Severity.Warning);
            return;
        }

        // ✅ Rhythmic = NEVER link to other performances
        int sourceEventId = eventId;

        // Load opposing teams for THIS rhythmic event only
        string teamUrl = $"/PerformanceBased/OpposingTeams/{sourceEventId}";
        var teams = await apiService.GetAsync<PerformanceBasedDTO.PerformanceTeam>(teamUrl)
                   ?? new List<PerformanceBasedDTO.PerformanceTeam>();

        // Team Championship roster = region rows with TeamID
        var regionTeamRows = teams
            .Where(t => t.RegionID == regionId && t.TeamID.HasValue)
            .ToList();

        if (!regionTeamRows.Any())
        {
            Snackbar.Add("No team found for this region. Click 'Set as Team' first.", Severity.Warning);
            return;
        }

        int teamId = regionTeamRows.First().TeamID!.Value;

        var playerIds = regionTeamRows
            .Where(t => !string.IsNullOrWhiteSpace(t.PlayerID))
            .Select(t => t.PlayerID.Trim())
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToList();

        if (!playerIds.Any())
        {
            Snackbar.Add("Team has no players.", Severity.Warning);
            return;
        }

        // ✅ Dialog: NO linking, single performance only
        var parameters = new DialogParameters<GymnasticsScore>
    {
        { x => x.RegionID, regionId },
        { x => x.PlayerID, playerIds.First() },
        { x => x.EventID, sourceEventId },

        { x => x.IsTeamEvent, true },
        { x => x.TeamPlayerIDs, playerIds },
        { x => x.TeamID, teamId },

        { x => x.ForcedCategoryName, "Team Championship" },

        // ✅ IMPORTANT: ensure linked save is OFF
        { x => x.SaveToLinkedPerformances, false },
        { x => x.LinkedPerformanceIDs, new List<int>() },

        { x => x.OnScoreSaved, EventCallback.Factory.Create(this, HandleScoreSaved) }
    };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<GymnasticsScore>("", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
            await HandleScoreSaved();
    }

    private async Task AddAerobicTeamChampionshipScore(int aerobicDanceEventId, int regionId)
    {
        try
        {
            // 1) Load reference event (from the row you clicked)
            string eventUrl = $"/PerformanceBased/PerformanceEvent/{aerobicDanceEventId}";
            var evt = await apiService.GetSingleAsync<PerformanceBasedDTO.PerformanceEvent>(eventUrl);

            if (evt == null)
            {
                var list = await apiService.GetAsync<PerformanceBasedDTO.PerformanceEvent>(eventUrl);
                evt = list?.FirstOrDefault();
            }

            if (evt == null)
            {
                Snackbar.Add("Event not found.", Severity.Error);
                return;
            }

            // 2) Finals only guard (optional)
            if (evt.StageID != 4)
            {
                Snackbar.Add("Team Championship scoring is only for Finals stage.", Severity.Warning);
                return;
            }

            // 3) ✅ Use the SAME deterministic TeamID created in SetAsTeam( ..., isAerobicTeamChampionship:true )
            int teamChampTeamId = GetAerobicTeamChampionshipTeamId(regionId, evt.SportID);

            // 4) ✅ Ensure team really exists before opening dialog
            //    (your main page already prevents this, but this avoids direct calls)
            bool exists = _allOpposingTeams.Any(t =>
                t.RegionID == regionId &&
                t.TeamID.HasValue &&
                t.TeamID.Value == teamChampTeamId &&
                t.PerformanceID == aerobicDanceEventId // at least in this event
            );

            if (!exists)
            {
                Snackbar.Add("Please click 'Set as Team' first for Team Championship.", Severity.Info);
                return;
            }

            // 5) Open dialog - TEAM MODE + TeamID set
            var parameters = new DialogParameters<GymnasticsScore>
        {
            { x => x.RegionID, regionId },
            { x => x.EventID, aerobicDanceEventId },

            // ✅ team mode
            { x => x.IsTeamEvent, true },
            { x => x.TeamID, teamChampTeamId },

            // ✅ lock to Team Championship category
            { x => x.ForcedCategoryName, "Team Championship" },

            // ✅ optional: if your dialog uses this flag to trigger special save/medal propagation
            { x => x.IsAerobicRegionChampionship, true },

            { x => x.OnScoreSaved, EventCallback.Factory.Create(this, HandleScoreSaved) }
        };

            var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Small,
                FullWidth = true,
                CloseOnEscapeKey = true
            };

            var dialog = await DialogService.ShowAsync<GymnasticsScore>("", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled)
                await HandleScoreSaved();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error opening aerobic team championship: {ex.Message}", Severity.Error);
        }
    }

    private List<int> GetPairedC1C2EventIds(int currentEventId)
    {
        var evt = _gymnasticsEvents?.FirstOrDefault(e => e.ID == currentEventId);
        if (evt == null) return new List<int> { currentEventId };

        var isElementary = GetSchoolLevelName(evt.LevelID)?
            .Contains("Elementary", StringComparison.OrdinalIgnoreCase) == true;

        if (!isElementary)
            return new List<int> { currentEventId };

        // find both C1 + C2 siblings for same sport/level/gender/stage
        var ids = _gymnasticsEvents!
            .Where(e =>
                e.SportID == evt.SportID &&
                e.LevelID == evt.LevelID &&
                e.GenderID == evt.GenderID &&
                e.StageID == evt.StageID &&
                (IsWAGEventC1(e) || IsWAGEventC2(e) || IsMAGEventC1(e) || IsMAGEventC2(e)))
            .Select(e => e.ID)
            .Distinct()
            .ToList();

        return ids.Any() ? ids : new List<int> { currentEventId };
    }

    private bool IsAerobicGymnasticsEvent(PerformanceBasedDTO.PerformanceEvent? evt)
    {
        if (evt == null) return false;
        return !string.IsNullOrWhiteSpace(evt.MainCategory)
            && evt.MainCategory.Contains("Aerobic Gymnastics", StringComparison.OrdinalIgnoreCase);
    }

    private async Task<List<int>> GetAllAerobicFinalsEventIds_AllLevelsAllGenders(PerformanceBasedDTO.PerformanceEvent currentEvent)
    {
        // Prefer local list if available
        if (_gymnasticsEvents != null && _gymnasticsEvents.Any())
        {
            return _gymnasticsEvents
                .Where(e =>
                    e.StageID == 4 &&
                    !string.IsNullOrWhiteSpace(e.MainCategory) &&
                    e.MainCategory.Contains("Aerobic Gymnastics", StringComparison.OrdinalIgnoreCase) &&
                    e.SportID == currentEvent.SportID)
                .Select(e => e.ID)
                .Distinct()
                .ToList();
        }

        // Fallback: query API
        var queryParts = new List<string>();

        if (currentEvent.SportID.HasValue)
            queryParts.Add($"sportID={currentEvent.SportID.Value}");

        if (!string.IsNullOrWhiteSpace(currentEvent.MainCategory))
            queryParts.Add($"mainCategory={Uri.EscapeDataString(currentEvent.MainCategory)}");

        queryParts.Add("stageID=4");

        var url = "/PerformanceBased/PerformanceEvents";
        if (queryParts.Any())
            url += "?" + string.Join("&", queryParts);

        var events = await apiService.GetAsync<PerformanceBasedDTO.PerformanceEvent>(url)
                     ?? new List<PerformanceBasedDTO.PerformanceEvent>();

        return events.Select(e => e.ID).Distinct().ToList();
    }

    private int GetAerobicTeamChampionshipTeamId(int regionId, int? sportId)
    {
        // Large range to avoid collision with normal team IDs
        // Make stable per sport+region so repeat calls don't create different TeamIDs
        int sid = sportId ?? 0;
        return 90000000 + (sid * 1000) + regionId;
    }

    private int GetCombinedEventsTeamId(int regionId, int? sportId, int stageId, int groupKey)
    {

        int sid = sportId ?? 0;
        int safeGroup = groupKey % 10000;

        return 80000000
             + (sid * 100000)
             + (stageId * 10000)
             + (safeGroup * 100)
             + regionId; // ✅ keep full region id
    }

    private int GetAerobicDanceEventIdOrFallback(PerformanceBasedDTO.PerformanceEvent currentEvent, List<int> eventIds)
    {
        var danceEvt = _gymnasticsEvents?
            .FirstOrDefault(e =>
                e.SportID == currentEvent.SportID &&
                e.StageID == currentEvent.StageID &&
                IsAerobicEvent(e) &&
                IsMixedGender(e) &&
                IsMixed(e) &&
                HasFiveToEightPlayersPerRegion(e));

        if (danceEvt != null)
            return danceEvt.ID;

        if (IsAerobicEvent(currentEvent) && IsMixedGender(currentEvent) && IsMixed(currentEvent) && HasFiveToEightPlayersPerRegion(currentEvent))
            return currentEvent.ID;

        return eventIds.Min();
    }

    private bool IsTeamChampionshipTeamId(int? teamId)
    {
        return teamId.HasValue && teamId.Value >= 90000000;
    }

    private const int CombinedTeamIdBase = 80000000;

private static bool IsEditableTeamId(int? teamId)
    => !teamId.HasValue || teamId.Value < CombinedTeamIdBase;


    // Data models
    public class ScoreboardItem
    {
        public int PerformanceID { get; set; }
        public int RegionID { get; set; }
        public string Region { get; set; } = string.Empty;
        public string PlayerID { get; set; } = string.Empty;
        public int LevelID { get; set; }
        public string Gymnast { get; set; } = string.Empty;
        public decimal TotalScore { get; set; }
        public int? TeamID { get; set; }
        public List<string> TeamPlayerIDs { get; set; } = new();
        public List<string> TeamGymnasts { get; set; } = new();
        public bool IsTeam => TeamID.HasValue && TeamPlayerIDs.Count > 1;
        public bool IsIndividual => !TeamID.HasValue || TeamPlayerIDs.Count == 1;
        public string Level { get; set; } = string.Empty;
    }

    public class IndividualAllAroundRank
    {
        public int Rank { get; set; }
        public string PlayerID { get; set; }
        public string PlayerName { get; set; }
        public int RegionID { get; set; }
        public string RegionName { get; set; }
        public decimal Total { get; set; }
    }

    public class TeamRank
    {
        public int Rank { get; set; }
        public int RegionID { get; set; }
        public int? TeamID { get; set; }
        public string RegionName { get; set; }
        public decimal TeamTotal { get; set; }
        public int LevelID { get; set; }
        public string Level { get; set; } = string.Empty;
    }

    public class PerformanceBasedDTO
    {
        public class PerformanceEvent
        {
            public int ID { get; set; }
            public int? SportID { get; set; }
            public string MainCategory { get; set; }
            public int? LevelID { get; set; }
            public int? GenderID { get; set; }
            public int StageID { get; set; }
        }

        public class PerformanceTeam
        {
            public int ID { get; set; }
            public int PerformanceID { get; set; }
            public int? TeamID { get; set; }
            public int RegionID { get; set; }
            public string PlayerID { get; set; }
        }

        public class PerformanceScore
        {
            public int ID { get; set; }
            public int PerformanceID { get; set; }
            public int? PerformanceTeamID { get; set; }
            public int SportSubcategoryID { get; set; }
            public decimal Score { get; set; }
            public int Rank { get; set; }
            public string? UserID { get; set; }
            public DateTime UpdatedAt { get; set; }
            public int? TeamID { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class SchoolLevels
        {
            public int ID { get; set; }
            public string? Level { get; set; }
        }

        public class SchoolRegion
        {
            public int? ID { get; set; }
            public string Region { get; set; }
            public string? Abbreviation { get; set; }
        }
    }

    public class SportsDTO
    {
        public class SportCategories
        {
            public int ID { get; set; }
            public string? Category { get; set; }
        }

        public class Sports
        {
            public int ID { get; set; }
            public string? Sport { get; set; }
            public string? Description { get; set; }
            public int? SportCategoryID { get; set; }
        }

        public class SportSubcategories
        {
            public int ID { get; set; }
            public string? Subcategory { get; set; }
            public int? SportID { get; set; }
            public int? SportGenderCategoryID { get; set; }
            public int? SchoolLevelID { get; set; }
            public string? MainCategory { get; set; }
        }

        public class SportGenderCategories
        {
            public int ID { get; set; }
            public string? Gender { get; set; }
        }
    }

    public class ProfilePlayersDTO
    {
        public class Players
        {
            public string ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }
    }

    public class EventsDTO
    {
        public class EventStages
        {
            public int ID { get; set; }
            public string? Stage { get; set; }
        }

        public class EventVersusTeams
        {
            public int ID { get; set; }
            public string? EventID { get; set; }
            public int? PerformanceScoreID { get; set; }
            public int? SchoolRegionID { get; set; }
            public string? Score { get; set; }
            public string? Rank { get; set; }
            public DateTime? RecentUpdateAt { get; set; }
        }
    }

    private class TeamSelection
    {
        public int PerformanceID { get; set; }
        public int RegionID { get; set; }
        public ICollection<string> PlayerIDs { get; set; } = new HashSet<string>();
        public int TeamID { get; set; }
    }
}

