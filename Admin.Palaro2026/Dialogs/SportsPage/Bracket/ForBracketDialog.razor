@using System.Net.Http
@using System.Text.Json
@using System.Threading.Tasks
@using System.Text
@using System.Text.RegularExpressions
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject APIService apiService
@inject HttpClient httpClient

@if (_isLoaded)
{
    <MudDialog>
        <DialogContent>
            <MudGrid Spacing="1">
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_selectedbracketName" Label="Bracket Name" Variant="Variant.Outlined" Immediate="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="_selectedSportID" Margin="Margin.Dense" Label="Sport" ShrinkLabel Variant="Variant.Outlined" T="int?" Clearable>
                        <MudVirtualize Items="_sports" Context="sport">
                            <MudSelectItem T="int?" Value="sport.ID">@sport.Sport</MudSelectItem>
                        </MudVirtualize>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudSelect @bind-Value="_selectedRegions"
                               T="List<int>"
                               MultiSelection="true"
                               Margin="Margin.Dense"
                               Label="Region"
                               ShrinkLabel
                               Variant="Variant.Outlined"
                               Clearable>
                        @if (_schoolRegions != null)
                        {
                            @foreach (var region in _schoolRegions)
                            {
                                <MudSelectItem T="int" Value="@region.ID">
                                    @region.Region (@region.Abbreviation)
                                </MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </DialogContent>

        <DialogActions>
            <MudStack Row Justify="Justify.SpaceBetween" Style="width: 100%">
                @if (_isEdit)
                {
                    <MudButton Color="Color.Error" OnClick="ConfirmDeleteBracketAsync">Delete</MudButton>
                }
                <MudStack Row Justify="Justify.SpaceBetween">
                    <MudButton Style="text-transform: none" DropShadow="false" OnClick="Cancel">Cancel</MudButton>
                    <MudButton OnClick="ConfirmSaveBracketAsync" Disabled="@_saveDisabled">@(_isEdit ? "Update" : "Add")</MudButton>
                </MudStack>
            </MudStack>
        </DialogActions>
    </MudDialog>

}
else
{
    <MudDialog>
        <DialogContent>
            <MudProgressLinear Indeterminate="true" Class="my-5" />
        </DialogContent>
    </MudDialog>
}

@code {
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }

    [Parameter] public int? BracketID { get; set; } // null for Add, value for Edit
    private bool _isEdit => BracketID.HasValue;

    private List<SportsDTO.Sports>? _sports;
    private List<SchoolsDTO.SchoolRegions>? _schoolRegions;
    private List<int> _selectedRegions = new();
    private int? _selectedSportID;
    private string? _selectedbracketName;

    private bool _isLoaded = false;
    private bool _saveDisabled => string.IsNullOrWhiteSpace(_selectedbracketName) || !_selectedSportID.HasValue;

    public class SportsDTO
    {
        public class Sports
        {
            public int ID { get; set; }
            public string? Sport { get; set; }
            public string? Description { get; set; }
            public int? SportCategoryID { get; set; }
        }
        public class SportsBracket
        {
            public int ID { get; set; }
            public int SportID { get; set; }
            public string? BracketName { get; set; }
            public string? SportName { get; set; }
            public List<SportsBracketRegions>? RegionsList { get; set; }
        }

        public class SportsBracketRegions
        {
            public int ID { get; set; }
            public int BracketID { get; set; }
            public int RegionID { get; set; }
            public string? RegionName { get; set; }
            public string? RegionAbbreviation { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class SchoolRegions
        {
            public int ID { get; set; }
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await GetSportsAsync();
        await GetSchoolRegionsAsync();

        _isLoaded = true;
    }


    private async Task GetSportsAsync()
    {
        string url = $"/Sports?sportCategoryID={_selectedSportID}";

        _sports = await apiService.GetAsync<SportsDTO.Sports>(url);
    }
    private async Task GetSchoolRegionsAsync()
    {
        string url = $"/Schools/Regions";
        _schoolRegions = await apiService.GetAsync<SchoolsDTO.SchoolRegions>(url);
    }


    private void Cancel() => MudDialog?.Cancel();

    private async Task ConfirmSaveBracketAsync()
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Confirm",
            $"Do you want to {(_isEdit ? "update" : "add")} this bracket?",
            yesText: "Yes",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            await SaveBracketAsync();
            MudDialog?.Close(DialogResult.Ok(true));
        }
    }


    private async Task SaveBracketAsync()
    {
        var dto = new SportsDTO.SportsBracket
            {
                BracketName = _selectedbracketName,
                SportID = _selectedSportID!.Value,
                RegionsList = _selectedRegions
                        .Select(rid => new SportsDTO.SportsBracketRegions
                        {
                            RegionID = rid
                        })
                        .ToList()
            };

        if (_isEdit)
        {
            await apiService.PutAsync($"/SportsBracket/{BracketID}", dto);
            Snackbar.Add("Bracket updated successfully.", Severity.Success);
        }
        else
        {
            await apiService.PostAsync("/SportsBracket", dto);
            Snackbar.Add("Bracket added successfully.", Severity.Success);
        }
    }



    private async Task ConfirmDeleteBracketAsync()
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Confirm Delete",
            "Do you really want to delete this bracket?",
            yesText: "Yes",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            await DeleteBracketAsync();
            MudDialog?.Close(DialogResult.Ok(true));
        }
    }

    private async Task DeleteBracketAsync()
    {
        if (BracketID.HasValue)
        {
            await apiService.DeleteAsync($"/SportsBracket/{BracketID}");
            Snackbar.Add("Bracket deleted successfully.", Severity.Success);
        }
    }
}
