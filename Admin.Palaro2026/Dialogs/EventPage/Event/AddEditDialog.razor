@using System.Net.Http
@using System.Net.Http.Headers
@using System.Text.Json
@using System.Threading.Tasks
@using System.Text
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject APIService apiService
@inject HttpClient httpClient

@if (_isLoaded == true)
{
    <MudDialog>
        <DialogContent>
            <MudGrid Spacing="5">

                <!-- Input Fields: dialogs, checkbox, datetime pickers -->
                <!-- Sport -->
                @if (IsSuperuser || IsEventManager || IsRegionalFacilitator)
                {
                    <MudItem xs="12" Class="mb-3">
                        <MudStack Spacing="1">
                            <MudText>Sport Details</MudText>
                            <MudDivider />
                            <MudGrid Spacing="1">
                                <MudItem xs="12" sm="6" md="4">
                                    <MudSelect @bind-Value="_selectedSportCategoryIDValue" Margin="Margin.Dense"
                                               Label="Classification" T="int?"
                                               ShrinkLabel Variant="Variant.Outlined" Clearable ReadOnly="@IsEditMode"
                                               SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                                      {
                                                                          _selectedSportIDValue = null;
                                                                          _selectedSchoolLevelIDValue = null;
                                                                          _selectedSportGenderCategoryIDValue = null;
                                                                          _selectedSportSubcategoryIDValue = null;
                                                                          await GetSportsAsync();
                                                                      }))">
                                        <MudVirtualize Items="_sportCategories" Context="category">
                                            <MudSelectItem T="int?"
                                                           Value="category.ID">@category.Category</MudSelectItem>
                                        </MudVirtualize>
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" sm="6" md="3">
                                    <MudSelect @bind-Value="_selectedSportIDValue" Margin="Margin.Dense" Label="Sport"
                                               T="int?" Disabled="_selectedSportCategoryIDValue == null"
                                               ShrinkLabel Variant="Variant.Outlined" Clearable ReadOnly="@IsEditMode"
                                               SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                                      {
                                                                          _selectedSchoolLevelIDValue = null;
                                                                          _selectedSportGenderCategoryIDValue = null;
                                                                          _selectedSportSubcategoryIDValue = null;
                                                                          _selectedSchoolLevelAndGenderID = null;
                                                                          await FilterSchoolLevelAndGenderAsync();

                                                                          FilterBracketsBySport();
                                                                      }))">
                                        <MudVirtualize Items="_sports" Context="sport">
                                            <MudSelectItem T="int?" Value="sport.ID">@sport.Sport</MudSelectItem>
                                        </MudVirtualize>
                                    </MudSelect>
                                </MudItem>


                                <MudItem xs="12" sm="6" md="5">
                                    <MudSelect @bind-Value="_selectedSchoolLevelAndGenderID" Margin="Margin.Dense"
                                               Label="School Level and Gender" T="string"
                                               ShrinkLabel Variant="Variant.Outlined" Clearable
                                               Disabled="_selectedSportIDValue == null" ReadOnly="@IsEditMode"
                                               SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                                      {
                                                                          _selectedSportSubcategoryIDValue = null;
                                                                          _selectedMainCategoryValue = null;
                                                                          await GetSportSubCategoriesSLGAsync();
                                                                          LoadMainCategories();
                                                                      }))">
                                        <MudVirtualize Items="_combinedSchoolLevelAndGenderNames" Context="combinedID">
                                            <MudSelectItem T="string" Value="@combinedID">
                                                @combinedID
                                            </MudSelectItem>
                                        </MudVirtualize>
                                    </MudSelect>
                                </MudItem>

                                <MudItem xs="12" sm="6" md="6">
                                    <MudSelect @bind-Value="_selectedMainCategoryValue" Margin="Margin.Dense"
                                               Label="Event"
                                               T="string"
                                               ShrinkLabel Variant="Variant.Outlined" Clearable ReadOnly="@IsEditMode"
                                               Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                                        @foreach (var mc in _sportMainCat)
                                        {
                                            <MudSelectItem Value="@mc">@mc</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>

                                <MudItem xs="12" sm="12" md="6">
                                    <MudSelect @bind-Value="_selectedSportSubcategoryIDValue" Margin="Margin.Dense"
                                               Label="Category" T="int?"
                                               HelperText="@((_sportSubcategories?.Any() != true && _selectedSchoolLevelAndGenderID != null) ? "No subcategory available for this gender or school level." : null)"
                                               ShrinkLabel Variant="Variant.Outlined" Clearable ReadOnly="@IsEditMode"
                                               Disabled="@(!_sportSubcategories?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                                        <MudVirtualize Items="@GetFilteredSubcategories()" Context="subCategory">
                                            <MudSelectItem T="int?" Value="@subCategory.ID">@subCategory.Subcategory</MudSelectItem>
                                        </MudVirtualize>
                                    </MudSelect>
                                </MudItem>


                            </MudGrid>

                            @if (!IsEditMode && _selectedSportIDValue.HasValue && _selectedMainCategoryValue != null)
                            {
                                <!-- Archery Alert -->
                                @if (_selectedMainCategoryValue?.Equals("1440 Round", StringComparison.OrdinalIgnoreCase) == true)
                                {
                                    <MudAlert Severity="Severity.Info" Class="mt-2" Variant="Variant.Filled">
                                        <MudText Typo="Typo.body2">
                                            @* <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-1" Size="Size.Small" /> *@
                                            <strong>Multiple Events Created:</strong> This Archery 1440 Round will generate 5 events (Overall + 30m, 50m, 60m, 70m distances) with identical team assignments.
                                        </MudText>
                                    </MudAlert>
                                }

                                <!-- DanceSport Alert -->
                                @* @if (_selectedMainCategoryValue?.Equals("Latin American", StringComparison.OrdinalIgnoreCase) == true)
                                {
                                    <MudAlert Severity="Severity.Info" Class="mt-2" Variant="Variant.Filled">
                                        <MudText Typo="Typo.body2">
                                            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-1" Size="Size.Small" />
                                            <strong>Multiple Events Created:</strong> This Latin American DanceSport will generate 5 single dance events:
                                            ChaChaCha, Jive, Pasodoble, Rumba, and Samba.
                                        </MudText>
                                    </MudAlert>
                                }

                                @if (_selectedMainCategoryValue?.Equals("Modern Standard", StringComparison.OrdinalIgnoreCase) == true)
                                {
                                    <MudAlert Severity="Severity.Info" Class="mt-2" Variant="Variant.Filled">
                                        <MudText Typo="Typo.body2">
                                            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-1" Size="Size.Small" />
                                            <strong>Multiple Events Created:</strong> This Modern Standard DanceSport will generate 5 single dance events:
                                            Tango, Foxtrot, Quickstep, Viennese Waltz, and Waltz.
                                        </MudText>
                                    </MudAlert>
                                } *@
                            }
                        </MudStack>
                    </MudItem>


                    <!-- Event Stage -->
                    <MudItem xs="12" Class="mb-3">
                        <MudStack Spacing="1">
                            <MudText>Event Stage Detail</MudText>
                            <MudDivider />
                            <MudGrid Spacing="1">
                                <MudItem xs="12" sm="6" md="4">
                                    <MudSelect @bind-Value="_selectedEventStagesIDValue" Margin="Margin.Dense"
                                               Label="Stage"
                                               T="int?"
                                               ShrinkLabel Variant="Variant.Outlined" Clearable>
                                        <MudVirtualize Items="_eventStages" Context="eventStage">
                                            <MudSelectItem T="int?"
                                                           Value="eventStage.ID">@eventStage.Stage</MudSelectItem>
                                        </MudVirtualize>
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" sm="6" md="4">
                                    <MudSelect T="int?" Label="Select Bracket"
                                               Value="_selectedBracketID"
                                               Margin="Margin.Dense"
                                               ValueChanged="OnBracketChanged" ReadOnly="@IsEditMode"
                                               ShrinkLabel Variant="Variant.Outlined"
                                               Disabled="@(_selectedSportIDValue == null || !_filteredBrackets.Any())">
                                        @foreach (var bracket in _filteredBrackets)
                                        {
                                            <MudSelectItem T="int?" Value="bracket.ID">@bracket.BracketName</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                @if (IsEditMode)
                                {
                                    <MudItem xs="12" sm="6" md="4">
                                        <MudSelect @bind-Value="_selectedIsEventFinishedValue"
                                                   Label="Status"
                                                   T="bool?"
                                                   Variant="Variant.Outlined"
                                                   Clearable Margin="Margin.Dense"
                                                   Disabled="@(!CanEditAllFields)">
                                            <MudSelectItem T="bool?" Value="true">Finished</MudSelectItem>
                                            <MudSelectItem T="bool?" Value="false">Ongoing</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                }
                            </MudGrid>
                        </MudStack>
                    </MudItem>


                    <!-- Schedule and Venue -->
                    <MudItem xs="12" Class="mb-3">
                        <MudStack Spacing="1">
                            <MudText>Schedule and Venue Details</MudText>
                            <MudDivider />
                            <MudGrid Spacing="1">
                                <MudItem xs="12" sm="6" md="4">
                                    <MudSelect @bind-Value="_selectedEventVenueIDValue" Margin="Margin.Dense"
                                               Label="Venue"
                                               T="int?"
                                               ShrinkLabel Variant="Variant.Outlined" Clearable>
                                        <MudVirtualize Items="_eventVenues" Context="venue">
                                            <MudSelectItem T="int?"
                                                           Value="venue.ID">@venue.Venue, @venue.Address</MudSelectItem>
                                        </MudVirtualize>
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" sm="6" md="4">
                                    <MudDatePicker @bind-Date="_selectedDateValue" Variant="Variant.Outlined"
                                                   Margin="Margin.Dense" Label="Date"
                                                   Placeholder="&#8205;" Clearable
                                                   PickerVariant="PickerVariant.Dialog" />
                                </MudItem>
                                <MudItem xs="12" sm="6" md="4">
                                    <MudTimePicker @bind-Time="_selectedTimeValue" Variant="Variant.Outlined"
                                                   Margin="Margin.Dense" Label="Time" AmPm="true"
                                                   Placeholder="&#8205;" Clearable
                                                   PickerVariant="PickerVariant.Dialog" />
                                </MudItem>
                            </MudGrid>
                        </MudStack>
                    </MudItem>

                    <!-- Opposing Team with Placement -->
                    <MudItem xs="12" Class="mb-3">
                        <MudStack Spacing="1">
                            <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudText>Opposing Team</MudText>
                                <MudButton StartIcon="@Icons.Material.Filled.Add"
                                           OnClick="AddOpponent"
                                           Disabled="IsEditMode || _schoolRegions == null || !_schoolRegions.Any()">
                                    Add Opponent
                                </MudButton>
                            </MudStack>
                            <MudDivider />

                            @for (int i = 0; i < _teamSelections.Count; i++)
                            {
                                var team = _teamSelections[i];
                                <MudGrid Spacing="2">
                                    <MudItem xs="12">
                                       
                                            <MudStack Spacing="2">
                                                <MudGrid Spacing="2">
                                                    <!-- Region Select -->
                                                    <MudItem xs="12">
                                                        <MudSelect @bind-Value="team.SelectedRegionID"
                                                                   Margin="Margin.Dense"
                                                                   Label="Region"
                                                                   ShrinkLabel
                                                                   Variant="Variant.Outlined"
                                                                   T="int?"
                                                                   Clearable
                                                                   SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                                      {
                                                                          team.SelectedPlayerIDs = new List<string>();
                                                                          await GetPlayerAsync(team);
                                                                      }))"
                                                                   Disabled="IsEditMode">
                                                            <MudVirtualize Items="_schoolRegions" Context="region">
                                                                <MudSelectItem T="int?" Value="@region.ID">
                                                                    @region.Region (@region.Abbreviation)
                                                                </MudSelectItem>
                                                            </MudVirtualize>
                                                        </MudSelect>
                                                    </MudItem>

                                                    <!-- Players Select -->
                                                    <MudItem xs="12">
                                                        <MudSelect @bind-SelectedValues="team.SelectedPlayerIDs"
                                                                   MultiSelection="true"
                                                                   SelectAll="true"
                                                                   Clearable
                                                                   Margin="Margin.Dense"
                                                                   Label="Players"
                                                                   ShrinkLabel
                                                                   Variant="Variant.Outlined"
                                                                   Disabled="!team.SelectedRegionID.HasValue || !_selectedSportSubcategoryIDValue.HasValue || IsEditMode"
                                                                   T="string"
                                                                   ToStringFunc="@(id => {
                                                                       if (string.IsNullOrEmpty(id)) return "No player selected";

                                                                       // TEMPORARY: Show loading message while fetching
                                                                       if (team.AvailablePlayers == null || !team.AvailablePlayers.Any())
                                                                           return $"{id} (Loading...)";

                                                                       // Find the player in AvailablePlayers by ID
                                                                       var player = team.AvailablePlayers?.FirstOrDefault(p => p.ID == id);

                                                                       if (player != null)
                                                                       {
                                                                           // Show name if available, otherwise show ID
                                                                           if (!string.IsNullOrEmpty(player.FirstName) && !string.IsNullOrEmpty(player.LastName))
                                                                               return $"{player.FirstName} {player.LastName}";
                                                                           else if (!string.IsNullOrEmpty(player.FirstName))
                                                                               return player.FirstName;
                                                                           else if (!string.IsNullOrEmpty(player.LastName))
                                                                               return player.LastName;
                                                                       }

                                                                       // Fallback to showing the ID
                                                                       return id ?? "Unknown Player";
                                                                   })">

                                                            <!-- Show all available players with their names -->
                                                            @if (team.AvailablePlayers != null && team.AvailablePlayers.Any())
                                                            {
                                                                <MudVirtualize Items="team.AvailablePlayers" Context="player">
                                                                    <MudSelectItem T="string" Value="@player.ID">
                                                                        @player.FirstName @player.LastName
                                                                    </MudSelectItem>
                                                                </MudVirtualize>
                                                            }
                                                            else
                                                            {
                                                                <!-- Show IDs while loading -->
                                                                @if (team.SelectedPlayerIDs != null && team.SelectedPlayerIDs.Any())
                                                                {
                                                                    @foreach (var playerId in team.SelectedPlayerIDs)
                                                                    {
                                                                        <MudSelectItem T="string" Value="@playerId">
                                                                            @playerId (Loading...)
                                                                        </MudSelectItem>
                                                                    }
                                                                }
                                                            }
                                                        </MudSelect>
                                                    </MudItem>
                                                </MudGrid>

                                                <!-- Score and Placement - visible when event is finished in edit mode -->
                                                @if (IsEditMode && _selectedIsEventFinishedValue == true)
                                                {
                                                    <MudGrid Spacing="2">
                                                        <MudItem xs="12">
                                                            @{
                                                                var selectedStage = GetSelectedStageName();
                                                                var isFinalsStage = selectedStage?.Equals("Finals", StringComparison.OrdinalIgnoreCase) == true;
                                                                var availablePlacements = isFinalsStage ? _championshipPlacements : _placements;
                                                            }

                                                            <MudSelect T="string"
                                                                       @bind-Value="team.Rank"
                                                                       Label="Placement"
                                                                       ShrinkLabel
                                                                       Variant="Variant.Outlined"
                                                                       Margin="Margin.Dense"
                                                                       Clearable>
                                                                @if (availablePlacements is not null)
                                                                {
                                                                    <MudVirtualize Items="availablePlacements" Context="placement">
                                                                        <MudSelectItem T="string" Value="@placement">@placement</MudSelectItem>
                                                                    </MudVirtualize>
                                                                }
                                                            </MudSelect>
                                                        </MudItem>
                                                    </MudGrid>
                                                }

                                                <!-- Remove button for non-edit mode -->
                                                @if (!IsEditMode && i > 0)
                                                {
                                                    <MudItem xs="12">
                                                        <MudButton Size="Size.Small"
                                                                   Variant="Variant.Text"
                                                                   Color="Color.Error"
                                                                   StartIcon="@Icons.Material.Filled.Delete"
                                                                   OnClick="@(() => RemoveOpposingTeam(i))">
                                                            Remove Team
                                                        </MudButton>
                                                    </MudItem>
                                                }
                                            </MudStack>
                                        
                                    </MudItem>
                                </MudGrid>

                                @if (i < _teamSelections.Count - 1)
                                {
                                    <MudText Align="Align.Center" Typo="Typo.h6" Class="mt-2 mb-2">VS</MudText>
                                }
                            }
                        </MudStack>
                    </MudItem>
                }

                <!-- Stream Section: Only for News Administrator -->
                @if (UserRole == "News Administrator" || UserRole == "Superuser")
                {
                    <MudItem xs="12" Class="mb-3">
                        <MudStack Spacing="1">
                            <MudText>Streaming Service Details</MudText>
                            <MudDivider />
                            <MudGrid Spacing="1">
                                <MudItem xs="12" md="2">
                                    <MudCheckBox Value="_isOnStream" Size="Size.Small" T="bool?"
                                                 Color="@Color.Secondary"
                                                 ValueChanged="@(value =>
                                                               {
                                                                   _isOnStream = value;
                                                                   _selectedEventStreamServiceIDValue = null;
                                                                   _selectedEventStreamIDValue = null;
                                                               })">
                                        On Stream
                                    </MudCheckBox>
                                </MudItem>
                                <MudItem xs="12" sm="6" md="5">
                                    <MudSelect @bind-Value="_selectedEventStreamServiceIDValue" Margin="Margin.Dense"
                                               Disabled="_isOnStream == false"
                                               Label="Stream Service" ShrinkLabel Variant="Variant.Outlined" Clearable
                                               T="int?"
                                               SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                                      {
                                                                          _selectedEventStreamIDValue = null;
                                                                          await GetStreamsAsync();
                                                                      }))">
                                        <MudVirtualize Items="_eventStreamServices" Context="streamService">
                                            <MudSelectItem T="int?"
                                                           Value="streamService.ID">@streamService.StreamService</MudSelectItem>
                                        </MudVirtualize>
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12" sm="6" md="5">
                                    <MudSelect @bind-Value="_selectedEventStreamIDValue" Margin="Margin.Dense"
                                               HelperText="@((_eventStreams?.Any() != true && _selectedEventStreamServiceIDValue != null) ? "No stream available for this streaming service." : null)"
                                               Disabled="@(_selectedEventStreamServiceIDValue == null || (_eventStreams?.Any() != true && _selectedEventStreamServiceIDValue != null))"
                                               Label="Stream" ShrinkLabel Variant="Variant.Outlined" Clearable>
                                        <MudVirtualize Items="_eventStreams" Context="stream">
                                            <MudSelectItem T="int?"
                                                           Value="@stream.ID">@stream.StreamTitle</MudSelectItem>
                                        </MudVirtualize>
                                    </MudSelect>
                                </MudItem>
                            </MudGrid>
                        </MudStack>
                    </MudItem>
                }



                <!-- Clerk Designate Section: Only for Event Manager -->
                @if (UserRole == "Event Manager" || UserRole == "Superuser" || UserRole == "Tally Clerk")
                {
                    <MudItem xs="12">
                        <MudStack Spacing="1">
                            <MudText>Designate Tally Clerk</MudText>
                            <MudDivider />
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudItem xs="12" sm="6" md="6">
                                    <MudSelect @bind-Value="_selectedUserIDValue"
                                               Margin="Margin.Dense"
                                               Label="Tally Clerk"
                                               ShrinkLabel
                                               Variant="Variant.Outlined"
                                               Clearable
                                               ReadOnly="@(IsTallyClerk)">
                                        <MudVirtualize Items="_userLists" Context="user">
                                            <MudSelectItem T="string" Value="user.ID">
                                                @user.FirstName @user.LastName
                                            </MudSelectItem>
                                        </MudVirtualize>
                                    </MudSelect>
                                </MudItem>

                                @if (IsEditMode && _selectedIsEventFinishedValue == true)
                                {
                                    <MudItem xs="12" sm="6" md="6">
                                        <MudStack Row AlignItems="AlignItems.Center">
                                            <MudFileUpload T="IBrowserFile"
                                                           FilesChanged="HandleRegionLogoFileUpload"
                                                           Disabled="@(!(IsTallyClerk || IsSuperuser))">
                                                <ActivatorContent>
                                                    <MudIconButton Icon="@Icons.Material.Filled.Upload"
                                                                   Variant="Variant.Filled"
                                                                   Color="Color.Primary" />
                                                </ActivatorContent>
                                            </MudFileUpload>

                                            <MudButton StartIcon="@Icons.Material.Filled.AttachFile"
                                                       Href="@_eventAttachmentUrl"
                                                       Target="_blank"
                                                       Disabled="@(!_fileExists)">
                                                <MudText Class="ml-2">@_eventAttachmentUploadState</MudText>
                                            </MudButton>
                                        </MudStack>
                                    </MudItem>
                                }
                            </MudStack>
                        </MudStack>
                    </MudItem>
                }

            </MudGrid>
        </DialogContent>
        <DialogActions>
            @if (IsEditMode)
            {
                <!-- Edit Mode: Delete | Cancel | Update -->
                <MudStack Row Justify="Justify.SpaceBetween" Style="width: 100%">
                    <MudButton Style="text-transform: none" DropShadow="false" Color="Color.Error"
                               OnClick="ConfirmDeleteEventAsync">
                        Delete
                    </MudButton>
                    <MudStack Row AlignItems="AlignItems.Center">
                        <MudButton Style="text-transform: none" DropShadow="false" OnClick="Cancel">
                            Cancel
                        </MudButton>
                        <MudButton Style="text-transform: none" DropShadow="false" OnClick="ConfirmUpdateEventAsync">
                            Update
                        </MudButton>
                    </MudStack>
                </MudStack>
            }
            else
            {
                <!-- Add Mode: Cancel | Clear | Add -->
                <MudStack Row Justify="Justify.SpaceBetween" Style="width: 100%">
                    <MudButton Style="text-transform: none" DropShadow="false" OnClick="Cancel">
                        Cancel
                    </MudButton>
                    <MudStack Row AlignItems="AlignItems.Center">
                        <MudButton Style="text-transform: none" DropShadow="false" OnClick="ClearFields">
                            Clear
                        </MudButton>
                        <MudButton Style="text-transform: none" DropShadow="false" OnClick="ConfirmAddEventAsync">
                            Add
                        </MudButton>
                    </MudStack>
                </MudStack>
            }
        </DialogActions>
    </MudDialog>
}
else
{
    <MudDialog>
        <DialogContent>
            <MudProgressLinear Indeterminate="true" Class="my-5" />
        </DialogContent>
    </MudDialog>
}


@code {

    // ------------------------------
    // Dialog & Services
    // ------------------------------
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }
    [Inject] private CookieService cookieService { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;

    // ------------------------------
    // Parameters
    // ------------------------------
    [Parameter] public string? SelectedEventID { get; set; }
    [Parameter] public int? SelectedSubCategoryID { get; set; }
    [Parameter] public bool IsEditMode { get; set; } = false;
    [Parameter] public int? SelectedEventVersusTeamsID { get; set; }
    [Parameter] public string? SelectedEventStage { get; set; }

    [Parameter] public bool IsProgressionMode { get; set; } = false;
    [Parameter] public string? PreviousEventID { get; set; }
    // [Parameter] public List<ProgressionDTO.ProgressionTeamSelection>? ProgressionTeams { get; set; }

    [Parameter]
    public List<Dictionary<string, object>>? ProgressionTeams { get; set; } = new();


    // ------------------------------
    // User Roles & Permissions
    // ------------------------------
    private string? UserRole;
    private bool IsNewsAdmin => UserRole == "News Administrator";
    private bool IsSuperuser => UserRole == "Superuser";
    private bool IsEventManager => UserRole == "Event Manager";
    private bool IsRegionalFacilitator => UserRole == "Regional Facilitator";
    private bool IsTallyClerk => UserRole == "Tally Clerk";

    private bool CanEditAllFields => IsSuperuser || IsEventManager || IsRegionalFacilitator;
    private bool CanEditStreamSection => IsSuperuser || IsEventManager || IsNewsAdmin;
    private bool CanAccessClerkSection => IsSuperuser || IsEventManager;

    private static readonly Random random = new();

    // ------------------------------
    // DTO Lists
    // ------------------------------
    private List<EventsDTO.EventStages>? _eventStages;
    private List<SportsDTO.SportCategories>? _sportCategories;
    private List<SportsDTO.Sports>? _sports;
    private List<SportsDTO.SportGenderCategories>? _sportGenderCategories;
    private List<SchoolsDTO.SchoolLevels>? _schoolLevels;
    private List<SportsDTO.SportSubcategories>? _sportSubcategories;
    private List<SchoolsDTO.SchoolRegions>? _schoolRegions;
    private List<EventsDTO.EventVenues>? _eventVenues;
    private List<EventsDTO.EventStreamServices>? _eventStreamServices;
    private List<EventsDTO.EventStreams>? _eventStreams;
    private List<UsersDTO.UserList>? _userLists;
    private List<ProfilesDTO.ProfilePlayerEvent>? _profilePlayerEvents;
    private List<EventsDTO.EventVersusTeams>? _eventVersusTeams;
    private List<EventsDTO.EventVersusTeamPlayers>? _eventVersusTeamPlayers;
    private List<SportsDTO.SportsBracketRegions>? _regionsForSelectedBracket;
    private List<BracketDisplayRow> _brackets = new();
    private List<BracketDisplayRow> _filteredBrackets = new();

    // ------------------------------
    // Selected Values
    // ------------------------------
    private int? _selectedEventStagesIDValue;
    private int? _selectedSportCategoryIDValue = 1;
    private int? _selectedSportIDValue;
    private int? _selectedSportGenderCategoryIDValue;
    private int? _selectedSchoolLevelIDValue;
    private string? _selectedMainCategoryValue;
    private int? _selectedSportSubcategoryIDValue;
    private int? _selectedEventVenueIDValue;
    private DateTime? _selectedDateValue = DateTime.Now;
    private TimeSpan? _selectedTimeValue;
    private bool? _isOnStream = false;
    private int? _selectedEventStreamServiceIDValue;
    private int? _selectedEventStreamIDValue;
    private string? _selectedUserIDValue;
    private int? _selectedRegionIDValue;
    private IEnumerable<string?>? _selectedPlayerIDs;
    private int? _createdEventVersusTeamIDValue;
    private bool? _selectedIsEventFinishedValue;
    private bool? _isFinished;
    private bool? _isArchived;
    private bool? _isDeleted;
    private int? _scoreValue;
    private int? _rankValue;
    private DateTime _recentUpdateAt = DateTime.Now;
    private string? _GamePhaseValue;
    private bool _isLoaded = false;
    private string? _selectedSchoolLevelAndGenderID;
    private string? _selectedStreamTitle;
    private string? _selectedStreamService;
    private int[]? _versusTeamsIDs;
    private List<int?> selectedRegions { get; set; } = new() { null };
    private int? _selectedBracketID;
    private string? _selectedEventStageName;


    // Opposing team IDs
    private int? _selectedEventVersusTeamsIDValue;
    private int? _selectedEventVersusTeamPlayersIDValue;
    private List<string>? _selectedPlayerIDValues;
    private List<TeamSelection> _teamSelections = new();

    // UI
    private List<string> _combinedSchoolLevelAndGenderNames = new();
    private List<string> _sportMainCat = new();
    private string? _selectedSportMainCat;

    // Attachment
    private string? _updateEventAttachmentValue;
    private string? _eventAttachmentUploadState = "No file uploaded";
    private byte[]? _uploadedFileBytes;
    private string? _uploadedFileContentType;

    private string _eventAttachmentUrl = "";
    private bool _fileExists = false;

    // Allowed extensions to check
    private readonly string[] _extensions = { ".png", ".jpg", ".jpeg", ".pdf", ".doc", ".docx" };

    // ------------------------------
    // Lifecycle
    // ------------------------------
    protected override async Task OnInitializedAsync()
    {
        UserRole = await cookieService.GetCookie("userRole");

        if (IsProgressionMode && PreviousEventID != null)
        {
            await LoadPreviousEventForProgression();

            // Load progression teams FIRST
            if (ProgressionTeams != null && ProgressionTeams.Any())
            {
                await LoadProgressionTeamsAsync();
            }
            else
            {
                await LoadDataAsync();
            }
        }
        else
        {
            await LoadDataAsync();
        }

        // Only add default team if not in progression mode or progression teams are empty
        if (!IsProgressionMode && !_teamSelections.Any())
        {
            _teamSelections.Add(new TeamSelection());
        }

        _isLoaded = true;

        StateHasChanged();
    }

    private async Task LoadProgressionTeamsAsync()
    {
        _teamSelections = new List<TeamSelection>();

        foreach (var teamDict in ProgressionTeams)
        {
            var teamSelection = new TeamSelection();

            // Get basic team info
            if (teamDict.TryGetValue("SelectedRegionID", out var regionIdValue))
            {
                if (regionIdValue != null)
                {
                    teamSelection.SelectedRegionID = Convert.ToInt32(regionIdValue);
                }
            }

            if (teamDict.TryGetValue("ExistingVersusTeamID", out var versusTeamIdValue))
            {
                if (versusTeamIdValue != null)
                {
                    teamSelection.ExistingVersusTeamID = Convert.ToInt32(versusTeamIdValue);
                }
            }

            teamSelection.Score = teamDict.TryGetValue("Score", out var scoreValue) ? scoreValue?.ToString() : "";
            teamSelection.Rank = teamDict.TryGetValue("Rank", out var rankValue) ? rankValue?.ToString() : "Winner";

            // Get player IDs
            teamSelection.SelectedPlayerIDs = new List<string>();
            teamSelection.AvailablePlayers = new List<ProfilesDTO.ProfilePlayerEvent>();

            if (teamDict.TryGetValue("SelectedPlayerIDs", out var playerIdsValue))
            {
                if (playerIdsValue is List<object> playerIdObjects)
                {
                    teamSelection.SelectedPlayerIDs = playerIdObjects
                        .Where(x => x != null)
                        .Select(x => x.ToString() ?? "")
                        .Where(x => !string.IsNullOrEmpty(x))
                        .ToList();
                }
                else if (playerIdsValue is List<string> stringList)
                {
                    teamSelection.SelectedPlayerIDs = stringList;
                }
            }

            _teamSelections.Add(teamSelection);

            _ = Task.Run(async () => await FetchPlayerNamesForTeam(teamSelection));
        }

    }

    private async Task FetchPlayerNamesForTeam(TeamSelection team)
    {
        if (team.SelectedPlayerIDs == null || !team.SelectedPlayerIDs.Any())
            return;

       

        var newAvailablePlayers = new List<ProfilesDTO.ProfilePlayerEvent>();

        foreach (var playerId in team.SelectedPlayerIDs)
        {
            try
            {
                // Fetch player details
                var playerUrl = $"/Profiles/Player?ID={playerId}";
                var playerDetails = await apiService.GetAsync<ProfilesDTO.ProfilePlayer>(playerUrl);

                if (playerDetails != null && playerDetails.Any())
                {
                    var player = playerDetails.First();
                    newAvailablePlayers.Add(new ProfilesDTO.ProfilePlayerEvent
                        {
                            ID = playerId,
                            FirstName = player.FirstName,
                            LastName = player.LastName
                        });
                }
                else
                {
                    // Add with just ID if not found
                    newAvailablePlayers.Add(new ProfilesDTO.ProfilePlayerEvent
                        {
                            ID = playerId,
                            FirstName = "",
                            LastName = ""
                        });
                }
            }
            catch (Exception ex)
            {
                newAvailablePlayers.Add(new ProfilesDTO.ProfilePlayerEvent
                    {
                        ID = playerId,
                        FirstName = "",
                        LastName = ""
                    });
            }
        }

        await InvokeAsync(() =>
        {
            team.AvailablePlayers = newAvailablePlayers;
            StateHasChanged();
        });
    }

    private async Task LoadPreviousEventForProgression()
    {
        if (string.IsNullOrEmpty(PreviousEventID)) return;

        try
        {
            // Load the previous event details
            string url = $"/Events?id={PreviousEventID}";
            var events = await apiService.GetAsync<EventsDTO.Events>(url);

            if (events != null && events.Any())
            {
                var previousEvent = events.First();

                // Load sport subcategory details to get all related info
                if (previousEvent.SportSubcategoryID.HasValue)
                {
                    var subcatUrl = $"/Sports/Subcategories?id={previousEvent.SportSubcategoryID.Value}";
                    _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(subcatUrl);

                    if (_sportSubcategories != null && _sportSubcategories.Any())
                    {
                        var sub = _sportSubcategories.First();
                        _selectedMainCategoryValue = sub.MainCategory;
                        _selectedSportSubcategoryIDValue = sub.ID;
                        _selectedSportIDValue = sub.SportID;

                        // Load sport categories
                        await GetSportCategoriesAsync();
                        await GetSportsAsync();

                        // Load school level and gender
                        await GetGenderCategoriesAsync();
                        await GetSchoolLevelsAsync();
                        await FilterSchoolLevelAndGenderAsync();

                        var schoolLevelName = _schoolLevels?.FirstOrDefault(x => x.ID == sub.SchoolLevelID)?.Level;
                        var genderName = _sportGenderCategories?.FirstOrDefault(x => x.ID == sub.SportGenderCategoryID)?.Gender;
                        if (schoolLevelName != null && genderName != null)
                            _selectedSchoolLevelAndGenderID = $"{schoolLevelName} - {genderName}";

                        // Load main categories
                        LoadMainCategories();

                        // Load players for each team
                        await LoadPlayersForProgressionTeams();
                    }
                }

                // Get the next stage
                await GetEventStagesAsync();
                if (_eventStages != null)
                {
                    var currentStage = _eventStages.FirstOrDefault(s => s.ID == previousEvent.EventStageID);
                    if (currentStage != null)
                    {
                        // Find the next stage based on your progression order
                        int nextStageId = GetNextStageId(currentStage.ID);
                        _selectedEventStagesIDValue = nextStageId;
                    }
                }

                // Load other data
                await GetSchoolRegionsAsync();
                await GetEventVenuesAsync();
                await GetStreamServicesAsync();
                await GetUsersAsync();
                await GetBracketsAsync();

                // Set sport category to 1
                _selectedSportCategoryIDValue = 1;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading previous event: {ex.Message}", Severity.Error);
        }
    }

    // load players for progression teams
    private async Task LoadPlayersForProgressionTeams()
    {
        if (ProgressionTeams == null || !ProgressionTeams.Any())
        {
            return;
        }

        _teamSelections = new List<TeamSelection>();

        foreach (var teamDict in ProgressionTeams)
        {
            var teamSelection = new TeamSelection();

            // Handle SelectedRegionID
            if (teamDict.TryGetValue("SelectedRegionID", out var regionIdValue))
            {
                if (regionIdValue != null)
                {
                    teamSelection.SelectedRegionID = Convert.ToInt32(regionIdValue);
                }
            }

            // Handle ExistingVersusTeamID
            if (teamDict.TryGetValue("ExistingVersusTeamID", out var versusTeamIdValue))
            {
                if (versusTeamIdValue != null)
                {
                    teamSelection.ExistingVersusTeamID = Convert.ToInt32(versusTeamIdValue);
                }
            }

            // Handle Score
            if (teamDict.TryGetValue("Score", out var scoreValue))
            {
                teamSelection.Score = scoreValue?.ToString();
            }

            // Handle Rank
            if (teamDict.TryGetValue("Rank", out var rankValue))
            {
                teamSelection.Rank = rankValue?.ToString();
            }

            // Handle SelectedPlayerIDs
            teamSelection.SelectedPlayerIDs = new List<string>();
            if (teamDict.TryGetValue("SelectedPlayerIDs", out var playerIdsValue))
            {

                if (playerIdsValue is List<object> playerIdObjects)
                {
                    teamSelection.SelectedPlayerIDs = playerIdObjects
                        .Where(x => x != null)
                        .Select(x => x.ToString() ?? "")
                        .Where(x => !string.IsNullOrEmpty(x))
                        .ToList();
                    
                }
                else if (playerIdsValue is List<string> stringList)
                {
                    teamSelection.SelectedPlayerIDs = stringList;
                    
                }
            }

            // Initialize AvailablePlayers
            teamSelection.AvailablePlayers = new List<ProfilesDTO.ProfilePlayerEvent>();

            // player IDs used to fetch their names
            if (teamSelection.SelectedPlayerIDs != null && teamSelection.SelectedPlayerIDs.Any())
            {
                await FetchPlayerNames(teamSelection);
            }
            else
            {
                // Console.WriteLine($"DEBUG: No player IDs found for this team");
            }

            _teamSelections.Add(teamSelection);
        }
    }

    private async Task FetchPlayerNames(TeamSelection team)
    {
        if (team.SelectedPlayerIDs == null || !team.SelectedPlayerIDs.Any())
            return;


        foreach (var playerId in team.SelectedPlayerIDs)
        {
            try
            {
                var playerUrl = $"/Profiles/Player?ID={playerId}";
                var playerDetails = await apiService.GetAsync<ProfilesDTO.ProfilePlayer>(playerUrl);

                if (playerDetails != null && playerDetails.Any())
                {
                    var player = playerDetails.First();

                    team.AvailablePlayers.Add(new ProfilesDTO.ProfilePlayerEvent
                        {
                            ID = playerId,
                            FirstName = player.FirstName ?? "",
                            LastName = player.LastName ?? ""
                        });
                }
                else
                {
                    team.AvailablePlayers.Add(new ProfilesDTO.ProfilePlayerEvent
                        {
                            ID = playerId,
                            FirstName = "",
                            LastName = ""
                        });
                }
            }
            catch (Exception ex)
            {
                team.AvailablePlayers.Add(new ProfilesDTO.ProfilePlayerEvent
                    {
                        ID = playerId,
                        FirstName = "",
                        LastName = ""
                    });
            }
        }

    }

    private int GetNextStageId(int currentStageId)
    {
        // stages: 1=Elimination, 2=Quarter-finals, 3=Semi-finals, 4=Finals
        return currentStageId switch
        {
            1 => 2,
            2 => 3,
            3 => 4,
            4 => 4, 
            _ => currentStageId + 1
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        await CheckIfFileExists();
    }


    private async Task LoadDataAsync()
    {
        // Load all dropdown data
        await GetEventStagesAsync();
        await GetSportCategoriesAsync();
        await GetGenderCategoriesAsync();
        await GetSchoolLevelsAsync();
        await GetSchoolRegionsAsync();
        await GetEventVenuesAsync();
        await GetStreamServicesAsync();
        await GetStreamsAsync();
        await GetUsersAsync();
        await GetSportSubCategoriesSLGAsync();
        await GetSportsAsync();
        await GetSportSubCategoriesSLGAsync();
        await GetEventsOnDialogOpenAsync();
        await GetEventVersusTeamsAsync();
        await GetStreamsOnDialogOpenAsync();
        await FilterSchoolLevelAndGenderAsync();
        await GetBracketsAsync();
        LoadMainCategories();

        if (_schoolRegions?.Any() == true ||
            _eventVersusTeams?.Any() == true ||
            _eventVersusTeamPlayers?.Any() == true ||
            _profilePlayerEvents?.Any() == true)
        {
            _isLoaded = true;
        }

        _filteredBrackets = _brackets;
    }

    // ------------------------------
    // Random ID Generator
    // ------------------------------
    private string GenerateRandomString(int length)
    {
        const string chars = "abcdefghijklmnopqrstuvwxyz0123456789";
        return new string(Enumerable.Range(0, length).Select(_ => chars[random.Next(chars.Length)]).ToArray());
    }


    // API Calls
    private async Task GetEventStagesAsync()
    {
        string url = "/Events/Stages";
        _eventStages = await apiService.GetAsync<EventsDTO.EventStages>(url);
    }

    private async Task GetSportCategoriesAsync()
    {
        string url = "/Sports/Categories";
        _sportCategories = await apiService.GetAsync<SportsDTO.SportCategories>(url);
    }

    private async Task GetSportsAsync()
    {
        string url = $"/Sports?sportCategoryID={_selectedSportCategoryIDValue}";
        _sports = await apiService.GetAsync<SportsDTO.Sports>(url);
    }

    private async Task GetPlayerAsync(TeamSelection team)
    {
        if (!team.SelectedRegionID.HasValue)
        {
            team.AvailablePlayers = new();
            return;
        }

        // For Archery events
        var isArcherySport = await IsArcherySport();

        if (isArcherySport && _selectedMainCategoryValue?.Equals("1440 Round", StringComparison.OrdinalIgnoreCase) == true)
        {
            // For Archery 1440 Round, fetch players by sport ID and region
            string url = $"/Profiles/Player/Events?regionID={team.SelectedRegionID}&sportID={_selectedSportIDValue}";
            var result = await apiService.GetAsync<ProfilesDTO.ProfilePlayerEvent>(url);
            team.AvailablePlayers = result ?? new List<ProfilesDTO.ProfilePlayerEvent>();
        }
        else if (_selectedSportSubcategoryIDValue.HasValue)
        {
            // For regular sports, use subcategory ID
            string url = $"/Profiles/Player/Events?regionID={team.SelectedRegionID}&subCategoryID={_selectedSportSubcategoryIDValue}";
            var result = await apiService.GetAsync<ProfilesDTO.ProfilePlayerEvent>(url);
            team.AvailablePlayers = result ?? new List<ProfilesDTO.ProfilePlayerEvent>();
        }
        else
        {
            team.AvailablePlayers = new();
        }
    }

    private async Task GetGenderCategoriesAsync()
    {
        string url = "/Sports/GenderCategories";
        _sportGenderCategories = await apiService.GetAsync<SportsDTO.SportGenderCategories>(url);
    }

    private async Task GetSchoolLevelsAsync()
    {
        string url = "/Schools/Levels";
        _schoolLevels = await apiService.GetAsync<SchoolsDTO.SchoolLevels>(url);

        await GetSportSubCategoriesAsync();
    }

    private async Task GetSportSubCategoriesAsync()
    {
        string url = $"/Sports/Subcategories?sportID={_selectedSportIDValue}&schoolLevelID={_selectedSchoolLevelIDValue}&sportGenderCategoryID={_selectedSportGenderCategoryIDValue}";
        _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(url);
    }

    //
    private async Task GetSportSubCategoriesSLGAsync()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
            return;
        }

        // Extract the school level ID and gender ID from the selected combined value (e.g. "High School - Male")
        var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
        var schoolLevelName = parts[0];
        var genderName = parts[1];

        // Get the corresponding IDs based on the names (you can adjust this if you want to match by IDs directly)
        var schoolLevelID = _schoolLevels.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
        var genderID = _sportGenderCategories.FirstOrDefault(x => x.Gender == genderName)?.ID;

        if (schoolLevelID != null && genderID != null)
        {
            // Fetch subcategories using the IDs
            _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(
                $"/Sports/Subcategories?sportID={_selectedSportIDValue}&schoolLevelID={schoolLevelID}&sportGenderCategoryID={genderID}");
        }
        else
        {
            // Handle cases where matching ID is not found
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        }
    }

    private async Task GetSchoolRegionsAsync()
    {
        string url = "/Schools/Regions";
        _schoolRegions = await apiService.GetAsync<SchoolsDTO.SchoolRegions>(url);
    }

    private async Task GetEventVenuesAsync()
    {
        string url = "/Events/Venues";
        _eventVenues = await apiService.GetAsync<EventsDTO.EventVenues>(url);
    }

    private async Task GetStreamServicesAsync()
    {
        string url = "/Events/StreamServices";
        _eventStreamServices = await apiService.GetAsync<EventsDTO.EventStreamServices>(url);
    }

    private async Task GetStreamsAsync()
    {
        string url = $"/Events/StreamService/Streams?eventStreamServiceID={_selectedEventStreamServiceIDValue}";
        _eventStreams = await apiService.GetAsync<EventsDTO.EventStreams>(url);
    }

    private async Task GetUsersAsync()
    {
        string url = "/Users/TallyClerkList";
        _userLists = await apiService.GetAsync<UsersDTO.UserList>(url);
    }

    private async Task GetBracketsAsync()
    {
        string url = "Sports/SportsBracketWithRegions";
        var bracketsDto = await apiService.GetAsync<SportsDTO.SportsBracket>(url);

        _brackets = bracketsDto.Select(b => new BracketDisplayRow
            {
                ID = b.ID,
                SportID = b.SportID,
                BracketName = b.BracketName,
                SportName = b.SportName,
                RegionsList = b.RegionsList
            }).ToList();

        FilterBracketsBySport();
    }

    private void FilterBracketsBySport()
    {
        if (_selectedSportIDValue.HasValue)
            _filteredBrackets = _brackets.Where(b => b.SportID == _selectedSportIDValue).ToList();
        else
            _filteredBrackets = new();
    }

    private async Task OnBracketChanged(int? bracketId)
    {
        _selectedBracketID = bracketId;
        _selectedRegionIDValue = null;

        if (bracketId.HasValue)
        {
            var selected = _brackets.FirstOrDefault(b => b.ID == bracketId);
            _regionsForSelectedBracket = selected?.RegionsList ?? new();
            _schoolRegions = _regionsForSelectedBracket?
                .Select(r => new SchoolsDTO.SchoolRegions
                    {
                        ID = r.RegionID,
                        Region = r.RegionName,
                        Abbreviation = r.RegionAbbreviation
                    }).ToList();
        }
        else
        {
            await GetSchoolRegionsAsync();
        }
    }

    private List<SportsDTO.SportSubcategories> GetFilteredSubcategories()
    {
        if (_sportSubcategories == null)
            return new List<SportsDTO.SportSubcategories>();

        // If a main category is selected → show only subcategories that match
        if (!string.IsNullOrEmpty(_selectedMainCategoryValue))
            return _sportSubcategories
                .Where(sc => sc.MainCategory == _selectedMainCategoryValue)
                .ToList();

        // If no main category selected → show only subcategories that have NO main category
        return _sportSubcategories
            .Where(sc => string.IsNullOrEmpty(sc.MainCategory))
            .ToList();
    }

    // ------------------------------
    // Event CRUD 
    // ------------------------------
    private async Task<bool> IsArcherySport()
    {
        if (_selectedSportIDValue == null) return false;

        var sport = _sports?.FirstOrDefault(s => s.ID == _selectedSportIDValue);
        if (sport != null)
        {
            return sport.Sport?.Equals("Archery", StringComparison.OrdinalIgnoreCase) == true;
        }

        var sportsUrl = $"/Sports?id={_selectedSportIDValue}";
        var sports = await apiService.GetAsync<SportsDTO.Sports>(sportsUrl);
        return sports?.Any(s => s.Sport?.Equals("Archery", StringComparison.OrdinalIgnoreCase) == true) == true;
    }

    private async Task Create1440RoundEvents()
    {
        var subcatUrl = $"/Events/Subcategories?mainCategory=1440 Round&sportID={_selectedSportIDValue}";

        if (_selectedSchoolLevelAndGenderID != null)
        {
            var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
            var schoolLevelName = parts[0];
            var genderName = parts[1];
            var schoolLevelID = _schoolLevels?.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
            var genderID = _sportGenderCategories?.FirstOrDefault(x => x.Gender == genderName)?.ID;

            if (schoolLevelID != null && genderID != null)
            {
                subcatUrl += $"&schoolLevelID={schoolLevelID}&sportGenderCategoryID={genderID}";
            }
        }

        var all1440Subcats = await apiService.GetAsync<SportsDTO.SportSubcategories>(subcatUrl);

        if (all1440Subcats == null || !all1440Subcats.Any())
        {
            throw new Exception("No 1440 Round subcategories found");
        }

        var overallSubcat = all1440Subcats.FirstOrDefault(sc =>
            sc.Subcategory?.Equals("1440 Round", StringComparison.OrdinalIgnoreCase) == true);

        var distanceSubcats = all1440Subcats.Where(sc =>
            sc.Subcategory?.Contains("Meter Distance") == true ||
            sc.Subcategory?.Contains("-Meter") == true)
            .OrderBy(sc =>
            {
                var match = System.Text.RegularExpressions.Regex.Match(sc.Subcategory ?? "", @"(\d+)");
                return match.Success ? int.Parse(match.Value) : 999;
            })
            .ToList();

        var eventsToCreate = new List<SportsDTO.SportSubcategories>();

        if (overallSubcat != null)
            eventsToCreate.Add(overallSubcat);

        if (distanceSubcats.Any())
            eventsToCreate.AddRange(distanceSubcats.Take(4));

        int createdCount = 0;
        foreach (var subcat in eventsToCreate)
        {
            await CreateEventWithSubcategory(subcat.ID, subcat.Subcategory);
            createdCount++;
        }

        Snackbar.Add($"Successfully created {createdCount} events for 1440 Round Archery.", Severity.Success);
    }

    private async Task CreateEventWithSubcategory(int? sportSubcategoryID, string? subcategoryName)
    {
        var addEvent = new EventsDTO.Events
            {
                ID = GenerateRandomString(20),
                EventStageID = _selectedEventStagesIDValue,
                SportSubcategoryID = sportSubcategoryID,
                EventVenuesID = _selectedEventVenueIDValue,
                EventStreamServiceID = _selectedEventStreamServiceIDValue,
                EventStreamID = _selectedEventStreamIDValue,
                OnStream = _isOnStream,
                Date = _selectedDateValue,
                Time = _selectedTimeValue,
                GamePhase = null,
                IsFinished = false,
                Archived = false,
                Deleted = false,
                UserID = _selectedUserIDValue,
                SportMainCat = _selectedMainCategoryValue
            };

        string eventUrl = "/Events";
        var eventCreated = await apiService.PostAndReadAsync<EventsDTO.Events>(eventUrl, addEvent);

        if (eventCreated == null)
        {
            throw new Exception($"Failed to create event for {subcategoryName}");
        }

        foreach (var team in _teamSelections)
        {
            if (!team.SelectedRegionID.HasValue)
                continue;

            var addEventVersusTeams = new EventsDTO.EventVersusTeams
                {
                    EventID = eventCreated.ID,
                    SchoolRegionID = team.SelectedRegionID,
                    RecentUpdateAt = _recentUpdateAt
                };

            string teamUrl = "/Events/VersusTeams";
            var createdEventVersusTeams = await apiService.PostAndReadAsync<EventsDTO.EventVersusTeams>(teamUrl, addEventVersusTeams);

            if (createdEventVersusTeams == null)
            {
                continue;
            }

            if (team.SelectedPlayerIDs?.Any() == true)
            {
                var addEventTeamPlayers = team.SelectedPlayerIDs
                    .Select(playerID => new EventsDTO.EventVersusTeamPlayers
                        {
                            EventVersusID = createdEventVersusTeams.ID,
                            ProfilePlayerID = playerID
                        })
                    .ToList();

                string playersUrl = "/Events/VersusTeams/Players";
                await apiService.PostAsync(playersUrl, addEventTeamPlayers);
            }
        }
    }

    private async Task AddEventAsync()
    {
        try
        {
            var isArchery = await IsArcherySport();
            var is1440Round = _selectedMainCategoryValue?.Equals("1440 Round", StringComparison.OrdinalIgnoreCase) == true;

            if (isArchery && is1440Round)
            {
                await Create1440RoundEvents();
            }
            else
            {
                await CreateSingleEvent();
            }

            Snackbar.Add("Event(s) added successfully.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to add event(s): {ex.Message}", Severity.Error);
        }
    }

    private string? GetSelectedStageName()
    {
        if (_selectedEventStagesIDValue.HasValue && _eventStages != null)
        {
            var stage = _eventStages.FirstOrDefault(s => s.ID == _selectedEventStagesIDValue.Value);
            return stage?.Stage;
        }
        return null;
    }

    private async Task CreateSingleEvent()
    {
        var addEvent = new EventsDTO.Events
            {
                ID = GenerateRandomString(20),
                EventStageID = _selectedEventStagesIDValue,
                SportSubcategoryID = _selectedSportSubcategoryIDValue,
                EventVenuesID = _selectedEventVenueIDValue,
                EventStreamServiceID = _selectedEventStreamServiceIDValue,
                EventStreamID = _selectedEventStreamIDValue,
                OnStream = _isOnStream,
                Date = _selectedDateValue,
                Time = _selectedTimeValue,
                GamePhase = null,
                IsFinished = false,
                Archived = false,
                Deleted = false,
                UserID = _selectedUserIDValue,
                SportMainCat = _selectedMainCategoryValue
            };

        string eventUrl = "/Events";
        var eventCreated = await apiService.PostAndReadAsync<EventsDTO.Events>(eventUrl, addEvent);

        if (eventCreated == null)
        {
            throw new Exception("Failed to create event.");
        }

        // Create versus teams
        foreach (var team in _teamSelections)
        {
            if (!team.SelectedRegionID.HasValue)
                continue;

            var addEventVersusTeams = new EventsDTO.EventVersusTeams
                {
                    EventID = eventCreated.ID,
                    SchoolRegionID = team.SelectedRegionID,
                    RecentUpdateAt = _recentUpdateAt
                };

            string teamUrl = "/Events/VersusTeams";
            var createdEventVersusTeams = await apiService.PostAndReadAsync<EventsDTO.EventVersusTeams>(teamUrl, addEventVersusTeams);

            if (createdEventVersusTeams == null)
            {
                continue;
            }

            // Save players
            if (team.SelectedPlayerIDs?.Any() == true)
            {
                var addEventTeamPlayers = team.SelectedPlayerIDs
                    .Select(playerID => new EventsDTO.EventVersusTeamPlayers
                        {
                            EventVersusID = createdEventVersusTeams.ID,
                            ProfilePlayerID = playerID
                        })
                    .ToList();

                string playersUrl = "/Events/VersusTeams/Players";
                await apiService.PostAsync(playersUrl, addEventTeamPlayers);
            }
        }
    }

    //==============================================================

    private async Task UpdateEventAsync()
    {
        if (SelectedEventID == null)
        {
            Snackbar.Add("No event selected for update.", Severity.Warning);
            return;
        }

        // Update main event
        var updateEvent = new EventsDTO.Events
            {
                ID = SelectedEventID,
                EventStageID = _selectedEventStagesIDValue,
                SportSubcategoryID = _selectedSportSubcategoryIDValue,
                EventVenuesID = _selectedEventVenueIDValue,
                EventStreamServiceID = _selectedEventStreamServiceIDValue,
                EventStreamID = _selectedEventStreamIDValue,
                OnStream = _isOnStream,
                Date = _selectedDateValue,
                Time = _selectedTimeValue,
                GamePhase = _GamePhaseValue,
                IsFinished = _selectedIsEventFinishedValue,
                Archived = false,
                Deleted = false,
                UserID = _selectedUserIDValue,
                SportMainCat = _selectedMainCategoryValue,
                BracketID = _selectedBracketID
            };

        var eventSuccess = await apiService.PutAsync($"/Events/{SelectedEventID}", updateEvent);
        if (!eventSuccess)
        {
            Snackbar.Add("Failed to update event.", Severity.Error);
            return;
        }

        // Update VersusTeams and Players
        foreach (var team in _teamSelections)
        {
            if (!team.SelectedRegionID.HasValue)
                continue;

            var versusTeam = new EventsDTO.EventVersusTeams
                {
                    ID = team.ExistingVersusTeamID,
                    EventID = SelectedEventID,
                    SchoolRegionID = team.SelectedRegionID,
                    RecentUpdateAt = DateTime.Now,
                    Score = team.Score,
                    Rank = team.Rank
                };

            if (team.ExistingVersusTeamID > 0)
            {
                // Update existing team
                await apiService.PutAsync($"/Events/VersusTeams/{team.ExistingVersusTeamID}", versusTeam);

                // Replace players
                await apiService.DeleteAsync($"/Events/VersusTeams/Players/ByEventVersusTeam/{team.ExistingVersusTeamID}");
            }
            else
            {
                // Create new team if doesn't exist
                var createdTeam = await apiService.PostAndReadAsync<EventsDTO.EventVersusTeams>("/Events/VersusTeams", versusTeam);
                team.ExistingVersusTeamID = createdTeam?.ID ?? 0;
            }

            // Add players for this team
            if (team.SelectedPlayerIDs?.Any() == true)
            {
                var playerList = team.SelectedPlayerIDs.Select(pid => new EventsDTO.EventVersusTeamPlayers
                    {
                        EventVersusID = team.ExistingVersusTeamID,
                        ProfilePlayerID = pid
                    }).ToList();

                await apiService.PostAsync("/Events/VersusTeams/Players", playerList);
            }
        }

        await UploadEventAttachmentAsync();
        Snackbar.Add("Event updated successfully.", Severity.Success);
        MudDialog?.Close(DialogResult.Ok(true));
    }


    private async Task ConfirmUpdateEventAsync()
    {
        bool? result = await DialogService.ShowMessageBox(
            title: "Notice",
            message: "Do you confirm changes the event?",
            yesText: "Yes",
            cancelText: "Cancel");

        if (result == true)
        {
            // update the event
            await UpdateEventAsync();

            // close the dialog if successful
            MudDialog?.Close(DialogResult.Ok(true));
        }
    }

    private async Task ConfirmDeleteEventAsync()
    {
        bool? result = await DialogService.ShowMessageBox(
            title: "Notice",
            message: "Do you confirm deletion this event?",
            yesText: "Yes",
            cancelText: "Cancel");

        if (result == true)
        {
            await DeleteEventAsync();

            MudDialog?.Close(DialogResult.Ok(true));
        }
    }

    private async Task DeleteEventAsync()
    {
        if (SelectedEventID == null) return;

        //get all versus teams for this event
        string versusTeamsUrl = $"/Events/VersusTeams?eventID={SelectedEventID}";
        var versusTeams = await apiService.GetAsync<EventsDTO.EventVersusTeams>(versusTeamsUrl);

        if (versusTeams != null && versusTeams.Any())
        {
            _versusTeamsIDs = versusTeams.Select(vt => vt.ID).ToArray();

            //  Delete versus team players first (due to foreign key constraints)
            await DeleteVersusTeamPlayersByVersusTeamIDAsync();

            // Then delete versus teams
            await DeleteVersusTeamsAsync();
        }

        // Finally delete the main event
        string url = $"/Events/{SelectedEventID}";
        var success = await apiService.DeleteAsync(url);

        if (success)
        {
            Snackbar.Add("Event deleted successfully.", Severity.Success);
        }
        else
        {
            Snackbar.Add("Failed to delete event.", Severity.Error);
        }
    }

    // Delete Sport event versus team players by event versus team ID
    private async Task DeleteVersusTeamPlayersByVersusTeamIDAsync()
    {
        if (_versusTeamsIDs == null || _versusTeamsIDs.Length == 0) return;

        foreach (var versusTeamID in _versusTeamsIDs)
        {
            string url = $"/Events/VersusTeams/Players/ByEventVersusTeam/{versusTeamID}";

            await apiService.DeleteAsync(url);
        }
    }

    // Delete versus teams
    private async Task DeleteVersusTeamsAsync()
    {
        if (_versusTeamsIDs == null || _versusTeamsIDs.Length == 0) return;

        foreach (var versusTeamID in _versusTeamsIDs)
        {
            string url = $"/Events/VersusTeams/{versusTeamID}";

            await apiService.DeleteAsync(url);
        }
    }

    private async Task PostEventVersusTeamPlayersAsync()
    {
        var eventStream = _selectedPlayerIDValues?.Where(id => id?.Any() == true)
            .Select(playerID => new EventsDTO.EventVersusTeamPlayers
                {
                    ProfilePlayerID = playerID,
                    EventVersusID = SelectedEventVersusTeamsID,
                }).ToList();

        if (eventStream == null || !eventStream.Any()) return;

        string url = $"/Events/VersusTeams/Players";
        var success = await apiService.PostAsync(url, eventStream);
    }

    // ------------------------------
    // Event Attachments
    // ------------------------------
    private async Task CheckIfFileExists()
    {
        if (string.IsNullOrEmpty(SelectedEventID))
        {
            _eventAttachmentUploadState = "No file selected";
            _fileExists = false;
            return;
        }

        using var httpClient = new HttpClient();

        foreach (var ext in _extensions)
        {
            var url = $"https://palarongpambansa2026.com/attachments/media/events/official%20event%20records/{SelectedEventID}{ext}";

            try
            {
                var response = await httpClient.SendAsync(new HttpRequestMessage(HttpMethod.Head, url));

                if (response.IsSuccessStatusCode)
                {
                    _fileExists = true;
                    _eventAttachmentUrl = url;
                    _eventAttachmentUploadState = "View Attachment";
                    return; 
                }
            }
            catch
            {
                // Ignore errors and try next extension
            }
        }

        // No file found for any extension
        _fileExists = false;
        _eventAttachmentUploadState = "No file selected";
    }

    private async Task HandleRegionLogoFileUpload(IBrowserFile file)
    {
        try
        {
            // Define the maximum file size (in bytes)
            const int maxFileSize = 10 * 1024 * 1024; // 10 MB

            // Check if the file size exceeds the maximum allowed
            if (file.Size > maxFileSize)
            {
                Snackbar.Add("File size exceeds the maximum allowed size of 10 MB.", Severity.Error);
                return;
            }

            // Validate file type (image only)
            var allowedExtensions = new[] { ".jpeg", ".jpg", ".png", ".pdf", ".doc", ".docx" };
            var fileExtension = Path.GetExtension(file.Name).ToLower();
            if (!allowedExtensions.Contains(fileExtension))
            {
                Snackbar.Add("Invalid file type. Only .webp is allowed.", Severity.Error);
                return;
            }

            // Open the file stream with the maxFileSize limit
            using var stream = file.OpenReadStream(maxFileSize);

            // Create a memory stream to store the file in memory
            using var memoryStream = new MemoryStream();

            // Copy the file data into the memory stream
            await stream.CopyToAsync(memoryStream);

            // Convert the memory stream to a base64 string for temporary storage
            var base64File = Convert.ToBase64String(memoryStream.ToArray());

            // Set the temporary variable to the base64 string of the file
            _updateEventAttachmentValue = $"data:{file.ContentType};base64,{base64File}";

            // Optionally display a success message
            var fileName = Path.GetFileName(file.Name);
            _eventAttachmentUploadState = $"Selected: {fileName}";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"File upload failed: {ex.Message}");
            Snackbar.Add($"File upload failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task UploadEventAttachmentAsync()
    {
        try
        {
            var base64Data = _updateEventAttachmentValue!.Split(',')[1];
            var fileBytes = Convert.FromBase64String(base64Data);
            var fileContent = new ByteArrayContent(fileBytes);

            string fileType, fileExtension;

            if (_updateEventAttachmentValue.Contains("image/webp"))
            {
                fileType = "image/webp";
                fileExtension = ".webp";
            }
            else if (_updateEventAttachmentValue.Contains("image/jpeg"))
            {
                fileType = "image/jpeg";
                fileExtension = ".jpg";
            }
            else if (_updateEventAttachmentValue.Contains("image/png"))
            {
                fileType = "image/png";
                fileExtension = ".png";
            }
            else if (_updateEventAttachmentValue.Contains("application/pdf"))
            {
                fileType = "application/pdf";
                fileExtension = ".pdf";
            }
            else if (_updateEventAttachmentValue.Contains("application/msword"))
            {
                fileType = "application/msword";
                fileExtension = ".doc";
            }
            else if (_updateEventAttachmentValue.Contains("application/vnd.openxmlformats-officedocument.wordprocessingml.document"))
            {
                fileType = "application/vnd.openxmlformats-officedocument.wordprocessingml.document";
                fileExtension = ".docx";
            }
            else
            {
                Snackbar.Add("Unsupported file format.", Severity.Error);
                return;
            }

            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(fileType);
            using var formData = new MultipartFormDataContent();
            formData.Add(fileContent, "attachmentFile", $"attachment{fileExtension}");

            var uploadUrl = $"/Events/UploadAttachment/{SelectedEventID}";
            var uploadSuccess = await apiService.PutFormAsync(uploadUrl, formData);

            if (!uploadSuccess)
                Snackbar.Add("Event updated, but attachment upload failed.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Attachment upload failed: {ex.Message}", Severity.Warning);
        }
    }

    // ------------------------------
    // Event Load on Edit
    // ------------------------------
    private async Task GetEventsOnDialogOpenAsync()
    {
        if (SelectedEventID == null) return;

        string url = $"/Events?id={SelectedEventID}";
        var events = await apiService.GetAsync<EventsDTO.Events>(url);

        if (events != null && events.Any())
        {
            var eventDetail = events.First();

            // --- Assign base event fields ---
            SelectedEventID = eventDetail.ID;
            _selectedEventStagesIDValue = eventDetail.EventStageID;
            _selectedIsEventFinishedValue = eventDetail.IsFinished;
            _selectedSportSubcategoryIDValue = eventDetail.SportSubcategoryID;
            _selectedDateValue = eventDetail.Date;
            _selectedTimeValue = eventDetail.Time;
            _selectedEventVenueIDValue = eventDetail.EventVenuesID;
            _isOnStream = eventDetail.OnStream;
            _selectedEventStreamIDValue = eventDetail.EventStreamID;
            _selectedEventStreamServiceIDValue = eventDetail.EventStreamServiceID;
            _GamePhaseValue = eventDetail.GamePhase;
            _isFinished = eventDetail.IsFinished;
            _isArchived = eventDetail.Archived;
            _isDeleted = eventDetail.Deleted;
            _selectedUserIDValue = eventDetail.UserID;

            // --- Fetch sport subcategory details ---
            if (_selectedSportSubcategoryIDValue.HasValue)
            {
                var subcatUrl = $"/Sports/Subcategories?id={_selectedSportSubcategoryIDValue.Value}";
                _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(subcatUrl);

                if (_sportSubcategories != null && _sportSubcategories.Any())
                {
                    var sub = _sportSubcategories.First();
                    _sportMainCat = new List<string> { sub.MainCategory ?? string.Empty };
                    _selectedMainCategoryValue = sub.MainCategory;

                    if (sub.SportID.HasValue)
                    {
                        _selectedSportIDValue = sub.SportID.Value;
                        var sportUrl = $"/Sports?sportCategoryID={_selectedSportCategoryIDValue}";
                        _sports = await apiService.GetAsync<SportsDTO.Sports>(sportUrl);

                        if (_sports != null && _sports.Any())
                        {
                            var sport = _sports.First();
                            if (sport.SportCategoryID.HasValue)
                            {
                                _selectedSportCategoryIDValue = sport.SportCategoryID.Value;
                                await GetSportCategoriesAsync();
                            }
                        }
                    }

                    await GetGenderCategoriesAsync();
                    await GetSchoolLevelsAsync();
                    await FilterSchoolLevelAndGenderAsync();

                    var schoolLevelName = _schoolLevels.FirstOrDefault(x => x.ID == sub.SchoolLevelID)?.Level;
                    var genderName = _sportGenderCategories.FirstOrDefault(x => x.ID == sub.SportGenderCategoryID)?.Gender;
                    if (schoolLevelName != null && genderName != null)
                        _selectedSchoolLevelAndGenderID = $"{schoolLevelName} - {genderName}";
                }
            }
        }
    }


    // ------------------------------
    // Opposing Team
    // ------------------------------
    private async Task GetEventVersusTeamsAsync()
    {
        if (SelectedEventID == null) return;

        string url = $"/Events/VersusTeams?eventID={SelectedEventID}";
        _eventVersusTeams = await apiService.GetAsync<EventsDTO.EventVersusTeams>(url);

        if (_eventVersusTeams == null || !_eventVersusTeams.Any()) return;

        _teamSelections = new List<TeamSelection>();

        foreach (var team in _eventVersusTeams)
        {
            var teamSelection = new TeamSelection
                {
                    ExistingVersusTeamID = team.ID,
                    SelectedRegionID = team.SchoolRegionID,
                    SelectedPlayerIDs = new List<string>(),
                    Score = team.Score,
                    Rank = team.Rank
                };

            // Fetch players for this team
            string playerUrl = $"/Events/VersusTeams/Players?eventVersusID={team.ID}";
            var teamPlayers = await apiService.GetAsync<EventsDTO.EventVersusTeamPlayers>(playerUrl);

            if (teamPlayers != null && teamPlayers.Any())
            {
                teamSelection.SelectedPlayerIDs = teamPlayers
                    .Where(p => !string.IsNullOrEmpty(p.ProfilePlayerID))
                    .Select(p => p.ProfilePlayerID!)
                    .ToList();
            }

            await GetPlayerAsync(teamSelection);

            _teamSelections.Add(teamSelection);
        }
    }

    private async Task GetEventVersusTeamPlayersAsync()
    {
        if (_selectedEventVersusTeamsIDValue == null) return;

        string url = $"/Events/VersusTeams/Players?eventVersusID={_selectedEventVersusTeamsIDValue}";
        _eventVersusTeamPlayers = await apiService.GetAsync<EventsDTO.EventVersusTeamPlayers>(url);

        if (_eventVersusTeamPlayers != null && _eventVersusTeamPlayers.Any())
        {
            _selectedPlayerIDValues = _eventVersusTeamPlayers.Select(p => p.ProfilePlayerID).ToList();
        }
    }

    private async Task GetStreamsOnDialogOpenAsync()
    {
        if (_selectedEventStreamIDValue != null)
        {
            string url = $"/Events/StreamService/Streams?ID={_selectedEventStreamIDValue}";
            var eventStreams = await apiService.GetAsync<EventsDTO.EventStreams>(url);

            if (eventStreams != null && eventStreams.Any())
            {
                var eventStream = eventStreams.First();

                _selectedEventStreamServiceIDValue = eventStream.EventStreamServiceID;

                // Ensure the checkbox reflects that there is a stream
                _isOnStream = true;
            }
        }
    }


    // ------------------------------
    // Main Categories & School Level/Gender
    // ------------------------------
    private void LoadMainCategories()
    {
        _sportMainCat = _sportSubcategories?.Where(sc => !string.IsNullOrEmpty(sc.MainCategory))
            .Select(sc => sc.MainCategory!).Distinct().ToList() ?? new List<string>();
    }

    private async Task FilterSchoolLevelAndGenderAsync()
    {
        if (_selectedSportIDValue == null)
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var subcats = await apiService.GetAsync<SportsDTO.SportSubcategories>(
            $"/Sports/Subcategories?sportID={_selectedSportIDValue}");

        if (subcats == null || !subcats.Any())
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var schoolLevelIDs = subcats.Where(x => x.SchoolLevelID.HasValue).Select(x => x.SchoolLevelID.Value).Distinct();
        var genderIDs = subcats.Where(x => x.SportGenderCategoryID.HasValue).Select(x => x.SportGenderCategoryID.Value).Distinct();

        var schoolLevelNames = _schoolLevels?.Where(s => schoolLevelIDs.Contains(s.ID)).Select(s => s.Level) ?? new List<string>();
        var genderNames = _sportGenderCategories?.Where(g => genderIDs.Contains(g.ID)).Select(g => g.Gender) ?? new List<string>();

        _combinedSchoolLevelAndGenderNames = schoolLevelNames.SelectMany(s => genderNames, (s, g) => $"{s} - {g}").ToList();
    }

    // ------------------------------
    // Dialog Controls
    // ------------------------------
    private async Task ConfirmAddEventAsync()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, CloseOnEscapeKey = true };
        bool? result = await DialogService.ShowMessageBox(
            title: "Notice",
            message: "Do you confirm addition of Event?",
            yesText: "Yes",
            noText: "Cancel",
            options: options
        );

        if (result == true)
        {
            await AddEventAsync();
            MudDialog?.Close(DialogResult.Ok(true));
        }
    }

    private void AddOpponent()
    {
        _teamSelections.Add(new TeamSelection());
    }

    private void RemoveOpposingTeam(int index)
    {
        if (index >= 0 && index < _teamSelections.Count)
            _teamSelections.RemoveAt(index);
    }


    private void ClearFields()
    {
        _selectedEventStagesIDValue = null;
        _selectedSportCategoryIDValue = null;
        _selectedSportIDValue = null;
        _selectedSportGenderCategoryIDValue = null;
        _selectedSchoolLevelIDValue = null;

        // Clear school level & gender fields
        _selectedSchoolLevelAndGenderID = null;
        _selectedSportSubcategoryIDValue = null;
        _selectedMainCategoryValue = null;
        _combinedSchoolLevelAndGenderNames = new List<string>();

        _selectedEventVenueIDValue = null;
        _selectedEventStreamServiceIDValue = null;
        _selectedEventStreamIDValue = null;
        _selectedDateValue = null;
        _selectedTimeValue = null;
        _selectedUserIDValue = null;
        _selectedEventVersusTeamsIDValue = null;
        _selectedPlayerIDValues = null;

        // Clear opposing team section
        foreach (var team in _teamSelections)
        {
            team.SelectedRegionID = null;
            team.SelectedPlayerIDs = new List<string>();
            team.AvailablePlayers = new List<ProfilesDTO.ProfilePlayerEvent>();
        }

        _isOnStream = false;
    }


    private void Cancel() => MudDialog?.Cancel();

    public class EventsDTO
    {
        public class Events
        {
            public string ID { get; set; } = null!;
            public int? EventStageID { get; set; }
            public string? SportMainCat { get; set; }
            public int? SportSubcategoryID { get; set; }
            public int? EventVenuesID { get; set; }
            public DateTime? Date { get; set; }
            public TimeSpan? Time { get; set; }
            public bool? OnStream { get; set; }
            public int? EventStreamID { get; set; }
            public int? EventStreamServiceID { get; set; }
            public string? GamePhase { get; set; }
            public bool? IsFinished { get; set; }
            public bool? Archived { get; set; }
            public bool? Deleted { get; set; }
            public string? UserID { get; set; }
            public int? BracketID { get; set; }
            public List<EventVersusTeams> EventVersusTeams { get; set; } = new();
        }

        public class EventStages
        {
            public int ID { get; set; }
            public string? Stage { get; set; }
        }

        public class EventStreamServices
        {
            public int ID { get; set; }
            public string? StreamService { get; set; }
        }

        public class EventStreams
        {
            public int ID { get; set; }
            public int? EventStreamServiceID { get; set; }
            public string? StreamTitle { get; set; }
            public string? StreamURL { get; set; }
            public DateTime? StreamDate { get; set; }
        }

        public class EventVenues
        {
            public int ID { get; set; }
            public string? Address { get; set; }
            public string? Venue { get; set; }
            public decimal? Latitude { get; set; }
            public decimal? Longitude { get; set; }
        }

        public class EventVersusTeams
        {
            public int ID { get; set; }
            public string? EventID { get; set; }
            public int? SchoolRegionID { get; set; }
            public DateTime? RecentUpdateAt { get; set; }
            public string? Score { get; set; }
            public string? Rank { get; set; }
            public List<EventVersusTeamPlayers> EventVersusTeamPlayers { get; set; } = new();
        }

        public class EventVersusTeamPlayers
        {
            public int ID { get; set; }
            public int? EventVersusID { get; set; }
            public string? ProfilePlayerID { get; set; }
        }
    }

    public class ProfilesDTO
    {
        public class ProfilePlayer
        {
            public string? ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }

        public class ProfilePlayerEvent
        {
            public string? ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }
    }


    public class SportsDTO
    {
        public class SportCategories
        {
            public int ID { get; set; }
            public string? Category { get; set; }
        }

        public class Sports
        {
            public int ID { get; set; }
            public string? Sport { get; set; }
            public string? Description { get; set; }
            public int? SportCategoryID { get; set; }
        }

        public class SportSubcategories
        {
            public int ID { get; set; }
            public string? Subcategory { get; set; }
            public int? SportID { get; set; }
            public int? SportGenderCategoryID { get; set; }
            public int? SchoolLevelID { get; set; }
            public string? MainCategory { get; set; }
        }

        public class SportGenderCategories
        {
            public int ID { get; set; }
            public string? Gender { get; set; }
        }

        public class SportsBracket
        {
            public int ID { get; set; }
            public int SportID { get; set; }
            public string? BracketName { get; set; }
            public string? SportName { get; set; }
            public List<SportsBracketRegions>? RegionsList { get; set; }
        }

        public class SportsBracketRegions
        {
            public int ID { get; set; }
            public int BracketID { get; set; }
            public int RegionID { get; set; }
            public string? RegionName { get; set; }
            public string? RegionAbbreviation { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class Schools
        {
            public int ID { get; set; }
            public string? School { get; set; }
            public int? SchoolDivisionID { get; set; }
            public int? SchoolLevelsID { get; set; }
        }

        public class SchoolRegions
        {
            public int ID { get; set; }
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
        }

        public class SchoolDivisions
        {
            public int ID { get; set; }
            public string? Division { get; set; }
            public int? SchoolRegionID { get; set; }
        }

        public class SchoolLevels
        {
            public int ID { get; set; }
            public string? Level { get; set; }
        }
    }

    public class UsersDTO
    {
        public class UserList
        {
            public string ID { get; set; } = null!;
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
            public string? Role { get; set; }
        }
    }

    private class TeamSelection
    {
        public int ID { get; set; }
        public int? SelectedRegionID { get; set; }
        public IEnumerable<string?>? SelectedPlayerIDs { get; set; } = new List<string?>();
        public List<ProfilesDTO.ProfilePlayerEvent> AvailablePlayers { get; set; } = new();
        public int ExistingVersusTeamID { get; set; }

        public string? Score { get; set; }
        public string? Rank { get; set; }
    }

    public class BracketDisplayRow
    {
        public int ID { get; set; }
        public int SportID { get; set; }
        public string? BracketName { get; set; }
        public string? SportName { get; set; }
        public List<SportsDTO.SportsBracketRegions>? RegionsList { get; set; }
    }

    private List<string> _championshipPlacements = new()
    {
        "Gold",
        "Silver",
        "Bronze",
        "Eliminated",
    };

        private List<string> _placements = new()
    {
        "Winner",
        "Eliminated",
    };

    public class ProgressionDTO
    {
        public class ProgressionTeamSelection
        {
            public int? SelectedRegionID { get; set; }
            public List<string> SelectedPlayerIDs { get; set; } = new();
            public List<ProfilePlayerDTO> AvailablePlayers { get; set; } = new();
            public int ExistingVersusTeamID { get; set; }
            public string? Score { get; set; }
            public string? Rank { get; set; }
        }

        public class ProfilePlayerDTO
        {
            public string? ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }
    }
}
