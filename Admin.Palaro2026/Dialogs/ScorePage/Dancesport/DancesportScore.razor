@using Microsoft.AspNetCore.Components

@inject ISnackbar Snackbar
@inject APIService apiService
@inject IDialogService DialogService
@inject CookieService cookieService

@if (_isLoaded == true)
{
    <MudDialog>
        <DialogContent>
            <MudGrid Spacing="5">
                <!-- Player Info -->
                <MudItem xs="12" Class="mb-3">
                    @if (IsTeamEvent)
                    {
                        <MudText Typo="Typo.h6"> @_regionName</MudText>
                        <MudStack Row Spacing="2" Justify="Justify.FlexStart">
                            <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Color="Color.Dark"/>
                            <MudText Typo="Typo.caption">@string.Join(", ", _teamPlayerNames)</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudText Typo="Typo.h6" Class="mb-2">@_playerName</MudText>
                        <MudText Typo="Typo.caption">Region: @_regionName</MudText>
                    }
                    <MudDivider Class="my-2"/>
                </MudItem>

                <!-- Sport Details -->
                <MudItem xs="12" Class="mb-3">
                    <MudStack Spacing="1">
                        <MudGrid Spacing="1">
                            <MudItem xs="12">
                                <MudSelect @bind-Value="_selectedMainCategory" Margin="Margin.Dense"
                                           Label="Event" T="string"
                                           ShrinkLabel Variant="Variant.Outlined" Clearable
                                           ReadOnly="true">
                                    @if (!string.IsNullOrEmpty(_selectedMainCategory))
                                    {
                                        <MudSelectItem
                                            Value="@_selectedMainCategory">@_selectedMainCategory</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12">
                                <MudSelect Value="@_selectedSubcategoryId"
                                           ValueChanged="@((int? value) => OnSubcategoryChanged(value))"
                                           Margin="Margin.Dense"
                                           Label="Category" T="int?"
                                           ShrinkLabel Variant="Variant.Outlined" Clearable>
                                    <MudVirtualize Items="_sportSubcategories" Context="subCategory">
                                        <MudSelectItem T="int?"
                                                       Value="@subCategory.ID">@subCategory.Subcategory</MudSelectItem>
                                    </MudVirtualize>
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12">
                                <MudNumericField @bind-Value="_rankValue"
                                                 HideSpinButtons="true"
                                                 Label="Rank"
                                                 Variant="Variant.Outlined"
                                                 Min="1"
                                                 Max="50"
                                                 Margin="Margin.Dense"/>
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudItem>

                @if (_existingScoreId.HasValue && _selectedSubcategoryId.HasValue)
                {
                    <MudItem xs="12" Class="mb-3">
                        <MudStack Spacing="1">
                            <MudText>Medal Tally</MudText>
                            <MudDivider />
                            <MudGrid Spacing="1" Class="mt-2">
                                <MudItem xs="12">
                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                        <MudItem xs="12" sm="10">
                                            <MudSelect @bind-Value="_selectedMedal"
                                                       Label="Select Medal"
                                                       ShrinkLabel
                                                       Clearable
                                                       T="string"
                                                       Variant="Variant.Outlined"
                                                       Margin="Margin.Dense" FullWidth="true">
                                                <MudSelectItem Value="@("Gold")">Gold</MudSelectItem>
                                                <MudSelectItem Value="@("Silver")">Silver</MudSelectItem>
                                                <MudSelectItem Value="@("Bronze")">Bronze</MudSelectItem>
                                            </MudSelect>
                                        </MudItem>

                                        <MudItem xs="12" sm="2">
                                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIconButton Icon="@Icons.Material.Filled.Check" Variant="Variant.Filled"
                                                               Color="Color.Success" 
                                                               OnClick="SaveMedal"
                                                               Disabled="@(string.IsNullOrEmpty(_selectedMedal) && _existingMedal == null)" />

                                                @if (_existingMedal != null && !string.IsNullOrEmpty(_existingMedal.Rank))
                                                {
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Variant="Variant.Filled"
                                                                   Color="Color.Error"
                                                                   OnClick="DeleteMedal" />
                                                }
                                            </MudStack>
                                        </MudItem>
                                    </MudStack>
                                </MudItem>
                            </MudGrid>
                        </MudStack>
                    </MudItem>
                }
            </MudGrid>
        </DialogContent>
        <DialogActions>
            <MudButton Variant="Variant.Text" OnClick="ConfirmSaveRank">Save</MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }

    [Parameter] public int RegionID { get; set; }
    [Parameter] public string PlayerID { get; set; } = string.Empty;
    [Parameter] public int? EventID { get; set; }
    [Parameter] public EventCallback OnScoreSaved { get; set; }

    [Parameter] public bool IsTeamEvent { get; set; } = false;
    [Parameter] public List<string> TeamPlayerIDs { get; set; } = new();
    [Parameter] public int? TeamID { get; set; }

    private string _playerName = "Loading...";
    private string _regionName = "Loading...";
    private int _rankValue;
    private string? _selectedMainCategory;
    private int? _selectedSubcategoryId;
    private bool _isLoaded = false;
    private int? _existingScoreId;

    private List<string> _mainCategories = new();
    private PerformanceBasedDTO.PerformanceEvent? _selectedEvent;
    private List<SportsDTO.SportSubcategories> _sportSubcategories = new();
    private List<SportsDTO.SportSubcategories> _filteredSubcategories = new();
    private int? _opposingTeamId;
    private string _currentUserId = string.Empty;

    private List<string> _teamPlayerNames = new();

    // Add these fields for filtering
    private List<SportsDTO.SportGenderCategories> _sportGenderCategories = new();
    private List<SchoolsDTO.SchoolLevels> _schoolLevels = new();
    private int? _selectedSportIDValue;

    private Dictionary<string, int> _teamPerformanceTeamIds = new();  // PlayerID -> PerformanceTeamID
    private List<int> _existingTeamScoreIds = new();                 // existing score IDs for team rows

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
        _isLoaded = true;
    }

    private async Task LoadInitialData()
    {
        try
        {
            await GetCurrentUserIdAsync();
            await LoadEventData();
            await LoadPlayerAndRegionData();
            await LoadSportData(); // This will now use the filtered approach
            await LoadOpposingTeam();
            await LoadExistingMedal();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
    }

    private async Task<string> GetCurrentUserIdAsync()
    {
        try
        {
            // Try to get user ID from cookie first
            var userId = await cookieService.GetCookie("userID");

            if (!string.IsNullOrEmpty(userId))
            {
                return userId;
            }

            // If no user ID in cookie, check for token
            var token = await cookieService.GetCookie("authenticationToken");
            if (string.IsNullOrEmpty(token))
            {
                Snackbar.Add("User not authenticated. Please log in.", Severity.Error);
                return string.Empty;
            }

            Snackbar.Add("Unable to retrieve user ID. Please log in again.", Severity.Warning);
            return string.Empty;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error getting user ID: {ex.Message}", Severity.Error);
            return string.Empty;
        }
    }

    private async Task LoadEventData()
    {
        try
        {
            if (!EventID.HasValue)
            {
                Snackbar.Add("No event ID provided", Severity.Error);
                return;
            }

            string eventUrl = $"/PerformanceBased/PerformanceEvent/{EventID.Value}";
            _selectedEvent = await apiService.GetSingleAsync<PerformanceBasedDTO.PerformanceEvent>(eventUrl);

            if (_selectedEvent == null)
            {
                var eventList = await apiService.GetAsync<PerformanceBasedDTO.PerformanceEvent>(eventUrl);
                _selectedEvent = eventList?.FirstOrDefault();
            }

            if (_selectedEvent != null)
            {
                _selectedMainCategory = _selectedEvent.MainCategory;
                _selectedSportIDValue = _selectedEvent.SportID;

                // Load the necessary data for filtering
                await GetGenderCategoriesAsync();
                await GetSchoolLevelsAsync();

                // Now filter subcategories using the event data
                await FilterSubcategoriesByEvent();
            }
            else
            {
                Snackbar.Add($"Event not found for ID: {EventID.Value}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading event data: {ex.Message}", Severity.Error);
        }
    }

    private async Task FilterSubcategoriesByEvent()
    {
        if (_selectedEvent == null) return;

        try
        {
            // Use the specific filtering method with event data
            await GetSportSubCategoriesAsync();

            if (!string.IsNullOrEmpty(_selectedMainCategory))
            {
                await FilterSubcategoriesByMainCategory();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error filtering subcategories: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadPlayerAndRegionData()
    {
        if (IsTeamEvent && TeamPlayerIDs.Any())
        {
            await LoadTeamPlayerNames();
        }
        else if (!string.IsNullOrEmpty(PlayerID) && EventID != null)
        {
            try
            {
                string playerUrl = $"/Profiles/Player?id={PlayerID}";
                var playerResult = await apiService.GetAsync<ProfilePlayersDTO.Players>(playerUrl);
                var player = playerResult?.FirstOrDefault();

                if (player != null)
                {
                    _playerName = $"{player.FirstName} {player.LastName}";
                }
                else
                {
                    _playerName = "Player not found";
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading player data: {ex.Message}", Severity.Error);
            }
        }

        try
        {
            string regionUrl = $"/Schools/Regions?id={RegionID}";
            var regionResult = await apiService.GetAsync<SchoolsDTO.SchoolRegions>(regionUrl);
            var region = regionResult?.FirstOrDefault();

            if (region != null)
            {
                _regionName = region.Abbreviation ?? region.Region;
            }
            else
            {
                _regionName = "Region not found";
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading region data: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadTeamPlayerNames()
    {
        _teamPlayerNames = new List<string>();

        foreach (var playerId in TeamPlayerIDs)
        {
            try
            {
                string playerUrl = $"/Profiles/Player?id={playerId}";
                var playerResult = await apiService.GetAsync<ProfilePlayersDTO.Players>(playerUrl);
                var player = playerResult?.FirstOrDefault();

                if (player != null)
                {
                    _teamPlayerNames.Add($"{player.FirstName} {player.LastName}");
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading team player {playerId}: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task LoadOpposingTeam()
    {
        if (EventID == null) return;

        try
        {
            string url = $"/PerformanceBased/OpposingTeams/{EventID}";
            var teams = await apiService.GetAsync<PerformanceBasedDTO.PerformanceTeam>(url)
                       ?? new List<PerformanceBasedDTO.PerformanceTeam>();

            if (IsTeamEvent)
            {
                List<PerformanceBasedDTO.PerformanceTeam> members = new();

                // ✅ 1) Prefer TeamID (ideal)
                if (TeamID.HasValue)
                {
                    members = teams
                        .Where(t => t.RegionID == RegionID
                                 && t.TeamID == TeamID
                                 && t.PerformanceID == EventID)
                        .ToList();
                }

                // ✅ 2) Fallback: use TeamPlayerIDs if TeamID is null / not found
                if (!members.Any() && TeamPlayerIDs != null && TeamPlayerIDs.Any())
                {
                    members = teams
                        .Where(t => t.PerformanceID == EventID
                                 && t.RegionID == RegionID
                                 && TeamPlayerIDs.Contains(t.PlayerID))
                        .ToList();

                    // If TeamID wasn't passed, infer it from members
                    if (!TeamID.HasValue && members.Any())
                        TeamID = members.First().TeamID;
                }

                if (!members.Any())
                {
                    Snackbar.Add("Could not find team members for this event/region.", Severity.Warning);
                    return;
                }

                _teamPerformanceTeamIds = members
                    .Where(m => !string.IsNullOrWhiteSpace(m.PlayerID))
                    .GroupBy(m => m.PlayerID)
                    .ToDictionary(g => g.Key, g => g.First().ID);

                _opposingTeamId = members.First().ID;
                return;
            }

            // ✅ Individual
            var team = teams.FirstOrDefault(t =>
                t.RegionID == RegionID &&
                t.PlayerID == PlayerID &&
                t.PerformanceID == EventID);

            if (team != null)
            {
                _opposingTeamId = team.ID;
                TeamID = team.TeamID;
            }
            else
            {
                Snackbar.Add("Could not find team information", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading team data: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadSportData()
    {
        try
        {
            // If we haven't loaded specific subcategories yet, load all as fallback
            if (!_sportSubcategories.Any())
            {
                string subcategoriesUrl = "/Sports/Subcategories";
                _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(subcategoriesUrl)
                                      ?? new List<SportsDTO.SportSubcategories>();
            }

            LoadMainCategories();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading sport data: {ex.Message}", Severity.Error);
        }
    }

    private void LoadMainCategories()
    {
        _mainCategories = _sportSubcategories
            .Where(sc => !string.IsNullOrEmpty(sc.MainCategory))
            .Select(sc => sc.MainCategory!)
            .Distinct()
            .ToList();
    }

    private async Task LoadExistingRank()
    {
        if (EventID == null || !_selectedSubcategoryId.HasValue) return;

        try
        {
            string url = $"/PerformanceScore/Score/{EventID}";
            var scores = await apiService.GetAsync<PerformanceBasedDTO.PerformanceScore>(url)
                        ?? new List<PerformanceBasedDTO.PerformanceScore>();

            _existingTeamScoreIds = new List<int>();

            // ✅ TEAM EVENT: get ALL rows for this team + subcategory
            if (IsTeamEvent && TeamID.HasValue)
            {
                var teamScores = scores
                    .Where(s => s.TeamID == TeamID
                             && s.SportSubcategoryID == _selectedSubcategoryId.Value)
                    .ToList();

                if (!teamScores.Any())
                {
                    _existingScoreId = null;
                    _rankValue = 0;
                    _existingMedal = null;
                    _selectedMedal = null;
                    StateHasChanged();
                    return;
                }

                _existingTeamScoreIds = teamScores.Select(s => s.ID).ToList();

                // ✅ Use ONE team rank (pick first OR most common)
                var teamRank = teamScores
                    .GroupBy(s => s.Rank)
                    .OrderByDescending(g => g.Count())
                    .Select(g => g.Key)
                    .First();

                _rankValue = teamRank;

                // ✅ Keep one representative score for medal
                _existingScoreId = teamScores.First().ID;
                await LoadExistingMedal();

                // ✅ OPTIONAL but recommended: auto-fix mismatch so all players store same rank
                if (teamScores.Any(s => s.Rank != teamRank))
                {
                    var currentUserId = await GetCurrentUserIdAsync();

                    foreach (var s in teamScores.Where(x => x.Rank != teamRank))
                    {
                        var patch = new PerformanceBasedDTO.PerformanceScore
                        {
                            ID = s.ID,
                            PerformanceID = s.PerformanceID,
                            PerformanceTeamID = s.PerformanceTeamID,
                            SportSubcategoryID = s.SportSubcategoryID,
                            Score = s.Score,
                            Rank = teamRank,
                            UserID = currentUserId,
                            UpdatedAt = DateTime.Now,
                            TeamID = s.TeamID
                        };

                        await apiService.PutAsync<PerformanceBasedDTO.PerformanceScore>(
                            $"/PerformanceScore/Score/{s.ID}", patch);
                    }
                }

                StateHasChanged();
                return;
            }

            // ✅ INDIVIDUAL EVENT: single row
            var existingScore = scores.FirstOrDefault(s =>
                s.PerformanceTeamID == _opposingTeamId &&
                s.SportSubcategoryID == _selectedSubcategoryId.Value &&
                !s.TeamID.HasValue);

            if (existingScore != null)
            {
                _existingScoreId = existingScore.ID;
                _rankValue = existingScore.Rank;
                await LoadExistingMedal();
            }
            else
            {
                _existingScoreId = null;
                _rankValue = 0;
                _existingMedal = null;
                _selectedMedal = null;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading existing rank: {ex.Message}", Severity.Error);
            _existingScoreId = null;
            _existingTeamScoreIds = new();
            _rankValue = 0;
            _existingMedal = null;
            _selectedMedal = null;
            StateHasChanged();
        }
    }


    private async Task OnSubcategoryChanged(int? newValue)
    {
        _selectedSubcategoryId = newValue;

        _rankValue = 0;
        _existingScoreId = null;
        _existingMedal = null;
        _selectedMedal = null;

        if (_selectedSubcategoryId.HasValue && _opposingTeamId.HasValue)
        {
            await LoadExistingRank();
        }
        else
        {
            StateHasChanged(); // Ensure UI updates even if we don't load
        }
    }

    private async Task FilterSubcategoriesByMainCategory()
    {
        if (string.IsNullOrEmpty(_selectedMainCategory))
        {
            _filteredSubcategories = new List<SportsDTO.SportSubcategories>();
            return;
        }

        _filteredSubcategories = _sportSubcategories
            .Where(sc => sc.MainCategory == _selectedMainCategory)
            .ToList();

        StateHasChanged();
    }

    private async Task GetGenderCategoriesAsync()
    {
        try
        {
            string url = "/Sports/GenderCategories";
            _sportGenderCategories = await apiService.GetAsync<SportsDTO.SportGenderCategories>(url)
                                     ?? new List<SportsDTO.SportGenderCategories>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading gender categories: {ex.Message}", Severity.Error);
        }
    }

    private async Task GetSchoolLevelsAsync()
    {
        try
        {
            string url = "/Schools/Levels";
            _schoolLevels = await apiService.GetAsync<SchoolsDTO.SchoolLevels>(url)
                            ?? new List<SchoolsDTO.SchoolLevels>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading school levels: {ex.Message}", Severity.Error);
        }
    }

    private async Task GetSportSubCategoriesAsync()
    {
        if (_selectedEvent == null) return;

        try
        {
            var parameters = new List<string>();

            if (_selectedEvent.SportID.HasValue)
                parameters.Add($"sportID={_selectedEvent.SportID}");

            if (_selectedEvent.LevelID.HasValue)
                parameters.Add($"schoolLevelID={_selectedEvent.LevelID}");

            if (_selectedEvent.GenderID.HasValue)
                parameters.Add($"sportGenderCategoryID={_selectedEvent.GenderID}");

            if (!string.IsNullOrEmpty(_selectedMainCategory))
                parameters.Add($"mainCategory={Uri.EscapeDataString(_selectedMainCategory)}");

            string url = "/Sports/Subcategories";
            if (parameters.Any())
                url += "?" + string.Join("&", parameters);

            var filteredSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(url);

            if (filteredSubcategories != null && filteredSubcategories.Any())
            {
                _sportSubcategories = filteredSubcategories;
            }
            else
            {
                string fallbackUrl = "/Sports/Subcategories";
                _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(fallbackUrl)
                                      ?? new List<SportsDTO.SportSubcategories>();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading sport subcategories: {ex.Message}", Severity.Error);
        }
    }

    private async Task ConfirmSaveRank()
    {
        if (!_selectedSubcategoryId.HasValue || _rankValue <= 0)
        {
            Snackbar.Add("Please select a category and enter a valid rank", Severity.Warning);
            return;
        }

        string action = _existingScoreId.HasValue ? "update" : "set";

        bool? result = await DialogService.ShowMessageBox(
            title: "Confirm Save Rank",
            message: $"Are you sure you want to {action} this rank?",
            yesText: "Yes",
            cancelText: "Cancel"
        );

        if (result == true)
        {
            await SaveRank();
        }
    }

    private async Task SaveRank()
    {
        try
        {
            if (!_selectedSubcategoryId.HasValue || _rankValue <= 0)
            {
                Snackbar.Add("Please select a category and enter a valid rank", Severity.Warning);
                return;
            }

            var currentUserId = await GetCurrentUserIdAsync();

            if (IsTeamEvent && TeamID.HasValue)
            {
                if (!_teamPerformanceTeamIds.Any())
                {
                    Snackbar.Add("Team members not loaded. Please reopen the dialog.", Severity.Error);
                    return;
                }

                // Load all existing scores for this event once (to upsert correctly per player)
                string getUrl = $"/PerformanceScore/Score/{EventID}";
                var allScores = await apiService.GetAsync<PerformanceBasedDTO.PerformanceScore>(getUrl)
                               ?? new List<PerformanceBasedDTO.PerformanceScore>();

                int successCount = 0;

                foreach (var kvp in _teamPerformanceTeamIds)
                {
                    string playerId = kvp.Key;
                    int perfTeamId = kvp.Value;

                    // find existing score for THIS player + subcategory + team
                    var existing = allScores.FirstOrDefault(s =>
                        s.PerformanceTeamID == perfTeamId &&
                        s.SportSubcategoryID == _selectedSubcategoryId.Value &&
                        s.TeamID == TeamID);

                    var scoreData = new PerformanceBasedDTO.PerformanceScore
                    {
                        PerformanceID = EventID.Value,
                        PerformanceTeamID = perfTeamId,
                        SportSubcategoryID = _selectedSubcategoryId.Value,
                        Score = 0,
                        Rank = _rankValue,
                        UserID = currentUserId,
                        UpdatedAt = DateTime.Now,
                        TeamID = TeamID
                    };

                    if (existing != null)
                    {
                        scoreData.ID = existing.ID;
                        string putUrl = $"/PerformanceScore/Score/{existing.ID}";
                        var ok = await apiService.PutAsync<PerformanceBasedDTO.PerformanceScore>(putUrl, scoreData);
                        if (ok) successCount++;
                    }
                    else
                    {
                        string postUrl = "/PerformanceScore/Score";
                        var created = await apiService.PostAsync<PerformanceBasedDTO.PerformanceScore>(postUrl, scoreData);
                        if (created != null) successCount++;
                    }
                }

                if (successCount > 0)
                {
                    Snackbar.Add($"Team rank saved for {successCount} player(s).", Severity.Success);

                    // refresh existing rank state (and medal representative)
                    await LoadExistingRank();

                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    Snackbar.Add("Failed to save team rank.", Severity.Error);
                }

                return;
            }

            // ✅ INDIVIDUAL EVENT: original behavior
            if (!_opposingTeamId.HasValue)
            {
                Snackbar.Add("Player team info not found.", Severity.Warning);
                return;
            }

            var individualScore = new PerformanceBasedDTO.PerformanceScore
            {
                PerformanceID = EventID.Value,
                PerformanceTeamID = _opposingTeamId.Value,
                SportSubcategoryID = _selectedSubcategoryId.Value,
                Score = 0,
                Rank = _rankValue,
                UserID = currentUserId,
                UpdatedAt = DateTime.Now,
                TeamID = null
            };

            if (_existingScoreId.HasValue)
            {
                individualScore.ID = _existingScoreId.Value;
                string putUrl = $"/PerformanceScore/Score/{_existingScoreId.Value}";
                var ok = await apiService.PutAsync<PerformanceBasedDTO.PerformanceScore>(putUrl, individualScore);

                if (ok)
                {
                    Snackbar.Add("Rank updated successfully!", Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    Snackbar.Add("Failed to update rank", Severity.Error);
                }
            }
            else
            {
                string postUrl = "/PerformanceScore/Score";
                var created = await apiService.PostAsync<PerformanceBasedDTO.PerformanceScore>(postUrl, individualScore);

                if (created != null)
                {
                    Snackbar.Add("Rank saved successfully!", Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    Snackbar.Add("Failed to save rank", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving rank: {ex.Message}", Severity.Error);
        }
    }

    //MEDAL TALLY

    private string? _selectedMedal;
    private EventsDTO.EventVersusTeams? _existingMedal;
    private Dictionary<int, EventsDTO.EventVersusTeams> _medalsByScoreId = new(); 

    private async Task LoadExistingMedal()
    {
        if (IsTeamEvent && TeamID.HasValue && EventID.HasValue)
        {
            try
            {
                // ✅ get ALL medals for this event+team (one per PerformanceScoreID)
                string url = $"/Events/VersusTeams?performanceID={EventID.Value}&teamID={TeamID.Value}";
                var medals = await apiService.GetAsync<EventsDTO.EventVersusTeams>(url) ?? new List<EventsDTO.EventVersusTeams>();

                _medalsByScoreId = medals
                    .Where(m => m.PerformanceScoreID.HasValue)
                    .GroupBy(m => m.PerformanceScoreID!.Value)
                    .ToDictionary(g => g.Key, g => g.OrderByDescending(x => x.RecentUpdateAt).First());

                // ✅ representative medal for UI (most common)
                var repRank = medals
                    .Where(m => !string.IsNullOrWhiteSpace(m.Rank))
                    .GroupBy(m => m.Rank!)
                    .OrderByDescending(g => g.Count())
                    .Select(g => g.Key)
                    .FirstOrDefault();

                _selectedMedal = repRank;
                _existingMedal = medals.FirstOrDefault(); // just for "has existing" UI checks
                StateHasChanged();
                return;
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading medal data: {ex.Message}", Severity.Error);
                _existingMedal = null;
                _selectedMedal = null;
                _medalsByScoreId.Clear();
                return;
            }
        }

        // ✅ INDIVIDUAL: old behavior
        if (!_existingScoreId.HasValue) return;

        try
        {
            string url = $"/Events/VersusTeams?performanceScoreID={_existingScoreId.Value}";
            var medals = await apiService.GetAsync<EventsDTO.EventVersusTeams>(url);
            _existingMedal = medals?.FirstOrDefault();
            _selectedMedal = _existingMedal?.Rank;

            _medalsByScoreId.Clear();
            if (_existingScoreId.HasValue && _existingMedal != null)
                _medalsByScoreId[_existingScoreId.Value] = _existingMedal;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading medal data: {ex.Message}", Severity.Error);
            _existingMedal = null;
            _selectedMedal = null;
            _medalsByScoreId.Clear();
        }
    }

    private async Task SaveMedal()
    {
        // must have rank saved first (same as your existing UI condition)
        if (!_existingScoreId.HasValue)
        {
            Snackbar.Add("No rank exists to assign medal to", Severity.Warning);
            return;
        }

        if (string.IsNullOrEmpty(_selectedMedal))
        {
            // treat empty as delete request
            await DeleteMedal();
            return;
        }

        try
        {
            // ✅ TEAM: apply medal to ALL team score rows
            if (IsTeamEvent && TeamID.HasValue)
            {
                // Ensure we have all team score ids (you fill this in LoadExistingRank)
                if (_existingTeamScoreIds == null || _existingTeamScoreIds.Count == 0)
                {
                    Snackbar.Add("Team scores not loaded yet. Please select category again.", Severity.Warning);
                    return;
                }

                int successCount = 0;

                foreach (var scoreId in _existingTeamScoreIds.Distinct())
                {
                    var payload = new EventsDTO.EventVersusTeams
                    {
                        PerformanceScoreID = scoreId,
                        PerformanceID = EventID,          // ✅ store event
                        TeamID = TeamID,                 // ✅ store team
                        SchoolRegionID = RegionID,
                        Score = null,
                        Rank = _selectedMedal,
                        RecentUpdateAt = DateTime.Now
                    };

                    // upsert by scoreId
                    if (_medalsByScoreId.TryGetValue(scoreId, out var existing) && existing != null)
                    {
                        payload.ID = existing.ID;
                        var ok = await apiService.PutAsync<EventsDTO.EventVersusTeams>(
                            $"/Events/VersusTeams/{existing.ID}", payload);

                        if (ok) successCount++;
                    }
                    else
                    {
                        var created = await apiService.PostAsync<EventsDTO.EventVersusTeams>(
                            "/Events/VersusTeams", payload);

                        if (created != null) successCount++;
                    }
                }

                if (successCount > 0)
                {
                    Snackbar.Add($"Medal saved for {successCount} player(s).", Severity.Success);
                    await LoadExistingMedal();
                }
                else
                {
                    Snackbar.Add("Failed to save medal.", Severity.Error);
                }

                return;
            }

            // ✅ INDIVIDUAL: old behavior
            var medalTally = new EventsDTO.EventVersusTeams
            {
                PerformanceScoreID = _existingScoreId.Value,
                PerformanceID = EventID,
                TeamID = null,
                SchoolRegionID = RegionID,
                Score = null,
                Rank = _selectedMedal,
                RecentUpdateAt = DateTime.Now
            };

            if (_existingMedal != null)
            {
                medalTally.ID = _existingMedal.ID;
                var ok = await apiService.PutAsync<EventsDTO.EventVersusTeams>(
                    $"/Events/VersusTeams/{_existingMedal.ID}", medalTally);

                if (ok)
                {
                    Snackbar.Add("Medal updated successfully!", Severity.Success);
                    await LoadExistingMedal();
                }
                else Snackbar.Add("Failed to update medal", Severity.Error);
            }
            else
            {
                var created = await apiService.PostAsync<EventsDTO.EventVersusTeams>(
                    "/Events/VersusTeams", medalTally);

                if (created != null)
                {
                    Snackbar.Add("Medal assigned successfully!", Severity.Success);
                    await LoadExistingMedal();
                }
                else Snackbar.Add("Failed to assign medal", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving medal: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteMedal()
    {
        bool? result = await DialogService.ShowMessageBox(
            title: "Confirm Delete Medal",
            message: "Are you sure you want to delete this medal?",
            yesText: "Yes",
            cancelText: "Cancel"
        );

        if (result != true) return;

        try
        {
            // ✅ TEAM: delete all medal rows for each PerformanceScoreID
            if (IsTeamEvent && TeamID.HasValue)
            {
                if (_medalsByScoreId == null || _medalsByScoreId.Count == 0)
                {
                    Snackbar.Add("No medal to delete.", Severity.Info);
                    return;
                }

                int deleted = 0;

                foreach (var kvp in _medalsByScoreId.ToList())
                {
                    var medal = kvp.Value;
                    if (medal == null) continue;

                    var ok = await apiService.DeleteAsync($"/Events/VersusTeams/{medal.ID}");
                    if (ok) deleted++;
                }

                Snackbar.Add($"Medal deleted for {deleted} player(s).", Severity.Success);
                _existingMedal = null;
                _selectedMedal = null;
                _medalsByScoreId.Clear();
                StateHasChanged();
                return;
            }

            // ✅ INDIVIDUAL
            if (_existingMedal == null)
            {
                Snackbar.Add("No medal to delete.", Severity.Info);
                return;
            }

            var success = await apiService.DeleteAsync($"/Events/VersusTeams/{_existingMedal.ID}");

            if (success)
            {
                Snackbar.Add("Medal deleted successfully.", Severity.Success);
                _existingMedal = null;
                _selectedMedal = null;
                _medalsByScoreId.Clear();
                StateHasChanged();
            }
            else
            {
                Snackbar.Add("Failed to delete medal.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting medal: {ex.Message}", Severity.Error);
        }
    }

    // Data models
    public class PerformanceBasedDTO
    {
        public class PerformanceEvent
        {
            public int ID { get; set; }
            public int? SportID { get; set; }
            public string MainCategory { get; set; } = string.Empty;
            public int? LevelID { get; set; }
            public int? GenderID { get; set; }
            public int? StageID { get; set; }
        }

        public class PerformanceTeam
        {
            public int ID { get; set; }
            public int? PerformanceID { get; set; }
            public int? TeamID { get; set; }
            public int RegionID { get; set; }
            public string PlayerID { get; set; } = string.Empty;
        }

        public class PerformanceScore
        {
            public int ID { get; set; }
            public int? PerformanceID { get; set; }
            public int PerformanceTeamID { get; set; }
            public int SportSubcategoryID { get; set; }
            public decimal Score { get; set; }
            public int Rank { get; set; }
            public string? UserID { get; set; }
            public DateTime UpdatedAt { get; set; }
            public int? TeamID { get; set; }
        }
    }

    public class SportsDTO
    {
        public class SportSubcategories
        {
            public int ID { get; set; }
            public string? Subcategory { get; set; }
            public int? SportID { get; set; }
            public int? SportGenderCategoryID { get; set; }
            public int? SchoolLevelID { get; set; }
            public string? MainCategory { get; set; }
        }

        public class SportGenderCategories
        {
            public int ID { get; set; }
            public string? Gender { get; set; }
        }
    }

    public class EventsDTO
    {
        public class EventVersusTeams
        {
            public int ID { get; set; }
            public string? EventID { get; set; }
            public int? PerformanceScoreID { get; set; }
            public int? PerformanceID { get; set; }
            public int? TeamID { get; set; }
            public int? SchoolRegionID { get; set; }
            public string? Score { get; set; }
            public string? Rank { get; set; }
            public DateTime? RecentUpdateAt { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class SchoolRegions
        {
            public int ID { get; set; }
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
        }

        public class SchoolLevels
        {
            public int ID { get; set; }
            public string? Level { get; set; }
        }
    }

    public class ProfilePlayersDTO
    {
        public class Players
        {
            public string ID { get; set; } = string.Empty;
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }
    }
}