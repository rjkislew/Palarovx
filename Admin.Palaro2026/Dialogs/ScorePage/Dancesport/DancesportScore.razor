@using Microsoft.AspNetCore.Components

@inject ISnackbar Snackbar
@inject APIService apiService
@inject IDialogService DialogService
@inject CookieService cookieService

@if (_isLoaded == true)
{
    <MudDialog>
        <DialogContent>
            <MudGrid Spacing="5">
                <!-- Player Info -->
                <MudItem xs="12" Class="mb-3">
                    @if (IsTeamEvent)
                    {
                        <MudText Typo="Typo.h6"> @_regionName</MudText>
                        <MudStack Row Spacing="2" Justify="Justify.FlexStart">
                            <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Color="Color.Dark"/>
                            <MudText Typo="Typo.caption">@string.Join(", ", _teamPlayerNames)</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudText Typo="Typo.h6" Class="mb-2">@_playerName</MudText>
                        <MudText Typo="Typo.caption">Region: @_regionName</MudText>
                    }
                    <MudDivider Class="my-2"/>
                </MudItem>

                <!-- Sport Details -->
                <MudItem xs="12" Class="mb-3">
                    <MudStack Spacing="1">
                        <MudGrid Spacing="1">
                            <MudItem xs="12">
                                <MudSelect @bind-Value="_selectedMainCategory" Margin="Margin.Dense"
                                           Label="Event" T="string"
                                           ShrinkLabel Variant="Variant.Outlined" Clearable
                                           ReadOnly="true">
                                    @if (!string.IsNullOrEmpty(_selectedMainCategory))
                                    {
                                        <MudSelectItem
                                            Value="@_selectedMainCategory">@_selectedMainCategory</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12">
                                <MudSelect Value="@_selectedSubcategoryId"
                                           ValueChanged="@((int? value) => OnSubcategoryChanged(value))"
                                           Margin="Margin.Dense"
                                           Label="Category" T="int?"
                                           ShrinkLabel Variant="Variant.Outlined" Clearable>
                                    <MudVirtualize Items="_sportSubcategories" Context="subCategory">
                                        <MudSelectItem T="int?"
                                                       Value="@subCategory.ID">@subCategory.Subcategory</MudSelectItem>
                                    </MudVirtualize>
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12">
                                <MudNumericField @bind-Value="_rankValue"
                                                 HideSpinButtons="true"
                                                 Label="Rank"
                                                 Variant="Variant.Outlined"
                                                 Min="1"
                                                 Max="50"
                                                 Margin="Margin.Dense"/>
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </DialogContent>
        <DialogActions>
            <MudButton Variant="Variant.Text" OnClick="ConfirmSaveRank">Save</MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }

    [Parameter] public int RegionID { get; set; }
    [Parameter] public string PlayerID { get; set; } = string.Empty;
    [Parameter] public int? EventID { get; set; }
    [Parameter] public EventCallback OnScoreSaved { get; set; }
    
    [Parameter] public bool IsTeamEvent { get; set; } = false;
    [Parameter] public List<string> TeamPlayerIDs { get; set; } = new();
    [Parameter] public int? TeamID { get; set; }

    private string _playerName = "Loading...";
    private string _regionName = "Loading...";
    private int _rankValue;
    private string? _selectedMainCategory;
    private int? _selectedSubcategoryId;
    private bool _isLoaded = false;
    private int? _existingScoreId;

    private List<string> _mainCategories = new();
    private PerformanceBasedDTO.PerformanceEvent? _selectedEvent;
    private List<SportsDTO.SportSubcategories> _sportSubcategories = new();
    private List<SportsDTO.SportSubcategories> _filteredSubcategories = new();
    private int? _opposingTeamId;
    private string _currentUserId = string.Empty;
    
    private List<string> _teamPlayerNames = new();

    // Add these fields for filtering
    private List<SportsDTO.SportGenderCategories> _sportGenderCategories = new();
    private List<SchoolsDTO.SchoolLevels> _schoolLevels = new();
    private int? _selectedSportIDValue;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
        _isLoaded = true;
    }

    private async Task LoadInitialData()
    {
        try
        {
            await GetCurrentUserIdAsync();
            await LoadEventData();
            await LoadPlayerAndRegionData();
            await LoadSportData(); // This will now use the filtered approach
            await LoadOpposingTeam();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
    }

    private async Task<string> GetCurrentUserIdAsync()
    {
        try
        {
            // Try to get user ID from cookie first
            var userId = await cookieService.GetCookie("userID");

            if (!string.IsNullOrEmpty(userId))
            {
                return userId;
            }

            // If no user ID in cookie, check for token
            var token = await cookieService.GetCookie("authenticationToken");
            if (string.IsNullOrEmpty(token))
            {
                Snackbar.Add("User not authenticated. Please log in.", Severity.Error);
                return string.Empty;
            }

            Snackbar.Add("Unable to retrieve user ID. Please log in again.", Severity.Warning);
            return string.Empty;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error getting user ID: {ex.Message}", Severity.Error);
            return string.Empty;
        }
    }

    private async Task LoadEventData()
    {
        try
        {
            if (!EventID.HasValue)
            {
                Snackbar.Add("No event ID provided", Severity.Error);
                return;
            }

            string eventUrl = $"/PerformanceBased/PerformanceEvent/{EventID.Value}";
            _selectedEvent = await apiService.GetSingleAsync<PerformanceBasedDTO.PerformanceEvent>(eventUrl);

            if (_selectedEvent == null)
            {
                var eventList = await apiService.GetAsync<PerformanceBasedDTO.PerformanceEvent>(eventUrl);
                _selectedEvent = eventList?.FirstOrDefault();
            }

            if (_selectedEvent != null)
            {
                _selectedMainCategory = _selectedEvent.MainCategory;
                _selectedSportIDValue = _selectedEvent.SportID;

                // Load the necessary data for filtering
                await GetGenderCategoriesAsync();
                await GetSchoolLevelsAsync();

                // Now filter subcategories using the event data
                await FilterSubcategoriesByEvent();
            }
            else
            {
                Snackbar.Add($"Event not found for ID: {EventID.Value}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading event data: {ex.Message}", Severity.Error);
        }
    }

    private async Task FilterSubcategoriesByEvent()
    {
        if (_selectedEvent == null) return;

        try
        {
            // Use the specific filtering method with event data
            await GetSportSubCategoriesAsync();

            if (!string.IsNullOrEmpty(_selectedMainCategory))
            {
                await FilterSubcategoriesByMainCategory();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error filtering subcategories: {ex.Message}", Severity.Error);
        }
    }

   private async Task LoadPlayerAndRegionData()
    {
        if (IsTeamEvent && TeamPlayerIDs.Any())
        {
            await LoadTeamPlayerNames();
        }
        else if (!string.IsNullOrEmpty(PlayerID) && EventID != null)
        {
            try
            {
                string playerUrl = $"/Profiles/Player?id={PlayerID}";
                var playerResult = await apiService.GetAsync<ProfilePlayersDTO.Players>(playerUrl);
                var player = playerResult?.FirstOrDefault();

                if (player != null)
                {
                    _playerName = $"{player.FirstName} {player.LastName}";
                }
                else
                {
                    _playerName = "Player not found";
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading player data: {ex.Message}", Severity.Error);
            }
        }

        try
        {
            string regionUrl = $"/Schools/Regions?id={RegionID}";
            var regionResult = await apiService.GetAsync<SchoolsDTO.SchoolRegions>(regionUrl);
            var region = regionResult?.FirstOrDefault();

            if (region != null)
            {
                _regionName = region.Abbreviation ?? region.Region;
            }
            else
            {
                _regionName = "Region not found";
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading region data: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadTeamPlayerNames()
    {
        _teamPlayerNames = new List<string>();
        
        foreach (var playerId in TeamPlayerIDs)
        {
            try
            {
                string playerUrl = $"/Profiles/Player?id={playerId}";
                var playerResult = await apiService.GetAsync<ProfilePlayersDTO.Players>(playerUrl);
                var player = playerResult?.FirstOrDefault();

                if (player != null)
                {
                    _teamPlayerNames.Add($"{player.FirstName} {player.LastName}");
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading team player {playerId}: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task LoadOpposingTeam()
    {
        if (EventID == null) return;

        try
        {
            string url = $"/PerformanceBased/OpposingTeams/{EventID}";
            var teams = await apiService.GetAsync<PerformanceBasedDTO.PerformanceTeam>(url);

            PerformanceBasedDTO.PerformanceTeam team;

            if (IsTeamEvent && TeamID.HasValue)
            {
                team = teams?.FirstOrDefault(t =>
                    t.RegionID == RegionID &&
                    t.TeamID == TeamID &&
                    t.PerformanceID == EventID);
            }
            else
            {
                team = teams?.FirstOrDefault(t =>
                    t.RegionID == RegionID &&
                    t.PlayerID == PlayerID &&
                    t.PerformanceID == EventID);
            }

            if (team != null)
            {
                _opposingTeamId = team.ID;
                TeamID = team.TeamID;  
            }
            else
            {
                Snackbar.Add("Could not find team information", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading team data: {ex.Message}", Severity.Error);
        }
    }


    private async Task LoadSportData()
    {
        try
        {
            // If we haven't loaded specific subcategories yet, load all as fallback
            if (!_sportSubcategories.Any())
            {
                string subcategoriesUrl = "/Sports/Subcategories";
                _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(subcategoriesUrl)
                                      ?? new List<SportsDTO.SportSubcategories>();
            }

            LoadMainCategories();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading sport data: {ex.Message}", Severity.Error);
        }
    }

    private void LoadMainCategories()
    {
        _mainCategories = _sportSubcategories
            .Where(sc => !string.IsNullOrEmpty(sc.MainCategory))
            .Select(sc => sc.MainCategory!)
            .Distinct()
            .ToList();
    }

    private async Task LoadExistingRank()
    {
        if (EventID == null) return;

        try
        {
            // Load all scores for this event
            string url = $"/PerformanceScore/Score/{EventID}";
            var scores = await apiService.GetAsync<PerformanceBasedDTO.PerformanceScore>(url) ?? new List<PerformanceBasedDTO.PerformanceScore>();

            // Find if there's already a score for this player/team and apparatus
            var existingScore = scores.FirstOrDefault(s =>
                s.PerformanceTeamID == _opposingTeamId &&
                s.SportSubcategoryID == _selectedSubcategoryId &&
                ((IsTeamEvent && s.TeamID.HasValue) || (!IsTeamEvent && !s.TeamID.HasValue))); // Match team/individual type

            if (existingScore != null)
            {
                _existingScoreId = existingScore.ID;
                _rankValue = existingScore.Rank;
            }
            else
            {
                // Reset rank value when no existing score is found
                _existingScoreId = null;
                _rankValue = 0;
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading existing rank: {ex.Message}", Severity.Error);

            _existingScoreId = null;
            _rankValue = 0;
            StateHasChanged();
        }
    }

    private async Task OnSubcategoryChanged(int? newValue)
    {
        _selectedSubcategoryId = newValue;
    
        _rankValue = 0;
        _existingScoreId = null;
    
        if (_selectedSubcategoryId.HasValue && _opposingTeamId.HasValue)
        {
            await LoadExistingRank();
        }
        else
        {
            StateHasChanged(); // Ensure UI updates even if we don't load
        }
    }

    private async Task FilterSubcategoriesByMainCategory()
    {
        if (string.IsNullOrEmpty(_selectedMainCategory))
        {
            _filteredSubcategories = new List<SportsDTO.SportSubcategories>();
            return;
        }

        _filteredSubcategories = _sportSubcategories
            .Where(sc => sc.MainCategory == _selectedMainCategory)
            .ToList();

        StateHasChanged();
    }

    private async Task GetGenderCategoriesAsync()
    {
        try
        {
            string url = "/Sports/GenderCategories";
            _sportGenderCategories = await apiService.GetAsync<SportsDTO.SportGenderCategories>(url)
                                     ?? new List<SportsDTO.SportGenderCategories>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading gender categories: {ex.Message}", Severity.Error);
        }
    }

    private async Task GetSchoolLevelsAsync()
    {
        try
        {
            string url = "/Schools/Levels";
            _schoolLevels = await apiService.GetAsync<SchoolsDTO.SchoolLevels>(url)
                            ?? new List<SchoolsDTO.SchoolLevels>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading school levels: {ex.Message}", Severity.Error);
        }
    }

    private async Task GetSportSubCategoriesAsync()
    {
        if (_selectedEvent == null) return;

        try
        {
            var parameters = new List<string>();

            if (_selectedEvent.SportID.HasValue)
                parameters.Add($"sportID={_selectedEvent.SportID}");

            if (_selectedEvent.LevelID.HasValue)
                parameters.Add($"schoolLevelID={_selectedEvent.LevelID}");

            if (_selectedEvent.GenderID.HasValue)
                parameters.Add($"sportGenderCategoryID={_selectedEvent.GenderID}");

            if (!string.IsNullOrEmpty(_selectedMainCategory))
                parameters.Add($"mainCategory={Uri.EscapeDataString(_selectedMainCategory)}");

            string url = "/Sports/Subcategories";
            if (parameters.Any())
                url += "?" + string.Join("&", parameters);

            var filteredSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(url);

            if (filteredSubcategories != null && filteredSubcategories.Any())
            {
                _sportSubcategories = filteredSubcategories;
            }
            else
            {
                string fallbackUrl = "/Sports/Subcategories";
                _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(fallbackUrl)
                                      ?? new List<SportsDTO.SportSubcategories>();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading sport subcategories: {ex.Message}", Severity.Error);
        }
    }

    private async Task ConfirmSaveRank()
    {
        if (!_selectedSubcategoryId.HasValue || _rankValue <= 0 || !_opposingTeamId.HasValue)
        {
            Snackbar.Add("Please select a category and enter a valid rank", Severity.Warning);
            return;
        }

        string action = _existingScoreId.HasValue ? "update" : "add";

        bool? result = await DialogService.ShowMessageBox(
            title: "Confirm Save Rank",
            message: $"Are you sure you want to {action} this rank?",
            yesText: "Yes",
            cancelText: "Cancel"
        );

        if (result == true)
        {
            await SaveRank();
        }
    }

    private async Task SaveRank()
    {
        try
        {
            if (!_selectedSubcategoryId.HasValue || _rankValue <= 0 || !_opposingTeamId.HasValue)
            {
                Snackbar.Add("Please select a category and enter a valid rank", Severity.Warning);
                return;
            }

            var currentUserId = await GetCurrentUserIdAsync();

            var scoreData = new PerformanceBasedDTO.PerformanceScore
            {
                PerformanceID = EventID.Value,
                PerformanceTeamID = _opposingTeamId.Value,
                SportSubcategoryID = _selectedSubcategoryId.Value,
                Score = 0, // Set score to 0 since we're now storing rank
                Rank = _rankValue,
                UserID = currentUserId,
                UpdatedAt = DateTime.Now,
                TeamID = IsTeamEvent ? TeamID : null
            };

            // If we have an existing score ID, we're updating. Otherwise, we're creating.
            if (_existingScoreId.HasValue)
            {
                // Update existing score
                scoreData.ID = _existingScoreId.Value;
                string url = $"/PerformanceScore/Score/{_existingScoreId.Value}";
                var result = await apiService.PutAsync<PerformanceBasedDTO.PerformanceScore>(url, scoreData);

                if (result)
                {
                    Snackbar.Add("Rank updated successfully!", Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    Snackbar.Add("Failed to update rank", Severity.Error);
                }
            }
            else
            {
                // Create new score
                string url = "/PerformanceScore/Score";
                var result = await apiService.PostAsync<PerformanceBasedDTO.PerformanceScore>(url, scoreData);

                if (result != null)
                {
                    Snackbar.Add("Rank saved successfully!", Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    Snackbar.Add("Failed to save rank", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving rank: {ex.Message}", Severity.Error);
        }
    }


    // Data models
    public class PerformanceBasedDTO
    {
        public class PerformanceEvent
        {
            public int ID { get; set; }
            public int? SportID { get; set; }
            public string MainCategory { get; set; } = string.Empty;
            public int? LevelID { get; set; }
            public int? GenderID { get; set; }
            public int? StageID { get; set; }
        }

        public class PerformanceTeam
        {
            public int ID { get; set; }
            public int? PerformanceID { get; set; }
            public int? TeamID { get; set; }
            public int RegionID { get; set; }
            public string PlayerID { get; set; } = string.Empty;
        }

        public class PerformanceScore
        {
            public int ID { get; set; }
            public int? PerformanceID { get; set; }
            public int PerformanceTeamID { get; set; }
            public int SportSubcategoryID { get; set; }
            public decimal Score { get; set; }
            public int Rank { get; set; }
            public string? UserID { get; set; }
            public DateTime UpdatedAt { get; set; }
            public int? TeamID { get; set; }
        }
    }

    public class SportsDTO
    {
        public class SportSubcategories
        {
            public int ID { get; set; }
            public string? Subcategory { get; set; }
            public int? SportID { get; set; }
            public int? SportGenderCategoryID { get; set; }
            public int? SchoolLevelID { get; set; }
            public string? MainCategory { get; set; }
        }

        public class SportGenderCategories
        {
            public int ID { get; set; }
            public string? Gender { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class SchoolRegions
        {
            public int ID { get; set; }
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
        }

        public class SchoolLevels
        {
            public int ID { get; set; }
            public string? Level { get; set; }
        }
    }

    public class ProfilePlayersDTO
    {
        public class Players
        {
            public string ID { get; set; } = string.Empty;
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
        }
    }
}