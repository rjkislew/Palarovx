@using System.Net.Http.Headers
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject APIService apiService
@inject HttpClient httpClient

@if (_isLoaded == true)
{
    <MudDialog>
        <DialogContent>
            <MudGrid Spacing="5">
                <!-- Sport Details -->
                <MudItem xs="12" Class="mb-3">
                    <MudStack Spacing="1">
                        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText>Sport Details</MudText>
                        </MudStack>
                        <MudDivider/>
                        <MudGrid Spacing="1">
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="_selectedSportCategoryIDValue" Margin="Margin.Dense"
                                           Label="Classification" T="int?"
                                           ShrinkLabel Variant="Variant.Outlined" Clearable ReadOnly="true">
                                    <MudVirtualize Items="_sportCategories" Context="category">
                                        <MudSelectItem T="int?" Value="category.ID">@category.Category</MudSelectItem>
                                    </MudVirtualize>
                                </MudSelect>
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="_selectedSportIDValue" Margin="Margin.Dense" Label="Sport"
                                           T="int?"
                                           ShrinkLabel Variant="Variant.Outlined" Clearable ReadOnly="true">
                                    <MudVirtualize Items="_sports" Context="sport">
                                        <MudSelectItem T="int?" Value="sport.ID">@sport.Sport</MudSelectItem>
                                    </MudVirtualize>
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="_selectedSchoolLevelAndGenderID" Margin="Margin.Dense"
                                           Label="School Level and Gender" T="string"
                                           ShrinkLabel Variant="Variant.Outlined" Clearable
                                           Disabled="_selectedSportIDValue == null"
                                           ReadOnly="@IsEditMode"
                                           SelectedValuesChanged="@((values) => OnSchoolLevelGenderChanged())">
                                    <MudVirtualize Items="_combinedSchoolLevelAndGenderNames" Context="combinedID">
                                        <MudSelectItem T="string" Value="@combinedID">@combinedID</MudSelectItem>
                                    </MudVirtualize>
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="_selectedMainCategoryValue" Margin="Margin.Dense"
                                           Label="Event" T="string"
                                           SelectedValuesChanged="@((values) => OnMainCategoryChanged())"
                                           ShrinkLabel Variant="Variant.Outlined" Clearable ReadOnly="@IsEditMode"
                                           Disabled="@(!_sportMainCat?.Any() == true || _selectedSchoolLevelAndGenderID == null)">
                                    @foreach (var mc in _sportMainCat)
                                    {
                                        <MudSelectItem Value="@mc">@mc</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudItem>

                <!-- Event Stage -->
                <MudItem xs="12" Class="mb-3">
                    <MudStack Spacing="1">
                        <MudText>Event Stage Detail</MudText>
                        <MudDivider/>
                        <MudGrid Spacing="1">
                            <MudItem xs="12" sm="6" md="4">
                                <MudSelect @bind-Value="_selectedEventStagesIDValue" Margin="Margin.Dense"
                                           Label="Stage" T="int?" ReadOnly="@IsEditMode" SelectedValuesChanged="@((values) => OnStageChanged())"
                                           ShrinkLabel Variant="Variant.Outlined" Clearable>
                                    <MudVirtualize Items="_eventStages" Context="eventStage">
                                        <MudSelectItem T="int?" Value="eventStage.ID">@eventStage.Stage</MudSelectItem>
                                    </MudVirtualize>
                                </MudSelect>
                            </MudItem>
                            @if (IsEditMode)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <MudSelect @bind-Value="_selectedIsEventFinishedValue"
                                               Label="Status"
                                               T="bool?"
                                               Variant="Variant.Outlined"
                                               Clearable Margin="Margin.Dense">
                                        <MudSelectItem T="bool?" Value="true">Finished</MudSelectItem>
                                        <MudSelectItem T="bool?" Value="false">Ongoing</MudSelectItem>
                                    </MudSelect>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudStack>
                </MudItem>

                <!-- Opposing Team -->
                <MudItem xs="12" Class="mb-3">
                    <MudStack Spacing="1">
                        <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText>Opposing Team</MudText>
                            <MudButton StartIcon="@Icons.Material.Filled.Add"
                                       OnClick="AddOpponent"
                                       Disabled="_filteredRegions == null || !_filteredRegions.Any()">
                                Add Opponent
                            </MudButton>
                        </MudStack>
                        <MudDivider />

                        @for (int i = 0; i < _teamSelections.Count; i++)
                        {
                            var team = _teamSelections[i];
                            <MudGrid Spacing="0">
                                <MudItem xs="12">
                                    <!-- Region Select -->
                                    <MudSelect @bind-Value="team.SelectedRegionID"
                                               Margin="Margin.Dense"
                                               Label="Region"
                                               ShrinkLabel
                                               Variant="Variant.Outlined"
                                               T="int?"
                                               Clearable
                                               SelectedValuesChanged="@((values) => InvokeAsync(async () =>
                                                                             {
                                                                                 team.SelectedPlayerIDs = new HashSet<string>();
                                                                                 await GetPlayerAsync(team);
                                                                             }))">
                                <MudVirtualize Items="_filteredRegions" Context="region">
                                    <MudSelectItem T="int?" Value="@region.ID">
                                        @region.Region (@region.Abbreviation)
                                    </MudSelectItem>
                                </MudVirtualize>
                            </MudSelect>

                                    <!-- Players Select -->
                                    <MudSelect SelectedValues="@team.SelectedPlayerIDs"
                                               SelectedValuesChanged="@(async (IEnumerable<string> values) => await OnSelectedPlayersChanged(team, values))"
                                               MultiSelection="true"
                                               SelectAll="true"
                                               Clearable
                                               Margin="Margin.Dense"
                                               Label="Players"
                                               ShrinkLabel
                                               Variant="Variant.Outlined"
                                               Disabled="!team.SelectedRegionID.HasValue || !_selectedSportIDValue.HasValue || string.IsNullOrEmpty(_selectedMainCategoryValue)"
                                               T="string"
                                               ToStringFunc="@(id => team.AvailablePlayers?.FirstOrDefault(p => p.ID == id) is { } player ? $"{player.FirstName} {player.LastName}" : string.Empty)">
                                        @if (team.AvailablePlayers?.Any() == true)
                                        {
                                            foreach (var player in team.AvailablePlayers)
                                            {
                                                <MudSelectItem T="string" Value="@player.ID">
                                                    @player.FirstName @player.LastName
                                                </MudSelectItem>
                                            }
                                        }
                                    </MudSelect>

                                    <!-- Set as Team Button - Below each player dropdown -->
                                    @if (ShouldShowSetTeamButton())
                                    {
                                        <MudItem xs="12" Class="mt-2">
                                            <MudButton StartIcon="@Icons.Material.Filled.Groups"
                                                       OnClick="() => SetAsTeam(team)"
                                                       Variant="Variant.Filled"
                                                       Color="Color.Primary"
                                                       Size="Size.Small"
                                                       FullWidth="true"
                                                       Disabled="!team.SelectedRegionID.HasValue || team.SelectedPlayerIDs?.Any() != true || team.TeamID.HasValue">Set as Couple                                             
                                            </MudButton>
                                        </MudItem>
                                    }
                                </MudItem>
                            </MudGrid>

                            @if (i < _teamSelections.Count - 1)
                            {
                                <MudText Align="Align.Center" Typo="Typo.h6" Class="mt-2 mb-2">VS</MudText>
                            }
                        }
                    </MudStack>
                </MudItem>

                <MudItem xs="12">
                    <MudStack Spacing="1">
                        <MudText>Upload Official Result</MudText>
                        <MudDivider />
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                            <MudItem xs="12" sm="6">
                                <MudStack Row AlignItems="AlignItems.Center">
                                    <MudFileUpload T="IBrowserFile"
                                                   FilesChanged="HandleFileUpload">
                                        <ActivatorContent>
                                            <MudIconButton Icon="@Icons.Material.Filled.Upload"
                                                           Variant="Variant.Filled"
                                                           Color="Color.Primary" />
                                        </ActivatorContent>
                                    </MudFileUpload>

                                    <MudButton StartIcon="@Icons.Material.Filled.AttachFile"
                                               Href="@_eventAttachmentUrl"
                                               Target="_blank"
                                               Disabled="@(!_fileExists)">
                                        <MudText Class="ml-2">@_eventAttachmentUploadState</MudText>
                                    </MudButton>
                                </MudStack>
                            </MudItem>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </DialogContent>
        <DialogActions>
            @if (IsEditMode)
            {
                <!-- Edit Mode: Delete | Cancel | Update -->
                <MudStack Row Justify="Justify.SpaceBetween" Style="width: 100%">
                    <MudButton Style="text-transform: none" DropShadow="false" Color="Color.Error"
                               OnClick="ConfirmDeleteEventAsync">
                        Delete
                    </MudButton>
                    <MudStack Row AlignItems="AlignItems.Center">
                        <MudButton Style="text-transform: none" DropShadow="false" OnClick="Cancel">
                            Cancel
                        </MudButton>
                        <MudButton Style="text-transform: none" DropShadow="false" OnClick="ConfirmUpdateEventAsync">
                            Update
                        </MudButton>
                    </MudStack>
                </MudStack>
            }
            else
            {
                <!-- Add Mode: Cancel | Clear | Add -->
                <MudStack Row Justify="Justify.SpaceBetween" Style="width: 100%">
                    <MudButton Style="text-transform: none" DropShadow="false" OnClick="Cancel">
                        Cancel
                    </MudButton>
                    <MudStack Row AlignItems="AlignItems.Center">
                        <MudButton Style="text-transform: none" DropShadow="false" OnClick="ClearFields">
                            Clear
                        </MudButton>
                        <MudButton Style="text-transform: none" DropShadow="false" OnClick="ConfirmAddEventAsync">
                            Add
                        </MudButton>
                    </MudStack>
                </MudStack>
            }
        </DialogActions>
    </MudDialog>
}
else
{
    <MudDialog>
        <DialogContent>
            <MudProgressLinear Indeterminate="true" Class="my-5"/>
        </DialogContent>
    </MudDialog>
}


@code {
    // ------------------------------
    // Dialog & Services
    // ------------------------------
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }
    [Inject] private CookieService cookieService { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;

    // ------------------------------
    // Parameters
    // ------------------------------
    [Parameter] public int? SelectedEventID { get; set; }
    [Parameter] public int? SelectedSubCategoryID { get; set; }
    [Parameter] public bool IsEditMode { get; set; } = false;
    [Parameter] public int? SelectedEventVersusTeamsID { get; set; }
    [Parameter] public string? SelectedEventStage { get; set; }

    // ------------------------------
    // DTO Lists
    // ------------------------------
    private List<EventsDTO.EventStages>? _eventStages;
    private List<SportsDTO.SportCategories>? _sportCategories;
    private List<SportsDTO.Sports>? _sports;
    private List<SportsDTO.SportGenderCategories>? _sportGenderCategories;
    private List<SchoolsDTO.SchoolLevels>? _schoolLevels;
    private List<SportsDTO.SportSubcategories>? _sportSubcategories;
    private List<SchoolsDTO.SchoolRegions>? _schoolRegions;
    private List<SchoolsDTO.SchoolRegions>? _filteredRegions;

    // ------------------------------
    // Selected Values
    // ------------------------------
    private int? _selectedEventStagesIDValue;
    private string? _selectedSchoolLevelAndGenderID;
    private int? _selectedSportCategoryIDValue = 1;
    private int? _selectedSportIDValue = 10;
    private string? _selectedMainCategoryValue;
    private int? _selectedSportGenderCategoryIDValue;
    private int? _selectedSchoolLevelIDValue;
    private bool _isLoaded = false;
    private bool? _selectedIsEventFinishedValue;

    
    // UI
    private List<string> _combinedSchoolLevelAndGenderNames = new();
    private List<string> _sportMainCat = new();
    private string? _selectedSportMainCat;
    private List<TeamSelection> _teamSelections = new();

    protected override async Task OnInitializedAsync()
    {
        _selectedSportCategoryIDValue = 1; // Sport Category ID = 1
        _selectedSportIDValue = 10; // Sport ID = 10

        await LoadDataAsync();

        if (!IsEditMode)
            _teamSelections.Add(new TeamSelection());

        _isLoaded = true;
        StateHasChanged(); // Ensure UI updates
    }

    private async Task LoadDataAsync()
    {
        await GetEventStagesAsync();
        await GetSportCategoriesAsync();
        await GetGenderCategoriesAsync();
        await GetSchoolLevelsAsync();
        await GetSchoolRegionsAsync();
        await GetSportsAsync();

        if (IsEditMode && SelectedEventID.HasValue)
            await GetEventsOnDialogOpenAsync();

        await FilterSchoolLevelAndGenderAsync();
    }

    // API Calls
    private async Task GetEventStagesAsync()
    {
        string url = "/Events/Stages";
        _eventStages = await apiService.GetAsync<EventsDTO.EventStages>(url) ?? new List<EventsDTO.EventStages>();
    }

    private async Task GetSportCategoriesAsync()
    {
        string url = "/Sports/Categories";
        _sportCategories = await apiService.GetAsync<SportsDTO.SportCategories>(url) ?? new List<SportsDTO.SportCategories>();
    }

    private async Task GetSportsAsync()
    {
        string url = $"/Sports?sportCategoryID={_selectedSportCategoryIDValue}";
        _sports = await apiService.GetAsync<SportsDTO.Sports>(url) ?? new List<SportsDTO.Sports>();

        if (!IsEditMode && _sports.Any())
        {
            _selectedSportIDValue = 10;
        }
    }

    private async Task GetPlayerAsync(TeamSelection team)
    {
        // Validate first
        if (!team.SelectedRegionID.HasValue || !_selectedSportIDValue.HasValue || string.IsNullOrEmpty(_selectedMainCategoryValue))
        {
            team.AvailablePlayers = new();
            return;
        }
        
        await GetPlayersWithFilters(team);

        // Ensure selected players are maintained
        StateHasChanged();
    }

    private async Task GetPlayersWithFilters(TeamSelection team)
    {
        // Extract school level and gender from the selected combined value
        var parts = _selectedSchoolLevelAndGenderID?.Split(" - ");
        var schoolLevelName = parts?.Length > 0 ? parts[0] : null;
        var genderName = parts?.Length > 1 ? parts[1] : null;

        // Get the corresponding IDs
        var schoolLevelID = _schoolLevels?.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
        var genderID = _sportGenderCategories?.FirstOrDefault(x => x.Gender == genderName)?.ID;

        // Build URL with filters
        string url = $"/Profiles/Player/FilteredPlayer?regionID={team.SelectedRegionID}&sportID={_selectedSportIDValue}&schoolLevelID={schoolLevelID}&genderID={genderID}";

        var result = await apiService.GetAsync<ProfilesDTO.ProfilePlayerEvent>(url) ?? new List<ProfilesDTO.ProfilePlayerEvent>();

        // Filter players by main category through subcategories
        if (result != null && _sportSubcategories != null)
        {
            var validSubcategoryIDs = _sportSubcategories
                .Where(sc => !string.IsNullOrEmpty(sc.MainCategory) &&
                             sc.MainCategory.Equals(_selectedMainCategoryValue, StringComparison.OrdinalIgnoreCase))
                .Select(sc => sc.ID)
                .ToList();

            if (validSubcategoryIDs.Any())
            {
                result = result.Where(player =>
                    player.SubCategoryID.HasValue &&
                    validSubcategoryIDs.Contains(player.SubCategoryID.Value)
                ).ToList();
            }
            else
            {
                result = new List<ProfilesDTO.ProfilePlayerEvent>();
            }
        }

        team.AvailablePlayers = result ?? new List<ProfilesDTO.ProfilePlayerEvent>();
    }

    private async Task GetGenderCategoriesAsync()
    {
        string url = "/Sports/GenderCategories";
        _sportGenderCategories = await apiService.GetAsync<SportsDTO.SportGenderCategories>(url) ?? new List<SportsDTO.SportGenderCategories>();
    }

    private async Task GetSchoolLevelsAsync()
    {
        string url = "/Schools/Levels";
        _schoolLevels = await apiService.GetAsync<SchoolsDTO.SchoolLevels>(url) ?? new List<SchoolsDTO.SchoolLevels>();

        await GetSportSubCategoriesAsync();
    }

    private async Task GetSportSubCategoriesAsync()
    {
        string url = $"/Sports/Subcategories?sportID={_selectedSportIDValue}&schoolLevelID={_selectedSchoolLevelIDValue}&sportGenderCategoryID={_selectedSportGenderCategoryIDValue}";
        _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(url) ?? new List<SportsDTO.SportSubcategories>();
    }

    private async Task GetSportSubCategoriesSLGAsync()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
            return;
        }

        var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
        var schoolLevelName = parts[0];
        var genderName = parts[1];

        var schoolLevelID = _schoolLevels?.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
        var genderID = _sportGenderCategories?.FirstOrDefault(x => x.Gender == genderName)?.ID;

        if (schoolLevelID != null && genderID != null)
        {
            _sportSubcategories = await apiService.GetAsync<SportsDTO.SportSubcategories>(
                $"/Sports/Subcategories?sportID={_selectedSportIDValue}&schoolLevelID={schoolLevelID}&sportGenderCategoryID={genderID}")
                ?? new List<SportsDTO.SportSubcategories>();
        }
        else
        {
            _sportSubcategories = new List<SportsDTO.SportSubcategories>();
        }

        // Apply region filtering when categories change
        await FilterRegionsByStage();

        // Clear player selections when category changes
        foreach (var team in _teamSelections)
        {
            team.SelectedPlayerIDs = new HashSet<string>();
            team.AvailablePlayers = new List<ProfilesDTO.ProfilePlayerEvent>();
        }
    }

    private async Task OnSchoolLevelGenderChanged()
    {
        _selectedMainCategoryValue = null;
        await GetSportSubCategoriesSLGAsync();
        LoadMainCategories();

        foreach (var team in _teamSelections)
        {
            team.SelectedRegionID = null;
            team.SelectedPlayerIDs = new HashSet<string>();
            team.AvailablePlayers = new List<ProfilesDTO.ProfilePlayerEvent>();
        }

        // Apply region filtering when school level/gender changes
        await FilterRegionsByStage();
    }

    private async Task OnMainCategoryChanged()
    {
        foreach (var team in _teamSelections)
        {
            team.SelectedRegionID = null;
            team.SelectedPlayerIDs = new HashSet<string>();
            team.AvailablePlayers = new List<ProfilesDTO.ProfilePlayerEvent>();
        }

        // Apply region filtering when main category changes
        await FilterRegionsByStage();

        StateHasChanged();
    }

    private async Task OnSelectedPlayersChanged(TeamSelection team, IEnumerable<string> selectedValues)
    {
        team.SelectedPlayerIDs = selectedValues?.ToHashSet() ?? new HashSet<string>();
        await InvokeAsync(StateHasChanged);
    }

    private async Task GetSchoolRegionsAsync()
    {
        string url = "/Schools/Regions";
        _schoolRegions = await apiService.GetAsync<SchoolsDTO.SchoolRegions>(url) ?? new List<SchoolsDTO.SchoolRegions>();

        // Apply stage filtering to regions
        await FilterRegionsByStage();
    }

    private int? GetSchoolLevelIDFromSelection()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID)) return null;
        var schoolLevelName = _selectedSchoolLevelAndGenderID.Split(" - ")[0];
        return _schoolLevels?.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
    }

    private int? GetGenderCategoryIDFromSelection()
    {
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID)) return null;
        var genderName = _selectedSchoolLevelAndGenderID.Split(" - ")[1];
        return _sportGenderCategories?.FirstOrDefault(x => x.Gender == genderName)?.ID;
    }

    // ------------------------------
    // Event CRUD
    // -----------------------------

    private async Task AddEventAsync()
    {
        try
        {
            // Create the gymnastics event
            var addEvent = new PerformanceBasedDTO.PerformanceEvent
            {
                SportID = _selectedSportIDValue,
                MainCategory = _selectedMainCategoryValue ?? string.Empty,
                StageID = _selectedEventStagesIDValue,
                LevelID = GetSchoolLevelIDFromSelection(),
                GenderID = GetGenderCategoryIDFromSelection(),
                IsFinished = false,
            };

            var eventCreated = await apiService.PostAndReadAsync<PerformanceBasedDTO.PerformanceEvent>("/PerformanceBased/AddEvent", addEvent);

            if (eventCreated == null)
            {
                Snackbar.Add("Failed to add event.", Severity.Error);
                return;
            }

            // Process all team selections
            foreach (var team in _teamSelections)
            {
                if (team.SelectedRegionID.HasValue && team.SelectedPlayerIDs?.Any() == true)
                {
                    await ProcessTeamSelection(eventCreated.ID, team);
                }
            }

            await UploadEventAttachmentAsync(eventCreated.ID);

            Snackbar.Add("Event added successfully.", Severity.Success);
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding event: {ex.Message}", Severity.Error);
        }
    }

    private async Task ProcessTeamSelection(int eventId, TeamSelection team)
    {
        int? teamIdToUse = null;

        // USE TEAM ID ONLY IF USER CLICKED "SET AS TEAM" AND HAS 2+ PLAYERS
        if (team.TeamID.HasValue && team.SelectedPlayerIDs.Count > 1)
        {
            teamIdToUse = team.TeamID.Value;
        }
        else
        {
            // Do NOT use team ID for individuals
            // Do NOT use team ID unless button is clicked
            teamIdToUse = null;
        }

        foreach (var playerId in team.SelectedPlayerIDs)
        {
            if (string.IsNullOrEmpty(playerId)) continue;

            var opposingTeam = new PerformanceBasedDTO.PerformanceTeam
            {
                PerformanceID = eventId,
                RegionID = team.SelectedRegionID.Value,
                PlayerID = playerId,
                TeamID = teamIdToUse // <- NULL for individuals
            };

            var result = await apiService.PostAndReadAsync<PerformanceBasedDTO.PerformanceTeam>(
                "/PerformanceBased/AddOpposingTeam", opposingTeam
            );

            if (result == null)
            {
                Snackbar.Add($"Failed to add player {playerId}.", Severity.Error);
            }
        }
    }

    private async Task UpdateEventAsync()
    {
        try
        {
            _uploadingOfficialResult = true;
            StateHasChanged();

            // 1. Update the gymnastics event
            var updateEvent = new PerformanceBasedDTO.PerformanceEvent
            {
                ID = SelectedEventID.Value,
                SportID = _selectedSportIDValue ?? 10,
                MainCategory = _selectedMainCategoryValue ?? string.Empty,
                StageID = _selectedEventStagesIDValue,
                LevelID = GetSchoolLevelIDFromSelection(),
                GenderID = GetGenderCategoryIDFromSelection(),
                IsFinished = _selectedIsEventFinishedValue,
            };

            var eventSuccess = await apiService.PutAsync($"/PerformanceBased/UpdateEvent/{SelectedEventID}", updateEvent);
            if (!eventSuccess)
            {
                Snackbar.Add("Failed to update event.", Severity.Error);
                return;
            }

            // Delete existing teams first
            await apiService.DeleteAsync($"/PerformanceBased/DeleteOpposingTeamsByEvent/{SelectedEventID}");

            await UploadEventAttachmentAsync(SelectedEventID.Value);

            // Add updated teams WITH TeamID
            foreach (var team in _teamSelections)
            {
                if (team.SelectedRegionID.HasValue && team.SelectedPlayerIDs?.Any() == true)
                {
                    foreach (var playerId in team.SelectedPlayerIDs)
                    {
                        if (!string.IsNullOrEmpty(playerId))
                        {
                            var opposingTeam = new PerformanceBasedDTO.PerformanceTeam
                            {
                                PerformanceID = SelectedEventID.Value,
                                RegionID = team.SelectedRegionID.Value,
                                PlayerID = playerId,
                                TeamID = team.TeamID // Add this line
                            };

                            var result = await apiService.PostAndReadAsync<PerformanceBasedDTO.PerformanceTeam>("/PerformanceBased/AddOpposingTeam", opposingTeam);

                            if (result != null)
                            {
                                // Success
                            }
                        }
                    }
                }
            }

            Snackbar.Add("Event updated successfully.", Severity.Success);
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating event: {ex.Message}", Severity.Error);
        }
        finally
        {
            _uploadingOfficialResult = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmUpdateEventAsync()
    {
        bool? result = await DialogService.ShowMessageBox(
            title: "Notice",
            message: "Do you confirm changing the event?",
            yesText: "Yes",
            cancelText: "Cancel");

        if (result == true)
        {
            await UpdateEventAsync();
            MudDialog?.Close(DialogResult.Ok(true));
        }
    }

    private async Task ConfirmDeleteEventAsync()
    {
        bool? result = await DialogService.ShowMessageBox(
            title: "Notice",
            message: "Do you confirm deleting this event?",
            yesText: "Yes",
            cancelText: "Cancel");

        if (result == true)
        {
            await DeleteEventAsync();
            MudDialog?.Close(DialogResult.Ok(true));
        }
    }

    private async Task DeleteEventAsync()
    {
        if (SelectedEventID == null) return;

        string versusTeamsUrl = $"/PerformanceBased/DeleteOpposingTeam/{SelectedEventID}";
        var versusTeams = await apiService.GetAsync<PerformanceBasedDTO.PerformanceTeam>(versusTeamsUrl);

        string url = $"/PerformanceBased/DeleteEvent/{SelectedEventID}";
        var success = await apiService.DeleteAsync(url);

        if (success)
        {
            Snackbar.Add("Event deleted successfully.", Severity.Success);
        }
        else
        {
            Snackbar.Add("Failed to delete event.", Severity.Error);
        }
    }

    // Method to determine if the Set Team button should be visible
    private bool ShouldShowSetTeamButton()
    {
        // Check if School Level and Gender is selected
        if (string.IsNullOrEmpty(_selectedSchoolLevelAndGenderID))
            return false;

        var parts = _selectedSchoolLevelAndGenderID.Split(" - ");
        if (parts.Length < 2)
            return false;

        var schoolLevel = parts[0];
        var gender = parts[1];

        // Check if it's Elementary or Secondary
        if (schoolLevel != "Elementary Level" && schoolLevel != "Secondary Level")
            return false;

        // Check if gender is Mix
        if (gender != "Mix")
            return false;

        return true;
    }

    // Simple TeamID generation
    private int _teamCounter = 1;

    private int GenerateTeamID()
    {
        return _teamCounter++;
    }

    private void SetAsTeam(TeamSelection team)
    {
        try
        {
            if (!team.SelectedRegionID.HasValue || team.SelectedPlayerIDs?.Any() != true)
            {
                Snackbar.Add("Please select a region and at least one player to set as a team.", Severity.Warning);
                return;
            }

            if (team.TeamID == null)
            {
                team.TeamID = GenerateTeamID();
                Snackbar.Add("Team has been set successfully!", Severity.Success);
            }
            else
            {
                Snackbar.Add("This team already has a TeamID assigned.", Severity.Info);
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error setting team: {ex.Message}", Severity.Error);
        }
    }

    // ------------------------------
    // Event Load on Edit
    // ------------------------------
    private async Task GetEventsOnDialogOpenAsync()
    {
        if (SelectedEventID == null) return;

        try
        {
            // Get the specific event
            string url = $"/PerformanceBased/PerformanceEvent/{SelectedEventID}";
            var eventDetail = await apiService.GetSingleAsync<PerformanceBasedDTO.PerformanceEvent>(url);

            if (eventDetail != null)
            {
                _selectedEventStagesIDValue = eventDetail.StageID;
                _selectedMainCategoryValue = eventDetail.MainCategory;
                _selectedSportIDValue = eventDetail.SportID;
                _selectedIsEventFinishedValue = eventDetail.IsFinished;

                await SetSchoolLevelAndGender(eventDetail.LevelID, eventDetail.GenderID);

                LoadMainCategories();

                await LoadOpposingTeamsForEdit();

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading event: {ex.Message}", Severity.Error);
        }
    }

    private async Task SetSchoolLevelAndGender(int? schoolLevelID, int? genderCategoryID)
    {
        if (schoolLevelID == null || genderCategoryID == null) return;

        var schoolLevel = _schoolLevels?.FirstOrDefault(x => x.ID == schoolLevelID);
        var gender = _sportGenderCategories?.FirstOrDefault(x => x.ID == genderCategoryID);

        if (schoolLevel != null && gender != null)
        {
            _selectedSchoolLevelAndGenderID = $"{schoolLevel.Level} - {gender.Gender}";

            // Load subcategories for this selection
            await GetSportSubCategoriesSLGAsync();
            LoadMainCategories();
        }
    }

    private async Task LoadOpposingTeamsForEdit()
    {
        if (SelectedEventID == null) return;

        try
        {
            string url = $"/PerformanceBased/OpposingTeams/{SelectedEventID}";
            var opposingTeams = await apiService.GetAsync<PerformanceBasedDTO.PerformanceTeam>(url) ?? new List<PerformanceBasedDTO.PerformanceTeam>();

            _teamSelections = new List<TeamSelection>();

            if (opposingTeams != null && opposingTeams.Any())
            {
                // Group by both RegionID AND TeamID to preserve team groupings
                var teamsByRegionAndTeam = opposingTeams
                    .Where(team => team.RegionID.HasValue && !string.IsNullOrEmpty(team.PlayerID))
                    .GroupBy(team => new { RegionID = team.RegionID.Value, TeamID = team.TeamID });

                foreach (var teamGroup in teamsByRegionAndTeam)
                {
                    var teamSelection = new TeamSelection
                    {
                        SelectedRegionID = teamGroup.Key.RegionID,
                        TeamID = teamGroup.Key.TeamID // Load the TeamID
                    };

                    await GetPlayerAsync(teamSelection);

                    // Set the selected player IDs
                    teamSelection.SelectedPlayerIDs = teamGroup
                        .Where(team => !string.IsNullOrEmpty(team.PlayerID))
                        .Select(team => team.PlayerID)
                        .ToHashSet();

                    _teamSelections.Add(teamSelection);
                }
            }

            if (!_teamSelections.Any())
            {
                _teamSelections.Add(new TeamSelection());
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading teams: {ex.Message}", Severity.Error);
        }
    }

    // ------------------------------
    // Main Categories & School Level/Gender
    // ------------------------------
    private void LoadMainCategories()
    {
        _sportMainCat = _sportSubcategories?
            .Where(sc => !string.IsNullOrEmpty(sc.MainCategory))
            .Select(sc => sc.MainCategory!.Trim())
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(x => x)
            .ToList() ?? new List<string>();
    }

    private async Task FilterSchoolLevelAndGenderAsync()
    {
        if (_selectedSportIDValue == null)
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var subcats = await apiService.GetAsync<SportsDTO.SportSubcategories>(
            $"/Sports/Subcategories?sportID={_selectedSportIDValue}") ?? new List<SportsDTO.SportSubcategories>();

        if (subcats == null || !subcats.Any())
        {
            _combinedSchoolLevelAndGenderNames = new List<string>();
            return;
        }

        var schoolLevelIDs = subcats.Where(x => x.SchoolLevelID.HasValue).Select(x => x.SchoolLevelID.Value).Distinct();
        var genderIDs = subcats.Where(x => x.SportGenderCategoryID.HasValue).Select(x => x.SportGenderCategoryID.Value).Distinct();

        var schoolLevelNames = _schoolLevels?.Where(s => schoolLevelIDs.Contains(s.ID)).Select(s => s.Level) ?? new List<string>();
        var genderNames = _sportGenderCategories?.Where(g => genderIDs.Contains(g.ID)).Select(g => g.Gender) ?? new List<string>();

        _combinedSchoolLevelAndGenderNames = schoolLevelNames.SelectMany(s => genderNames, (s, g) => $"{s} - {g}").ToList();
    }

    //Filter players per stages

    //Filter regions per stages
    private async Task FilterRegionsByStage()
    {
        if (_schoolRegions == null || !_schoolRegions.Any())
        {
            _filteredRegions = new List<SchoolsDTO.SchoolRegions>();
            return;
        }

        // If no stage selected, show all regions
        if (!_selectedEventStagesIDValue.HasValue)
        {
            _filteredRegions = _schoolRegions.ToList();
            return;
        }

        // Get the current stage
        var currentStage = _eventStages?.FirstOrDefault(x => x.ID == _selectedEventStagesIDValue.Value);
        if (currentStage == null)
        {
            _filteredRegions = _schoolRegions.ToList();
            return;
        }

        // If it's elimination round, show all regions
        if (currentStage.Stage == "Elimination Round")
        {
            _filteredRegions = _schoolRegions.ToList();
            return;
        }

        // For other stages, check previous stage
        var previousStage = GetPreviousStage(currentStage.Stage);
        if (previousStage == null)
        {
            _filteredRegions = _schoolRegions.ToList();
            return;
        }

        // Get qualified regions from previous stage
        var qualifiedRegionIDs = await GetQualifiedRegionsFromStage(previousStage.ID);

        if (qualifiedRegionIDs == null || !qualifiedRegionIDs.Any())
        {
            Snackbar.Add($"No regions qualified from {previousStage.Stage}.", Severity.Info);
            _filteredRegions = new List<SchoolsDTO.SchoolRegions>();
            return;
        }

        // Filter regions
        _filteredRegions = _schoolRegions.Where(r => qualifiedRegionIDs.Contains(r.ID)).ToList();
    }

    private EventsDTO.EventStages? GetPreviousStage(string currentStageName)
    {
        var stageOrder = new Dictionary<string, string>
    {
        { "Quarter-finals", "Elimination Round" },
        { "Semi-finals", "Quarter-finals" },
        { "Finals", "Semi-finals" }
    };

        if (stageOrder.TryGetValue(currentStageName, out var previousStageName))
        {
            return _eventStages?.FirstOrDefault(x => x.Stage == previousStageName);
        }

        return null;
    }

    // Get qualified regions from a specific stage
    private async Task<HashSet<int>> GetQualifiedRegionsFromStage(int stageID)
    {
        try
        {
            // 1. Get all events from the PREVIOUS stage that match filters
            var allEvents = await apiService.GetAsync<PerformanceBasedDTO.PerformanceEvent>(
                "/PerformanceBased/PerformanceEvents"
            ) ?? new List<PerformanceBasedDTO.PerformanceEvent>();

            var previousStageEvents = allEvents
                .Where(e =>
                    e.StageID == stageID &&
                    EventMatchesFilters(e))
                .Select(e => e.ID)
                .ToHashSet();

            if (!previousStageEvents.Any())
                return new HashSet<int>();

            // 2. Get all scores
            var allScores = await apiService.GetAsync<PerformanceBasedDTO.PerformanceScore>(
                "/PerformanceScore/Scores"
            ) ?? new List<PerformanceBasedDTO.PerformanceScore>();

            // 3. Get QUALIFIED teams only (Rank = 1) from previous stage events
            var qualifiedTeamIDs = allScores
                .Where(s =>
                    s.Rank == 1 &&
                    s.PerformanceID.HasValue &&
                    previousStageEvents.Contains(s.PerformanceID.Value))
                .Select(s => s.PerformanceTeamID)
                .ToHashSet();

            if (!qualifiedTeamIDs.Any())
                return new HashSet<int>();

            // 4. Get teams → regions
            var qualifiedRegionIDs = new HashSet<int>();

            foreach (var eventId in previousStageEvents)
            {
                var teams = await apiService.GetAsync<PerformanceBasedDTO.PerformanceTeam>(
                    $"/PerformanceBased/OpposingTeams/{eventId}"
                ) ?? new List<PerformanceBasedDTO.PerformanceTeam>();

                foreach (var team in teams)
                {
                    if (qualifiedTeamIDs.Contains(team.ID) && team.RegionID.HasValue)
                    {
                        qualifiedRegionIDs.Add(team.RegionID.Value);
                    }
                }
            }

            return qualifiedRegionIDs;
        }
        catch
        {
            return new HashSet<int>();
        }
    }


    private bool EventMatchesFilters(PerformanceBasedDTO.PerformanceEvent performanceEvent)
    {
        // Check sport ID
        if (performanceEvent.SportID != _selectedSportIDValue)
            return false;

        // Check main category
        if (performanceEvent.MainCategory != _selectedMainCategoryValue)
            return false;

        // Check school level and gender
        var parts = _selectedSchoolLevelAndGenderID?.Split(" - ");
        if (parts?.Length != 2)
            return false;

        var schoolLevelName = parts[0];
        var genderName = parts[1];

        var schoolLevelID = _schoolLevels?.FirstOrDefault(x => x.Level == schoolLevelName)?.ID;
        var genderID = _sportGenderCategories?.FirstOrDefault(x => x.Gender == genderName)?.ID;

        return performanceEvent.LevelID == schoolLevelID && performanceEvent.GenderID == genderID;
    }

    private async Task OnStageChanged()
    {
        await FilterRegionsByStage();

        // Clear selections when stage changes
        foreach (var team in _teamSelections)
        {
            team.SelectedRegionID = null;
            team.SelectedPlayerIDs = new HashSet<string>();
            team.AvailablePlayers = new List<ProfilesDTO.ProfilePlayerEvent>();
        }

        StateHasChanged();
    }

    //UPLOAD OFFICIAL RESULT

    private string _eventAttachmentUrl = "";
    private bool _fileExists = false;
    private bool _uploadingOfficialResult = false;

    private string? _updateEventAttachmentValue;
    private string? _eventAttachmentUploadState = "No file uploaded";
    private byte[]? _uploadedFileBytes;
    private string? _uploadedFileContentType;

    private readonly string[] _extensions = { ".png", ".jpg", ".jpeg", ".pdf", ".doc", ".docx" };

    protected override async Task OnParametersSetAsync()
    {
        await CheckIfFileExists();
    }

    private async Task CheckIfFileExists()
    {
        if (!SelectedEventID.HasValue)
        {
            _eventAttachmentUploadState = "No file selected";
            _fileExists = false;
            return;
        }

        using var httpClient = new HttpClient();

        foreach (var ext in _extensions)
        {
            var url = $"https://palarongpambansa2026.com/attachments/media/events/official%20event%20records/{SelectedEventID}{ext}";

            try
            {
                var response = await httpClient.SendAsync(new HttpRequestMessage(HttpMethod.Head, url));

                if (response.IsSuccessStatusCode)
                {
                    _fileExists = true;
                    _eventAttachmentUrl = url;
                    _eventAttachmentUploadState = "View Attachment";
                    return;
                }
            }
            catch
            {
                // Ignore errors and try next extension
            }
        }

        // No file found for any extension
        _fileExists = false;
        _eventAttachmentUploadState = "No file selected";
    }

    private async Task HandleFileUpload(IBrowserFile file)
    {
        try
        {
            // Define the maximum file size (in bytes)
            const int maxFileSize = 10 * 1024 * 1024; // 10 MB

            // Check if the file size exceeds the maximum allowed
            if (file.Size > maxFileSize)
            {
                Snackbar.Add("File size exceeds the maximum allowed size of 10 MB.", Severity.Error);
                return;
            }

            // Validate file type (image only)
            var allowedExtensions = new[] { ".jpeg", ".jpg", ".png", ".pdf", ".doc", ".docx" };
            var fileExtension = Path.GetExtension(file.Name).ToLower();
            if (!allowedExtensions.Contains(fileExtension))
            {
                Snackbar.Add("Invalid file type. Allowed: .jpg, .jpeg, .png, .pdf, .doc, .docx", Severity.Error);
                return;
            }

            // Open the file stream with the maxFileSize limit
            using var stream = file.OpenReadStream(maxFileSize);

            // Create a memory stream to store the file in memory
            using var memoryStream = new MemoryStream();

            // Copy the file data into the memory stream
            await stream.CopyToAsync(memoryStream);

            // Convert the memory stream to a base64 string for temporary storage
            var base64File = Convert.ToBase64String(memoryStream.ToArray());

            // Set the temporary variable to the base64 string of the file
            _updateEventAttachmentValue = $"data:{file.ContentType};base64,{base64File}";

            // Optionally display a success message
            var fileName = Path.GetFileName(file.Name);
            _eventAttachmentUploadState = $"Selected: {fileName}";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"File upload failed: {ex.Message}");
            Snackbar.Add($"File upload failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task UploadEventAttachmentAsync(int eventId)
    {
        if (string.IsNullOrWhiteSpace(_updateEventAttachmentValue))
            return;

        try
        {
            var base64Data = _updateEventAttachmentValue.Split(',')[1];
            var fileBytes = Convert.FromBase64String(base64Data);

            using var fileContent = new ByteArrayContent(fileBytes);

            string fileType, fileExtension;

            if (_updateEventAttachmentValue.Contains("image/jpeg"))
            {
                fileType = "image/jpeg"; fileExtension = ".jpg";
            }
            else if (_updateEventAttachmentValue.Contains("image/png"))
            {
                fileType = "image/png"; fileExtension = ".png";
            }
            else if (_updateEventAttachmentValue.Contains("application/pdf"))
            {
                fileType = "application/pdf"; fileExtension = ".pdf";
            }
            else if (_updateEventAttachmentValue.Contains("application/msword"))
            {
                fileType = "application/msword"; fileExtension = ".doc";
            }
            else if (_updateEventAttachmentValue.Contains("application/vnd.openxmlformats-officedocument.wordprocessingml.document"))
            {
                fileType = "application/vnd.openxmlformats-officedocument.wordprocessingml.document"; fileExtension = ".docx";
            }
            else
            {
                Snackbar.Add("Unsupported file format.", Severity.Error);
                return;
            }

            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(fileType);

            using var formData = new MultipartFormDataContent();
            formData.Add(fileContent, "attachmentFile", $"attachment{fileExtension}");

            // ✅ IMPORTANT: use eventId, and verify controller route
            var uploadUrl = $"/PerformanceBased/UploadAttachment/{eventId}";
            // if your controller is PerformanceBased: use:
            // var uploadUrl = $"/PerformanceBased/UploadAttachment/{eventId}";

            var uploadSuccess = await apiService.PutFormAsync(uploadUrl, formData);

            if (uploadSuccess)
            {
                _eventAttachmentUploadState = "View Attachment";
                await CheckIfFileExists();
            }
            else
            {
                Snackbar.Add("Attachment upload failed.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Attachment upload failed: {ex.Message}", Severity.Warning);
        }
    }

    // ------------------------------
    // Dialog Controls
    // ------------------------------
    private async Task ConfirmAddEventAsync()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, CloseOnEscapeKey = true };
        bool? result = await DialogService.ShowMessageBox(
            title: "Notice",
            message: "Do you confirm addition of Event?",
            yesText: "Yes",
            noText: "Cancel",
            options: options
        );

        if (result == true)
        {
            await AddEventAsync();
            MudDialog?.Close(DialogResult.Ok(true));
        }
    }

    private void AddOpponent()
    {
        _teamSelections.Add(new TeamSelection { TeamID = null });
    }

    private void ClearFields()
    {
        _selectedEventStagesIDValue = null;
        _selectedSportCategoryIDValue = 1;
        _selectedSportIDValue = 10;
        _selectedSportGenderCategoryIDValue = null;
        _selectedSchoolLevelIDValue = null;

        _selectedSchoolLevelAndGenderID = null;
        _selectedMainCategoryValue = null;
        _combinedSchoolLevelAndGenderNames = new List<string>();

        // Reset filtered regions
        _filteredRegions = null;

        foreach (var team in _teamSelections)
        {
            team.SelectedRegionID = null;
            team.SelectedPlayerIDs = new HashSet<string>();
            team.AvailablePlayers = new List<ProfilesDTO.ProfilePlayerEvent>();
        }
    }

    private void Cancel() => MudDialog?.Cancel();

    public class PerformanceBasedDTO
    {
        public class PerformanceEvent
        {
            public int ID { get; set; }
            public int? SportID { get; set; }
            public string MainCategory { get; set; } = string.Empty;
            public int? LevelID { get; set; }
            public int? GenderID { get; set; }
            public int? StageID { get; set; }
            public bool? IsFinished { get; set; }
        }
    
        public class PerformanceTeam
        {
            public int ID { get; set; }
            public int? PerformanceID { get; set; } 
            public int? TeamID { get; set; }
            public int? RegionID { get; set; }
            public string PlayerID { get; set; } = string.Empty;
        }

        public class PerformanceScore
        {
            public int ID { get; set; }
            public int? PerformanceID { get; set; }
            public int PerformanceTeamID { get; set; }
            public int SportSubcategoryID { get; set; }
            public decimal Score { get; set; }
            public int Rank { get; set; }
            public string? UserID { get; set; }
            public DateTime UpdatedAt { get; set; }
            public int? TeamID { get; set; }
        }
    }

    public class EventsDTO
    {
        public class EventStages
        {
            public int ID { get; set; }
            public string? Stage { get; set; }
        }
    }

    public class ProfilesDTO
    {
        public class ProfilePlayerEvent
        {
            public string? ID { get; set; }
            public string? FirstName { get; set; }
            public string? LastName { get; set; }
            public int? RegionID { get; set; }
            public int? SubCategoryID { get; set; }
        }
    }

    public class SportsDTO
    {
        public class SportCategories
        {
            public int ID { get; set; }
            public string? Category { get; set; }
        }

        public class Sports
        {
            public int ID { get; set; }
            public string? Sport { get; set; }
            public string? Description { get; set; }
            public int? SportCategoryID { get; set; }
        }

        public class SportSubcategories
        {
            public int ID { get; set; }
            public string? Subcategory { get; set; }
            public int? SportID { get; set; }
            public int? SportGenderCategoryID { get; set; }
            public int? SchoolLevelID { get; set; }
            public string? MainCategory { get; set; }
        }

        public class SportGenderCategories
        {
            public int ID { get; set; }
            public string? Gender { get; set; }
        }
    }

    public class SchoolsDTO
    {
        public class SchoolRegions
        {
            public int ID { get; set; }
            public string? Region { get; set; }
            public string? Abbreviation { get; set; }
        }

        public class SchoolLevels
        {
            public int ID { get; set; }
            public string? Level { get; set; }
        }
    }

    private class TeamSelection
    {
        public int ID { get; set; }
        public int? SelectedRegionID { get; set; }
        public ICollection<string> SelectedPlayerIDs { get; set; } = new HashSet<string>();
        public List<ProfilesDTO.ProfilePlayerEvent> AvailablePlayers { get; set; } = new List<ProfilesDTO.ProfilePlayerEvent>();
        public int ExistingOpposingTeamID { get; set; }
        public int? TeamID { get; set; }
    }
}