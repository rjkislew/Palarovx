@inject NavigationManager NavManager
@inject CookieService cookieService

<MudNavMenu Margin="Margin.Normal" Rounded Color="Color.Dark" Class="scroll-container">
    <!-- Home -->
    <MudNavLink Match="NavLinkMatch.All" Href="./">Home</MudNavLink>

    <!-- Events -->
    <MudNavGroup Title="Event" Expanded="@IsExpanded("/events")" Disabled="@(!CanAccessEvents)">
        <MudNavLink Match="NavLinkMatch.All" Href="./events/" Disabled="@(!CanAccessEvents)">Events</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./events/streams" Disabled="@(!CanAccessEvents)">Streams</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./events/venues" Disabled="@(!CanAccessEvents)">Venues</MudNavLink>
    </MudNavGroup>

    <!-- News -->
    <MudNavGroup Title="News" Expanded="@IsExpanded("/news")" Disabled="@(!CanAccessNews)">
        <MudNavLink Match="NavLinkMatch.All" Href="./news" Disabled="@(!CanAccessNews)">News</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./news/categories" Disabled="@(!CanAccessNewsAdmin)">Categories</MudNavLink>
    </MudNavGroup>

    <!-- Profile -->
    <MudNavGroup Title="Profile" Expanded="@IsExpanded("/profiles")" Disabled="@(!CanAccessProfiles)">         
        <MudNavLink Match="NavLinkMatch.All" Href="./profiles/players" Disabled="@(!CanAccessProfiles)">Players</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./profiles/coaches" Disabled="@(!CanAccessProfiles)">Coaches</MudNavLink>
    </MudNavGroup>

    <!-- Schools -->
    <MudNavGroup Title="School" Expanded="@IsExpanded("/schools")" Disabled="@(!CanAccessSchools)">
        <MudNavLink Match="NavLinkMatch.All" Href="./schools/regions" Disabled="@(!CanAccessSchools)">Regions</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./schools/divisions" Disabled="@(!CanAccessSchools)">Divisions</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./schools" Disabled="@(!CanAccessSchools)">Schools</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./schools/billeting-quarters" Disabled="@(!CanAccessSchools)">Billeting Quarters</MudNavLink>
    </MudNavGroup>

    <!-- Sports -->
    <MudNavGroup Title="Sport" Expanded="@IsExpanded("/sports")" Disabled="@(!CanAccessSports)">
        <MudNavLink Match="NavLinkMatch.All" Href="./sports" Disabled="@(!CanAccessSports)">Sports</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./sports/subcategories" Disabled="@(!CanAccessSports)">Subcategories</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./sports/brackets" Disabled="@(!CanAccessSports)">Sports Bracketing</MudNavLink>
    </MudNavGroup>

    <!-- Score -->
    <MudNavGroup Title="Score" Expanded="@IsExpanded("/score")" Disabled="@(!CanAccessSports)">
        <MudNavLink Match="NavLinkMatch.All" Href="./score/boxing/scoreboard" Disabled="@(!CanAccessSports)">Boxing Scoareboard</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/boxing/bracketing" Disabled="@(!CanAccessSports)">Boxing Bracketing</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/archery" Disabled="@(!CanAccessSports)">Archery</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/billiards" Disabled="@(!CanAccessSports)">Billiards</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/chess" Disabled="@(!CanAccessSports)">Chess</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/dancesport" Disabled="@(!CanAccessSports)">Dancesport</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/field-events" Disabled="@(!CanAccessSports)">Field Events</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/gymnastics" Disabled="@(!CanAccessSports)">Gymnastics</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/martialarts" Disabled="@(!CanAccessSports)">Martial Arts</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/martialarts-performance" Disabled="@(!CanAccessSports)">Martial Arts Performance</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/teammatch" Disabled="@(!CanAccessSports)">Team Match</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./score/time-distance" Disabled="@(!CanAccessSports)">Time & Distance Base</MudNavLink>
        </MudNavGroup>
    
    <MudNavGroup Title="Certificates" Expanded="@IsExpanded("/certificates")" Disabled="@(!CanAccessSports)">
        <MudNavLink Match="NavLinkMatch.All" Href="./certificates/players" Disabled="@(!CanAccessSports)">Players</MudNavLink>
        <MudNavLink Match="NavLinkMatch.All" Href="./certificates/coaches" Disabled="@(!CanAccessSports)">Coaches</MudNavLink>
        </MudNavGroup>

    <!-- Schedule -->
    <MudNavLink Match="NavLinkMatch.All" Href="./schedule" Disabled="@(!CanAccessSchedule)">Schedule</MudNavLink>

    <!-- Users -->
    <MudNavLink Match="NavLinkMatch.All" Href="./users" Disabled="@(!CanAccessUsers)">Users</MudNavLink>
</MudNavMenu>

@code {
    private string currentPath = string.Empty;
    private string? UserRole;

    private bool CanAccessEvents => UserRole is "Superuser" or "System Administrator" or "Tally Manager" or "Tally Clerk" or "Event Manager";
    private bool CanAccessNews => UserRole is "Superuser" or "System Administrator" or "News Administrator" or "News Editor" or "News Contributor";
    private bool CanAccessNewsAdmin => UserRole is "Superuser" or "System Administrator" or "News Administrator";
    private bool CanAccessProfiles => UserRole is "Superuser" or "System Administrator" or "Regional Facilitator";
    private bool CanAccessSchools => UserRole is "Superuser" or "System Administrator" or "Regional Facilitator";
    private bool CanAccessSports => UserRole is "Superuser" or "System Administrator" or "Sport Manager";
    private bool CanAccessUsers => UserRole == "Superuser";
    private bool CanAccessSchedule => UserRole is "Superuser" or "System Administrator" or "Event Manager";

    protected override async Task OnInitializedAsync()
    {
        UpdateCurrentPath();
        NavManager.LocationChanged += HandleLocationChanged;

        // 🔑 Load role from cookie
        UserRole = await cookieService.GetCookie("userRole");
    }

    private void HandleLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateCurrentPath();
        InvokeAsync(StateHasChanged);
    }

    private void UpdateCurrentPath()
    {
        currentPath = NavManager.Uri.Replace(NavManager.BaseUri, "").TrimEnd('/');
    }

    private bool IsExpanded(string pathPrefix)
    {
        return currentPath.StartsWith(pathPrefix.TrimStart('/'), StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        NavManager.LocationChanged -= HandleLocationChanged;
    }
}
